<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Chapter 18 Grails</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre"><p class="ChapterNumber"><a id="b9781430259084_18" class="calibre6"></a>CHAPTER 18</p>
<p class="Chapimage"><img src="../images/00008.jpeg" alt="image" class="calibre3"/></p>
<p class="ChapterTitle">Grails</p>
<div class="calibre10"><p class="noindent">When you embark on the creation of a Java web application, you need to put together a series of Java classes, create configuration files, and establish a particular layout, all of which have little to do with the problems an application solves. Such pieces are often called “scaffolding code<a id="cXXX.1248" class="calibre5"></a>” or “scaffolding steps,” since they are just the means to an end—the end being what an application actually accomplishes.</p>
<p class="indent">Grails<a id="cXXX.2042" class="calibre5"></a> is a framework designed to limit the amount of scaffolding steps you need to take in Java applications. Based on the Groovy language, which is a Java Virtual Machine–compatible language, Grails automates many steps that need to be undertaken in a Java application on the basis of conventions.</p>
<p class="indent">For example, when you create application controllers, they are eventually accompanied by a series of views (e.g., JavaServer Pages [JSP] pages<a id="cXXX.1249" class="calibre5"></a>), in addition to requiring some type of configuration file to make them work. If you generate a controller using Grails, Grails automates numerous steps using conventions (e.g., creating views and configuration files). You can later modify whatever Grails generates to more specific scenarios, but Grails undoubtedly shortens your development time since you won’t need to write everything from scratch (e.g., write XML configuration files and prepare a project directory structure).</p>
<p class="indent">Grails is fully integrated with Spring 4.0, so you can use it to kick-start your Spring applications and thus reduce your development efforts.</p>
<p id="Sec1" class="Heading">18-1. Getting and Installing Grails</p>
<p id="Sec2" class="Heading1">Problem</p>
<p class="noindent">You want to start creating a Grails application but don’t know where to get Grails and how to set it up.</p>
<p id="Sec3" class="Heading1">Solution</p>
<p class="noindent">You can download Grails at <span class="FontName"><a href="http://www.grails.org/" class="calibre5">http://www.grails.org/</a></span>. Ensure that you download Grails version 2.4 or higher, since only those versions support Spring 4.0. Grails is a self-contained framework that comes with various scripts to automate the creation of Java applications. In this sense, you simply need to unpack the distribution and perform a few installation steps in order to create Java applications on your workstation.</p>
<p id="Sec4" class="Heading1">How It Works<a id="cXXX.1250" class="calibre6"></a></p>
<p class="noindent">After you unpack Grails on your workstation, define two environment variables on your operating system: <span class="FontName">GRAILS_HOME</span> and <span class="FontName">PATH</span>. This allows you to invoke Grails operations from anywhere on your workstation.</p>
<p class="indent">If you use a Linux workstation, you can edit the global <span class="FontName">bashrc</span> file– located under the <span class="FontName">/etc/</span> directory, or a use’s <span class="FontName">.bashrc</span> file, located under a user’s home directory. Note that, depending on the Linux distribution, these last file names can vary (e.g., <span class="FontName">bash.bashrc</span>). Both files use identical syntax to define environment variables, with one file used to define variables for all users and another for a single user. Place the following contents in either one:</p>
<pre class="calibre11"><span class="FontName">GRAILS_HOME=/&lt;installation_directory&gt;/grails</span><br class="calibre10"/><span class="FontName">export GRAILS_HOME</span><br class="calibre10"/><span class="FontName">export PATH=$PATH:$GRAILS_HOME/bin</span></pre>
<p class="indent">If you use a Windows workstation, go to the Control Panel, and click the System icon. On the window that emerges, click the Advanced Options tab. Next, click the “Environment variables” <a id="cXXX.1251" class="calibre5"></a>box to bring up the environment variable editor. From there, you can add or modify environment variables for either a single user or all users, using the following steps:</p>
<ol class="OrderedList"><li value="1" class="calibre17">Click the New box.</li>
<li value="2" class="calibre17">Create an environment variable with the name <span class="FontName">GRAILS_HOME</span> and a value corresponding to the Grails installation directory (e.g., <span class="FontName">/&lt;installation_directory&gt;/grails</span>).</li>
<li value="3" class="calibre17">Select the <span class="FontName">PATH</span> environment variable, and click the Modify box.</li>
<li value="4" class="calibre17">Add the <span class="FontName">;%GRAILS_HOME%\bin</span> value to the end of the <span class="FontName">PATH</span> environment variable.</li></ol><div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Caution</b>  Be sure to <i class="calibre8">add</i> this last value and not modify the <span class="FontName">PATH</span> environment variable in any other way, as this may cause certain applications to stop working.</p></div>
<p class="indent">Once you perform these steps in either a Windows or Linux workstation, you can start creating Grails applications. If you execute the command <span class="FontName">grails help</span> from any directory on your workstation, you should see Grails’s numerous commands. <a id="cXXX.1252" class="calibre5"></a></p>
<p id="Sec5" class="Heading">18-2. Creating a Grails Application<a id="cXXX.1253" class="calibre6"></a></p>
<p id="Sec6" class="Heading1">Problem</p>
<p class="noindent">You want to create a Grails application.</p>
<p id="Sec7" class="Heading1">Solution</p>
<p class="noindent">To create a Grails application, invoke the following command wherever you wish to create an application: <span class="FontName">grails create-app &lt;grailsappname&gt;</span>. This creates a Grails application directory, with a project structure in accordance to the framework’s design.</p>
<p class="indent">If this last command fails, consult Recipe 18-1, on “Getting and Installing<a id="cXXX.2045" class="calibre5"></a> Grails.” The <span class="FontName">grails</span> command should be available from any console or terminal if Grails was installed correctly.</p>
<p id="Sec8" class="Heading1">How It Works</p>
<p class="noindent">For example, typing <span class="FontName">grails create-app court</span> creates a Grails application under a directory named <span class="FontName">court</span>. Inside this directory, you will find a series of files and directories generated by Grails on the basis of conventions. The initial project structure for a Grails application is the following:</p>
<pre class="calibre11"><span class="FontName">application.properties</span><br class="calibre10"/><span class="FontName">grails-app/</span><br class="calibre10"/><span class="FontName">grailsw</span><br class="calibre10"/><span class="FontName">grailsw.bat</span><br class="calibre10"/><span class="FontName">lib/</span><br class="calibre10"/><span class="FontName">scripts/</span><br class="calibre10"/><span class="FontName">src/</span><br class="calibre10"/><span class="FontName">test/</span><br class="calibre10"/><span class="FontName">web-app/</span><br class="calibre10"/><span class="FontName">wrapper/</span></pre>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  In addition to this last layout, Grails also creates a series of working directories and files (i.e., not intended to be modified directly) for an application. These working directories and files are placed under a user’s home directory under the name <span class="FontName">.grails/&lt;grails_version&gt;/</span>.</p></div>
<p class="indent">As you can note from this last listing, Grails generates a series of files and directories that are common in most Java applications. Directories like <span class="FontName">src</span> for placing source code files and a <span class="FontName">web-app</span> directory that includes the common layout for Java web application(e.g., <span class="FontName">/WEB-INF/</span>, <span class="FontName">/META-INF/</span>, <span class="FontName">css</span>, <span class="FontName">images</span>, and <span class="FontName">js</span>).</p>
<p class="indent">Right out of the box, Grails saves you time by putting these common Java application constructs together using a single command.</p>
<p id="Sec9" class="Heading2">A Grails Application’s File and Directory Structure<a id="cXXX.1254" class="calibre6"></a></p>
<p class="noindent">Since some of these files and directories are Grails specific, we will describe the purpose behind each one:</p>
<ul class="bulleted"><li class="calibre17"><span class="FontName">application.properties</span>: Used to define an application’s properties, including the Grails version, servlet version, and an application’s name</li>
<li class="calibre17"><span class="FontName">grails-app</span>: A directory containing the core of an application, which further contains the following folders:
<ol class="OrderedList"><li value="1" class="calibre17"><span class="FontName">assets</span>: A directory containing an application’s static resources (i.e. <span class="FontName">.css</span> and <span class="FontName">.js</span> files)</li>
<li value="2" class="calibre17"><span class="FontName">conf</span>: A directory containing an application’s configuration sources</li>
<li value="3" class="calibre17"><span class="FontName">controllers</span>: A directory containing an application’s controllers files</li>
<li value="4" class="calibre17"><span class="FontName">domain</span>: A directory containing an application’s domain files</li>
<li value="5" class="calibre17"><span class="FontName">i18n</span>: A directory containing an application’s internationalization (i18n) files</li>
<li value="6" class="calibre17"><span class="FontName">migrations</span>:</li>
<li value="7" class="calibre17"><span class="FontName">services</span>: A directory containing an application’s service files</li>
<li value="8" class="calibre17"><span class="FontName">taglib</span>: A directory containing an application’s tag libraries</li>
<li value="9" class="calibre17"><span class="FontName">utils</span>: A directory containing an application’s utility files</li>
<li value="10" class="calibre17"><span class="FontName">views</span>: A directory containing an application’s view files
<ul class="list-disc"><li class="calibre17"><span class="FontName">lib</span>: Directory used for libraries (i.e., JARs)</li>
<li class="calibre17"><span class="FontName">scripts</span>: Directory used for scripts</li>
<li class="calibre17"><span class="FontName">src</span>: Directory used for an application’s source code files; contains two subfolders named <span class="FontName">groovy</span> and <span class="FontName">java</span>, for sources written in these respective languages</li>
<li class="calibre17"><span class="FontName">test</span>: Directory used for an application’s test files. Contains two subfolders named <span class="FontName">integration</span> and <span class="FontName">unit</span>, for tests belonging to these respective types</li>
<li class="calibre17"><span class="FontName">web-app</span>: Directory used for an application’s deployment structure; contains the standard web archive (WAR) files<a id="cXXX.1255" class="calibre5"></a> and directory structure (e.g., <span class="FontName">/WEB-INF/</span>, <span class="FontName">/META-INF/</span>, <span class="FontName">css</span>, <span class="FontName">images</span>, and <span class="FontName">js</span>)</li></ul>
</li></ol></li></ul>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  Grails does not support Apache Maven out of the box. However, if you prefer to use Maven as your build tool, there is support for using Maven with Grails. Consult <span class="FontName"><a href="http://www.grails.org/Maven" class="calibre5">http://www.grails.org/Maven</a>+Integration</span>.</p></div>
<p id="Sec10" class="Heading2">Running an Application<a id="cXXX.1256" class="calibre6"></a></p>
<p class="noindent">Grails comes preconfigured to run applications on an Apache Tomcat web container. Note the files pertaining to the Apache Tomcat container are one of those placed under a user’s home directory (i.e., <span class="FontName">.grails/&lt;grails_version&gt;/</span>), they are not visible. Similar to the creation of creating a Grails application, the process of running Grails applications is highly automated.</p>
<p class="indent">Placed under the root directory of a Grails application, invoke <span class="FontName">grails run-app</span>. This command will trigger the build process for an application if it’s needed, as well as start the Apache Tomcat web container and deploy the application.</p>
<p class="indent">Since Grails operates on conventions, an application is deployed under a context named after the project name. So for example, the application named <span class="FontName">court</span> is deployed to the URL <span class="FontName">http://localhost:8080/court/</span>. <a id="_Fig1" href="part0028.html#Fig1" class="calibre5">Figure 18-1</a> illustrates the default main screen for Grails applications.</p>
<div class="Figure" id="Fig1">
<p class="img1"><img src="../images/00086.jpeg" alt="9781430259084_Fig18-01.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0028.html#_Fig1" class="calibre5">Figure 18-1</a>.</span> Default main screen for court Grails application</p></div>
<p class="indent">The application is still in its out of the box state. Next, we will illustrate how to create your first Grails construct in order to realize more time-saving procedures.</p>
<p id="Sec11" class="Heading2">Creating Your First Grails Application Construct<a id="cXXX.2044" class="calibre6"></a><a id="cXXX.1257" class="calibre6"></a></p>
<p class="noindent">Now that you have seen how easy it is to create a Grails application, let’s incorporate an application construct in the form of a controller. This will further illustrate how Grails automates a series of steps in the development<a id="cXXX.2043" class="calibre5"></a> process of Java applications.</p>
<p class="indent">Placed under the root directory of a Grails application, invoke <span class="FontName">grails create-controller welcome</span>. Executing this command will perform the following steps:</p>
<ol class="OrderedList"><li value="1" class="calibre17">Create a controller named <span class="FontName">WelcomeController.groovy</span> under the application directory <span class="FontName">grails-app/controllers</span>.</li>
<li value="2" class="calibre17">Create a directory named <span class="FontName">welcome</span> under the application directory <span class="FontName">grails-app/views</span>.</li>
<li value="3" class="calibre17">Create a test class named <span class="FontName">WelcomeControllerSpec.groovy</span> under the application directory <span class="FontName">test/unit</span>.</li></ol><p class="indent">As a first step, let’s analyze the contents of the controller generated by Grails. The contents of the <span class="FontName">WelcomeController.groovy</span> controller are the following:</p>
<pre class="calibre11"><span class="FontName">class WelcomeController {</span><br class="calibre10"/> <span class="FontName">def index = {}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">If you‘re unfamiliar with Groovy, the syntax will seem awkward. But it’s simply a class named <span class="FontName">WelcomeController</span> with a method named <span class="FontName">index</span>. The purpose is the same as the Spring MVC controllers you created back in <a href="part0014.html" class="calibre5">Chapter 4</a>, <span class="FontName">WelcomeController</span>, represents a controller class whereas the method, <span class="FontName">index</span>, represents a handler method. However, in this state the controller isn‘t doing anything. Modify it to reflect the following:</p>
<pre class="calibre11"><span class="FontName">class WelcomeController {</span><br class="calibre10"/>  <b class="calibre4">Date now = new Date()</b><br class="calibre10"/>  <b class="calibre4">def index = {[today:now]}</b><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent"><a id="cXXX.1258" class="calibre5"></a>The first addition is a <span class="FontName">Date</span> object assigned to the <span class="FontName">now</span> class field, to represent the system date. Since <span class="FontName">def index = {}</span> represents a handler method, the addition of <span class="FontName">[today:now]</span> is used as a return value. In this case, the return value represents a variable named <span class="FontName">today</span> with the <span class="FontName">now</span> class field, and that variable’s value will be passed onto to the view associated with the handler method.</p>
<p class="indent">Having a controller and a handler method that returns the current date, you can create a corresponding view. If you place yourself under the directory <span class="FontName">grails-app/views/welcome</span>, you will not find any views. However, Grails attempts to locate a view for the <span class="FontName">WelcomeController</span> controller inside this directory, in accordance with the name of the handler method; this, once again, is one of the many conventions used by Grails.</p>
<p class="indent">Therefore, create a GSP page named <span class="FontName">index.gsp</span> inside this directory with the following contents: <a id="cXXX.1259" class="calibre5"></a></p>
<pre class="calibre11"><span class="FontName">&lt;!DOCTYPE html&gt;</span><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;title&gt;Welcome&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">Welcome to Court Reservation System&lt;/h2&gt;</span><br class="calibre10"/><b class="calibre4">Today is &lt;g:formatDate format="yyyy-MM-dd" date="${today}"/&gt;</b><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent"><a id="cXXX.1260" class="calibre5"></a></p>
<p class="indent">This is a standard GSP page which makes use of the expressions and a tag library. When writing GSP pages the default tag library is available using the <span class="FontName">g</span> tag. The <span class="FontName">formatDate</span> tag renders a variable named <span class="FontName">${today}</span>, which is precisely the name of the variable returned by the controller handler method named <span class="FontName">index</span>.</p>
<p class="indent">Next, from the root directory of the Grails application, invoke the command <span class="FontName">grails run-app</span>. This automatically builds the application, compiling the controller class and copying files where they are needed as well as starting the Apache Tomcat web container and deploying the application.</p>
<p class="indent">Following the same Grails convention process, the <span class="FontName">WelcomeController</span> along with its handler methods and views will be accessible from the context path <span class="FontName">http://localhost:8080/court/welcome/</span>. Since <span class="FontName">index</span> is the default page used for context paths, if you open a browser and visit <span class="FontName">http://localhost:8080/court/welcome/</span> or the explicit URL <span class="FontName">http://localhost:8080/court/welcome/index</span>, you will see the previous JSP page <a id="cXXX.1261" class="calibre5"></a>that renders the current date as returned by the controller. Note the lack of view extensions in the URLs (i.e., <span class="FontName">.jsp</span>). Grails hides the view technology by default, the reasons for this will become more evident in more advanced Grails scenarios.</p>
<p class="indent">As you repeat the simple steps needed to create an application controller and view, bear in mind you didn’t have to create or modify any configuration files, manually copy files to different locations, or set up a web container to run the application. As an application moves forward, avoiding these scaffolding steps that are common in Java web applications can be a great way to reduce development time.</p>
<p id="Sec12" class="Heading2">Exporting a Grails Application to a WAR<a id="cXXX.1262" class="calibre6"></a></p>
<p class="noindent">The previous steps were all performed in the confines of a Grails environment. That is to say, you relied on Grails to bootstrap a web container and run applications. However, when you want to run a Grails application in a production environment, you will undoubtedly need to generate a format in which to deploy the application to an external web container, which is a WAR file in the case of Java applications.</p>
<p class="indent">Placed under the root directory of a Grails application, invoke <span class="FontName">grails war</span>. Executing this command generates a WAR file under the root directory in the form <span class="FontName">&lt;application-name&gt;-&lt;application-version&gt;.war</span>. This WAR is a self-contained file with all the necessary elements needed to run a Grails application on any Java standard web container.</p>
<p class="indent">In the case of the <span class="FontName">court</span> application, a file named <span class="FontName">court-0.1.war</span> is generated in the root directory of the Grails application, and the application version is taken from the parameter <span class="FontName">app.version</span> defined in the <span class="FontName">application.properties</span> file.</p>
<p class="indent">In accordance with Apache Tomcat deployment conventions, a WAR named <span class="FontName">court-0.1.war</span> would be accessible at a URL in the form <span class="FontName">http://localhost:8080/court-0.1/</span>. WAR deployment to URL conventions may vary depending on the Java web container (e.g., Jetty or Oracle WebLogic).</p>
<p id="Sec13" class="Heading">18-3. Grails Plug-Ins<a id="cXXX.1263" class="calibre6"></a></p>
<p id="Sec14" class="Heading1">Problem</p>
<p class="noindent">You want to use functionality from a Java framework or Java API inside Grails applications, while taking advantage of the same Grails techniques to save scaffolding.</p>
<p class="indent">The problem isn’t simply using a Java framework or Java API in an application; this can be achieved by simply dropping the corresponding JARs into an application’s <span class="FontName">lib</span> directory. But rather having a Java framework or Java API <i class="calibre8">tightly</i> integrated with Grails, something that is provided in the form of Grails plug-ins.</p>
<p class="indent">By <i class="calibre8">tightly</i> integrated with Grails, we mean having the capacity to use short-cut instructions (e.g., <span class="FontName">grails &lt;plug-in-task&gt;</span>) for performing a particular Java framework or Java API task or the ability to use functionality inside an application’s classes or configuration files without resorting to scaffolding steps.</p>
<p id="Sec15" class="Heading1">Solution</p>
<p class="noindent">Grails actually comes with a few preinstalled plug-ins, even though this is not evident if you stick to using Grails out of the box functionality. However, there are many Grails plug-ins that can make working with a particular Java framework or Java API as productive a process as using Grails core functionality. Some of the more popular Grails plug-ins follow: <a id="cXXX.1264" class="calibre5"></a></p>
<ul class="bulleted"><li class="calibre17"><i class="calibre8">App Engine</i>: Integrates Google’s App Engine SDK and tools with Grails.</li>
<li class="calibre17"><i class="calibre8">Quartz</i>: Integrates the Quartz Enterprise Job Scheduler to schedule jobs and have them executed using a specified interval or <span class="FontName">cron</span> expression.</li>
<li class="calibre17"><i class="calibre8">Spring WS</i>: Integrates and supports the provisioning of web services, based on the Spring Web Services project.<a id="cXXX.2249" class="calibre5"></a></li>
<li class="calibre17"><i class="calibre8">Clojure</i>: Integrates Clojure and allows Clojure code to be executed in Grails artifacts.</li></ul>
<p class="indent">To obtain a complete list of Grails plug-ins<a id="cXXX.2046" class="calibre5"></a> you can execute the command: <span class="FontName">grails list-plugins</span>. This last command connects to the Grails plug-in repository and displays all the available Grails plug-ins. In addition, the command <span class="FontName">grails plugin-info &lt;plugin_name&gt;</span> can be used to obtain detailed information about a particular plug-in. As an alternative, you can visit the Grails plug-in page located at <span class="FontName"><a href="http://grails.org/plugin/home" class="calibre5">http://grails.org/plugin/home</a></span>.</p>
<p class="indent">Installing a Grails plug-in requires invoking the following command from a Grails application’s root directory: <span class="FontName">grails install-plugin &lt;plugin_name&gt;</span>.</p>
<p class="indent">Removing a Grails plug-in requires invoking the following command from a Grails application’s root directory: <span class="FontName">grails uninstall-plugin &lt;plugin_name&gt;</span>.</p>
<p id="Sec16" class="Heading1">How It Works<a id="cXXX.1265" class="calibre6"></a></p>
<p class="noindent">A Grails plug-in follows a series of conventions that allow it to tightly integrate a particular Java framework or Java API with Grails. By default, Grails comes with the Apache Tomcat and Hibernate plug-ins preinstalled, and both of these are located under the <span class="FontName">plugins</span> directory of the Grails distribution.</p>
<p class="indent">When you first create a Grails application, these plug-ins are copied to the Grails working directory <span class="FontName">.grails/&lt;grails_version&gt;/plugins</span> located under a user’s home directory. In addition, two files are generated under this same directory: <span class="FontName">plugins-list-core.xml</span> and <span class="FontName">plugins-list-default.xml</span>. The first of which contains plug-ins included in every Grails application, by default Apache Tomcat and Hibernate, and the second containing the entire list of available Grails plug-ins.</p>
<p class="indent">Every Grails application you create afterward includes the plug-ins defined in the <span class="FontName">plugins-list-core.xml</span> file. This inclusion takes place by unzipping each plug-in under an application’s working directory under <span class="FontName">.grails/&lt;grails_version&gt;/projects/&lt;project_name&gt;/plugins/</span>. Once the plug-ins are unzipped, a Grails application is equipped to support whatever functionality is provided by a plug-in.</p>
<p class="indent">Besides these default plug-ins, additional plug-ins can be installed on a per-application basis. For example, to install the Clojure plug-in<a id="cXXX.1266" class="calibre5"></a>, you would execute the following command from an application’s root directory:</p>
<pre class="calibre11"><span class="FontName">grails install-plugin clojure</span></pre>
<p class="indent">This last command downloads and initially copies the Clojure plug-in to the same Grails working directory, <span class="FontName">.grails/&lt;grails_version&gt;/plugins</span>, located under a user’s home directory. Once downloaded, the plug-in is copied as a zip file, as well as unzipped under an application’s working directory under<span class="FontName">.grails/&lt;grails_version&gt;/projects/&lt;project_name&gt;/plugins/</span>.</p>
<p class="indent">To remove a plug-in from a Grails application, you can invoke the following command:</p>
<pre class="calibre11"><span class="FontName">grails uninstall-plugin clojure</span></pre>
<p class="indent">This last command removes the unzipped plug-in from an application’s working directory <span class="FontName">under.grails/&lt;grails_version&gt;/projects/&lt;project_name&gt;/plugins/</span>, though the zipped plug-in file will remain. In addition, the downloaded plug-in remains under the Grails working directory <span class="FontName">.grails/&lt;grails_version&gt;/plugins</span>, located under a user’s home directory.</p>
<p class="indent">This installation and uninstallation of plug-ins <a id="cXXX.1267" class="calibre5"></a>is done on a per-application basis. In order for a plug-in to be automatically added to a Grails application upon creation, you need to modify the <span class="FontName">plugins-list-core.xml</span> file manually. This copies whatever plug-ins you deem necessary on all subsequent application you create, along with the default Apache Tomcat and Hibernate plug-ins.</p>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Caution</b>  Besides the steps outlined here, we do not recommend you modify the structure of a plug-in or a Grails application working directory. Plug-ins always alter the structure of a Grails application to provide it with the necessary functionality. If you encounter problems with a Grails plug-in, we recommend you consult the plug-in’s documentation or ask the plug-in maintainers on the Grails development mailing list at <span class="FontName"><a href="http://grails.org/Mailing%20lists" class="calibre5">http://grails.org/Mailing%20lists</a></span>.</p></div>
<p id="Sec17" class="Heading">18-4. Developing, Producing, and Testing in Grails Environments<a id="cXXX.1268" class="calibre6"></a></p>
<p id="Sec18" class="Heading1">Problem</p>
<p class="noindent">You want to use different parameters for the same application on the basis of the environment (e.g., development, production, and testing) it’s being run in.</p>
<p id="Sec19" class="Heading1">Solution</p>
<p class="noindent">Grails anticipates that a Java application can undergo various phases that require different parameters. These phases, or “environments” as they are called by Grails, can be, for instance, development, production, and testing.</p>
<p class="indent">The most obvious scenario involves data sources, where you are likely to use a different permanent storage system<a id="cXXX.1269" class="calibre5"></a> for development, production, and testing environments. Since each of these storage systems will use different connection parameters, it’s easier to configure parameters for multiple environments and let Grails connect to each one depending on an application’s operations.</p>
<p class="indent">In addition to data sources, Grails provides the same feature for other parameters that can change in between application environments, such as server URLs for creating an application’s absolute links.</p>
<p class="indent">Configuration parameters for a Grails application environment are specified in the files located under an application’s <span class="FontName">/grails-app/conf/</span> directory.</p>
<p id="Sec20" class="Heading1">How It Works</p>
<p class="noindent">Depending on the operation you’re performing, Grails automatically selects the most suitable environment: development, production, or testing.</p>
<p class="indent">For example, when you invoke the command <span class="FontName">grails run-app</span>, this implies that you are still developing an application locally, so a development environment is assumed. In fact, when you execute this command, among the output you can see a line that reads:</p>
<pre class="calibre11"><span class="FontName">Environment set to development</span></pre>
<p class="indent">This means that whatever parameters are set for a development environment are used to build, configure and run the application.</p>
<p class="indent">Another example is the <span class="FontName">grails war</span> command. Since exporting a Grails application to a stand-alone WAR implies you will be running it on an external web container, Grails assumes a production environment. In the output generated for this command, you will find a line that reads<a id="cXXX.1270" class="calibre5"></a></p>
<pre class="calibre11"><span class="FontName">Environment set to production</span></pre>
<p class="indent">This means that whatever parameters are set for a production environment are used to build, configure, and export the application.</p>
<p class="indent">Finally, if you run a command like <span class="FontName">grails test-app</span>, Grails assumes a testing environment. This means that whatever parameters are set for a testing environment are used to build, configure, and run tests. In the output generated for this command, you will find a line that reads</p>
<pre class="calibre11"><span class="FontName">Environment set to test</span></pre>
<p class="indent">Inside the configuration files located in an application‘s directory <span class="FontName">/grails-app/conf/</span>, you can find sections in the following form:</p>
<pre class="calibre11"><span class="FontName">environments {</span><br class="calibre10"/>    <span class="FontName">production {</span><br class="calibre10"/>        <span class="FontName">grails.serverURL = "</span><span class="FontName"><a href="http://www.domain.com" class="calibre5">http://www.domain.com</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">development {</span><br class="calibre10"/>        <span class="FontName">grails.serverURL = "</span><span class="FontName">http://localhost:8080/${appName</span><span class="FontName">}"</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">test {</span><br class="calibre10"/>        <span class="FontName">grails.serverURL = "</span><span class="FontName">http://localhost:8080/${appName</span><span class="FontName">}"</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This last listing belongs to the <span class="FontName">Config.groovy</span> file<a id="cXXX.1271" class="calibre5"></a>. It’s used to specify different server URLs for creating an application’s absolute links on the basis of an application’s environment. Another example would be the section contained in the <span class="FontName">DataSource.groovy</span> file, which is used to define data sources and illustrated next:</p>
<pre class="calibre11"><span class="FontName">environments {</span><br class="calibre10"/>    <span class="FontName">development {</span><br class="calibre10"/>        <span class="FontName">dataSource {</span><br class="calibre10"/>           <span class="FontName">dbCreate = "create-drop" // one of 'create', 'create-drop','update' , 'validate', ''</span><br class="calibre10"/>           <span class="FontName">url = "jdbc:h2:mem:devDb;MVCC=TRUE;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE"</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>     <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">test {</span><br class="calibre10"/>        <span class="FontName">dataSource {</span><br class="calibre10"/>           <span class="FontName">dbCreate = "update"</span><br class="calibre10"/>           <span class="FontName">url = "jdbc:h2:mem:testDb;MVCC=TRUE;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE"</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">production {</span><br class="calibre10"/>        <span class="FontName">dataSource {</span><br class="calibre10"/>             <span class="FontName">dbCreate = "update"</span><br class="calibre10"/>             <span class="FontName">"jdbc:h2:prodDb;MVCC=TRUE;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE"</span><br class="calibre10"/>             <span class="FontName">properties { ... }</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>     <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In this last listing, different connection parameters are specified for permanent storage systems on the basis of an application’s environment. This allows an application to operate on different data sets, as you will surely not want development modifications to take place on the same data set used in a production environment. It should be noted that this doesn’t mean these last examples are the only parameters that are allowed to be configured on the basis of an application’s environment. You can equally place any parameter inside the corresponding <span class="FontName">environments { &lt;environment_phase&gt; }</span> section. These last examples simply represent the most likely parameters to change in between an application’s environments.</p>
<p class="indent">It’s also possible to perform programming logic (e.g., within a class or script) on the basis of a given application’s environment. This is achieved through the <span class="FontName">grails.util.Environment</span> class. The following listing illustrates this process.</p>
<pre class="calibre11"><span class="FontName">import grails.util.Environment</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">switch(Environment.current) {</span><br class="calibre10"/>    <span class="FontName">case Environment.DEVELOPMENT:</span><br class="calibre10"/>       <span class="FontName">// Execute development logic</span><br class="calibre10"/>    <span class="FontName">break</span><br class="calibre10"/>    <span class="FontName">case Environment.PRODUCTION:</span><br class="calibre10"/>       <span class="FontName">// Execute production logic</span><br class="calibre10"/>    <span class="FontName">break</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This last code snippet illustrates how a class first imports the <span class="FontName">grails.util.Environment</span> class. Then, on the basis of the <span class="FontName">Environment.current</span> value, which contains the environment an application is being run on, the code uses a <span class="FontName">switch</span> conditional to execute logic depending on this value.</p>
<p class="indent">Such a scenario can be common in areas like sending out emails or performing geolocation. It would not make sense to send out e-mails or determine where a user is located on a development environment, given that a development team’s location is irrelevant in addition to not requiring an application’s e-mail notifications.</p>
<p class="indent">Finally, it’s worth mentioning that you can override the default environment used for any Grails command.</p>
<p class="indent">For example, by default, the <span class="FontName">grails run-app</span> command uses the parameters specified for a development environment. If for some reason you want to run this command with the parameters specified for a production environment, you can do so using the following instruction: <span class="FontName">grails prod run-app</span>. If you wish to use the parameters specified for a test environment, you can also do so by using the following instruction: <span class="FontName">grails test run-app</span>. <a id="cXXX.1272" class="calibre5"></a></p>
<p class="indent">By the same token, for a command like <span class="FontName">grails test-app</span>, which uses the parameters specified for a test environment, you can use the parameters belonging to a development environment by using the command <span class="FontName">grails dev test-app</span>. The same case applies for all other commands, by simply inserting the <span class="FontName">prod</span>, <span class="FontName">test</span>, or <span class="FontName">dev</span> keyword after the <span class="FontName">grails</span> command.</p>
<p id="Sec21" class="Heading">18-5. Creating an Application’s Domain Classes</p>
<p id="Sec22" class="Heading1">Problem<a id="cXXX.1273" class="calibre6"></a></p>
<p class="noindent">You need to define an application’s domain classes.<a id="cXXX.2028" class="calibre5"></a></p>
<p id="Sec23" class="Heading1">Solution</p>
<p class="noindent">Domain classes<a id="cXXX.1274" class="calibre5"></a> are used to describe an application’s primary elements and characteristics. If an application is designed to attend reservations, it’s likely to have a domain class for holding reservations. Equally, if reservations are associated with a person, an application<a id="cXXX.2039" class="calibre5"></a> will have a domain class for holding persons.</p>
<p class="indent">In web applications, domain classes are generally the first things to be defined, because these classes represent data that is saved for posterity—in a permanent storage system—so it interacts with controllers, as well as representing data displayed in views.</p>
<p class="indent">In Grails, domain classes are placed under the <span class="FontName">/grails-app/domain/</span> directory. The creation of domain classes, like most other things in Grails, can be carried out by executing a simple command in the following form:</p>
<pre class="calibre11"><span class="FontName">grails create-domain-class &lt;domain_class_name&gt;</span></pre>
<p class="indent">This last command generates a skeleton domain class file named <span class="FontName">&lt;domain_class_name&gt;.groovy</span> inside the <span class="FontName">/grails-app/domain/</span> directory.</p>
<p id="Sec24" class="Heading1">How It Works<a id="cXXX.1275" class="calibre6"></a></p>
<p class="noindent">Grails creates skeleton domain classes, but you still need to modify each domain class to reflect the purpose of an application.</p>
<p class="indent">Let’s create a reservation system, similar to the one you created back in <a href="part0014.html" class="calibre5">Chapter 4</a> to experiment with Spring MVC. Create two domain classes, one named <span class="FontName">Reservation</span> and another named <span class="FontName">Player</span>. To do so, execute the following commands:</p>
<pre class="calibre11"><span class="FontName">grails create-domain-class Player</span><br class="calibre10"/><span class="FontName">grails create-domain-class Reservation</span></pre>
<p class="indent">By executing these last commands, a class file named <span class="FontName">Player.groovy</span> and another one named <span class="FontName">Reservation.groovy1</span> are placed under an application’s <span class="FontName">/grails-app/domain/</span> directory. In addition, corresponding unit tests files are also generated for each domain class under an application’s <span class="FontName">test/unit</span> directory, though testing will be addressed in a Recipe 18-10.</p>
<p class="indent">Next, open the <span class="FontName">Player.groovy</span> class to edit its contents. The following statements in bold represent the declarations you need to add to this domain class:</p>
<pre class="calibre11"><span class="FontName">class Player {</span><br class="calibre10"/>    <b class="calibre4">static hasMany = [ reservations : Reservation ]</b><br class="calibre10"/>    <b class="calibre4">String name</b><br class="calibre10"/>    <b class="calibre4">String phone</b><br class="calibre10"/>    <span class="FontName">static constraints = {</span><br class="calibre10"/>      <b class="calibre4">name(blank:false)</b><br class="calibre10"/>      <b class="calibre4">phone(blank:false)</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent"><a id="cXXX.1276" class="calibre5"></a></p>
<p class="indent">The first addition, <span class="FontName">static hasMany = [ reservations : Reservation ]</span>, represents a relationship among domain classes. This statement indicates that the <span class="FontName">Player</span> domain class has a <span class="FontName">reservations</span> field that has many <span class="FontName">Reservation</span> objects associated with it. The following statements indicate that the <span class="FontName">Player</span> domain class also has two <span class="FontName">String</span> fields, one called <span class="FontName">name</span> and another called <span class="FontName">phone</span>.</p>
<p class="indent">The remaining element, <span class="FontName">static constraints = { }</span>, defines constraints on the domain class. In this case, the declaration <span class="FontName">name(blank:false)</span> indicates that a <span class="FontName">Player</span> object’s <span class="FontName">name</span> field cannot be left blank. While the declaration <span class="FontName">phone(blank:false)</span> indicates that a <span class="FontName">Player</span> object cannot be created unless the <span class="FontName">phone</span> field is provided with a value.</p>
<p class="indent">Once you modify the <span class="FontName">Player</span> domain class, open the <span class="FontName">Reservation.groovy</span> class to edit its contents. The following statements in bold represent the declarations you need to add to this domain class:</p>
<pre class="calibre11"><span class="FontName">class Reservation {</span><br class="calibre10"/>    <b class="calibre4">static belongsTo = Player</b><br class="calibre10"/>    <b class="calibre4">String courtName;</b><br class="calibre10"/>    <b class="calibre4">Date date;</b><br class="calibre10"/>    <b class="calibre4">Player player;</b><br class="calibre10"/>    <b class="calibre4">String sportType;</b><br class="calibre10"/>    <span class="FontName">static constraints = {</span><br class="calibre10"/>       <b class="calibre4">sportType(inList:["Tennis", "Soccer"] )</b><br class="calibre10"/>       <b class="calibre4">date(validator: {</b><br class="calibre10"/>            <b class="calibre4">if (it.getAt(Calendar.DAY_OF_WEEK) == "SUNDAY"</b> <span class="FontName">&amp;&amp;</span><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>                                 <b class="calibre4">( it.getAt(Calendar.HOUR_OF_DAY) &lt; 8 ||</b><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>                               <b class="calibre4">it.getAt(Calendar.HOUR_OF_DAY) &gt; 22)) {</b><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>                                 <b class="calibre4">return ['invalid.holidayHour']</b><br class="calibre10"/>           <b class="calibre4">} else if ( it.getAt(Calendar.HOUR_OF_DAY)  &lt; 9 ||</b><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>                        <b class="calibre4">it.getAt(Calendar.HOUR_OF_DAY) &gt; 21) {</b><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>                                 <b class="calibre4">return ['invalid.weekdayHour']</b><br class="calibre10"/>         <b class="calibre4">}</b><br class="calibre10"/>        <b class="calibre4">})</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The first statement added to the <span class="FontName">Reservation</span> domain class, <span class="FontName">static belongsTo = Player</span>, indicates that a <span class="FontName">Reservation</span> object always belongs to a <span class="FontName">Player</span> object. The following statements indicate the <span class="FontName">Reservation</span> domain class has a field named <span class="FontName">courtName</span> of the type <span class="FontName">String</span>, a field named <span class="FontName">date</span> of the type <span class="FontName">Date</span>, a field named <span class="FontName">player</span> of the type <span class="FontName">Player</span> and another field named <span class="FontName">sportType</span> of the type <span class="FontName">String</span>.</p>
<p class="indent">The constraints for the <span class="FontName">Reservation</span> domain class are a little more elaborate than the <span class="FontName">Player</span> domain class. The first constraint, <span class="FontName">sportType(inList:["Tennis", "Soccer"] )</span>, restricts the <span class="FontName">sportType</span> field of a <span class="FontName">Reservation</span> object to a string value of either <span class="FontName">Tennis</span> or <span class="FontName">Soccer</span>. The second constraint is a custom-made validator to ensure the <span class="FontName">date</span> field of a <span class="FontName">Reservation</span> object is within a certain hour range depending on the day of the week.</p>
<p class="indent">Now that you have an application’s domain classes, you can create the corresponding views and controllers for an application. <a id="cXXX.1277" class="calibre5"></a></p>
<p class="indent">Before proceeding, though, a word on Grails domain classes is in order. While the domain classes you created in this recipe provide you with a basic understanding of the syntax used to define Grails domain classes, they illustrate only a fraction of the features available in Grails domain classes.</p>
<p class="indent">As the relationship between domain classes grows more elaborate, more sophisticated constructs are likely to be required for defining Grails domain classes. This comes as a consequence of Grails relying on domain classes for various application functionalities.</p>
<p class="indent">For example, if a domain object is updated or deleted from an application’s permanent storage system, the relationships between domain classes need to be well established. If relationships are not well established, there is a possibility for inconsistent data to arise in an application (e.g., if a person object is deleted, its corresponding reservations also need to be deleted to avoid an inconsistent state in an application’s reservations).</p>
<p class="indent">Equally, a variety of constraints can be used to enforce a domain class’s structure. Under certain circumstances,if a constraint is too elaborate, it’s often incorporated within an application’s controller prior to creating an object of a certain domain class. Though for this recipe, model constraints were used to illustrate the design of Grails domain classes.</p>
<p id="Sec25" class="Heading">18-6. Generating CRUD Controllers and Views for an Application’s Domain Classes<a id="cXXX.1278" class="calibre6"></a></p>
<p id="Sec26" class="Heading1">Problem</p>
<p class="noindent">You need to generate create, read, update, and delete (CRUD) controllers<a id="cXXX.1279" class="calibre5"></a> and views for an application’s domain classes.</p>
<p id="Sec27" class="Heading1">Solution</p>
<p class="noindent">An application’s domain classes by themselves are of little use. The data mapped to domain classes still needs to be created<a id="cXXX.2011" class="calibre5"></a>, presented to end users, and potentially saved for future use in a permanent storage system.</p>
<p class="indent">In web applications backed by permanent storage systems, these operations on domain classes are often referred to as CRUD operations. In the majority of web frameworks, generating CRUD controllers and views entails a substantial amount of work. This is on account of needing controllers capable of creating, reading, updating, and deleting domain objects to a permanent storage systems, as well as creating the corresponding views (e.g., JSP pages) for an end user to create, read, update, and delete these same objects.</p>
<p class="indent">However, since Grails operates on the basis of conventions, the mechanism for generating CRUD controllers and views for an application’s domain classes is easy. You can execute the following command to generate the corresponding CRUD controller and views for an application’s domain class:</p>
<pre class="calibre11"><span class="FontName">grails generate-all &lt;domain_class_name&gt;</span></pre>
<p id="Sec28" class="Heading1">How It Works<a id="cXXX.1280" class="calibre6"></a></p>
<p class="noindent">Grails is capable of inspecting an application’s domain classes and generating the corresponding controllers and views necessary to create, read, update, and delete instances belonging to an application’s domain classes.</p>
<p class="indent">For example, take the case of the <span class="FontName">Player</span> domain class you created earlier. In order to generate its CRUD controller and views, you only need to execute the following command from an application’s root directory:</p>
<pre class="calibre11"><span class="FontName">grails generate-all court.Player</span><a id="cXXX.1281" class="calibre5"></a></pre>
<p class="indent">A similar command would apply to the <span class="FontName">Reservation</span> domain class. Simply execute the following command to generate its CRUD controller and views:</p>
<pre class="calibre11"><span class="FontName">grails generate-all court.Reservation</span><a id="cXXX.1282" class="calibre5"></a></pre>
<p class="indent">So what is actually generated by executing these steps? If you saw the output for these commands you will have a pretty good idea, but I will recap the process here nonetheless.</p>
<ol class="OrderedList"><li value="1" class="calibre17">Compile an application’s classes.</li>
<li value="2" class="calibre17">Generate 12 properties files under the directory <span class="FontName">grails-app/i18n</span> to support an application’s internationalization(e.g., <span class="FontName">messages_&lt;language&gt;.properties</span>).</li>
<li value="3" class="calibre17">Create a controller named <span class="FontName">&lt;domain_class&gt;Controller.groovy</span>  with CRUD operations designed for an RDBMS, placed under an application’s  <span class="FontName">grails-app/controllers</span> directory.</li>
<li value="4" class="calibre17">Create four views corresponding to a controller class’s CRUD operations named <span class="FontName">create.gsp</span>, <span class="FontName">edit.gsp</span>, <span class="FontName">list.gsp</span>, and <span class="FontName">show.gsp</span>. Note that the <span class="FontName">.gsp</span> extension stands for “Groovy Server Pages,” which is equivalent to JavaServer Pages except it uses Groovy to declare programmatic statements instead of Java. These views are placed under an application’s <span class="FontName">grails-app/views/&lt;domain_class&gt;</span>  directory.</li></ol><p class="indent">Once you finish these steps, you can start the Grails application using <span class="FontName">grails run-app</span> and work as an end user with the application. Yes, you read correctly; after performing these simple commands, the application is now ready to for end users. This is the mantra of Grails operating on conventions, to simplify the creation of scaffolding code through one word commands.<a id="cXXX.1283" class="calibre5"></a></p>
<p class="indent">After the application is started, you can perform CRUD operations on the <span class="FontName">Player</span> domain class at the following URLs: <a id="cXXX.1284" class="calibre5"></a></p>
<ul class="bulleted"><li class="calibre17">Create: <span class="FontName">http://localhost:8080/court/player/create</span></li>
<li class="calibre17">Read: <span class="FontName">http://localhost:8080/court/player/list</span> (for all players) or <span class="FontName">http://localhost:8080/court/player/show/&lt;player_id</span><span class="FontName">&gt;</span></li>
<li class="calibre17">Update: <span class="FontName">http://localhost:8080/court/player/edit/&lt;player_id</span><span class="FontName">&gt;</span></li>
<li class="calibre17">Delete: <span class="FontName">http://localhost:8080/court/player/delete/&lt;player_id</span><span class="FontName">&gt;</span></li></ul>
<p class="indent">The page navigation between each view is more intuitive than these URLs have it to be, but we will illustrate with a few screen shots shortly. An important thing to be aware about these URLs is their conventions. Notice the pattern <span class="FontName">&lt;domain&gt;/&lt;app_name&gt;/&lt;domain_class&gt;/&lt;crud_action&gt;/&lt;object_id&gt;</span>, where <span class="FontName">&lt;object_id&gt;</span> is optional depending on the operation.</p>
<p class="indent">In addition to being used to define URL patterns, these conventions are used throughout an application’s artifacts. For example, if you inspect the <span class="FontName">PlayerController.groovy</span> controller, you can observe there are handler methods named like the various <span class="FontName">&lt;crud_action&gt;</span> values. Similarly, if you inspect an application’s backing RDBMS, you can note that the domain class objects are saved using the same <span class="FontName">&lt;player_id&gt;</span> used in a URL.</p>
<p class="indent">Now that you’re aware of how CRUD operations are structured in Grails applications, create a <span class="FontName">Player</span> object by visiting the address <span class="FontName">http://localhost:8080/court/player/create</span>. Once you visit this page, you can see an HTML form with the same field values you defined for the <span class="FontName">Player</span> domain class.</p>
<p class="indent">Introduce any two values for the <span class="FontName">name</span> and <span class="FontName">phone</span> fields and submit the form. You’ve just persisted a <span class="FontName">Player</span> object to a RDBMS. By default, Grails come preconfigured to use HSQLDB, an in-memory RDBMS. A future recipe will illustrate how to change this to another RDBMS<a id="cXXX.1285" class="calibre5"></a>, for now HSQLDB will suffice.</p>
<p class="indent">Next, try submitting the same form but, this time, without any values. Grails will not persist the <span class="FontName">Player</span> object, it will instead show two warning messages indicating that the <span class="FontName">name</span> and <span class="FontName">phone</span> fields cannot be blank. <a id="_Fig2" href="part0028.html#Fig2" class="calibre5">Figure 18-2</a> illustrates this screen shot.</p>
<div class="Figure" id="Fig2">
<p class="img1"><img src="../images/00087.jpeg" alt="9781430259084_Fig18-02.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0028.html#_Fig2" class="calibre5">Figure 18-2</a>.</span> Grails domain class validation taking place in a view (in this case, an HTML form) <a id="cXXX.1286" class="calibre5"></a></p></div>
<p class="indent">This validation process is being enforced on account of the statements, <span class="FontName">name(blank:false)</span> and <span class="FontName">phone(blank:false)</span>, which you placed in the <span class="FontName">Player</span> domain class. You didn’t need to modify an application’s controllers or views or even create properties files for these error messages; everything was taken care of by Grails convention=based approach.</p>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  When using a HTML5 capable browser you won’t be allowed to submit the form. Both input elements are marked <span class="FontName">required</span> which prevent the form submission in these browsers. These rules are also added based on statement mentioned above.</p></div>
<p class="indent">Experiment with the remaining views available for the <span class="FontName">Player</span> domain class, creating, reading, updating, and deleting objects directly from a web browser to get a feel for how Grails handles these tasks.</p>
<p class="indent">Moving along the application, you can also perform CRUD operations on the <span class="FontName">Reservation</span> domain class at the following URLs: <a id="cXXX.1287" class="calibre5"></a></p>
<ul class="bulleted"><li class="calibre17">Create: <span class="FontName"><a href="http://localhost:8080/court/reservation/create" class="calibre5">http://localhost:8080/court/reservation/create</a></span></li>
<li class="calibre17">Read: <span class="FontName"><a href="http://localhost:8080/court/reservation/list" class="calibre5">http://localhost:8080/court/reservation/list</a></span> (for all reservations) or <span class="FontName"><a href="http://localhost:8080/court/reservation/show/&lt;reservation_id" class="calibre5">http://localhost:8080/court/reservation/show/&lt;reservation_id</a></span><span class="FontName">&gt;</span></li>
<li class="calibre17">Update: <span class="FontName"><a href="http://localhost:8080/court/reservation/edit/&lt;reservation_id" class="calibre5">http://localhost:8080/court/reservation/edit/&lt;reservation_id</a></span><span class="FontName">&gt;</span></li>
<li class="calibre17">Delete: <span class="FontName"><a href="http://localhost:8080/court/reservation/delete/&lt;reservation_id" class="calibre5">http://localhost:8080/court/reservation/delete/&lt;reservation_id</a></span><span class="FontName">&gt;</span></li></ul>
<p class="indent">These last URLs serve the same purpose as those for the <span class="FontName">Player</span> domain class. The ability to create, read, update, and delete objects belonging to the <span class="FontName">Reservation</span> domain class from a web interface.</p>
<p class="indent">Next, let’s analyze the HTML form used for creating <span class="FontName">Reservation</span> objects, available at the URL <span class="FontName"><a href="http://localhost:8080/court/reservation/create" class="calibre5">http://localhost:8080/court/reservation/create</a></span>. <a id="_Fig3" href="part0028.html#Fig3" class="calibre5">Figure 18-3</a> illustrates this form.</p>
<div class="Figure" id="Fig3">
<p class="img1"><img src="../images/00088.jpeg" alt="9781430259084_Fig18-03.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0028.html#_Fig3" class="calibre5">Figure 18-3</a>.</span> Grails domain class HTML form, populated with domain objects from separate class<a id="cXXX.1288" class="calibre5"></a></p></div>
<p class="indent"><a href="part0028.html#Fig3" class="calibre5">Figure 18-3</a> is interesting in various ways. Though the HTML form is still created on the basis of the fields of the <span class="FontName">Reservation</span> domain class, just like the HTML form for the <span class="FontName">Player</span> domain class, notice that it has various prepopulated HTML select menus.</p>
<p class="indent">The first select menu belongs to the <span class="FontName">sportType</span> field. Since this particular field has a definition constraint to have a string value of either <span class="FontName">Soccer</span> or <span class="FontName">Tennis</span>, Grails automatically provides a user with these options instead of allowing open-ended strings and validating them afterward.</p>
<p class="indent">The second select menu belongs to the <span class="FontName">date</span> field. In this case, Grails generates various HTML select menus representing a date and time to make the date-selection process easier, instead of allowing open-ended dates and validating them afterward.</p>
<p class="indent">The third select menu belongs to the <span class="FontName">player</span> field. This select menu’s options are different in the sense they are taken from the <span class="FontName">Player</span> objects you’ve created for the application. The values are being extracted from querying the application’s RDBMS; if you add another <span class="FontName">Player</span> object, it will automatically become available in this select menu.</p>
<p class="indent">In addition, a validation process is performed on the <span class="FontName">date</span> field. If the selected date does not conform to a certain range, the <span class="FontName">Reservation</span> object cannot be persisted and a warning message appears on the form.</p>
<p class="indent">Try experimenting with the remaining views available for the <span class="FontName">Reservation</span> domain class, creating, reading, updating, and deleting objects directly from a web browser.</p>
<p class="indent">Finally, just to keep things in perspective, realize what your application is already doing in a few steps: validating input; creating, reading, updating and deleting objects from a RDBMS; completing HTML forms from data in a RDBMS; and supporting internationalization. And you haven’t even modified a configuration file, been required to use HTML, or needed to deal with SQL or object-relational mappers (ORMs)<a id="cXXX.1289" class="calibre5"></a>. <a id="cXXX.1290" class="calibre5"></a></p>
<p id="Sec29" class="Heading">18-7. Internationalization (I18n) Message Properties<a id="cXXX.2067" class="calibre6"></a></p>
<p id="Sec30" class="Heading1">Problem<a id="cXXX.1291" class="calibre6"></a></p>
<p class="noindent">You need to internationalize values used throughout a Grails application.</p>
<p id="Sec31" class="Heading1">Solution</p>
<p class="noindent">By default, all Grails applications are equipped to support internationalization. Inside an application’s <span class="FontName">/grails-app/i18n/</span> folder, you can find series of <span class="FontName">*.properties</span> files used to define messages in 12 languages.</p>
<p class="indent">The values declared in these <span class="FontName">*.properties</span> files allow Grails applications to display messages based on a user’s languages preferences or an application’s default language. Within a Grails application, the values declared in <span class="FontName">*.properties</span> files can be accessed from places that include views (JSP or GSP pages) or an application’s context.</p>
<p id="Sec32" class="Heading1">How It Works<a id="cXXX.1292" class="calibre6"></a></p>
<p class="noindent">Grails determines which locale (i.e., from an internationalization properties file) to use for a user based on two criteria:</p>
<ul class="bulleted"><li class="calibre17">The explicit configuration inside an application’s <span class="FontName">/grails-app/conf/spring/resource.groovy</span> file</li>
<li class="calibre17">A user’s browser language preferences</li></ul>
<p class="indent">Since the explicit configuration of an application’s locale takes precedence over a user’s browser language preferences, there is no default configuration present in an application’s <span class="FontName">resource.groovy</span> file.</p>
<p class="indent">This ensures that if a user’s browser language preferences <a id="cXXX.1293" class="calibre5"></a>are set to Spanish (<span class="FontName">es</span>) or German (<span class="FontName">de</span>), a user is served messages from the Spanish or German properties files (e.g., <span class="FontName">messages_es.properties</span> or <span class="FontName">messages_de.properties</span>). On the other hand, if an application’s <span class="FontName">resource.groovy</span> file is configured to use Italian (<span class="FontName">it</span>), it won’t matter what a user’s browser language preferences are; a user will always be served messages from the Italian properties file (e.g., <span class="FontName">messages_it.properties</span>).</p>
<p class="indent">Therefore, you should define an explicit configuration inside an application’s <span class="FontName">/grails-app/conf/spring/resource.groovy</span> file, only if you want to coerce users into using a specific language locale. For example, maybe you don’t want to update several internationalization properties files or maybe you simply value uniformity.</p>
<p class="indent">Since Grails internationalization is based on Spring’s Locale Resolver, you need to place the following contents inside an application’s <span class="FontName">/grails-app/conf/spring/resource.groovy</span> file, in order to force a specific language on users:</p>
<pre class="calibre11"><span class="FontName">import org.springframework.web.servlet.i18n.SessionLocaleResolver</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">beans = {</span><br class="calibre10"/> <span class="FontName">localeResolver(SessionLocaleResolver) {</span><br class="calibre10"/>    <span class="FontName">defaultLocale= Locale.ENGLISH</span><br class="calibre10"/>    <span class="FontName">Locale.setDefault (Locale.ENGLISH)</span><br class="calibre10"/>  <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">By using this last declaration, any visitor is served messages from the English properties files (e.g. <span class="FontName">messages_en.properties</span>) irrespective of his or her browser’s language preferences. <a id="cXXX.1294" class="calibre5"></a></p>
<p class="indent">It’s also worth mentioning that if you specify a locale for which there are no available properties files, Grails reverts back to using the default <span class="FontName">messages.properties</span> file, which by default is written in English though you can easily modify its values to reflect another language if you prefer. This same scenario applies when a user’s browser language preferences are the defining selection criteria (e.g., if a user browser’s language preferences are set for Chinese and there is no Chinese properties file, Grails falls back to using the default <span class="FontName">messages.properties</span> file).</p>
<p class="indent">Now that you know how Grails determines which properties file to choose from in order to serve localized content, let’s take a look at the syntax of a Grails <span class="FontName">*.properties</span> file. <a id="cXXX.1295" class="calibre5"></a></p>
<pre class="calibre11"><span class="FontName">default.paginate.next=Next</span><br class="calibre10"/><span class="FontName">typeMismatch.java.net.URL=Property {0} must be a valid URL</span><br class="calibre10"/><span class="FontName">default.blank.message=Property [{0}] of class [{1}] cannot be blank</span><br class="calibre10"/><span class="FontName">default.invalid.email.message=Property [{0}] of class [{1}] with value</span><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/><span class="FontName">[{2}] is not a valid e-mail address</span><br class="calibre10"/><span class="FontName">default.invalid.range.message=Property [{0}] of class [{1}] with value</span><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/><span class="FontName">[{2}] does not fall within the valid range from [{3}] to [{4}]</span></pre>
<p class="indent">The first line is the simplest declaration possible in a <span class="FontName">*.properties</span> file. If Grails encounters the property named <span class="FontName">default.paginate.next</span> in an application, it will substitute it for the value <span class="FontName">Next</span>, or whatever other value is specified for this same property based on a user’s determining locale.</p>
<p class="indent">On certain occasions, it can be necessary to provide more explicit messages that are best determined from wherever a localized message is being called. This is the purpose of the keys <span class="FontName">{0}</span>, <span class="FontName">{1}</span>, <span class="FontName">{2}</span>, <span class="FontName">{3}</span>, and <span class="FontName">{4}</span>, they are parameters used in conjunction with a localized property. In this manner, the localized message displayed to a user can convey more detailed information. <a id="_Fig4" href="part0028.html#Fig4" class="calibre5">Figure 18-4</a> illustrates localized and parameterized messages for the court application determined on a user browser’s language preferences.</p>
<div class="Figure" id="Fig4">
<p class="img1"><img src="../images/00089.jpeg" alt="9781430259084_Fig18-04.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0028.html#_Fig4" class="calibre5">Figure 18-4</a>.</span> Grails localized and parameterized messages, determined on a user browser’s language preferences (Left-Right, Top-Down: Spanish, German, Italian, and French)</p></div>
<p class="indent">Armed with this knowledge, define the following four properties inside Grails <span class="FontName">message.properties</span> files:</p>
<pre class="calibre11"><span class="FontName">invalid.holidayHour=Invalid holiday hour</span><br class="calibre10"/><span class="FontName">invalid.weekdayHour=Invalid weekday hour</span><br class="calibre10"/><span class="FontName">welcome.title=Welcome to Grails</span><br class="calibre10"/><span class="FontName">welcome.message=Welcome to Court Reservation System</span></pre>
<p class="indent">Next, it’s time to explore how property placeholders are defined in Grails applications.</p>
<p class="indent">Back in Recipe 18-5, “Defining an Application’s Domain Classes,” you might not have realized it, but you declared a localized property for the <span class="FontName">Reservation</span> domain class. In the validation section (<span class="FontName">static constraints =  { }</span>), you created this statement in the form:</p>
<pre class="calibre11"><span class="FontName">return ['invalid.weekdayHour']</span></pre>
<p class="indent">If this statement is reached, Grails attempts to locate a property named <span class="FontName">invalid.weekdayHour</span> inside a properties file and substitute its value on the basis of a user’s determining locale.</p>
<p class="indent">It’s also possible to introduce localized properties into an application’s views. For example, you can modify the GSP page created in Recipe 18-2 and located under <span class="FontName">/court/grails-app/views/welcome/index.gsp</span> to use the following</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="fmt" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/fmt" class="calibre5">http://java.sun.com/jsp/jstl/fmt</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><b class="calibre4">&lt;%@ taglib prefix="g" uri="</b><b class="calibre4"><a href="http://grails.codehaus.org/tags" class="calibre5">http://grails.codehaus.org/tags</a></b><b class="calibre4">" %&gt;</b><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;!DOCTYPE html&gt;</span><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;title&gt;</span><b class="calibre4">&lt;g:message code="welcome.title"/&gt;</b><span class="FontName">&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;g:message code="welcome.message"/&gt;&lt;/h2&gt;</span><br class="calibre10"/><span class="FontName">Today is &lt;g:formatDate format="yyyy-MM-dd" date="${today}"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">This GSP page uses the <span class="FontName">&lt;g:message/&gt;</span>tag then using the <span class="FontName">code</span> attribute, the properties <span class="FontName">welcome.title</span> and <span class="FontName">welcome.messsage</span> are defined, both of which will be replaced with the corresponding localized values once the JSP is rendered. <a id="cXXX.1296" class="calibre5"></a></p>
<p id="Sec33" class="Heading">18-8. Changing Permanent Storage Systems<a id="cXXX.1297" class="calibre6"></a></p>
<p id="Sec34" class="Heading1">Problem<a id="cXXX.1298" class="calibre6"></a></p>
<p class="noindent">You want to change a Grails application’s permanent storage system to your favorite RDBMS.</p>
<p id="Sec35" class="Heading1">Solution</p>
<p class="noindent">Grails is designed to use a RDBMS as a permanent storage system. By default, Grails comes preconfigured to use HSQLDB. <a id="cXXX.1299" class="calibre5"></a>HSQLDB is a database that is automatically started by Grails upon deploying an application (i.e., executing <span class="FontName">grails run-app</span>).</p>
<p class="indent">However, the simplicity of HSQLDB can also be its primary drawback. Every time an application is restarted in development and testing environments, HSQLDB loses all its data since it’s configured to operate in memory. And even though Grails applications in a production environment are configured with HSQLDB to store data permanently on a file, HSQLDB feature set may be seen as a limited for certain application demands.</p>
<p class="indent">You can configure Grails to use another RDBMS by modifying an application’s <span class="FontName">DataSource.groovy</span> file, located under the <span class="FontName">grails-app/conf</span> directory. Inside this file, you can configure up to three RDBMS, one for each environment—development, production, and testing— undertaken by an application. See Recipe 18-4, “Developing, producing, and testing Grails Environments,” for more on development, production, and testing environments in Grails applications.</p>
<p id="Sec36" class="Heading1">How It Works</p>
<p class="noindent">Grails relies on the standard Java JDBC notation to specify RDBMS connection parameters, as well as on the corresponding JDBC drivers provided by each RDBMS vendor, to create, read, update, and delete information.</p>
<p class="indent">One important aspect you need to be aware of if you change RDBMS, is that Grails uses an ORM called Groovy Object Relational Mapper (GROM<a id="cXXX.1300" class="calibre5"></a>)<a id="cXXX.1301" class="calibre5"></a> to interact with a RDBMS.</p>
<p class="indent">The purpose behind GROM is the same as all other ORM solutions—to allow you to concentrate on an application’s business logic, without worrying about the particularities of an RDBMS implementation, which can range from discrepancies in data types to working with SQL directly. GROM allows you to design an application’s domain classes and maps your design to the RDBMS of your choice.</p>
<p id="Sec37" class="Heading2">Setting Up an RDBMS Driver</p>
<p class="noindent">The first step you need to take in changing Grails default RDBMS is to install the JDBC driver <a id="cXXX.1302" class="calibre5"></a>for the RDBMS of your choice inside an application’s <span class="FontName">lib</span> directory. This allows the application access to the JDBC classes needed to persist objects to a particular RDBMS.</p>
<p id="Sec38" class="Heading2">Configuring an RDBMS Instance</p>
<p class="noindent">The second step consists of modifying the <span class="FontName">DataSource.groovy</span> file <a id="cXXX.1303" class="calibre5"></a>located under an application’s <span class="FontName">grails-app/conf</span> directory. Inside this file, there are three sections for defining an RDBMS instance.</p>
<p class="indent">Each RDBMS instance corresponds to a different possible application environment: development, production, and testing. Depending on the actions you take, Grails chooses one of these instances to perform any permanent storage operations an application is designed to do. See Recipe 18-4, “Developing, producing, and testing Grails Environments,” for more on development, production, and testing environments in Grails applications.</p>
<p class="indent">However, the syntax used for declaring a RDBMS in each of these sections is the same. <a id="_Tab1" href="part0028.html#Tab1" class="calibre5">Table 18-1</a> contains the various properties that can be used in a <span class="FontName">dataSource</span> definition for the purpose of configuring a RDBMS.</p>
<div class="Table" id="Tab1">
<p class="TabCapt"><span class="calibre4"><a href="part0028.html#_Tab1" class="calibre5">Table 18-1</a>.</span> dataSource properties for configuring a RDBMS<a id="cXXX.1304" class="calibre5"></a></p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14">
<p class="tab-left">Property</p></th><th valign="top" class="calibre14">
<p class="tab-left">Definition</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">driverClassName</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Class name for the JDBC driver</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">username</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Username to establish a connection to a RDBMS</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">password</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Password to establish a connection to a RDBMS</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">url</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">URL connection parameters for a RDBMS</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">pooled</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Indicates whether to use connection pooling for a RDMBS; defaults to <span class="FontName">true</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">jndiName</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Indicates a JNDI connection string for a data source. (This is an alternative to configuring <span class="FontName">driverClassName</span>, <span class="FontName">username</span>, <span class="FontName">password</span>, and <span class="FontName">url</span> directly in Grails and instead relying on a data source being configured in a web container.)</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">logSql</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Indicates whether to enable SQL logging</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">dialect</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Indicates the RDBMS dialect to perform operations.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">properties</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Used to indicate extra parameters for RDBMS operation</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">dbCreate</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Indicates auto-generation of RDBMS data definition language (DDL)</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">dbCreate value</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Definition</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">create-drop</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Drops and recreates the RDBMS DDL when Grails is run (Warning: Deletes all existing data in the RDBMS.)</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">create</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Creates the RDBMS DDL if it doesn’t exist, but doesn’t modify if it does (Warning: Deletes all existing data in the RDBMS.)</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">update</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Creates the RDBMS DDL if it doesn’t exist or update if it does</p></td></tr></tbody></table>
</div>
<p class="indent">If you’ve used a Java ORM, such as Hibernate or EclipseLink, the parameters in <a href="part0028.html#Tab1" class="calibre5">Table 18-1</a> should be fairly familiar. The following listing illustrates the <span class="FontName">dataSource</span> definition for a MySQL RDBMS: <a id="cXXX.1305" class="calibre5"></a></p>
<pre class="calibre11"><span class="FontName">dataSource {</span><br class="calibre10"/>    <span class="FontName">dbCreate = "update"</span><br class="calibre10"/>    <span class="FontName">url = "jdbc:mysql://localhost/grailsDB"</span><br class="calibre10"/>    <span class="FontName">driverClassName = "com.mysql.jdbc.Driver"</span><br class="calibre10"/>    <span class="FontName">username = "grails"</span><br class="calibre10"/>    <span class="FontName">password = "groovy"</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Of the properties in this last definition, the one you should be most careful with is <span class="FontName">dbCreate</span>, since it can destroy data in a RDBMS. In this case, the <span class="FontName">update</span> value is the most conservative of all three available values, as explained in <a href="part0028.html#Tab1" class="calibre5">Table 18-1</a>.</p>
<p class="indent">If you’re using a production RDBMS, then <span class="FontName">dbCreate="update"</span> is surely to be your preferred strategy, since it doesn’t destroy any data in the RDBMS. If, on the other hand, a Grails application is undergoing testing, you are likely <i class="calibre8">to want</i> data in a RDBMS being cleaned out on every test run, thus a value like <span class="FontName">dbCreate="create"</span> or <span class="FontName">dbCreate="create-drop"</span> would be more common. For a development RDBMS, which of these options you select as the better strategy depends on how advanced a Grails application is in terms of development.</p>
<p class="indent">Grails also allows you to use a RDBMS configured on a web container. In such cases, a web container, such as Apache Tomcat, is set up with the corresponding RDBMS connection parameters and access to the RDBMS is made available through JNDI. The following listing illustrates the <span class="FontName">dataSource</span> definition to access RDBMS via JNDI:</p>
<pre class="calibre11"><span class="FontName">dataSource {</span><br class="calibre10"/>    <span class="FontName">jndiName = "java:comp/env/grailsDataSource"</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Finally, it’s worth mentioning that you can configure a <span class="FontName">dataSource</span> definition<a id="cXXX.1306" class="calibre5"></a> to take effect on an application’s various environments, while further specifying properties for each specific environment. This configuration is illustrated in the following listing:</p>
<pre class="calibre11"><span class="FontName">dataSource {</span><br class="calibre10"/>  <span class="FontName">driverClassName = "com.mysql.jdbc.Driver"</span><br class="calibre10"/>  <span class="FontName">username = "grails"</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><span class="FontName">environments {</span><br class="calibre10"/>  <span class="FontName">production {</span><br class="calibre10"/>     <span class="FontName">dataSource {</span><br class="calibre10"/>        <span class="FontName">url = "jdbc:mysql://localhost/grailsDBPro"</span><br class="calibre10"/>        <span class="FontName">password = "production"</span><br class="calibre10"/>     <span class="FontName">}</span><br class="calibre10"/>  <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">development {</span><br class="calibre10"/>     <span class="FontName">dataSource {</span><br class="calibre10"/>        <span class="FontName">url = "jdbc:mysql://localhost/grailsDBDev"</span><br class="calibre10"/>        <span class="FontName">password = "development"</span><br class="calibre10"/>     <span class="FontName">}</span><br class="calibre10"/>  <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">As this last listing illustrates, a <span class="FontName">dataSource</span>’s <span class="FontName">driverClassName</span> and <span class="FontName">username</span> properties are defined globally, taking effect on all environments, while other <span class="FontName">dataSource</span> properties are declared specifically for each individual environment.</p>
<p id="Sec39" class="Heading">18-9. Logging<a id="cXXX.2101" class="calibre6"></a><a id="cXXX.1307" class="calibre6"></a></p>
<p id="Sec40" class="Heading1">Problem</p>
<p class="noindent">You want to customize the logging output<a id="cXXX.1308" class="calibre5"></a> generated by a Grails application.</p>
<p id="Sec41" class="Heading1">Solution</p>
<p class="noindent">Grails relies on Java Log4J to perform <a id="cXXX.1309" class="calibre5"></a>its logging operations. In doing so, all Log4J configuration parameters are specified inside the <span class="FontName">Config.groovy</span> file located under an application’s <span class="FontName">/grails-app/conf</span> directory.</p>
<p class="indent">Given Log4J’s logging versatility, a Grails application logging can be configured in various ways. This includes creating custom appenders, logging levels, console output, logging by artifacts, and custom logging layouts.</p>
<p id="Sec42" class="Heading1">How It Works</p>
<p class="noindent">Grails comes preconfigured with a basic set of Log4J parameters. Defined inside the <span class="FontName">Config.groovy</span> file <a id="cXXX.1310" class="calibre5"></a>located under an application’s <span class="FontName">/grails-app/conf</span> directory, these Log4J parameters are the following:</p>
<pre class="calibre11"><span class="FontName">log4j = {</span><br class="calibre10"/>    <span class="FontName">error      'org.codehaus.groovy.grails.web.servlet',        // controllers</span><br class="calibre10"/>               <span class="FontName">'org.codehaus.groovy.grails.web.pages',          // GSP</span><br class="calibre10"/>               <span class="FontName">'org.codehaus.groovy.grails.web.sitemesh',       // layouts</span><br class="calibre10"/>               <span class="FontName">'org.codehaus.groovy.grails.web.mapping.filter', // URL mapping</span><br class="calibre10"/>               <span class="FontName">'org.codehaus.groovy.grails.web.mapping',        // URL mapping</span><br class="calibre10"/>               <span class="FontName">'org.codehaus.groovy.grails.commons',            // core / classloading</span><br class="calibre10"/>               <span class="FontName">'org.codehaus.groovy.grails.plugins',            // plugins</span><br class="calibre10"/>               <span class="FontName">'org.codehaus.groovy.grails.orm.hibernate',      // hibernate integration</span><br class="calibre10"/>               <span class="FontName">'org.springframework',</span><br class="calibre10"/>               <span class="FontName">'org.hibernate'</span><br class="calibre10"/>    <span class="FontName">warn       'org.mortbay.log'</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The notation for this last listing follows the convention <span class="FontName">&lt;logging_level&gt; '&lt;package_name&gt;'</span>. This implies that any logging operation occurring at any of the cited packages will be logged so long as it occurs within the specified logging level or a more severe level.</p>
<p class="indent">In Log4J parlance, each package is known as a <i class="calibre8">logger</i><a id="cXXX.1311" class="calibre5"></a>. Log4J also has the following logging levels: <span class="FontName">fatal</span>, <span class="FontName">error</span>, <span class="FontName">warn</span>, <span class="FontName">info</span>, <span class="FontName">debug</span>, and <span class="FontName">trace</span>. <span class="FontName">fatal</span> is the most severe. Grails thus follows a conservative default logging policy by using the <span class="FontName">error</span> level on most of its packages. Specifying a less severe level (e.g., <span class="FontName">debug</span>) would result in greater volumes of logging information, which may not be practical for most cases.</p>
<p class="indent">By default, all logging message are sent to the <span class="FontName">stacktrace.log</span> file located under an application’s root directory. And if applicable, to the standard output (i.e., console) of a running application. When you execute a <span class="FontName">grails</span> command, you will observe logging messages sent to standard output.</p>
<p id="Sec43" class="Heading2">Configuring Custom Appenders and Loggers<a id="cXXX.1312" class="calibre6"></a></p>
<p class="noindent">Log4J relies on appenders and loggers to offer versatile logging functionality. An appender is a location where logging information is sent (e.g., a file or standard output), whereas a logger is a location where logging information is generated (e.g., a class or package).</p>
<p class="indent">Grails is configured with a root Log4J logger, from which all other loggers inherit their behavior. The default Log4J logger can be customized in a Grails application using the following statement within the <span class="FontName">log4j { }</span> section of an application’s <span class="FontName">Config.groovy</span> file:</p>
<pre class="calibre11"><span class="FontName">root {</span><br class="calibre10"/>    <span class="FontName">error()</span><br class="calibre10"/>    <span class="FontName">additivity = true</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This last statement defines a logger so that messages of an <span class="FontName">error</span> level, or a more severe one, are logged to standard output. This is the reason you can see logging message from other loggers (e.g., a class or package) being sent to standard output, they all inherit the root logger’s behavior, in addition to specifying their own log level.</p>
<p class="indent">On the other hand, Log4J appenders provide a means to send logging messages to various locations. There are four types of appenders available by default:</p>
<ul class="bulleted"><li class="calibre17"><span class="FontName">jdbc</span>: An appender that logs to a JDBC connection.</li>
<li class="calibre17"><span class="FontName">console</span>: An appender that logs to standard output.</li>
<li class="calibre17"><span class="FontName">file</span>: An appender that logs to a file.</li>
<li class="calibre17"><span class="FontName">rollingFile</span>: An appender that logs to a rolling set of files.</li></ul>
<p class="indent">In order to define Log4J appenders in a Grails application, you need to declare them within the <span class="FontName">log4j { }</span> section of an application’s <span class="FontName">Config.groovy</span> file, as follows:</p>
<pre class="calibre11"><span class="FontName">appenders {</span><br class="calibre10"/>    <span class="FontName">file name:'customlogfile', file:'/logs/grails.log'</span><br class="calibre10"/>    <span class="FontName">rollingFile name:'rollinglogfile', maxFileSize:1024,file:'/logs/rollinggrails.log'</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">As you can see, Log4J appenders are defined in the form <span class="FontName">&lt;appender_type&gt; name:&lt;appender_name&gt; &lt;additional_appender_options&gt;</span>. In order to use appenders, you simply need to add them to a corresponding logger where they can receive input.</p>
<p class="indent">The following declaration illustrates how to put together the use of appenders, loggers and logging levels:</p>
<pre class="calibre11"><span class="FontName">root {</span><br class="calibre10"/>    <span class="FontName">debug 'stdout', 'customlogfile'</span><br class="calibre10"/>    <span class="FontName">additivity = true</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This last listing overrides the default root Log4J logger. It indicates to use a <span class="FontName">debug</span> level for outputting logging messages to both to the <span class="FontName">stdout</span> appender (i.e., standard output or console) as well as the <span class="FontName">customlogfile</span> appender, the last of which represent a file defined in the <span class="FontName">appender</span> section. Be aware that a <span class="FontName">debug</span> level generates a lot of logging information.</p>
<p class="indent">If you simply want to use an appender for a particular package (i.e., logger), you can do so using the following syntax:</p>
<pre class="calibre11"><span class="FontName">error customlogfile:'com.apress.springwebrecipes.grails'</span></pre>
<p class="indent">This last syntax is similar to the default notation included in Grails <span class="FontName">&lt;logging_level&gt; '&lt;package_name&gt;'</span>, except it prefixes the name of an appender to the package.</p>
<p id="Sec44" class="Heading2">Configuring Layouts<a id="cXXX.1313" class="calibre6"></a></p>
<p class="noindent">In addition to custom loggers and appenders, Log4J can also be customized to use a particular logging layout. There are four types of layouts available by default:</p>
<ul class="bulleted"><li class="calibre17"><span class="FontName">xml</span>: An XML log file</li>
<li class="calibre17"><span class="FontName">html</span>: An HTML log file</li>
<li class="calibre17"><span class="FontName">simple</span>: A simple textual log</li>
<li class="calibre17"><span class="FontName">pattern</span>: A pattern layout</li></ul>
<p class="indent">By default, Log4J uses a <span class="FontName">pattern</span> layout. However, you can configure a different logging layout on a per-appender basis. The following listing illustrates how to assign layouts to appenders:</p>
<pre class="calibre11"><span class="FontName">appenders {</span><br class="calibre10"/>    <span class="FontName">file name:'customlogfile', file:'/logs/grails.log' layout:pattern(conversionPattern: '%c{2} %m%n')</span><br class="calibre10"/>    <span class="FontName">console name:'stdout', layout:simple</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The first appender, <span class="FontName">customlogfile</span>, is assigned a <span class="FontName">pattern</span> layout. Whereas the second appender, <span class="FontName">stdout</span>, is assigned a <span class="FontName">simple</span> layout. Note that <span class="FontName">stdout</span> is the built-in appender for standard output (i.e., console).</p>
<p id="Sec45" class="Heading">18-10. Running Unit and Integration Tests<a id="cXXX.2252" class="calibre6"></a><a id="cXXX.1314" class="calibre6"></a></p>
<p id="Sec46" class="Heading1">Problem</p>
<p class="noindent">To make sure that your application’s classes are working as specified, you need to perform unit and integration tests on them.</p>
<p id="Sec47" class="Heading1">Solution</p>
<p class="noindent">Grails has built-in support for running both unit and integration tests on an application. Earlier when you generated Grails artifacts, such as an application’s domain classes, you might recall a series of test classes were automatically generated.</p>
<p class="indent">In a Grails application, tests are placed under an application’s <span class="FontName">test</span> directory. Inside this directory, you will find three more folders: <span class="FontName">unit</span> used to place an application’s unit test classes, <span class="FontName">integration</span> used to place an application’s integration test classes, and <span class="FontName">reports</span> used to place the results of performing an application’s tests<a id="cXXX.1315" class="calibre5"></a>.</p>
<p class="indent">Similar to other functionality offered by Grails, much of the drudgery involved in setting up and configuring application tests is handled by Grails. You simply need to concentrate on designing tests.</p>
<p class="indent">Once you’ve designed an application’s tests, running tests in Grails is as simple as executing the <span class="FontName">grails test-app</span> command from an application’s root directory.</p>
<p id="Sec48" class="Heading1">How It Works</p>
<p class="noindent">Grails bootstraps an environment necessary to perform application tests. This environment includes the libraries (i.e., JARs), permanent storage system (i.e., RDBMS), as well as any other artifact necessary to carry out unit and integration tests. <a id="cXXX.1316" class="calibre5"></a></p>
<p class="indent">Let’s start by analyzing the output of executing the <span class="FontName">grails test-app</span> command, illustrated next:</p>
<pre class="calibre11"><span class="FontName">Running script /springrecipes/grails-1.2/scripts/TestApp.groovy</span><br class="calibre10"/><span class="FontName">Environment set to test</span><br class="calibre10"/>    <span class="FontName">[mkdir] Created dir: /springrecipes/Ch11/court/test/reports/html</span><br class="calibre10"/>    <span class="FontName">[mkdir] Created dir: /springrecipes/Ch11/court/test/reports/plain</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">Starting unit tests ...</span><br class="calibre10"/><span class="FontName">Running tests of type 'unit'</span><br class="calibre10"/>  <span class="FontName">[groovyc] Compiling 3 source files to /home/web/.grails/1.2/</span><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>                <span class="FontName">projects/court/test-classes/unit</span><br class="calibre10"/><span class="FontName">-------------------------------------------------------</span><br class="calibre10"/><span class="FontName">Running 3 unit tests...</span><br class="calibre10"/><span class="FontName">Running test WelcomeControllerTests...PASSED</span><br class="calibre10"/><span class="FontName">Running test ReservationTests...PASSED</span><br class="calibre10"/><span class="FontName">Running test PlayerTests...PASSED</span><br class="calibre10"/><span class="FontName">Tests Completed in 2302ms ...</span><br class="calibre10"/><span class="FontName">-------------------------------------------------------</span><br class="calibre10"/><span class="FontName">Tests passed: 3</span><br class="calibre10"/><span class="FontName">Tests failed: 0</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">-------------------------------------------------------</span><br class="calibre10"/><span class="FontName">Starting integration tests ...</span><br class="calibre10"/>     <span class="FontName">[copy] Copying 1 file to /home/web/.grails/1.2/</span><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>               <span class="FontName">projects/court/test-classes/integration</span><br class="calibre10"/>     <span class="FontName">[copy] Copying 1 file to /home/web/.grails/1.2/</span><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>               <span class="FontName">projects/court/test-classes</span><br class="calibre10"/><span class="FontName">Running tests of type 'integration'</span><br class="calibre10"/><span class="FontName">No tests found in test/integration to execute ...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">[junitreport] Processing /springrecipes/sourcecode/Ch11/</span><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>              <span class="FontName">court/test/reports/TESTS-TestSuites.xml to /tmp/null993113113</span><br class="calibre10"/><span class="FontName">[junitreport] Loading stylesheet jar:file:/springrecipes/grails-1.2/</span><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>          <span class="FontName">lib/ant-junit-1.7.1.jar!/org/apache/tools/ant/taskdefs/optional/</span><img src="../images/00053.jpeg" alt="image" class="calibre3"/><br class="calibre10"/>          <span class="FontName">junit/xsl/junit-frames.xsl</span><br class="calibre10"/><span class="FontName">[junitreport] Transform time: 2154ms</span><br class="calibre10"/><span class="FontName">[junitreport] Deleting: /tmp/</span><span class="FontName">null993113113</span></pre>
<p class="indent">The script <span class="FontName">TestApp.groovy</span>, included in the Grails distribution, starts the testing process. Immediately after, you can see the Grails environment is set to set <span class="FontName">test</span>, meaning configuration parameters are taken from this type of environment (e.g., <span class="FontName">test</span> RDBMS parameters). Next, there are three sections. <a id="cXXX.1317" class="calibre5"></a></p>
<p class="indent">The first section indicates the execution of unit tests, which are taken from the <span class="FontName">test/unit</span> directory under an application’s root directory. In this case, three successful unit tests are performed, which correspond to the three skeleton test classes generated upon the creation of an application’s domain classes. Since these test classes contain an empty test, they automatically validate one unit test.</p>
<p class="indent">The second section indicates the execution of integration tests, which are taken from the <span class="FontName">test/integration</span> directory under an application’s root directory. In this case, there are no classes found in this last directory, so no integration tests are performed.</p>
<p class="indent">The third and last section indicates the creation of reports <a id="cXXX.1318" class="calibre5"></a>for both unit and integration tests. In this case, reports are placed in an XML format under the <span class="FontName">test/reports</span> directory of an application’s root directory, as well as reports in the more user-friendly HTML and plain text formats under the corresponding <span class="FontName">test/reports/html</span> and <span class="FontName">test/reports/plain</span> subdirectories of an application’s root directory.</p>
<p class="indent">Now that you know how Grails executes tests<a id="cXXX.1319" class="calibre5"></a>, let’s modify the preexisting unit test classes to incorporate unit tests based on a domain class’s logic. Given that Grails testing is based on the foundations of the JUnit testing framework (<span class="FontName"><a href="http://www.junit.org/" class="calibre5">http://www.junit.org/</a></span>) , if you’re unfamiliar with this framework, we advise you to look over its documentation to grasp its syntax and approach. The following sections assume a basic understanding of JUnit.</p>
<p class="indent">Add the following methods (i.e., unit tests) to the <span class="FontName">PlayerSpec.groovy</span> class located under an application’s <span class="FontName">/test/unit/</span> directory: <a id="cXXX.1320" class="calibre5"></a></p>
<pre class="calibre11"><span class="FontName">void "Test Non Empty Player"() {</span><br class="calibre10"/>    <span class="FontName">given: "A valid player is constructed"</span><br class="calibre10"/>        <span class="FontName">def player = new Player(name:'James',phone:'118-1111')</span><br class="calibre10"/>        <span class="FontName">mockForConstraintsTests(Player, [player])</span><br class="calibre10"/>    <span class="FontName">when: "validate is called"</span><br class="calibre10"/>        <span class="FontName">def result = player.validate();</span><br class="calibre10"/>    <span class="FontName">then: "it should be valid"</span><br class="calibre10"/>        <span class="FontName">assertTrue player.validate()</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">void testEmptyName() {</span><br class="calibre10"/>    <span class="FontName">given: "A player without a name is constructed"</span><br class="calibre10"/>        <span class="FontName">def player = new Player(name:'',phone:'118-1111')</span><br class="calibre10"/>        <span class="FontName">mockForConstraintsTests(Player, [player])</span><br class="calibre10"/>    <span class="FontName">when: "validate is called"</span><br class="calibre10"/>        <span class="FontName">def result = player.validate();</span><br class="calibre10"/>    <span class="FontName">then: "The name should be rejected"</span><br class="calibre10"/>        <span class="FontName">assertFalse result</span><br class="calibre10"/>        <span class="FontName">assertEquals 'Name cannot be null', 'nullable',player.errors['name']</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">void testEmptyPhone() {</span><br class="calibre10"/>    <span class="FontName">given: "A player without a phone is constructed"</span><br class="calibre10"/>        <span class="FontName">def player = new Player(name:'James',phone:'')</span><br class="calibre10"/>        <span class="FontName">mockForConstraintsTests(Player, [player])</span><br class="calibre10"/>    <span class="FontName">when: "validate is called"</span><br class="calibre10"/>        <span class="FontName">def result = player.validate()</span><br class="calibre10"/>    <span class="FontName">then: "The phone number should be rejected."</span><br class="calibre10"/>        <span class="FontName">assertFalse result</span><br class="calibre10"/>        <span class="FontName">assertEquals 'Phone cannot be null', 'nullable', player.errors['phone']</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The first unit test creates a <span class="FontName">Player</span> object and instantiates it with both a <span class="FontName">name</span> and <span class="FontName">phone</span> fields. In accordance with the constraints declared in the <span class="FontName">Player</span> domain class, this type of an instance should always be valid. Therefore, the statement <span class="FontName">assertTrue player.validate()</span> confirms the validation of this object is always <span class="FontName">true</span>.</p>
<p class="indent">The second and third unit tests also create a <span class="FontName">Player</span> object. However, notice in one test the <span class="FontName">Player</span> object is instantiated with a blank <span class="FontName">name</span> field, and in another, the <span class="FontName">Player</span> object is instantiated with a blank <span class="FontName">phone</span> field. In accordance with the constraints declared in the <span class="FontName">Player</span> domain class, both instances should always be invalid. Therefore, the statements <span class="FontName">assertFalse player.validate()</span> confirm the validation of such objects are always <span class="FontName">false</span>. The <span class="FontName">assertEquals</span> statements provide detailed results as to why the <span class="FontName">assertFalse</span> declarations are false.</p>
<p class="indent">Next, add the following methods (i.e., unit tests) to the <span class="FontName">ReservationSpec.groovy</span> class <a id="cXXX.1321" class="calibre5"></a>located under an application’s <span class="FontName">/test/unit/</span> directory:</p>
<pre class="calibre11"><span class="FontName">void testReservation() {</span><br class="calibre10"/>    <span class="FontName">given:</span><br class="calibre10"/>        <span class="FontName">def calendar = Calendar.instance</span><br class="calibre10"/>        <span class="FontName">calendar.with {</span><br class="calibre10"/>            <span class="FontName">clear()</span><br class="calibre10"/>            <span class="FontName">set MONTH, OCTOBER</span><br class="calibre10"/>            <span class="FontName">set DATE, 15</span><br class="calibre10"/>            <span class="FontName">set YEAR, 2009</span><br class="calibre10"/>            <span class="FontName">set HOUR, 15</span><br class="calibre10"/>            <span class="FontName">set MINUTE, 00</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">def validDateReservation = calendar.getTime()</span><br class="calibre10"/>        <span class="FontName">def reservation = new Reservation(</span><br class="calibre10"/>                <span class="FontName">sportType:'Tennis', courtName:'Main',</span><br class="calibre10"/>                <span class="FontName">date:validDateReservation,player:new Player(name:'James',phone:'118-1111'))</span><br class="calibre10"/>        <span class="FontName">mockForConstraintsTests(Reservation, [reservation])</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">expect:</span><br class="calibre10"/>        <span class="FontName">assertTrue reservation.validate()</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">void testOutOfRangeDateReservation() {</span><br class="calibre10"/>    <span class="FontName">given:</span><br class="calibre10"/>        <span class="FontName">def calendar = Calendar.instance</span><br class="calibre10"/>        <span class="FontName">calendar.with {</span><br class="calibre10"/>            <span class="FontName">clear()</span><br class="calibre10"/>            <span class="FontName">set MONTH, OCTOBER</span><br class="calibre10"/>            <span class="FontName">set DATE, 15</span><br class="calibre10"/>            <span class="FontName">set YEAR, 2009</span><br class="calibre10"/>            <span class="FontName">set HOUR, 23</span><br class="calibre10"/>            <span class="FontName">set MINUTE, 00</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">def invalidDateReservation = calendar.getTime()</span><br class="calibre10"/>        <span class="FontName">def reservation = new Reservation(</span><br class="calibre10"/>                <span class="FontName">sportType:'Tennis',courtName:'Main',</span><br class="calibre10"/>                <span class="FontName">date:invalidDateReservation,player:new Player(name:'James',phone:'118-1111'))</span><br class="calibre10"/>        <span class="FontName">mockForConstraintsTests(Reservation, [reservation])</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">expect:</span><br class="calibre10"/>        <span class="FontName">assertFalse reservation.validate()</span><br class="calibre10"/>        <span class="FontName">assertEquals 'Reservation date is out of range', 'invalid.weekdayHour',</span><br class="calibre10"/>        <span class="FontName">reservation.errors['date']</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">void testOutOfRangeSportTypeReservation() {</span><br class="calibre10"/>    <span class="FontName">given:</span><br class="calibre10"/>        <span class="FontName">def calendar = Calendar.instance</span><br class="calibre10"/>        <span class="FontName">calendar.with {</span><br class="calibre10"/>            <span class="FontName">clear()</span><br class="calibre10"/>            <span class="FontName">set MONTH, OCTOBER</span><br class="calibre10"/>            <span class="FontName">set DATE, 15</span><br class="calibre10"/>            <span class="FontName">set YEAR, 2009</span><br class="calibre10"/>            <span class="FontName">set HOUR, 15</span><br class="calibre10"/>            <span class="FontName">set MINUTE, 00</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">def validDateReservation = calendar.getTime()</span><br class="calibre10"/>        <span class="FontName">def reservation = new Reservation(</span><br class="calibre10"/>                <span class="FontName">sportType:'Baseball',courtName:'Main',</span><br class="calibre10"/>                <span class="FontName">date:validDateReservation,player:new Player(name:'James',phone:'118-1111'))</span><br class="calibre10"/>        <span class="FontName">mockForConstraintsTests(Reservation, [reservation])</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">expect:</span><br class="calibre10"/>        <span class="FontName">assertFalse reservation.validate()</span><br class="calibre10"/>        <span class="FontName">assertEquals 'SportType is not valid', 'inList',reservation.errors['sportType']</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This last listing contains three unit tests designed to validate the integrity of <span class="FontName">Reservation</span> objects. The first test creates a <span class="FontName">Reservation</span> object instance and confirms that its corresponding values pass through the <span class="FontName">Reservation</span> domain class’s constraints. The second test creates a <span class="FontName">Reservation</span> object that violates the domain class’s date constraint and confirms such an instance is invalid. The third test creates a <span class="FontName">Reservation</span> object that violates the domain class’s <span class="FontName">sportType</span> constraint and confirms such an instance is invalid.</p>
<p class="indent">If you execute the <span class="FontName">grails test-app</span> command, Grails automatically executes all the previous tests and outputs the test results to the application’s <span class="FontName">/test/reports/</span> directory.</p>
<p class="indent">Now that you’ve created unit tests for a Grails application, let’s explore the creation of integration tests.</p>
<p class="indent">Unlike unit tests, integration tests validate more elaborate logic undertaken by an application. Interactions between various domain classes or operations performed against a RDBMS are the realm of integration testing. In this sense, Grails aids the integration testing process by automatically bootstrapping a RDBMS and other application properties to perform integration tests. The “Grails Differences for Running Unit and Integration Tests” sidebar contains more details on the different aspects provided by Grails for running both unit and integration tests.</p>
<div class="Singlethin">
<p class="Heading4a"><b class="calibre1">GRAILS DIFFERENCES FOR RUNNING UNIT AND INTEGRATION TESTS</b></p>
<p class="box-left">Unit tests are designed to validate the logic contained in a single domain class. Because of this fact, besides automating the execution of such tests, Grails provides no type of bootstrapping properties for performing these type of tests. <a id="cXXX.1322" class="calibre5"></a></p>
<p class="box-left">This is the reason the previous unit tests relied on the special method <span class="FontName">mockForConstraintsTests</span>. This method creates a mock object from a domain class that is used to access a class's dynamic methods (e.g., <span class="FontName">validate</span>) needed to perform unit tests. In this manner, Grails maintains a low overhead for performing unit tests by not bootstrapping anything, leaving even the creation of mock objects to the creator of a test.</p>
<p class="box-left">Integration tests are designed to validate more elaborate logic that can span a series of application classes. Therefore, Grails bootstraps not only a RDBMS for the purpose of running tests against this type of permanent storage system but also bootstraps a domain class’s dynamic methods to simplify the creation of such tests. This of course entails additional overhead for performing such tests, compared to unit tests.</p>
<p class="box-left">It’s also worth mentioning that if you look closely at the skeleton test classes generated by Grails for both unit and integration tests, there aren’t any difference among them. The only difference is that tests placed inside the <span class="FontName">integration</span> directory have access to the series of provisions mentioned earlier, whereas those inside the <span class="FontName">unit</span> directory do not. You could go down the route of placing unit tests inside the <span class="FontName">integration</span> directory, but this is a matter for you to decide by considering convenience versus overhead.</p></div>
<p class="indent">Next, create an integration class for the application by executing the following command: <span class="FontName">grails create-integration-test CourtIntegrationTest</span>. This generates an integration test class inside the application’s <span class="FontName">/test/integration/</span> directory.</p>
<p class="indent">Incorporate the following method (i.e., the integration test) into this last class to validate the RDBMS operations performed by the application: <a id="cXXX.1323" class="calibre5"></a></p>
<pre class="calibre11"><span class="FontName">void testQueries() {</span><br class="calibre10"/>    <span class="FontName">given: "2 Existing Players"</span><br class="calibre10"/>        <span class="FontName">// Define and save players</span><br class="calibre10"/>        <span class="FontName">def players = [ new Player(name:'James',phone:'118-1111'),</span><br class="calibre10"/>                        <span class="FontName">new Player(name:'Martha',phone:'999-9999')]</span><br class="calibre10"/>        <span class="FontName">players*.save()</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Confirm two players are saved in the database</span><br class="calibre10"/>        <span class="FontName">Player.list().size() == 2</span><br class="calibre10"/>    <span class="FontName">when: "Player James is retrieved"</span><br class="calibre10"/>        <span class="FontName">// Get player from the database by name</span><br class="calibre10"/>        <span class="FontName">def testPlayer = Player.findByName('James')</span><br class="calibre10"/>    <span class="FontName">then:  "The phone number should match"</span><br class="calibre10"/>        <span class="FontName">// Confirm phone</span><br class="calibre10"/>        <span class="FontName">testPlayer.phone == '118-1111'</span><br class="calibre10"/>    <span class="FontName">when: "Player James is Updated"</span><br class="calibre10"/>        <span class="FontName">// Update player name</span><br class="calibre10"/>        <span class="FontName">testPlayer.name = 'Marcus'</span><br class="calibre10"/>        <span class="FontName">testPlayer.save()</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">then: "The name should be updated in the DB"</span><br class="calibre10"/>        <span class="FontName">// Get updated player from the database, but now by phone</span><br class="calibre10"/>        <span class="FontName">def updatedPlayer = Player.findByPhone('118-1111')</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Confirm name</span><br class="calibre10"/>        <span class="FontName">updatedPlayer.name == 'Marcus'</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">when: "The updated player is deleted"</span><br class="calibre10"/>        <span class="FontName">// Delete player</span><br class="calibre10"/>        <span class="FontName">updatedPlayer.delete()</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">then: "The player should be removed from the DB."</span><br class="calibre10"/>        <span class="FontName">// Confirm one player is left in the database</span><br class="calibre10"/>        <span class="FontName">Player.list().size() == 1</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Confirm updatedPlayer is deleted</span><br class="calibre10"/>        <span class="FontName">def nonexistantPlayer = Player.findByPhone('118-1111')</span><br class="calibre10"/>        <span class="FontName">nonexistantPlayer == null</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This last listing performs a series of operations against an application’s RDBMS, starting from saving two <span class="FontName">Player</span> objects and then querying, updating, and deleting those objects from the RDBMS. After each operation, a validation step (e.g., <span class="FontName">assertEquals</span>, <span class="FontName">assertNull</span>) is performed to ensure the logic—in this case contained in the <span class="FontName">PlayerController</span> controller class—operates as expected (i.e., the controller <span class="FontName">list()</span> method returns the correct number of objects in the RDBMS).</p>
<p class="indent">By default, Grails performs RDBMS test operations against HSQLDB. However, you can use any RDBMS you like. See Recipe 18-8, “Changing Permanent Storage Systems,”<a id="cXXX.2129" class="calibre5"></a> for details on changing Grails RDBMS.</p>
<p class="indent">Finally, it’s worth mentioning that if you wish to execute a single type of test (i.e., unit or integration), you can rely on the command flags <span class="FontName">-unit</span> or <span class="FontName">-integration</span>. Executing the <span class="FontName">grails test-app -unit</span> command performs only an application’s unit tests, whereas executing the <span class="FontName">grails test-app -integration</span> command performs only an application’s integration tests. This can be helpful if you have a large amount of both tests, since it can cut down on the overall time needed to perform tests.</p>
<p id="Sec49" class="Heading">18-11. Using Custom Layouts and Templates<a id="cXXX.2021" class="calibre6"></a></p>
<p id="Sec50" class="Heading1">Problem<a id="cXXX.1324" class="calibre6"></a></p>
<p class="noindent">You need to customize layouts and templates to display an application’s content.</p>
<p id="Sec51" class="Heading1">Solution</p>
<p class="noindent">By default, Grails applies a global layout to display an application’s content. This allows views to have a minimal set of display elements (e.g., HTML, CSS, and JavaScript) <a id="cXXX.1325" class="calibre5"></a>and inherit their layout behavior from a separate location.</p>
<p class="indent">This inheritance process allows application designers and graphic designers to perform their work separately, with application designers concentrating on creating views with the necessary data and graphic designers concentrating on the layout (i.e., aesthetics) of such data.</p>
<p class="indent">You can create custom layouts to include elaborate HTML displays, as well as custom CSS or JavaScript libraries.</p>
<p class="indent">Grails also supports the concept of templates, which serve the same purpose as layouts, except applied at a more granular level. In addition, it’s also possible to use templates for rendering a controller’s output, instead of a view as in most controllers.</p>
<p id="Sec52" class="Heading1">How It Works<a id="cXXX.1326" class="calibre6"></a></p>
<p class="noindent">Inside the <span class="FontName">/grails-app/view/</span> directory of an application, you can find a subdirectory called <span class="FontName">layouts</span>, containing the layouts available to an application. By default, there is a file named <span class="FontName">main.gsp</span> whose contents are the following:</p>
<pre class="calibre11"><span class="FontName">&lt;!DOCTYPE html&gt;</span><br class="calibre10"/><span class="FontName">&lt;!--[if lt IE 7 ]&gt; &lt;html lang="en" class="no-js ie6"&gt; &lt;![endif]--&gt;</span><br class="calibre10"/><span class="FontName">&lt;!--[if IE 7 ]&gt; &lt;html lang="en" class="no-js ie7"&gt; &lt;![endif]--&gt;</span><br class="calibre10"/><span class="FontName">&lt;!--[if IE 8 ]&gt; &lt;html lang="en" class="no-js ie8"&gt; &lt;![endif]--&gt;</span><br class="calibre10"/><span class="FontName">&lt;!--[if IE 9 ]&gt; &lt;html lang="en" class="no-js ie9"&gt; &lt;![endif]--&gt;</span><br class="calibre10"/><span class="FontName">&lt;!--[if (gt IE 9)|!(IE)]&gt;&lt;!--&gt; &lt;html lang="en" class="no-js"&gt;&lt;!--&lt;![endif]--&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;title&gt;&lt;g:layoutTitle default="Grails"/&gt;&lt;/title&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;link rel="shortcut icon" href="${assetPath(src: 'favicon.ico')}" type="image/x-icon"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;link rel="apple-touch-icon" href="${assetPath(src: 'apple-touch-icon.png')}"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;link rel="apple-touch-icon" sizes="114x114" href="${assetPath(src: 'apple-touch-icon-retina.png')}"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;asset:stylesheet src="application.css"/&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;asset:javascript src="application.js"/&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;g:layoutHead/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;div id="grailsLogo" role="banner"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;a href="</span><span class="FontName"><a href="http://grails.org" class="calibre5">http://grails.org</a></span><span class="FontName">"&gt;&lt;asset:image src="grails_logo.png" alt="Grails"/&gt;&lt;/a&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/div&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;g:layoutBody/&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;div class="footer" role="contentinfo"&gt;&lt;/div&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;div id="spinner" class="spinner" style="display:none;"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;g:message code="spinner.alt" default="Loading&amp;hellip;"/&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/div&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span><br class="calibre10"/></pre>
<p class="indent">Though apparently a simple HTML file, this last listing contains several elements that are used as placeholders in order for application views (i.e., JSP and GSP pages) to inherit the same layout.</p>
<p class="indent">The first of such elements are Groovy tags appended to the <span class="FontName">&lt;g:*&gt;</span> namespace. The <span class="FontName">&lt;g:layoutTitle&gt;</span> tag is used to define the contents of a layout’s title section. If a view inherits the behavior from this layout and lacks such a value, Grails automatically assigns the <span class="FontName">Grails</span> value, as indicated by the <span class="FontName">default</span> attribute. On the other hand, if an inheriting view has such a value, it’s displayed in its place.</p>
<p class="indent">The <span class="FontName">&lt;g:layoutHead&gt;</span> tag is used to define the contents of a layout’s head section. Any values declared in the head of a view head inheriting this layout are placed in this location upon rendering.</p>
<p class="indent">The <span class="FontName">&lt;asset:javascript library="application"&gt;</span> tag allows any view inheriting this layout automatic access to JavaScript libraries. Upon rendering, this element is transformed into the following: <span class="FontName">&lt;script type="text/javascript" src="/court/assets/application.js"&gt;&lt;/script&gt;</span>. Bear in mind JavaScript libraries have to be placed inside the Grails <span class="FontName">/&lt;app-name&gt;/web-app/assets/javascripts</span> subdirectory; <span class="FontName">&lt;app-name&gt;</span> in this case corresponds to <span class="FontName">court</span>.</p>
<p class="indent">Moving along, you will also find several declarations in the form <span class="FontName">${assetPath*}</span> with a <span class="FontName">src</span> attribute. Such statements are translated by Grails to reflect a resource contained in an application. So for example, the statement <span class="FontName">${assetPath(src: 'favicon.ico')}</span> is transformed into <span class="FontName">/court/assets/images/favicon.ico</span>. Notice the addition of the application’s name (i.e., context path) to the transformed values. This allows the layout to be reused in several applications while referencing the same image, the last of which should be placed under the Grails <span class="FontName">/court/web-app/assets/images</span> subdirectory. <a id="cXXX.1327" class="calibre5"></a></p>
<p class="indent">Now that you know how a Grails layout is structured, let’s take a look at how a view inherits its behavior. If you open any of the views generated by the application controllers created earlier—<span class="FontName">player</span>, <span class="FontName">reservation</span> or <span class="FontName">welcome</span> (also located under the <span class="FontName">views</span> directory)— you will find the following statement used to inherit behavior from a Grails layout:</p>
<pre class="calibre11"><span class="FontName">&lt;meta name="layout" content="main"/&gt;</span></pre>
<p class="indent">The <span class="FontName">&lt;meta&gt;</span> tag is a standard HTML tag that has no effect on a page’s display but is used by Grails to detect the layout from which a view should inherit its behavior. By using this last statement, a view is automatically rendered with the layout named <span class="FontName">main</span>, which is precisely the template described earlier.</p>
<p class="indent">Looking further into a view’s structure, you will notice that all generated views are structured as standalone HTML pages; they contain <span class="FontName">&lt;html&gt;</span>, <span class="FontName">&lt;body&gt;</span> and other such HTML tags, similar to the layout template. This doesn’t mean, however, that a page will contain duplicate HTML tags upon rendering. Grails automatically sorts out the substitution process by placing a view’s <span class="FontName">&lt;title&gt;</span> content inside the <span class="FontName">&lt;g:layoutTitle&gt;</span> tag, a view’s <span class="FontName">&lt;body&gt;</span> content inside the <span class="FontName">&lt;g:layoutBody /&gt;</span>tag, and so on.</p>
<p class="indent">What happens if you remove <span class="FontName">&lt;meta&gt;</span> tag from a Grails view? On the face of it, the answer to this question is obvious: no layout is applied upon rendering a view, which also implies no visual elements are rendered (e.g., images, menus, and CSS borders). However, since Grails operates on the basis of conventions, Grails always attempts to apply a layout on the basis of a controller’s name.</p>
<p class="indent">For example, even if the views corresponding to the <span class="FontName">reservation</span> controller have no <span class="FontName">&lt;meta name="layout"&gt;</span> tag declaration’s associated with them, if a layout named <span class="FontName">reservation.gsp</span> is present inside an application’s <span class="FontName">layout</span> directory, it will be applied to all views corresponding to the controller.</p>
<p class="indent">Though layouts provide an excellent foundation on which to modularize an application’s views, they are only applicable to a view’s entire page. Providing a more granular approach, templates allow certain chunks of a view’s page be made reusable.</p>
<p class="indent">Take the case of an HTML section used to display a player’s reservations. You’d like to display this information on all views corresponding to this controller as a reminder. Placing this HTML section explicitly on all views not only results in more initial work but can also result in more ongoing work in case such an HTML section changes. To facilitate this inclusion process, a template can be used. The following listing illustrates the contents of a template named <span class="FontName">_reservationList.gsp</span>: <a id="cXXX.1328" class="calibre5"></a></p>
<pre class="calibre11"><span class="FontName">&lt;table&gt;</span><br class="calibre10"/> <span class="FontName">&lt;g:each in="${reservationInstanceList}" status="i" var="reservationInstance"&gt;</span><br class="calibre10"/>       <span class="FontName">&lt;tr class="${(i % 2) == 0 ? 'odd' : 'even'}"&gt;</span><br class="calibre10"/>          <span class="FontName">&lt;td&gt;&lt;g:link action="show" id="${reservationInstance.id}"&gt;</span><br class="calibre10"/>              <span class="FontName">${fieldValue(bean:reservationInstance, field:'id')}&lt;/g:link&gt;&lt;/td&gt;</span><br class="calibre10"/>          <span class="FontName">&lt;td&gt;${fieldValue(bean:reservationInstance, field:'sportType')}&lt;/td&gt;</span><br class="calibre10"/>          <span class="FontName">&lt;td&gt;${fieldValue(bean:reservationInstance, field:'date')}&lt;/td&gt;</span><br class="calibre10"/>          <span class="FontName">&lt;td&gt;${fieldValue(bean:reservationInstance, field:'courtName')}&lt;/td&gt;</span><br class="calibre10"/>          <span class="FontName">&lt;td&gt;${fieldValue(bean:reservationInstance, field:'player')}&lt;/td&gt;</span><br class="calibre10"/>       <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/g:each&gt;</span><br class="calibre10"/><span class="FontName">&lt;/table&gt;</span></pre>
<p class="indent">This last template generates an HTML table relying on the Groovy tag <span class="FontName">&lt;g:each&gt;</span> with a list of reservations. The underscore (<span class="FontName">_</span>) prefix used to name the file is a notation by Grails to different between templates and stand-alone views; templates are always prefixed with an underscore.</p>
<p class="indent">In order to use this template inside a view, you need to use the <span class="FontName">&lt;g:render&gt;</span> tag illustrated here:</p>
<pre class="calibre11"><span class="FontName">&lt;g:render template="reservationList" model="[reservationList:reservationInstanceList]" /&gt;</span></pre>
<p class="indent">In this case, the <span class="FontName">&lt;g:render&gt;</span> tag takes two attributes: the <span class="FontName">template</span> attribute to indicate the name of a template and the <span class="FontName">model</span> attribute to pass reference data needed by a template.</p>
<p class="indent">Another variation of the <span class="FontName">&lt;g:render&gt;</span> tag includes a template’s relative and absolute locations. By declaring <span class="FontName">template="reservationList"</span>, Grails attempts to locate a template in the same directory as the view in which it’s declared. To facilitate reuse, templates can be loaded from a common directory for which absolute directories are used. For example, a view with a statement in the form <span class="FontName">template="/common/reservationList"</span> would attempt to locate a template named <span class="FontName">_reservationList.gsp</span> under an application’s <span class="FontName">grails-app/views/common</span> directory.</p>
<p class="indent">Finally, it’s worth mentioning that a template can also be used by a controller to render its output. For example, most controllers return control to a view using the following syntax:</p>
<pre class="calibre11"><span class="FontName">render view:'reservations', model:[reservationList:reservationList]</span></pre>
<p class="indent">However, it’s also possible to return control to a template using the following syntax:</p>
<pre class="calibre11"><span class="FontName">render template:'reservationList', model:[reservationList:reservationList]</span></pre>
<p class="indent">By using this last render statement, Grails attempts to locate a template by the name <span class="FontName">_reservationList.gsp</span>.</p>
<p id="Sec53" class="Heading">18-12. Using GORM Queries<a id="cXXX.1329" class="calibre6"></a></p>
<p id="Sec54" class="Heading1">Problem</p>
<p class="noindent">You want to perform queries against an application’s RDBMS.</p>
<p id="Sec55" class="Heading1">Solution</p>
<p class="noindent">Grails performs RDBMS operations <a id="cXXX.1330" class="calibre5"></a>using GORM. GORM is based on the popular Java ORM Hibernate, allowing Grails applications to perform queries using Hibernate Query Language (HQL).</p>
<p class="indent">However, in addition to supporting the use of HQL, GORM also has a series of built-in functionalities that make querying a RDBMS very simple.</p>
<p id="Sec56" class="Heading1">How It Works</p>
<p class="noindent">In Grails, queries against a RDBMS are generally performed from within controllers. If you inspect any of the court application controllers, one of the simplest queries is the following:</p>
<pre class="calibre11"><span class="FontName">Player.get(id)</span> <a id="cXXX.1331" class="calibre5"></a></pre>
<p class="indent">This query is used to obtain a <span class="FontName">Player</span> object with a particular ID. Under certain circumstances though, an application can be required to perform queries on another set of criteria.</p>
<p class="indent">For example, <span class="FontName">Player</span> objects in the court application have the <span class="FontName">name</span> and <span class="FontName">phone</span> fields, as defined in the <span class="FontName">Player</span> domain class. GORM supports the querying of domain objects on the basis of its field names. It does so by offering methods in the form <span class="FontName">findBy&lt;field_name&gt;</span>, as illustrated here:</p>
<pre class="calibre11"><span class="FontName">Player.findByName('Henry')</span><br class="calibre10"/><span class="FontName">Player.findByPhone('118-1111')</span></pre>
<p class="indent">These two statements are used to query a RDBMS and obtain a <span class="FontName">Player</span> object on the basis of a name and phone. These methods are called<a id="cXXX.1332" class="calibre5"></a> dynamic finders<a id="cXXX.1333" class="calibre5"></a>, since they are made available by GORM on the basis of a domain class’s fields.</p>
<p class="indent">In a similar fashion, the <span class="FontName">Reservation</span> domain class having its own field names will have dynamic finders like <span class="FontName">findByPlayer()</span>, <span class="FontName">findByCourtName()</span>, and <span class="FontName">findByDate()</span>. As you can see, this process simplifies the creation of queries against an RDBMS in Java applications.</p>
<p class="indent">In addition, dynamic finder methods can also use comparators to further refine a query’s results. The following snippet illustrates how to use a comparator to extract <span class="FontName">Reservation</span> objects in a particular date range:</p>
<pre class="calibre11"><span class="FontName">def now = new Date()</span><br class="calibre10"/><span class="FontName">def tomorrow = now + 1</span><br class="calibre10"/><span class="FontName">def reservations = Reservation.findByDateBetween( now, tomorrow )</span></pre>
<p class="indent">Besides the <span class="FontName">Between</span> comparator, another comparator that can be of use in the court application is the <span class="FontName">Like</span> comparator. The following snippet illustrates the use of the <span class="FontName">Like</span> comparator to extract <span class="FontName">Player</span> objects with names starting with the letter A.</p>
<pre class="calibre11"><span class="FontName">def letterAPlayers = Player.findByNameLike('A%')</span></pre>
<p class="indent"><a id="_Tab2" href="part0028.html#Tab2" class="calibre5">Table 18-2</a> describes the various comparators available for dynamic finder methods.</p>
<div class="Table" id="Tab2">
<p class="TabCapt"><span class="calibre4"><a href="part0028.html#_Tab2" class="calibre5">Table 18-2</a>.</span> GORM dynamic finder comparators</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14">
<p class="tab-left">GORM comparator</p></th><th valign="top" class="calibre14">
<p class="tab-left">Query</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">InList</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">If value is present in a given list of values</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">LessThan</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">For lesser object(s) than the given value</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">LessThanEquals</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">For lesser or equal object(s) than the given value</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">GreaterThan</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">For greater object(s) than the given value</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">GreaterThanEquals</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">For greater or equal object(s) than the given value</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">Like</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">For object(s) like the given value</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">Ilike</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">For object(s) like the given value in a case insensitive manner</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">NotEqual</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">For object(s) not equal to the given value</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">Between</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">For object(s) between to the two given values</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">IsNotNull</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">For not null object(s); uses no arguments</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">IsNull</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">For null object(s); uses no arguments</p></td></tr></tbody></table>
</div>
<p class="indent">GORM also supports the use of Boolean logic<a id="cXXX.1334" class="calibre5"></a> (and/or) in the construction of dynamic finder methods. The following snippet demonstrates how to perform a query for <span class="FontName">Reservation</span> objects that satisfy both a certain court name and a date in the future.</p>
<pre class="calibre11"><span class="FontName">def reservations = Reservation.findAllByCourtNameLikeAndDateGreaterThan("%main%", new Date()+7)</span></pre>
<p class="indent">In a similar fashion, the <span class="FontName">Or</span> statement (instead of <span class="FontName">And</span>) could have been used in this last dynamic finder method to extract <span class="FontName">Reservation</span> objects that satisfy at least one of the criteria.</p>
<p class="indent">Finally, dynamic finder methods also support the use of pagination and sorting to further refine queries. This is achieved by appending a map to the dynamic finder method. The following snippet illustrates how to limit the number of results in a query, as well as define its sorting and order properties: <a id="cXXX.1335" class="calibre5"></a></p>
<pre class="calibre11"><span class="FontName">def reservations = Reservation.findAllByCourtName("%main%", [ max: 3, sort: "date", order: "desc"] )</span></pre>
<p class="indent">As outlined at the start of this recipe, GORM also supports the use HQL to execute queries against a RDBMS. Though more verbose and error prone than the preceding listing, the following one illustrates several equivalent queries using HQL:</p>
<pre class="calibre11"><span class="FontName">def letterAPlayers = Player.findAll("from Player as p where p.name like 'A%'")</span><br class="calibre10"/><span class="FontName">def reservations = Reservation.findAll("from Reservation as r</span><br class="calibre10"/>        <span class="FontName">where r.courtName like '%main%' order by r.date desc", [ max: 3] )</span></pre>
<p id="Sec57" class="Heading">18-13. Creating Custom Tags<a id="cXXX.1336" class="calibre6"></a></p>
<p id="Sec58" class="Heading1">Problem<a id="cXXX.1337" class="calibre6"></a></p>
<p class="noindent">You want to execute logic inside a Grails view that is not available through a prebuilt GSP or JSTL tag and yet not resort to the inclusion of code in a view.</p>
<p id="Sec59" class="Heading1">Solution</p>
<p class="noindent">A Grails view can contain display elements (e.g., HTML tags) <a id="cXXX.1338" class="calibre5"></a>, business logic elements (e.g., GSP or JSTL tags) or straightforward Groovy or Java code to achieve its display objectives.</p>
<p class="indent">On certain occasions, a view can require a unique combination of display elements and business logic. For example, displaying the reservations of a particular player on a monthly basis requires the use of custom code. To simplify the inclusion of such a combination and facilitate its reuse in multiple views a custom tag can be used.</p>
<p id="Sec60" class="Heading1">How It Works</p>
<p class="noindent">To create custom tags, you can use the <span class="FontName">grails create-tag-lib &lt;tag-lib-name&gt;</span> command<a id="cXXX.1339" class="calibre5"></a>. This command creates a skeleton class for a custom tag library under an application’s <span class="FontName">/grails-app/tag-lib/</span> directory.</p>
<p class="indent">Knowing this, let’s create a custom tag library for the court application designed to display special reservation offers. The first custom tag will detect the current date and based on this information display special reservation offers. The end result being the capacity to use a tag like <span class="FontName">&lt;g:promoDailyAd/&gt;</span>inside an application’s view, instead of placing in-line code in a view or performing this logic in a controller.</p>
<p class="indent">Execute the <span class="FontName">grails create-tag-lib DailyNotice</span> command to create the custom tag library class. Next, open the generated <span class="FontName">DailyNoticeTagLib.groovy</span> class<a id="cXXX.1340" class="calibre5"></a> located under an application’s <span class="FontName">/grails-app/tag-lib/</span> directory, and add the following method (i.e., custom tag):</p>
<pre class="calibre11"><span class="FontName">def promoDailyAd = { attrs, body -&gt;</span><br class="calibre10"/>  <span class="FontName">def dayoftheweek = Calendar.getInstance().get(Calendar.DAY_OF_WEEK)</span><br class="calibre10"/>  <span class="FontName">out &lt;&lt; body() &lt;&lt; (dayoftheweek == 7 ?</span><br class="calibre10"/>       <span class="FontName">"We have special reservation offers for Sunday!": "No special offers")</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The name of this method defines the name of the custom tag. The first declarations of the method (<span class="FontName">attrs, body</span>) represent the input values of a custom tag—its attributes and body. Next, the day of the week is determined using a <span class="FontName">Calendar</span> object.</p>
<p class="indent">After that, you can find a conditional statement based on the day of the week. If the day of the week is <span class="FontName">7</span> (Saturday ), the conditional statement resolves to the string <span class="FontName">"We have special reservation offers for Saturday!"</span>; otherwise, it resolves to <span class="FontName">"No special offers"</span>.</p>
<p class="indent">The string is outputted through <span class="FontName">&lt;&lt;</span> and is first assigned through to the <span class="FontName">body()</span> method, which represents the custom tag’s body, then through<span class="FontName">out</span>, which represents the custom tag’s output. In this manner, you declare the custom tag in an application’s view using the following syntax:</p>
<pre class="calibre11"><span class="FontName">&lt;g:promoDailyAd/&gt;&lt;/h3&gt;</span></pre>
<p class="indent">When the view containing this custom tag is rendered, Grails executes the logic in the backing class method and supplants it with the results. This allows a view to display results based on more elaborate logic by means of a simple declaration.</p>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Caution</b>  This type of tag is automatically available in GSP pages but not JSP pages. In order for this custom tag to function properly in JSP, it’s necessary to add it to the corresponding Tag Library Definition (TLD) <span class="FontName">grails.tld</span>. TLDs are located in an application’s <span class="FontName">/web-app/WEB-INF/tld/</span> directory.</p></div>
<p class="indent">Custom tags<a id="cXXX.2022" class="calibre5"></a> can also rely on input parameters passed in as tag attributes to perform a backing class’s logic. The following listing illustrates another custom tag that expects an attribute named <span class="FontName">offerdate</span> to determine its results:</p>
<pre class="calibre11"><span class="FontName">def upcomingPromos  = { attrs, body -&gt;</span><br class="calibre10"/>  <span class="FontName">def dayoftheweek = attrs['offerdate']</span><br class="calibre10"/>  <span class="FontName">out &lt;&lt; body() &lt;&lt; (dayoftheweek == 7 ?</span><br class="calibre10"/>       <span class="FontName">"We have special reservation offers for Saturday!": "No special offers")</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Though similar to the earlier custom tag, this last listing uses the statement <span class="FontName">attrs['offerdate']</span> to determine the day of the week. In this case, <span class="FontName">attrs</span> represents the attributes passed as input parameters to the <a id="cXXX.1341" class="calibre5"></a>class method (i.e., those declared in the view). Therefore, to use this last custom tag, a declaration like the following is used:</p>
<pre class="calibre11"><span class="FontName">&lt;g:upcomingPromos offerdate='saturday'/&gt;&lt;/h3&gt;</span></pre>
<p class="indent">This type of custom tag allows more flexibility, since its logic is executed on the basis of data provided in a view. Inclusively, it’s also possible to use a variable representing data passed by a controller into a view, as illustrated here:</p>
<pre class="calibre11"><span class="FontName">&lt;g:upcomingPromos offerdate='${promoDay}'/&gt;&lt;/h3&gt;</span></pre>
<p class="indent">Finally, a word about the namespace used in Grails custom tags—by default, Grails assigns custom tags to the <span class="FontName">&lt;g:&gt;</span> namespace. To use a custom namespace, it’s necessary to declare the <span class="FontName">namespace</span><a id="cXXX.1342" class="calibre5"></a> field a top the custom tag library class.</p>
<pre class="calibre11"><span class="FontName">class DailyNoticeTagLib {</span><br class="calibre10"/>   <b class="calibre4">static namespace = 'court'</b><br class="calibre10"/>   <span class="FontName">def promoDailyAd = { attrs, body -&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>   <span class="FontName">}</span><br class="calibre10"/>   <span class="FontName">def upcomingPromos  = { attrs, body -&gt;</span><br class="calibre10"/>   <span class="FontName">...</span><br class="calibre10"/>   <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">By using this last statement, a class’s custom tags are assigned their own custom namespace named <span class="FontName">court</span>. With the custom tag declarations made in a view requiring to be changed to the following:</p>
<pre class="calibre11"><span class="FontName">&lt;court:promoDailyAd/&gt;&lt;/h3&gt;</span><br class="calibre10"/><span class="FontName">&lt;court:upcomingPromos offerdate='${promoDay}'/&gt;&lt;/h3&gt;</span></pre>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Tip</b>  The Grails project has several contributed custom tags you can use in your applications. Consult: <span class="FontName"><a href="http://www.grails.org/Contribute" class="calibre5">http://www.grails.org/Contribute</a>+a+Tag</span></p></div>
<p id="Sec61" class="Heading">18-14. Adding Security<a id="cXXX.1343" class="calibre6"></a></p>
<p id="Sec62" class="Heading1">Problem<a id="cXXX.1344" class="calibre6"></a></p>
<p class="noindent">You want to secure your application using Spring Security.</p>
<p id="Sec63" class="Heading2">Solution</p>
<p class="noindent">Use the Grails Spring Security plugin to have security applied to your application.</p>
<p id="Sec64" class="Heading2">How It Works</p>
<p class="noindent">To secure an application you need to add the Grails plugin<a id="cXXX.2218" class="calibre5"></a> <span class="FontName">spring-security-core</span> to the application. To do this open the <span class="FontName">grails-app\conf\BuildConfig.groovy</span> file and add the plugin to it.</p>
<pre class="calibre11"><span class="FontName">grails.project.dependency.resolution = {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">repositories {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <b class="calibre4">mavenRepo '</b><b class="calibre4"><a href="http://repo.spring.io/milestone" class="calibre5">http://repo.spring.io/milestone</a></b><b class="calibre4">'</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">dependencies {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">plugins {</span><br class="calibre10"/>        <span class="FontName">// plugins for the compile step</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <b class="calibre4">compile ":spring-security-core:2.0-RC4"</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The plugin is added to the <span class="FontName">plugin</span> section of the <span class="FontName">grails.project.dependency.resolution</span> section. (Note as this isn’t a final version but a release candidate you need to add the Spring milestone repository to the <span class="FontName">repositories</span> section).</p>
<p class="indent">Now that the plugin is added running <span class="FontName">grails compile</span> will download and install the plugin.</p>
<p class="indent">After installing the plugin, security can be set up using the <span class="FontName">s2-quickstart</span> command. This command takes a package name and names of the classes to use for representing the user and its authorities.</p>
<pre class="calibre11"><span class="FontName">grails s2-quickstart court SecUser SecRole</span></pre>
<p class="indent">Running this will create a <span class="FontName">SecUser</span> and <span class="FontName">SecRole</span> domain object<a id="cXXX.1345" class="calibre5"></a><a id="cXXX.2221" class="calibre5"></a>. It will also modify the <span class="FontName">grails-app/conf/Config.groovy</span> file this will have a security section added.</p>
<pre class="calibre11"><span class="FontName">// Added by the Spring Security Core plugin:</span><br class="calibre10"/><span class="FontName">grails.plugin.springsecurity.userLookup.userDomainClassName = 'court.SecUser'</span><br class="calibre10"/><span class="FontName">grails.plugin.springsecurity.userLookup.authorityJoinClassName = 'court.SecUserSecRole'</span><br class="calibre10"/><span class="FontName">grails.plugin.springsecurity.authority.className = 'court.SecRole'</span><br class="calibre10"/><span class="FontName">grails.plugin.springsecurity.controllerAnnotations.staticRules = [</span><br class="calibre10"/>        <span class="FontName">'/':                              ['permitAll'],</span><br class="calibre10"/>        <span class="FontName">'/index':                         ['permitAll'],</span><br class="calibre10"/>        <span class="FontName">'/index.gsp':                     ['permitAll'],</span><br class="calibre10"/>        <span class="FontName">'/assets/**':                     ['permitAll'],</span><br class="calibre10"/>        <span class="FontName">'/**/js/**':                      ['permitAll'],</span><br class="calibre10"/>        <span class="FontName">'/**/css/**':                     ['permitAll'],</span><br class="calibre10"/>        <span class="FontName">'/**/images/**':                  ['permitAll'],</span><br class="calibre10"/>        <span class="FontName">'/**/favicon.ico':                ['permitAll']</span><br class="calibre10"/><span class="FontName">]</span></pre>
<p class="indent">When running the application with <span class="FontName">grails run-app</span> the application will start and have security applied. If you try to access the application you will be prompted with a login screen<a id="cXXX.2219" class="calibre5"></a> asking for a username and password (see <a id="_Fig5" href="part0028.html#Fig5" class="calibre5">Figure 18-5</a>).</p>
<div class="Figure" id="Fig5">
<p class="img1"><img src="../images/00090.jpeg" alt="9781430259084_Fig18-05.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0028.html#_Fig5" class="calibre5">Figure 18-5</a>.</span> Login screen after adding security<a id="cXXX.1346" class="calibre5"></a></p></div>
<p class="indent">Currently there are no users and roles in the system so logging on to the system isn’t possible at the moment.</p>
<p id="Sec65" class="Heading2">Bootstrapping Security<a id="cXXX.2217" class="calibre6"></a><a id="cXXX.1347" class="calibre6"></a></p>
<p class="noindent">To use the system first there need to be users that have passwords and roles in a live application. These would come from a database, ldap directory or maybe some files on the file system. You will add some users in the bootstrap script of the application. Open the <span class="FontName">Bootstrap.groovy</span> file in the <span class="FontName">grails-app/conf</span> directory and add 2 users and 2 roles to the system.</p>
<pre class="calibre11"><span class="FontName">class BootStrap {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">def init = { servletContext -&gt;</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">def adminRole = new court.SecRole(authority: 'ROLE_ADMIN').save(flush: true)</span><br class="calibre10"/>        <span class="FontName">def userRole = new court.SecRole(authority: 'ROLE_USER').save(flush: true)</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">def testUser = new  court.SecUser(username: 'user', password: 'password')</span><br class="calibre10"/>        <span class="FontName">testUser.save(flush: true)</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">def testAdmin = new  court.SecUser(username: 'admin', password: 'secret')</span><br class="calibre10"/>        <span class="FontName">testAdmin.save(flush: true)</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">court.SecUserSecRole.create testUser, userRole, true</span><br class="calibre10"/>        <span class="FontName">court.SecUserSecRole.create testAdmin, adminRole, true</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">First 2 roles, ROLE_ADMIN and ROLE_USER, are added to the system. Next 2 users are added both with a username and password. Finally the link between the user and the role is made.</p>
<p class="indent">Now that everything is in place restart the application and logon to the system (see <a id="_Fig6" href="part0028.html#Fig6" class="calibre5">Figure 18-6</a>).</p>
<div class="Figure" id="Fig6">
<p class="img1"><img src="../images/00091.jpeg" alt="9781430259084_Fig18-06.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0028.html#_Fig6" class="calibre5">Figure 18-6</a>.</span> The system after logging in with a user</p></div>
<p class="indent">Although you are able to login you will be greeted with a page telling you that you aren’t allowed to access the page you requested. Although there are now users in the system, our system doesn’t know that those are allowed to access the page requests. For this we need to add configuration to make clear which URLs are allowed to be accessed.</p>
<p id="Sec66" class="Heading2">Securing URLs<a id="cXXX.2220" class="calibre6"></a><a id="cXXX.1348" class="calibre6"></a></p>
<p class="noindent">After creating the security configuration only some default URLs are added to it. It doesn’t contain the specific URLs for your application. For this open the <span class="FontName">Config.groovy</span> file in the <span class="FontName">grails<a id="cXXX.2215" class="calibre5"></a>-app/conf</span> directory.</p>
<pre class="calibre11"><span class="FontName">grails.plugin.springsecurity.controllerAnnotations.staticRules = [</span><br class="calibre10"/>    <span class="FontName">'/':                              ['permitAll'],</span><br class="calibre10"/>    <span class="FontName">'/index':                         ['permitAll'],</span><br class="calibre10"/>    <span class="FontName">'/index.gsp':                     ['permitAll'],</span><br class="calibre10"/>    <span class="FontName">'/assets/**':                     ['permitAll'],</span><br class="calibre10"/>    <span class="FontName">'/**/js/**':                      ['permitAll'],</span><br class="calibre10"/>    <span class="FontName">'/**/css/**':                     ['permitAll'],</span><br class="calibre10"/>    <span class="FontName">'/**/images/**':                  ['permitAll'],</span><br class="calibre10"/>    <span class="FontName">'/**/favicon.ico':                ['permitAll'</span><b class="calibre4">],</b><br class="calibre10"/>    <b class="calibre4">'/player/**':                     ['isAuthenticated()'],</b><br class="calibre10"/>    <b class="calibre4">'/reservation/**':                ['isAuthenticated()']</b><br class="calibre10"/><span class="FontName">]</span></pre>
<p class="indent">Notice the 2 new additions one for the players section of the site and one for the reservation section of the site. The expression, <span class="FontName">/player/**</span>, is a so called ant-style pattern it matches everything that starts with <span class="FontName">/player</span>. The <span class="FontName">permitAll</span> means everyone even no users can access those parts of the website (mostly useful for static and public content). With <span class="FontName">isAuthenticated()</span> only authenticated users are allowed to access the site. For more allowed expression see the recipes on Spring Security (<a href="part0018.html" class="calibre5">Chapter 8</a>).</p>
<p class="indent">After rebuilding and starting the application you should be able to access the player and reservations screens again.</p>
<p id="Sec67" class="Heading2">Using Annotations for Security<a id="cXXX.2216" class="calibre6"></a><a id="cXXX.1349" class="calibre6"></a></p>
<p class="noindent">Next to securing URLs it is also possible to secure methods, for this there you can use the <span class="FontName">@Secured</span> annotation. Let’s secure the <span class="FontName">create</span> method so that only admins can create new players.</p>
<pre class="calibre11"><b class="calibre4">import grails.plugin.springsecurity.annotation.Secured</b><br class="calibre10"/><br class="calibre10"/><span class="FontName">class PlayerController {</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Secured(['ROLE_ADMIN'])</b><br class="calibre10"/>    <span class="FontName">def create() {</span><br class="calibre10"/>        <span class="FontName">respond new Player(params)</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice the addition of the <span class="FontName">@Secured</span> annotation to the <span class="FontName">create</span> method. The annotation takes an array of roles that are allowed access. Here ROLE_<span class="FontName">ADMIN</span> is specified, as access is limited to administrators only. The <span class="FontName">@Secured</span> annotation can also be placed on the class level instead of the method level and this will add security to all methods in the class.</p>
<p class="indent">Logging in as a normal user (using <span class="FontName">user/password</span>) and trying to create a new player will result in an access denied page (the same as shown in <a href="part0028.html#Fig6" class="calibre5">Figure 18-6</a>). When doing the same with an administrator (using <span class="FontName">admin/secret</span>) you will be allowed to enter a new player.</p>
<p id="Sec68" class="Heading">Summary</p>
<p class="noindent">In this chapter, you learned how to develop Java web applications using the Grails framework. You started by learning the structure of a Grails application and quickly followed that by working with a sample application that demonstrated the automation of several steps undertaken in a web application.</p>
<p class="indent">Throughout the various recipes, you also learned how Grails uses conventions in its automation process to create an application’s views, controllers, models, and configuration files.</p>
<p class="indent">In addition, you also learned about the existence of Grails plug-ins to automate tasks for related Java APIs or frameworks in the context of Grails. You then explored how Grails separates configuration parameters and executes tasks on the basis of an application’s working environment, which can be development, testing, or production.</p>
<p class="indent">You then learned how, from an application’s domain classes, Grails generates the corresponding controller and views used to perform CRUD operations against a RDBMS. Next, you explored Grails internationalization, logging, and testing facilities.</p>
<p class="indent">Next, you explored Grails layouts and templates used to modularize an application’s display and followed that with a look at the Grails Object Relational Mapping (GORM) facilities<a id="cXXX.2050" class="calibre5"></a><a id="cXXX.1350" class="calibre5"></a>, as well as the creation of custom tags.</p>
<p class="indent">Finally you explored how to apply Spring Security to a Grails project and how to configure and use it to secure URLs and methods.</p></div>
</body></html>
