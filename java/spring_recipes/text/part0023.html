<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Chapter 13 NoSQL and BigData</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre"><p class="ChapterNumber"><a id="b9781430259084_13" class="calibre6"></a>CHAPTER 13</p>
<p class="Chapimage"><img src="../images/00008.jpeg" alt="image" class="calibre3"/></p>
<p class="ChapterTitle">NoSQL and BigData</p>
<div class="calibre10"><p class="noindent">Most applications use a relational database like Oracle, MySQL, or Postgresql; however there is more too data storage then just SQL databases<a id="cXXX.941" class="calibre5"></a>. There are:</p>
<ol class="OrderedList">
<li value="1" class="calibre17">Relational Databases (Oracle, Mysql, Postgresql, etc.)</li>
<li value="2" class="calibre17">Document Stores (MongoDB, Couchbase)</li>
<li value="3" class="calibre17">Key-Value Stores (Redis, Volgemort)</li>
<li value="4" class="calibre17">Column Stores (Cassandra)</li>
<li value="5" class="calibre17">Graph Stores (Neo4j, Giraph)</li></ol>
<p class="indent">Although each of these different technologies (and even the different implementations) have their own use, they can also be hard to use or configure. Additionally, sometimes it might feel that one writes a lot of duplicated plumbing code for handling transactions and error translation.</p>
<p class="indent">The Spring Data project can help make life easier; it can help configure the different technologies with the plumbing code. Each of the integration modules will have support for exception translation to Spring’s consistent <span class="FontName">DataAccessException</span><a id="cXXX.942" class="calibre5"></a> hierarchy and the use of Spring’s templating approach.</p>
<p class="indent">Spring Data also provides a cross-storage solution for some technologies which means part of your model can be stored in a relational database with JPA and the other part can be stored in a graph or document store.</p>
<p id="Sec1" class="Heading">13-1. Using MongoDB<a id="cXXX.943" class="calibre6"></a></p>
<p id="Sec2" class="Heading1">Problem</p>
<p class="noindent">You want to use MongoDB to store and retrieve documents.</p>
<p id="Sec3" class="Heading1">Solution</p>
<p class="noindent">Download and configure MongoDB.</p>
<p id="Sec4" class="Heading1">How It Works</p>
<p id="Sec5" class="Heading2">Downloading and Starting MongoDB</p>
<p class="noindent">First download MongoDB from <span class="FontName"><a href="http://www.mongodb.org" class="calibre5">http://www.mongodb.org</a></span>. Select the one that is applicable for the system in use and follow the installation<a id="cXXX.944" class="calibre5"></a> instructions in the manual (<span class="FontName"><a href="http://docs.mongodb.org/manual/installation/" class="calibre5">http://docs.mongodb.org/manual/installation/</a></span>). When the installation is complete MongoDB can be started.</p>
<p class="indent">To start MongoDB execute the <span class="FontName">mongodb</span> command on the command line (see <a id="_Fig1" href="part0023.html#Fig1" class="calibre5">Figure 13-1</a>). This will start a MongoDB server on port <span class="FontName">27017</span>. If a different port is required this can be done by specifying the <span class="FontName">--port</span> option on the command line when starting the server.</p>
<div class="Figure" id="Fig1">
<p class="img1"><img src="../images/00075.jpeg" alt="9781430259084_Fig13-01.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0023.html#_Fig1" class="calibre5">Figure 13-1</a>.</span> Output after initial start of MongoDB</p></div>
<p class="indent">The default location for storing data is \data\db (for Windows users this is from the root of the disk where MongoDB was installed!) to change the path use the <span class="FontName">--dbpath</span> option on the command line. Make sure that the directory exists and is writeable for MongoDB.</p>
<p id="Sec6" class="Heading2">Connecting to MongoDB</p>
<p class="noindent">For a connection<a id="cXXX.945" class="calibre5"></a> to MongoDB an instance of <span class="FontName">Mongo</span> is needed. This instance can be used to get the database to use and the actual underlying collection(s). Let’s create a small system that uses MongoDB first to create an object to use for storage.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Vehicle {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String vehicleNo;</span><br class="calibre10"/>    <span class="FontName">private String color;</span><br class="calibre10"/>    <span class="FontName">private int wheel;</span><br class="calibre10"/>    <span class="FontName">private int seat;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Vehicle() {</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Vehicle(String vehicleNo, String color, int wheel, int seat) {</span><br class="calibre10"/>        <span class="FontName">this.vehicleNo = vehicleNo;</span><br class="calibre10"/>        <span class="FontName">this.color = color;</span><br class="calibre10"/>        <span class="FontName">this.wheel = wheel;</span><br class="calibre10"/>        <span class="FontName">this.seat = seat;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">/// Getters and Setters have been omitted for brevity.</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">To work with this object, create a repository interface.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface VehicleRepository {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public long count();</span><br class="calibre10"/>    <span class="FontName">public void save(Vehicle vehicle);</span><br class="calibre10"/>    <span class="FontName">public void delete(Vehicle vehicle);</span><br class="calibre10"/>    <span class="FontName">public List&lt;Vehicle&gt; findAll()</span><br class="calibre10"/>    <span class="FontName">public Vehicle findByVehicleNo(String vehicleNo);</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">For MongoDB create the <span class="FontName">MongoDBVehicleRepository</span> implementation of the <span class="FontName">VehicleRepository</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.mongodb.*;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.annotation.PostConstruct;</span><br class="calibre10"/><span class="FontName">import java.util.ArrayList;</span><br class="calibre10"/><span class="FontName">import java.util.List;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class MongoDBVehicleRepository implements VehicleRepository {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private final Mongo mongo;</span><br class="calibre10"/>    <span class="FontName">private final String collectionName;</span><br class="calibre10"/>    <span class="FontName">private final String databaseName;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public MongoDBVehicleRepository(Mongo mongo, String databaseName, String collectionName) {</span><br class="calibre10"/>        <span class="FontName">this.mongo = mongo;</span><br class="calibre10"/>        <span class="FontName">this.databaseName=databaseName;</span><br class="calibre10"/>        <span class="FontName">this.collectionName = collectionName;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public long count() {</span><br class="calibre10"/>        <span class="FontName">return getCollection().count();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void save(Vehicle vehicle) {</span><br class="calibre10"/>        <span class="FontName">BasicDBObject query = new BasicDBObject("vehicleNo", vehicle.getVehicleNo());</span><br class="calibre10"/>        <span class="FontName">DBObject dbVehicle = transform(vehicle);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">DBObject fromDB = getCollection().findAndModify(query, dbVehicle);</span><br class="calibre10"/>        <span class="FontName">if (fromDB == null) {</span><br class="calibre10"/>            <span class="FontName">getCollection().insert(dbVehicle);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void delete(Vehicle vehicle) {</span><br class="calibre10"/>        <span class="FontName">BasicDBObject query = new BasicDBObject("vehicleNo", vehicle.getVehicleNo());</span><br class="calibre10"/>        <span class="FontName">getCollection().remove(query);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public List&lt;Vehicle&gt; findAll() {</span><br class="calibre10"/>        <span class="FontName">DBCursor cursor = getCollection().find(null);</span><br class="calibre10"/>        <span class="FontName">List&lt;Vehicle&gt; vehicles = new ArrayList&lt;&gt;(cursor.size());</span><br class="calibre10"/>        <span class="FontName">for (DBObject dbObject : cursor) {</span><br class="calibre10"/>            <span class="FontName">vehicles.add(transform(dbObject));</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">return vehicles;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public Vehicle findByVehicleNo(String vehicleNo) {</span><br class="calibre10"/>        <span class="FontName">BasicDBObject query = new BasicDBObject("vehicleNo", vehicleNo);</span><br class="calibre10"/>        <span class="FontName">DBObject dbVehicle = getCollection().findOne(query);</span><br class="calibre10"/>        <span class="FontName">return transform(dbVehicle);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private DBCollection getCollection() {</span><br class="calibre10"/>        <span class="FontName">return mongo.getDB(databaseName).getCollection(collectionName);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private Vehicle transform(DBObject dbVehicle) {</span><br class="calibre10"/>        <span class="FontName">return new Vehicle(</span><br class="calibre10"/>                <span class="FontName">(String) dbVehicle.get("vehicleNo"),</span><br class="calibre10"/>                <span class="FontName">(String) dbVehicle.get("color"),</span><br class="calibre10"/>                <span class="FontName">(int) dbVehicle.get("wheel"),</span><br class="calibre10"/>                <span class="FontName">(int) dbVehicle.get("seat"));</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private DBObject transform(Vehicle vehicle) {</span><br class="calibre10"/>        <span class="FontName">BasicDBObject dbVehicle = new BasicDBObject("vehicleNo", vehicle.getVehicleNo())</span><br class="calibre10"/>                <span class="FontName">.append("color", vehicle.getColor())</span><br class="calibre10"/>                <span class="FontName">.append("wheel", vehicle.getWheel())</span><br class="calibre10"/>                <span class="FontName">.append("seat", vehicle.getSeat());</span><br class="calibre10"/>        <span class="FontName">return dbVehicle;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@PostConstruct</span><br class="calibre10"/>    <span class="FontName">public void shutdown() {</span><br class="calibre10"/>        <span class="FontName">mongo.getDB(databaseName).dropDatabase();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/></pre>
<p class="indent">First notice the constructor it takes three arguments. The first is the actual MongoDB<a id="cXXX.2121" class="calibre5"></a> client, the second is the name of the database that is going to be used, and the last is the name of the collection in which the objects are stored. Documents in mongodb are stored in collections and a collection belongs to a database.</p>
<p class="indent">For easy access to the <span class="FontName">DBCollection</span> used there is the <span class="FontName">getCollection</span> method<a id="cXXX.946" class="calibre5"></a> which gets a connection to the DB and returns the configured <span class="FontName">DBCollection</span>. This <span class="FontName">DBCollection</span><a id="cXXX.947" class="calibre5"></a> can then be used to execute operations like storing, deleting, or updating documents.</p>
<p class="indent">The <span class="FontName">save</span> method will first try to update and existing document. If this fails a new document for the given <span class="FontName">Vehicle</span> will be created. To store objects, start by transforming the domain object <span class="FontName">Vehicle</span> into a <span class="FontName">DBObject</span> in this case a <span class="FontName">BasicDBObject</span>. The <span class="FontName">BasicDBObject</span><a id="cXXX.948" class="calibre5"></a> takes key/value pairs of the different properties of our <span class="FontName">Vehicle</span> object.</p>
<p class="indent">When querying for a document the same <span class="FontName">DBObject</span> is used, the key/value pairs that are present on the given object are used to lookup documents, an example can be found in the <span class="FontName">findByVehicleNo</span> method in the repository.</p>
<p class="indent">Conversion from and to <span class="FontName">Vehicle</span> objects is done through the two <span class="FontName">transform</span> methods.</p>
<p class="indent">To use this class create the following Main class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.mongodb.MongoClient;</span><br class="calibre10"/><span class="FontName">import org.apache.commons.lang3.builder.ToStringBuilder;</span><br class="calibre10"/><span class="FontName">import org.apache.commons.lang3.builder.ToStringStyle;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.List;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static final String DB_NAME = "vehicledb";</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">// Default mongoclient for localhost and port 27017</span><br class="calibre10"/>        <span class="FontName">MongoClient mongo = new MongoClient();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">VehicleRepository repository = new MongoDBVehicleRepository(mongo, DB_NAME, "vehicles");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">System.out.println("Number of Vehicles: " + repository.count());</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">repository.save(new Vehicle("TEM0001", "RED", 4, 4));</span><br class="calibre10"/>        <span class="FontName">repository.save(new Vehicle("TEM0002", "RED", 4, 4));</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">System.out.println("Number of Vehicles: " + repository.count());</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Vehicle v = repository.findByVehicleNo("TEM0001");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">System.out.println(ToStringBuilder.reflectionToString(v, ToStringStyle.SHORT_PREFIX_STYLE));</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">List&lt;Vehicle&gt; vehicleList = repository.findAll();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">System.out.println("Number of Vehicles: " + vehicleList.size());</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">for (Vehicle vehicle : vehicleList) {</span><br class="calibre10"/>            <span class="FontName">repository.delete(vehicle);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">System.out.println("Number of Vehicles: " + repository.count());</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Cleanup and close</span><br class="calibre10"/>        <span class="FontName">mongo.getDB(DB_NAME).dropDatabase();</span><br class="calibre10"/>        <span class="FontName">mongo.close();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The main class constructs an instance of the MongoClient which will try to connect to port <span class="FontName">27017</span> on <span class="FontName">localhost</span> for a MongoDB instance. If another port or host is needed there is also a constructor which takes a host and port as parameters <span class="FontName">new MongoClient("mongodb-server.local", 28018)</span>.</p>
<p class="indent">Next an instance of the <span class="FontName">MongoDBVehicleRepository</span><a id="cXXX.949" class="calibre5"></a> is constructed, the earlier constructed MongoClient is passed as well as the name of the database, <span class="FontName">vehicledb</span>, and name of the collection, <span class="FontName">vehicles</span>.</p>
<p class="indent">The next lines of code will insert two vehicles into the database, try to find them, and finally delete them. The last lines in the main class will close the mongo instance and before doing so will drop the database. The latter is something you don’t want to do when using a production database.</p>
<p id="Sec7" class="Heading2">Using Spring for Configuration</p>
<p class="noindent">The setup and configuration of the <span class="FontName">MongoClient</span> and <span class="FontName">MongoDBVehicleRepository</span> can easily be moved to Spring configuration<a id="cXXX.950" class="calibre5"></a>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.nosql.MongoDBVehicleRepository;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.nosql.VehicleRepository;</span><br class="calibre10"/><span class="FontName">import com.mongodb.Mongo;</span><br class="calibre10"/><span class="FontName">import com.mongodb.MongoClient;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.net.UnknownHostException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class MongoConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static final String DB_NAME = "vehicledb";</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public Mongo mongo() throws UnknownHostException {</span><br class="calibre10"/>        <span class="FontName">return new MongoClient();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public VehicleRepository vehicleRepository(Mongo mongo) {</span><br class="calibre10"/>        <span class="FontName">return new MongoDBVehicleRepository(mongo, DB_NAME, " vehicles");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The following method has been added to the MongoDBVehicleRepository to take care of the cleanup of the database.</p>
<pre class="calibre11"><span class="FontName">@PreDestroy</span><br class="calibre10"/><span class="FontName">public void cleanUp() {</span><br class="calibre10"/>    <span class="FontName">mongo.getDB(databaseName).dropDatabase();</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Finally the Main program needs to be updated to reflect the changes.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.AbstractApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.List;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static final String DB_NAME = "vehicledb";</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <b class="calibre4">ApplicationContext ctx = new AnnotationConfigApplicationContext(MongoConfiguration.class);</b><br class="calibre10"/>        <b class="calibre4">VehicleRepository repository = ctx.getBean(VehicleRepository.class);</b><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/>        <b class="calibre4">((AbstractApplicationContext) ctx).close();</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The configuration is loaded by an <span class="FontName">AnnotationConfigApplicationContext</span> from this context the <span class="FontName">VehicleRepository</span> bean is retrieved and used to execute the operations. When the code that has run the context is closed, it triggers the <span class="FontName">cleanUp</span> method in the <span class="FontName">MongoDBVehicleRepository</span>.</p>
<p id="Sec8" class="Heading2">Using a MongoTemplate<a id="cXXX.2122" class="calibre6"></a><a id="cXXX.951" class="calibre6"></a> to Simplify MongoDB code</p>
<p class="noindent">At the moment the <span class="FontName">MongoDBVehicleRepository</span> uses the plain MongoDB API. Although not very complex it still requires knowledge about the API<a id="cXXX.952" class="calibre5"></a>. Next to that there are some repetitive tasks like mapping from and to a <span class="FontName">Vehicle</span> object. Using a <span class="FontName">MongoTemplate</span> can simplify the repository<a id="cXXX.953" class="calibre5"></a> considerably.</p>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  Before using Spring Data Mongo the relevant jars need to be added to the classpath. When using Maven add the following dependency:</p>
<pre class="calibre19"><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;spring-data-mongodb&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;1.6.0.RELEASE&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span></pre></div>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.mongodb.DB;</span><br class="calibre10"/><span class="FontName">import com.mongodb.MongoException;</span><br class="calibre10"/><span class="FontName">import org.springframework.dao.DataAccessException;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.mongodb.core.DbCallback;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.mongodb.core.MongoTemplate;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.mongodb.core.query.Query;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.annotation.PreDestroy;</span><br class="calibre10"/><span class="FontName">import java.util.List;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import static org.springframework.data.mongodb.core.query.Criteria.where;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class MongoDBVehicleRepository implements VehicleRepository {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private final MongoTemplate mongo;</span><br class="calibre10"/>    <span class="FontName">private final String collectionName;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public MongoDBVehicleRepository(</span><b class="calibre4">MongoTemplate mongo</b><span class="FontName">, String collectionName) {</span><br class="calibre10"/>        <span class="FontName">this.mongo = mongo;</span><br class="calibre10"/>        <span class="FontName">this.collectionName = collectionName;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public long count() {</span><br class="calibre10"/>        <span class="FontName">return mongo.count(null, collectionName);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void save(Vehicle vehicle) {</span><br class="calibre10"/>        <span class="FontName">mongo.save(vehicle, collectionName);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void delete(Vehicle vehicle) {</span><br class="calibre10"/>        <span class="FontName">mongo.remove(vehicle, collectionName);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public List&lt;Vehicle&gt; findAll() {</span><br class="calibre10"/>        <span class="FontName">return mongo.findAll(Vehicle.class, collectionName);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public Vehicle findByVehicleNo(String vehicleNo) {</span><br class="calibre10"/>        <span class="FontName">return mongo.findOne(new Query(where("vehicleNo").is(vehicleNo)), Vehicle.class, collectionName);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@PreDestroy</span><br class="calibre10"/>    <span class="FontName">public void cleanUp() {</span><br class="calibre10"/>        <span class="FontName">mongo.execute(new DbCallback&lt;Object&gt;() {</span><br class="calibre10"/>            <span class="FontName">@Override</span><br class="calibre10"/>            <span class="FontName">public Object doInDB(DB db) throws MongoException, DataAccessException {</span><br class="calibre10"/>                <span class="FontName">db.dropDatabase();</span><br class="calibre10"/>                <span class="FontName">return null;</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">});</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The code looks a lot cleaner when using a <span class="FontName">MongoTemplate</span>. It has convenience methods for almost every operation <span class="FontName">save</span>, <span class="FontName">update</span>, and <span class="FontName">delete</span>. Additionally, it has a very nice query builder approach (see the <span class="FontName">findByVehicleNo</span> method).</p>
<p class="indent">There are no more mappings to and from the mongo classes so there is no need to create a DBObject<a id="cXXX.954" class="calibre5"></a> anymore. That burden is now handled by the <span class="FontName">MongoTemplate</span>. To convert the Vehicle object to the MongoDB classes a <span class="FontName">MongoConverter</span><a id="cXXX.955" class="calibre5"></a> is used. By default a <span class="FontName">MappingMongoConverter</span> is used. This mapper maps properties to attribute names and vice versa and while doing so also tries to convert from and to the correct datatype. If a specific mapping is needed it is possible to write your own implementation of a <span class="FontName">MongoConverter</span> and register it with the <span class="FontName">MongoTemplate</span>.</p>
<p class="indent">Due to the use of the <span class="FontName">MongoTemplate</span> the configuration needs to be modified.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.nosql.MongoDBVehicleRepository;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.nosql.VehicleRepository;</span><br class="calibre10"/><span class="FontName">import com.mongodb.Mongo;</span><br class="calibre10"/><span class="FontName">import com.mongodb.MongoClient;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.mongodb.core.MongoFactoryBean;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.mongodb.core.MongoTemplate;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.net.UnknownHostException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class MongoConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static final String DB_NAME = "vehicledb";</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MongoTemplate mongo() throws Exception {</span><br class="calibre10"/>        <span class="FontName">return new MongoTemplate(mongoFactoryBean().getObject(), DB_NAME);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MongoFactoryBean mongoFactoryBean() {</span><br class="calibre10"/>        <span class="FontName">return new MongoFactoryBean();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public VehicleRepository vehicleRepository(MongoTemplate mongo) {</span><br class="calibre10"/>        <span class="FontName">return new MongoDBVehicleRepository(mongo, "vehicles");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice the use of the <span class="FontName">MongoFactoryBean</span><a id="cXXX.956" class="calibre5"></a>. It allows for easy setup of the <span class="FontName">MongoClient</span>. It isn’t a requirement for using the <span class="FontName">MongoTemplate</span> but it makes it easier to configure the client. Another benefit is that there is no more <span class="FontName">java.net.UnknownHostException</span> thrown that is handled internally by the <span class="FontName">MongoFactoryBean</span>.</p>
<p class="indent">The MongoTemplate has various constructors. The one used here takes a <span class="FontName">Mongo</span> instance and the name of the database to use. To resolve the database an instance of a <span class="FontName">MongoDbFactory</span> is used; by default the <span class="FontName">SimpleMongoDbFactory</span><a id="cXXX.957" class="calibre5"></a>. In most cases this is sufficient but if some special case arises, like encrypted connections, it is quite easy to extend the default implementation.</p>
<p class="indent">Finally the <span class="FontName">MongoTemplate</span> is injected, together with the name of the collection, into the <span class="FontName">MongoDBVehicleRepository</span>.</p>
<p class="indent">A final addition needs to be made to the Vehicle object. It is required that a field is available for storing the generated id. This can be either a field with the name <span class="FontName">id</span> or a field with the <span class="FontName">@Id</span> annotation.</p>
<pre class="calibre11"><span class="FontName">public class Vehicle {</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">private String id;</b><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec9" class="Heading2">Using Annotations to Specify Mapping Information<a id="cXXX.958" class="calibre6"></a></p>
<p class="noindent">Currently the <span class="FontName">MongoDBVehicleRepository</span> needs to know the name of the collection we want to access. It would be easier and more flexible if this could be specified on the <span class="FontName">Vehicle</span> object, just as with a JPA <span class="FontName">@Table</span> annotation. With Spring Data Mongo this is possible using the <span class="FontName">@Document</span> annotation.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.data.mongodb.core.mapping.Document;</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">@Document(collection = "vehicles")</b><br class="calibre10"/><span class="FontName">public class Vehicle { ... }</span></pre>
<p class="indent">The @Document annotation can take two attributes: <span class="FontName">collection</span> and <span class="FontName">language</span>. The <span class="FontName">collection</span> property is for specifying the name of the collection to use, the <span class="FontName">language</span> property is for specifying the language for this object. Now that the mapping information is on the <span class="FontName">Vehicle</span> class the collection name can be removed from the <span class="FontName">MongoDBVehicleRepository</span>.</p>
<pre class="calibre11"><span class="FontName">public class MongoDBVehicleRepository implements VehicleRepository {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private final MongoTemplate mongo;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public MongoDBVehicleRepository(MongoTemplate mongo) {</span><br class="calibre10"/>        <span class="FontName">this.mongo = mongo;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public long count() {</span><br class="calibre10"/>        <span class="FontName">return mongo.count(null, Vehicle.class);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void save(Vehicle vehicle) {</span><br class="calibre10"/>        <span class="FontName">mongo.save(vehicle);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void delete(Vehicle vehicle) {</span><br class="calibre10"/>        <span class="FontName">mongo.remove(vehicle);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public List&lt;Vehicle&gt; findAll() {</span><br class="calibre10"/>        <span class="FontName">return mongo.findAll(Vehicle.class);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public Vehicle findByVehicleNo(String vehicleNo) {</span><br class="calibre10"/>        <span class="FontName">return mongo.findOne(new Query(where("vehicleNo").is(vehicleNo)), Vehicle.class);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Of course the collection name can be removed from the configuration of the <span class="FontName">MongoDBVehicleRepository</span> as well.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class MongoConfiguration {</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public VehicleRepository vehicleRepository(MongoTemplate mongo) {</span><br class="calibre10"/>        <span class="FontName">return</span> <b class="calibre4">new MongoDBVehicleRepository(mongo);</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">When running the Main class the result should still be the same as it was before.</p>
<p id="Sec10" class="Heading2">Create a Spring Data MongoDB Repository</p>
<p class="noindent">Although the code has been reduced a lot in that there is no more mapping from and to MongoDB classes and no more collection names passing around, it can still be reduced even further. Leveraging another feature of Spring Data Mongo the complete implementation of the <span class="FontName">MongoDBVehicleRepository</span> could be removed.</p>
<p class="indent">First the configuration needs to be modified.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.mongodb.core.MongoFactoryBean;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.mongodb.core.MongoTemplate;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.mongodb.repository.config.EnableMongoRepositories;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><b class="calibre4">@EnableMongoRepositories(basePackages = "com.apress.springrecipes.nosql")</b><br class="calibre10"/><span class="FontName">public class MongoConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static final String DB_NAME = "vehicledb";</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MongoTemplate mongoTemplate() throws Exception {</span><br class="calibre10"/>        <span class="FontName">return new MongoTemplate(mongoFactoryBean().getObject(), DB_NAME);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MongoFactoryBean mongoFactoryBean() {</span><br class="calibre10"/>        <span class="FontName">return new MongoFactoryBean();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">First, notice the removal of the <span class="FontName">@Bean</span> method that constructed the <span class="FontName">MongoDBVehicleRepository</span>. Second, notice the addition of the <span class="FontName">@EnableMongoRepositories</span> annotation. This enables detection of interfaces that extend the Spring Data <span class="FontName">CrudRepository</span><a id="cXXX.959" class="calibre5"></a> and are used for domain objects annotated with <span class="FontName">@Document</span>.</p>
<p class="indent">To have our <span class="FontName">VehicleRepository</span> detected by Spring Data we need to let it extend <span class="FontName">CrudRepository</span> or one of its sub-interfaces like <span class="FontName">MongoRepository</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.data.mongodb.repository.MongoRepository;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface VehicleRepository extends MongoRepository&lt;Vehicle, String&gt; {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Vehicle findByVehicleNo(String vehicleNo);</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You might wonder where all the methods have gone. They are already defined in the super interfaces and as such can be removed from this interface. The <span class="FontName">findByVehicleNo</span> method<a id="cXXX.960" class="calibre5"></a> is still there. This method will still be used to lookup a <span class="FontName">Vehicle</span> by its <span class="FontName">vehicleNo</span> property. All the <span class="FontName">findBy</span> methods are converted into a MongoDB query. The part after the <span class="FontName">findBy</span> is interpreted as a property name. It is also possible to write more complex queries using different operators like <span class="FontName">and</span>, <span class="FontName">or</span>, and <span class="FontName">between</span>.</p>
<p class="indent">Now running the Main class again should still result in the same output, however the actual code written to work with MongoDB has been minimized.</p>
<p id="Sec11" class="Heading">13-2. Using Redis<a id="cXXX.961" class="calibre6"></a></p>
<p class="noindent">Redis is a key-value cache or store and it will only hold simple datatypes likes strings and hashes. When storing more complex datastructures, conversion from and to that datastructure is needed.</p>
<p id="Sec13" class="Heading2">Downloading and Starting Redis</p>
<p class="noindent">Redis sources can be downloaded from <span class="FontName"><a href="http://redis.io/download" class="calibre5">http://redis.io/download</a></span> at the moment of writing version 2.8.17 was the recently released stable version. A compiled version for Windows can be found at <span class="FontName"><a href="https://github.com/MSOpenTech/redis/tree/2.8/bin/release" class="calibre5">https://github.com/MSOpenTech/redis/tree/2.8/bin/release</a></span>. The official download site only provides unix binaries<a id="cXXX.962" class="calibre5"></a>. Mac users can use homebrew (<span class="FontName"><a href="http://brew.sh" class="calibre5">http://brew.sh</a></span>) to install Redis.</p>
<p class="indent">After downloading and installing Redis, start it using the <span class="FontName">redis-server</span> command<a id="cXXX.963" class="calibre5"></a> from the command line. When started, the output should be similar to that in <a id="_Fig2" href="part0023.html#Fig2" class="calibre5">Figure 13-2</a>, it will output the process-id (PID) and the port number (default 6379) it listens on.</p>
<div class="Figure" id="Fig2">
<p class="img1"><img src="../images/00076.jpeg" alt="9781430259084_Fig13-02.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0023.html#_Fig2" class="calibre5">Figure 13-2</a>.</span> Output after starting Redis</p></div>
<p id="Sec14" class="Heading2">Connecting to Redis</p>
<p class="noindent">To be able to connect to Redis a client is needed, much like a JDBC driver<a id="cXXX.964" class="calibre5"></a> to connect to a database. There are several clients available. A full list can be found on the Redis website (<span class="FontName"><a href="http://redis.io/clients" class="calibre5">http://redis.io/clients</a></span>).  For this recipe the Jedis client will be used as that is quite active and recommended by the Redis team.</p>
<p class="indent">When using maven add the following dependency for the client.</p>
<pre class="calibre11"><span class="FontName">&lt;dependency&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;groupId&gt;redis.clients&lt;/groupId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;artifactId&gt;jedis&lt;/artifactId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;version&gt;2.6.0&lt;/version&gt;</span><br class="calibre10"/><span class="FontName">&lt;/dependency&gt;</span></pre>
<p class="indent">Let’s start with a simple hello world sample to see if a connection to Redis can be made.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import redis.clients.jedis.Jedis;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">Jedis jedis = new Jedis("localhost");</span><br class="calibre10"/>        <span class="FontName">jedis.set("msg", "Hello World, from Redis!");</span><br class="calibre10"/>        <span class="FontName">System.out.println(jedis.get("msg"));</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">A Jedis client is created and passed the name of the host to connect to, in this case simply <span class="FontName">localhost</span><a id="cXXX.965" class="calibre5"></a>. The <span class="FontName">set</span> method on the Jedis client will put a message in the store and with <span class="FontName">get</span> the message is retrieved again.</p>
<p class="indent">Instead of a simple object you could also have Redis mimic a <span class="FontName">List</span> or a <span class="FontName">Map</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import redis.clients.jedis.Jedis;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">Jedis jedis = new Jedis("localhost");</span><br class="calibre10"/>        <span class="FontName">jedis.rpush("authors", "Marten Deinum", "Josh Long", "Daniel Rubio", "Gary Mak");</span><br class="calibre10"/>        <span class="FontName">System.out.println("Authors: " + jedis.lrange("authors",0,-1));</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">jedis.hset("sr_3", "authors", "Gary Mak, Danial Rubio, Josh Long, Marten Deinum");</span><br class="calibre10"/>        <span class="FontName">jedis.hset("sr_3", "published", "2014");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">System.out.println("Spring Recipes 3rd: " + jedis.hgetAll("sr_3"));</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">With <span class="FontName">rpush</span> and <span class="FontName">lpush</span><a id="cXXX.966" class="calibre5"></a> one can add elements to a <span class="FontName">List</span>, <span class="FontName">rpush</span> adds the elements to the end of the list and <span class="FontName">lpush</span> adds them to the start of the list. To retrieve them the lrange or rrange methods can be used, the <span class="FontName">lrange</span> starts from the left and takes a start and end index. The sample uses -1 that indicates everything.</p>
<p class="indent">To add elements to a <span class="FontName">Map</span> use <span class="FontName">hset</span>, this takes a key and a field and value, another option is to use <span class="FontName">hmset</span> (multi set) which takes a <span class="FontName">Map&lt;String, String&gt;,</span> or <span class="FontName">Map&lt;byte[], byte[]&gt;</span> as an argument.</p>
<p id="Sec15" class="Heading2">Storing Objects with Redis</p>
<p class="noindent">Redis is a key/value store and can only handle <span class="FontName">String</span>s or <span class="FontName">byte</span><a id="cXXX.967" class="calibre5"></a><span class="FontName">[]</span>. The same goes for the keys. So storing an object in Redis isn’t as straightforward as with other technologies. The object needs to be serialized to a <span class="FontName">String</span> or a <span class="FontName">byte[] before storing</span>.</p>
<p class="indent">Let’s reuse the <span class="FontName">Vehicle</span> class<a id="cXXX.968" class="calibre5"></a> used earlier and store and retrieve that using a Jedis client.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.io.Serializable;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Vehicle</span> <b class="calibre4">implements Serializable</b><span class="FontName">{</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String vehicleNo;</span><br class="calibre10"/>    <span class="FontName">private String color;</span><br class="calibre10"/>    <span class="FontName">private int wheel;</span><br class="calibre10"/>    <span class="FontName">private int seat;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Vehicle() {</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Vehicle(String vehicleNo, String color, int wheel, int seat) {</span><br class="calibre10"/>        <span class="FontName">this.vehicleNo = vehicleNo;</span><br class="calibre10"/>        <span class="FontName">this.color = color;</span><br class="calibre10"/>        <span class="FontName">this.wheel = wheel;</span><br class="calibre10"/>        <span class="FontName">this.seat = seat;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">// getters/setters omitted</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice the implements Serializable for the Vehicle class. This is needed to make the object serializable voor Java.</p>
<p class="indent">Before storing the object it needs to be converted into a <span class="FontName">byte[]</span> in Java the <span class="FontName">ObjectOutputStream</span> can write objects and the <span class="FontName">ByteArrayOutputStream</span><a id="cXXX.969" class="calibre5"></a> can write to a <span class="FontName">byte[]</span>. To transform a <span class="FontName">byte[]</span> into an object again the <span class="FontName">ObjectInputStream</span><a id="cXXX.970" class="calibre5"></a> and <span class="FontName">ByteArrayInputStream</span> are of help. First create a helper class to ease the de-/serialization process.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.io.*;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class SerializationUtils {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public byte[] serialize(Object obj) throws IOException {</span><br class="calibre10"/>        <span class="FontName">ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br class="calibre10"/>        <span class="FontName">try (ObjectOutputStream out = new ObjectOutputStream(baos)) {</span><br class="calibre10"/>            <span class="FontName">out.writeObject(obj);</span><br class="calibre10"/>            <span class="FontName">return baos.toByteArray();</span><br class="calibre10"/>        <span class="FontName">} finally {</span><br class="calibre10"/>            <span class="FontName">baos.close();</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static &lt;T&gt; T deserialize(byte[] bytes) throws IOException, ClassNotFoundException {</span><br class="calibre10"/>        <span class="FontName">try (ObjectInputStream in = new ObjectInputStream(new ByteArrayInputStream(bytes))) {</span><br class="calibre10"/>            <span class="FontName">return (T) in.readObject();</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now in the Main class let’s create a Vehicle and store it using Jedis.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import redis.clients.jedis.Jedis;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">Jedis jedis = new Jedis("localhost");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">final String vehicleNo = "TEM0001";</span><br class="calibre10"/>        <span class="FontName">Vehicle vehicle = new Vehicle(vehicleNo, "RED", 4, 4);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">jedis.set(vehicleNo.getBytes(),</span> <b class="calibre4">SerializationUtils.serialize(vehicle)</b><span class="FontName">);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">byte[] vehicleArray = jedis.get(vehicleNo.getBytes());</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">System.out.println("Vehicle: " +</span> <b class="calibre4">SerializationUtils.deserialize(vehicleArray)</b><span class="FontName">);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">First an instance of the <span class="FontName">Vehicle</span> is created. Next the earlier created <span class="FontName">SerializationUtils</span><a id="cXXX.971" class="calibre5"></a> are used to convert the object into a <span class="FontName">byte[]</span>. When storing a <span class="FontName">byte[]</span> the key also needs to be a <span class="FontName">byte[];</span> hence the key, here the <span class="FontName">vehicleNo</span>, is converted too. Finally the same key is used to read the serialized object from the store again and converted back into an object again.</p>
<p class="indent">The drawback of this approach is that every object that is stored needs to implement the Serializable interface. If this isn’t the case the object might be lost or an error during serialization might occur. Next to that the <span class="FontName">byte[]</span> is a representation of the class. Also now if this class is changed there is a great chance that converting it back into an object will fail.</p>
<p class="indent">Another option is to use a String representation of the object. Convert the <span class="FontName">Vehicle</span> into XML or JSON which would be more flexible than a <span class="FontName">byte[]</span>. Let’s take a look at converting the object into JSON using the excellent Jackson JSON library.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.fasterxml.jackson.databind.ObjectMapper;</span><br class="calibre10"/><span class="FontName">import redis.clients.jedis.Jedis;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args)</span> <b class="calibre4">throws Exception</b> <span class="FontName">{</span><br class="calibre10"/>        <span class="FontName">Jedis jedis = new Jedis("localhost");</span><br class="calibre10"/>        <b class="calibre4">ObjectMapper mapper = new ObjectMapper();</b><br class="calibre10"/>        <span class="FontName">final String vehicleNo = "TEM0001";</span><br class="calibre10"/>        <span class="FontName">Vehicle vehicle = new Vehicle(vehicleNo, "RED", 4,4);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">jedis.set(vehicleNo,</span> <b class="calibre4">mapper.writeValueAsString(vehicle)</b><span class="FontName">);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">String vehicleString = jedis.get(vehicleNo);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">System.out.println("Vehicle: " +</span> <b class="calibre4">mapper.readValue(vehicleString, Vehicle.class)</b><span class="FontName">);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">First an instance of the <span class="FontName">ObjectMapper</span><a id="cXXX.972" class="calibre5"></a> is needed. This object is used to convert from and to JSON. When writing the <span class="FontName">writeValueAsString</span> method<a id="cXXX.973" class="calibre5"></a> is used as it will transform the object into a JSON String. This <span class="FontName">String</span> is then stored in Redis. Next the <span class="FontName">String</span> is read again and passed to the <span class="FontName">readValue</span> method of the <span class="FontName">ObjectMapper</span>. Based on the type argument, <span class="FontName">Vehicle.class</span> here, an object is constructed and the JSON is mapped to an instance of the given class.</p>
<p class="indent">To run this sample a dependency on the Jackon library is needed. Add the following dependency:</p>
<pre class="calibre11"><span class="FontName">&lt;dependency&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;version&gt;2.4.2&lt;/version&gt;</span><br class="calibre10"/><span class="FontName">&lt;/dependency&gt;</span></pre>
<p class="indent">Storing objects when using Redis isn’t straightforward and some argue that this isn’t how Redis was intended to be used (storing complex object structures).</p>
<p id="Sec16" class="Heading2">Configuring and Using the RedisTemplate</p>
<p class="noindent">Depending on the client library used to connect to Redis it might be harder to use the Redis API. To unify this there is the <span class="FontName">RedisTemplate</span>. It can work with most Redis Java Clients out there. Next to providing a unified approach it also takes care of translating any exceptions into the Springs <span class="FontName">DataAccessException</span><a id="cXXX.974" class="calibre5"></a> hierarchy. This lets it integrate nicely with any already existing data access<a id="cXXX.2023" class="calibre5"></a> and allows it to use Springs transactions support.</p>
<p class="indent">First add a dependency on the Spring Data Redis project to your list of dependencies:</p>
<pre class="calibre11"><span class="FontName">&lt;dependency&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;version&gt;1.4.0.RELEASE&lt;/version&gt;</span><br class="calibre10"/><span class="FontName">&lt;/dependency&gt;</span></pre>
<p class="indent">The <span class="FontName">RedisTemplate</span> requires a <span class="FontName">RedisConnectionFactory</span><a id="cXXX.975" class="calibre5"></a> to be able to get a connection. The RedisConnectionFactory is an interface and several implementations are available. In this case the <span class="FontName">JedisConnectionFactory</span> is needed.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.nosql.Vehicle;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.redis.connection.RedisConnectionFactory;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.redis.connection.jedis.JedisConnectionFactory;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.redis.core.RedisTemplate;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class RedisConfig {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public</span> <b class="calibre4">RedisTemplate&lt;String, Vehicle&gt;</b> <span class="FontName">redisTemplate() {</span><br class="calibre10"/>        <span class="FontName">RedisTemplate template = new RedisTemplate();</span><br class="calibre10"/>        <span class="FontName">template.setConnectionFactory(redisConnectionFactory());</span><br class="calibre10"/>        <span class="FontName">return template;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public RedisConnectionFactory redisConnectionFactory() {</span><br class="calibre10"/>        <span class="FontName">return new JedisConnectionFactory();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice the return type of the <span class="FontName">redisTemplate</span> bean method. The <span class="FontName">RedisTemplate</span> is a generic class and requires a key and value type to be specified. In this case <span class="FontName">String</span> is the type of key and <span class="FontName">Vehicle</span> is the type of value, when storing and retrieving objects the RedisTemplate will take care of the conversion.</p>
<p class="indent">Conversion is done using a <span class="FontName">RedisSerializer</span>, which is an interface for which several implementations exist (see <a id="_Tab1" href="part0023.html#Tab1" class="calibre5">Table 13-1</a>).  The default RedisSerializer<a id="cXXX.976" class="calibre5"></a>, the <span class="FontName">JdkSerializationRedisSerializer</span>, uses standard Java serialization to convert objects to a byte[] and back.</p>
<div class="Table" id="Tab1">
<p class="TabCapt"><span class="calibre4"><a href="part0023.html#_Tab1" class="calibre5">Table 13-1</a>.</span> Default RedisSerializer implementations</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14">
<p class="tab-left">Name</p></th><th valign="top" class="calibre14">
<p class="tab-left">Description</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">GenericToStringSerializer</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">String</span> to <span class="FontName">byte[]</span> serializer, uses the Spring <span class="FontName">ConversionService</span> to convert objects to <span class="FontName">String</span> before converting to a <span class="FontName">byte[]</span>.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">Jackson2JsonRedisRedisSerializer</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Read and write JSON using a Jackon 2 <span class="FontName">ObjectMapper</span>.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">JacksonJsonRedisRedisSerializer</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Read and write JSON using a Jackon <span class="FontName">ObjectMapper</span>.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">JdkSerializationRedisSerializer</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Uses default java serialization and deserialization and is the default implementation used.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">OxmSerializer</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Read and write XML using Spring’s <span class="FontName">Marshaller</span> and <span class="FontName">Unmarshaller</span>.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">StringRedisSerializer</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Simple <span class="FontName">String</span> to <span class="FontName">byte[]</span> converter.</p></td></tr></tbody></table>
</div>
<p class="indent">To be able to use the <span class="FontName">RedisTemplate</span> the <span class="FontName">Main</span> class needs to be modified. The configuration needs to be loaded and the <span class="FontName">RedisTemplate</span> retrieved from it.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.nosql.config.RedisConfig;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.redis.core.RedisTemplate;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">ApplicationContext context = new AnnotationConfigApplicationContext(RedisConfig.class);</span><br class="calibre10"/>        <span class="FontName">RedisTemplate&lt;String, Vehicle&gt; template = context.getBean(RedisTemplate.class);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">final String vehicleNo = "TEM0001";</span><br class="calibre10"/>        <span class="FontName">Vehicle vehicle = new Vehicle(vehicleNo, "RED", 4,4);</span><br class="calibre10"/>        <span class="FontName">template.opsForValue().set(vehicleNo, vehicle);</span><br class="calibre10"/>        <span class="FontName">System.out.println("Vehicle: " + template.opsForValue().get(vehicleNo));</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">When the RedisTemplate has been retrieved from the ApplicationContext it can be used. The biggest advantage here is that one can use objects and the template handles the hard work of converting from and to objects. Notice how the <span class="FontName">set</span> method takes a <span class="FontName">String</span> and <span class="FontName">Vehicle</span> as arguments instead of only <span class="FontName">String</span> or <span class="FontName">byte[]</span>. This makes code more readable and easier to maintain.</p>
<p class="indent">By default JDK serialization is used. To use Jackson a different <span class="FontName">RedisSerializer</span> needs to be configured.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql.config;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class RedisConfig {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public RedisTemplate&lt;String, Vehicle&gt; redisTemplate() {</span><br class="calibre10"/>        <span class="FontName">RedisTemplate template = new RedisTemplate();</span><br class="calibre10"/>        <span class="FontName">template.setConnectionFactory(redisConnectionFactory());</span><br class="calibre10"/>        <b class="calibre4">template.setDefaultSerializer(new Jackson2JsonRedisSerializer(Vehicle.class));</b><br class="calibre10"/>        <span class="FontName">return template;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">RedisTemplate</span> will now use a Jackson <span class="FontName">ObjectMapper</span> to perform the serialization and deserialization. The remainder of the code can remain the same. When running the main program again it still works and the object will be stored using JSON.</p>
<p class="indent">When Redis is used inside a transaction it can also participate in that same transaction. For this set the <span class="FontName">enableTransactionSupport</span> property<a id="cXXX.977" class="calibre5"></a> on the <span class="FontName">RedisTemplate</span> to <span class="FontName">true</span>. This will take care of executing the Redis operation inside the transaction, when the transaction commits.</p>
<p id="Sec17" class="Heading">13-3. Using Hadoop<a id="cXXX.978" class="calibre6"></a></p>
<p id="Sec18" class="Heading1">Problem</p>
<p class="noindent">You want to use Hadoop in your application for map/reduce operations<a id="cXXX.979" class="calibre5"></a>.</p>
<p id="Sec19" class="Heading1">Solution</p>
<p class="noindent">Download and use Hadoop and add Spring Data Hadoop for easier use and configuration of jobs.</p>
<p id="Sec20" class="Heading1">How It Works</p>
<p class="noindent">Hadoop is a library for distributed computing, it provides a distributed file system (HDFS), a framework for job scheduling and cluster resource management<a id="cXXX.980" class="calibre5"></a> (YARN), and a system for parallel processing of large datasets. Covering all of Hadoop would require another book. This recipe will cover the basics and will show how to work with Hadoop using the Spring Data Hadoop project.</p>
<p id="Sec21" class="Heading2">Downloading and Running Hadoop</p>
<p class="noindent">First Hadoop needs to be installed by downloading a Hadoop version from their website (<span class="FontName"><a href="http://hadoop.apache.org/#Download" class="calibre5">http://hadoop.apache.org/#Download</a>+Hadoop</span>). This recipe will assume to operate in standalone mode and not in one of the cluster modes.</p>
<p id="Sec22" class="Heading2">Creating and Running a Map Reduce Job - StandAlone</p>
<p class="noindent">Let’s create a job that counts words in a file. For this we need a file and a <span class="FontName">Mapper</span> and <span class="FontName">Reducer</span> implementation. The code is in a single class, but you are free to place it in multiple source files if you like.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.hadoop;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.apache.commons.lang3.StringUtils;</span><br class="calibre10"/><span class="FontName">import org.apache.hadoop.conf.Configuration;</span><br class="calibre10"/><span class="FontName">import org.apache.hadoop.fs.Path;</span><br class="calibre10"/><span class="FontName">import org.apache.hadoop.io.IntWritable;</span><br class="calibre10"/><span class="FontName">import org.apache.hadoop.io.Text;</span><br class="calibre10"/><span class="FontName">import org.apache.hadoop.mapreduce.Job;</span><br class="calibre10"/><span class="FontName">import org.apache.hadoop.mapreduce.Mapper;</span><br class="calibre10"/><span class="FontName">import org.apache.hadoop.mapreduce.Reducer;</span><br class="calibre10"/><span class="FontName">import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br class="calibre10"/><span class="FontName">import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.io.IOException;</span><br class="calibre10"/><span class="FontName">import java.util.regex.Pattern;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class WordCount {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private static final Pattern WORD_BOUNDARY = Pattern.compile("\\s*\\b\\s*");</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static class TokenizerMapper extends Mapper&lt;Object, Text, Text, IntWritable&gt; {</span><br class="calibre10"/>        <span class="FontName">private final static IntWritable ONE = new IntWritable(1);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">public void map(Object key, Text value, Context context) throws IOException, InterruptedException {</span><br class="calibre10"/>            <span class="FontName">String line = value.toString();</span><br class="calibre10"/>            <span class="FontName">for (String word : WORD_BOUNDARY.split(line)) {</span><br class="calibre10"/>                <span class="FontName">if (StringUtils.isBlank(word)) {</span><br class="calibre10"/>                    <span class="FontName">continue;</span><br class="calibre10"/>                <span class="FontName">}</span><br class="calibre10"/>                <span class="FontName">context.write(new Text(word.toLowerCase()), ONE);</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static class IntSumReducer extends Reducer&lt;Text, IntWritable, Text, IntWritable&gt; {</span><br class="calibre10"/>        <span class="FontName">private IntWritable result = new IntWritable();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">public void reduce(Text key, Iterable&lt;IntWritable&gt; values, Context context)</span><br class="calibre10"/>                <span class="FontName">throws IOException, InterruptedException {</span><br class="calibre10"/>            <span class="FontName">int sum = 0;</span><br class="calibre10"/>            <span class="FontName">for (IntWritable val : values) {</span><br class="calibre10"/>                <span class="FontName">sum += val.get();</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>            <span class="FontName">result.set(sum);</span><br class="calibre10"/>            <span class="FontName">context.write(key, result);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">String input = System.getProperty("user.home") + "/</span><span class="FontName">hadoop-recipe</span><span class="FontName">/input";</span><br class="calibre10"/>        <span class="FontName">String output = System.getProperty("user.home") + "/hadoop-recipe/output";</span><br class="calibre10"/>        <span class="FontName">Configuration conf = new Configuration();</span><br class="calibre10"/>        <span class="FontName">Job job = Job.getInstance(conf, "word count");</span><br class="calibre10"/>        <span class="FontName">job.setJarByClass(WordCount.class);</span><br class="calibre10"/>        <span class="FontName">job.setMapperClass(TokenizerMapper.class);</span><br class="calibre10"/>        <span class="FontName">job.setCombinerClass(IntSumReducer.class);</span><br class="calibre10"/>        <span class="FontName">job.setReducerClass(IntSumReducer.class);</span><br class="calibre10"/>        <span class="FontName">job.setOutputKeyClass(Text.class);</span><br class="calibre10"/>        <span class="FontName">job.setOutputValueClass(IntWritable.class);</span><br class="calibre10"/>        <span class="FontName">FileInputFormat.addInputPath(job, new Path(input));</span><br class="calibre10"/>        <span class="FontName">FileOutputFormat.setOutputPath(job, new Path(output));</span><br class="calibre10"/>        <span class="FontName">System.exit(job.waitForCompletion(true) ? 0 : 1);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This is another example of a wordcount hadoop program. The <span class="FontName">TokenizerMapper</span> uses a regular expression to split a string into words. The words are then transformed to lowercase. The <span class="FontName">IntSumReducer</span><a id="cXXX.981" class="calibre5"></a> is simply counting the occurrences of the lowercase words.</p>
<p class="indent">The <span class="FontName">main</span> method of the <span class="FontName">WordCount</span> program<a id="cXXX.982" class="calibre5"></a> sets up the <span class="FontName">Configuration</span> and the <span class="FontName">Job</span> then the system waits for the job to finish. On a successful run it will exit with 0 else with 1.</p>
<p class="indent">Before running the recipe, make sure there is a <span class="FontName">hadoop-recipe/input</span> directory in your home folder. For the recipe the plaintext copy of <i class="calibre8">On the Origin of Species by Means of Natural Selection</i> by Charles Darwin was used. (More books are available on <a href="http://www.gutenburg.org" class="calibre5">http://www.gutenburg.org</a>). But any plaintext file will do. On the commandline run <span class="FontName">hdfs dfs -copyFromLocal &lt;local location of plaintext&gt; input/</span> to copy a plaintext file to the input directory. Now everything is in place to run the program.</p>
<p class="indent">After running the program the output directory is created and should contain some files, including a <span class="FontName">part-r-00000</span> file (depending on your filesize and configuration there might be more files). That file contains the output of running the job. To display the output run <span class="FontName">hdfs dfs –cat output/part-r-00000</span>.</p>
<p class="indent">Before running the next wordcount job you have to remove the output directory using <span class="FontName">hdfs –rmr output.</span> If you don’t do this the next executions will not run.</p>
<p id="Sec23" class="Heading2">Creating and Running a Map Reduce Job – Cluster</p>
<p class="noindent">Running a job in standalone mode is nice but where hadoop really shines in clustering and distribution. Although you don’t have a full cluster let’s setup a cluster of 1 node (a so-called pseudo cluster<a id="cXXX.983" class="calibre5"></a>). First make sure you can login with SSH to your localhost, try <span class="FontName">ssh localhost</span> on the commandline. If you can login or get a prompt saying to accept this host you are fine; if not you need to setup keys first.</p>
<p class="indent">Type <span class="FontName">ssh-keygen –t rsa –P ""</span> on the command line, followed by <span class="FontName">cat $HOME/.ssh/id_rsa.pub &gt;&gt; $HOME/.ssh/authorized_keys</span> this will create a key and add it to authorized keys. Now you should be able to login with ssh on localhost.</p>
<p class="indent">Next you need to modify the following configuration files <span class="FontName">core-site.xml</span>, <span class="FontName">hdfs-site.xml</span>, <span class="FontName">mapred-site.xml,yarn-site.xml</span> and <span class="FontName">hadoop-env.sh</span>. The instructions here are basically the same as in the tutorial on the Apache Hadoop website.<a id="_Fn1" href="part0023.html#Fn1" class="calibre5"><sup class="calibre9">1</sup></a></p>
<p class="indent">First modify the core-site.xml<a id="cXXX.984" class="calibre5"></a> and set the defaultFS property to <span class="FontName">localhost:9000</span>.</p>
<pre class="calibre11"><span class="FontName">&lt;configuration&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;name&gt;fs.defaultFS&lt;/name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;value&gt;hdfs://localhost:9000&lt;/value&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/><span class="FontName">&lt;/configuration&gt;</span></pre>
<p class="indent">Next up is the <span class="FontName">hdfs-site.xml</span> which needs to be configured for a single node.</p>
<pre class="calibre11"><span class="FontName">&lt;configuration&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;name&gt;dfs.replication&lt;/name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;value&gt;1&lt;/value&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/><span class="FontName">&lt;/configuration&gt;</span></pre>
<p class="indent">Next we need to configure YARN to run in a single node configuration. YARN is used to manage the jobs and resources. Let’s modify the <span class="FontName">mapred-site.xml</span>.</p>
<pre class="calibre11"><span class="FontName">&lt;configuration&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;name&gt;mapreduce.framework.name&lt;/name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;value&gt;yarn&lt;/value&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/><span class="FontName">&lt;/configuration&gt;</span></pre>
<p class="indent">Finally the <span class="FontName">yarn-site.xml</span> file.</p>
<pre class="calibre11"><span class="FontName">&lt;configuration&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;value&gt;mapreduce_shuffle&lt;/value&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/><span class="FontName">&lt;/configuration&gt;</span></pre>
<p class="indent">Now that all the configuration is in place you can start the filesystem and YARN. On the command line type <span class="FontName">start-dfs.sh</span> and <span class="FontName">start-yarn.sh</span>. You could also run start-all.sh but on newer versions of Hadoop this is deprecated and probably will be removed in future versions.</p>
<p class="indent">When you have trouble starting Hadoop you might need to modify the <span class="FontName">hadoop-env.sh</span> file. Open it and find the line that sets the HADOOP_OPTS variable<a id="cXXX.985" class="calibre5"></a> and append <span class="FontName">-Djava.security.krb5.realm= -Djava.security.krb5.kdc=</span> to it. Afterwards try to start again.</p>
<p class="indent">If everything is running there should be the Hadoop web console on http://localhost:50070 and the Yarn web console on http://localhost:8088.</p>
<p id="Sec24" class="Heading2">Using Spring for Hadoop to Run a Job</p>
<p class="noindent">Spring for Hadoop makes it easier to configure and run Hadoop jobs. The biggest advantage is that you can use Spring to configure the Hadoop client and jobs. Because of the usage of Spring you can use all the nice Spring features like resource loading and property placeholders for configuration.</p>
<p class="indent">Spring for Hadoop at the moment of this writing only had XML support<a id="cXXX.986" class="calibre5"></a> for configuring jobs so in this part of the recipe you are going to create a Spring XML based application context. Spring Hadoop has an XML namespace for easy configuration. Let’s transform the job you created into a Spring configured one.</p>
<p class="indent">Create a <span class="FontName">wordcount-context.xml</span> file for the job configuration.</p>
<pre class="calibre11"><span class="FontName">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br class="calibre10"/><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">" xmlns:hadoop="</span><span class="FontName"><a href="http://www.springframework.org/schema/hadoop" class="calibre5">http://www.springframework.org/schema/hadoop</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xsi:schemaLocation="</span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/hadoop" class="calibre5">http://www.springframework.org/schema/hadoop</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/hadoop/spring-hadoop.xsd" class="calibre5">http://www.springframework.org/schema/hadoop/spring-hadoop.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">&lt;hadoop:configuration file-system-uri="hdfs://localhost:9000/" /&gt;</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">&lt;hadoop:job id="wordCountJob"</span><br class="calibre10"/>                    <span class="FontName">mapper="com.apress.springrecipes.hadoop.TokenizerMapper"</span><br class="calibre10"/>                    <span class="FontName">reducer="com.apress.springrecipes.hadoop.IntSumReducer"</span><br class="calibre10"/>                    <b class="calibre4">jar-by-class="com.apress.springrecipes.hadoop.WordCountSpring"</b><br class="calibre10"/>                    <span class="FontName">input-path="/hadoop-recipe/input"</span><br class="calibre10"/>                    <span class="FontName">output-path="/hadoop-recipe/output" /&gt;</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">&lt;hadoop:job-runner job-ref="wordCountJob" run-at-startup="true" /&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">First there is the Hadoop configuration element. This has been configured to connect to the file system on localhost on port 9000 (which is what you configured the DFS to run on).  Next there is the job configuration. The id is required and needed by the job-runner further on. The job takes a mapper and reducer class, it needs the input and output path to know where to read from and store the result. The interesting part is the <span class="FontName">jar-by-class</span> property, when submitting a job to a Hadoop cluster it needs to know the files. The mapper and reducer classes are in our generated jar and that needs to be sent to Hadoop.</p>
<p class="indent">Finally the job-runner element, which takes a reference to a job configuration, and should be started at startup. This takes care of creating the Hadoop job and making sure the configuration is correct and can be run on the Hadoop instance.</p>
<p class="indent">The last is the bootstrap class. This needs to load the <span class="FontName">wordcount-context.xml</span> to kickoff the job.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.hadoop;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.support.AbstractApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.ClassPathXmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class WordCountSpring {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">AbstractApplicationContext context = new ClassPathXmlApplicationContext("wordcount-context.xml");</span><br class="calibre10"/>        <span class="FontName">System.out.println("Spring Hadoop WordCount Recipe Running.");</span><br class="calibre10"/>        <span class="FontName">context.registerShutdownHook();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The configuration is loaded by the ClassPathXmlApplicationContext<a id="cXXX.987" class="calibre5"></a> which immediately kicks of the job. A shutdown hook is registered so that when the job is finished the application context is cleaned up nicely.</p>
<p class="indent">Before running the job, remove any data from the output directory by executing <span class="FontName">hdfs dfs -rm -r /hadoop-recipe/output</span> on the command line. If there isn’t any input yet, copy it to Hadoop with <span class="FontName">hdfs dfs -copyFromLocal &lt;local location of plaintext&gt; input/</span> on the command line.</p>
<p class="indent">When the jar file of these classes has been build it can be simply executed with <span class="FontName">java –jar Recipe_13_3_ii-3.0.0.jar</span>. The job will be scheduled and if everything has been configured correctly will run successfully. The output should be like that in <a id="_Fig3" href="part0023.html#Fig3" class="calibre5">Figure 13-3</a>.</p>
<div class="Figure" id="Fig3">
<p class="img1"><img src="../images/00077.jpeg" alt="9781430259084_Fig13-03.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0023.html#_Fig3" class="calibre5">Figure 13-3</a>.</span> Output of successfully running the WordCount job</p></div>
<p class="indent">The information of the job can also be found in the YARN web console. For this navigate to http://localhost:8088 and check the status. The output should be like <a id="_Fig4" href="part0023.html#Fig4" class="calibre5">Figure 13-4</a><a id="cXXX.988" class="calibre5"></a>.</p>
<div class="Figure" id="Fig4">
<p class="img1"><img src="../images/00078.jpeg" alt="9781430259084_Fig13-04.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0023.html#_Fig4" class="calibre5">Figure 13-4</a>.</span> YARN web console after running jobs</p></div>
<p id="Sec25" class="Heading">13-4. Using Neo4j<a id="cXXX.989" class="calibre6"></a></p>
<p id="Sec26" class="Heading1">Problem</p>
<p class="noindent">You want to use Neo4j in your application.</p>
<p id="Sec27" class="Heading1">Solution</p>
<p class="noindent">Use the Spring Data Neo4j library to access Neo4j.</p>
<p id="Sec28" class="Heading1">How It Works</p>
<p id="Sec29" class="Heading2">Downloading and Running Neo4J</p>
<p class="noindent">Neo4J can be downloaded from the Neo4j website (<span class="FontName"><a href="http://neo4j.com/download/" class="calibre5">http://neo4j.com/download/</a></span>). For this recipe it is enough to download the community edition; however it should also work with the commercial version of Neo4j. Windows users can run the installer to install. Mac and Linux<a id="cXXX.990" class="calibre5"></a> users can extract the archive and, from inside the directory created, start with <span class="FontName">bin/neo4j</span>. Mac users can also use Homebrew (<a href="http://brew.sh" class="calibre5">http://brew.sh</a>) to install Neo4j with <span class="FontName">brew install neo4j</span>, starting can then be done with <span class="FontName">neo4j start</span> on the command line.</p>
<p class="indent">After starting on the command line the output should be similar to that of <a id="_Fig5" href="part0023.html#Fig5" class="calibre5">Figure 13-5</a>.</p>
<div class="Figure" id="Fig5">
<p class="img1"><img src="../images/00079.jpeg" alt="9781430259084_Fig13-05.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0023.html#_Fig5" class="calibre5">Figure 13-5</a>.</span> Output after initial start of Neo4j</p></div>
<p id="Sec30" class="Heading2">Starting Neo4j</p>
<p class="noindent">Let’s start by creating a Hello World with Neo4j. Create a main class that starts an embedded server, adds some data to Neo4j and retrieves it again.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.GraphDatabaseService;</span><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.Node;</span><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.Transaction;</span><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.factory.GraphDatabaseFactory;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">final String DB_PATH = System.getProperty("user.home") + "/friends";</span><br class="calibre10"/>        <b class="calibre4">GraphDatabaseService db = new GraphDatabaseFactory().newEmbeddedDatabase(DB_PATH);</b><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Transaction tx1 = db.beginTx();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Node hello = db.createNode();</span><br class="calibre10"/>        <span class="FontName">hello.setProperty("msg", "Hello");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Node world = db.createNode();</span><br class="calibre10"/>        <span class="FontName">world.setProperty("msg", "World");</span><br class="calibre10"/>        <span class="FontName">tx1.success();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Iterable&lt;Node&gt; nodes = db.getAllNodes();</span><br class="calibre10"/>        <span class="FontName">for (Node n : nodes) {</span><br class="calibre10"/>            <span class="FontName">System.out.println("Msg: " + n.getProperty("msg"));</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Remove all nodes</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This main will start an embedded Neo4j server. Next it will start a transaction and create two nodes. Next all nodes are retrieved and the value of the <span class="FontName">msg</span> property is printed to the console. Neo4j is good at traversing relations between nodes<a id="cXXX.991" class="calibre5"></a>. It is especially optimized for that (just like other Graph datastores).</p>
<p class="indent">Let’s create some nodes that have a relationship between them.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.neo4j.cypher.javacompat.ExecutionEngine;</span><br class="calibre10"/><span class="FontName">import org.neo4j.cypher.javacompat.ExecutionResult;</span><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.*;</span><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.factory.GraphDatabaseFactory;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.Map;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import static com.apress.springrecipes.nosql.Main.RelationshipTypes.*;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">enum RelationshipTypes implements RelationshipType {FRIENDS_WITH, MASTER_OF, SIBLING, LOCATION};</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">final String DB_PATH = System.getProperty("user.home") + "/starwars";</span><br class="calibre10"/>        <span class="FontName">GraphDatabaseService db = new GraphDatabaseFactory().newEmbeddedDatabase(DB_PATH);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Transaction tx1 = db.beginTx();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Label character = DynamicLabel.label("character");</span><br class="calibre10"/>        <span class="FontName">Label planet = DynamicLabel.label("planet");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Node dagobah = db.createNode(planet);</span><br class="calibre10"/>        <span class="FontName">dagobah.setProperty("name", "Dagobah");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Node tatooine = db.createNode(planet);</span><br class="calibre10"/>        <span class="FontName">tatooine.setProperty("name", "Tatooine");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Node alderaan = db.createNode(planet);</span><br class="calibre10"/>        <span class="FontName">alderaan.setProperty("name", "Alderaan");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Node yoda = db.createNode(character);</span><br class="calibre10"/>        <span class="FontName">yoda.setProperty("name", "Yoda");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Node luke = db.createNode(character);</span><br class="calibre10"/>        <span class="FontName">luke.setProperty("name", "Luke Skywalker");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Node leia = db.createNode(character);</span><br class="calibre10"/>        <span class="FontName">leia.setProperty("name", "Leia Organa");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Node han = db.createNode(character);</span><br class="calibre10"/>        <span class="FontName">han.setProperty("name", "Han Solo");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Relations</span><br class="calibre10"/>        <span class="FontName">yoda.createRelationshipTo(luke, MASTER_OF);</span><br class="calibre10"/>        <span class="FontName">yoda.createRelationshipTo(dagobah, LOCATION);</span><br class="calibre10"/>        <span class="FontName">luke.createRelationshipTo(tatooine, LOCATION);</span><br class="calibre10"/>        <span class="FontName">luke.createRelationshipTo(han, FRIENDS_WITH);</span><br class="calibre10"/>        <span class="FontName">luke.createRelationshipTo(leia, FRIENDS_WITH);</span><br class="calibre10"/>        <span class="FontName">leia.createRelationshipTo(han, FRIENDS_WITH);</span><br class="calibre10"/>        <span class="FontName">leia.createRelationshipTo(alderaan, LOCATION);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">tx1.success();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ExecutionEngine engine = new ExecutionEngine(db);</span><br class="calibre10"/>        <span class="FontName">ExecutionResult result = engine.execute("MATCH (n) RETURN n.name as name");</span><br class="calibre10"/>        <span class="FontName">String rows = "";</span><br class="calibre10"/>        <span class="FontName">for ( Map&lt;String, Object&gt; row : result ) {</span><br class="calibre10"/>            <span class="FontName">for ( Map.Entry&lt;String, Object&gt; column : row.entrySet() ) {</span><br class="calibre10"/>                <span class="FontName">rows += column.getKey() + ": " + column.getValue() + "; ";</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>            <span class="FontName">rows += "\n";</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">System.out.println(rows);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The code reflects a tiny part of the StarWars universe. It has characters and their locations which are actually planets. There are also relations between people (see <a id="_Fig6" href="part0023.html#Fig6" class="calibre5">Figure 13-6</a> for the relationship diagram).</p>
<div class="Figure" id="Fig6">
<p class="img1"><img src="../images/00080.jpeg" alt="9781430259084_Fig13-06.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0023.html#_Fig6" class="calibre5">Figure 13-6</a>.</span> Relationships in sample</p></div>
<p class="indent">The relationships in the code are enabled by using an enum that implements a Neo4j interface <span class="FontName">RelationshipType</span><a id="cXXX.992" class="calibre5"></a>. This is, as the name suggests, needed to differentiate between the different types of relationships. The type of node is differentiated by putting a <span class="FontName">Label</span> on the <span class="FontName">Node</span>. The <span class="FontName">name</span> is set as a basic property on the node.</p>
<p class="indent">When running the code it will execute the cypher query <span class="FontName">MATCH (n) RETURN</span><a id="cXXX.993" class="calibre5"></a> <span class="FontName">n.name as name</span>. This selects all nodes and returns the name property of all the nodes.</p>
<p id="Sec31" class="Heading2">Mapping objects with Neo4j</p>
<p class="noindent">The code until now is quite low level and bound to Neo4j. Creating and manipulating Nodes is cumbersome. Ideally one would use a <span class="FontName">Planet</span> and <span class="FontName">Character</span> class<a id="cXXX.994" class="calibre5"></a> and have that stored/retrieved from Neo4j.</p>
<p class="indent">First create the <span class="FontName">Planet</span> and <span class="FontName">Character</span> classes.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Planet {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private long id = -1;</span><br class="calibre10"/>    <span class="FontName">private String name;</span><br class="calibre10"/>    <span class="FontName">// Getters and Setters omitted</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.ArrayList;</span><br class="calibre10"/><span class="FontName">import java.util.Collections;</span><br class="calibre10"/><span class="FontName">import java.util.List;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Character {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private long id = -1;</span><br class="calibre10"/>    <span class="FontName">private String name;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private Planet location;</span><br class="calibre10"/>    <span class="FontName">private final List&lt;Character&gt; friends = new ArrayList&lt;&gt;();</span><br class="calibre10"/>    <span class="FontName">private Character apprentice;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void addFriend(Character friend) {</span><br class="calibre10"/>        <span class="FontName">friends.add(friend);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Getters and Setters omitted</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">Planet</span> class is quite straightforward. It has an <span class="FontName">id</span> and <span class="FontName">name</span> property. The <span class="FontName">Character</span> class is a bit more complicated. It also has the <span class="FontName">id</span> and <span class="FontName">name</span> properties along with some additional properties for the relationships. There is the location for the <span class="FontName">LOCATION</span> relationship<a id="cXXX.995" class="calibre5"></a>, a collection of Characters for the <span class="FontName">FRIENDS_WITH</span> relationship and also an apprentice for the <span class="FontName">MASTER_OF</span> relationship.</p>
<p class="indent">To be able to store these classes let’s create a <span class="FontName">StarwarsRepositor</span><a id="cXXX.996" class="calibre5"></a><span class="FontName">y</span> interface to hold the save operations.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface StarwarsRepository {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">Planet save(Planet planet);</span><br class="calibre10"/>    <span class="FontName">Character save(Character character);</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">And the implementation for Neo4j.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.*;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import static com.apress.springrecipes.nosql.RelationshipTypes.*;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Neo4jStarwarsRepository implements StarwarsRepository {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private final GraphDatabaseService db;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Neo4jStarwarsRepository(GraphDatabaseService db) {</span><br class="calibre10"/>        <span class="FontName">this.db = db;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public Planet save(Planet planet) {</span><br class="calibre10"/>        <span class="FontName">if (planet.getId() &gt; -1) {</span><br class="calibre10"/>            <span class="FontName">return planet;</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">Transaction tx = db.beginTx();</span><br class="calibre10"/>        <span class="FontName">Label label =  DynamicLabel.label("planet");</span><br class="calibre10"/>        <span class="FontName">Node node = db.createNode(label);</span><br class="calibre10"/>        <span class="FontName">node.setProperty("name", planet.getName());</span><br class="calibre10"/>        <span class="FontName">tx.success();</span><br class="calibre10"/>        <span class="FontName">planet.setId(node.getId());</span><br class="calibre10"/>        <span class="FontName">return planet;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public Character save(Character character) {</span><br class="calibre10"/>        <span class="FontName">if (character.getId() &gt; -1) {</span><br class="calibre10"/>            <span class="FontName">return character;</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">Transaction tx = db.beginTx();</span><br class="calibre10"/>        <span class="FontName">Label label =  DynamicLabel.label("character");</span><br class="calibre10"/>        <span class="FontName">Node node = db.createNode(label);</span><br class="calibre10"/>        <span class="FontName">node.setProperty("name", character.getName());</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">if (character.getLocation() != null) {</span><br class="calibre10"/>            <span class="FontName">Planet planet = character.getLocation();</span><br class="calibre10"/>            <span class="FontName">planet = save(planet);</span><br class="calibre10"/>            <span class="FontName">node.createRelationshipTo(db.getNodeById(planet.getId()), LOCATION);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">for (Character friend : character.getFriends()) {</span><br class="calibre10"/>            <span class="FontName">friend = save(friend);</span><br class="calibre10"/>            <span class="FontName">node.createRelationshipTo(db.getNodeById(friend.getId()), FRIENDS_WITH);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">if (character.getApprentice() != null) {</span><br class="calibre10"/>            <span class="FontName">save(character.getApprentice());</span><br class="calibre10"/>            <span class="FontName">node.createRelationshipTo(db.getNodeById(character.getApprentice().getId()), MASTER_OF);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">tx.success();</span><br class="calibre10"/>        <span class="FontName">character.setId(node.getId());</span><br class="calibre10"/>        <span class="FontName">return character;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">There is a whole lot going on here to convert the objects into a Node object. For the <span class="FontName">Planet</span> it is pretty easy, first check if it has already been persisted (the <span class="FontName">id</span> is &gt; -1 in that case); if not start a transaction, create a node, set the <span class="FontName">name</span> property, and transfer the <span class="FontName">id</span> to the <span class="FontName">Planet</span> object. However for the Character class it is a bit more complicated as all the relationships need to be taken into account.</p>
<p class="indent">The Main class needs to be modified to reflect the changes to the classes.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.neo4j.cypher.javacompat.ExecutionEngine;</span><br class="calibre10"/><span class="FontName">import org.neo4j.cypher.javacompat.ExecutionResult;</span><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.GraphDatabaseService;</span><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.factory.GraphDatabaseFactory;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.Map;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">final String DB_PATH = System.getProperty("user.home") + "/friends";</span><br class="calibre10"/>        <span class="FontName">final GraphDatabaseService db = new GraphDatabaseFactory().newEmbeddedDatabase(DB_PATH);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">StarwarsRepository repository = new Neo4jStarwarsRepository(db);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Planets</span><br class="calibre10"/>        <span class="FontName">Planet dagobah = new Planet();</span><br class="calibre10"/>        <span class="FontName">dagobah.setName("Dagobah");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Planet alderaan = new Planet();</span><br class="calibre10"/>        <span class="FontName">alderaan.setName("Alderaan");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Planet tatooine = new Planet();</span><br class="calibre10"/>        <span class="FontName">tatooine.setName("Tatooine");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">dagobah = repository.save(dagobah);</span><br class="calibre10"/>        <span class="FontName">repository.save(alderaan);</span><br class="calibre10"/>        <span class="FontName">repository.save(tatooine);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Characters</span><br class="calibre10"/>        <span class="FontName">Character han = new Character();</span><br class="calibre10"/>        <span class="FontName">han.setName("Han Solo");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Character leia = new Character();</span><br class="calibre10"/>        <span class="FontName">leia.setName("Leia Organa");</span><br class="calibre10"/>        <span class="FontName">leia.setLocation(alderaan);</span><br class="calibre10"/>        <span class="FontName">leia.addFriend(han);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Character luke = new Character();</span><br class="calibre10"/>        <span class="FontName">luke.setName("Luke Skywalker");</span><br class="calibre10"/>        <span class="FontName">luke.setLocation(tatooine);</span><br class="calibre10"/>        <span class="FontName">luke.addFriend(han);</span><br class="calibre10"/>        <span class="FontName">luke.addFriend(leia);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Character yoda = new Character();</span><br class="calibre10"/>        <span class="FontName">yoda.setName("Yoda");</span><br class="calibre10"/>        <span class="FontName">yoda.setLocation(dagobah);</span><br class="calibre10"/>        <span class="FontName">yoda.setApprentice(luke);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">repository.save(han);</span><br class="calibre10"/>        <span class="FontName">repository.save(luke);</span><br class="calibre10"/>        <span class="FontName">repository.save(leia);</span><br class="calibre10"/>        <span class="FontName">repository.save(yoda);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ExecutionEngine engine = new ExecutionEngine(db);</span><br class="calibre10"/>        <span class="FontName">ExecutionResult result = engine.execute("MATCH (n) RETURN n.name as name");</span><br class="calibre10"/>        <span class="FontName">String rows = "";</span><br class="calibre10"/>        <span class="FontName">for ( Map&lt;String, Object&gt; row : result ) {</span><br class="calibre10"/>            <span class="FontName">for ( Map.Entry&lt;String, Object&gt; column : row.entrySet() ) {</span><br class="calibre10"/>                <span class="FontName">rows += column.getKey() + ": " + column.getValue() + "; ";</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>            <span class="FontName">rows += "\n";</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">System.out.println(rows);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">When executing the result should still be the same as before. However the main difference is now that the code is using domain objects instead of working directly with nodes. Storing the objects as Nodes in Neo4j is quite cumbersome. Luckily Spring Boot Neo4j can help to make it a lot easier.</p>
<p id="Sec32" class="Heading2">Mapping<a id="cXXX.997" class="calibre6"></a> Objects Using Spring Data Neo4j</p>
<p class="noindent">In the conversion to nodes and relationships, properties can be quite cumbersome. Wouldn’t it be nice if one could simply specify what to store where using annotations just as is done using JPA? Spring Data Neo4j offers those annotations. To make an object a Neo4j mapped entity use the <span class="FontName">@</span> <span class="FontName">NodeEntity</span> annotation<a id="cXXX.998" class="calibre5"></a> on the type. Relationships can be modeled with the <span class="FontName">@RelatedTo</span> annotation. To identify the field used for the id add the <span class="FontName">@GraphId</span> annotation. Applying these to the <span class="FontName">Planet</span> and <span class="FontName">Character</span><a id="cXXX.999" class="calibre5"></a> class would make them look like the following.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.annotation.GraphId;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.annotation.NodeEntity;</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">@NodeEntity</b><br class="calibre10"/><span class="FontName">public class Planet {</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@GraphId</b><br class="calibre10"/>    <span class="FontName">private Long id;</span><br class="calibre10"/>    <span class="FontName">private String name;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public long getId() {</span><br class="calibre10"/>        <span class="FontName">return id;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setId(long id) {</span><br class="calibre10"/>        <span class="FontName">this.id = id;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public String getName() {</span><br class="calibre10"/>        <span class="FontName">return name;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setName(String name) {</span><br class="calibre10"/>        <span class="FontName">this.name = name;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">And the <span class="FontName">Character</span> class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.annotation.GraphId;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.annotation.NodeEntity;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.annotation.RelatedTo;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.*;</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">@NodeEntity</b><br class="calibre10"/><span class="FontName">public class Character {</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@GraphId</b><br class="calibre10"/>    <span class="FontName">private Long id;</span><br class="calibre10"/>    <span class="FontName">private String name;</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@RelatedTo(type="LOCATION")</b><br class="calibre10"/>    <span class="FontName">private Planet location;</span><br class="calibre10"/>    <b class="calibre4">@RelatedTo(type="FRIENDS_WITH")</b><br class="calibre10"/>    <span class="FontName">private final Set&lt;Character&gt; friends = new HashSet&lt;&gt;();</span><br class="calibre10"/>    <b class="calibre4">@RelatedTo(type="MASTER_OF")</b><br class="calibre10"/>    <span class="FontName">private Character</span> <span class="FontName">apprentice</span><span class="FontName">;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public long getId() {</span><br class="calibre10"/>        <span class="FontName">return id;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setId(long id) {</span><br class="calibre10"/>        <span class="FontName">this.id = id;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public String getName() {</span><br class="calibre10"/>        <span class="FontName">return name;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setName(String name) {</span><br class="calibre10"/>        <span class="FontName">this.name = name;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Planet getLocation() {</span><br class="calibre10"/>        <span class="FontName">return location;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setLocation(Planet location) {</span><br class="calibre10"/>        <span class="FontName">this.location = location;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Character getApprentice() {</span><br class="calibre10"/>        <span class="FontName">return apprentice;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setApprentice(Character apprentice) {</span><br class="calibre10"/>        <span class="FontName">this.apprentice = apprentice;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Set&lt;Character&gt; getFriends() {</span><br class="calibre10"/>        <span class="FontName">return Collections.unmodifiableSet(friends);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void addFriend(Character friend) {</span><br class="calibre10"/>        <span class="FontName">friends.add(friend);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now that the entities are annotated the repository<a id="cXXX.1000" class="calibre5"></a> can be rewritten to use a <span class="FontName">Neo4jTemplate</span> for easier access.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.annotation.Autowired;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.conversion.Result;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.support.Neo4jTemplate;</span><br class="calibre10"/><span class="FontName">import org.springframework.stereotype.Repository;</span><br class="calibre10"/><span class="FontName">import org.springframework.transaction.annotation.Transactional;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.annotation.PreDestroy;</span><br class="calibre10"/><span class="FontName">import java.util.Map;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Repository</span><br class="calibre10"/><b class="calibre4">@Transactional</b><br class="calibre10"/><span class="FontName">public class Neo4jStarwarsRepository implements StarwarsRepository {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private final Neo4jTemplate template;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public Neo4jStarwarsRepository(</span><b class="calibre4">Neo4jTemplate template</b><span class="FontName">) {</span><br class="calibre10"/>        <span class="FontName">this.template = template;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public Planet save(Planet planet) {</span><br class="calibre10"/>        <b class="calibre4">template.save(planet);</b><br class="calibre10"/>        <span class="FontName">return planet;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public Character save(Character character) {</span><br class="calibre10"/>        <b class="calibre4">template.save(character);</b><br class="calibre10"/>        <span class="FontName">return character;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void printAll() {</span><br class="calibre10"/>        <span class="FontName">Result&lt;Map&lt;String, Object&gt;&gt; result;result=template.queryEngineFor().query("MATCH (n) RETURN n.name as name", null);</span><br class="calibre10"/>        <span class="FontName">String rows = "";</span><br class="calibre10"/>        <span class="FontName">for ( Map&lt;String, Object&gt; row : result ) {</span><br class="calibre10"/>            <span class="FontName">for ( Map.Entry&lt;String, Object&gt; column : row.entrySet() ) {</span><br class="calibre10"/>                <span class="FontName">rows += column.getKey() + ": " + column.getValue() + "; ";</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>            <span class="FontName">rows += "\n";</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">System.out.println(rows);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@PreDestroy</span><br class="calibre10"/>    <span class="FontName">public void cleanUp() {</span><br class="calibre10"/>        <span class="FontName">// Clean up when shutdown</span><br class="calibre10"/>        <span class="FontName">template.query("MATCH (n) OPTIONAL MATCH (n)-[r]-() DELETE n,r", null);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">There are a couple of things to notice: the code is a lot cleaner when using the <span class="FontName">Neo4jTemplate</span><a id="cXXX.1001" class="calibre5"></a> as a lot of the plumping is done for you, especially mapping from and to <span class="FontName">Node</span>s. The repository is now also annotated with <span class="FontName">@Transactional</span>. To operate on Neo4j we need a transaction and it is the easiest to let Spring manage those. The final thing to note is the addition of the printAll method. A transaction is required to query related objects (there is some lazy loading going on) and the repository is already transactional.</p>
<p class="indent">Finally the cleanUp method<a id="cXXX.1002" class="calibre5"></a> has been added to make sure that the repository cleans up the datastore when we shutdown. This is probably not something you want to use in production but for our small recipe it makes sense.</p>
<p class="indent">The next class to modify is the configuration class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.GraphDatabaseService;</span><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.factory.GraphDatabaseFactory;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.ComponentScan;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.config.Neo4jConfiguration;</span><br class="calibre10"/><span class="FontName">import org.springframework.transaction.annotation.EnableTransactionManagement;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.annotation.PostConstruct;</span><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableTransactionManagement</span><br class="calibre10"/><span class="FontName">@ComponentScan(basePackages = {"com.apress.springrecipes.nosql"})</span><br class="calibre10"/><span class="FontName">public class StarwarsConfig</span> <b class="calibre4">extends Neo4jConfiguration</b> <span class="FontName">{</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@PostConstruct</b><br class="calibre10"/>    <b class="calibre4">public void init() {</b><br class="calibre10"/>        <b class="calibre4">setBasePackage("com.apress.springrecipes.nosql");</b><br class="calibre10"/>    <b class="calibre4">}</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean(destroyMethod = "shutdown")</span><br class="calibre10"/>    <span class="FontName">public GraphDatabaseService graphDatabaseService() {</span><br class="calibre10"/>        <span class="FontName">final String DB_PATH = System.getProperty("user.home") + "/starwars";</span><br class="calibre10"/>        <span class="FontName">return new GraphDatabaseFactory().newEmbeddedDatabase(DB_PATH);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The configuration class now extends the <span class="FontName">Neo4jConfiguration</span> class<a id="cXXX.1003" class="calibre5"></a>. This class sets up the <span class="FontName">Neo4jTemplate</span> and a lot of other infrastructure classes like a transactionmanager. The Neo4jConfiguration also need to know in which packages the <span class="FontName">@NodeEntity</span> annotated classes are kept. This can be done in a <span class="FontName">@PostConstruct</span> annotated method.</p>
<p class="indent">Finally the main class needs to be modified to load this configuration class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.nosql.config.StarwarsConfig;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.transaction.PlatformTransactionManager;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class</span> <span class="FontName">Main</span> <span class="FontName">{</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <b class="calibre4">AnnotationConfigApplicationContext context =</b><br class="calibre10"/>               <b class="calibre4">new AnnotationConfigApplicationContext(StarwarsConfig.class);</b><br class="calibre10"/>        <b class="calibre4">StarwarsRepository repository = context.getBean(StarwarsRepository.class);</b><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Planet dagobah = new Planet();</span><br class="calibre10"/>        <span class="FontName">dagobah.setName("Dagobah");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Planet alderaan = new Planet();</span><br class="calibre10"/>        <span class="FontName">alderaan.setName("Alderaan");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Planet tatooine = new Planet();</span><br class="calibre10"/>        <span class="FontName">tatooine.setName("Tatooine");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">dagobah = repository.save(dagobah);</span><br class="calibre10"/>        <span class="FontName">repository.save(alderaan);</span><br class="calibre10"/>        <span class="FontName">repository.save(tatooine);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Character han = new Character();</span><br class="calibre10"/>        <span class="FontName">han.setName("Han Solo");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Character leia = new Character();</span><br class="calibre10"/>        <span class="FontName">leia.setName("Leia Organa");</span><br class="calibre10"/>        <span class="FontName">leia.setLocation(alderaan);</span><br class="calibre10"/>        <span class="FontName">leia.addFriend(han);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Character luke = new Character();</span><br class="calibre10"/>        <span class="FontName">luke.setName("Luke Skywalker");</span><br class="calibre10"/>        <span class="FontName">luke.setLocation(tatooine);</span><br class="calibre10"/>        <span class="FontName">luke.addFriend(han);</span><br class="calibre10"/>        <span class="FontName">luke.addFriend(leia);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Character yoda = new Character();</span><br class="calibre10"/>        <span class="FontName">yoda.setName("Yoda");</span><br class="calibre10"/>        <span class="FontName">yoda.setLocation(dagobah);</span><br class="calibre10"/>        <span class="FontName">yoda.setApprentice(luke);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">repository.save(han);</span><br class="calibre10"/>        <span class="FontName">repository.save(luke);</span><br class="calibre10"/>        <span class="FontName">repository.save(leia);</span><br class="calibre10"/>        <span class="FontName">repository.save(yoda);</span><br class="calibre10"/><br class="calibre10"/>        <b class="calibre4">repository.printAll();</b><br class="calibre10"/><br class="calibre10"/>        <b class="calibre4">context.close();</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">An <span class="FontName">AnnotionConfigApplicationContext</span><a id="cXXX.1004" class="calibre5"></a> is used to parse the <span class="FontName">StarwarsConfig</span> class. This will bootstrap the application and construct all beans necessary. Next the data is being setup and the <span class="FontName">printAll</span> method is called. The code that was there initially is now in that method. The end result should still be similar to what you got until now.</p>
<p class="indent">The call to <span class="FontName">context.close()</span> will make sure the <span class="FontName">@PreDestroy</span> method is being invoked.</p>
<p id="Sec33" class="Heading2">Using Spring Data Neo4j Repositories</p>
<p class="noindent">The code has been simplified considerably. The usage of the Neo4jTemplate made it a lot easier to work with entities together with Neo4j. It can be even easier. As with the JPA or Mongo version of Spring Data it can generate repositories for you. The only thing you need to do is write an interface. Let’s create a <span class="FontName">PlanetRepository</span> and <span class="FontName">CharacterRepository</span> to operate on the entities.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.repository.GraphRepository;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface CharacterRepository extends GraphRepository&lt;Character&gt; {}</span></pre>
<p class="indent">And the <span class="FontName">PlanetRepository</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.repository.GraphRepository;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface PlanetRepository extends GraphRepository&lt;Planet&gt; {}</span></pre>
<p class="indent">The thing to notice here is that the repositories are interfaces that extend <span class="FontName">GraphRepository</span>. This is a special interface which, eventually, also extends the Spring Data <span class="FontName">CrudRepository</span><a id="cXXX.1005" class="calibre5"></a>. This allows for automatic creation of repositories. The GraphRepository also extends <span class="FontName">IndexRepository</span>, <span class="FontName">SchemaIndexRepository,</span> and <span class="FontName">TraversalRepository</span> which are especially useful to search on indexed properties or by traversing relationships. Instead of extending <span class="FontName">GraphRepository</span><a id="cXXX.1006" class="calibre5"></a> you can extend the less extensive <span class="FontName">CRUDRepository</span>.</p>
<p class="indent">The extended interface takes a type parameter. The type is the type of entity that is supported by this repository.</p>
<p class="indent">Next rename the <span class="FontName">StarwarsRepository</span> and its implementation, to <span class="FontName">StarwarsService</span> as it isn’t really a repository anymore, the implementation also needs to change to operate on the repositories instead of the <span class="FontName">Neo4jTemplate<a id="cXXX.2125" class="calibre5"></a></span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.annotation.Autowired;</span><br class="calibre10"/><span class="FontName">import org.springframework.stereotype.Repository;</span><br class="calibre10"/><span class="FontName">import org.springframework.stereotype.Service;</span><br class="calibre10"/><span class="FontName">import org.springframework.transaction.annotation.Transactional;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.annotation.PreDestroy;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Service</span><br class="calibre10"/><span class="FontName">@Transactional</span><br class="calibre10"/><span class="FontName">public class Neo4jStarwarsService implements StarwarsService {</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">private final PlanetRepository planetRepository;</b><br class="calibre10"/>    <b class="calibre4">private final CharacterRepository characterRepository;</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <b class="calibre4">public Neo4jStarwarsService(PlanetRepository planetRepository,</b><br class="calibre10"/>                                <b class="calibre4">CharacterRepository characterRepository) {</b><br class="calibre10"/>        <span class="FontName">this.planetRepository=planetRepository;</span><br class="calibre10"/>        <span class="FontName">this.characterRepository=characterRepository;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public Planet save(Planet planet) {</span><br class="calibre10"/>        <span class="FontName">return planetRepository.save(planet);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public Character save(Character character) {</span><br class="calibre10"/>        <span class="FontName">return characterRepository.save(character);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void printAll() {</span><br class="calibre10"/>        <span class="FontName">Result&lt;Planet&gt; planets = planetRepository.findAll();</span><br class="calibre10"/>        <span class="FontName">Result&lt;Character&gt; characters = characterRepository.findAll();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">for (Planet p : planets) {</span><br class="calibre10"/>            <span class="FontName">System.out.println(p);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">for (Character c : characters) {</span><br class="calibre10"/>            <span class="FontName">System.out.println(c);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@PreDestroy</span><br class="calibre10"/>    <span class="FontName">public void cleanUp() {</span><br class="calibre10"/>        <span class="FontName">// Clean up when shutdown</span><br class="calibre10"/>        <span class="FontName">characterRepository.deleteAll();</span><br class="calibre10"/>        <span class="FontName">planetRepository.deleteAll();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now all operations are done on the specific repository interfaces<a id="cXXX.1007" class="calibre5"></a>. Those interfaces don’t create instances themselves. To enable the creation the <i class="calibre8">@EnableNeo4jRepositories</i> annotations needs to be added to the configuration class.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableTransactionManagement</span><br class="calibre10"/><b class="calibre4">@EnableNeo4jRepositories(basePackages = {"com.apress.springrecipes.nosql"})</b><br class="calibre10"/><span class="FontName">@ComponentScan(basePackages = {"com.apress.springrecipes.nosql"})</span><br class="calibre10"/><span class="FontName">public class StarwarsConfig extends Neo4jConfiguration { ... }</span></pre>
<p class="indent">Notice the <span class="FontName">@EnableNeo4jRepositories</span> annotation. This annotation will scan the configured base-packages for repositories. When one is found a dynamic implementation is created, this implementation eventually delegates to the <span class="FontName">Neo4jTemplate</span>.</p>
<p class="indent">Finally modify the Main class to use the refactored <span class="FontName">StarwarsService</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.nosql.config.StarwarsConfig;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">AnnotationConfigApplicationContext context =</span><br class="calibre10"/>                <span class="FontName">new AnnotationConfigApplicationContext(StarwarsConfig.class);</span><br class="calibre10"/><br class="calibre10"/>        <b class="calibre4">StarwarsService service = context.getBean(StarwarsService.class);</b><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now all the components have been changed to use the dynamically created Spring Data Neo4j repositories.</p>
<p id="Sec34" class="Heading2">Connecting to a Remote Neo4j Database<a id="cXXX.1008" class="calibre6"></a></p>
<p class="noindent">Until now all the coding for Neo4j has been done to an embedded Neo4j instance, however at the beginning you downloaded and installed Neo4j. Neo4j has a REST interface for remote connections. To easily connect to a remote repository Spring Data has the <span class="FontName">spring-data-neo4j-rest</span> module.</p>
<p class="indent">After adding this dependency it is just a matter of reconfiguring the embedded repository for a remote one. The remainder of the code can be left unchanged.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.nosql.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.neo4j.graphdb.GraphDatabaseService;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.ComponentScan;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.config.EnableNeo4jRepositories;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.config.Neo4jConfiguration;</span><br class="calibre10"/><span class="FontName">import org.springframework.data.neo4j.rest.SpringRestGraphDatabase;</span><br class="calibre10"/><span class="FontName">import org.springframework.transaction.annotation.EnableTransactionManagement;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.annotation.PostConstruct;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableTransactionManagement</span><br class="calibre10"/><span class="FontName">@EnableNeo4jRepositories(basePackages = {"com.apress.springrecipes.nosql"})</span><br class="calibre10"/><span class="FontName">@ComponentScan(basePackages = {"com.apress.springrecipes.nosql"})</span><br class="calibre10"/><span class="FontName">public class StarwarsConfig extends Neo4jConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@PostConstruct</span><br class="calibre10"/>    <span class="FontName">public void init() {</span><br class="calibre10"/>        <span class="FontName">setBasePackage("com.apress.springrecipes.nosql");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean(destroyMethod = "shutdown")</span><br class="calibre10"/>    <span class="FontName">public GraphDatabaseService graphDatabaseService() {</span><br class="calibre10"/>        <b class="calibre4">return new SpringRestGraphDatabase("</b><b class="calibre4">http://localhost:7474/db/data</b><b class="calibre4">");</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The SpringRestGraphDatabase will connect to the Neo4j instance which by default is on port 7474 on localhost. Underneath it will construct an instance of the <span class="FontName">RestAPIFacade</span> class. If more elaborate configuration is needed, like SSL or a username and password, an explicit configured <span class="FontName">RestAPIFacade</span> could also be injected instead.</p>
<p id="Sec35" class="Heading">Summary</p>
<p class="noindent">In this recipe you took an introductory journey into different types of datastores, including how to use them and how to make using them easier with different modules of the Spring Data family.</p>
<p class="indent">You started out by taking a look at document-driven stores in the form of MongoDB and the usage of the Spring Data MongoDB module. Next the journey took you to key-value stores for which Redis<a id="cXXX.2144" class="calibre5"></a> was used as an implementation and the usage of the Spring Data Redis module.</p>
<p class="indent">Then for Big Data<a id="cXXX.2015" class="calibre5"></a><a id="cXXX.2051" class="calibre5"></a> you looked at how to do a basic processing job with plain Hadoop and how to do it with Spring Data Hadoop. As an intermezzo you also learned how to setup a single node cluster.</p>
<p class="indent">The final datastore was a graph based one. In this case Neo4j, for which you explored the embedded neo4j, how to use it, and build a repository for storing entities.</p>
<p class="FootLine">__________________________</p>
<p class="FootNote"><a id="Fn1" href="part0023.html#_Fn1" class="calibre5"><sup class="calibre18">1</sup></a><span class="FontName"><a href="http://hadoop.apache.org/docs/r2.5.1/hadoop-project-dist/hadoop-common/SingleCluster.html#Pseudo-Distributed_Operation" class="calibre5">http://hadoop.apache.org/docs/r2.5.1/hadoop-project-dist/hadoop-common/SingleCluster.html#Pseudo-Distributed_Operation</a></span>.</p></div>
</body></html>
