<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Chapter 6 Spring Social</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre"><p class="ChapterNumber"><a id="b9781430259084_6" class="calibre6"></a>CHAPTER 6</p>
<p class="Chapimage"><img src="../images/00008.jpeg" alt="image" class="calibre3"/></p>
<p class="ChapterTitle">Spring Social</p>
<div class="calibre10"><p class="noindent">Social networking<a id="cXXX.2190" class="calibre5"></a><a id="cXXX.495" class="calibre5"></a> is everywhere and most Internet users have one or more social networking accounts. People tweet to share what they are doing or how they feel about a subject; they share pictures on Facebook and Instagram, and write blogs using Tumblr. More and more social networks are appearing every day.</p>
<p class="indent">As the owner of a website it can be beneficial to add integration with those social networks, allowing users to easily post links or to filter and show how people think.</p>
<p class="indent">Spring Social tries to have a unified API to connect to those different networks and an extension model. Spring Social itself provides integration for Facebook, Twitter<a id="cXXX.2228" class="calibre5"></a>, and LinkedIn; however, there are a lot of community projects providing support for different social networks (like Tumblr, Weibo, and Instagram to name a few).</p>
<p class="indent">Spring Social can be split into three parts. First there is the Connect Framework, which handles the authentication and connection flow with the underlying social network. Next, is the <span class="FontName">ConnectController</span> is the controller doing the OAuth exchange between the service provider, the consumer (the application), and the user of the application. Finally there is the <span class="FontName">SocialAuthenticationFilter</span> which integrates Spring Social with Spring Security (see <a href="part0018.html" class="calibre5">Chapter 8</a>) to allow users to sign in with their social network account.</p>
<p id="Sec1" class="Heading">6-1. Setting Up Spring Social</p>
<p id="Sec2" class="Heading1">Problem</p>
<p class="noindent">You want to use Spring Social in your application.</p>
<p id="Sec3" class="Heading1">Solution</p>
<p class="noindent">Add Spring Social to your dependencies and enable Spring Social in your configuration.</p>
<p id="Sec4" class="Heading1">How It Works</p>
<p class="noindent">Spring Social consists of several modules apart from all the different modules for each service provider (like Twitter, Facebook, GitHub, etc.). To be able to use Spring Social you will need to add those to your application’s dependencies. <a id="_Tab1" href="part0016.html#Tab1" class="calibre5">Table 6-1</a> shows the available modules.</p>
<div class="Table" id="Tab1">
<p class="TabCapt"><span class="calibre4"><a href="part0016.html#_Tab1" class="calibre5">Table 6-1</a>.</span> Overview of Spring Social <a id="cXXX.2222" class="calibre5"></a>Modules<a id="cXXX.496" class="calibre5"></a></p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14">
<p class="tab-left">Module</p></th><th valign="top" class="calibre14">
<p class="tab-left">Description</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">spring-social-core</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Core module of Spring Social, contains the main and shared infrastructure classes.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">spring-social-config</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Spring Social configuration module, makes it easier to configure (parts) of Spring Social</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">spring-social-web</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Web integration for Spring Social contains filters and controllers for easy use.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">spring-social-security</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Integration with Spring Security (see <a href="part0018.html" class="calibre5">chapter 8</a>).</p></td></tr></tbody></table>
</div>
<p class="indent">To dependencies are in the group org.springframework.social, this chapter will cover every module (core, config, web, and security) in different recipes. This section will cover the basic setup of Spring Social. At the moment of writing 1.1.0.RELEASE was the latest version of Spring Social available. Add the following dependencies (when using maven).</p>
<pre class="calibre11"><span class="FontName">&lt;</span><span class="FontName">dependency</span><a id="cXXX.497" class="calibre5"></a><span class="FontName">&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;groupId&gt;org.springframework.social&lt;/groupId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;artifactId&gt;spring-social-core&lt;/artifiactId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;version&gt;1.1.0.RELEASE&lt;/version&gt;</span><br class="calibre10"/><span class="FontName">&lt;/dependency&gt;</span><br class="calibre10"/><span class="FontName">&lt;dependency&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;groupId&gt;org.springframework.social&lt;/groupId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;artifactId&gt;spring-social-config&lt;/artificatId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;version&gt;1.1.0.RELEASE&lt;/version&gt;</span><br class="calibre10"/><span class="FontName">&lt;/dependency&gt;</span></pre>
<p class="indent">With the dependencies added Spring Social can now be setup.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.social.StaticUserIdSource;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.*;</span><br class="calibre10"/><span class="FontName">import org.springframework.core.env.Environment;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.config.annotation.EnableSocial;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.config.annotation.SocialConfigurerAdapter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><b class="calibre4">@EnableSocial</b><br class="calibre10"/><span class="FontName">@PropertySource("classpath:/application.properties")</span><br class="calibre10"/><span class="FontName">public class SocialConfig</span> <b class="calibre4">extends SocialConfigurerAdapter</b> <span class="FontName">{</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public StaticUserIdSource getUserIdSource() {</span><br class="calibre10"/>        <span class="FontName">return new StaticUserIdSource();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">To enable Spring Social simply add the <span class="FontName">@EnableSocial</span> annotation to a <span class="FontName">@Configuration</span> annotated class. This annotation will trigger loading of the configuration of Spring Social. It will detect any instance of <span class="FontName">SocialConfigurer</span> beans, these beans are used for further configuration of Spring Social. Those are used to add the configuration for 1 or more service providers.</p>
<p class="indent">The SocialConfig extends <span class="FontName">SocialConfigurerAdapter</span> which is an implementation of a <span class="FontName">SocialConfigurer</span>, as you can see there is an overridden method <span class="FontName">getUserIdSource</span> which returns a <span class="FontName">StaticUserIdSource</span>. Spring Social requires an instance of a <span class="FontName">UserIdSource</span> to determine the current user. This user is used to lookup any connections with service providers. These connections are stored in a, per user, <span class="FontName">ConnectionRepository</span>. The <span class="FontName">ConnectionRepository</span> to use is determined by the <span class="FontName">UsersConnectionRepository</span>, which uses the current user for that. The default configured <span class="FontName">UsersConnectionRepository</span> is the <span class="FontName">InMemoryUsersConnectionRepository</span>.</p>
<p class="indent">Finally you are going to load a properties file from the classpath, this properties file contains the api keys for your application to use for service providers. Instead of putting them in a properties file you could also hardcode them into your code.</p>
<p class="indent">For the time being you are going to use the <span class="FontName">StaticUserIdSource</span><a id="cXXX.498" class="calibre5"></a> to determine the current user.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.social.UserIdSource;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class StaticUserIdSource implements UserIdSource {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private static final String DEFAULT_USERID = "anonymous";</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String userId = DEFAULT_USERID;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public String getUserId() {</span><br class="calibre10"/>        <span class="FontName">return this.userId;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setUserId(String userId) {</span><br class="calibre10"/>        <span class="FontName">this.userId = userId;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">StaticUserIdSource</span> implements <span class="FontName">UserIdSource</span> and returns a preset userId, although this works for now but in a real application you want to be able to store the connection information on a per user basis.</p>
<p id="Sec5" class="Heading">6-2. Connecting to Twitter<a id="cXXX.499" class="calibre6"></a></p>
<p id="Sec6" class="Heading1">Problem</p>
<p class="noindent">You want your application to have access to Twitter.</p>
<p id="Sec7" class="Heading1">Solution</p>
<p class="noindent">Register your application with Twitter and configure Spring Social to make use of the application credentials to get access to Twitter.</p>
<p id="Sec8" class="Heading1">How It Works</p>
<p class="noindent">Before you can have your application use Twitter you need to register your application with Twitter. After this registration you will have credentials (API key and API secret) to identify your application.</p>
<p id="Sec9" class="Heading2">Register an Application<a id="cXXX.500" class="calibre6"></a> on Twitter</p>
<p class="noindent">To register an application with Twitter go to <span class="FontName"><a href="https://dev.twitter.com" class="calibre5">https://dev.twitter.com</a></span> and look in the right-hand top corner for your avatar, now from the dropdown menu select <span class="FontName">My applications</span> (see <a id="_Fig1" href="part0016.html#Fig1" class="calibre5">Figure 6-1</a>).</p>
<div class="Figure" id="Fig1">
<p class="img1"><img src="../images/00054.jpeg" alt="9781430259084_Fig06-01.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0016.html#_Fig1" class="calibre5">Figure 6-1</a>.</span> Selecting my applications on twitter</p></div>
<p class="indent">After selection My Applications the Application Management page will appear. On this page is a button which allows you to create new apps (see <a id="_Fig2" href="part0016.html#Fig2" class="calibre5">Figure 6-2</a>).</p>
<div class="Figure" id="Fig2">
<p class="img1"><img src="../images/00055.jpeg" alt="9781430259084_Fig06-02.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0016.html#_Fig2" class="calibre5">Figure 6-2</a>.</span> Application Management Page</p></div>
<p class="indent">On this page, press the button to open the screen (see <a id="_Fig3" href="part0016.html#Fig3" class="calibre5">Figure 6-3</a>) to register your application.</p>
<div class="Figure" id="Fig3">
<p class="img1"><img src="../images/00056.jpeg" alt="9781430259084_Fig06-03.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0016.html#_Fig3" class="calibre5">Figure 6-3</a>.</span> Register a new application</p></div>
<p class="indent">Now in this screen you must enter a name and description of your application and it also requires a URL of the website on which this application is going to be used. When using Spring Social it is also important that you fill-out the callback url field as we need callbacks, the actual value doesn’t really matter (unless you use a very old version of OAuth).</p>
<p class="indent">After accepting the terms and conditions and pressing the final create button you will be taken to your application settings page and you successfully created your application.</p>
<p class="indent">To be able to connect Spring Social to Twitter you need to know your API key and API secret, those can be found on the API Keys tab of your application settings (see <a id="_Fig4" href="part0016.html#Fig4" class="calibre5">Figures 6-4</a> and <a id="_Fig5" href="part0016.html#Fig5" class="calibre5">6-5</a>).</p>
<div class="Figure" id="Fig4">
<p class="img1"><img src="../images/00057.jpeg" alt="9781430259084_Fig06-04.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0016.html#_Fig4" class="calibre5">Figure 6-4</a>.</span> Application Settings page</p></div>
<div class="Figure" id="Fig5">
<p class="img1"><img src="../images/00058.jpeg" alt="9781430259084_Fig06-05.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0016.html#_Fig5" class="calibre5">Figure 6-5</a>.</span> API key and API secret needed to connect Spring Social</p></div>
<p id="Sec10" class="Heading2">Configure Spring Social<a id="cXXX.501" class="calibre6"></a> to Connect with Twitter</p>
<p class="noindent">Now that you have an API key and API secret you can configure Spring Social to connect to Twitter. First create a properties file (for instance <span class="FontName">application.properties</span>) to hold your API key and API secret so that we can easily retrieve it when we need it.</p>
<pre class="calibre11"><span class="FontName">twitter.appId=</span><b class="calibre4">&lt;your-twitter-API-key-here&gt;</b><br class="calibre10"/><span class="FontName">twitter.appSecret=</span><b class="calibre4">&lt;your-twitter-API-secret-here&gt;</b></pre>
<p class="indent">To connect to Twitter you need to add a <span class="FontName">TwitterConnectionFactory</span> which will use the application id and secret when requested to connect to Twitter.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.core.env.Environment;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.config.annotation.ConnectionFactoryConfigurer;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.connect.Connection;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.connect.ConnectionRepository;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.twitter.api.Twitter;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.twitter.connect.TwitterConnectionFactory;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableSocial</span><br class="calibre10"/><span class="FontName">@PropertySource("classpath:/application.properties")</span><br class="calibre10"/><span class="FontName">public class SocialConfig extends SocialConfigurerAdapter {</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@Configuration</span><br class="calibre10"/>    <span class="FontName">public static class</span> <b class="calibre4">TwitterConfigurer</b> <span class="FontName">extends SocialConfigurerAdapter {</span><br class="calibre10"/>        <span class="FontName">@Override</span><br class="calibre10"/>        <span class="FontName">public void addConnectionFactories(</span><br class="calibre10"/><span class="FontName">            ConnectionFactoryConfigurer connectionFactoryConfigurer,</span><br class="calibre10"/><span class="FontName">            Environment env) {</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">connectionFactoryConfigurer.addConnectionFactory(</span><br class="calibre10"/>                    <span class="FontName">new TwitterConnectionFactory(</span><br class="calibre10"/>                            <span class="FontName">env.getRequiredProperty("twitter.appId"),</span><br class="calibre10"/>                            <span class="FontName">env.getRequiredProperty("twitter.appSecret")));</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">@Bean</span><br class="calibre10"/>        <span class="FontName">@Scope(value = "request", proxyMode = ScopedProxyMode.INTERFACES)</span><br class="calibre10"/>        <span class="FontName">public Twitter twitterTemplate(ConnectionRepository connectionRepository) {</span><br class="calibre10"/>            <span class="FontName">Connection&lt;Twitter&gt; connection = connectionRepository.findPrimaryConnection(Twitter.class);</span><br class="calibre10"/>            <span class="FontName">return connection != null ? connection.getApi() : null;</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">SocialConfigurer</span> interface has the callback method <span class="FontName">addConnectionFactories</span> which allows you to add <span class="FontName">ConnectionFactory</span> instances to use to Spring Social. For Twitter there is the <span class="FontName">TwitterConnectionFactory</span> which takes two arguments, the first is the API key, the second is the API secret. Both constructor arguments come from the properties file that is read. Of course you could also hardcode the values into the configuration.</p>
<p class="indent">The connection to Twitter has been made, although you could use the raw underlying connection it isn’t really recommended to do so. Instead use the <span class="FontName">TwitterTemplate</span> which makes it easier to work with the Twitter API.</p>
<p class="indent">The configuration above adds a <span class="FontName">TwitterTemplate</span> to the application context. Notice the <span class="FontName">@Scope</span> annotation. It is important that this bean is request scoped. For each request the actual connection to Twitter might differ as potentially every request is for a different user. Hence the request scoped bean. The <span class="FontName">ConnectionRepository</span> that is injected into the method is determined based on the id of the current user, which is retrieved using the <span class="FontName">UserIdSource</span> you configured earlier.</p>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  Although the sample uses a separate configuration class to configure Twitter as a service provider you can also add it to the main <span class="FontName">SocialConfig</span> class. However it can be desirable to separate the global Spring Social configuration from the specific service provider setup.</p></div>
<p id="Sec11" class="Heading">6-3. Connecting to Facebook<a id="cXXX.2223" class="calibre6"></a><a id="cXXX.502" class="calibre6"></a></p>
<p id="Sec12" class="Heading1">Problem</p>
<p class="noindent">You want your application to have access to Facebook.</p>
<p id="Sec13" class="Heading1">Solution</p>
<p class="noindent">Register your application with Facebook and configure Spring Social to make use of the application credentials to get access to Facebook.</p>
<p id="Sec14" class="Heading1">How It Works</p>
<p class="noindent">Before you can have your application use Facebook you first need to register your application with Facebook. After this registration you will have credentials (API key and API secret) to identify your application. To be able to register an application on Facebook you have to have a Facebook account and have to be registered as a developer. (This recipe assumes you already have been registered as a developer with Facebook. If not go to <span class="FontName"><a href="http://developers.facebook.com" class="calibre5">http://developers.facebook.com</a></span> and click the Register Now button and fill out the wizard).</p>
<p id="Sec15" class="Heading2">Register an Application<a id="cXXX.503" class="calibre6"></a> on Facebook</p>
<p class="noindent">Start by going to <span class="FontName"><a href="http://developers.facebook.com" class="calibre5">http://developers.facebook.com</a></span> and click the Apps menu on top of the page and select Create a New App (see <a id="_Fig6" href="part0016.html#Fig6" class="calibre5">Figure 6-6</a>).</p>
<div class="Figure" id="Fig6">
<p class="img1"><img src="../images/00059.jpeg" alt="9781430259084_Fig06-06.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0016.html#_Fig6" class="calibre5">Figure 6-6</a>.</span> First steps in registering a new app</p></div>
<p class="indent">This will open a screen (see <a id="_Fig7" href="part0016.html#Fig7" class="calibre5">Figure 6-7</a>) which allows you to fill in some details about your application.</p>
<div class="Figure" id="Fig7">
<p class="img1"><img src="../images/00060.jpeg" alt="9781430259084_Fig06-07.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0016.html#_Fig7" class="calibre5">Figure 6-7</a>.</span> Create a new App window</p></div>
<p class="indent">The name of your application can be anything as long as it doesn’t contain the word “face” or “book”. The namespace is used by the Facebook Graph API it is limit to only contain lowercase characters and of course has to be unique over all Facebook applications. Finally you need to select the category in which your application belongs. When you decided on all these things press the Create App button, which will take you to your application page (see <a id="_Fig8" href="part0016.html#Fig8" class="calibre5">Figure 6-8</a>).</p>
<div class="Figure" id="Fig8">
<p class="img1"><img src="../images/00061.jpeg" alt="9781430259084_Fig06-08.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0016.html#_Fig8" class="calibre5">Figure 6-8</a>.</span> Facebook Settings page</p></div>
<p class="indent">On this page navigate to the Settings tab.</p>
<p class="indent">On the settings page enter the URL of the site your app is going to be part of. In this exercise that is <span class="FontName">http://localhost:8080/social</span>. If this URL isn’t present, authorization will not be granted and the connection will be never made.</p>
<p id="Sec16" class="Heading2">Configure Spring Social<a id="cXXX.504" class="calibre6"></a> to Connect with Facebook</p>
<p class="noindent">This Facebook settings page also contains the application id and secret needed by the application to connect to Facebook. Put them in the <span class="FontName">application.properties</span> file.</p>
<pre class="calibre11"><span class="FontName">facebook.appId=&lt;your app-id here&gt;</span><br class="calibre10"/><span class="FontName">facebook.appSecret=&lt;your app-secret here&gt;</span></pre>
<p class="indent">Assuming Spring Social is already setup (see Recipe 6-1) it is a matter of adding a <span class="FontName">FacebookConnectionFactory</span> and <span class="FontName">FacebookTemplate</span> for easy access.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.social.facebook.api.Facebook;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.facebook.connect.FacebookConnectionFactory;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableSocial</span><br class="calibre10"/><span class="FontName">@PropertySource("classpath:/application.properties")</span><br class="calibre10"/><span class="FontName">public class SocialConfig extends SocialConfigurerAdapter {</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@Configuration</span><br class="calibre10"/>    <span class="FontName">public static class</span> <b class="calibre4">FacebookConfiguration</b> <span class="FontName">extends SocialConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">@Override</span><br class="calibre10"/>        <span class="FontName">public void addConnectionFactories(</span><br class="calibre10"/>            <span class="FontName">ConnectionFactoryConfigurer connectionFactoryConfigurer,</span><br class="calibre10"/>            <span class="FontName">Environment env) {</span><br class="calibre10"/>            <span class="FontName">connectionFactoryConfigurer.addConnectionFactory(</span><br class="calibre10"/>                    <span class="FontName">new FacebookConnectionFactory(</span><br class="calibre10"/>                            <span class="FontName">env.getRequiredProperty("facebook.appId"),</span><br class="calibre10"/>                            <span class="FontName">env.getRequiredProperty("facebook.appSecret")));</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">@Bean</span><br class="calibre10"/>        <span class="FontName">@Scope(value = "request", proxyMode = ScopedProxyMode.INTERFACES)</span><br class="calibre10"/>        <span class="FontName">public Facebook facebookTemplate(ConnectionRepository connectionRepository) {</span><br class="calibre10"/>            <span class="FontName">Connection&lt;Facebook&gt; connection = connectionRepository.findPrimaryConnection(Facebook.class);</span><br class="calibre10"/>            <span class="FontName">return connection != null ? connection.getApi() : null;</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">FacebookConnectionFactory</span> needs the application id and secret. Both properties are added to the <span class="FontName">application.properties</span> file and are available through the <span class="FontName">Environment</span> object.</p>
<p class="indent">The bean configuration above adds a bean named <span class="FontName">facebookTemplate</span> to the application context. Notice the <span class="FontName">@Scope</span> annotation. It is important that this bean is request scoped. For each request the actual connection to Facebook might differ as potentially every request is for a different user. Hence the request scoped bean. The <span class="FontName">ConnectionRepository</span> that is injected into the method is determined based on the id of the current user, which is retrieved using the <span class="FontName">UserIdSource</span> you configured earlier (see Recipe 6-1).</p>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  Although the sample uses a separate configuration class to configure Facebook as a service provider you can also add it to the main <span class="FontName">SocialConfig</span> class. However it can be desirable to separate the global Spring Social configuration from the specific service provider setup.</p></div>
<p id="Sec17" class="Heading">6-4. Showing Service Provider Connection Status<a id="cXXX.505" class="calibre6"></a></p>
<p id="Sec18" class="Heading1">Problem</p>
<p class="noindent">You want to display the status of the connections of the used service providers.</p>
<p id="Sec19" class="Heading1">Solution</p>
<p class="noindent">Configure the ConnectController and use it to show the status to the user.</p>
<p id="Sec20" class="Heading1">How It Works</p>
<p class="noindent">Spring Social comes with a <span class="FontName">ConnectController</span> which takes care of connecting and disconnecting to a service provider but you can also show the status (connected or not) of the current user for the used service providers. The ConnectController uses several REST URLs to either show, add, or remove the connection for the given user (see <a id="_Tab2" href="part0016.html#Tab2" class="calibre5">Table 6-2</a>).</p>
<div class="Table" id="Tab2">
<p class="TabCapt"><span class="calibre4"><a href="part0016.html#_Tab2" class="calibre5">Table 6-2</a>.</span> ConnectController URL mapping</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14">
<p class="tab-left">URL</p></th><th valign="top" class="calibre14">
<p class="tab-left">Method</p></th><th valign="top" class="calibre14">
<p class="tab-left">Description</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">/connect</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">GET</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Display the connection status of all available service provides. Will return <span class="FontName">connect/status</span> as the name of the view to render.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">/connect/{provider}</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">GET</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Display the connection status of the given provider. When connected will return <span class="FontName">connect/{provider}Connected</span> else will return <span class="FontName">connect/{provider}Connect</span> as the view to render.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">/connect/{provider}</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">POST</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Starts the connection flow with the given provider.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">/connect/{provider}</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">DELETE</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Deletes all connections for the current user with the given provider.</p></td></tr></tbody></table>
</div>
<p class="indent">To be able to use the controller you first need to configure Spring MVC (see <a href="part0014.html" class="calibre5">Chapter 4</a>). For this add the following configuration.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.ComponentScan;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.connect.ConnectionFactoryLocator;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.connect.ConnectionRepository;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.connect.web.ConnectController;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.ViewResolver;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.config.annotation.ViewControllerRegistry;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.view.InternalResourceViewResolver;</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">@EnableWebMvc</b><br class="calibre10"/><span class="FontName">@ComponentScan({"com.apress.springrecipes.social.web"})</span><br class="calibre10"/><span class="FontName">public class WebConfig extends WebMvcConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public ViewResolver internalResourceViewResolver() {</span><br class="calibre10"/>        <span class="FontName">InternalResourceViewResolver viewResolver = new InternalResourceViewResolver();</span><br class="calibre10"/>        <span class="FontName">viewResolver.setPrefix("/WEB-INF/views/");</span><br class="calibre10"/>        <span class="FontName">viewResolver.setSuffix(".jsp");</span><br class="calibre10"/>        <span class="FontName">return viewResolver;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void addViewControllers(ViewControllerRegistry registry) {</span><br class="calibre10"/>        <span class="FontName">registry.addViewController("/").setViewName("index");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You need to enable Spring MVC using <span class="FontName">@EnableWebMvc</span>, and add a <span class="FontName">ViewResolver</span> so the jsp pages can be picked up. Finally you want to show the <span class="FontName">index.jsp</span> when the application starts up.</p>
<p class="indent">Next add the <span class="FontName">ConnectController</span> to the WebConfig, this controller needs <span class="FontName">ConnectionFactoryLocator</span> and <span class="FontName">ConnectionRepository</span> as constructor arguments. To access those simply add them as method arguments.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public ConnectController connectController(</span><br class="calibre10"/>    <span class="FontName">ConnectionFactoryLocator connectionFactoryLocator,</span><br class="calibre10"/>    <span class="FontName">ConnectionRepository connectionRepository) {</span><br class="calibre10"/>    <span class="FontName">return</span> <b class="calibre4">new ConnectController(connectionFactoryLocator, connectionRepository)</b><span class="FontName">;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The ConnectController will listen to the URLs as listed in <a href="part0016.html#Tab2" class="calibre5">Table 6-2</a>. Now add two views in the <span class="FontName">/WEB-INF/views</span> directory. The first is the main index the second is the status overview page.</p>
<p class="indent">First create the <span class="FontName">index.jsp</span></p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="spring" uri="</span><span class="FontName"><a href="http://www.springframework.org/tags" class="calibre5">http://www.springframework.org/tags</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;title&gt;Hello Spring Social&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;h3&gt;Connections&lt;/h3&gt;</span><br class="calibre10"/>    <span class="FontName">Click &lt;a href="&lt;spring:url value='/connect'/&gt;"&gt;here&lt;/a&gt; to see your Social Network Connections.</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">Next create the <span class="FontName">status.jsp</span> in the <span class="FontName">/WEB-INF/views/connect</span> directory.</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="spring" uri="</span><span class="FontName"><a href="http://www.springframework.org/tags" class="calibre5">http://www.springframework.org/tags</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;%@ taglib prefix="c" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/core" class="calibre5">http://java.sun.com/jsp/jstl/core</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;title&gt;Spring Social - Connections&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;h3&gt;Spring Social - Connections&lt;/h3&gt;</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">&lt;c:forEach items="${providerIds}" var="provider"&gt;</b><br class="calibre10"/>    <b class="calibre4">&lt;h4&gt;${provider}&lt;/h4&gt;</b><br class="calibre10"/>    <b class="calibre4">&lt;c:if test="${not empty connectionMap[provider]}"&gt;</b><br class="calibre10"/>        <b class="calibre4">You are connected to ${provider} as ${connectionMap[provider][0].displayName}</b><br class="calibre10"/>    <b class="calibre4">&lt;/c:if&gt;</b><br class="calibre10"/>    <b class="calibre4">&lt;c:if test="${empty connectionMap[provider]}"&gt;</b><br class="calibre10"/>        <b class="calibre4">&lt;div&gt;</b><br class="calibre10"/>            <b class="calibre4">You are not yet connected to ${provider}. Click &lt;a href="&lt;spring:url value="/connect/${provider}"/&gt;"&gt;here&lt;/a&gt; to connect to ${provider}.</b><br class="calibre10"/>        <b class="calibre4">&lt;/div&gt;</b><br class="calibre10"/>    <b class="calibre4">&lt;/c:if&gt;&lt;/c:forEach&gt;</b><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">The status page will iterate over all available providers and will determine if there is an existing connection for the current user for that service provider (twitter, facebook, etc.). The <span class="FontName">ConnectController</span> will make the list of providers available under the <span class="FontName">providerIds</span> attribute and the <span class="FontName">connectionMap</span> holds the connections of the current user.</p>
<p class="indent">Now to bootstrap the application you will need to create a <span class="FontName">WebApplicationInitializer</span> that will register a <span class="FontName">ContextLoaderListener</span> and <span class="FontName">DispatcherServlet</span> to handle the requests.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.social.config.SocialConfig;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.social.config.WebConfig;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.filter.DelegatingFilterProxy;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.Filter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class SocialWebApplicationInitializer extends    AbstractAnnotationConfigDispatcherServletInitializer {</span><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected Class&lt;?&gt;[] getRootConfigClasses() {</span><br class="calibre10"/>        <span class="FontName">return new Class&lt;?&gt;[]{SocialConfig.class};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected Class&lt;?&gt;[] getServletConfigClasses() {</span><br class="calibre10"/>        <span class="FontName">return new Class&lt;?&gt;[] {WebConfig.class, };</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected String[] getServletMappings() {</span><br class="calibre10"/>        <span class="FontName">return new String[] {"/"};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This will bootstrap the application. The <span class="FontName">SocialConfig</span> will be loaded by the <span class="FontName">ContextLoaderListener</span> and the <span class="FontName">WebConfig</span> will be loaded by the <span class="FontName">DispatcherServlet</span>. To be able to handle requests there needs to be a servlet mapping, for this the mapping will be /.</p>
<p class="indent">Now that everything is configured the application can be deployed and accessed by the url <span class="FontName">http://localhost:8080/social</span>. This will show the index page. Clicking the link will show the connection status page, which initially will show that the current user isn’t connected.</p>
<p id="Sec21" class="Heading2">Connecting to a Service Provider</p>
<p class="noindent">Now when clicking on a link to connect to a service provider the user will be sent to the <span class="FontName">/connect/{provider}</span> url. When there isn’t a connection the <span class="FontName">connect/{provider}Connect</span> page will be rendered or the <span class="FontName">connect/{provider}Connected</span> page would be shown.</p>
<p class="indent">To be able to use the ConnectController to connect to Twitter you need to add the <span class="FontName">twitterConnect.jsp</span> and <span class="FontName">twitterConnected.jsp</span>. For Facebook it would be <span class="FontName">facebookConnect.jsp</span> and <span class="FontName">facebookConnected.jsp</span>. The same pattern applies to all other service provider connectors for Spring Social (like GitHub, FourSquare, LinkedIn, ...).</p>
<p class="indent">First add the <span class="FontName">twitterConnect.jsp</span> to the <span class="FontName">/WEB-INF/views/connect</span> directory.</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="spring" uri="</span><span class="FontName"><a href="http://www.springframework.org/tags" class="calibre5">http://www.springframework.org/tags</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;title&gt;Spring Social - Connect to Twitter&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;h3&gt;Connect to Twitter&lt;/h3&gt;</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">&lt;form action="&lt;spring:url value='/connect/twitter'/&gt;" method="POST"&gt;</b><br class="calibre10"/>    <span class="FontName">&lt;div class="formInfo"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;p&gt;You aren't connected to Twitter yet. Click the button to connect this application with your Twitter account.&lt;/p&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/div&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;p&gt;&lt;button type="submit"&gt;Connect to Twitter&lt;/button&gt;&lt;/p&gt;</span><br class="calibre10"/><span class="FontName">&lt;/form&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">Notice the form tag which POSTs the form back to the same URL. When pressing the submit button you will be redirected to Twitter which will ask for your permission to allow this application to access your Twitter profile. (Replace this with facebook to connect to Facebook.).</p>
<p class="indent">Next add the <span class="FontName">twitterConnected.jsp</span> to the <span class="FontName">/WEB-INF/views/connect</span> directory. This is the page that will be displayed when you are already connected to Twitter but also when you return from Twitter after authorizing the application.</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="spring" uri="</span><span class="FontName"><a href="http://www.springframework.org/tags" class="calibre5">http://www.springframework.org/tags</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;title&gt;Spring Social - Connected to Twitter&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;h3&gt;Connected to Twitter&lt;/h3&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;p&gt;</span><br class="calibre10"/>    <span class="FontName">You are now connected to your Twitter account.</span><br class="calibre10"/>    <span class="FontName">Click &lt;a href="&lt;spring:url value='/connect'/&gt;"&gt;here&lt;/a&gt; to see your Connection Status.</span><br class="calibre10"/><span class="FontName">&lt;/p&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">When these pages are added reboot the application and navigate to the status page. Now when clicking the Connect to Twitter link you will send to the twitterConnect.jsp. After clicking the Connect to Twitter button you will be shown the Twitter authorize application page (see <a id="_Fig9" href="part0016.html#Fig9" class="calibre5">Figure 6-9</a>).</p>
<div class="Figure" id="Fig9">
<p class="img1"><img src="../images/00062.jpeg" alt="9781430259084_Fig06-09.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0016.html#_Fig9" class="calibre5">Figure 6-9</a>.</span> Twitter Authorize Page</p></div>
<p class="indent">After authorizing the application you will be returned to the <span class="FontName">twitterConnect.jsp</span> telling you that you have successfully connected to Twitter. When returning to the status page you will see that you are connected to Twitter with your nickname.</p>
<p class="indent">For Facebook or any other service provider follow the same steps of adding the <span class="FontName">{provider}Connect</span> and <span class="FontName">{provider}Connected</span> page and Spring Social will be able to connect to that provider, given that you also added the correct service provider connector and configuration.</p>
<p id="Sec22" class="Heading">6-5. Using the Twitter API<a id="cXXX.506" class="calibre6"></a></p>
<p id="Sec23" class="Heading1">Problem</p>
<p class="noindent">You want to use the Twitter API.</p>
<p id="Sec24" class="Heading1">Solution</p>
<p class="noindent">Use the Twitter object to access the Twitter API.</p>
<p id="Sec25" class="Heading1">How It Works</p>
<p class="noindent">Each service provider has its own API using Twitter. There is an object implementing the <span class="FontName">Twitter</span> interface which represents the Twitter API in Java; for <span class="FontName">Facebook</span> an object implementing the <span class="FontName">Facebook</span> interface is available. In Recipe 6-2 you already set up the connection to Twitter and the <span class="FontName">TwitterTemplate</span>.</p>
<p class="indent">The TwitterTemplate exposes various parts of the Twitter API (see <a id="_Tab3" href="part0016.html#Tab3" class="calibre5">Table 6-3</a>).</p>
<div class="Table" id="Tab3">
<p class="TabCapt"><span class="calibre4"><a href="part0016.html#_Tab3" class="calibre5">Table 6-3</a>.</span> Exposed operations of the Twitter API</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14">
<p class="tab-left">Operations</p></th><th valign="top" class="calibre14">
<p class="tab-left">Description</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">blockOperations()</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Block and unblock users</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">directMessageOperations()</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Reading and sending direct messages</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">friendOperations()</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Retrieving a user’s list of friends and followers and following/unfollowing users</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">geoOperations()</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Working with locations</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">listOperations()</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Maintaining, subscribing to, and unsubscribing from user lists</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">searchOperations()</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Searching tweets and viewing search trends</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">streamingOperations()</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Receive tweets as they are created via Twitter’s Streaming API</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">timelineOperations()</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Reading timelines and posting tweets</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">userOperations()</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Retrieving user profile data</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt"><span class="FontName">restOperations()</span></p></td><td valign="top" class="calibre16">
<p class="tab-leftt">The underlying <span class="FontName">RestTemplate</span> if a part of the API hasn’t been exposed through the other APIs</p></td></tr></tbody></table>
</div>
<p class="indent">It might be that for certain operations your application requires more access than read-only. If you want to send tweets you need read-write access and to be able to access direct messages you need Read, Write, and access to direct messages.</p>
<p class="indent">To post a status update you would use the <span class="FontName">timelineOperations()</span> and then the <span class="FontName">updateStatus()</span> method. Depending on your needs it either takes a simple String, the status, or a value object TweetData holding the status and other information like location, if it is a reply to another tweet and optionally any resources like images.</p>
<p class="indent">A simple controller could look like the following.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social.web;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.social.twitter.api.Twitter;</span><br class="calibre10"/><span class="FontName">import org.springframework.stereotype.Controller;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.bind.annotation.RequestMapping;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.bind.annotation.RequestMethod;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.bind.annotation.RequestParam;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">@RequestMapping("/twitter")</span><br class="calibre10"/><span class="FontName">public class TwitterController {</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">private final Twitter twitter;</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public TwitterController(Twitter twitter) {</span><br class="calibre10"/>        <span class="FontName">this.twitter = twitter;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.GET)</span><br class="calibre10"/>    <span class="FontName">public String index() {</span><br class="calibre10"/>        <span class="FontName">return "twitter";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.POST)</span><br class="calibre10"/>    <span class="FontName">public String tweet(@RequestParam("status") String status) {</span><br class="calibre10"/>        <b class="calibre4">twitter.timelineOperations().updateStatus(status);</b><br class="calibre10"/>        <span class="FontName">return "redirect:/twitter";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The controller needs the Twitter API through the <span class="FontName">TwitterTemplate</span>. The <span class="FontName">TwitterTemplate</span> implements the <span class="FontName">Twitter</span> interface. As you might recall from Recipe 6-2 the API is request scoped. You get a scoped proxy hence the usage of the <span class="FontName">Twitter</span> interface. The tweet method receives a parameter and passes that on to Twitter.</p>
<p id="Sec26" class="Heading">6-6. Using a Persistent UsersConnectionRepository<a id="cXXX.507" class="calibre6"></a></p>
<p id="Sec27" class="Heading1">Problem</p>
<p class="noindent">You want to persist the users’ connection data to survive server restarts.</p>
<p id="Sec28" class="Heading1">Solution</p>
<p class="noindent">Use the <span class="FontName">JdbcUsersConnectionRepository</span> instead of the default <span class="FontName">InMemoryUsersConnectionRepository</span>.</p>
<p id="Sec29" class="Heading1">How It Works</p>
<p class="noindent">By default Spring Social automatically configures an <span class="FontName">InMemoryUsersConnectionRepository</span> for storing the connection information for a user. However this doesn’t work in a cluster nor does it survive server restarts. To solve this problem it is possible to use a database to store the connection information. This is enabled by the <span class="FontName">JdbcUsersConnectionRepository</span>.</p>
<p class="indent">The <span class="FontName">JdbcUsersConnectionRepository</span> requires a database containing a table named <span class="FontName">UserConnection</span> containing a certain number of columns. Luckily Spring Social contains a DDL script, <span class="FontName">JdbcUsersConnectionRepository.sql</span>, which you can use to create the table.</p>
<p class="indent">First add a <span class="FontName">DataSource</span> to point to the database of your choice. In this case Derby is used but any database would do.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public DataSource dataSource() {</span><br class="calibre10"/>    <span class="FontName">BasicDataSource dataSource = new BasicDataSource();</span><br class="calibre10"/>    <span class="FontName">dataSource.setUrl(env.getRequiredProperty("dataSource.url"));</span><br class="calibre10"/>    <span class="FontName">dataSource.setDriverClassName(env.getRequiredProperty("dataSource.driverClassName"));</span><br class="calibre10"/>    <span class="FontName">dataSource.setUsername(env.getProperty("dataSource.username"));</span><br class="calibre10"/>    <span class="FontName">dataSource.setPassword(env.getProperty("dataSource.password"));</span><br class="calibre10"/>    <span class="FontName">return dataSource;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice the <span class="FontName">dataSource.*</span> properties, which are used to configure the URL, JDBC Driver, and username/password. Add the properties to the application.properties file.</p>
<pre class="calibre11"><span class="FontName">dataSource.password=app</span><br class="calibre10"/><span class="FontName">dataSource.username=app</span><br class="calibre10"/><span class="FontName">dataSource.driverClassName=org.apache.derby.jdbc.ClientDriver</span><br class="calibre10"/><span class="FontName">dataSource.url=jdbc:derby://localhost:1527/social;create=true</span></pre>
<p class="indent">Now before starting the application you need to start Derby to accept connections. Assuming that you have Derby already available you can start it by running the <span class="FontName">startNetworkServer</span> command which can be found in the <span class="FontName">bin</span> directory of the Derby installation.</p>
<p class="indent">If you want automatic creation of the desired database table you will need to add a <span class="FontName">DataSourceInitializer</span> and have it execute the <span class="FontName">JdbcUsersConnectionRepository.sql</span> file.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public DataSourceInitializer databasePopulator() {</span><br class="calibre10"/>    <span class="FontName">ResourceDatabasePopulator populator = new ResourceDatabasePopulator();</span><br class="calibre10"/>    <span class="FontName">populator.addScript(</span><br class="calibre10"/>      <span class="FontName">new ClassPathResource("org/springframework/social/connect/jdbc/JdbcUsersConnectionRepository.sql"));</span><br class="calibre10"/>    <span class="FontName">populator.setContinueOnError(true); // Continue in case the create script already ran</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">DataSourceInitializer initializer = new DataSourceInitializer();</span><br class="calibre10"/>    <span class="FontName">initializer.setDatabasePopulator(populator);</span><br class="calibre10"/>    <span class="FontName">initializer.setDataSource(dataSource());</span><br class="calibre10"/>    <span class="FontName">return initializer;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This <span class="FontName">DataSourceInitializer</span> is executed at application startup and will execute all the scripts handed to it. By default it will stop application startup as soon as an error is encountered. To stop this set the <span class="FontName">continueOnError</span> property to true.</p>
<p class="indent">Now that the DataSource is setup and configured the final step is to add the <span class="FontName">JdbcUsersConnectionRepository</span> to the <span class="FontName">SocialConfig</span> class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.social.connect.jdbc.JdbcUsersConnectionRepository;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableSocial</span><br class="calibre10"/><span class="FontName">@PropertySource("classpath:/application.properties")</span><br class="calibre10"/><span class="FontName">public class SocialConfig extends SocialConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public UsersConnectionRepository getUsersConnectionRepository(</span><br class="calibre10"/>        <span class="FontName">ConnectionFactoryLocator connectionFactoryLocator) {</span><br class="calibre10"/>        <span class="FontName">return new JdbcUsersConnectionRepository(</span><br class="calibre10"/>                <span class="FontName">dataSource(), connectionFactoryLocator, Encryptors.noOpText());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public DataSource dataSource() { ... }</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The JdbcUsersConnectionRepository takes three constructor arguments. The first is the <span class="FontName">DataSource</span>, the second is the passed in <span class="FontName">ConnectionFactoryLocator,</span> and the last argument is a <span class="FontName">TextEncryptor</span>. The <span class="FontName">TextEncryptor</span> is a class from the Spring Security crypto module and is used to encrypt the accessToken, secret, and, when available, the refresh token. The encryption is needed as when the data is stored as plain text and the data would be compromised. The tokens could be used to gain access to your profile information.</p>
<p class="indent">For testing however it can be handy to use the noOpText encryptor which, as the name implies, does no encryption. For real production you want to use a <span class="FontName">TextEncryptor</span> which uses a password and salt to encrypt the values.</p>
<p class="indent">When the <span class="FontName">JdbcUsersConnectionRepository</span> is configured and the database has been started you can restart the application. At first glance nothing has changed; however, as soon as you grant access to, for instance, Twitter, this access will survive application restarts. You can also query the database and see that the information is stored in the <span class="FontName">USERCONNECTION</span> table.</p>
<p id="Sec30" class="Heading">6-7. Integrating Spring Social and Spring Security<a id="cXXX.508" class="calibre6"></a></p>
<p id="Sec31" class="Heading1">Problem</p>
<p class="noindent">You want to allow users of your website to connect their social network accounts.</p>
<p id="Sec32" class="Heading1">Solution</p>
<p class="noindent">Use the spring-social-security project to integrate both frameworks.</p>
<p id="Sec33" class="Heading1">How It Works</p>
<p class="noindent">Before you can use the Spring Security integration for Spring Social you will need to add the spring-social-security module to your dependencies.</p>
<pre class="calibre11"><span class="FontName">&lt;dependency&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;groupId&gt;org.springframework.social&lt;/groupId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;artifactId&gt;spring-social-security&lt;/artifactId&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;version&gt;1.1.0.RELEASE&lt;/version&gt;</span><br class="calibre10"/><span class="FontName">&lt;/dependency&gt;</span></pre>
<p class="indent">This dependency will pull in all other necessary dependencies for Spring Security.</p>
<p class="indent">Next let’s setup Spring Security. It goes beyond this recipe to discuss Spring Security in detail. For that check <a href="part0017.html" class="calibre5">Chapter 7</a>. The setup for this recipe is as follows.</p>
<pre class="calibre11"><span class="FontName">Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvcSecurity</span><br class="calibre10"/><span class="FontName">public class SecurityConfig extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http.authorizeRequests()</span><br class="calibre10"/>                <span class="FontName">.anyRequest().authenticated()</span><br class="calibre10"/>            <span class="FontName">.and()</span><br class="calibre10"/>                <span class="FontName">.formLogin()</span><br class="calibre10"/>                <span class="FontName">.loginPage("/signin")</span><br class="calibre10"/>                <span class="FontName">.failureUrl("/signin?param.error=bad_credentials")</span><br class="calibre10"/>                <span class="FontName">.loginProcessingUrl("/signin/authenticate").permitAll()</span><br class="calibre10"/>                <span class="FontName">.defaultSuccessUrl("/connect")</span><br class="calibre10"/>            <span class="FontName">.and()</span><br class="calibre10"/>                <span class="FontName">.logout().logoutUrl("/signout").permitAll();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public UserDetailsManager userDetailsManager(DataSource dataSource) {</span><br class="calibre10"/>        <span class="FontName">JdbcUserDetailsManager userDetailsManager = new JdbcUserDetailsManager();</span><br class="calibre10"/>        <span class="FontName">userDetailsManager.setDataSource(dataSource);</span><br class="calibre10"/>        <span class="FontName">userDetailsManager.setEnableAuthorities(true);</span><br class="calibre10"/>        <span class="FontName">return userDetailsManager;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(AuthenticationManagerBuilder auth) throws Exception {</span><br class="calibre10"/>        <span class="FontName">auth.userDetailsService(userDetailsManager(null));</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">@EnableWebMvcSecurity</span> annotation will enable security for Spring MVC applications. It registers beans needed for Spring Security to operate. To do further configuration, like setting up security rules, one or more <span class="FontName">WebSecurityConfigurer</span>s can be added. To make it easier there is a <span class="FontName">WebSecurityConfigurerAdapter</span> which one can extend.</p>
<p class="indent">The <span class="FontName">configure(HttpSecurity http)</span> method takes care of setting up security. This particular configuration wants a user to be authenticated for every call that is made. If a user isn’t already authenticated (i.e., has logged in to the application) he will be prompted with a login form. You will also notice that the <span class="FontName">loginPage</span>, <span class="FontName">loginProcessingUrl</span>, and <span class="FontName">logoutUrl</span> are modified. This is done so that they match the default URLs from Spring Social.</p>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  If you want to keep the Spring Security defaults configure the <span class="FontName">SocialAuthenticationFilter</span> explicitly and set the <span class="FontName">signupUrl</span> and <span class="FontName">defaultFailureUrl</span> properties.</p></div>
<p class="indent">With the <span class="FontName">configure(AuthenticationManagerBuilder  auth)</span> you add a <span class="FontName">AuthenticationManager</span> which is used to determine if a user exists and if the correct credentials were entered. The UserDetailsService used is a JdbcUserDetailsManager which, next to being a UserDetailsService, can also add and remove users from the repository. This will be needed when you add Social signin to the application.</p>
<p class="indent">The <span class="FontName">JdbcUserDetailsManager</span> uses a <span class="FontName">DataSource</span> to read and write the data and the <span class="FontName">enableAuthorities</span> properties is set to <span class="FontName">true</span> so that any roles the user gets from the application are added to the database as well. To bootstrap the database add the <span class="FontName">create_users.sql</span> script to the database populator configured in the previous recipe.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public DataSourceInitializer databasePopulator() {</span><br class="calibre10"/>    <span class="FontName">ResourceDatabasePopulator populator = new ResourceDatabasePopulator();</span><br class="calibre10"/>    <span class="FontName">populator.addScript(</span><br class="calibre10"/>    <span class="FontName">new ClassPathResource("org/springframework/social/connect/jdbc/JdbcUsersConnectionRepository.sql"));</span><br class="calibre10"/>    <b class="calibre4">populator.addScript(new ClassPathResource("sql/create_users.sql"));</b><br class="calibre10"/>    <span class="FontName">populator.setContinueOnError(true); // Continue in case the create scripts already ran</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">DataSourceInitializer initializer = new DataSourceInitializer();</span><br class="calibre10"/>    <span class="FontName">initializer.setDatabasePopulator(populator);</span><br class="calibre10"/>    <span class="FontName">initializer.setDataSource(dataSource());</span><br class="calibre10"/>    <span class="FontName">return initializer;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Next, to be able to render the custom login or signin page it needs to be added as a view controller to the <span class="FontName">WebConfig</span>. This tells that a request to <span class="FontName">/signin</span> should render the <span class="FontName">signin.jsp</span> page.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">@EnableWebMvc</span><br class="calibre10"/><span class="FontName">@ComponentScan({"com.apress.springrecipes.social.web"})</span><br class="calibre10"/><span class="FontName">public class WebConfig extends WebMvcConfigurerAdapter {</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void addViewControllers(ViewControllerRegistry registry) {</span><br class="calibre10"/>        <span class="FontName">registry.addViewController("/").setViewName("index");</span><br class="calibre10"/>        <b class="calibre4">registry.addViewController("/signin").setViewName("signin");</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">signin.jsp</span> is a simple JSP page rendering a username and password input field and a submit button.</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="c" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/core" class="calibre5">http://java.sun.com/jsp/jstl/core</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;!DOCTYPE html&gt;</span><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;c:url var="formLogin" value="/signin/authenticate" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;c:if test="${param.error eq 'bad_credentials'}"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;div class="error"&gt;</span><br class="calibre10"/>            <span class="FontName">The login information was incorrect please try again.</span><br class="calibre10"/>        <span class="FontName">&lt;/div&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/c:if&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;form method="post" action="${formLogin}"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;input type="hidden" name="_csrf" value="${_csrf.token}" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;table&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;td&gt;&lt;label for="username"&gt;Username&lt;/label&gt;&lt;/td&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;td&gt;&lt;input type="text" name="username"/&gt;&lt;/td&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;td&gt;&lt;label for="password"&gt;Password&lt;/label&gt;&lt;/td&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;td&gt;&lt;input type="password" name="password"/&gt;&lt;/td&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;tr&gt;&lt;td colspan="2"&gt;&lt;button&gt;Login&lt;/button&gt;&lt;/td&gt; &lt;/tr&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/table&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/form&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">Notice the hidden input which contains a CSFR token (Cross Site Forgery Request token). This is to prevent malicious websites or javascript code to post to our URL. When using Spring Security with Java Config this is enabled by default. It can be disabled with <span class="FontName">http.csfr().disable()</span> in the SecurityConfig class.</p>
<p class="indent">There are two final configuration pieces left. First this configuration needs to be loaded and second a filter needs to be registered to apply the security to our request. For this modify the <span class="FontName">SocialWebApplicationInitializer</span> class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.social.config.SecurityConfig;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.social.config.SocialConfig;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.social.config.WebConfig;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.filter.DelegatingFilterProxy;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.Filter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class SocialWebApplicationInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {</span><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected Class&lt;?&gt;[] getRootConfigClasses() {</span><br class="calibre10"/>        <span class="FontName">return new Class&lt;?&gt;[]{</span><b class="calibre4">SecurityConfig.class</b><span class="FontName">, SocialConfig.class};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected Filter[] getServletFilters() {</span><br class="calibre10"/>        <span class="FontName">DelegatingFilterProxy springSecurityFilterChain = new DelegatingFilterProxy();</span><br class="calibre10"/>        <span class="FontName">springSecurityFilterChain.setTargetBeanName("springSecurityFilterChain");</span><br class="calibre10"/>        <span class="FontName">return new Filter[]{springSecurityFilterChain};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">First notice that the SecurityConfig class is added to the <span class="FontName">getRootConfigClasses</span> method, this will take care of the configuration class being loaded. Next the <span class="FontName">getServletFilters</span> method is added. This method is used to register filters to requests that are going to be handled by the <span class="FontName">DispatcherServlet</span>. Spring Security, by default, registers a <span class="FontName">Filter</span> in the application context named <span class="FontName">springSecurityFilterChain</span>. To have this executed you need to add a <span class="FontName">DelegatingFilterProxy</span>. The <span class="FontName">DelegatingFilterProxy</span> will look up a bean of the type Filter for the specified <span class="FontName">targetBeanName</span>.</p>
<p id="Sec34" class="Heading2">Using Spring Security to Obtain the Username<a id="cXXX.509" class="calibre6"></a></p>
<p class="noindent">In the previous recipes you used a <span class="FontName">UserIdSource</span> implementation that returned a static username. If you have an application that is already using Spring Security you could use the <span class="FontName">AuthenticationNameUserIdSource</span> which uses the <span class="FontName">SecurityContext</span> (from Spring Security) to obtain the username of the authenticated current user. That username in turn is used to store and lookup the users connections with the different service providers.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableSocial</span><br class="calibre10"/><span class="FontName">@PropertySource("classpath:/application.properties")</span><br class="calibre10"/><span class="FontName">public class SocialConfig extends SocialConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public UserIdSource getUserIdSource() {</span><br class="calibre10"/>        <span class="FontName">return</span> <b class="calibre4">new AuthenticationNameUserIdSource();</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice the construction of the <span class="FontName">AuthenticationNameUserIdSource</span>. This is all that is needed to be able to retrieve the username from Spring Security. It will do a lookup of the <span class="FontName">Authentication</span> object from the <span class="FontName">SecurityContext</span> and return the <span class="FontName">name</span> property of the <span class="FontName">Authentication</span>.</p>
<p class="indent">When restarting the application you will be prompted with a login form. Now login as <span class="FontName">user1</span> with password <span class="FontName">user1</span>.</p>
<p id="Sec35" class="Heading2">Using Spring Social for Sign In<a id="cXXX.510" class="calibre6"></a></p>
<p class="noindent">Letting the current user connect his social networks is nice. It would be better if a user could use his social network account(s) to sign in to the application. Spring Social provides tight integration with Spring Security to enable this. There are a couple of additional parts that need to be setup for this.</p>
<p class="indent">First Spring Social needs to be integrated with Spring Security. For this the <span class="FontName">SpringSocialConfigurer</span> can be used and applied to the Spring Security configuration.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvcSecurity</span><br class="calibre10"/><span class="FontName">public class SecurityConfig extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <b class="calibre4">http.apply(new SpringSocialConfigurer());</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">SpringSocialConfigurer</span> needs a <span class="FontName">SocialUserDetailsService</span>. This is used to lookup a user based on the user’s id. For this recipe an implementation that delegates to a normal <span class="FontName">UserDetailsService</span> will do. The <span class="FontName">SpringSocialConfigurer</span> registers the <span class="FontName">SocialAuthenticationFilter</span> which starts the authentication flow with the selected service provider. The filter listens, by default, to the <span class="FontName">/auth/{provider}</span> URL, where <span class="FontName">{provider}</span> points to the service provider being used (i.e., Twitter, Facebook, etc.).</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social.security;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.dao.DataAccessException;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.core.userdetails.UserDetails;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.core.userdetails.UserDetailsService;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.security.SocialUser;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.security.SocialUserDetails;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.security.SocialUserDetailsService;</span><br class="calibre10"/><span class="FontName">import org.springframework.util.Assert;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class SimpleSocialUserDetailsService implements SocialUserDetailsService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private final UserDetailsService userDetailsService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public SimpleSocialUserDetailsService(UserDetailsService userDetailsService) {</span><br class="calibre10"/>        <span class="FontName">Assert.notNull(userDetailsService, "UserDetailsService cannot be null.");</span><br class="calibre10"/>        <span class="FontName">this.userDetailsService = userDetailsService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public SocialUserDetails loadUserByUserId(String userId) throws UsernameNotFoundException, DataAccessException {</span><br class="calibre10"/>        <span class="FontName">UserDetails user = userDetailsService.loadUserByUsername(userId);</span><br class="calibre10"/>        <span class="FontName">return new SocialUser(user.getUsername(), user.getPassword(), user.getAuthorities());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Next add the links for your configured service providers to the signin page.</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="c" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/core" class="calibre5">http://java.sun.com/jsp/jstl/core</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;!DOCTYPE html&gt;</span><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;!-- TWITTER SIGNIN --&gt;</span><br class="calibre10"/><b class="calibre4">&lt;c:url var="twitterSigin" value="/auth/twitter"/&gt;</b><br class="calibre10"/><b class="calibre4">&lt;p&gt;&lt;a href="${twitterSigin}"&gt;Sign in with Twitter&lt;/a&gt;&lt;/p&gt;</b><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;!-- FACEBOOK SIGNIN --&gt;</span><br class="calibre10"/><b class="calibre4">&lt;c:url var="twitterSigin" value="/auth/facebook"/&gt;</b><br class="calibre10"/><b class="calibre4">&lt;p&gt;&lt;a href="${twitterSigin}"&gt;Sign in with Facebook&lt;/a&gt;&lt;/p&gt;</b><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">The <span class="FontName">SimpleSocialUserDetailsService</span> delegates the actual lookup to a <span class="FontName">UserDetailsService</span> which is passed in through the constructor. When a user is retrieved it uses the retrieved information to construct a <span class="FontName">SocialUser</span> instance. Finally this bean needs to be added to the configuration.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvcSecurity</span><br class="calibre10"/><span class="FontName">public class SecurityConfig extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public SocialUserDetailsService socialUserDetailsService(UserDetailsService userDetailsService) {</span><br class="calibre10"/>        <span class="FontName">return new SimpleSocialUserDetailsService(userDetailsService);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This will all allow a user to sign in with his social networking accounts; however, the application needs to know which user the account belongs to. If a user cannot be located for the specific social network a user needs to be created. Basically the application needs a way for users to sign up for the application. By default the <span class="FontName">SocialAuthenticationFilter</span> redirects the user to the <span class="FontName">/signup</span> url. You can create a controller which is attached to this URL and renders a form allowing the user to create an account.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social.web;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.annotation.Autowired;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.core.context.SecurityContextHolder;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.provisioning.UserDetailsManager;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.connect.Connection;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.connect.web.ProviderSignInUtils;</span><br class="calibre10"/><span class="FontName">import org.springframework.social.security.SocialUser;</span><br class="calibre10"/><span class="FontName">import org.springframework.stereotype.Controller;</span><br class="calibre10"/><span class="FontName">import org.springframework.validation.BindingResult;</span><br class="calibre10"/><span class="FontName">import org.springframework.validation.annotation.Validated;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.bind.annotation.RequestMapping;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.bind.annotation.RequestMethod;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.request.WebRequest;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.Collections;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">public class SignupController {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private final ProviderSignInUtils providerSignInUtils = new ProviderSignInUtils();</span><br class="calibre10"/>    <span class="FontName">private final UserDetailsManager userDetailsManager;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public SignupController(UserDetailsManager userDetailsManager) {</span><br class="calibre10"/>        <span class="FontName">this.userDetailsManager = userDetailsManager;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(value="/signup", method=RequestMethod.GET)</span><br class="calibre10"/>    <span class="FontName">public SignupForm signupForm(WebRequest request) {</span><br class="calibre10"/>        <span class="FontName">Connection&lt;?&gt; connection = providerSignInUtils.getConnectionFromSession(request);</span><br class="calibre10"/>        <span class="FontName">if (connection != null) {</span><br class="calibre10"/>            <span class="FontName">return SignupForm.fromProviderUser(connection.fetchUserProfile());</span><br class="calibre10"/>        <span class="FontName">} else {</span><br class="calibre10"/>            <span class="FontName">return new SignupForm();</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(value="/signup", method=RequestMethod.POST)</span><br class="calibre10"/>    <span class="FontName">public String signup(@Validated SignupForm form, BindingResult formBinding, WebRequest request) {</span><br class="calibre10"/>        <span class="FontName">if (formBinding.hasErrors()) {</span><br class="calibre10"/>            <span class="FontName">return null;</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">SocialUser user = createUser(form, formBinding);</span><br class="calibre10"/>        <span class="FontName">if (user != null) {</span><br class="calibre10"/>            <span class="FontName">SecurityContextHolder.getContext().setAuthentication(</span><br class="calibre10"/>        <span class="FontName">new UsernamePasswordAuthenticationToken(user.getUsername(), null, null));</span><br class="calibre10"/>            <span class="FontName">providerSignInUtils.doPostSignUp(user.getUsername(), request);</span><br class="calibre10"/>            <span class="FontName">return "redirect:/";</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">return null;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private SocialUser createUser(SignupForm form, BindingResult errors) {</span><br class="calibre10"/>        <span class="FontName">SocialUser user = new SocialUser(</span><br class="calibre10"/>                        <span class="FontName">form.getUsername(),</span><br class="calibre10"/>                        <span class="FontName">form.getPassword(),</span><br class="calibre10"/>                        <span class="FontName">Collections.singleton(new SimpleGrantedAuthority("ROLE_USER")));</span><br class="calibre10"/>        <span class="FontName">userDetailsManager.createUser(user);</span><br class="calibre10"/>        <span class="FontName">return user;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">First the <span class="FontName">signupForm</span> method will be called as the initial request will be a GET request to the <span class="FontName">/signup</span> URL. The <span class="FontName">signupForm</span> method checks if a connection attempt has been done. This is delegated to the <span class="FontName">ProviderSignInUtils</span> provided by Spring Social. If that is the case the retrieved <span class="FontName">UserProfile</span> is used to prepopulate a <span class="FontName">SignupForm</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.social.web;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.social.connect.UserProfile;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class SignupForm {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String username;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String password;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public String getUsername() {</span><br class="calibre10"/>        <span class="FontName">return username;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setUsername(String username) {</span><br class="calibre10"/>        <span class="FontName">this.username = username;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public String getPassword() {</span><br class="calibre10"/>        <span class="FontName">return password;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setPassword(String password) {</span><br class="calibre10"/>        <span class="FontName">this.password = password;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static SignupForm fromProviderUser(UserProfile providerUser) {</span><br class="calibre10"/>        <span class="FontName">SignupForm form = new SignupForm();</span><br class="calibre10"/>        <span class="FontName">form.setUsername(providerUser.getUsername());</span><br class="calibre10"/>        <span class="FontName">return form;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The HTML form used for filling in the two fields.</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="form" uri="</span><span class="FontName"><a href="http://www.springframework.org/tags/form" class="calibre5">http://www.springframework.org/tags/form</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;title&gt;Sign Up&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;h3&gt;Sign Up&lt;/h3&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;form:form modelAttribute="signupForm" method="POST"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;table&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;tr&gt;&lt;td&gt;&lt;form:label path="username" /&gt;&lt;/td&gt;&lt;td&gt;&lt;form:input path="username"/&gt;&lt;/td&gt;&lt;/tr&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;tr&gt;&lt;td&gt;&lt;form:label path="password" /&gt;&lt;/td&gt;&lt;td&gt;&lt;form:password path="password"/&gt;&lt;/td&gt;&lt;/tr&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;tr&gt;&lt;td colspan="2"&gt;&lt;button&gt;Sign Up&lt;/button&gt;&lt;/td&gt;&lt;/tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/table&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/form:form&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  There is no hidden input for the CSFR tag here. Spring Security integrates tightly with Spring MVC and this field will be added automatically when using the Spring Framework form tags.</p></div>
<p class="indent">After the user filled out the form the <span class="FontName">signup</span> method will be called. This will create a user with the given username and password. After the user is created a <span class="FontName">Connection</span> is added for the entered username. Now that the connection has been made the user is logged in to the application and on subsequent visits can use the social network connection to log in to the application.</p>
<p id="Sec36" class="Heading">Summary</p>
<p class="noindent">In this chapter you explored Spring Social. The first step taken was to register an application with a service provider and use the generated API key and secret to connect the application to that service provider.</p>
<p class="indent">Next you looked into connecting a user’s account to the application so that it can be used to access user information; however, this will also allow you to use the service provider’s API. For Twitter you could query a timeline or look at someone’s friends.</p>
<p class="indent">To make the connections to the service providers more useful they are stored in a JDBC-based storage.</p>
<p class="indent">Finally you looked at how Spring Social can integrate with Spring Security and how it can be used to allow a service provider to sign in to your application.</p></div>
</body></html>
