<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Chapter 9 Spring with Other Web Frameworks</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre"><p class="ChapterNumber"><a id="b9781430259084_9" class="calibre6"></a>CHAPTER 9</p>
<p class="Chapimage"><img src="../images/00008.jpeg" alt="image" class="calibre3"/></p>
<p class="ChapterTitle">Spring with Other Web Frameworks</p>
<div class="calibre10"><p class="noindent">In this chapter, you will learn how to integrate the Spring framework with several popular web application frameworks,<a id="cXXX.2265" class="calibre5"></a> like JSF. Spring’s powerful IoC container and enterprise support features make it very suitable for implementing the service and persistence layers of your Java EE applications. However, for the presentation layer, you have a choice between many different web frameworks. So, you often need to integrate Spring with whatever web application framework you are using. The integration mainly focuses on accessing beans declared in the Spring IoC container<a id="cXXX.622" class="calibre5"></a> within these frameworks.</p>
<p class="indent">JavaServer Faces,<a id="cXXX.2094" class="calibre5"></a> or JSF<a id="cXXX.623" class="calibre5"></a> (<span class="FontName"><a href="http://java.sun.com/javaee/javaserverfaces/" class="calibre5">http://java.sun.com/javaee/javaserverfaces/</a></span>), is an excellent component-based and event-driven web application framework included as part of the Java EE specification. You can use the rich set of standard JSF components and also develop custom components for reuse. JSF can cleanly separate presentation logic from UIs by encapsulating it in one or more managed beans. Due to its component-based approach and popularity, JSF is supported by a wide range of IDEs for visual development.</p>
<p class="indent">After finishing this chapter, you will be able to integrate Spring into web applications implemented with Servlet/JSP and popular web application frameworks like JSF.</p>
<p id="Sec1" class="Heading">9-1. Accessing Spring in Generic Web Applications</p>
<p id="Sec2" class="Heading1">Problem</p>
<p class="noindent">You would like to access beans declared in the Spring IoC container in a web application, regardless of which framework it uses.</p>
<p id="Sec3" class="Heading1">Solution</p>
<p class="noindent">A web application can load Spring’s application context by registering the servlet listener <span class="FontName">ContextLoaderListener</span><a id="cXXX.624" class="calibre5"></a>. This listener stores the loaded application context into the web application’s servlet context. Later, a servlet, or any object that can access the servlet context, can also access Spring’s application context through a utility method.</p>
<p id="Sec4" class="Heading1">How It Works</p>
<p class="noindent">Suppose you are going to develop a web application for users to find the distance (measured in kilometers) between two cities. First, you define the following service interface<a id="cXXX.625" class="calibre5"></a>:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface CityService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double findDistance(String srcCity, String destCity);</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">For simplicity’s sake, let’s implement this interface by using a Java map<a id="cXXX.626" class="calibre5"></a> to store the distance data. This map’s keys are source cities while its values are nested maps that contain destination cities and their distances from the source city.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class CityServiceImpl implements CityService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private Map&lt;String, Map&lt;String, Double&gt;&gt;distanceMap;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setDistanceMap(Map&lt;String, Map&lt;String, Double&gt;&gt;distanceMap) {</span><br class="calibre10"/>        <span class="FontName">this.distanceMap = distanceMap;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double findDistance(String srcCity, String destCity) {</span><br class="calibre10"/>        <span class="FontName">Map&lt;String, Double&gt; destinationMap = distanceMap.get(srcCity);</span><br class="calibre10"/>        <span class="FontName">if (destinationMap == null) {</span><br class="calibre10"/>            <span class="FontName">throw new IllegalArgumentException("Source city not found");</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">Double distance = destinationMap.get(destCity);</span><br class="calibre10"/>        <span class="FontName">if (distance == null) {</span><br class="calibre10"/>            <span class="FontName">throw new IllegalArgumentException("Destination city not found");</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">return distance;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Next the service needs to be configured by creating a class and annotating it with the @Configuration annotation and configure the bean appropriately. It could look like the following:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.CityService;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.CityServiceImpl;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.HashMap;</span><br class="calibre10"/><span class="FontName">import java.util.Map;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class DistanceConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public CityService cityService() {</span><br class="calibre10"/>        <span class="FontName">CityServiceImpl cityService = new CityServiceImpl();</span><br class="calibre10"/>        <span class="FontName">Map&lt;String, Map&lt;String, Double&gt;&gt;distances = new HashMap&lt;&gt;();</span><br class="calibre10"/>        <span class="FontName">Map&lt;String, Double&gt; newYorkDistances = new HashMap&lt;&gt;();</span><br class="calibre10"/>        <span class="FontName">newYorkDistances.put("London", 5574.0);</span><br class="calibre10"/>        <span class="FontName">newYorkDistances.put("Beijing", 10976.0);</span><br class="calibre10"/>        <span class="FontName">distances.put("New York", newYorkDistances);</span><br class="calibre10"/>        <span class="FontName">cityService.setDistanceMap(distances);</span><br class="calibre10"/>        <span class="FontName">return cityService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">CityServiceImpl</span> is constructed and a <span class="FontName">Map</span> is filled with some distance data.</p>
<p class="indent">Next you need a servlet to process the distance requests and a page to display the form and the results. When this servlet is accessed with the HTTP <span class="FontName">GET</span> method<a id="cXXX.627" class="calibre5"></a>, it simply displays the form. Later, when the form is submitted with the <span class="FontName">POST</span> method, this servlet finds the distance between the two input cities and displays it in the form again.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To develop web applications that use the Servlet API, you have to include the Servlet API. If you are using Maven, add the following dependency to your project:</p>
<p class="paraaftertitle">&lt;dependency&gt;<br class="calibre10"/>  &lt;groupId&gt;javax.servlet&lt;/groupId&gt;<br class="calibre10"/>  &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;<br class="calibre10"/>  &lt;version&gt;3.0.1&lt;/version&gt;<br class="calibre10"/>&lt;/dependency&gt;</p></div>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.servlet;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.CityService;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.WebApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.support.WebApplicationContextUtils;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.RequestDispatcher;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletException;</span><br class="calibre10"/><span class="FontName">import javax.servlet.annotation.WebServlet;</span><br class="calibre10"/><span class="FontName">import javax.servlet.http.HttpServlet;</span><br class="calibre10"/><span class="FontName">import javax.servlet.http.HttpServletRequest;</span><br class="calibre10"/><span class="FontName">import javax.servlet.http.HttpServletResponse;</span><br class="calibre10"/><span class="FontName">import java.io.IOException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class DistanceServlet extends HttpServlet {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private CityService cityService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void init() throws ServletException {</span><br class="calibre10"/>        <span class="FontName">WebApplicationContext context;</span><br class="calibre10"/>        <span class="FontName">context =WebApplicationContextUtils.getRequiredWebApplicationContext(getServletContext());</span><br class="calibre10"/>        <span class="FontName">cityService = context.getBean(CityService.class);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void doGet(HttpServletRequest request, HttpServletResponse response)</span><br class="calibre10"/>        <span class="FontName">throws ServletException, IOException {</span><br class="calibre10"/>        <span class="FontName">forward(request, response);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void doPost(HttpServletRequest request, HttpServletResponse response)</span><br class="calibre10"/>        <span class="FontName">throws ServletException, IOException {</span><br class="calibre10"/>        <span class="FontName">String srcCity = request.getParameter("srcCity");</span><br class="calibre10"/>        <span class="FontName">String destCity = request.getParameter("destCity");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">double distance = cityService.findDistance(srcCity, destCity);</span><br class="calibre10"/>        <span class="FontName">request.setAttribute("distance", distance);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">forward(request, response);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private void forward(HttpServletRequest request, HttpServletResponse response)</span><br class="calibre10"/>        <span class="FontName">throws ServletException, IOException {</span><br class="calibre10"/>        <span class="FontName">RequestDispatcher dispatcher = request.getRequestDispatcher("WEB-INF/jsp/distance.jsp");</span><br class="calibre10"/>        <span class="FontName">dispatcher.forward(request, response);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This servlet needs to access the <span class="FontName">cityService</span> bean declared in the Spring IoC container to find distances. As Spring’s application context is stored in the servlet context, you can retrieve it through the <span class="FontName">WebApplicationContextUtils.</span><span class="FontName">getRequiredWebApplicationContext()</span><a id="cXXX.628" class="calibre5"></a> method by passing in a servlet context. The dependency lookup is done in the servlets <span class="FontName">init</span> method.</p>
<p class="indent">To allow users to query distances between cities, you have to create a JSP file that contains a form. You can name it <span class="FontName">distance.jsp</span> and put it in the <span class="FontName">WEB-INF/jsp</span> directory to prevent direct access to it. There are two text fields in this form for users to input the source and destination cities. There’s also a table grid for showing the actual distance.</p>
<pre class="calibre11"><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;City Distance&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;form method="POST"&gt;</span><br class="calibre10"/><span class="FontName">&lt;table&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Source City&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;input type="text" name="srcCity" value="${param.srcCity}" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Destination City&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;input type="text" name="destCity" value="${param.destCity}" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Distance&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;${distance}&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td colspan="2"&gt;&lt;input type="submit" value="Find" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/><span class="FontName">&lt;/table&gt;</span><br class="calibre10"/><span class="FontName">&lt;/form&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">Finally you need to tie everything together by loading the configuration using a <span class="FontName">ContextLoaderListener</span> and we need to register the <span class="FontName">DistanceServlet</span> and map it to the URL pattern <span class="FontName">/distance</span>. For this create a class that implements the <span class="FontName">ServletContainerInitializer</span> interface<a id="cXXX.629" class="calibre5"></a>. This class is used by the Servlet container (Tomcat for instance) to bootstrap your application. This interface is part of the Servlet specification since version 3.0.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.servlet;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.config.DistanceConfiguration;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.ContextLoaderListener;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.support.AnnotationConfigWebApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.ServletContainerInitializer;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletContext;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletException;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletRegistration;</span><br class="calibre10"/><span class="FontName">import java.util.Set;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class DistanceApplicationInitializer implements ServletContainerInitializer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void onStartup(Set&lt;Class&lt;?&gt;&gt;c, ServletContext ctx) throws ServletException {</span><br class="calibre10"/>        <span class="FontName">// Register the ContextLoaderListener</span><br class="calibre10"/>        <span class="FontName">AnnotationConfigWebApplicationContext appContext = new AnnotationConfigWebApplicationContext();</span><br class="calibre10"/>        <span class="FontName">appContext.register(DistanceConfiguration.class);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ctx.addListener(new ContextLoaderListener(appContext));</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Register the Servlet</span><br class="calibre10"/>        <span class="FontName">ServletRegistration.Dynamic registration = ctx.addServlet("distance", new DistanceServlet());</span><br class="calibre10"/>        <span class="FontName">registration.setLoadOnStartup(1);</span><br class="calibre10"/>        <span class="FontName">registration.addMapping("/distance");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">First an instance of the <span class="FontName">AnnotationConfigWebApplicationContext</span> is created and is passed the <span class="FontName">DistanceConfiguration</span> class. Next an instance of the <span class="FontName">ContextLoaderListener</span> is created and handed the earlier created application context. The next part registers the servlet under the name <span class="FontName">distance</span> and is mapped to the <span class="FontName">/distance</span> url pattern. The <span class="FontName">loadOnStartup</span> property makes sure the servlet is started as soon as the application starts.</p>
<p class="indent">Finally you need to create a file named <span class="FontName">javax.servlet.ServletContainerInitializer</span><a id="cXXX.630" class="calibre5"></a> inside the <span class="FontName">/META-INF/services</span> directory, the content of the file is the fully qualified classname of the <span class="FontName">DistanceServletContainerInitializer</span>. The servlet container uses this file to determine which <span class="FontName">ServletContainerInitializer</span> need to be executed.</p>
<pre class="calibre11"><span class="FontName">com.apress.springrecipes.city.servlet.DistanceApplicationInitializer</span></pre>
<p class="indent">Now, you can deploy this web application to a web container (e.g., Apache Tomcat 7.x). By default, Tomcat listens on port 8080, so if you deploy your application to the <span class="FontName">city</span> context path, you can access it with the following URL once it has been started up: <span class="FontName">http://localhost:8080/city/distance</span>.</p>
<p class="indent">When using Spring instead of implementing the <span class="FontName">ServletContainerInitializer</span> you can also use the Spring-provided <span class="FontName">WebApplicationInitializer</span> interface. Spring automatically detects the classes implementing this interface and will use them to bootstrap the application. Added benefit is that you don’t need the <span class="FontName">javax.servlet.ServletContainerInitializer</span> file anymore.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.servlet;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.config.DistanceConfiguration;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.WebApplicationInitializer;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.ContextLoaderListener;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.support.AnnotationConfigWebApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.ServletContext;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletException;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletRegistration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class DistanceApplicationInitializer</span> <b class="calibre4">implements WebApplicationInitializer</b> <span class="FontName">{</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void onStartup(ServletContext ctx) throws ServletException {</span><br class="calibre10"/>        <span class="FontName">// Register the ContextLoaderListener</span><br class="calibre10"/>        <span class="FontName">AnnotationConfigWebApplicationContext appContext = new AnnotationConfigWebApplicationContext();</span><br class="calibre10"/>        <span class="FontName">appContext.register(DistanceConfiguration.class);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ctx.addListener(new ContextLoaderListener(appContext));</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Register the Servlet</span><br class="calibre10"/>        <span class="FontName">ServletRegistration.Dynamic registration = ctx.addServlet("distance", new DistanceServlet());</span><br class="calibre10"/>        <span class="FontName">registration.setLoadOnStartup(1);</span><br class="calibre10"/>        <span class="FontName">registration.addMapping("/distance");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec5" class="Heading">9-2. Using Spring in Your Servlets and Filters<a id="cXXX.631" class="calibre6"></a></p>
<p id="Sec6" class="Heading1">Problem</p>
<p class="noindent">The servlet specification provides servlets and filters. Servlets handle requests and responses and are responsible ultimately for producing output and acting on the inbound request. Filters are given the opportunity to react to the state of a given request and response before and after the servlet to which a request is destined has processed it. Filters provide the same effect as aspect-oriented programming<a id="cXXX.632" class="calibre5"></a>, which lets you intercept and modify the state of a method invocation. Filters can be added in arbitrary depths to any existing servlet. It is possible, thus, to reuse filters to provide generic functionality to any servlet, such as gzip compression. These artifacts are declared in the <span class="FontName">web.xml</span> file<a id="cXXX.633" class="calibre5"></a>. The servlet container reads the configuration and instantiates the servlets or filters on your behalf and manages the life cycles of these objects inside the container. Because the life cycle is handled by the servlet container, and not by Spring, accessing the services of the Spring container—for example using traditional dependency injection and AOP—proves difficult. You can use <span class="FontName">WebApplicationContextUtils</span> to look up and acquire the dependencies you need, but that defeats the value proposition of dependency injection—your code is required to acquire instances explicitly, which is not much better than using JNDI, for example. It is desirable to let Spring handle dependency injection for you and to let Spring manage the life cycles of your beans.</p>
<p id="Sec7" class="Heading1">Solution</p>
<p class="noindent">If you want to implement filter-like functionality but want to have full access to the Spring context’s life cycle machinery and dependency injection, use the <span class="FontName">DelegatingFilterProxy</span> class. Similarly, if you want to implement servlet-like functionality but want to have full access to the Spring context’s life cycle machinery and dependency injection, use <span class="FontName">HttpRequestHandlerServlet</span>. These classes are configured normally in <span class="FontName">web.xml</span>, but they then delegate their obligations to a bean that you configure in the Spring application context.</p>
<p id="Sec8" class="Heading1">How It Works</p>
<p id="Sec9" class="Heading2">Servlets</p>
<p class="noindent">Let’s revisit our previous example. Suppose we wanted to rewrite the servlet functionality to leverage Spring’s application context machinery and configuration. The <span class="FontName">HttpRequestHandlerServlet</span> will handle this for us. It uses a little bit of indirection to achieve its work: you configure an instance of <span class="FontName">org.springframework.web.context.support.HttpRequestHandlerServlet</span> and assign it a name. The servlet takes the name as configured and looks up a bean in the root Spring application context. Assuming the bean exists and that it implements the <span class="FontName">HttpRequestHandler</span> interface, the servlet delegates all requests to that bean by invoking the <span class="FontName">handleRequest</span> method.</p>
<p class="indent">You must first write a bean that implements the <span class="FontName">org.springframework.web.</span><span class="FontName">HttpRequestHandler</span> interface<a id="cXXX.634" class="calibre5"></a>. We will endeavor to replace our existing <span class="FontName">DistanceServlet</span> with a POJO that implements the <span class="FontName">HttpRequestHandler</span> interface. The logic is identical; it’s just been reorganized a bit. The POJO’s definition is as follows:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.servlet;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.CityService;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.HttpRequestHandler;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.RequestDispatcher;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletException;</span><br class="calibre10"/><span class="FontName">import javax.servlet.http.HttpServletRequest;</span><br class="calibre10"/><span class="FontName">import javax.servlet.http.HttpServletResponse;</span><br class="calibre10"/><span class="FontName">import java.io.IOException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class DistanceHttpRequestHandler implements HttpRequestHandler {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private final CityService cityService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public DistanceHttpRequestHandler(CityService cityService) {</span><br class="calibre10"/>        <span class="FontName">this.cityService = cityService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void handleRequest(final HttpServletRequest request, final HttpServletResponse response)</span><br class="calibre10"/>        <span class="FontName">throws ServletException, IOException {</span><br class="calibre10"/>        <span class="FontName">if (request.getMethod().toUpperCase().equals("POST")) {</span><br class="calibre10"/>            <span class="FontName">String srcCity = request.getParameter("srcCity");</span><br class="calibre10"/>            <span class="FontName">String destCity = request.getParameter("destCity");</span><br class="calibre10"/>            <span class="FontName">double distance = cityService.findDistance(srcCity, destCity);</span><br class="calibre10"/>            <span class="FontName">request.setAttribute("distance", distance);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">forward(request, response);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private void forward(HttpServletRequest request, HttpServletResponse response)</span><br class="calibre10"/>        <span class="FontName">throws ServletException, IOException {</span><br class="calibre10"/>        <span class="FontName">RequestDispatcher dispatcher = request.getRequestDispatcher("WEB-INF/jsp/distance.jsp");</span><br class="calibre10"/>        <span class="FontName">dispatcher.forward(request, response);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now, we must wire the bean up in the configuration class like so:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.config;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.servlet.DistanceHttpRequestHandler;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class DistanceConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public CityService cityService() { ... }</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Bean</b><br class="calibre10"/>    <b class="calibre4">public DistanceHttpRequestHandler distance() {</b><br class="calibre10"/>        <b class="calibre4">return new DistanceHttpRequestHandler(cityService());</b><br class="calibre10"/>    <b class="calibre4">}</b><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Here, we’ve configured our bean and injected a reference to the <span class="FontName">CityServiceImpl</span><a id="cXXX.635" class="calibre5"></a> instance. The bean will be available under the name <span class="FontName">distance</span> as Spring by default used the method name as the bean name. We need this to configure the <span class="FontName">HttpRequestHandlerServlet</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.servlet;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.config.DistanceConfiguration;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.WebApplicationInitializer;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.ContextLoaderListener;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.support.AnnotationConfigWebApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.support.HttpRequestHandlerServlet;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.ServletContext;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletException;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletRegistration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class DistanceApplicationInitializer implements WebApplicationInitializer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void onStartup(ServletContext ctx) throws ServletException {</span><br class="calibre10"/>        <span class="FontName">// Register the ContextLoaderListener</span><br class="calibre10"/>        <span class="FontName">AnnotationConfigWebApplicationContext appContext = new AnnotationConfigWebApplicationContext();</span><br class="calibre10"/>        <span class="FontName">appContext.register(DistanceConfiguration.class);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ctx.addListener(new ContextLoaderListener(appContext));</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Register the Servlet</span><br class="calibre10"/>        <span class="FontName">ServletRegistration.Dynamic registration = ctx.addServlet("distance",</span><br class="calibre10"/>        <b class="calibre4">new HttpRequestHandlerServlet()</b><span class="FontName">);</span><br class="calibre10"/>        <span class="FontName">registration.setLoadOnStartup(1);</span><br class="calibre10"/>        <span class="FontName">registration.addMapping("/distance");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The use of the bean is identical as in the previous application—all code referencing the <span class="FontName">/distance</span> endpoint will continue to work from the perspective of a bean. Try it yourself by launching your browser and pointing it to <span class="FontName">http://localhost:8080/city/distance?srcCity=New%20York&amp;destCity=London</span>.</p>
<p id="Sec10" class="Heading3">Filters<a id="cXXX.2041" class="calibre6"></a></p>
<p class="noindent">The Spring framework provides a similar feature for filters. We will demonstrate a suitably simple filter configuration that simply iterates through the inbound request’s request attributes and lists them. Here, we will use a collaborating object, of type <span class="FontName">CityServiceRequestAuditor</span>, whose function it is to enumerate the request parameters (conceivably, such a filter could be used to send the data to syslog, to a monitoring agent like Splunk™ or through JMX). The source code for <span class="FontName">CityServiceRequestAuditor</span><a id="cXXX.636" class="calibre5"></a> is as follows:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.Map;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class CityServiceRequestAuditor {</span><br class="calibre10"/>    <span class="FontName">public void log(Map&lt;String, String&gt; attributes) {</span><br class="calibre10"/>        <span class="FontName">for (String k : attributes.keySet()) {</span><br class="calibre10"/>            <span class="FontName">System.out.println(String.format("%s=%s", k, attributes.get(k)));</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span></pre>
<p class="indent">In the servlet example, the <span class="FontName">HttpRequestHandlerServlet</span> delegated to another object that implemented an interface—<span class="FontName">HttpRequestHandler</span>—that was considerably simpler than that of a raw servlet. In the <span class="FontName">javax.servlet.Filter</span> case, however, there is very little that can be done to simplify the interface, so we will instead delegate to an implementation of filter that’s been configured using Spring.</p>
<p class="indent">Our filter implementation is as follows:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.filter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.CityServiceRequestAuditor;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.*;</span><br class="calibre10"/><span class="FontName">import java.io.IOException;</span><br class="calibre10"/><span class="FontName">import java.util.Map;</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/><span class="FontName">/**</span><br class="calibre10"/> <span class="FontName">* This class is designed to intercept requests to the {@link</span><br class="calibre10"/> <span class="FontName">com.apress.springrecipes.city.CityServiceImpl} and log them</span><br class="calibre10"/> <span class="FontName">*/</span><br class="calibre10"/><span class="FontName">public class CityServiceRequestFilter implements Filter {</span><br class="calibre10"/>    <span class="FontName">private CityServiceRequestAuditor cityServiceRequestAuditor;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void init(final FilterConfig filterConfig) throws ServletException {</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Override</b><br class="calibre10"/>    <b class="calibre4">public void doFilter(final ServletRequest servletRequest,</b><br class="calibre10"/><b class="calibre4">                               final ServletResponse servletResponse,<br class="calibre10"/>                               final FilterChain filterChain)</b><br class="calibre10"/>        <b class="calibre4">throws IOException, ServletException {</b><br class="calibre10"/>        <b class="calibre4">Map parameterMap = servletRequest.getParameterMap();</b><br class="calibre10"/><br class="calibre10"/>        <b class="calibre4">this.cityServiceRequestAuditor.log(parameterMap);</b><br class="calibre10"/><br class="calibre10"/>        <b class="calibre4">filterChain.doFilter(servletRequest, servletResponse);</b><br class="calibre10"/>    <b class="calibre4">}</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void destroy() {</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setCityServiceRequestAuditor(</span><br class="calibre10"/>      <span class="FontName">final CityServiceRequestAuditorcityServiceRequestAuditor) {</span><br class="calibre10"/>        <span class="FontName">this.cityServiceRequestAuditor = cityServiceRequestAuditor;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">It has a dependency on a bean of type <span class="FontName">CityServiceRequestAuditor</span>. We will inject it and configure this bean in our Spring application context, below the previous configuration.</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans-3.0.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>   <span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">&lt;bean id="cityServiceRequestAuditor"</b><br class="calibre10"/>          <b class="calibre4">class="com.apress.springrecipes.city.CityServiceRequestAuditor" /&gt;</b><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">&lt;bean id="cityServiceRequestFilter"</b><br class="calibre10"/>          <b class="calibre4">class="com.apress.springrecipes.city.filter.CityServiceRequestFilter"&gt;</b><br class="calibre10"/>        <b class="calibre4">&lt;property name="cityServiceRequestAuditor" ref="cityServiceRequestAuditor" /&gt;</b><br class="calibre10"/>    <b class="calibre4">&lt;/bean&gt;</b><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">Now, all that remains is to setup the Spring <span class="FontName">org.springframework.web.filter.</span><span class="FontName">DelegatingFilterProxy</span><a id="cXXX.637" class="calibre5"></a> instance in <span class="FontName">web.xml</span>. This configuration maps the filter to the <span class="FontName">distance</span> servlet we configured earlier.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.servlet;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.config.DistanceConfiguration;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.WebApplicationInitializer;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.ContextLoaderListener;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.support.AnnotationConfigWebApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.support.HttpRequestHandlerServlet;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.filter.DelegatingFilterProxy;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.FilterRegistration;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletContext;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletException;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletRegistration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class DistanceApplicationInitializer implements WebApplicationInitializer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void onStartup(ServletContext ctx) throws ServletException {</span><br class="calibre10"/>        <span class="FontName">// Register the ContextLoaderListener</span><br class="calibre10"/>        <span class="FontName">AnnotationConfigWebApplicationContext appContext = new AnnotationConfigWebApplicationContext();</span><br class="calibre10"/>        <span class="FontName">appContext.register(DistanceConfiguration.class);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ctx.addListener(new ContextLoaderListener(appContext));</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Register the Servlet</span><br class="calibre10"/>        <span class="FontName">ServletRegistration.Dynamic registration = ctx.addServlet("distance", new HttpRequestHandlerServlet());</span><br class="calibre10"/>        <span class="FontName">registration.setLoadOnStartup(1);</span><br class="calibre10"/>        <span class="FontName">registration.addMapping("/distance");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">//Register the Filter</span><br class="calibre10"/>        <b class="calibre4">FilterRegistration.Dynamic filterReg = ctx.addFilter("cityServiceRequestFilter", new DelegatingFilterProxy());</b><br class="calibre10"/>        <b class="calibre4">filterReg.addMappingForServletNames(null, false, "distance");</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Again, note the use of engineered coincidence; the name of the filter, <span class="FontName">cityServiceRequestFilter</span> , is used to determine which bean in the root Spring application context to look up and delegate to. You might notice a bit of redundancy here: the filter interface exposes two methods for life cycle management—<span class="FontName">init</span> and <span class="FontName">destroy</span>—and the Spring context also provides life cycle management<a id="cXXX.638" class="calibre5"></a> for your beans. The default behavior of the <span class="FontName">DelegatingFilterProxy</span> is to <i class="calibre8">not</i> delegate those life cycle methods to your bean, preferring instead to let the Spring life cycle machinery (<span class="FontName">InitializingBean</span>, <span class="FontName">@PostConstruct</span>, etc. for initialization and <span class="FontName">DisposableBean</span>, <span class="FontName">@PreDestroy</span>, etc. for destruction) work instead. If you’d like to have Spring invoke those life cycle methods for you, set the <span class="FontName">targetFilterLifecycle</span> property to true on the filter:</p>
<pre class="calibre11"><span class="FontName">public class DistanceApplicationInitializer implements WebApplicationInitializer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void onStartup(ServletContext ctx) throws ServletException {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">DelegatingFilterProxy delegatingFilter = new DelegatingFilterProxy();</span><br class="calibre10"/>        <b class="calibre4">delegatingFilter.setTargetFilterLifecycle(true);</b><br class="calibre10"/>        <span class="FontName">FilterRegistration.Dynamic filterReg = ctx.addFilter("cityServiceRequestFilter", delegatingFilter);</span><br class="calibre10"/>        <span class="FontName">filterReg.addMappingForServletNames(null, false, "distance");</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec11" class="Heading">9-3. Integrating Spring with JSF</p>
<p id="Sec12" class="Heading1">Problem</p>
<p class="noindent">You would like to access beans declared in the Spring IoC container<a id="cXXX.639" class="calibre5"></a> in a web application developed with JSF.</p>
<p id="Sec13" class="Heading1">Solution</p>
<p class="noindent">A JSF application is able to access Spring’s application context just like a generic web application (i.e., by registering the servlet listener <span class="FontName">ContextLoaderListener</span> and accessing it from the servlet context). However, due to the similarity between Spring’s and JSF’s bean models, it’s very easy to integrate them by registering the Spring-provided JSF variable resolver <span class="FontName">DelegatingVariableResolver</span> (for JSF 1.1) or the <span class="FontName">SpringBeanFacesELResolver</span><a id="cXXX.640" class="calibre5"></a> (for JSF 1.2 and greater), which can resolve JSF variables into Spring beans. Furthermore, you can even declare JSF managed beans in Spring’s bean configuration file to centralize them with your Spring beans.</p>
<p id="Sec14" class="Heading1">How It Works</p>
<p class="noindent">Suppose you are going to implement your web application for finding city distances using JSF. First, you create the following directory structure for your web application.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  Before you start developing a web application using JSF, you need a JSF implementation library. You can use the JSF Reference Implementation (JSF-RI) or a third-party implementation. If you are using Maven, add the following dependencies to your Maven project:</p>
<p class="paraaftertitle">&lt;dependency&gt;<br class="calibre10"/>  &lt;groupId&gt;javax.servlet&lt;/groupId&gt;<br class="calibre10"/>  &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;<br class="calibre10"/>  &lt;version&gt;3.0.1&lt;/version&gt;<br class="calibre10"/>&lt;/dependency&gt;<br class="calibre10"/><br class="calibre10"/>&lt;dependency&gt;<br class="calibre10"/>  &lt;groupId&gt;com.sun.faces&lt;/groupId&gt;<br class="calibre10"/>  &lt;artifactId&gt;jsf-api&lt;/artifactId&gt;<br class="calibre10"/>  &lt;version&gt;2.2.7&lt;/version&gt;<br class="calibre10"/>&lt;/dependency&gt;<br class="calibre10"/><br class="calibre10"/>&lt;dependency&gt;<br class="calibre10"/>  &lt;groupId&gt;com.sun.faces&lt;/groupId&gt;<br class="calibre10"/>  &lt;artifactId&gt;jsf-impl&lt;/artifactId&gt;<br class="calibre10"/>  &lt;version&gt;2.2.7&lt;/version&gt;<br class="calibre10"/>&lt;/dependency&gt;<br class="calibre10"/><br class="calibre10"/>&lt;dependency&gt;<br class="calibre10"/>  &lt;groupId&gt;org.apache.taglibs&lt;/groupId&gt;<br class="calibre10"/>  &lt;artifactId&gt;taglibs-standard-spec&lt;/artifactId&gt;<br class="calibre10"/>  &lt;version&gt;1.2.1&lt;/version&gt;<br class="calibre10"/>&lt;/dependency&gt;<br class="calibre10"/><br class="calibre10"/>&lt;dependency&gt;<br class="calibre10"/>  &lt;groupId&gt;org.apache.taglibs&lt;/groupId&gt;<br class="calibre10"/>  &lt;artifactId&gt;taglibs-standard-impl&lt;/artifactId&gt;<br class="calibre10"/>  &lt;version&gt;1.2.1&lt;/version&gt;<br class="calibre10"/>&lt;/dependency&gt;</p></div>
<p class="indent">As of JSF 2.1 the necessary JSF components are registered by default. The FacesServlet, needed to handle web requests, is configured by default and is mapped to the following patterns <span class="FontName">/faces/*</span>, <span class="FontName">*.faces</span> and <span class="FontName">*.jsf</span>. It is however very common to map it to <span class="FontName">*.xhtml</span> also. Using our <span class="FontName">DistanceApplicationInitializer</span><a id="cXXX.641" class="calibre5"></a> we can add a mapping for this pattern.</p>
<p class="indent">To load Spring’s application context at startup, you also have to register the servlet listener <span class="FontName">ContextLoaderListener</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.servlet;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.config.DistanceConfiguration;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.WebApplicationInitializer;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.ContextLoaderListener;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.support.AnnotationConfigWebApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.ServletContext;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class DistanceApplicationInitializer implements WebApplicationInitializer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void onStartup(ServletContext ctx) throws ServletException {</span><br class="calibre10"/>        <span class="FontName">// Register the ContextLoaderListener</span><br class="calibre10"/>        <span class="FontName">AnnotationConfigWebApplicationContext appContext = new AnnotationConfigWebApplicationContext();</span><br class="calibre10"/>        <span class="FontName">appContext.register(DistanceConfiguration.class);</span><br class="calibre10"/>        <span class="FontName">ctx.addListener(new ContextLoaderListener(appContext));</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Configure facelets to use xhtml instead of jsp extension</span><br class="calibre10"/>        <b class="calibre4">ctx.setInitParameter("javax.faces.DEFAULT_SUFFIX", ".xhtml");</b><br class="calibre10"/>        <span class="FontName">// Map the FacesServlet to *.xhtml</span><br class="calibre10"/>        <b class="calibre4">ctx.getServletRegistration("FacesServlet").addMapping("*.xhtml");</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice the init parameter when <span class="FontName">FacesServlet</span> receives a request, it will map this request to a file with the same name with the configured suffix (default is .jsp). For example, if you request the URL <span class="FontName">/distance.faces</span>, then <span class="FontName">FacesServlet</span> will load <span class="FontName">/distance.jsp</span> accordingly. Instead of <span class="FontName">.jsp</span> you want to switch it to .xhtml, for that set the <span class="FontName">javax.faces.DEFAULT_SUFFIX</span> init parameter to .xhtml.</p>
<p class="indent">Next the default registered <span class="FontName">FacesServlet</span>, named <span class="FontName">FacesServlet</span>, is looked up and a mapping to <span class="FontName">*.xhtml</span> is added.</p>
<p class="indent">The basic idea of JSF is to separate presentation logic from UIs by encapsulating it in one or more JSF managed beans. For your distance-finding function, you can create the following <span class="FontName">DistanceBean</span> class<a id="cXXX.642" class="calibre5"></a> for a JSF managed bean:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.jsf;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.CityService;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.faces.bean.ManagedBean;</span><br class="calibre10"/><span class="FontName">import javax.faces.bean.ManagedProperty;</span><br class="calibre10"/><span class="FontName">import javax.faces.bean.RequestScoped;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@ManagedBean</span><br class="calibre10"/><span class="FontName">@RequestScoped</span><br class="calibre10"/><span class="FontName">public class DistanceBean {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String srcCity;</span><br class="calibre10"/>    <span class="FontName">private String destCity;</span><br class="calibre10"/>    <span class="FontName">private double distance;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@ManagedProperty("#{cityService}")</span><br class="calibre10"/>    <span class="FontName">private CityService cityService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public String getSrcCity() {</span><br class="calibre10"/>        <span class="FontName">return srcCity;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public String getDestCity() {</span><br class="calibre10"/>        <span class="FontName">return destCity;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double getDistance() {</span><br class="calibre10"/>        <span class="FontName">return distance;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setSrcCity(String srcCity) {</span><br class="calibre10"/>        <span class="FontName">this.srcCity = srcCity;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setDestCity(String destCity) {</span><br class="calibre10"/>        <span class="FontName">this.destCity = destCity;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setCityService(CityService cityService) {</span><br class="calibre10"/>        <span class="FontName">this.cityService = cityService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void find() {</span><br class="calibre10"/>        <span class="FontName">distance = cityService.findDistance(srcCity, destCity);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Due to the <span class="FontName">@RequestScope</span> annotation the scope of <span class="FontName">DistanceBean</span> is <span class="FontName">request</span>, which means a new bean instance will be created on each request. There are four properties defined in this bean. As your page has to show the <span class="FontName">srcCity</span>, <span class="FontName">destCity</span>, and <span class="FontName">distance</span> properties, you define a getter method for each of them. Users can only input the <span class="FontName">srcCity</span> and <span class="FontName">destCity</span> properties, so they require a setter method as well. The back-end <span class="FontName">CityService</span> bean is injected via a setter method, which is mandated when using a <span class="FontName">@ManagedProperty</span>. When the <span class="FontName">find()</span> metho<a id="cXXX.643" class="calibre5"></a>d is called on this bean, it will invoke the back-end service to find the distance between these two cities and then store it in the <span class="FontName">distance</span> property for subsequent display.</p>
<p class="indent">Then, you create <span class="FontName">distance.xhtml</span><a id="cXXX.644" class="calibre5"></a>  in the root of your web application context. You have to put it here because when <span class="FontName">FacesServlet</span> receives a request, it will map this request to a file with the same name with the configured suffix (default is .jsp). For example, if you request the URL <span class="FontName">/distance.faces</span>, then <span class="FontName">FacesServlet</span> will load <span class="FontName">/distance.xhtml</span> accordingly. (Remember that you configured the .<span class="FontName">xhtml</span> suffix in the <span class="FontName">DistanceApplicationInitializer</span>).</p>
<pre class="calibre11"><span class="FontName">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br class="calibre10"/><span class="FontName">&lt;!DOCTYPE html&gt;</span><br class="calibre10"/><span class="FontName">&lt;html xmlns="</span><span class="FontName"><a href="http://www.w3.org/1999/xhtml" class="calibre5">http://www.w3.org/1999/xhtml</a></span><span class="FontName">"</span><br class="calibre10"/>      <span class="FontName">xmlns:f="</span><span class="FontName"><a href="http://xmlns.jcp.org/jsf/core" class="calibre5">http://xmlns.jcp.org/jsf/core</a></span><span class="FontName">"</span><br class="calibre10"/>      <span class="FontName">xmlns:h="</span><span class="FontName"><a href="http://xmlns.jcp.org/jsf/html" class="calibre5">http://xmlns.jcp.org/jsf/html</a></span><span class="FontName">" xml:lang="en" lang="en"&gt;</span><br class="calibre10"/><span class="FontName">&lt;h:head&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;title&gt;City Distance&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/h:head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;h:body&gt;</span><br class="calibre10"/><span class="FontName">&lt;f:view&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;h:form&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;h:panelGrid columns="2"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;h:outputLabel for="srcCity"&gt;Source City&lt;/h:outputLabel&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;h:inputText id="srcCity" value="#{distanceBean.srcCity}"/&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;h:outputLabel for="destCity"&gt;Destination City&lt;/h:outputLabel&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;h:inputText id="destCity" value="#{distanceBean.destCity}"/&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;h:outputLabel&gt;Distance&lt;/h:outputLabel&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;h:outputText value="#{distanceBean.distance}"/&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;h:commandButton value="Find" action="#{distanceBean.find()}"/&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/h:panelGrid&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/h:form&gt;</span><br class="calibre10"/><span class="FontName">&lt;/f:view&gt;</span><br class="calibre10"/><span class="FontName">&lt;/h:body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">This XHTML file contains an <span class="FontName">&lt;h:form&gt;</span> component for users to input a source city and a destination city. These two fields are defined using two <span class="FontName">&lt;h:inputText&gt;</span> components, whose values are bound to a JSF managed bean’s properties. The distance result is defined using an <span class="FontName">&lt;h:outputText&gt;</span> component because its value is read-only. Finally, you define an <span class="FontName">&lt;h:commandButton&gt;</span> component whose action will be triggered on the server side when you click it.</p>
<p id="Sec15" class="Heading2">Resolving Spring Beans in JSF</p>
<p class="noindent">The JSF configuration file <span class="FontName">faces-config.xml</span>, located in the root of <span class="FontName">WEB-INF</span>, is where you configure your navigation rules and JSF managed beans. For this simple application with only one screen, there’s no navigation rule to configure. You can simply configure the preceding <span class="FontName">DistanceBean</span> here. Here is the configuration file we might use for JSF 1.2 and up (note the sample uses JSF 2.2):</p>
<pre class="calibre11"><span class="FontName">&lt;?xml version='1.0' encoding='UTF-8'?&gt;</span><br class="calibre10"/><span class="FontName">&lt;faces-config version="2.2"  xmlns="</span><span class="FontName"><a href="http://xmlns.jcp.org/xml/ns/javaee" class="calibre5">http://xmlns.jcp.org/xml/ns/javaee</a></span><span class="FontName">"</span><br class="calibre10"/>              <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>              <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://xmlns.jcp.org/xml/ns/javaee" class="calibre5">http://xmlns.jcp.org/xml/ns/javaee</a></span><br class="calibre10"/>    <span class="FontName"><a href="http://xmlns.jcp.org/xml/ns/javaee/web-facesconfig_2_2.xsd" class="calibre5">http://xmlns.jcp.org/xml/ns/javaee/web-facesconfig_2_2.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;application&gt;</span><br class="calibre10"/>        <b class="calibre4">&lt;el-resolver&gt;org.springframework.web.jsf.el.SpringBeanFacesELResolver&lt;/el-resolver&gt;</b><br class="calibre10"/>    <span class="FontName">&lt;/application&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/faces-config&gt;</span></pre>
<p class="indent">Note that by registering the variable resolver the <span class="FontName">SpringBeanFacesELResolver</span>, you can easily refer to a bean declared in Spring’s application context as a JSF variable in the form of <span class="FontName">#{beanName}</span>. This variable resolver will first attempt to resolve variables from the original JSF variable resolver. If a variable cannot be resolved, this variable resolver will look up Spring’s application context for a bean with the same name.</p>
<p class="indent">Now, you can deploy this application to your web container and access it through the URL <span class="FontName">http://localhost:8080/city/distance.xhtml</span>.</p>
<p id="Sec16" class="Heading2">Declaring JSF Managed Beans in Spring’s Bean Configuration File</p>
<p class="noindent">By registering <span class="FontName">DelegatingVariableResolver</span><a id="cXXX.645" class="calibre5"></a>, you can refer to beans declared in Spring from JSF managed beans. However, they are managed by two different containers: JSF’s and Spring’s. A better solution is to centralize them under the management of Spring’s IoC container. Let’s remove the managed bean declaration from the JSF configuration file and add the following Spring bean declaration in <span class="FontName">applicationContext.xml</span>:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.config;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.city.jsf.DistanceBean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Scope;</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class DistanceConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public CityService cityService() { ... }</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Bean</b><br class="calibre10"/>    <b class="calibre4">@Scope("request")</b><br class="calibre10"/>    <b class="calibre4">public DistanceBean distanceBean() {</b><br class="calibre10"/>        <b class="calibre4">DistanceBean distanceBean = new DistanceBean();</b><br class="calibre10"/>        <b class="calibre4">distanceBean.setCityService(cityService());</b><br class="calibre10"/>        <b class="calibre4">return distanceBean;</b><br class="calibre10"/>    <b class="calibre4">}</b><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">To enable the <span class="FontName">request</span> bean scope in Spring’s application context, you have to register <span class="FontName">RequestContextListener</span> in the <span class="FontName">DistanceApplicationInitializer</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.city.servlet;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.request.RequestContextListener;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class DistanceApplicationInitializer implements WebApplicationInitializer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void onStartup(ServletContext ctx) throws ServletException {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">ctx.addListener(new</span> <span class="FontName">RequestContextListener</span><span class="FontName">());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec17" class="Heading">Summary</p>
<p class="noindent">In this chapter, you have learned how to integrate Spring into web applications developed with Servlet/JSP and popular web application frameworks like JSF. The integration mainly focuses on accessing beans declared in the Spring IoC container within these frameworks.</p>
<p class="indent">In a generic web application, regardless of which framework it uses, you can register the Spring-provided servlet listener <span class="FontName">ContextLoaderListener</span> to load Spring’s application context into the servlet context of this web application. Later, a servlet or any object that can access the servlet context will also be able to access Spring’s application context through a utility method.</p>
<p class="indent">For JSF, you can register the variable resolver <span class="FontName">DelegatingVariableResolver</span> to resolve JSF variables into Spring beans. Furthermore, you can even declare JSF managed beans in Spring’s bean configuration file to centralize them with Spring beans.</p></div>
</body></html>
