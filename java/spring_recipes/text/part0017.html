<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Chapter 7 Spring Security</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre"><p class="ChapterNumber"><a id="b9781430259084_8" class="calibre6"></a>CHAPTER 7</p>
<p class="Chapimage"><img src="../images/00008.jpeg" alt="image" class="calibre3"/></p>
<p class="ChapterTitle">Spring Security</p>
<div class="calibre10"><p class="noindent">In this chapter,<a id="cXXX.2211" class="calibre5"></a> you will learn how to secure applications using the Spring Security framework, a subproject of the Spring framework. Spring Security was initially known as Acegi Security, but its name has been changed since joining with the Spring Portfolio projects. Spring Security can be used to secure any Java application, but it’s mostly used for web-based applications. Web applications, especially those that can be accessed through the Internet, are vulnerable to hacker attacks if they are not secured properly.</p>
<p class="indent">If you’ve already used Spring Security, be advised there have been several changes introduced in the 3.0 release of the Spring Security framework, which was released almost in tandem with the 3.0 release of the Spring framework (i.e., core). These changes include feature enhancements like support for annotations and OpenID<a id="cXXX.511" class="calibre5"></a>, as well as a restructuring that includes class name changes and package partitioning (i.e., multiple JARs). This is especially important if you are running Spring Security 2.x code, on which the first edition of the book was based.</p>
<p class="indent">If, on the other hand, you’ve never handled security in an application, there are several terms and concepts that you must understand first. Authentication is the process of verifying a principal’s identity against what it claims to be. A principal can be a user, a device, or a system, but most typically, it’s a user. A principal has to provide evidence of identity to be authenticated. This evidence is called a credential, which is usually a password when the target principal is a user.</p>
<p class="indent">Authorization<a id="cXXX.512" class="calibre5"></a> is the process of granting authority to an authenticated user so that this user is allowed to access particular resources of the target application. The authorization process must be performed after the authentication process. Typically, authorities are granted in terms of roles.</p>
<p class="indent">Access control means controlling access to an application’s resources. It entails making a decision on whether a user is allowed to access a resource. This decision is called an access control decision, and it’s made by comparing the resource’s access attributes with the user’s granted authorities or other characteristics.</p>
<p class="indent">After finishing this chapter, you will understand basic security concepts and know how to secure your web applications at the URL access level, the method invocation level, the view-rendering level, and the domain object level.</p>
<p id="Sec1" class="Heading">7-1. Securing URL Access<a id="cXXX.2260" class="calibre6"></a><a id="cXXX.513" class="calibre6"></a></p>
<p id="Sec2" class="Heading1">Problem</p>
<p class="noindent">Many web applications have some particular URLs that are critically important and private. You must secure these URLs by preventing unauthorized access<a id="cXXX.514" class="calibre5"></a> to them.</p>
<p id="Sec3" class="Heading1">Solution</p>
<p class="noindent">Spring Security<a id="cXXX.515" class="calibre5"></a> enables you to secure a web application’s URL access in a declarative way through simple configuration. It handles security by applying servlet filters to HTTP requests. You can configure these filters in Spring’s bean configuration files using XML elements defined in the Spring Security schema. However, as servlet filters must be registered in the web deployment descriptor to take effect, you have to register a <span class="FontName">DelegatingFilterProxy</span> instance in the web deployment descriptor, which is a servlet filter that delegates request filtering to a filter in Spring’s application context.</p>
<p class="indent">Spring Security allows you to configure web application security through the <span class="FontName">&lt;http&gt;</span> element. If your web application’s security requirements are straightforward and typical, you can set this element’s <span class="FontName">auto-config</span> attribute to <span class="FontName">true</span> so that Spring Security will automatically register and configure several basic security services, including the following:</p>
<ul class="bulleted"><li class="calibre17">Form-based login service: This provides a default page that contains a login form for users to log into this application.</li>
<li class="calibre17">Logout service: This provides a handler mapped with a URL for users to log out of this application.</li>
<li class="calibre17">HTTP Basic authentication: This can process the Basic authentication credentials presented in HTTP request headers. It can also be used for authenticating requests made with remoting protocols and web services.</li>
<li class="calibre17">Anonymous login: This assigns a principal and grants authorities to an anonymous user so that you can handle an anonymous user like a normal user.</li>
<li class="calibre17">Remember-me support: This can remember a user’s identity across multiple browser sessions, usually by storing a cookie in the user’s browser.</li>
<li class="calibre17">Servlet API integration: This allows you to access security information in your web application via standard Servlet APIs, such as <span class="FontName">HttpServletRequest.isUserInRole()</span> and <span class="FontName">HttpServletRequest.getUserPrincipal()</span>.</li></ul>
<p class="indent">With these security services registered, you can specify the URL patterns that require particular authorities to access. Spring Security will perform security checks according to your configurations. A user must log into an application before accessing the secure URLs, unless these URLs are opened for anonymous access. Spring Security provides a set of authentication providers for you to choose from. An authentication provider authenticates a user and returns the authorities granted to this user.</p>
<p id="Sec4" class="Heading1">How It Works</p>
<p class="noindent">Suppose you are going to develop an online message board application for users to post their messages on. First, you create the domain class <span class="FontName">Message</span><a id="cXXX.516" class="calibre5"></a> with three properties: <span class="FontName">author</span>, <span class="FontName">title</span>, and <span class="FontName">body</span>:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.domain;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Message {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private Long id;</span><br class="calibre10"/>    <span class="FontName">private String author;</span><br class="calibre10"/>    <span class="FontName">private String title;</span><br class="calibre10"/>    <span class="FontName">private String body;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Getters and Setters</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Next, you define the operations of your message board in a service interface, including listing all messages, posting a message, deleting a message, and finding a message by its ID:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public interface MessageBoardService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public List&lt;Message&gt; listMessages();</span><br class="calibre10"/>    <span class="FontName">public void postMessage(Message message);</span><br class="calibre10"/>    <span class="FontName">public void deleteMessage(Message message);</span><br class="calibre10"/>    <span class="FontName">public Message findMessageById(Long messageId);</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">For testing purposes, let’s implement this interface by using a list to store the posted messages. You can use the message posting time (in milliseconds) as a message’s identifier. You also have to declare the <span class="FontName">postMessage()</span> and <span class="FontName">deleteMessage()</span> method as <span class="FontName">synchronized</span> to make them thread-safe.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class MessageBoardServiceImpl implements MessageBoardService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private Map&lt;Long, Message&gt; messages = new LinkedHashMap&lt;Long, Message&gt;();</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public List&lt;Message&gt; listMessages() {</span><br class="calibre10"/>        <span class="FontName">return new ArrayList&lt;Message&gt;(messages.values());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public synchronized void postMessage(Message message) {</span><br class="calibre10"/>        <span class="FontName">message.setId(System.currentTimeMillis());</span><br class="calibre10"/>        <span class="FontName">messages.put(message.getId(), message);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public synchronized void deleteMessage(Message message) {</span><br class="calibre10"/>        <span class="FontName">messages.remove(message.getId());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Message findMessageById(Long messageId) {</span><br class="calibre10"/>        <span class="FontName">return</span> <span class="FontName">messages.get(messageId);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec5" class="Heading2">Setting Up a Spring MVC Application<a id="cXXX.517" class="calibre6"></a> That Uses Spring Security</p>
<p class="noindent">To develop this application using Spring MVC as the web framework and Spring Security as the security framework, you first create the following directory structure for your web application.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  Before using Spring Security, you have to have the relevant Spring Security JARs on your classpath. If you are using Maven, add the following dependencies to your Maven project. We include here a few extra dependencies that you will need on a case-by-case basis, including LDAP support and ACL support. In this book, we have used a variable - <span class="FontName">${spring.security.version}</span> to extract the version out. In this book, we are building against <b class="calibre4">3.2.4.RELEASE</b>.</p>
<pre class="calibre19"><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;spring-security-core&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;${spring.security.version}&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span><br class="calibre2"/><br class="calibre2"/><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;spring-security-ldap&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;${spring.security.version}&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span><br class="calibre2"/><br class="calibre2"/>  <span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;${spring.security.version}&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span><br class="calibre2"/><br class="calibre2"/>  <span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;spring-security-web&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;${spring.security.version}&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span><br class="calibre2"/><br class="calibre2"/>  <span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;spring-security-taglibs&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;${spring.security.version}&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span><br class="calibre2"/><br class="calibre2"/>  <span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;spring-security-acl&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;${spring.security.version}&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span></pre></div>
<p class="indent">The Spring configurations for this application are separated into three different files: <span class="FontName">board-security.xml</span>, <span class="FontName">board-service.xml</span>, and <span class="FontName">board-servlet.xml</span>. Each of them configures a particular layer.</p>
<p id="Sec6" class="Heading2">Creating the Configuration Files<a id="cXXX.518" class="calibre6"></a></p>
<p class="noindent">In the web deployment descriptor (i.e., <span class="FontName">web.xml</span>), you register <span class="FontName">ContextLoaderListener</span> to load the root application context at startup and Spring MVC’s <span class="FontName">DispatcherServlet</span> to dispatch requests:</p>
<pre class="calibre11"><span class="FontName">&lt;web-app  xmlns="</span><span class="FontName"><a href="http://java.sun.com/xml/ns/javaee" class="calibre5">http://java.sun.com/xml/ns/javaee</a></span><span class="FontName">"</span><br class="calibre10"/>          <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>          <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://java.sun.com/xml/ns/javaee" class="calibre5">http://java.sun.com/xml/ns/javaee</a></span><br class="calibre10"/>              <span class="FontName"><a href="http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd" class="calibre5">http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd</a></span><span class="FontName">"</span><br class="calibre10"/>          <span class="FontName">version="3.0"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;context-param&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;param-value&gt;/WEB-INF/board-service.xml&lt;/param-value&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/context-param&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;listener&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;listener-class&gt;</span><br class="calibre10"/>            <span class="FontName">org.springframework.web.context.ContextLoaderListener</span><br class="calibre10"/>        <span class="FontName">&lt;/listener-class&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/listener&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;servlet&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;servlet-name&gt;board&lt;/servlet-name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;servlet-class&gt;</span><br class="calibre10"/>            <span class="FontName">org.springframework.web.servlet.DispatcherServlet</span><br class="calibre10"/>        <span class="FontName">&lt;/servlet-class&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/servlet&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;servlet-mapping&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;servlet-name&gt;board&lt;/servlet-name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;url-pattern&gt;/&lt;/url-pattern&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/servlet-mapping&gt;</span><br class="calibre10"/><span class="FontName">&lt;/web-app&gt;</span></pre>
<p class="indent">If the root application context’s configuration file doesn’t have the default name (i.e., <span class="FontName">applicationContext.xml</span>), or if you configure it with multiple configuration files, you’ll have to specify the file locations in the <span class="FontName">contextConfigLocation</span> context parameter. Also note that you have mapped the URL pattern <span class="FontName">/</span> to <span class="FontName">DispatcherServlet</span>, meaning everything under the application’s root directory will be handled by this servlet.</p>
<p class="indent">In the web layer configuration file (i.e., <span class="FontName">board-servlet.xml</span>), you define a view resolver to resolve view names into JSP files located in the <span class="FontName">/WEB-INF/jsp/</span> directory. Later, you will have to configure your controllers in this file.</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:context="</span><span class="FontName"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans" class="calibre5">http://www.springframework.org/schema/beans/spring-beans</a></span> <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/context/spring-context.xsd" class="calibre5">http://www.springframework.org/schema/context/spring-context.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/> <span class="FontName">&lt;context:component-scan base-package="com.apress.springrecipes.board.web" /&gt;</span>  <br class="calibre10"/>    <span class="FontName">&lt;bean class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="prefix" value="/WEB-INF/jsp/" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffix" value=".jsp" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">In the service layer configuration file (i.e., <span class="FontName">board-service.xml</span>), you have to declare only the message board service:</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="messageBoardService"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.board.service.MessageBoardServiceImpl" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p id="Sec7" class="Heading2">Creating the Controllers and Page Views<a id="cXXX.519" class="calibre6"></a></p>
<p class="noindent">Suppose you have to implement a function for listing all messages posted on the message board. The first step is to create the following controller.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.web;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">@RequestMapping("/messageList*")</span><br class="calibre10"/><span class="FontName">public class MessageListController  {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private MessageBoardService messageBoardService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public MessageListController(MessageBoardService messageBoardService) {</span><br class="calibre10"/>        <span class="FontName">this.messageBoardService = messageBoardService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.GET)</span><br class="calibre10"/>    <span class="FontName">public String generateList(Model model) {</span><br class="calibre10"/>         <span class="FontName">List&lt;Message&gt; messages = java.util.Collections.emptyList();</span><br class="calibre10"/>         <span class="FontName">messages = messageBoardService.listMessages();</span><br class="calibre10"/>         <span class="FontName">model.addAttribute("messages",messages);</span><br class="calibre10"/>         <span class="FontName">return "messageList";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The controller is mapped to a URL in the form <span class="FontName">/messageList</span>. The controller’s main method—<span class="FontName">generateList()</span>—obtains a list of messages from the <span class="FontName">messageBoardService</span>, saves it to the model object under the <span class="FontName">messages</span> named, and returns control to a logical view named <span class="FontName">messageList</span>. In accordance with Spring MVC conventions, this last logical view is mapped to the JSP <span class="FontName">/WEB-INF/jsp/messageList.jsp</span> showing all the messages passed from the controller:</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="c" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/core" class="calibre5">http://java.sun.com/jsp/jstl/core</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Message List&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;c:forEach items="${messages}" var="message"&gt;</span><br class="calibre10"/><span class="FontName">&lt;table&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Author&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;${message.author}&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Title&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;${message.title}&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Body&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;${message.body}&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td colspan="2"&gt;</span><br class="calibre10"/>      <span class="FontName">&lt;a href="messageDelete?messageId=${message.id}"&gt;Delete&lt;/a&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/><span class="FontName">&lt;/table&gt;</span><br class="calibre10"/><span class="FontName">&lt;hr /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/c:forEach&gt;</span><br class="calibre10"/><span class="FontName">&lt;a href="messagePost.htm"&gt;Post&lt;/a&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">Another function you have to implement is for users to post messages on the message board. You create the following form controller for this purpose:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.web;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">@RequestMapping("/messagePost*")</span><br class="calibre10"/><span class="FontName">public class MessagePostController  {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private MessageBoardService messageBoardService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public void MessagePostController(MessageBoardService messageBoardService) {</span><br class="calibre10"/>        <span class="FontName">this.messageBoardService = messageBoardService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>     <span class="FontName">@RequestMapping(method=RequestMethod.GET)</span><br class="calibre10"/>     <span class="FontName">public String setupForm(Model model) {</span><br class="calibre10"/>        <span class="FontName">Message message = new Message();</span><br class="calibre10"/>        <span class="FontName">model.addAttribute("message",message);</span><br class="calibre10"/>        <span class="FontName">return "messagePost";</span><br class="calibre10"/>     <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>     <span class="FontName">@RequestMapping(method=RequestMethod.POST)</span><br class="calibre10"/>     <span class="FontName">public String onSubmit(@ModelAttribute("message") Message message, BindingResult result) {</span><br class="calibre10"/>          <span class="FontName">if (result.hasErrors()) {</span><br class="calibre10"/>              <span class="FontName">return "messagePost";</span><br class="calibre10"/>          <span class="FontName">} else {</span><br class="calibre10"/>              <span class="FontName">messageBoardService.postMessage(message);</span><br class="calibre10"/>              <span class="FontName">return "redirect:messageList";</span><br class="calibre10"/>          <span class="FontName">}</span><br class="calibre10"/>       <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">A user must have logged into the message board before posting a message. You can get a user’s login name with the <span class="FontName">getRemoteUser()</span> method defined in <span class="FontName">HttpServletRequest</span>. This login name will be used as the message’s author name.</p>
<p class="indent">You then create the form view <span class="FontName">/WEB-INF/jsp/messagePost.jsp</span> with Spring’s form tags for users to input message contents:</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="form" uri="</span><span class="FontName"><a href="http://www.springframework.org/tags/form" class="calibre5">http://www.springframework.org/tags/form</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Message Post&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;form:form method="POST" modelAttribute="message"&gt;</span><br class="calibre10"/><span class="FontName">&lt;table&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Title&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:input path="title" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Body&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:textarea path="body" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td colspan="2"&gt;&lt;input type="submit" value="Post" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/><span class="FontName">&lt;/table&gt;</span><br class="calibre10"/><span class="FontName">&lt;/form:form&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">The last function is to allow a user to delete a posted message by clicking the Delete link on the message list page. You create the following controller for this function:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.web;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">@RequestMapping("/messageDelete*")</span><br class="calibre10"/><span class="FontName">public class MessageDeleteController  {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private MessageBoardService messageBoardService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public void MessageDeleteController(MessageBoardService messageBoardService) {</span><br class="calibre10"/>        <span class="FontName">this.messageBoardService = messageBoardService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method= RequestMethod.GET)</span><br class="calibre10"/>    <span class="FontName">public String messageDelte(@RequestParam(required = true, <img src="../images/00053.jpeg" alt="image" class="calibre3"/></span><br class="calibre10"/>       <span class="FontName">value = "messageId") Long messageId, Model model)  {</span><br class="calibre10"/>       <span class="FontName">Message message = messageBoardService.findMessageById(messageId);</span><br class="calibre10"/>       <span class="FontName">messageBoardService.deleteMessage(message);</span><br class="calibre10"/>       <span class="FontName">model.addAttribute("messages", messageBoardService.listMessages());</span><br class="calibre10"/>       <span class="FontName">return "redirect:messageList";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now, you can deploy this application to a web container (e.g., Apache Tomcat 7.0). By default, Tomcat listens on port 8080, so if you deploy your application to the <span class="FontName">board</span> context path, you can list all posted messages with the following URL:</p>
<pre class="calibre11"><span class="FontName">http://localhost:8080/board/messageList.htm</span></pre>
<p class="indent">Up to this time, you haven’t configured any security service for this application, so you can access it directly without logging into it.</p>
<p id="Sec8" class="Heading2">Securing URL Access</p>
<p class="noindent">Now, let’s secure this web application’s URL access with Spring Security. First, you have to configure a <span class="FontName">DelegatingFilterProxy</span> instance<a id="cXXX.520" class="calibre5"></a> in <span class="FontName">web.xml</span> to delegate HTTP request filtering to a filter defined in Spring Security:</p>
<pre class="calibre11"><span class="FontName">&lt;web-app ...&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;context-param&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;param-value&gt;</span><br class="calibre10"/>            <span class="FontName">/WEB-INF/board-service.xml</span><br class="calibre10"/>            <b class="calibre4">/WEB-INF/board-security.xml</b><a id="cXXX.521" class="calibre5"></a><br class="calibre10"/>        <span class="FontName">&lt;/param-value&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/context-param&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;filter&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;filter-class&gt;</span><br class="calibre10"/>            <b class="calibre4">org.springframework.web.filter.DelegatingFilterProxy</b><a id="cXXX.522" class="calibre5"></a><br class="calibre10"/>        <span class="FontName">&lt;/filter-class&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/filter&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;filter-mapping&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/filter-mapping&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/web-app&gt;</span></pre>
<p class="indent">The responsibility of <span class="FontName">DelegatingFilterProxy</span> is simply to delegate HTTP request filtering to a Spring bean that implements the <span class="FontName">javax.servlet.Filter</span> interface. By default, it delegates to a bean whose name is the same as its <span class="FontName">&lt;filter-name&gt;</span> property, but you can override the bean name in its <span class="FontName">targetBeanName</span> init parameter. As Spring Security will automatically configure a filter chain with the name <span class="FontName">springSecurityFilterChain</span> when you enable web application security, you can simply use this name for your <span class="FontName">DelegatingFilterProxy</span> instance.</p>
<p class="indent">Although you can configure Spring Security in the same configuration file as the web and service layers, it’s better to separate the security configurations in an isolated file (e.g., <span class="FontName">board-security.xml</span>). Inside <span class="FontName">web.xml</span>, you have to add the file’s location to the <span class="FontName">contextConfigLocation</span><a id="cXXX.523" class="calibre5"></a> context parameter for <span class="FontName">ContextLoaderListener</span> to load it at startup. Then, you create it with the following content:</p>
<pre class="calibre11"><span class="FontName">&lt;beans:beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/security" class="calibre5">http://www.springframework.org/schema/security</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:beans="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/security" class="calibre5">http://www.springframework.org/schema/security</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/security/spring-security.xsd" class="calibre5">http://www.springframework.org/schema/security/spring-security.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;http auto-config="true"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;intercept-url pattern="/messageList*"</span><br class="calibre10"/>            <span class="FontName">access="ROLE_USER,ROLE_ANONYMOUS" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;intercept-url pattern="/messagePost*" access="ROLE_USER" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;intercept-url pattern="/messageDelete*" access="ROLE_ADMIN" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/http&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;authentication-manager&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;authentication-provider&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;user-service&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;user name="admin" password="secret"</span><br class="calibre10"/>                <span class="FontName">authorities="ROLE_ADMIN,ROLE_USER" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;user name="user1" password="1111" authorities="ROLE_USER" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/user-service&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/authentication-provider&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/authentication-manager&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans:beans&gt;</span></pre>
<p class="indent">You may find that this file looks a bit different from a normal bean configuration file. Normally, the default namespace of a bean configuration file is <span class="FontName">beans</span>, so you can use the <span class="FontName">&lt;bean&gt;</span> and <span class="FontName">&lt;property&gt;</span> elements without the <span class="FontName">beans</span> prefix. However, if you use this style to declare the Spring Security services, all security elements must be appended with the <span class="FontName">security</span> prefix. Because the elements in a security configuration file are mostly Spring Security’s, you can define <span class="FontName">security</span> as the default namespace instead, so you can use them without the <span class="FontName">security</span> prefix. If you do it this way, however, when you declare normal Spring beans in this file, you have to include the <span class="FontName">beans</span> prefix for the <span class="FontName">&lt;bean&gt;</span> and <span class="FontName">&lt;property&gt;</span> elements.</p>
<p class="indent">Inside the <span class="FontName">&lt;http&gt;</span> configuration element, you can restrict access to particular URLs with one or more <span class="FontName">&lt;intercept-url&gt;</span> elements. Each <span class="FontName">&lt;intercept-url&gt;</span> element specifies a URL pattern and a set of access attributes required to access the URLs. Remember that you must always include a wildcard at the end of a URL pattern. Failing to do so will make the URL pattern unable to match a URL that has request parameters. As a result, hackers could easily skip the security check by appending an arbitrary request parameter.</p>
<p class="indent">Access attributes are compared with a user’s authorities to decide if this user can access the URLs. In most cases, access attributes are defined in terms of roles. For example, users with the <span class="FontName">ROLE_USER</span> role, or anonymous users, who have the <span class="FontName">ROLE_ANONYMOUS</span> role<a id="cXXX.524" class="calibre5"></a> by default, are able to access the URL <span class="FontName">/messageList</span> to list all messages. However, a user must have the <span class="FontName">ROLE_USER</span> role<a id="cXXX.525" class="calibre5"></a> to post a new message via the URL <span class="FontName">/messagePost</span>. Only an administrator who has the <span class="FontName">ROLE_ADMIN</span> role<a id="cXXX.526" class="calibre5"></a> can delete messages via <span class="FontName">/messageDelete</span>.</p>
<p class="indent">You can configure authentication services in the <span class="FontName">&lt;authentication-provider&gt;</span> element, which is nested inside the <span class="FontName">&lt;authentication-manager&gt;</span> element. Spring Security supports several ways of authenticating users, including authenticating against a database or an LDAP repository. It also supports defining user details in <span class="FontName">&lt;user-service&gt;</span> directly for simple security requirements. You can specify a username, a password, and a set of authorities for each user.</p>
<p class="indent">Now, you can redeploy this application to test its security configurations. You can enter the request path <span class="FontName">/messageList</span> to list all posted messages as usual, because it’s open to anonymous users. But if you click the link to post a new message, you will be redirected to the default login page generated by Spring Security. You must log into this application with a correct username and password to post a message. Finally, to delete a message, you must log in as an administrator.</p>
<p id="Sec9" class="Heading2">Using Java<a id="cXXX.527" class="calibre6"></a><a id="cXXX.528" class="calibre6"></a> to configure Spring Security</p>
<p class="noindent">Until now we have used XML to configure our application. However as of Spring Security 3.2 we can also use a full Java based configuration approach and the Servlet 3.0 specification also allows us the remove the <span class="FontName">web.xml</span>, which allows us to do everything in Java. The web.xml we created in the previous samples can be replaced with a <span class="FontName">ServletContainerInitializer</span> which gives us the opportunity to configure the <span class="FontName">ServletContext</span> ourselves.</p>
<p class="indent">Spring provides us with the <span class="FontName">SpringServletContainerInitializer</span><a id="cXXX.529" class="calibre5"></a> which allows us to add one or more <span class="FontName">WebApplicationInitializer</span> which we can use to add servlets, filters, and listeners to the <span class="FontName">ServletContext</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.web;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.board.config.MessageBoardConfiguration;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.board.web.config.MessageBoardSecurityConfiguration;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.board.web.config.MessageBoardWebConfiguration;</span><br class="calibre10"/><span class="FontName">import org.springframework.core.annotation.Order;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer;</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">@Order(1)</b><a id="cXXX.530" class="calibre5"></a><br class="calibre10"/><span class="FontName">public class MessageBoardApplicationInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected Class&lt;?&gt;[] getRootConfigClasses() {</span><br class="calibre10"/>        <span class="FontName">return new Class&lt;?&gt;[] {MessageBoardConfiguration.class, MessageBoardSecurityConfiguration.class};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected Class&lt;?&gt;[] getServletConfigClasses() {</span><br class="calibre10"/>        <span class="FontName">return new Class&lt;?&gt;[] {MessageBoardWebConfiguration.class};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected String[] getServletMappings() {</span><br class="calibre10"/>        <span class="FontName">return new String[] { "/"};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">And the security <span class="FontName">WebApplicationInitializer</span>.</p>
<pre class="calibre11"><span class="FontName">packag</span><span class="FontName">e com.apress.springrecipes.board.web;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.core.annotation.Order;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.web.context.AbstractSecurityWebApplicationInitializer;</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">@Order(2)</b><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityInitializer extends AbstractSecurityWebApplicationInitializer { }</span></pre>
<p class="indent">The <span class="FontName">MessageBoardApplicationInitializer</span><a id="cXXX.531" class="calibre5"></a> takes care of creating a <span class="FontName">ContextLoaderListener</span> and <span class="FontName">DispatcherServlet</span> the code that does this is part of the <span class="FontName">AbstractAnnotationConfigDispatcherServletInitializer</span> class. We only need to provide the configuration classes for the listener and servlet for this we need to implement the <span class="FontName">getRootConfigClasses</span> and <span class="FontName">getServletConfigClasses</span> method. Finally we need to supply the servlet mapping for this we let the <span class="FontName">getServletMappings</span> method return <span class="FontName">/</span>.</p>
<p class="indent">We also need to register a DelegatingFilterProxy to make Spring Security work, we can extend the <span class="FontName">AbstractSecurityWebApplicationInitializer</span> base class for this. This class is provided by Spring Security, this class is also capable of constructing a <span class="FontName">ContextLoaderListener</span> which can be convenient in an environment where you don’t use Spring MVC but another web technology like JSF. That way you can work with a single <span class="FontName">WebApplicationInitializer</span>.</p>
<p class="indent">Notice the @Order annotation on both classes it is important that the <span class="FontName">DelegatingFilterProxy</span> is the first <span class="FontName">Filter</span> in the chain of filters. However the Spring provided <span class="FontName">AbstractAnnotationConfigDispatcherServletInitializer</span> registers any filters before all already configured filters. To make sure that Spring Security is setup correctly it should be the last <span class="FontName">WebApplicationInitializer</span> to execute so that it can register the DelegatingFilterProxy as the first filter without the risk of being overwritten later on.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.config;</span><a id="cXXX.532" class="calibre5"></a><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.board.service.MessageBoardService;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.board.service.MessageBoardServiceImpl;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class MessageBoardConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MessageBoardService messageBoardService() {</span><br class="calibre10"/>        <span class="FontName">return new MessageBoardServiceImpl();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The configuration class for the service isn’t spectacular; it only contains the bean definition for our service class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.web.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.ComponentScan;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.ViewResolver;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.view.InternalResourceViewResolver;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@ComponentScan("com.apress.springrecipes.board.web")</span><br class="calibre10"/><span class="FontName">@EnableWebMvc</span><br class="calibre10"/><span class="FontName">public class MessageBoardWebConfiguration</span><a id="cXXX.533" class="calibre5"></a> <span class="FontName">{</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public ViewResolver viewResolver() {</span><br class="calibre10"/>        <span class="FontName">InternalResourceViewResolver viewResolver = new InternalResourceViewResolver();</span><br class="calibre10"/>        <span class="FontName">viewResolver.setPrefix("/WEB-INF/jsp/");</span><br class="calibre10"/>        <span class="FontName">viewResolver.setSuffix(".jsp");</span><br class="calibre10"/>        <span class="FontName">return viewResolver;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">To configure out <span class="FontName">DispatcherServlet</span> we have the <span class="FontName">MessageBoardWebConfiguration</span> class. In the <span class="FontName">MessageBoardWebConfiguration</span> class you define a view resolver to resolve view names into JSP files located in the <span class="FontName">/WEB-INF/jsp/</span> directory. We have a <span class="FontName">@ComponentScan</span><a id="cXXX.534" class="calibre5"></a> (analogous to <span class="FontName">&lt;context:component-scan /&gt;</span>) to pick up our <span class="FontName">@Controller</span> annotated beans. Finally we specific that we want to use enable Spring MVC by placing the <span class="FontName">@EnableWebMvc</span> annotation.</p>
<p class="indent">To configure Spring Security we need to have a configuration class which is annotated with <span class="FontName">@EnableWebSecurity</span> and for further configuration needs to be a <span class="FontName">WebSecurityConfigurer</span>. The latter is needed to correctly setup the security configuration. Although you could implement your own class Spring Security provides <span class="FontName">WebSecurityConfigurerAdapter</span> as a base class which takes away a lot of ground work.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.web.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">.authorizeRequests()</span><br class="calibre10"/>                <span class="FontName">.antMatchers("/messageList*").hasAnyRole("USER", "ANONYMOUS")</span><br class="calibre10"/>                <span class="FontName">.antMatchers("/messagePost*").hasRole("USER")</span><br class="calibre10"/>                <span class="FontName">.antMatchers("/messageDelete*").hasRole("ADMIM")</span><br class="calibre10"/>            <span class="FontName">.and()</span><br class="calibre10"/>                <span class="FontName">.formLogin();</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(AuthenticationManagerBuilder auth) throws Exception {</span><br class="calibre10"/>        <span class="FontName">auth.inMemoryAuthentication()</span><br class="calibre10"/>                <span class="FontName">.withUser("admin").password("secret").authorities("ROLE_ADMIN","ROLE_USER")</span><br class="calibre10"/>                <span class="FontName">.and().withUser("user1").password("1111").authorities("ROLE_USER");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">We are overriding two <span class="FontName">configure</span> methods from the superclass. The first is the one that takes an <span class="FontName">HttpSecurity</span> as argument. This is analogous to the <span class="FontName">&lt;http&gt;</span> element in xml. We use it to configure the protection for our URLs with the <span class="FontName">antMatchers</span> on conjunction with the <span class="FontName">hasAnyRole</span> or <span class="FontName">hasRole</span> method<a id="cXXX.535" class="calibre5"></a>. Notice the omission of the <span class="FontName">ROLE_</span> prefix the configured prefix is automatically added to the roles.</p>
<p class="indent">The configure method taking the <span class="FontName">AuthenticationManagerBuilder</span> is used to setup the <span class="FontName">AuthenticationManager</span>, just like the <span class="FontName">&lt;authentication-manager&gt;</span> in XML. For now we are going to use in memory authentication this is done by using the <span class="FontName">inMemoryAuthentication</span> method and configuring the users with the <span class="FontName">withUser</span> method.</p>
<p id="Sec10" class="Heading">7-2. Logging In to Web Applications<a id="cXXX.536" class="calibre6"></a></p>
<p id="Sec11" class="Heading1">Problem</p>
<p class="noindent">A secure application requires its users to log in before they can access certain secure functions. This is especially important for web applications running on the open Internet, because hackers can easily reach them. Most web applications have to provide a way for users to input their credentials to log in.</p>
<p id="Sec12" class="Heading1">Solution<a id="cXXX.537" class="calibre6"></a></p>
<p class="noindent">Spring Security supports multiple ways for users to log into a web application. It supports form-based login by providing a default web page that contains a login form. You can also provide a custom web page as the login page. In addition, Spring Security supports HTTP Basic authentication by processing the Basic authentication credentials presented in HTTP request headers. HTTP Basic authentication can also be used for authenticating requests made with remoting protocols and web services.</p>
<p class="indent">Some parts of your application may allow for anonymous access (e.g., access to the welcome page). Spring Security provides an anonymous login service that can assign a principal and grant authorities to an anonymous user so that you can handle an anonymous user like a normal user when defining security policies.</p>
<p class="indent">Spring Security also supports remember-me login, which is able to remember a user’s identity across multiple browser sessions so that a user needn’t log in again after logging in for the first time.</p>
<p id="Sec13" class="Heading1">How It Works</p>
<p class="noindent">To help you better understand the various login mechanisms in isolation, let’s first disable HTTP auto-configuration by removing the <span class="FontName">auto-config</span> attribute:</p>
<pre class="calibre11"><span class="FontName">&lt;http&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messageList*" access="ROLE_USER,ROLE_ANONYMOUS" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messagePost*" access="ROLE_USER" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messageDelete*" access="ROLE_ADMIN" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">Note that the login services introduced next will be registered automatically if you enable HTTP <span class="FontName">auto-config</span>. However, if you disable HTTP <span class="FontName">auto-config</span> or you want to customize these services, you have to configure the corresponding XML elements explicitly.</p>
<p id="Sec14" class="Heading2">HTTP Basic Authentication<a id="cXXX.538" class="calibre6"></a></p>
<p class="noindent">The HTTP Basic authentication support can be configured via the <span class="FontName">&lt;http-basic&gt;</span> element. When HTTP Basic authentication is required, a browser will typically display a login dialog or a specific login page for users to log in.</p>
<pre class="calibre11"><span class="FontName">&lt;http&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;http-basic /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">Or using the <span class="FontName">httpBasic</span> method when using Java config.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>            <b class="calibre4">.httpBasic();</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Note that when HTTP Basic authentication and form-based login are enabled at the same time, the latter will be used. So, if you want your web application users to log in with this authentication type, you should not enable form-based login.</p>
<p id="Sec15" class="Heading2">Form-Based Login<a id="cXXX.539" class="calibre6"></a><a id="cXXX.540" class="calibre6"></a></p>
<p class="noindent">The form-based login service will render a web page that contains a login form for users to input their login details and process the login form submission. It’s configured via the <span class="FontName">&lt;form-login&gt;</span> element:</p>
<pre class="calibre11"><span class="FontName">&lt;http&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;form-login /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">Or when using Java config the <span class="FontName">formLogin</span> method.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>            <b class="calibre4">.formLogin();</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">By default, Spring Security automatically creates a login page and maps it to the URL <span class="FontName">/spring_security_login</span><a id="cXXX.541" class="calibre5"></a>. So, you can add a link to your application (e.g., in <span class="FontName">messageList.jsp</span>) referring to this URL for login:</p>
<pre class="calibre11"><span class="FontName">&lt;a href="&lt;c:url value="/spring_security_login" /&gt;"&gt;Login&lt;/a&gt;</span></pre>
<p class="indent">If you don’t prefer the default login page, you can provide a custom login page of your own. For example, you can create the following <span class="FontName">login.jsp</span> file in the root directory of the web application. Note that you shouldn’t put this file inside <span class="FontName">WEB-INF</span>, which would prevent users from accessing it directly.</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="c" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/core" class="calibre5">http://java.sun.com/jsp/jstl/core</a><a id="cXXX.2035" class="calibre5"></a></span><span class="FontName">" %&gt;</span><a id="cXXX.542" class="calibre5"></a><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Login&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;form method="POST" action="&lt;c:url value="/j_spring_security_check" /&gt;"&gt;</span><br class="calibre10"/><span class="FontName">&lt;table&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td align="right"&gt;Username&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;input type="text" name="j_username" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td align="right"&gt;Password&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;input type="password" name="j_password" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td align="right"&gt;Remember me&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;input type="checkbox" name="_spring_security_remember_me" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td colspan="2" align="right"&gt;</span><br class="calibre10"/>      <span class="FontName">&lt;input type="submit" value="Login" /&gt;</span><br class="calibre10"/>      <span class="FontName">&lt;input type="reset" value="Reset" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/><span class="FontName">&lt;/table&gt;</span><br class="calibre10"/><span class="FontName">&lt;/form&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">Note that the form action URL and the input field names are Spring Security–specific. However, the action URL can be customized with the <span class="FontName">login-url</span> attribute of <span class="FontName">&lt;form-login&gt;</span>.</p>
<p class="indent">Now, you have to change the previous login link (i.e., <span class="FontName">messageList.jsp</span>) to refer to this URL for login:</p>
<pre class="calibre11"><span class="FontName">&lt;a href="&lt;c:url value="/login.jsp" /&gt;"&gt;Login&lt;/a&gt;</span></pre>
<p class="indent">In order for Spring Security to display your custom login page when a login is requested, you have to specify its URL in the <span class="FontName">login-page</span> attribute<a id="cXXX.543" class="calibre5"></a>:</p>
<pre class="calibre11"><span class="FontName">&lt;http&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;form-login login-page="/login.jsp" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">Or the equivalent in Java based configuration.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>            <b class="calibre4">.formLogin().loginPage("/login.jsp");</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">If the login page is displayed by Spring Security when a user requests a secure URL, the user will be redirected to the target URL once the login succeeds. However, if the user requests the login page directly via its URL, by default the user will be redirected to the context path’s root (i.e., <span class="FontName">http://localhost:8080/board/</span><a id="cXXX.544" class="calibre5"></a>) after a successful login. If you have not defined a welcome page in your web deployment descriptor, you may wish to redirect the user to a default target URL when the login succeeds:</p>
<pre class="calibre11"><span class="FontName">&lt;http&gt;</span><br class="calibre10"/>    <span class="FontName">....</span><br class="calibre10"/>    <span class="FontName">&lt;form-login login-page="/login.jsp" default-target-url="/messageList" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">The equivalent in Java based configuration.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>            <b class="calibre4">.formLogin().loginPage("/login.jsp").defaultSuccessUrl("/messageList");</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">If you use the default login page created by Spring Security, then when a login fails, Spring Security will render the login page again with the error message. However, if you specify a custom login page, you will have to configure the <span class="FontName">authentication-failure-url</span> attribute<a id="cXXX.545" class="calibre5"></a> to specify which URL to redirect to on login error. For example, you can redirect to the custom login page again with the <span class="FontName">error</span> request parameter:</p>
<pre class="calibre11"><span class="FontName">&lt;http&gt;</span><br class="calibre10"/>    <span class="FontName">....</span><br class="calibre10"/>    <span class="FontName">&lt;form-login login-page="/login.jsp" default-target-url="/messageList"</span><br class="calibre10"/>        <span class="FontName">authentication-failure-url="/login.jsp?error=true" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">The equivalent in Java based configuration.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>            <b class="calibre4">.formLogin()</b><br class="calibre10"/>                <b class="calibre4">.loginPage("/login.jsp")</b><br class="calibre10"/>                <b class="calibre4">.defaultSuccessUrl("/messageList")</b><br class="calibre10"/>                <b class="calibre4">.failureUrl("login.jsp?error=true");</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Then your login page should test whether the <span class="FontName">error</span> request parameter is present. If an error has occurred, you will have to display the error message by accessing the session scope attribute <span class="FontName">SPRING_SECURITY_LAST_EXCEPTION</span><a id="cXXX.546" class="calibre5"></a>, which stores the last exception for the current user.</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="c" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/core" class="calibre5">http://java.sun.com/jsp/jstl/core</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Login&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;c:if test="${not empty param.error}"&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;font color="red"&gt;</span><br class="calibre10"/>  <span class="FontName">Login error. &lt;br /&gt;</span><br class="calibre10"/>  <span class="FontName">Reason : ${sessionScope["SPRING_SECURITY_LAST_EXCEPTION"].message}</span><br class="calibre10"/>  <span class="FontName">&lt;/font&gt;</span><br class="calibre10"/><span class="FontName">&lt;/c:if&gt;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p id="Sec16" class="Heading2">The Logout Service<a id="cXXX.547" class="calibre6"></a></p>
<p class="noindent">The logout service<a id="cXXX.548" class="calibre5"></a> provides a handler to handle logout requests. It can be configured via the <span class="FontName">&lt;logout&gt;</span> element:</p>
<pre class="calibre11"><span class="FontName">&lt;http&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;logout /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">For Java based configuration you can use the <span class="FontName">logout</span> method.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>            <span class="FontName">.and()</span><br class="calibre10"/>                <b class="calibre4">.logout();</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">By default, it’s mapped to the URL <span class="FontName">/j_spring_security_logout</span>, so you can add a link to a page referring to this URL for logout. Note that this URL can be customized with the <span class="FontName">logout-url</span> attribute of <span class="FontName">&lt;logout&gt;</span>.</p>
<pre class="calibre11"><span class="FontName">&lt;a href="&lt;c:url value="/j_spring_security_logout" /&gt;"&gt;Logout&lt;/a&gt;</span></pre>
<p class="indent">By default, a user will be redirected to the context path’s root when the logout succeeds, but sometimes, you may wish to direct the user to another URL, which you can do as follows:</p>
<pre class="calibre11"><span class="FontName">&lt;http&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;logout logout-success-url="/login.jsp" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">In Java config you would use the <span class="FontName">logoutSuccessUrl</span> method to configure the URL to direct to.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public</span> <span class="FontName">clas</span><span class="FontName">s MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protecte</span><span class="FontName">d void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>            <span class="FontName">.and()</span><br class="calibre10"/>                <b class="calibre4">.logout().logoutSuccessUrl("/login.jsp");</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec17" class="Heading2">Anonymous Login<a id="cXXX.549" class="calibre6"></a></p>
<p class="noindent">The anonymous login<a id="cXXX.550" class="calibre5"></a> service can be configured via the <span class="FontName">&lt;anonymous&gt;</span> element or <span class="FontName">anonymous()</span> in Java config, where you can customize the username and authorities of an anonymous user, whose default values are <span class="FontName">anonymousUser</span> and <span class="FontName">ROLE_ANONYMOUS</span>:</p>
<pre class="calibre11"><span class="FontName">&lt;http&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messageList*" access="ROLE_USER,ROLE_GUEST" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messagePost*" access="ROLE_USER" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messageDelete*" access="ROLE_ADMIN" /&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;anonymous username="guest" granted-authority="ROLE_GUEST" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">When using Java config:</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>            <span class="FontName">.and()</span><br class="calibre10"/>                <b class="calibre4">.anonymous().principal("guest").authorities("ROLE_GUEST");</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec18" class="Heading2">Remember-Me Support<a id="cXXX.551" class="calibre6"></a></p>
<p class="noindent">Remember-me support<a id="cXXX.552" class="calibre5"></a> can be configured via the <span class="FontName">&lt;remember-me&gt;</span> element or <span class="FontName">rememberMe()</span> method in Java config. By default, it encodes the username, password, remember-me expiration time, and a private key as a token, and stores it as a cookie in the user’s browser. The next time the user accesses the same web application, this token will be detected so that the user can log in automatically.</p>
<pre class="calibre11"><span class="FontName">&lt;http&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;remember-me /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">When using Java config:</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>            <span class="FontName">.and()</span><br class="calibre10"/>                <b class="calibre4">.rememberMe();</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">However, static remember-me tokens can cause security issues, because they may be captured by hackers. Spring Security supports rolling tokens for more advanced security needs, but this requires a database to persist the tokens. For details about rolling remember-me token deployment, please refer to the Spring Security reference documentation.</p>
<p id="Sec19" class="Heading">7-3. Authenticating Users<a id="cXXX.553" class="calibre6"></a></p>
<p id="Sec20" class="Heading1">Problem<a id="cXXX.554" class="calibre6"></a></p>
<p class="noindent">When a user attempts to log into your application to access its secure resources, you have to authenticate the user’s principal and grant authorities to this user.</p>
<p id="Sec21" class="Heading1">Solution<a id="cXXX.555" class="calibre6"></a></p>
<p class="noindent">In Spring Security, authentication is performed by one or more <i class="calibre8">authentication providers</i>, connected as a chain. If any of these providers authenticates a user successfully, that user will be able to log into the application. If any provider reports that the user is disabled or locked or that the credential is incorrect, or if no provider can authenticate the user, then the user will be unable to log into this application.</p>
<p class="indent">Spring Security supports multiple ways of authenticating users and includes built-in provider implementations for them. You can easily configure these providers with the built-in XML elements. Most common authentication providers authenticate users against a user repository storing <i class="calibre8">user details</i> (e.g., in an application’s memory, a relational database, or an LDAP repository).</p>
<p class="indent">When storing user details in a repository, you should avoid storing user passwords in clear text, because that makes them vulnerable to hackers. Instead, you should always store encrypted passwords in your repository. A typical way of encrypting passwords is to use a one-way hash function to encode the passwords. When a user enters a password to log in, you apply the same hash function to this password and compare the result with the one stored in the repository. Spring Security supports several algorithms for encoding passwords (including MD5 and SHA) and provides built-in password encoders for these algorithms.</p>
<p class="indent">If you retrieve a user’s details from a user repository every time a user attempts to log in, your application may incur a performance impact. This is because a user repository is usually stored remotely, and it has to perform some kinds of queries in response to a request. For this reason, Spring Security supports caching user details in local memory and storage to save you the overhead of performing remote queries.</p>
<p id="Sec22" class="Heading1">How It Works</p>
<p id="Sec23" class="Heading2">Authenticating Users with In-Memory Definitions<a id="cXXX.556" class="calibre6"></a><a id="cXXX.557" class="calibre6"></a></p>
<p class="noindent">If you have only a few users in your application and you seldom modify their details, you can consider defining the user details in Spring Security’s configuration file so that they will be loaded into your application’s memory:</p>
<pre class="calibre11"><span class="FontName">&lt;authentication-manager&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;authentication-provider&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;user-service&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;user name="admin" password="secret" authorities="ROLE_ADMIN,ROLE_USER" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;user name="user1" password="1111" authorities="ROLE_USER" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;user name="user2" password="2222" disabled="true" authorities="ROLE_USER" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/user-service&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/authentication-provider&gt;</span><br class="calibre10"/><span class="FontName">&lt;/authentication-manager&gt;</span></pre>
<p class="indent">You can define user details in <span class="FontName">&lt;user-service&gt;</span> with multiple <span class="FontName">&lt;user&gt;</span> elements. For each user, you can specify a username, a password, a disabled status, and a set of granted authorities. A disabled user cannot log into an application.</p>
<p class="indent">Spring Security also allows you to externalize user details in a properties file, such as <span class="FontName">/WEB-INF/users.properties</span>:</p>
<pre class="calibre11"><span class="FontName">&lt;authentication-manager&gt;</span><br class="calibre10"/> <span class="FontName">&lt;authentication-provider&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;user-service properties="/WEB-INF/users.properties" /&gt;</span><br class="calibre10"/> <span class="FontName">&lt;/authentication-provider&gt;</span><br class="calibre10"/><span class="FontName">&lt;/authentication-manager&gt;</span></pre>
<p class="indent">Then, you can create the specified properties file and define the user details in the form of properties:</p>
<pre class="calibre11"><span class="FontName">admin=secret,ROLE_ADMIN,ROLE_USER</span><br class="calibre10"/><span class="FontName">user1=1111,ROLE_USER</span><br class="calibre10"/><span class="FontName">user2=2222,disabled,ROLE_USER</span></pre>
<p class="indent">Each property in this file represents a user’s details. The property key is the username, and the property value is divided into several parts separated by commas. The first part is the password, and the second part is the enabled status, which is optional; and the default status is <span class="FontName">enabled</span>. The following parts are the authorities granted to the user.</p>
<p id="Sec24" class="Heading2">Authenticating Users with In-Memory Definitions using Java Config</p>
<p class="noindent">If you have only a few users in your application and you seldom modify their details, you can consider defining the user details in Spring Security’s configuration file so that they will be loaded into your application’s memory:</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(AuthenticationManagerBuilder auth) throws Exception {</span><br class="calibre10"/>        <span class="FontName">auth.inMemoryAuthentication()</span><br class="calibre10"/>                <span class="FontName">.withUser("admin").password("secret").authorities("ROLE_ADMIN","ROLE_USER").and()</span><br class="calibre10"/>                <span class="FontName">.withUser("user1").password("1111").authorities("ROLE_USER").and()</span><br class="calibre10"/>                <span class="FontName">.withUser("user2").password("2222").disabled(true).authorities("ROLE_USER");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You can<a id="cXXX.558" class="calibre5"></a> define user details with the <span class="FontName">inMemoryAuthentication</span> using the <span class="FontName">withUser</span> method you can define the users. For each user, you can specify a username, a password, a disabled status, and a set of granted authorities. A disabled user cannot log into an application.</p>
<p id="Sec25" class="Heading2">Authenticating Users Against a Database<a id="cXXX.2009" class="calibre6"></a><a id="cXXX.559" class="calibre6"></a></p>
<p class="noindent">More typically, user details should be stored in a database for easy maintenance. Spring Security has built-in support for querying user details from a database. By default, it queries user details, including authorities, with the following SQL statements<a id="cXXX.560" class="calibre5"></a>:</p>
<pre class="calibre11"><span class="FontName">SELECT username, password, enabled</span><br class="calibre10"/><span class="FontName">FROM   users</span><br class="calibre10"/><span class="FontName">WHERE  username = ?</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">SELECT username, authority</span><br class="calibre10"/><span class="FontName">FROM   authorities</span><br class="calibre10"/><span class="FontName">WHERE  username = ?</span></pre>
<p class="indent">In order for Spring Security to query user details with these SQL statements, you have to create the corresponding tables in your database. For example, you can create them in the <span class="FontName">board</span> schema of Apache Derby with the following SQL statements:</p>
<pre class="calibre11"><span class="FontName">CREATE TABLE USERS (</span><br class="calibre10"/>    <span class="FontName">USERNAME    VARCHAR(10)    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">PASSWORD    VARCHAR(32)    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">ENABLED     SMALLINT,</span><br class="calibre10"/>    <span class="FontName">PRIMARY KEY (USERNAME)</span><br class="calibre10"/><span class="FontName">);</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">CREATE TABLE AUTHORITIES (</span><br class="calibre10"/>    <span class="FontName">USERNAME    VARCHAR(10)    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">AUTHORITY   VARCHAR(10)    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">FOREIGN KEY (USERNAME) REFERENCES USERS</span><br class="calibre10"/><span class="FontName">);</span></pre>
<p class="indent">Next, you can input some user details into these tables for testing purposes. The data for these two tables is shown in <a id="_Tab1" href="part0017.html#Tab1" class="calibre5">Tables 7-1</a> and <a id="_Tab2" href="part0017.html#Tab2" class="calibre5">7-2</a>.</p>
<div class="Table" id="Tab1"><p class="TabCapt"><span class="calibre4"><a href="part0017.html#_Tab1" class="calibre5">Table 7-1</a>.</span> Testing User Data for the USERS Table</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14"><p class="tab-left">USERNAME</p></th><th valign="top" class="calibre14"><p class="tab-left">PASSWORD</p></th><th valign="top" class="calibre14"><p class="tab-left">ENABLED</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">Admin</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">Secret</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">1</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">user1</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">1111</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">1</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">user2</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">2222</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">0</span></p></td></tr></tbody></table>
</div>
<div class="Table" id="Tab2"><p class="TabCapt"><span class="calibre4"><a href="part0017.html#_Tab2" class="calibre5">Table 7-2</a>.</span> Testing User Data for the AUTHORITIES Table</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14"><p class="tab-left">USERNAME</p></th><th valign="top" class="calibre14"><p class="tab-left">AUTHORITY</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">Admin</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">ROLE_ADMIN</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">Admin</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">ROLE_USER</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">user1</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">ROLE_USER</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">user2</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">ROLE_USER</span></p></td></tr></tbody></table>
</div>
<p class="indent">In order for Spring Security to access these tables, you have to declare a data source (e.g., in <span class="FontName">board-service.xml</span>) for creating connections to this database.</p>
<pre class="calibre11"><span class="FontName">&lt;bean id="dataSource"</span><br class="calibre10"/>    <span class="FontName">class="org.springframework.jdbc.datasource.DriverManagerDataSource"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property name="driverClassName"</span><br class="calibre10"/>        <span class="FontName">value="org.apache.derby.jdbc.ClientDriver" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property name="url"</span><br class="calibre10"/>        <span class="FontName">value="jdbc:derby://localhost:1527/board;create=true" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property name="username" value="app" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property name="password" value="app" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/bean&gt;</span></pre>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To connect to a database in the Apache Derby server, you need the Derby client .jars, as well as the Spring JDBC support. If you are using Apache Maven, add the following dependencies to your project:</p>
<pre class="calibre19"><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.apache.derby&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;derbyclient&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;10.10.2.0&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span><br class="calibre2"/><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>    <span class="FontName1">&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br class="calibre2"/>    <span class="FontName1">&lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;${spring.version}&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span></pre></div>
<p class="indent">The final step is to configure an authentication provider that queries this database for user details. You can achieve this simply by using the <span class="FontName">&lt;jdbc-user-service&gt;</span><a id="cXXX.561" class="calibre5"></a> element with a data source reference:</p>
<pre class="calibre11"><span class="FontName">&lt;authentication-manager&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;authentication-provider&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;jdbc-user-service data-source-ref="dataSource" /&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/authentication-provider&gt;</span><br class="calibre10"/><span class="FontName">&lt;/authentication-manager&gt;</span></pre>
<p class="indent">For Java Config use the <span class="FontName">jdbcAuthentication</span> and pass it a <span class="FontName">DataSource</span>.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">private DataSource dataSource;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(AuthenticationManagerBuilder auth) throws Exception {</span><br class="calibre10"/>        <span class="FontName">auth.</span><b class="calibre4">jdbcAuthentication().dataSource(dataSource);</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">However, in some cases, you may already have your own user repository defined in a legacy database. For example, suppose that the tables are created with the following SQL statements, and that all users in the <span class="FontName">MEMBER</span> table have the enabled status:</p>
<pre class="calibre11"><span class="FontName">CREATE TABLE MEMBER (</span><br class="calibre10"/>    <span class="FontName">ID          BIGINT         NOT NULL,</span><br class="calibre10"/>    <span class="FontName">USERNAME    VARCHAR(10)    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">PASSWORD    VARCHAR(32)    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">PRIMARY KEY (ID)</span><br class="calibre10"/><span class="FontName">);</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">CREATE TABLE MEMBER_ROLE (</span><br class="calibre10"/>    <span class="FontName">MEMBER_ID    BIGINT         NOT NULL,</span><br class="calibre10"/>    <span class="FontName">ROLE         VARCHAR(10)    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER</span><br class="calibre10"/><span class="FontName">);</span></pre>
<p class="indent">Suppose you have the legacy user<a id="cXXX.562" class="calibre5"></a> data stored in these tables as shown in <a id="_Tab3" href="part0017.html#Tab3" class="calibre5">Tables 7-3</a> and <a id="_Tab4" href="part0017.html#Tab4" class="calibre5">7-4</a>.</p>
<div class="Table" id="Tab3"><p class="TabCapt"><span class="calibre4"><a href="part0017.html#_Tab3" class="calibre5">Table 7-3</a>.</span> Legacy User Data in the MEMBER Table</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14"><p class="tab-left">ID</p></th><th valign="top" class="calibre14"><p class="tab-left">USERNAME</p></th><th valign="top" class="calibre14"><p class="tab-left">PASSWORD</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">1</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">Admin</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">Secret</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">2</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">user1</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">1111</span></p></td></tr></tbody></table>
</div>
<div class="Table" id="Tab4"><p class="TabCapt"><span class="calibre4"><a href="part0017.html#_Tab4" class="calibre5">Table 7-4</a>.</span> Legacy User Data in the MEMBER_ROLE Table</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14"><p class="tab-left">MEMBER_ID</p></th><th valign="top" class="calibre14"><p class="tab-left">ROLE</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">1</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">ROLE_ADMIN</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">1</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">ROLE_USER</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">2</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">ROLE_USER</span></p></td></tr></tbody></table>
</div>
<p class="indent">Fortunately, Spring Security also supports using custom SQL statements to query a legacy database for user details. You can specify the statements for querying a user’s information and authorities in the <span class="FontName">users-by-username-query</span> and <span class="FontName">authorities-by-username-query</span> attributes:</p>
<pre class="calibre11"><span class="FontName">&lt;jdbc-user-service data-source-ref="dataSource"</span><br class="calibre10"/>    <span class="FontName">users-by-username-query=</span><br class="calibre10"/>        <span class="FontName">"SELECT username, password, 'true' as enabled<img src="../images/00053.jpeg" alt="image" class="calibre3"/></span><br class="calibre10"/>         <span class="FontName">FROM   member<img src="../images/00053.jpeg" alt="image" class="calibre3"/></span><br class="calibre10"/>         <span class="FontName">WHERE  username = ?"</span><br class="calibre10"/>    <span class="FontName">authorities-by-username-query=</span><br class="calibre10"/>        <span class="FontName">"SELECT member.username, member_role.role as authorities<img src="../images/00053.jpeg" alt="image" class="calibre3"/></span><br class="calibre10"/>         <span class="FontName">FROM   member, member_role<img src="../images/00053.jpeg" alt="image" class="calibre3"/></span><br class="calibre10"/>         <span class="FontName">WHERE  member.username = ? AND member.id = member_role.member_id" /&gt;</span></pre>
<p class="indent">The equivalent in Java config using <span class="FontName">usersByUsernameQuery</span><a id="cXXX.563" class="calibre5"></a> and <span class="FontName">authoritiesByUsernameQuery</span> methods<a id="cXXX.564" class="calibre5"></a>:</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public</span> <span class="FontName">class</span> <span class="FontName">MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(AuthenticationManagerBuilder auth) throws Exception {</span><br class="calibre10"/>        <span class="FontName">auth.jdbcAuthentication()</span><br class="calibre10"/>                <span class="FontName">.dataSource(dataSource)</span><br class="calibre10"/>                <span class="FontName">.usersByUsernameQuery(</span><br class="calibre10"/>                        <span class="FontName">"SELECT username, password, 'true' as enabled FROM member WHERE username = ?")</span><br class="calibre10"/>                <span class="FontName">.authoritiesByUsernameQuery(</span><br class="calibre10"/>                        <span class="FontName">"SELECT member.username, member_role.role as authorities " +</span><br class="calibre10"/>                        <span class="FontName">"FROM member, member_role " +</span><br class="calibre10"/>                        <span class="FontName">"WHERE  member.username = ? AND member.id = member_role.member_id");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec26" class="Heading2">Encrypting Passwords<a id="cXXX.565" class="calibre6"></a></p>
<p class="noindent">Until now, you have been storing user details with clear-text passwords. But this approach is vulnerable to hacker attacks, so you should encrypt the passwords<a id="cXXX.566" class="calibre5"></a> before storing them. Spring Security supports several algorithms for encrypting passwords. For example, you can choose MD5 (Message-Digest algorithm 5), a one-way hash algorithm, to encrypt your passwords.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  You may need a utility to calculate MD5 digests for your passwords. One such utility is Jacksum, which you can download from <span class="FontName"><a href="http://sourceforge.net/projects/jacksum/" class="calibre5">http://sourceforge.net/projects/jacksum/</a></span> and extract to a directory of your choice. Then execute the following command to calculate a digest for a text:</p>
<span class="FontName1">java -jar jacksum.jar -a md5 -q "txt:secret"</span></div>
<p class="indent">Now, you can store the encrypted passwords in your user repository. For example, if you are using in-memory user definitions, you can specify the encrypted passwords in the <span class="FontName">password</span> attributes. Then, you can configure a <span class="FontName">&lt;password-encoder&gt;</span> element with a hashing algorithm specified in the <span class="FontName">hash</span> attribute.</p>
<pre class="calibre11"><span class="FontName">&lt;authentication-manager&gt;</span><br class="calibre10"/>   <span class="FontName">&lt;authentication-provider&gt;</span><br class="calibre10"/>    <b class="calibre4">&lt;password-encoder hash="md5" /&gt;</b><br class="calibre10"/>    <span class="FontName">&lt;user-service&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;user name="admin" password="5ebe2294ecd0e0f08eab7690d2a6ee69"</span><br class="calibre10"/>            <span class="FontName">authorities="ROLE_ADMIN, ROLE_USER" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;user name="user1" password="b59c67bf196a4758191e42f76670ceba"</span><br class="calibre10"/>            <span class="FontName">authorities="ROLE_USER" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;user name="user2" password="934b535800b1cba8f96a5d72f72f1611"</span><br class="calibre10"/>            <span class="FontName">disabled="true" authorities="ROLE_USER" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/user-service&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/authentication-provider&gt;</span><br class="calibre10"/><span class="FontName">&lt;/authentication-manager&gt;</span></pre>
<p class="indent">A password encoder is also applicable to a user repository stored in a database:</p>
<pre class="calibre11"><span class="FontName">&lt;authentication-manager&gt;</span><br class="calibre10"/>   <span class="FontName">&lt;authentication-provider&gt;</span><br class="calibre10"/>    <b class="calibre4">&lt;password-encoder hash="md5" /&gt;</b><br class="calibre10"/>    <span class="FontName">&lt;jdbc-user-service data-source-ref="dataSource" /&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/authentication-provider&gt;</span><br class="calibre10"/><span class="FontName">&lt;/authentication-manager&gt;</span></pre>
<p class="indent">In Java config you can specify the pass encoder using the <span class="FontName">passwordEncoder</span> method on <span class="FontName">AuthenticationManagerBuilder</span>:</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(AuthenticationManagerBuilder auth) throws Exception {</span><br class="calibre10"/>        <span class="FontName">auth.jdbcAuthentication()</span><br class="calibre10"/>                <span class="FontName">.dataSource(dataSource)</span><br class="calibre10"/>                <span class="FontName">.passwordEncoder(new Md5PasswordEncoder());</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Of course, you have to store the encrypted passwords in the database tables, instead of the clear-text passwords, as shown in <a id="_Tab5" href="part0017.html#Tab5" class="calibre5">Table 7-5</a>.</p>
<div class="Table" id="Tab5"><p class="TabCapt"><span class="calibre4"><a href="part0017.html#_Tab5" class="calibre5">Table 7-5</a>.</span> Testing User Data with Encrypted Passwords for the USERS Table</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14"><p class="tab-left">USERNAME</p></th><th valign="top" class="calibre14"><p class="tab-left">PASSWORD</p></th><th valign="top" class="calibre14"><p class="tab-left">ENABLED</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">Admin</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">5ebe2294ecd0e0f08eab7690d2a6ee69</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">1</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">user1</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">b59c67bf196a4758191e42f76670ceba</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">1</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">user2</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">934b535800b1cba8f96a5d72f72f1611</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">0</span></p></td></tr></tbody></table>
</div>
<p id="Sec27" class="Heading2">Authenticating Users Against an LDAP Repository<a id="cXXX.567" class="calibre6"></a></p>
<p class="noindent">Spring Security also supports accessing an LDAP repository<a id="cXXX.568" class="calibre5"></a> for authenticating users. First, you have to prepare some user data for populating the LDAP repository. Let’s prepare the user data in the LDAP Data Interchange Format (LDIF), a standard plain-text data format for importing and exporting LDAP directory data. For example, create the <span class="FontName">users.ldif</span> file containing the following contents:</p>
<pre class="calibre11"><span class="FontName">dn: dc=springrecipes,dc=com</span><br class="calibre10"/><span class="FontName">objectClass: top</span><br class="calibre10"/><span class="FontName">objectClass: domain</span><br class="calibre10"/><span class="FontName">dc: springrecipes</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">dn: ou=groups,dc=springrecipes,dc=com</span><br class="calibre10"/><span class="FontName">objectclass: top</span><br class="calibre10"/><span class="FontName">objectclass: organizationalUnit</span><br class="calibre10"/><span class="FontName">ou: groups</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">dn: ou=people,dc=springrecipes,dc=com</span><br class="calibre10"/><span class="FontName">objectclass: top</span><br class="calibre10"/><span class="FontName">objectclass: organizationalUnit</span><br class="calibre10"/><span class="FontName">ou: people</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">dn: uid=admin,ou=people,dc=springrecipes,dc=com</span><br class="calibre10"/><span class="FontName">objectclass: top</span><br class="calibre10"/><span class="FontName">objectclass: uidObject</span><br class="calibre10"/><span class="FontName">objectclass: person</span><br class="calibre10"/><span class="FontName">uid: admin</span><br class="calibre10"/><span class="FontName">cn: admin</span><br class="calibre10"/><span class="FontName">sn: admin</span><br class="calibre10"/><span class="FontName">userPassword: secret</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">dn: uid=user1,ou=people,dc=springrecipes,dc=com</span><br class="calibre10"/><span class="FontName">objectclass: top</span><br class="calibre10"/><span class="FontName">objectclass: uidObject</span><br class="calibre10"/><span class="FontName">objectclass: person</span><br class="calibre10"/><span class="FontName">uid: user1</span><br class="calibre10"/><span class="FontName">cn: user1</span><br class="calibre10"/><span class="FontName">sn: user1</span><br class="calibre10"/><span class="FontName">user</span><span class="FontName">Password: 1111</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">dn: cn=admin,ou=groups,dc=springrecipes,dc=com</span><br class="calibre10"/><span class="FontName">objectclass: top</span><br class="calibre10"/><span class="FontName">objectclass: groupOfNames</span><br class="calibre10"/><span class="FontName">cn: admin</span><br class="calibre10"/><span class="FontName">member: uid=admin,ou=people,dc=springrecipes,dc=com</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">dn: cn=user,ou=groups,dc=springrecipes,dc=com</span><br class="calibre10"/><span class="FontName">objectclass: top</span><br class="calibre10"/><span class="FontName">objectclass: groupOfNames</span><br class="calibre10"/><span class="FontName">cn: user</span><br class="calibre10"/><span class="FontName">member: uid=admin,ou=people,dc=springrecipes,dc=com</span><br class="calibre10"/><span class="FontName">member: uid=user1,ou=people,dc=springrecipes,dc=com</span></pre>
<p class="indent">Don’t worry if you don’t understand this LDIF file very well. You probably won’t need to use this file format to define LDAP data often, because most LDAP servers support GUI-based configuration. This <span class="FontName">users.ldif</span> file includes the following contents:</p>
<ul class="bulleted"><li class="calibre17">The default LDAP domain, <span class="FontName">dc=springrecipes,dc=com</span></li>
<li class="calibre17">The <span class="FontName">groups</span> and <span class="FontName">people</span> organization units for storing groups and users</li>
<li class="calibre17">The <span class="FontName">admin</span> and <span class="FontName">user1</span> users with the passwords <span class="FontName">secret</span> and <span class="FontName">1111</span></li>
<li class="calibre17">The <span class="FontName">admin</span> group (including the <span class="FontName">admin</span> user) and the <span class="FontName">user</span> group (including the <span class="FontName">admin</span> and <span class="FontName">user1</span> users)</li></ul>
<p class="indent">For testing purposes, you can install an LDAP server on your local machine to host this user repository. For the sake of easy installation and configuration, we recommend installing OpenDS (<span class="FontName"><a href="http://www.opends.org/" class="calibre5">http://www.opends.org/</a></span>), a Java-based open source directory service engine that supports LDAP.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  OpenDS supports two types of installation interfaces: command line and GUI. This example uses the command-line interface, so you have to download the ZIP distribution and extract it to an arbitrary directory (e.g., <span class="FontName">C:\OpenDS-2.2.1</span>), and then execute the <span class="FontName">setup</span> script from the root of this directory.</p></div>
<pre class="calibre11"><span class="FontName">C:\OpenDS-2.2.0&gt;setup --cli</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">OpenDS Directory Server 2.2.0</span><br class="calibre10"/><span class="FontName">Please wait while the setup program initializes...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">What would you like to use as the initial root user DN for the Directory</span><br class="calibre10"/><span class="FontName">Server? [cn=Directory Manager]:</span><br class="calibre10"/><span class="FontName">Please provide the password to use for the initial root user: ldap</span><br class="calibre10"/><span class="FontName">Please re-enter the password for confirmation: ldap</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">On which port would you like the Directory Server to accept connections from</span><br class="calibre10"/><span class="FontName">LDAP clients? [1389]:</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">On</span> <span class="FontName">which</span> <span class="FontName">port would you like the Administration Connector to accept</span><br class="calibre10"/><span class="FontName">connections? [4444]:</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">What</span> <span class="FontName">do you wish to use as the base DN for the directory data?</span><br class="calibre10"/><span class="FontName">[dc=example,dc=com]:dc=springrecipes,dc=com</span><br class="calibre10"/><span class="FontName">Options for populating the database:</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">1)  Only create the base entry</span><br class="calibre10"/>    <span class="FontName">2)  Leave the database empty</span><br class="calibre10"/>    <span class="FontName">3)  Import data from an LDIF file</span><br class="calibre10"/>    <span class="FontName">4)  Load automatically-generated sample data</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">Enter choice [1]: 3</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">Please specify the path to the LDIF file containing the data to import: users.ldif</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">Do you want to enable SSL? (yes / no) [no]:</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">Do you want to enable Start TLS? (yes / no) [no]:</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">Do you want to start the server when the configuration is completed?</span><br class="calibre10"/><span class="FontName">(yes/no) [yes]:</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">Enable OpenDS to run as a Windows Service? (yes / no) [no]:</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">Do you want to start the server when the configuration is completed?</span><br class="calibre10"/><span class="FontName">(yes/no) [yes]:</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">What would you like to do?</span><br class="calibre10"/>    <span class="FontName">1)  Setup the server with the parameters above</span><br class="calibre10"/>    <span class="FontName">2)  Provide the setup parameters again</span><br class="calibre10"/>    <span class="FontName">3)  Cancel the setup</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">Enter choice [1]:</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">Configuring Directory Server ..... Done.</span><br class="calibre10"/><span class="FontName">Importing LDIF file users.ldif ....... Done.</span><br class="calibre10"/><span class="FontName">Starting Directory Server ........ Done.</span></pre>
<p class="indent">Note that the root user and password for this LDAP server are <span class="FontName">cn=Directory Manager</span> and <span class="FontName">ldap</span>, respectively. Later, you will have to use this user to connect to this server.</p>
<p class="indent">After the LDAP server has started up, you can configure Spring Security to authenticate users against its repository.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To authenticate users against an LDAP repository, you have to have the Spring LDAP project on your CLASSPATH. If you are using Maven, add the following dependency to your Maven project:</p>
<pre class="calibre19"><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>   <span class="FontName1">&lt;groupId&gt;org.springframework.ldap&lt;/groupId&gt;</span><br class="calibre2"/>   <span class="FontName1">&lt;artifactId&gt;spring-ldap-core&lt;/artifactId&gt;</span><br class="calibre2"/>   <span class="FontName1">&lt;version&gt;2.0.2.RELEASE&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span></pre></div>
<pre class="calibre11"><span class="FontName">&lt;beans:beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;authentication-manager&gt;</span><br class="calibre10"/>      <span class="FontName">&lt;authentication-provider&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;password-encoder hash="{sha}" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;ldap-user-service server-ref="ldapServer"</span><br class="calibre10"/>          <b class="calibre4">user-search-filter="uid={0}" user-search-base="ou=people"</b><br class="calibre10"/>          <b class="calibre4">group-search-filter="member={0}" group-search-base="ou=groups" /&gt;</b><br class="calibre10"/>      <span class="FontName">&lt;/authentication-provider&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/authentication-manager&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;ldap-server id="ldapServer"</span><br class="calibre10"/>        <span class="FontName">url="ldap://localhost:1389/dc=springrecipes,dc=com"</span><br class="calibre10"/>        <span class="FontName">manager-dn="cn=Directory Manager" manager-password="ldap" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans:beans&gt;</span></pre>
<p class="indent">You have to configure an <span class="FontName">&lt;ldap-user-service&gt;</span> element to define how to search users from an LDAP repository. You can specify the search filters and search bases for searching users and groups via several attributes, whose values must be consistent with the repository’s directory structure. With the preceding attribute values, Spring Security will search a user from the <span class="FontName">people</span> organization unit with a particular user ID and search a user’s groups from the <span class="FontName">groups</span> organization unit. Spring Security will automatically insert the <span class="FontName">ROLE_</span> prefix to each group as an authority.</p>
<p class="indent">As OpenDS uses SSHA (Salted Secure Hash Algorithm) to encode user passwords by default, you have to specify <span class="FontName">{sha}</span> as the hash algorithm in <span class="FontName">&lt;password-encoder&gt;</span>. Note that this value is different from <span class="FontName">sha</span>, as it’s specific to LDAP password encoding.</p>
<p class="indent">Finally, <span class="FontName">&lt;ldap-user-service&gt;</span> has to refer to an LDAP server definition, which defines how to create connections to an LDAP server. You can specify the root user’s username and password to connect to the LDAP server running on localhost.</p>
<p id="Sec28" class="Heading2">Authenticating Users Against an LDAP Repository using Java Config<a id="cXXX.569" class="calibre6"></a></p>
<p class="noindent">You have to configure the LDAP repository using the <span class="FontName">ldapAuthentication</span> method. You can specify the search filters and search bases for searching users and groups via several callback methods, whose values must be consistent with the repository’s directory structure. With the preceding attribute values, Spring Security will search a user from the <span class="FontName">people</span> organization unit with a particular user ID and search a user’s groups from the <span class="FontName">groups</span> organization unit. Spring Security will automatically insert the <span class="FontName">ROLE_</span> prefix to each group as an authority.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(AuthenticationManagerBuilder auth) throws Exception {</span><br class="calibre10"/>       <span class="FontName">auth</span><br class="calibre10"/>           <span class="FontName">.ldapAuthentication()</span><br class="calibre10"/>               <span class="FontName">.contextSource()</span><br class="calibre10"/>                <span class="FontName">.url("ldap://localhost:1389/dc=springrecipes,dc=com")</span><br class="calibre10"/>                <span class="FontName">.managerDn("cn=Directory Manager").managerPassword("ldap")</span><br class="calibre10"/>           <span class="FontName">.and()</span><br class="calibre10"/>               <span class="FontName">.userSearchFilter("uid={0}").userSearchBase("ou=people")</span><br class="calibre10"/>               <span class="FontName">.groupSearchFilter("member={0}").groupSearchBase("ou=groups")</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">.passwordEncoder(new LdapShaPasswordEncoder())</span><br class="calibre10"/>            <span class="FontName">.passwordCompare().passwordAttribute("userPassword");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">As OpenDS uses SSHA (Salted Secure Hash Algorithm) to encode user passwords by default, you have to specify a <span class="FontName">LdapShaPasswordEncoder</span> as the password encoder. Note that this value is different from <span class="FontName">sha</span>, as it’s specific to LDAP password encoding. We also need to specify the <span class="FontName">passwordAttribute</span> because the password encoder needs to know which field in LDAP is the password.</p>
<p class="indent">Finally, we have to refer to an LDAP server definition, which defines how to create connections to an LDAP server. You can specify the root user’s username and password to connect to the LDAP server running on localhost, configure the server using the <span class="FontName">contextSource</span> method.</p>
<p id="Sec29" class="Heading2">Caching User<a id="cXXX.570" class="calibre6"></a> Details</p>
<p class="noindent">Both <span class="FontName">&lt;jdbc-user-service&gt;</span> and <span class="FontName">&lt;ldap-user-service&gt;</span> support caching user details. First of all, you have to choose a cache implementation that provides a caching service. As Spring and Spring Security have built-in support for Ehcache (<span class="FontName"><a href="http://ehcache.sourceforge.net/" class="calibre5">http://ehcache.sourceforge.net/</a></span>), you can choose it as your cache implementation and create a configuration file for it (e.g., <span class="FontName">ehcache.xml</span> in the classpath root) with the following contents:</p>
<pre class="calibre11"><span class="FontName">&lt;ehcache&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;diskStore path="java.io.tmpdir"/&gt;</span>  <br class="calibre10"/>    <span class="FontName">&lt;defaultCache</span><br class="calibre10"/>        <span class="FontName">maxElementsInMemory="1000"</span><br class="calibre10"/>        <span class="FontName">eternal="false"</span><br class="calibre10"/>        <span class="FontName">timeToIdleSeconds="120"</span><br class="calibre10"/>        <span class="FontName">timeToLiveSeconds="120"</span><br class="calibre10"/>        <span class="FontName">overflowToDisk="true"</span><br class="calibre10"/>        <span class="FontName">/&gt;</span>  <br class="calibre10"/>    <span class="FontName">&lt;cache name="userCache"</span><br class="calibre10"/>        <span class="FontName">maxElementsInMemory="100"</span><br class="calibre10"/>        <span class="FontName">eternal="false"</span><br class="calibre10"/>        <span class="FontName">timeToIdleSeconds="600"</span><br class="calibre10"/>        <span class="FontName">timeToLiveSeconds="3600"</span><br class="calibre10"/>        <span class="FontName">overflowToDisk="true"</span><br class="calibre10"/>        <span class="FontName">/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/ehcache&gt;</span></pre>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To use Ehcache to cache objects, you have to have the Ehcache library on your CLASSPATH. If you are using Maven, add the following dependency to your Maven project:</p>
<pre class="calibre19"><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;net.sf.ehcache&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;2.8.3&lt;/version&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;ehcache-core&lt;/artifactId&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span></pre></div>
<p class="indent">This Ehcache configuration file defines two types of cache configurations. One is for the default, and the other is for caching user details. If the user cache configuration is used, a cache instance will cache the details of at most 100 users in memory. The cached users will overflow to disk when this limit is exceeded. A cached user will expire if it has been idle for 10 minutes or live for 1 hour after its creation.</p>
<p class="indent">To enable caching user details in Spring Security, you can set the <span class="FontName">cache-ref</span> attribute of either <span class="FontName">&lt;jdbc-user-service&gt;</span> or <span class="FontName">&lt;ldap-user-service&gt;</span> to refer to a <span class="FontName">UserCache</span> object. Spring Security comes with two <span class="FontName">UserCache</span> implementations, <span class="FontName">EhCacheBasedUserCache</span>, which has to refer to an Ehcache instance and a <span class="FontName">SpringCacheBasedUserCache</span>, which uses Spring’s caching abstraction.</p>
<pre class="calibre11"><span class="FontName">&lt;beans:beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;authentication-manager&gt;</span><br class="calibre10"/>       <span class="FontName">&lt;authentication-provider&gt;</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">&lt;ldap-user-service server-ref="ldapServer"</span><br class="calibre10"/>            <span class="FontName">user-search-filter="uid={0}" user-search-base="ou=people"</span><br class="calibre10"/>            <span class="FontName">group-search-filter="member={0}" group-search-base="ou=groups"</span><br class="calibre10"/>            <b class="calibre4">cache-ref="userCache" /&gt;</b><br class="calibre10"/>       <span class="FontName">&lt;/authentication-provider&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/authentication-manager&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;beans:bean id="userCache" class="org.springframework.security.core.<img src="../images/00053.jpeg" alt="image" class="calibre3"/></span><br class="calibre10"/>        <span class="FontName">userdetails.cache.EhCacheBasedUserCache"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;beans:property name="cache" ref="userEhCache" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/beans:bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;beans:bean id="userEhCache"</span><br class="calibre10"/>        <span class="FontName">class="org.springframework.cache.ehcache.EhCacheFactoryBean"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;beans:property name="cacheManager" ref="cacheManager" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;beans:property name="cacheName" value="userCache" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/beans:bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans:beans&gt;</span></pre>
<p class="indent">In Spring, an Ehcache instance can be created via <span class="FontName">EhCacheFactoryBean</span> by providing a cache manager and a cache name. Spring also provides <span class="FontName">EhCacheManagerFactoryBean</span> for you to create an Ehcache manager by loading a configuration file. By default, it loads <span class="FontName">ehcache.xml</span> (located in the root of the classpath). As an Ehcache manager may be used by other service components, it should be defined in <span class="FontName">board-service.xml</span>.</p>
<pre class="calibre11"><span class="FontName">&lt;bean id="cacheManager"</span><br class="calibre10"/>    <span class="FontName">class="org.springframework.security.core.userdetails.cache.EhCacheManagerFactoryBean" /&gt;</span></pre>
<p class="indent">In Java based configuration, at the moment of writing, only the <span class="FontName">jdbcAuthentication()</span> allows for easy configuration of a user cache. However configuration is quite similar to the one in XML. For a Spring Caching based cache solution (which still delegates to EhCache) we need to configure a <span class="FontName">CacheManage</span><span class="FontName">r</span> and make this aware of EhCache.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class MessageBoardConfiguration {</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public EhCacheCacheManager cacheManager() {</span><br class="calibre10"/>        <span class="FontName">EhCacheCacheManager cacheManager = new EhCacheCacheManager();</span><br class="calibre10"/>        <span class="FontName">cacheManager.setCacheManager(ehCacheManager().getObject());</span><br class="calibre10"/>        <span class="FontName">return cacheManager;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public EhCacheManagerFactoryBean ehCacheManager() {</span><br class="calibre10"/>        <span class="FontName">return new EhCacheManagerFactoryBean();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This is best added to the configuration of the services as the caching can also be used for others means (see the recipes regarding Spring Caching). Now that we have the CacheManager setup we need to configure a <span class="FontName">SpringCacheBasedUserCache</span>.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvcSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Autowired</b><br class="calibre10"/>    <b class="calibre4">private CacheManager cacheManager;</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public SpringCacheBasedUserCache userCache() throws Exception {</span><br class="calibre10"/>        <span class="FontName">Cache cache = cacheManager.getCache("userCache");</span><br class="calibre10"/>        <span class="FontName">return new SpringCacheBasedUserCache(cache);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(AuthenticationManagerBuilder auth) throws Exception {</span><br class="calibre10"/>       <span class="FontName">auth.jdbcAuthentication()</span><br class="calibre10"/>             <b class="calibre4">.userCache(userCache())</b><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice the autowiring of the <span class="FontName">CacheManager</span> into the configuration class. We need access to it because we need to retrieve a <span class="FontName">Cache</span> instance which we pass into the constructor of the <span class="FontName">SpringCacheBasedUseCache</span>. We are going to use the cache named <span class="FontName">userCache</span> (which we configured in the ehcache.xml). Finally we pass the configured UserCache into the <span class="FontName">jdbcAuthentication</span>s <span class="FontName">userCache()</span>.</p>
<p id="Sec30" class="Heading">7-4. Making Access Control Decisions<a id="cXXX.571" class="calibre6"></a></p>
<p id="Sec31" class="Heading1">Problem<a id="cXXX.572" class="calibre6"></a></p>
<p class="noindent">In the authentication process, an application will grant a successfully authenticated user a set of authorities. When this user attempts to access a resource in the application, the application has to decide whether the resource is accessible with the granted authorities or other characteristics.</p>
<p id="Sec32" class="Heading1">Solution</p>
<p class="noindent">The decision on whether a user is allowed to access a resource in an application is called an access control decision. It is made based on the user’s authentication status, and the resource’s nature and access attributes. In Spring Security, access control decisions are made by access decision managers, which have to implement the <span class="FontName">AccessDecisionManager</span> interface. You are free to create your own access decision managers by implementing this interface, but Spring Security comes with three convenient access decision managers based on the voting approach. They are shown in <a id="_Tab6" href="part0017.html#Tab6" class="calibre5">Table 7-6</a>.</p>
<div class="Table" id="Tab6"><p class="TabCapt"><span class="calibre4"><a href="part0017.html#_Tab6" class="calibre5">Table 7-6</a>.</span> Access Decision Managers<a id="cXXX.573" class="calibre5"></a> That Come with Spring Security</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14"><p class="tab-left">Access Decision Manager</p></th><th valign="top" class="calibre14"><p class="tab-left">When to Grant Access</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">AffirmativeBased</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">At least one voter votes to grant access.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">ConsensusBased</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">A consensus of voters votes to grant access.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">UnanimousBased</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">All voters vote to abstain or grant access (no voter votes to deny access).</p></td></tr></tbody></table>
</div>
<p class="indent">All these access decision<a id="cXXX.574" class="calibre5"></a> managers require a group of <i class="calibre8">voters</i> to be configured for voting on access control decisions. Each voter has to implement the <span class="FontName">AccessDecisionVoter</span> interface. A voter can vote to grant, abstain, or deny access to a resource. The voting results are represented by the <span class="FontName">ACCESS_GRANTED</span>, <span class="FontName">ACCESS_DENIED</span>, and <span class="FontName">ACCESS_ABSTAIN</span> constant fields defined in the <span class="FontName">AccessDecisionVoter</span> interface.</p>
<p class="indent">By default, if no access decision manager is specified explicitly, Spring Security will automatically configure an <span class="FontName">AffirmativeBased</span> access decision manager with the following two voters configured:</p>
<p class="indent"><span class="FontName">RoleVoter</span><a id="cXXX.575" class="calibre5"></a> votes for an access control decision based on a user’s role. It will only process access attributes that start with the <span class="FontName">ROLE_</span> prefix, but this prefix can be customized. It votes to grant access if the user has the same role as required to access the resource or to deny access if the user lacks any role required to access the resource. If the resource does not have an access attribute starting with <span class="FontName">ROLE_</span>, it will abstain from voting.</p>
<p class="indent"><span class="FontName">AuthenticatedVoter</span><a id="cXXX.576" class="calibre5"></a> votes for an access control decision based on a user’s authentication level. It will only process the access attributes <span class="FontName">IS_AUTHENTICATED_FULLY</span>, <span class="FontName">IS_AUTHENTICATED_REMEMBERED</span>, and <span class="FontName">IS_AUTHENTICATED_ANONYMOUSLY</span>. It votes to grant access if the user’s authentication level is higher than the required attribute. From highest to lowest, authentication levels are fully authenticated, authentication remembered, and anonymously authenticated.</p>
<p id="Sec33" class="Heading1">How It Works</p>
<p class="noindent">By default, Spring Security will automatically configure an access decision manager if none is specified. This default access decision manager is equivalent to the one defined with the following bean configuration<a id="cXXX.577" class="calibre5"></a>:</p>
<pre class="calibre11"><span class="FontName">&lt;bean id=" accessDecisionManager"</span><br class="calibre10"/>    <span class="FontName">class="org.springframework.security.access.vote.AffirmativeBased"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property name="decisionVoters"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;list&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean class="org.springframework.security.access.vote.RoleVoter" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean class="org.springframework.security.access.vote.AuthenticatedVoter" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/list&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/><span class="FontName">&lt;/bean&gt;</span></pre>
<p class="indent">This default access decision manager and its decision voters should satisfy most typical authorization requirements. However, if they don’t satisfy yours, you can create your own. In most cases, you’ll only need to create a custom voter. For example, you can create a voter to vote for a decision based on a user’s IP address:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.security;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.security.core.Authentication;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.access.ConfigAttribute;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.security.web.authentication.WebAuthenticationDetails;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.access.AccessDecisionVoter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.Collection;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class IpAddressVoter implements AccessDecisionVoter</span><a id="cXXX.578" class="calibre5"></a> <span class="FontName">{</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static final String IP_PREFIX = "IP_";</span><br class="calibre10"/>    <span class="FontName">public static final String IP_LOCAL_HOST = "IP_LOCAL_HOST";</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public boolean supports(ConfigAttribute attribute) {</span><br class="calibre10"/>        <span class="FontName">return attribute.getAttribute() != null</span><br class="calibre10"/>                <span class="FontName">&amp;&amp; attribute.getAttribute().startsWith(IP_PREFIX);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public boolean supports(Class clazz) {</span><br class="calibre10"/>        <span class="FontName">return true;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public int vote(Authentication authentication, Object object,</span><br class="calibre10"/>            <span class="FontName">Collection&lt;ConfigAttribute&gt; configList) {</span><br class="calibre10"/>        <span class="FontName">if (!(authentication.getDetails() instanceof WebAuthenticationDetails)) {</span><br class="calibre10"/>            <b class="calibre4">return ACCESS_DENIED;</b><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">WebAuthenticationDetails details =</span><br class="calibre10"/>            <span class="FontName">(WebAuthenticationDetails) authentication.getDetails();</span><br class="calibre10"/>        <span class="FontName">String address = details.getRemoteAddress();</span><br class="calibre10"/><br class="calibre10"/>        <b class="calibre4">int result = ACCESS_ABSTAIN;</b><br class="calibre10"/>        <span class="FontName">for (ConfigAttribute config : configList) {</span><br class="calibre10"/><br class="calibre10"/>                <b class="calibre4">result = ACCESS_DENIED;</b><br class="calibre10"/>                <span class="FontName">if (IP_LOCAL_HOST.equals(config.getAttribute())) {</span><br class="calibre10"/>                    <span class="FontName">if (address.equals("127.0.0.1") || address.equals("0:0:0:0:0:0:0:1")) {</span><br class="calibre10"/>                        <b class="calibre4">return ACCESS_GRANTED;</b><br class="calibre10"/>                    <span class="FontName">}</span><br class="calibre10"/>                <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">return result;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Note that this voter will only process the access attributes that start with the <span class="FontName">IP_</span> prefix. At the moment, it only supports the <span class="FontName">IP_LOCAL_HOST</span> access attribute. If the user is a web client whose IP address is equal to <span class="FontName">127.0.0.1</span> or <span class="FontName">0:0:0:0:0:0:0:1</span>—the last value being returned by networkless Linux workstations—this voter will vote to grant access. Otherwise, it will vote to deny access. If the resource does not have an access attribute starting with <span class="FontName">IP_</span>, it will abstain from voting.</p>
<p class="indent">Next, you have to define a custom access decision manager that includes this voter. If you define this access decision manager in <span class="FontName">board-security.xml</span><a id="cXXX.579" class="calibre5"></a>, you will have to include the <span class="FontName">beans</span> prefix, because the default schema is <span class="FontName">security</span>.</p>
<pre class="calibre11"><span class="FontName">&lt;beans:bean id="accessDecisionManager"</span><br class="calibre10"/>    <span class="FontName">class="org.springframework.security.access.vote.AffirmativeBased"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;beans:property name="decisionVoters"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;beans:list&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;beans:bean</span><br class="calibre10"/>                <span class="FontName">class="org.springframework.security.access.vote.RoleVoter" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;beans:bean</span><br class="calibre10"/>                <span class="FontName">class="org.springframework.security.acces.vote.AuthenticatedVoter" /&gt;</span><br class="calibre10"/>            <b class="calibre4">&lt;beans:bean class="com.apress.springrecipes.board.security.IpAddressVoter" /&gt;</b><br class="calibre10"/>        <span class="FontName">&lt;/beans:list&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/beans:property&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans:bean&gt;</span></pre>
<p class="indent">Now, suppose you would like to allow users of the machine running the web container (i.e., the server administrators) to delete messages without logging in. You have to refer to this access decision manager from the <span class="FontName">&lt;http&gt;</span> configuration element and add the access attribute <span class="FontName">IP_LOCAL_HOST</span> to the URL pattern <span class="FontName">/messageDelete.htm*</span>:</p>
<pre class="calibre11"><span class="FontName">&lt;http access-decision-manager-ref="accessDecisionManager"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messageList*" access="ROLE_USER,ROLE_GUEST" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messagePost*" access="ROLE_USER" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messageDelete*"</span><br class="calibre10"/>        <span class="FontName">access="ROLE_ADMIN,IP_LOCAL_HOST" /&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">Then, if you access this message board application from localhost, you needn’t log in as an administrator to delete a posted message.</p>
<p id="Sec34" class="Heading2">Using Expressio<a id="cXXX.580" class="calibre6"></a>n to make Access Control Decisions</p>
<p class="noindent">Although the <span class="FontName">AccessDecisionVoter</span>s allow for a certain degree of flexibility sometimes one wants more complex access control rules or be more flexible. With Spring Security it is also possible to use Springs Expression Language (SpEL) to create powerful access control rules.</p>
<p class="indent">To enable the use of expressions (by default this is disabled, unless Java configuration is used) you have to set the <span class="FontName">use-expressions</span> attribute on the <span class="FontName">&lt;http&gt;</span> element to <span class="FontName">true</span>.</p>
<pre class="calibre11"><span class="FontName">&lt;http</span> <b class="calibre4">use-expressions="true"</b><span class="FontName">&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messageList*" access="hasAnyRole('ROLE_USER','ROLE_ANONYMOUS')" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messagePost*" access="hasRole('ROLE_USER')" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messageDelete*" access="hasRole('ROLE_ADMIN')" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;form-login /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">One thing to notice is the value in the <span class="FontName">access</span> attribute of the <span class="FontName">&lt;intercept-url&gt;</span> elements. Those have to be rewritten to be valid expressions. Spring Security supports a couple of expressions out of the box (see <a id="_Tab7" href="part0017.html#Tab7" class="calibre5">Table 7-7</a> for a list). Using constructs like and, or, and not one can create very powerful and flexible expressions.</p>
<div class="Table" id="Tab7"><p class="TabCapt"><span class="calibre4"><a href="part0017.html#_Tab7" class="calibre5">Table 7-7</a>.</span> Spring Security build in expressions</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14"><p class="tab-left">Expression</p></th><th valign="top" class="calibre14"><p class="tab-left">Description</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">hasRole('role')</span></p>
<p class="tab-leftt"><span class="FontName">hasAuthority('authority')</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">Returns <span class="FontName">true</span> if the current user has the given role (authority is the same as role)</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">hasAnyRole('role1','role2') hasAnyAuthority('auth1','auth2')</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">Returns <span class="FontName">true</span> if the current user has at least one of the given roles (authority is the same as role)</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">hasIpAddress('ip-address')</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">Returns <span class="FontName">true</span> if the current user has the given ip-address.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">principal</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">The current user</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">Authentication</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">Access to the Spring Security authentication object.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">permitAll</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">Always evaluates to <span class="FontName">true</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">denyAll</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">Always evaluates to <span class="FontName">false</span></p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">isAnonymous()</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">Returns <span class="FontName">true</span> if the current user is anonymous</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">isRememberMe()</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">Returns <span class="FontName">true</span> if the current user logged in by the means of remember-me functionality</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">isAuthenticated()</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">Returns <span class="FontName">true</span> if this is not an anonymous user</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt"><span class="FontName">isFullyAuthenticated()</span></p></td><td valign="top" class="calibre16"><p class="tab-leftt">Returns <span class="FontName">true</span> if the user is not an anonymous nor a remember-me user.</p></td></tr></tbody></table>
</div>
<p class="indent">When <span class="FontName">use-</span><span class="FontName">expressions</span> is set to <span class="FontName">true</span> Spring Security will automatically configure an access decision manager with a <span class="FontName">WebExpressionVoter</span>. This access decision manager is equivalent to the one defined with the following bean configuration.</p>
<pre class="calibre11"><span class="FontName">&lt;bean id=" accessDecisionManager"</span><br class="calibre10"/>           <span class="FontName">class="org.springframework.security.access.vote.AffirmativeBased"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property name="decisionVoters"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;list&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean class="org.springframework.security.web.access.expression.WebExpressionVoter" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/list&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/><span class="FontName">&lt;/bean&gt;</span></pre>
<pre class="calibre11"><br class="calibre10"/><span class="FontName">&lt;http</span> <b class="calibre4">use-expressions="true"</b><span class="FontName">&gt;</span><br class="calibre10"/>     <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;intercept-url pattern="/messageDelete*"</span><br class="calibre10"/>                           <span class="FontName">access="hasRole('ROLE_ADMIN') or hasIpAddress('127.0.0.1')</span><br class="calibre10"/>    <span class="FontName">or hasIpAddress('0:0:0:0:0:0:0:1') /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span></pre>
<p class="indent">The expression above would give access to deletion of a post if someone had the ADMIN role or was logged in on the local machine. In the previous section we needed to create our own custom <span class="FontName">AccessDecisionVoter</span>, now you only have to write an expression.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">.authorizeRequests()</span><br class="calibre10"/>                <span class="FontName">.antMatchers("/messageList*").hasAnyRole("USER", "GUEST")</span><br class="calibre10"/>                <span class="FontName">.antMatchers("/messagePost*").hasRole("USER")</span><br class="calibre10"/>                <span class="FontName">.antMatchers("/messageDelete*")</span><br class="calibre10"/>            <b class="calibre4">.access("hasRole('ROLE_ADMIN') or hasIpAddress('127.0.0.1') or hasIpAddress('0:0:0:0:0:0:0:1')")</b><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Expression can also be used with Java based configuration, for this you use the <span class="FontName">access</span> method and write the expression inside it.</p>
<p class="indent">Although Spring Security has already several build in functions that can be used when creating expressions it is also possible to extend the functions with your own. For this we need to create a class which implements the <span class="FontName">SecurityExpressionOperations</span> interface and register it with Spring Security. Although it would be possible to create a class which implements all the methods on this interface it is in general easier to extend the default when you want to add expressions.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.security;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.security.core.Authentication;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.web.FilterInvocation;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.web.access.expression.WebSecurityExpressionRoot;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class ExtendedWebSecurityExpressionRoot extends WebSecurityExpressionRoot {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public ExtendedWebSecurityExpressionRoot(Authentication a, FilterInvocation fi) {</span><br class="calibre10"/>        <span class="FontName">super(a, fi);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public boolean localAccess() {</span><br class="calibre10"/>        <span class="FontName">return hasIpAddress("127.0.0.1") || hasIpAddress("0:0:0:0:0:0:0:1");</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">We extended <span class="FontName">WebSecurityExpressionRoot</span> which provides the default implementation and we added the method <span class="FontName">localAccess()</span>. This method checks if we are logging in from the local machine. To make this class available for Spring Security we need to create <span class="FontName">SecurityExpressionHandler</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.security;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.security.access.expression.SecurityExpressionOperations;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.authentication.AuthenticationTrustResolver;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.authentication.AuthenticationTrustResolverImpl;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.core.Authentication;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.web.FilterInvocation;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.web.access.expression.DefaultWebSecurityExpressionHandler;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.web.access.expression.WebSecurityExpressionRoot;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class ExtendedWebSecurityExpressionHandler extends DefaultWebSecurityExpressionHandler {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private AuthenticationTrustResolver trustResolver = new AuthenticationTrustResolverImpl();</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected SecurityExpressionOperations          createSecurityExpressionRoot(Authentication authentication, FilterInvocation fi) {</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ExtendedWebSecurityExpressionRoot root =              new ExtendedWebSecurityExpressionRoot(authentication, fi);</span><br class="calibre10"/>        <span class="FontName">root.setPermissionEvaluator(getPermissionEvaluator());</span><br class="calibre10"/>        <span class="FontName">root.setTrustResolver(trustResolver);</span><br class="calibre10"/>        <span class="FontName">root.setRoleHierarchy(getRoleHierarchy());</span><br class="calibre10"/>        <span class="FontName">return root;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void setTrustResolver(AuthenticationTrustResolver trustResolver) {</span><br class="calibre10"/>        <span class="FontName">this.trustResolver=trustResolver;</span><br class="calibre10"/>        <span class="FontName">super.setTrustResolver(trustResolver);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">We are extending the <span class="FontName">DefaultWebSecurityExpressionHandler</span><a id="cXXX.581" class="calibre5"></a> which provides the default implementation. We override the <span class="FontName">createSecurityExpressionRoot</span> method and let that create an instance of our <span class="FontName">ExtendedWebSecurityExpressionRoot</span> class. As we need to add a couple of collaborators we call the get methods of the superclass. As there isn’t a <span class="FontName">getTrustResolver</span> method we need to create a new instance of that ourselves and implement the setter method.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebSecurity</span><br class="calibre10"/><span class="FontName">public class MessageBoardSecurityConfiguration extends WebSecurityConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected void configure(HttpSecurity http) throws Exception {</span><br class="calibre10"/>        <span class="FontName">http</span><br class="calibre10"/>            <span class="FontName">.authorizeRequests()</span><br class="calibre10"/>                <b class="calibre4">.expressionHandler(new ExtendedWebSecurityExpressionHandler())</b><br class="calibre10"/>                <span class="FontName">.antMatchers("/messageList*").hasAnyRole("USER", "GUEST")</span><br class="calibre10"/>                <span class="FontName">.antMatchers("/messagePost*").hasRole("USER")</span><br class="calibre10"/>                <span class="FontName">.antMatchers("/messageDelete*").access("hasRole('ROLE_ADMIN) or localAccess()")</span></pre>
<p class="indent">We set our custom expression handler with the <span class="FontName">expressionHandler</span> method. Now we can rewrite our expression using our <span class="FontName">localAccess()</span> expression.</p>
<pre class="calibre11"><span class="FontName">&lt;http use-expressions="true" &gt;</span><br class="calibre10"/>  <b class="calibre4">&lt;expression-handler ref="customExpressionHandler" /&gt;</b><br class="calibre10"/>  <span class="FontName">&lt;intercept-url pattern="/messageDelete*" access="hasRole('ROLE_ADMIN') or localAccess()" /&gt;</span><br class="calibre10"/>  <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/http&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;beans:bean id="customExpressionHandler"</span><br class="calibre10"/>                      <span class="FontName">class=" com.apress.springrecipes.board.security.ExtendedWebSecurityExpressionHandler" /&gt;</span></pre>
<p class="indent">When using XML configuration you have to wire up the custom implementation using the <span class="FontName">&lt;expression-handler /&gt;</span> element and create a bean for the <span class="FontName">ExtendedWebSecurityExpressionHandler</span><a id="cXXX.582" class="calibre5"></a>.</p>
<p id="Sec35" class="Heading">7-5. Securing Method Invocations</p>
<p id="Sec36" class="Heading1">Problem<a id="cXXX.583" class="calibre6"></a></p>
<p class="noindent">As an alternative or a complement to securing URL access in the web layer, sometimes you may need to secure method invocations in the service layer. For example, in the case that a single controller has to invoke multiple methods in the service layer, you may wish to enforce fine-grained security controls on these methods.</p>
<p id="Sec37" class="Heading1">Solution</p>
<p class="noindent">Spring Security enables you to secure method invocations in a declarative way. First, you can embed a <span class="FontName">&lt;security:intercept-methods&gt;</span> element in a bean definition to secure its methods. Alternatively, you can configure a global <span class="FontName">&lt;global-method-security&gt;</span> element to secure multiple methods matched with AspectJ pointcut expressions. You can also annotate methods declared in a bean interface or an implementation class with the <span class="FontName">@Secured</span> annotation<a id="cXXX.2175" class="calibre5"></a><a id="cXXX.584" class="calibre5"></a> and then enable security for them in <span class="FontName">&lt;global-method-security&gt;</span> or using the <span class="FontName">@EnableGlobalMethodSecurity</span> annotation.</p>
<p id="Sec38" class="Heading1">How It Works</p>
<p id="Sec39" class="Heading2">Securing Methods by Embedding a Security Interceptor<a id="cXXX.585" class="calibre6"></a></p>
<p class="noindent">First, you can secure a bean’s methods by embedding a <span class="FontName">&lt;security:intercept-methods&gt;</span> element in the bean definition. For example, you can secure the methods of the <span class="FontName">messageBoardService</span> bean defined in <span class="FontName">board-service.xml</span>. As this element is defined in the <span class="FontName">security</span> schema, you have to import it beforehand.</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/> <b class="calibre4">xmlns:security="</b><b class="calibre4"><a href="http://www.springframework.org/schema/security" class="calibre5">http://www.springframework.org/schema/security</a></b><b class="calibre4">"</b><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><br class="calibre10"/>        <b class="calibre4"><a href="http://www.springframework.org/schema/security" class="calibre5">http://www.springframework.org/schema/security</a></b><br class="calibre10"/> <b class="calibre4"><a href="http://www.springframework.org/schema/security/spring-security.xsd" class="calibre5">http://www.springframework.org/schema/security/spring-security.xsd</a></b><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="messageBoardService"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.board.service.MessageBoardServiceImpl"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;security:intercept-methods</span><br class="calibre10"/>            <span class="FontName">access-decision-manager-ref="accessDecisionManager"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;security:protect</span><br class="calibre10"/>                <b class="calibre4">method="com.apress.springrecipes.board.service.MessageBoardService.listMessages"</b><br class="calibre10"/>                <span class="FontName">access="ROLE_USER,ROLE_GUEST" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;security:protect</span><br class="calibre10"/>                <b class="calibre4">method="com.apress.springrecipes.board.service.MessageBoardService.postMessage"</b><br class="calibre10"/>                <span class="FontName">access="ROLE_USER" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;security:protect</span><br class="calibre10"/>                <b class="calibre4">method="com.apress.springrecipes.board.service.MessageBoardService.deleteMessage"</b><br class="calibre10"/>                <span class="FontName">access="ROLE_ADMIN,IP_LOCAL_HOST" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;security:protect</span><br class="calibre10"/>                <b class="calibre4">method="com.apress.springrecipes.board.service.MessageBoardService.findMessageById"</b><br class="calibre10"/>                <span class="FontName">access="ROLE_USER,ROLE_GUEST" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/security:intercept-methods&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">In a bean’s <span class="FontName">&lt;security:intercept-methods&gt;</span>, you can specify multiple <span class="FontName">&lt;security:protect&gt;</span> elements to specify access attributes for this bean’s methods. You can match multiple methods by specifying a method name pattern with wildcards. If you would like to use a custom access decision manager, you can specify it in the <span class="FontName">access-decision-manager-ref</span> attribute.</p>
<p id="Sec40" class="Heading2">Securing Methods<a id="cXXX.586" class="calibre6"></a> with Pointcuts<a id="cXXX.587" class="calibre6"></a></p>
<p class="noindent">Second, you can define global pointcuts in <span class="FontName">&lt;global-method-security&gt;</span> to secure methods using AspectJ pointcut expressions, instead of embedding a security interceptor in each bean whose methods require security. You should configure the <span class="FontName">&lt;global-method-security&gt;</span> element in <span class="FontName">board-security.xml</span> for centralizing security configurations. As the default namespace of this configuration file is <span class="FontName">security</span>, you needn’t specify a prefix for this element explicitly. You can also specify a custom access decision manager in the <span class="FontName">access-decision-manager-ref</span> attribute.</p>
<pre class="calibre11"><span class="FontName">&lt;global-method-security</span><br class="calibre10"/>    <span class="FontName">access-decision-manager-ref="accessDecisionManager"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;protect-pointcut</span><br class="calibre10"/>        expression=<b class="calibre4">"execution(* com.apress.springrecipes.board.service.*Service.list*(..))"</b><br class="calibre10"/>        <span class="FontName">access="ROLE_USER,ROLE_GUEST" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;protect-pointcut</span><br class="calibre10"/>        expression=<b class="calibre4">"execution(* com.apress.springrecipes.board.service.*Service.post*(..))"</b><br class="calibre10"/>        <span class="FontName">access="ROLE_USER" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;protect-pointcut</span><br class="calibre10"/>        expression=<b class="calibre4">"execution(* com.apress.springrecipes.board.service.*Service.delete*(..))"</b><br class="calibre10"/>        <span class="FontName">access="ROLE_ADMIN,IP_LOCAL_HOST" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;protect-pointcut</span><br class="calibre10"/>        expression=<b class="calibre4">"execution(* com.apress.springrecipes.board.service.*Service.find*(..))"</b><br class="calibre10"/>        <span class="FontName">access="ROLE_USER,ROLE_GUEST" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/global-method-security&gt;</span></pre>
<p class="indent">To test this approach, you have to delete the preceding <span class="FontName">&lt;security:intercept-methods&gt;</span> element.</p>
<p id="Sec41" class="Heading2">Securing Methods with Annotations<a id="cXXX.2174" class="calibre6"></a><a id="cXXX.588" class="calibre6"></a></p>
<p class="noindent">The third approach to securing methods is by annotating them with <span class="FontName">@Secured</span>. For example, you can annotate the methods in <span class="FontName">MessageBoardServiceImpl</span> with the <span class="FontName">@Secured</span> annotation and specify the access attributes as its value, whose type is <span class="FontName">String[]</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.security.access.annotation.Secured;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class MessageBoardServiceImpl implements MessageBoardService {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <b class="calibre4">@Secured({"ROLE_USER", "ROLE_GUEST"})</b><br class="calibre10"/>    <span class="FontName">public List&lt;Message&gt; listMessages() {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Secured("ROLE_USER")</b><br class="calibre10"/>    <span class="FontName">public synchronized void postMessage(Message message) {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Secured({"ROLE_ADMIN", "IP_LOCAL_HOST"})</b><br class="calibre10"/>    <span class="FontName">public synchronized void deleteMessage(Message message) {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Secured({"ROLE_USER", "ROLE_GUEST"})</b><br class="calibre10"/>    <span class="FontName">public Message findMessageById(Long messageId) {</span><br class="calibre10"/>        <span class="FontName">return messages.get(messageId);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Then, in <span class="FontName">&lt;global-method-security&gt;</span>, you have to enable security for methods annotated with <span class="FontName">@Secured</span>.</p>
<pre class="calibre11"><span class="FontName">&lt;global-method-security secured-annotations="enabled"</span><br class="calibre10"/>    <span class="FontName">access-decision-manager-ref="accessDecisionManager" /&gt;</span></pre>
<p class="indent">To do the same in Java config we have to add the <span class="FontName">@EnableGlobalMethodSecurity</span> annotation to our configuration class.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><b class="calibre4">@EnableGlobalMethodSecurity(securedEnabled = true)</b><br class="calibre10"/><span class="FontName">public class MessageBoardConfiguration { ... }</span></pre>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  It is important that you add the <span class="FontName">@EnableGlobalMethodSecurity</span> annotation or <span class="FontName">&lt;global-method-security&gt;</span> element to the application context configuration that contains the beans you want to secure!</p></div>
<p id="Sec42" class="Heading">7-6. Handling Security in Views</p>
<p id="Sec43" class="Heading1">Problem<a id="cXXX.589" class="calibre6"></a></p>
<p class="noindent">Sometimes, you may wish to display a user’s authentication information<a id="cXXX.2053" class="calibre5"></a>, such as the principal name and the granted authorities, in the views of your web application. In addition, you would like to render the view contents conditionally according to the user’s authorities.</p>
<p id="Sec44" class="Heading1">Solution</p>
<p class="noindent">Although you can write JSP scriptlets in your JSP files<a id="cXXX.590" class="calibre5"></a> to retrieve authentication and authorization information through the Spring Security API, it’s not an efficient solution. Spring Security provides a JSP tag library for you to handle security in JSP views. It includes tags that can display a user’s authentication information and render the view contents conditionally according to the user’s authorities.</p>
<p id="Sec45" class="Heading1">How It Works</p>
<p id="Sec46" class="Heading2">Displaying Authentication Information<a id="cXXX.591" class="calibre6"></a></p>
<p class="noindent">Suppose you would like to display a user’s principal name and granted authorities in the header of the message listing page (i.e., <span class="FontName">messageList.jsp</span>). First, you have to import Spring Security’s tag library definition.</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="c" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/core" class="calibre5">http://java.sun.com/jsp/jstl/core</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><b class="calibre4">&lt;%@ taglib prefix="security" uri="</b><b class="calibre4"><a href="http://www.springframework.org/security/tags" class="calibre5">http://www.springframework.org/security/tags</a></b><b class="calibre4">" %&gt;</b><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Message List&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">Welcome! &lt;security:authentication property="name" /&gt;&lt;/h2&gt;</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">&lt;security:authentication property="authorities" var="authorities" /&gt;</b><br class="calibre10"/><span class="FontName">&lt;ul&gt;</span><br class="calibre10"/><span class="FontName">&lt;c:forEach items="${authorities}" var="authority"&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;li&gt;${authority.authority}&lt;/li&gt;</span><br class="calibre10"/><span class="FontName">&lt;/c:forEach&gt;</span><br class="calibre10"/><span class="FontName">&lt;/ul&gt;</span><br class="calibre10"/><span class="FontName">&lt;hr /&gt;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">The <span class="FontName">&lt;security:authentication&gt;</span> tag exposes the current user’s <span class="FontName">Authentication</span> object for you to render its properties. You can specify a property name or property path in its <span class="FontName">property</span> attribute. For example, you can render a user’s principal name through the <span class="FontName">name</span> property.</p>
<p class="indent">In addition to rendering an authentication property directly, this tag supports storing the property in a JSP variable, whose name is specified in the <span class="FontName">var</span> attribute. For example, you can store the <span class="FontName">authorities</span> property, which contains the authorities granted to the user, in the JSP variable <span class="FontName">authorities</span>, and render them one by one with a <span class="FontName">&lt;c:forEach&gt;</span> tag. You can further specify the variable scope with the <span class="FontName">scope</span> a<span class="FontName">scope</span> attribute.</p>
<p id="Sec47" class="Heading2">Rendering View Contents<a id="cXXX.592" class="calibre6"></a> Conditionally</p>
<p class="noindent">If you would like to render view contents conditionally according to a user’s authorities, you can use the <span class="FontName">&lt;security:authorize&gt;</span> tag. For example, you can decide whether to render the message authors according to the user’s authorities:</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="c" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/core" class="calibre5">http://java.sun.com/jsp/jstl/core</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;%@ taglib prefix="security" uri="</span><span class="FontName"><a href="http://www.springframework.org/security/tags" class="calibre5">http://www.springframework.org/security/tags</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Message List&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;c:forEach items="${messages}" var="message"&gt;</span><br class="calibre10"/><span class="FontName">&lt;table&gt;</span><br class="calibre10"/> <b class="calibre4">&lt;security:authorize ifAllGranted="ROLE_ADMIN,ROLE_USER"&gt;</b><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Author&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;${message.author}&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/> <b class="calibre4">&lt;/security:authorize&gt;</b><br class="calibre10"/>  <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/table&gt;</span><br class="calibre10"/><span class="FontName">&lt;hr /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/c:forEach&gt;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">If you want the enclosing content to be rendered only when the user has been granted certain authorities at the same time, you have to specify them in the <span class="FontName">ifAllGranted</span> attribute. Otherwise, if the enclosing content can be rendered with any of the authorities, you have to specify them in the <span class="FontName">ifAnyGranted</span> attribute:</p>
<pre class="calibre11"><span class="FontName">&lt;security:authorize ifAnyGranted="ROLE_ADMIN,ROLE_USER"&gt;</span><br class="calibre10"/><span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;td&gt;Author&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;td&gt;${message.author}&lt;/td&gt;</span><br class="calibre10"/><span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/><span class="FontName">&lt;/security:authorize&gt;</span></pre>
<p class="indent">You can also render the enclosing content when a user has not been granted any of the authorities specified in the <span class="FontName">ifNotGranted</span> attribute:</p>
<pre class="calibre11"><span class="FontName">&lt;security:authorize ifNotGranted="ROLE_GUEST"&gt;</span><br class="calibre10"/><span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;td&gt;Author&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;td&gt;${message.author}&lt;/td&gt;</span><br class="calibre10"/><span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/><span class="FontName">&lt;/security:authorize&gt;</span></pre>
<p id="Sec48" class="Heading">7-7. Handling Domain Object Security<a id="cXXX.2030" class="calibre6"></a></p>
<p id="Sec49" class="Heading1">Problem<a id="cXXX.593" class="calibre6"></a></p>
<p class="noindent">Sometimes, you may have complicated security requirements that require handling security at the domain object level. That means you have to allow each domain object to have different access attributes for different principals.</p>
<p id="Sec50" class="Heading1">Solution</p>
<p class="noindent">Spring Security provides a module named ACL<a id="cXXX.594" class="calibre5"></a> that allows each domain object to have its own <i class="calibre8">access control list (ACL)</i>. An ACL contains a domain object’s <i class="calibre8">object identity</i> to associate with the object, and also holds multiple <i class="calibre8">access control entries (ACEs)</i>, each of which contains the following two core parts:</p>
<ul class="bulleted"><li class="calibre17">Permissions: An ACE’s permissions are represented by a particular bit mask, with each bit value for a particular type of permission. The <span class="FontName">BasePermission</span> class predefines five basic permissions as constant values for you to use: <span class="FontName">READ</span> (bit 0 or integer 1), <span class="FontName">WRITE</span> (bit 1 or integer 2), <span class="FontName">CREATE</span> (bit 2 or integer 4), <span class="FontName">DELETE</span> (bit 3 or integer 8), and <span class="FontName">ADMINISTRATION</span> (bit 4 or integer 16). You can also define your own using other unused bits.</li>
<li class="calibre17">Security Identity (SID): Each ACE contains permissions for a particular SID. An SID can be a principal (<span class="FontName">PrincipalSid</span>) or an authority (<span class="FontName">GrantedAuthoritySid</span>) to associate with permissions.</li></ul>
<p class="indent">In addition to defining the ACL object model, Spring Security defines APIs for reading and maintaining the model, and provides high-performance JDBC implementations for these APIs. To simplify ACL’s usages, Spring Security also provides facilities, such as access decision voters and JSP tags, for you to use ACL consistently with other security facilities in your application.</p>
<p id="Sec51" class="Heading1">How It Works</p>
<p id="Sec52" class="Heading2">Setting Up an ACL Service<a id="cXXX.2002" class="calibre6"></a><a id="cXXX.595" class="calibre6"></a></p>
<p class="noindent">Spring Security provides built-in support for storing ACL data in a relational database and accessing it with JDBC. First, you have to create the following tables in your database for storing ACL data:</p>
<pre class="calibre11"><span class="FontName">CREATE TABLE ACL_SID(</span><br class="calibre10"/>    <span class="FontName">ID         BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,</span><br class="calibre10"/>    <span class="FontName">SID        VARCHAR(100)  NOT NULL,</span><br class="calibre10"/>    <span class="FontName">PRINCIPAL  SMALLINT      NOT NULL,</span><br class="calibre10"/>    <span class="FontName">PRIMARY KEY (ID),</span><br class="calibre10"/>    <span class="FontName">UNIQUE (SID, PRINCIPAL)</span><br class="calibre10"/><span class="FontName">);</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">CREATE TABLE ACL_CLASS(</span><br class="calibre10"/>    <span class="FontName">ID     BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,</span><br class="calibre10"/>    <span class="FontName">CLASS  VARCHAR(100)  NOT NULL,</span><br class="calibre10"/>    <span class="FontName">PRIMARY KEY (ID),</span><br class="calibre10"/>    <span class="FontName">UNIQUE (CLASS)</span><br class="calibre10"/><span class="FontName">);</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">CREATE TABLE ACL_OBJECT_IDENTITY(</span><br class="calibre10"/>    <span class="FontName">ID                  BIGINT    NOT NULL GENERATED BY DEFAULT AS IDENTITY,</span><br class="calibre10"/>    <span class="FontName">OBJECT_ID_CLASS     BIGINT    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">OBJECT_ID_IDENTITY  BIGINT    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">PARENT_OBJECT       BIGINT,</span><br class="calibre10"/>    <span class="FontName">OWNER_SID           BIGINT,</span><br class="calibre10"/>    <span class="FontName">ENTRIES_INHERITING  SMALLINT  NOT NULL,</span><br class="calibre10"/>    <span class="FontName">PRIMARY KEY (ID),</span><br class="calibre10"/>    <span class="FontName">UNIQUE (OBJECT_ID_CLASS, OBJECT_ID_IDENTITY),</span><br class="calibre10"/>    <span class="FontName">FOREIGN KEY (PARENT_OBJECT)   REFERENCES ACL_OBJECT_IDENTITY,</span><br class="calibre10"/>    <span class="FontName">FOREIGN KEY (OBJECT_ID_CLASS) REFERENCES ACL_CLASS,</span><br class="calibre10"/>    <span class="FontName">FOREIGN KEY (OWNER_SID)       REFERENCES ACL_SID</span><br class="calibre10"/><span class="FontName">);</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">CREATE TABLE ACL_ENTRY(</span><br class="calibre10"/>    <span class="FontName">ID                  BIGINT    NOT NULL GENERATED BY DEFAULT AS IDENTITY,</span><br class="calibre10"/>    <span class="FontName">ACL_OBJECT_IDENTITY BIGINT    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">ACE_ORDER           INT       NOT NULL,</span><br class="calibre10"/>    <span class="FontName">SID                 BIGINT    NOT NULL,</span><br class="calibre10"/>    <span class="FontName">MASK                INTEGER   NOT NULL,</span><br class="calibre10"/>    <span class="FontName">GRANTING            SMALLINT  NOT NULL,</span><br class="calibre10"/>    <span class="FontName">AUDIT_SUCCESS       SMALLINT  NOT NULL,</span><br class="calibre10"/>    <span class="FontName">AUDIT_FAILURE       SMALLINT  NOT NULL,</span><br class="calibre10"/>    <span class="FontName">PRIMARY KEY (ID),</span><br class="calibre10"/>    <span class="FontName">UNIQUE (ACL_OBJECT_IDENTITY, ACE_ORDER),</span><br class="calibre10"/>    <span class="FontName">FOREIGN KEY (ACL_OBJECT_IDENTITY) REFERENCES ACL_OBJECT_IDENTITY,</span><br class="calibre10"/>    <span class="FontName">FOREIGN KEY (SID)                 REFERENCES ACL_SID</span><br class="calibre10"/><span class="FontName">);</span></pre>
<p class="indent">Spring Security defines APIs and provides high-performance JDBC implementations for you to access ACL data stored in these tables, so you’ll seldom have a need to access ACL data from the database directly.</p>
<p class="indent">As each domain object can have its own ACL, there may be a large number of ACLs in your application. Fortunately, Spring Security supports caching ACL objects. You can continue to use Ehcache as your cache implementation and create a new configuration for ACL caching in <span class="FontName">ehcache.xml</span> (located in the classpath root).</p>
<pre class="calibre11"><span class="FontName">&lt;ehcache&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;cache name="aclCache"</span><br class="calibre10"/>        <span class="FontName">maxElementsInMemory="1000"</span><br class="calibre10"/>        <span class="FontName">eternal="false"</span><br class="calibre10"/>        <span class="FontName">timeToIdleSeconds="600"</span><br class="calibre10"/>        <span class="FontName">timeToLiveSeconds="3600"</span><br class="calibre10"/>        <span class="FontName">overflowToDisk="true"</span><br class="calibre10"/>        <span class="FontName">/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/ehcache&gt;</span></pre>
<p class="indent">Next, you have to set up an ACL service for your application. However, as Spring Security doesn’t support configuring the ACL module with XML schema-based configurations, you have to configure this module with a group of normal Spring beans. As the default namespace of <span class="FontName">board-security.xml</span> is <span class="FontName">security</span>, it’s cumbersome to configure an ACL in this file using the standard XML elements in the <span class="FontName">beans</span> namespace. For this reason, let’s create a separate bean configuration file named <span class="FontName">board-acl.xml</span>, which will store ACL-specific configurations, and add its location in the web deployment descriptor:</p>
<pre class="calibre11"><span class="FontName">&lt;web-app ...&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;context-param&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;param-value&gt;</span><br class="calibre10"/>            <span class="FontName">/WEB-INF/board-service.xml</span><br class="calibre10"/>            <span class="FontName">/WEB-INF/board-security.xml</span><br class="calibre10"/>            <b class="calibre4">/WEB-INF/board-acl.xml</b><br class="calibre10"/>        <span class="FontName">&lt;/param-value&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/context-param&gt;</span><br class="calibre10"/><span class="FontName">&lt;/web-app&gt;</span></pre>
<p class="indent">In an ACL configuration file, the core bean is an ACL service. In Spring Security, there are two interfaces that define operations of an ACL service: <span class="FontName">AclService</span> and <span class="FontName">MutableAclService. AclService</span> defines operations for you to read ACLs. <span class="FontName">MutableAclService</span> is a subinterface of <span class="FontName">AclService</span> that defines operations for you to create, update, and delete ACLs. If your application only needs to read ACLs, you can simply choose an <span class="FontName">AclService</span> implementation, such as <span class="FontName">JdbcAclService</span>. Otherwise, you should choose a <span class="FontName">MutableAclService</span> implementation, such as <span class="FontName">JdbcMutableAclService</span>.</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="aclCache"</span><br class="calibre10"/>               <span class="FontName">class="org.springframework.security.acls.domain.EhCacheBasedAclCache"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg ref="aclEhCache" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg ref="permissionGrantingStrategy" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg ref="authorizationStrategy" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="aclEhCache"</span><br class="calibre10"/>               <span class="FontName">class="org.springframework.cache.ehcache.EhCacheFactoryBean"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="cacheManager" ref="cacheManager" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="cacheName" value="aclCache" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="lookupStrategy"</span><br class="calibre10"/>               <span class="FontName">class="org.springframework.security.acls.jdbc.BasicLookupStrategy"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg ref="dataSource" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg ref="aclCache" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg ref="authorizationStrategy" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg ref="permissionGrantingStrategy" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="authorizationStrategy"</span><br class="calibre10"/>               <span class="FontName">class="org.springframework.security.acls.domain.AclAuthorizationStrategyImpl"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean id="adminRole"</span><br class="calibre10"/>                       <span class="FontName">class="org.springframework.security.core.authority.SimpleGrantedAuthority"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;constructor-arg value="ROLE_ADMIN" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/constructor-arg&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="permissionGrantingStrategy"</span><br class="calibre10"/>               <span class="FontName">class="org.springframework.security.acls.domain.DefaultPermissionGrantingStrategy"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean class="org.springframework.security.acls.domain.ConsoleAuditLogger" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/constructor-arg&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="aclService"</span><br class="calibre10"/>        <span class="FontName">class="org.springframework.security.acls.jdbc.JdbcMutableAclService"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg ref="dataSource" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg ref="lookupStrategy" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg ref="aclCache" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="sidIdentityQuery" value="values identity_val_local()" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">The core bean definition in this ACL configuration file is the ACL service, which is an instance of <span class="FontName">JdbcMutableAclService</span> that allows you to maintain ACLs. This class requires three constructor arguments. The first is a data source for creating connections to a database that stores ACL data. You should have a data source defined in <span class="FontName">board-service.xml</span> beforehand so that you can simply refer to it here (assuming that you have created the ACL tables in the same database). The third constructor argument is a cache instance to use with an ACL, which you can configure using Ehcache as the back-end cache implementation.</p>
<p class="indent">The second argument—<span class="FontName">sidIdentityQuery</span>—is a lookup strategy that performs lookup for an ACL service. Note, if you’re using HSQLDB, that the <span class="FontName">sidIdentityQuery</span>’s property is not necessary, because it defaults to this database. If using another database—as in this case for Apache Derby—an explicit value is necessary.</p>
<p class="indent">The only implementation that comes with Spring Security is <span class="FontName">BasicLookupStrategy</span>, which performs basic lookup using standard and compatible SQL statements. If you want to make use of advanced database features to increase lookup performance, you can create your own lookup strategy by implementing the <span class="FontName">LookupStrategy</span> interface. A <span class="FontName">BasicLookupStrategy</span> instance also requires a data source and a cache instance. Besides, it requires a constructor argument whose type is <span class="FontName">AclAuthorizationStrategy</span>. This object determines whether a principal is authorized to change certain properties of an ACL, usually by specifying a required authority for each category of properties. For the preceding configurations, only a user who has the <span class="FontName">ROLE_ADMIN</span> role can change an ACL’s ownership, an ACE’s auditing details, or other ACL and ACE details, respectively. Finally it needs a constructor argument whose type is <span class="FontName">PermissionGrantingStrategy</span>. This objects responsibility it to check if the Acl grants access to the given Sid with the Permissions it has.</p>
<p class="indent">Finally, <span class="FontName">JdbcMutableAclService</span> embeds standard SQL statements for maintaining ACL data in a relational database. However, those SQL statements may not be compatible with all database products. For example, you have to customize the identity query statement for Apache Derby.</p>
<p id="Sec53" class="Heading2">Maintaining ACLs for Domain Objects<a id="cXXX.2001" class="calibre6"></a><a id="cXXX.596" class="calibre6"></a></p>
<p class="noindent">In your back-end services and DAOs, you can maintain ACLs for domain objects with the previously defined ACL service via dependency injection. For your message board, you have to create an ACL for a message when it is posted and delete the ACL when this message is deleted:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.board.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.model.MutableAcl;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.model.MutableAclService;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.domain.BasePermission;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.model.ObjectIdentity;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.domain.ObjectIdentityImpl;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.domain.GrantedAuthoritySid;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.domain.PrincipalSid;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.access.annotation.Secured;</span><br class="calibre10"/><span class="FontName">import org.springframework.transaction.annotation.Transactional;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public</span> <span class="FontName">class</span> <span class="FontName">MessageBoardServiceImpl implements MessageBoardService {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <b class="calibre4">private MutableAclService mutableAclService;</b><br class="calibre10"/><br class="calibre10"/>     <b class="calibre4">public void setMutableAclService(MutableAclService mutableAclService) {</b><br class="calibre10"/>         <b class="calibre4">this.mutableAclService = mutableAclService;</b><br class="calibre10"/>     <b class="calibre4">}</b><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Transactional</b><br class="calibre10"/>    <span class="FontName">@Secured("ROLE_USER")</span><br class="calibre10"/>    <span class="FontName">public synchronized void postMessage(Message message) {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <b class="calibre4">ObjectIdentity oid = new ObjectIdentityImpl(Message.class, message.getId());</b><br class="calibre10"/>        <b class="calibre4">MutableAcl acl = mutableAclService.createAcl(oid);</b><br class="calibre10"/>        <b class="calibre4">acl.insertAce(0, BasePermission.ADMINISTRATION, new PrincipalSid(message.getAuthor()), true);</b><br class="calibre10"/>        <b class="calibre4">acl.insertAce(1, BasePermission.DELETE, new GrantedAuthoritySid("ROLE_ADMIN"), true);</b><br class="calibre10"/>        <b class="calibre4">acl.insertAce(2, BasePermission.READ, new GrantedAuthoritySid("ROLE_USER"), true);</b><br class="calibre10"/>        <b class="calibre4">mutableAclService.updateAcl(acl);</b><br class="calibre10"/> <b class="calibre4">}</b><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Transactional</b><br class="calibre10"/>    <span class="FontName">@Secured({"ROLE_ADMIN", "IP_LOCAL_HOST"})</span><br class="calibre10"/>    <span class="FontName">public synchronized void deleteMessage(Message message) {</span><br class="calibre10"/>        <b class="calibre4">...</b><br class="calibre10"/>        <b class="calibre4">ObjectIdentity oid = new ObjectIdentityImpl(Message.class, message.getId());</b><br class="calibre10"/>        <b class="calibre4">mutableAclService.deleteAcl(oid, false);</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">When a user posts a message, you create a new ACL for this message at the same time, using the message ID as the ACL’s object identity. When a user deletes a message, you delete the corresponding ACL as well. For a new message, you insert the following three ACEs into its ACL:</p>
<ul class="bulleted"><li class="calibre17">The message author is permitted to administrate this message.</li>
<li class="calibre17">A user who has the <span class="FontName">ROLE_ADMIN</span> role is permitted to delete this message.</li>
<li class="calibre17">A user who has the <span class="FontName">ROLE_USER</span> role is permitted to read this message.</li></ul>
<p class="indent"><span class="FontName">JdbcMutableAclService</span> requires that the calling methods have transactions enabled so that its SQL statements can run within transactions. So, you annotate the two methods involving ACL maintenance with the <span class="FontName">@Transactional</span> annotation and then define a transaction manager and <span class="FontName">&lt;tx:annotation-driven&gt;</span> in <span class="FontName">board-service.xml</span>. Also, don’t forget to inject the ACL service into the message board service for it to maintain ACLs.</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/> <b class="calibre4">xmlns:tx="</b><b class="calibre4"><a href="http://www.springframework.org/schema/tx" class="calibre5">http://www.springframework.org/schema/tx</a></b><b class="calibre4">"</b><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><br class="calibre10"/> <b class="calibre4"><a href="http://www.springframework.org/schema/tx" class="calibre5">http://www.springframework.org/schema/tx</a></b><br class="calibre10"/> <b class="calibre4"><a href="http://www.springframework.org/schema/tx/spring-tx.xsd" class="calibre5">http://www.springframework.org/schema/tx/spring-tx.xsd</a></b><span class="FontName">"&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <b class="calibre4">&lt;tx:annotation-driven /&gt;</b>  <br class="calibre10"/>    <b class="calibre4">&lt;bean id="transactionManager"</b><br class="calibre10"/>               <b class="calibre4">class="org.springframework.jdbc.datasource.DataSourceTransactionManager"&gt;</b><br class="calibre10"/>        <b class="calibre4">&lt;property name="dataSource" ref="dataSource" /&gt;</b><br class="calibre10"/>    <b class="calibre4">&lt;/bean&gt;</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="messageBoardService"</span><br class="calibre10"/>               <span class="FontName">class="com.apress.springrecipes.board.service.MessageBoardServiceImpl"&gt;</span><br class="calibre10"/>         <b class="calibre4">&lt;property name="mutableAclService" ref="aclService" /&gt;</b><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p id="Sec54" class="Heading2">Making Access Control Decisions<a id="cXXX.597" class="calibre6"></a><a id="cXXX.2000" class="calibre6"></a> using expressions</p>
<p class="noindent">With an ACL for each domain object, you can use an object’s ACL to make access control decisions on methods that involve this object. For example, when a user attempts to delete a posted message, you can consult this message’s ACL about whether the user is permitted to delete this message.</p>
<p class="indent">Configuring ACL can be a daunting task, luckily you can use annotations and expressions to make your life easier. We can use the <span class="FontName">@PreAuthorize</span> and <span class="FontName">@PreFilter</span> annotations to check if someone is allowed to execute the method or use certain method arguments. The <span class="FontName">@PostAuthorize</span> and <span class="FontName">@PostFilter</span> can be used to check if a user is allowed to access the result or to filter results based on the ACL.</p>
<p class="indent">To enable the processing of these annotations you need to set the <span class="FontName">pre-post-annotations</span> attribute of the <span class="FontName">&lt;global-method-security&gt;</span> element to <span class="FontName">enabled</span> or when using annotations, the <span class="FontName">prePostEnabled</span> attribute of the <span class="FontName">@EnableGlobalMethodSecurity</span> annotation to <span class="FontName">true</span>.</p>
<pre class="calibre11"><span class="FontName">&lt;global-method-security</span> <b class="calibre4">pre-post-enabled="true"</b> <span class="FontName">... &gt;</span></pre>
<p class="indent">Or for Java based configuration:</p>
<pre class="calibre11"><span class="FontName">@EnableGlobalMethodSecurity(prePostEnabled=true)</span></pre>
<p class="indent">In addition we need to configure infrastructure components to be able to make decisions. We need to setup an <span class="FontName">AclPermissionEvaluator</span> which is needed to evaluate the permission for an object.</p>
<pre class="calibre11"><span class="FontName">&lt;bean id="aclPermissionEvaluator" class="org.springframework.security.acls.AclPermissionEvaluator"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;constructor-arg ref="aclService" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/bean&gt;</span></pre>
<p class="indent">The equivalent in Java config:</p>
<pre class="calibre11"><span class="FontName">package</span> <span class="FontName">com.apress.springrecipes.board.web.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.annotation.Autowired;</span><br class="calibre10"/><span class="FontName">import org.springframework.cache.Cache;</span><br class="calibre10"/><span class="FontName">import org.springframework.cache.CacheManager;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.AclPermissionEvaluator;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.domain.AclAuthorizationStrategyImpl;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.domain.ConsoleAuditLogger;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.domain.DefaultPermissionGrantingStrategy;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.domain.SpringCacheBasedAclCache;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.jdbc.BasicLookupStrategy;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.acls.jdbc.JdbcMutableAclService;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.core.GrantedAuthority;</span><br class="calibre10"/><span class="FontName">import org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.sql.DataSource;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class MessageBoardAclSecurityConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">private DataSource dataSource;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">private CacheManager cacheManager;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public SpringCacheBasedAclCache aclCache() {</span><br class="calibre10"/>        <span class="FontName">Cache cache = cacheManager.getCache("aclCache");</span><br class="calibre10"/>        <span class="FontName">return new SpringCacheBasedAclCache(cache, permissionGrantingStrategy(), authorizationStrategy());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public BasicLookupStrategy lookupStrategy() {</span><br class="calibre10"/>        <span class="FontName">return new BasicLookupStrategy(dataSource, aclCache(),<br class="calibre10"/>                                        authorizationStrategy(), permissionGrantingStrategy());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public DefaultPermissionGrantingStrategy permissionGrantingStrategy() {</span><br class="calibre10"/>        <span class="FontName">return new DefaultPermissionGrantingStrategy(new ConsoleAuditLogger());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public AclAuthorizationStrategyImpl authorizationStrategy() {</span><br class="calibre10"/>        <span class="FontName">return new AclAuthorizationStrategyImpl(new SimpleGrantedAuthority("ROLE_ADMIN"));</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public JdbcMutableAclService jdbcMutableAclService() {</span><br class="calibre10"/>        <span class="FontName">return new JdbcMutableAclService(dataSource, lookupStrategy(), aclCache());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public AclPermissionEvaluator permissionEvaluator() {</span><br class="calibre10"/>        <span class="FontName">return new AclPermissionEvaluator(jdbcMutableAclService());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This might look a little verbose but remember that we did not yet configure the collaborating classes in Java yet, until now ACL was done it in XML. We put the configuration in a separate class <span class="FontName">MessageBoardAclSecurityConfiguration</span>. This class needs also be added to the <span class="FontName">getRootConfigClasses()</span> method of the <span class="FontName">MessageBoardApplicationInitializer</span> class.</p>
<pre class="calibre11"><span class="FontName">@Override</span><br class="calibre10"/><span class="FontName">protected Class&lt;?&gt;[] getRootConfigClasses() {</span><br class="calibre10"/>    <span class="FontName">return new Class&lt;?&gt;[]{MessageBoardConfiguration.class,<br class="calibre10"/>                          MessageBoardSecurityConfiguration.class,</span><br class="calibre10"/>                          <b class="calibre4">MessageBoardAclSecurityConfiguration.class</b><span class="FontName">};</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">AclPermissionEvaluator</span> requires an <span class="FontName">AclService</span> to obtain the ACL for the objects it needs to check. When doing Java based configuration this is enough as the <span class="FontName">PermissionEvaluator</span> will be automatically detected and wired to the <span class="FontName">DefaultMethodSecurityExpressionHandler</span>. When using XML based configuration an extra step is needed, we need to explicitly configure the <span class="FontName">DefaultMethodSecurityExpressionHandler</span> and we need to explicitly wire it to the <span class="FontName">&lt;global-method-security&gt;</span> element.</p>
<pre class="calibre11"><span class="FontName">&lt;bean id="methodExpressionHandler" class="org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="permissionEvaluator" ref="aclPermissionEvaluator" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;security:global-method-security pre-post-annotations="enabled"&gt;</span><br class="calibre10"/>    <b class="calibre4">&lt;security:expression-handler ref="methodExpressionHandler" /&gt;</b><br class="calibre10"/><span class="FontName">&lt;/security:global-method-security&gt;</span></pre>
<p class="indent">Now everything is in place to use the annotations together with expressions to control our access.</p>
<pre class="calibre11"><span class="FontName">public</span> <span class="FontName">class</span> <span class="FontName">MessageBoardServiceImpl implements MessageBoardService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Transactional</span><br class="calibre10"/>    <b class="calibre4">@PreAuthorize("hasPermission(#message, 'delete') or hasPermission(#message, 'admin')")</b><br class="calibre10"/>    <span class="FontName">public synchronized void deleteMessage(Message message) {</span><br class="calibre10"/>        <span class="FontName">messages.remove(message.getId());</span><br class="calibre10"/>        <span class="FontName">ObjectIdentity oid = new ObjectIdentityImpl(Message.class, message.getId());</span><br class="calibre10"/>        <span class="FontName">mutableAclService.deleteAcl(oid, false);</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@PostFilter("hasPermission(filterObject, 'read')")</b><br class="calibre10"/>    <span class="FontName">public List&lt;Message&gt; listMessages() {</span><br class="calibre10"/>        <span class="FontName">return new ArrayList&lt;Message&gt;(messages.values());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@PostAuthorize("hasPermission(returnObject, 'read')")</b><br class="calibre10"/>    <span class="FontName">public Message findMessageById(Long messageId) {</span><br class="calibre10"/>        <span class="FontName">return messages.get(messageId);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You probably noticed the different annotations and the expressions inside these annotations. The <span class="FontName">@PreAuthorize annotation</span> can be used to check if someone has the correct permissions to execute the method. The expression uses <span class="FontName">#message</span> this refers to the method argument with the name <span class="FontName">message</span>. The <span class="FontName">hasPermission</span> expression is a built-in expression from Spring Security (see <a href="part0017.html#Tab7" class="calibre5">Table 7-7</a>).</p>
<p class="indent">The <span class="FontName">@PostFilter</span> annotation<a id="cXXX.598" class="calibre5"></a> allows you to filter the collection and remove the elements someone isn’t allowed to read. In the expression the keyword <span class="FontName">filterObject</span> refers to an element in the collection, to remain in the collection the logged in user needs to have read permission.</p>
<p class="indent"><span class="FontName">@PostAuthorize</span> can be used to check if a single return value can be used (i.e., if the user has the right permissions). To use the return value in an expression use the keyword <span class="FontName">returnObject</span>.</p>
<p id="Sec55" class="Heading">Summary</p>
<p class="noindent">In this chapter, you learned how to secure applications using Spring Security 3.2. It can be used to secure any Java application, but it’s mostly used for web applications<a id="cXXX.2268" class="calibre5"></a>. The concepts of authentication, authorization, and access control are essential in the security area, so you should have a clear understanding of them.</p>
<p class="indent">You often have to secure critical URLs by preventing unauthorized access to them. Spring Security can help you to achieve this in a declarative way. It handles security by applying servlet filters, which can be configured with simple XML elements or java based configuration. If your web application’s security requirements are simple and typical, you can enable the HTTP <span class="FontName">auto-config</span> feature so that Spring Security will automatically configure the basic security services for you.</p>
<p class="indent">Spring Security supports multiple ways for users to log into a web application, such as form-based login and HTTP Basic authentication. It also provides an anonymous login service that allows you to handle an anonymous user just like a normal user. Remember-me support allows an application to remember a user’s identity across multiple browser sessions.</p>
<p class="indent">Spring Security supports multiple ways of authenticating users and has built-in provider implementations for them. For example, it supports authenticating users against in-memory definitions, a relational database, and an LDAP repository. You should always store encrypted passwords in your user repository, because clear-text passwords are vulnerable to hacker attacks. Spring Security also supports caching user details locally to save you the overhead of performing remote queries.</p>
<p class="indent">Decisions on whether a user is allowed to access a given resource are made by access decision managers. Spring Security comes with three access decision managers that are based on the voting approach. All of them require a group of voters to be configured for voting on access control decisions.</p>
<p class="indent">Spring Security enables you to secure method invocations in a declarative way, either by embedding a security interceptor in a bean definition, or matching multiple methods with AspectJ pointcut expressions or annotations. Spring Security also allows you to display a user’s authentication information in JSP views and render view contents conditionally according to a user’s authorities.</p>
<p class="indent">Spring Security provides an ACL module that allows each domain object to have an ACL for controlling access. You can read and maintain an ACL for each domain object with Spring Security’s high-performance APIs, which are implemented with JDBC. Spring Security also provides facilities such as access decision voters and JSP tags for you to use ACLs consistently with other security facilities.</p></div>
</body></html>
