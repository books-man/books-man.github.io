<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Chapter 2 Spring Core Tasks</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre"><div class="calibre10"><pre class="calibre11"><span class="FontName">&lt;beans profile='spring'&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="aaa" class="com.apress.springrecipes.shop.Battery"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="name" value="AAA" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="price" value="2.5" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="cdrw" class="com.apress.springrecipes.shop.Disc"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="name" value="CD-RW" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="price" value="1.5" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;beans profile='summer,winter'&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="aaa" class="com.apress.springrecipes.shop.Battery"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="name" value="AAA" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="price" value="2.0" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="cdrw" class="com.apress.springrecipes.shop.Disc"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="name" value="CD-RW" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="price" value="1.0" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">Notice how the <span class="FontName">&lt;beans&gt;</span> tags are nested to delimit the different beans that belong to each profile. In addition, a group of beans can also belong to several profiles, where each profile name is defined as a csv list value for the <span class="FontName">profile</span> attribute.</p>
<p id="Sec75" class="Heading2">Load Profile into Environment</p>
<p class="noindent">To load the beans from a certain profile into an application, you need to activate a profile. You can load multiple profiles at a time and it’s also possible to load profiles programmatically, through a Java runtime flag or even as an initialization parameter of a WAR file.</p>
<p class="indent">To load profiles programmatically (i.e., via the application context) you get the context environment from where you can load profiles via the <span class="FontName">setActiveProfiles()</span> method.</p>
<pre class="calibre11"><span class="FontName">GenericXmlApplicationContext ApplicationContext context = new GenericXmlApplicationContext();</span><br class="calibre10"/><span class="FontName">context.getEnvironment().setActiveProfiles("global","summer");</span><br class="calibre10"/><span class="FontName">context.load("beans.xml");</span><br class="calibre10"/><span class="FontName">context.refresh();</span><br class="calibre10"/><span class="FontName">/**At this point beans declared in beans.xml with the global and summer profiles are accessible*/</span></pre><p class="indent">It’s also possible to indicate which Spring profile to load via a Java runtime flag. In this manner, you can pass the following runtime flag to load all beans that belong to the global and winter profiles: <span class="FontName">-Dspring.profiles.active="global,winter"</span></p>
<p class="indent">Finally, a Spring profile can also be setup directly inside a WAR’s <span class="FontName">web.xml</span> configuration file. This scenario is relevant for Spring web applications.</p>
<pre class="calibre11"><span class="FontName">&lt;servlet&gt;</span><br class="calibre10"/> <span class="FontName">&lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt;</span><br class="calibre10"/> <span class="FontName">&lt;servlet-class&gt;</span><br class="calibre10"/>   <span class="FontName">org.springframework.web.servlet.DispatcherServlet</span><br class="calibre10"/> <span class="FontName">&lt;/servlet-class&gt;</span><br class="calibre10"/> <span class="FontName">&lt;init-param&gt;</span><br class="calibre10"/>   <span class="FontName">&lt;param-name&gt; spring.profiles.active&lt;/param-name&gt;</span><br class="calibre10"/>   <span class="FontName">&lt;param-value&gt;winter&lt;/param-value&gt;</span><br class="calibre10"/> <span class="FontName">&lt;/init-param&gt;</span><br class="calibre10"/><span class="FontName">&lt;/servlet&gt;</span></pre><p id="Sec76" class="Heading2">Set Default Profile</p>
<p class="noindent">To avoid the possibility of errors because no profiles are loaded into an application, you can define default profiles. Default profiles are only used when Spring can’t detect any active profiles—defined using any of the previous methods: programmatically, via a Java runtime flag or web application initialization parameter.</p>
<p class="indent">To setup default profiles, you can also use any of the three methods to setup active profiles. Programmatically you use the method <span class="FontName">setDefaultProfiles()</span> instead of <span class="FontName">setActiveProfiles()</span>, and via a Java runtime flag or web application initialization parameter you can use the <span class="FontName">spring.profiles.default</span> parameter instead of <span class="FontName">spring.profiles.active</span>.</p>
<p id="Sec77" class="Heading">2-12. Aspect Orientated Programming</p>
<p id="Sec78" class="Heading1">Problem</p>
<p class="noindent"><a id="cXXX.138" class="calibre5"></a>You want to use aspect orientated programming with Spring.</p>
<p id="Sec79" class="Heading1">Solution</p>
<p class="noindent"><a id="cXXX.139" class="calibre5"></a>Define POJOs to be aspects and define them inside the <span class="FontName">&lt;aop:aspect&gt;</span> XML element, surrounded by the <span class="FontName">&lt;aop:config&gt;</span> element. Next, define pointcuts to apply the aspect to certain objects and types with the <span class="FontName">&lt;aop:pointcut&gt;</span> element. Finally, to indicate at which point to apply aspects, define any of the five advices supported by Spring AOP: <span class="FontName">&lt;aop:before&gt;</span>, <span class="FontName">&lt;aop:after&gt;</span>,<span class="FontName">&lt;aop:after-returning&gt;</span>, <span class="FontName">&lt;aop:after-throwing&gt;</span>, or <span class="FontName">&lt;aop:around&gt;</span>.</p>
<p id="Sec80" class="Heading1">How It Works</p>
<p class="noindent">To illustrate how to apply aspect orientated programming in Spring, we’ll use the following calculator interfaces to define a set of sample POJOs:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.calculator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface ArithmeticCalculator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double add(double a, double b);</span><br class="calibre10"/>    <span class="FontName">public double sub(double a, double b);</span><br class="calibre10"/>    <span class="FontName">public double mul(double a, double b);</span><br class="calibre10"/>    <span class="FontName">public double div(double a, double b);</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">package com.apress.springrecipes.calculator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface UnitCalculator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double kilogramToPound(double kilogram);</span><br class="calibre10"/>    <span class="FontName">public double kilometerToMile(double kilometer);</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent"><a id="cXXX.140" class="calibre5"></a>Next, let’s create POJO classes for each interface with println statements to know when each method is executed:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.calculator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class ArithmeticCalculatorImpl implements ArithmeticCalculator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double add(double a, double b) {</span><br class="calibre10"/>        <span class="FontName">double result = a + b;</span><br class="calibre10"/>        <span class="FontName">System.out.println(a + " + " + b + " = " + result);</span><br class="calibre10"/>        <span class="FontName">return result;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double sub(double a, double b) {</span><br class="calibre10"/>        <span class="FontName">double result = a - b;</span><br class="calibre10"/>        <span class="FontName">System.out.println(a + " - " + b + " = " + result);</span><br class="calibre10"/>        <span class="FontName">return result;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">public double mul(double a, double b) {</span><br class="calibre10"/>        <span class="FontName">double result = a * b;</span><br class="calibre10"/>        <span class="FontName">System.out.println(a + " * " + b + " = " + result);</span><br class="calibre10"/>        <span class="FontName">return result;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double div(double a, double b) {</span><br class="calibre10"/>        <span class="FontName">if (b == 0) {</span><br class="calibre10"/>            <span class="FontName">throw new IllegalArgumentException("Division by zero");</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">double result = a / b;</span><br class="calibre10"/>        <span class="FontName">System.out.println(a + " / " + b + " = " + result);</span><br class="calibre10"/>        <span class="FontName">return result;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">package com.apress.springrecipes.calculator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class UnitCalculatorImpl implements UnitCalculator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double kilogramToPound(double kilogram) {</span><br class="calibre10"/>        <span class="FontName">double pound = kilogram * 2.2;</span><br class="calibre10"/>        <span class="FontName">System.out.println(kilogram + " kilogram = " + pound + " pound");</span><br class="calibre10"/>        <span class="FontName">return pound;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double kilometerToMile(double kilometer) {</span><br class="calibre10"/>        <span class="FontName">double mile = kilometer * 0.62;</span><br class="calibre10"/>        <span class="FontName">System.out.println(kilometer + " kilometer = " + mile + " mile");</span><br class="calibre10"/>        <span class="FontName">return mile;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p id="Sec81" class="Heading2">Declaring Aspects</p>
<p class="noindent"><a id="cXXX.141" class="calibre5"></a>An aspect is a Java class that modularizes a set of concerns (e.g., logging or transaction management) that cuts across multiple types and objects. In AOP terminology, aspects are also complemented by advices, which in themselves have pointcuts. An advice is a simple Java method—contained in an aspect class—that contains logic to execute at different lifecycles of the aspect. Where as a pointcut is an expression that looks for types and objects on which to apply the aspect’s advices.</p>
<p class="indent">The following is a POJO class to be used as an aspect with several methods to act as advices.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.calculator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.Arrays;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.apache.commons.logging.Log;</span><br class="calibre10"/><span class="FontName">import org.apache.commons.logging.LogFactory;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.aspectj.lang.JoinPoint;</span><br class="calibre10"/><span class="FontName">import org.aspectj.lang.ProceedingJoinPoint;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class CalculatorLoggingAspect {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private Log log = LogFactory.getLog(this.getClass());</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void logBefore(JoinPoint joinPoint) {</span><br class="calibre10"/>        <span class="FontName">log.info("The method " + joinPoint.getSignature().getName()</span><br class="calibre10"/>                <span class="FontName">+ "() begins with " + Arrays.toString(joinPoint.getArgs()));</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void logAfter(JoinPoint joinPoint) {</span><br class="calibre10"/>        <span class="FontName">log.info("The method " + joinPoint.getSignature().getName()</span><br class="calibre10"/>                <span class="FontName">+ "() ends");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void logAfterReturning(JoinPoint joinPoint, Object result) {</span><br class="calibre10"/>        <span class="FontName">log.info("The method " + joinPoint.getSignature().getName()</span><br class="calibre10"/>                <span class="FontName">+ "() ends with " + result);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void logAfterThrowing(JoinPoint joinPoint,</span><br class="calibre10"/>            <span class="FontName">IllegalArgumentException e) {</span><br class="calibre10"/>        <span class="FontName">log.error("Illegal argument " + Arrays.toString(joinPoint.getArgs())</span><br class="calibre10"/>                <span class="FontName">+ " in " + joinPoint.getSignature().getName() + "()");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Object logAround(ProceedingJoinPoint joinPoint) throws Throwable {</span><br class="calibre10"/>        <span class="FontName">log.info("The method " + joinPoint.getSignature().getName()</span><br class="calibre10"/>                <span class="FontName">+ "() begins with " + Arrays.toString(joinPoint.getArgs()));</span><br class="calibre10"/>        <span class="FontName">try {</span><br class="calibre10"/>            <span class="FontName">Object result = joinPoint.proceed();</span><br class="calibre10"/>            <span class="FontName">log.info("The method " + joinPoint.getSignature().getName()</span><br class="calibre10"/>                    <span class="FontName">+ "() ends with " + result);</span><br class="calibre10"/>            <span class="FontName">return result;</span><br class="calibre10"/>        <span class="FontName">} catch (IllegalArgumentException e) {</span><br class="calibre10"/>            <span class="FontName">log.error("Illegal argument "</span><br class="calibre10"/>                    <span class="FontName">+ Arrays.toString(joinPoint.getArgs()) + " in "</span><br class="calibre10"/>                    <span class="FontName">+ joinPoint.getSignature().getName() + "()");</span><br class="calibre10"/>            <span class="FontName">throw e;</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  For the previous aspect to work (i.e., output its message) you need to setup logging. Specifically create a log4j.properties file with configuration properties like the following:</p>
<p class="paraaftertitle">log4j.rootLogger=INFO, A1</p>
<p class="paraaftertitle">log4j.appender.A1=org.apache.log4j.ConsoleAppender</p>
<p class="paraaftertitle">log4j.appender.A1.layout=org.apache.log4j.PatternLayout</p>
<p class="paraaftertitle">log4j.appender.A1.layout.ConversionPattern=%-4r [%t] %-5p %c %x - %m%n</p></div>
<p class="indent">Once you have the POJO aspect class, you declare aspects in Spring simply by defining them as bean instances in the IoC container. The Spring AOP schema must be present in the <span class="FontName">&lt;beans&gt;</span> root element, because all the Spring AOP configurations must be defined inside the <span class="FontName">&lt;aop:config&gt;</span> element.</p>
<p class="indent">For each aspect, you create a standard bean for the aspect POJO, as well as an <span class="FontName">&lt;aop:aspect&gt;</span> element to refer to a backing bean instance for the concrete aspect implementation. So, your aspect beans must have an identifier for the <span class="FontName">&lt;aop:aspect&gt;</span> elements to refer to.</p>
<pre class="calibre11"><span class="FontName">&lt;beans   xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:aop="</span><span class="FontName"><a href="http://www.springframework.org/schema/aop" class="calibre5">http://www.springframework.org/schema/aop</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans-3.2.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/aop" class="calibre5">http://www.springframework.org/schema/aop</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/aop/spring-aop-3.2.xsd" class="calibre5">http://www.springframework.org/schema/aop/spring-aop-3.2.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;aop:config&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;aop:aspect id="loggingAspect" ref="calculatorLoggingAspect"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/aop:aspect&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/aop:config&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="calculatorLoggingAspect"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.calculator.CalculatorLoggingAspect" /&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p id="Sec82" class="Heading2">Declaring Pointcuts</p>
<p class="noindent"><a id="cXXX.142" class="calibre5"></a>A pointcut may be defined either under the <span class="FontName">&lt;aop:aspect&gt;</span> element or directly under the <span class="FontName">&lt;aop:config&gt;</span> element. In the former case, the pointcut becomes visible to the declaring aspect only. In the latter case, it becomes a global pointcut definition visible to all the aspects.</p>
<p class="indent">Unlike AspectJ annotations, XML-based AOP configurations don’t allow you to refer to other pointcuts by name within a pointcut expression. That means you must copy the referred pointcut expression and embed it directly.</p>
<pre class="calibre11"><span class="FontName">&lt;aop:config&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;aop:pointcut id="loggingOperation" expression=</span><br class="calibre10"/>        <span class="FontName">"within(com.apress.springrecipes.calculator.ArithmeticCalculator+) ||</span><br class="calibre10"/>        <span class="FontName">within(com.apress.springrecipes.calculator.UnitCalculator+)" /&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/aop:config&gt;</span></pre><p class="indent">This last snippet applies the <span class="FontName">loggingOperation</span> aspect to classes that either use the <span class="FontName">ArtihmeticCalculator</span> or <span class="FontName">UnitCalculator</span>. The <span class="FontName">||</span> operator stands for or. Note that when using AspectJ annotations, you can join two pointcut expressions with the operator <span class="FontName">&amp;&amp;</span> (and). However, the character <span class="FontName">&amp;</span> stands for “entity reference” in XML, so the pointcut operator <span class="FontName">&amp;&amp;</span> isn’t valid in an XML document. You have to use the keyword <span class="FontName">and</span> instead.</p>
<p id="Sec83" class="Heading2">Declaring Advices</p>
<p class="noindent"><a id="cXXX.143" class="calibre5"></a>In the AOP schema, there are five different XML elements to declare advices: <span class="FontName">&lt;aop:before&gt;</span>, <span class="FontName">&lt;aop:after&gt;</span>,<span class="FontName">&lt;aop:after-returning&gt;</span>, <span class="FontName">&lt;aop:after-throwing&gt;</span>, or <span class="FontName">&lt;aop:around&gt;</span>.</p>
<p class="indent">An advice element requires either a <span class="FontName">pointcut-ref</span> attribute to refer to a pointcut or a <span class="FontName">pointcut</span> attribute to embed a pointcut expression directly. The <span class="FontName">method</span> attribute specifies the name of the advice method in the aspect class.</p>
<pre class="calibre11"><span class="FontName">&lt;aop:config&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;aop:aspect id="loggingAspect" ref="calculatorLoggingAspect"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;aop:before pointcut-ref="loggingOperation"</span><br class="calibre10"/>            <span class="FontName">method="logBefore" /&gt;</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">&lt;aop:after pointcut-ref="loggingOperation"</span><br class="calibre10"/>            <span class="FontName">method="logAfter" /&gt;</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">&lt;aop:after-returning pointcut-ref="loggingOperation"</span><br class="calibre10"/>            <span class="FontName">returning="result" method="logAfterReturning" /&gt;</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">&lt;aop:after-throwing pointcut-ref="loggingOperation"</span><br class="calibre10"/>            <span class="FontName">throwing="e" method="logAfterThrowing" /&gt;</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">&lt;aop:around pointcut-ref="loggingOperation"</span><br class="calibre10"/>            <span class="FontName">method="logAround" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/aop:aspect&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/aop:config&gt;</span></pre><p id="Sec84" class="Heading2">Define a Concrete Class to Test AOP</p>
<p class="noindent"><a id="cXXX.144" class="calibre5"></a>Once you’ve defined the Aspect class, as well as declared the aspects, pointcuts and advices in a XML configuration file, you can test the aspect with the following Main class:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.calculator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.GenericXmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">ApplicationContext context =</span><br class="calibre10"/>            <span class="FontName">new GenericXmlApplicationContext("beans.xml");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ArithmeticCalculator arithmeticCalculator =</span><br class="calibre10"/>            <span class="FontName">(ArithmeticCalculator) context.getBean("arithmeticCalculator");</span><br class="calibre10"/>        <span class="FontName">arithmeticCalculator.add(1, 2);</span><br class="calibre10"/>        <span class="FontName">arithmeticCalculator.sub(4, 3);</span><br class="calibre10"/>        <span class="FontName">arithmeticCalculator.mul(2, 3);</span><br class="calibre10"/>        <span class="FontName">arithmeticCalculator.div(4, 2);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">UnitCalculator unitCalculator =</span><br class="calibre10"/>            <span class="FontName">(UnitCalculator) context.getBean("unitCalculator");</span><br class="calibre10"/>        <span class="FontName">unitCalculator.kilogramToPound(10);</span><br class="calibre10"/>        <span class="FontName">unitCalculator.kilometerToMile(5);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p id="Sec85" class="Heading">2-13. Declare POJOs<a id="cXXX.2027" class="calibre6"></a> from Static Fields or Object Properties</p>
<p id="Sec86" class="Heading1">Problem</p>
<p class="noindent">You want to declare a be<a id="cXXX.145" class="calibre5"></a>an in the Spring IoC container from a static field, from an object property or a nested property (i.e., a property path).</p>
<p id="Sec87" class="Heading1">Solution</p>
<p class="noindent">To declare a bean from a static field, you can make use of either the built-in factory bean <span class="FontName">FieldRetrievingFactoryBean</span> or the <span class="FontName">&lt;util:constant&gt;</span> tag.</p>
<p class="indent">To declare a bean from an object property or a property path, you can make use of either the built-in factory bean <span class="FontName">PropertyPathFactoryBean</span> or the <span class="FontName">&lt;util:property-path&gt;</span> tag.</p>
<p id="Sec88" class="Heading1">How It Works</p>
<p id="Sec89" class="Heading2">Declare POJOs from Static Fields</p>
<p class="noindent"><a id="cXXX.146" class="calibre5"></a>First, let’s define two product constants in the Product class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><span class="FontName">public abstract class Product {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static final Product AAA = new Battery("AAA", 2.5);</span><br class="calibre10"/>    <span class="FontName">public static final Product CDRW = new Disc("CD-RW", 1.5);</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">To declare a bean from a static field, you can make use of the built-in factory bean <span class="FontName">FieldRetrievingFactoryBean</span> and specify the fully qualified field name in the <span class="FontName">staticField</span> property.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="aaa" class="org.springframework.beans.factory.config.</span><br class="calibre10"/>        <span class="FontName">FieldRetrievingFactoryBean"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="staticField"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;value&gt;com.apress.springrecipes.shop.Product.AAA&lt;/value&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="cdrw" class="org.springframework.beans.factory.config.</span><br class="calibre10"/>        <span class="FontName">FieldRetrievingFactoryBean"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="staticField"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;value&gt;com.apress.springrecipes.shop.Product.CDRW&lt;/value&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">The preceding bean configuration is equivalent to the following code snippet:</p>
<pre class="calibre11"><span class="FontName">Product aaa = com.apress.springrecipes.shop.Product.AAA;</span><br class="calibre10"/><span class="FontName">Product cdrw = com.apress.springrecipes.shop.Product.CDRW;</span></pre><p class="indent">Another alternative is to declare a bean from a static field by using the <span class="FontName">&lt;util:constant&gt;</span> tag. Compared to using <span class="FontName">FieldRetrievingFactoryBean</span>, it is a simpler way of declaring beans from static fields. But before this tag can work, you must add the <span class="FontName">util</span> schema definition to your <span class="FontName">&lt;beans&gt;</span> root element.</p>
<pre class="calibre11"><span class="FontName">&lt;beans   xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:util="</span><span class="FontName"><a href="http://www.springframework.org/schema/util" class="calibre5">http://www.springframework.org/schema/util</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans-3.2.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/util" class="calibre5">http://www.springframework.org/schema/util</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/util/spring-util-3.2.xsd" class="calibre5">http://www.springframework.org/schema/util/spring-util-3.2.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;util:constant id="aaa"</span><br class="calibre10"/>        <span class="FontName">static-field="com.apress.springrecipes.shop.Product.AAA" /&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;util:constant id="cdrw"</span><br class="calibre10"/>        <span class="FontName">static-field="com.apress.springrecipes.shop.Product.CDRW" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p id="Sec90" class="Heading2">Declare POJOs from Object Properties</p>
<p class="noindent"><a id="cXXX.147" class="calibre5"></a>As an example, let’s create a <span class="FontName">ProductRanking</span> class with a <span class="FontName">bestSeller</span> property whose type is <span class="FontName">Product</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><span class="FontName">public class ProductRanking {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private Product bestSeller;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Product getBestSeller() {</span><br class="calibre10"/>        <span class="FontName">return bestSeller;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setBestSeller(Product bestSeller) {</span><br class="calibre10"/>        <span class="FontName">this.bestSeller = bestSeller;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">In the following bean declaration, the <span class="FontName">bestSeller</span> property is declared as an inner bean. By definition, you cannot retrieve an inner bean by its name. However, you can retrieve it as a property of the <span class="FontName">productRanking</span> bean. The factory bean <span class="FontName">PropertyPathFactoryBean</span> can be used to declare a bean from an object property or a property path.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="productRanking"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.shop.ProductRanking"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="bestSeller"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean class="com.apress.springrecipes.shop.Disc"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;property name="name" value="CD-RW" /&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;property name="price" value="1.5" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="bestSeller"</span><br class="calibre10"/>        <span class="FontName">class="org.springframework.beans.factory.config.PropertyPathFactoryBean"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="targetObject" ref="productRanking" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="propertyPath" value="bestSeller" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">Note that the <span class="FontName">propertyPath</span> property of <span class="FontName">PropertyPathFactoryBean</span> can accept not only a single property name but also a property path with dots as the separators. The preceding bean configuration is equivalent to the following code snippet:</p>
<pre class="calibre11"><span class="FontName">Product bestSeller = productRanking.getBestSeller();</span></pre><p class="indent">Another alternative is to declare a bean from an object property or a property path by using the <span class="FontName">&lt;util:property-path&gt;</span> tag. Compared to using <span class="FontName">PropertyPathFactoryBean</span>, it is a simpler way of declaring beans from properties. But before this tag can work, you must add the util schema definition to your <span class="FontName">&lt;beans&gt;</span> root element.</p>
<pre class="calibre11"><span class="FontName">&lt;beans   xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:util="</span><span class="FontName"><a href="http://www.springframework.org/schema/util" class="calibre5">http://www.springframework.org/schema/util</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans-3.2.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/util" class="calibre5">http://www.springframework.org/schema/util</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/util/spring-util-3.2.xsd" class="calibre5">http://www.springframework.org/schema/util/spring-util-3.2.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;util:property-path id="bestSeller" path="productRanking.bestSeller" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">You can test this property path by retrieving it from the IoC container and printing it to the console.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">Product bestSeller = (Product) context.getBean("bestSeller");</span><br class="calibre10"/>        <span class="FontName">System.out.println(bestSeller);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p id="Sec91" class="Heading">2-14. Making POJOs Aware of Spring’s IoC Container Resources<a id="cXXX.2136" class="calibre6"></a></p>
<p id="Sec92" class="Heading1">Problem</p>
<p class="noindent"><a id="cXXX.148" class="calibre5"></a>Even though a well-designed component should not have direct dependencies on Spring’s IoC container, sometimes it’s necessary for beans to be aware of the container’s<a id="cXXX.2135" class="calibre5"></a> resources.</p>
<p id="Sec93" class="Heading1">Solution</p>
<p class="noindent">Your beans can be aware of the Spring IoC container’s resources by implementing certain “aware” interfaces, shown in <a id="_Tab3" href="part0011.html#Tab3" class="calibre5">Table 2-3</a>. Spring injects the corresponding resources to beans that implement these interfaces via the setter methods defined in these interfaces.</p>
<div class="Table" id="Tab3">
<p class="TabCapt"><span class="calibre4"><a href="part0011.html#_Tab3" class="calibre5">Table 2-3</a>.</span> Common Aware Interfaces in Spring</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14">
<p class="tab-left">Aware Interface</p></th><th valign="top" class="calibre14">
<p class="tab-left">Target Resource Type</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">BeanNameAware</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">The bean name of its instances configured in the IoC container.</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">BeanFactoryAware</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">The current bean factory, through which you can invoke the container’s services</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">ApplicationContextAware*</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">The current application context, through which you can invoke the container’s services</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">MessageSourceAware</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">A message source, through which you can resolve text messages</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">ApplicationEventPublisherAware</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">An application event publisher, through which you can publish application events</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">ResourceLoaderAware</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">A resource loader, through which you can load external resources</p></td></tr></tbody></table>
<p class="noindent"><i class="calibre8">* The ApplicationContext interface in fact extends the MessageSource, ApplicationEventPublisher, and ResourceLoader interfaces, so you only need to be aware of the application context to access all these services. However, the best practice is to choose an aware interface with minimum scope that can satisfy your requirement.</i></p></div>
<p class="indent">The setter methods in the aware interfaces are called by Spring after the bean properties have been set, but before the initialization callback methods are called, as illustrated in the following list:</p><ol class="OrderedList">
<li value="1" class="calibre17">Create the bean instance either by a constructor or by a factory method.</li>
<li value="2" class="calibre17">Set the values and bean references to the bean properties.</li>
<li value="3" class="calibre17">Call the setter methods defined in the aware interfaces.</li>
<li value="4" class="calibre17">Pass the bean instance to the <span class="FontName">postProcessBeforeInitialization()</span> method of each bean post processor.</li>
<li value="5" class="calibre17">Call the initialization callback methods.</li>
<li value="6" class="calibre17">Pass the bean instance to the <span class="FontName">postProcessAfterInitialization()</span> method of each bean post processor.</li>
<li value="7" class="calibre17">The bean is ready to be used.</li>
<li value="8" class="calibre17">When the container is shut down, call the destruction callback methods.</li></ol>
<p class="indent">Keep in mind that once a bean implements an aware interface, they are bound to Spring and won’t work properly outside the Spring IoC container. So consider carefully whether it’s necessary to implement such proprietary interfaces.</p>
<p id="Sec94" class="Heading1">How It Works</p>
<p class="noindent">For example, you can make the shopping application’s POJO instances of the <span class="FontName">Cashier</span> class aware of their corresponding bean name by implementing the <span class="FontName">BeanNameAware</span> interface. By implementing the interface, Spring automatically injects the bean name into the POJO instance. In addition to implementing the interface, you also need to add the necessary setter method to handle the bean name.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.BeanNameAware;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Cashier implements BeanNameAware {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">private String beanName;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setBeanName(String beanName) {</span><br class="calibre10"/>        <span class="FontName">this.name = beanName;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">When the bean name is injected, you can use the value to do a related POJO task that requires the bean name. For example, you could use the value to set the filename to record a cashier’s checkout data. In this way, you can erase the configuration of the <span class="FontName">name</span> property, as well as the POJO <span class="FontName">name</span> field and <span class="FontName">setName()</span> method.</p>
<pre class="calibre11"><span class="FontName">&lt;bean id="cashier" class="com.apress.springrecipes.shop.Cashier" init-method="openFile"       destroy-method="closeFile"&gt;</span><br class="calibre10"/>      <span class="FontName">&lt;property name="path" value="c:/Windows/Temp/cashier" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span></pre><p id="Sec95" class="Heading">2-15. Communicate Application Events Between POJOs</p>
<p id="Sec96" class="Heading1">Problem</p>
<p class="noindent"><a id="cXXX.149" class="calibre5"></a><a id="cXXX.150" class="calibre5"></a>In a typical communication between POJOs, the sender has to locate the receiver to call a method on it. In this case, the sender POJO must be aware of the receiver component. This kind of communication is direct and simple, but the sender and receiver POJOs are tightly coupled.</p>
<p class="indent">When using an IoC container, POJOs can communicate by interface rather than by implementation. This communication model helps reduce coupling. However, it is only efficient when a sender component has to communicate with one receiver. When a sender needs to communicate with multiple receivers, it has to call the receivers one by one<a id="cXXX.151" class="calibre5"></a>.</p>
<p id="Sec97" class="Heading1">Solution</p>
<p class="noindent">Spring’s application context supports event-based communication between its beans. In the event-based communication model<a id="cXXX.152" class="calibre5"></a>, the sender POJO just publishes an event without knowing who the receiver is. Since there can actually be more than one receiver. Also, the receiver doesn’t necessarily know who is publishing the event. It can listen to multiple events from different senders at the same time. In this way, the sender and receiver components are loosely coupled.</p>
<p class="indent">In Spring, all event classes must extend the <span class="FontName">ApplicationEvent</span> class. For such cases, any bean can publish an event calling an application event publisher’s <span class="FontName">publishEvent()</span> method. For a bean to listen to certain events, it must implement the <span class="FontName">ApplicationListener</span> interface and handle the events in the <span class="FontName">onApplicationEvent()</span> method. Spring notifies a listener of all events, so you must filter the events yourself. If you use exploit generics, however, Spring only delivers messages that match the generic type parameter.</p>
<p id="Sec98" class="Heading1">How It Works</p>
<p id="Sec99" class="Heading2">Define Events</p>
<p class="noindent"><a id="cXXX.153" class="calibre5"></a>The first step of enabling event-based communication is to define the event. Suppose you would like a cashier bean to publish a <span class="FontName">CheckoutEvent</span> after the shopping cart is checked out. This event includes a checkout time property. In Spring, all events must extend the abstract class <span class="FontName">ApplicationEvent</span> and pass the event source as a constructor argument.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationEvent;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class CheckoutEvent extends ApplicationEvent {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private Date time;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public CheckoutEvent(Object source, Date time) {</span><br class="calibre10"/>        <span class="FontName">super(source);</span><br class="calibre10"/>        <span class="FontName">this.time = time;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Date getTime() {</span><br class="calibre10"/>        <span class="FontName">return time;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p id="Sec100" class="Heading2">Publish Events</p>
<p class="noindent"><a id="cXXX.154" class="calibre5"></a>To publish an event, you just create an event instance and make a call to the <span class="FontName">publishEvent()</span> method of an application event publisher, which becomes accessible by implementing the <span class="FontName">ApplicationEventPublisherAware</span> interface.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationEventPublisher;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationEventPublisherAware;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Cashier implements ApplicationEventPublisherAware {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">private ApplicationEventPublisher applicationEventPublisher;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setApplicationEventPublisher(</span><br class="calibre10"/>            <span class="FontName">ApplicationEventPublisher applicationEventPublisher) {</span><br class="calibre10"/>            <span class="FontName">this.applicationEventPublisher = applicationEventPublisher;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void checkout(ShoppingCart cart) throws IOException {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">CheckoutEvent event = new CheckoutEvent(this, new Date());</span><br class="calibre10"/>        <span class="FontName">applicationEventPublisher.publishEvent(event);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p id="Sec101" class="Heading2">Listen to Events</p>
<p class="noindent"><a id="cXXX.155" class="calibre5"></a>Any bean defined in the application context that implements the <span class="FontName">ApplicationListener</span> interface is notified of all events. So in the <span class="FontName">onApplicationEvent()</span> method, you can filter the events that a listener wants to handle—similar to how it’s done with bean post processors (Recipe 2-9). In the following listener, we use an instance of check to filter on the nongeneric <span class="FontName">ApplicationEvent</span> parameter.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationEvent;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationListener;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class CheckoutListener implements ApplicationListener {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void onApplicationEvent(ApplicationEvent event) {</span><br class="calibre10"/>        <span class="FontName">if (event instanceof CheckoutEvent) {</span><br class="calibre10"/>            <span class="FontName">Date time = ((CheckoutEvent) event).getTime();</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">// Do anything you like with the checkout amount and time</span><br class="calibre10"/>            <span class="FontName">System.out.println("Checkout event [" + time + "]");</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">Rewritten to take advantage of the generics functionality, it’s a bit briefer:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationEvent;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationListener;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class CheckoutListener implements ApplicationListener&lt;CheckoutEvent&gt; {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void onApplicationEvent(CheckoutEvent event) {</span><br class="calibre10"/>            <span class="FontName">Date time = ((CheckoutEvent) event).getTime();</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">// Do anything you like with the checkout amount and time</span><br class="calibre10"/>            <span class="FontName">System.out.println("Checkout event [" + time + "]");</span><br class="calibre10"/>     <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">Next, you have to register the listener in the application context to listen for all events. The registration is as simple as declaring a bean instance of this listener. The application context recognizes the beans that implement the <span class="FontName">ApplicationListener</span> interface and notify them of each event.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;bean class="com.apress.springrecipes.shop.CheckoutListener" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">Finally, remember the application context itself also publishes container events such as <span class="FontName">ContextClosedEvent</span>, <span class="FontName">ContextRefreshedEvent</span>, and <span class="FontName">RequestHandledEvent</span>. If any beans want to be notified of these events, they can implement the <span class="FontName">ApplicationListener</span> interface.</p>
<p id="Sec102" class="Heading">2-16. Use Property Editors in Spring<a id="cXXX.2141" class="calibre6"></a></p>
<p id="Sec103" class="Heading1">Problem</p>
<p class="noindent"><a id="cXXX.156" class="calibre5"></a><a id="cXXX.157" class="calibre5"></a>A property editor is a feature of the JavaBeans API<a id="cXXX.2070" class="calibre5"></a> for converting property values to and from text values. Each property editor is designed for a certain type of property only. You may wish to employ property editors to simplify bean configurations.</p>
<p class="indent">In addition to registering the built-in property editors, it’s also possible to write custom<a id="cXXX.158" class="calibre5"></a> property editors for converting custom data types.</p>
<p id="Sec104" class="Heading1">Solution</p>
<p class="noindent"><a id="cXXX.159" class="calibre5"></a>The Spring IoC container supports property editors to help with bean configurations. For example, with a property editor for the <span class="FontName">java.util.Date</span> type, Spring would automatically convert the data string into a <span class="FontName">java.util.Date</span> object, instead of automatically creating a String type. Spring comes with several property editors for converting common type bean properties.</p>
<p class="indent">Before you can use a custom property editor in the Spring IoC container you need to register it. The <span class="FontName">CustomEditorConfigurer</span> is implemented as a bean factory post processor for you to register custom property editors before any of the beans get instantiated.</p>
<p class="indent">You can write custom property editors by implementing the <span class="FontName">java.beans.PropertyEditor</span> interface or extending the convenient support class <span class="FontName">java.beans.PropertyEditorSupport</span>.</p>
<p id="Sec105" class="Heading1">How It Works</p>
<p class="noindent">As an example, suppose you define <a id="cXXX.160" class="calibre5"></a>product ranking class to keep track of sales for a particular period.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class ProductRanking {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private Product bestSeller;</span><br class="calibre10"/>    <span class="FontName">private Date fromDate;</span><br class="calibre10"/>    <span class="FontName">private Date toDate;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Getters and Setters</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">To specify the value for a <span class="FontName">java.util.Date</span> property in a Java program, you can convert it from a date string of particular pattern with the help of the <span class="FontName">DateFormat.parse()</span><a id="cXXX.161" class="calibre5"></a> method.</p>
<pre class="calibre11"><span class="FontName">DateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");</span><br class="calibre10"/><span class="FontName">productRanking.setFromDate(dateFormat.parse("2007-09-01"));</span><br class="calibre10"/><span class="FontName">productRanking.setToDate(dateFormat.parse("2007-09-30"));</span></pre><p class="indent">To write the equivalent bean configuration without the help of property editors, you could declare a <span class="FontName">dateFormat</span> bean with the pattern. As the <a id="cXXX.162" class="calibre5"></a><span class="FontName">parse()</span> method is called for converting the date strings into date objects, you can consider it as an instance factory method to create the date beans.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="dateFormat" class="java.text.SimpleDateFormat"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg value="yyyy-MM-dd" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="productRanking"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.shop.ProductRanking"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="bestSeller"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean class="com.apress.springrecipes.shop.Disc"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;property name="name" value="CD-RW" /&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;property name="price" value="1.5" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="fromDate"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean factory-bean="dateFormat" factory-method="parse"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;constructor-arg value="2013-09-01" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="toDate"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean factory-bean="dateFormat" factory-method="parse"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;constructor-arg value="2013-09-30" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">As you can see, the preceding configuration is too complicated for setting date properties. The Spring IoC container is able to convert the text values for properties using property editors. The <span class="FontName">CustomDateEditor</span><a id="cXXX.163" class="calibre5"></a> class that comes with Spring is used to convert date strings into <span class="FontName">java.util.Date</span> properties. First, you have to declare an instance of it in the bean configuration file.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="dateEditor"</span><br class="calibre10"/>        <span class="FontName">class="org.springframework.beans.propertyeditors.CustomDateEditor"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean class="java.text.SimpleDateFormat"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;constructor-arg value="yyyy-MM-dd" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/constructor-arg&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;constructor-arg value="true" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">This editor requires a <span class="FontName">DateFormat</span> object<a id="cXXX.164" class="calibre5"></a> as the first constructor argument. The second argument indicates whether the editor allows empty values.</p>
<p class="indent">Next, you have to register the property editor in a <span class="FontName">CustomEditorConfigurer</span><a id="cXXX.165" class="calibre5"></a> instance so Spring can convert properties whose type is <span class="FontName">java.util.Date</span>. Now, you can specify a date value in text format for any <span class="FontName">java.util.Date</span> property:</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;bean class="org.springframework.beans.factory.config.CustomEditorConfigurer"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="customEditors"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;map&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;entry key="java.util.Date"&gt;</span><br class="calibre10"/>                    <span class="FontName">&lt;ref local="dateEditor" /&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;/entry&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/map&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="productRanking"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.shop.ProductRanking"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="bestSeller"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bean class="com.apress.springrecipes.shop.Disc"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;property name="name" value="CD-RW" /&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;property name="price" value="1.5" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="fromDate" value="2007-09-01" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="toDate" value="2007-09-30" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">You can test whether the <span class="FontName">CustomDateEditor</span> configuration works with the following <span class="FontName">Main</span> class:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.ClassPathXmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">ApplicationContext context =</span><br class="calibre10"/>            <span class="FontName">new ClassPathXmlApplicationContext("beans.xml");</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">ProductRanking productRanking =</span><br class="calibre10"/>            <span class="FontName">(ProductRanking) context.getBean("productRanking");</span><br class="calibre10"/>        <span class="FontName">System.out.println(</span><br class="calibre10"/>                <span class="FontName">"Product ranking from" + productRanking.getFromDate() +</span><br class="calibre10"/>                <span class="FontName">"to" + productRanking.getToDate());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">In addition to <span class="FontName">CustomDateEditor</span>, Spring comes with several property editors for converting common data types, such as <span class="FontName">CustomNumberEditor</span>, <span class="FontName">ClassEditor</span>, <span class="FontName">FileEditor</span>, <span class="FontName">LocaleEditor</span>, <span class="FontName">StringArrayPropertyEditor</span>, and <span class="FontName">URLEditor</span>. Among them, <span class="FontName">ClassEditor</span>, <span class="FontName">FileEditor</span>, <span class="FontName">LocaleEditor</span>, and <span class="FontName">URLEditor</span> are preregistered by Spring, so you don’t need to register them again. For more information on using these editors, you can consult the Javadoc of these classes in the <span class="FontName">org.springframework.beans.propertyeditors</span> package.</p>
<p class="indent">Next, let’s write a property editor for the <span class="FontName">Product</span> class<a id="cXXX.166" class="calibre5"></a>. You can design the string representation of a product as three parts, which are the concrete class name, the product name, and the price. Each part is separated by a comma. Then, you can write the following <span class="FontName">ProductEditor</span> class<a id="cXXX.167" class="calibre5"></a> for converting them:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.shop;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.beans.PropertyEditorSupport;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class ProductEditor extends PropertyEditorSupport {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public String getAsText() {</span><br class="calibre10"/>        <span class="FontName">Product product = (Product) getValue();</span><br class="calibre10"/>        <span class="FontName">return product.getClass().getName() + "," + product.getName() + ","</span><br class="calibre10"/>                <span class="FontName">+ product.getPrice();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setAsText(String text) throws IllegalArgumentException {</span><br class="calibre10"/>        <span class="FontName">String[] parts = text.split(",");</span><br class="calibre10"/>        <span class="FontName">try {</span><br class="calibre10"/>            <span class="FontName">Product product = (Product) Class.forName(parts[0]).newInstance();</span><br class="calibre10"/>            <span class="FontName">product.setName(parts[1]);</span><br class="calibre10"/>            <span class="FontName">product.setPrice(Double.parseDouble(parts[2]));</span><br class="calibre10"/>            <span class="FontName">setValue(product);</span><br class="calibre10"/>        <span class="FontName">} catch (Exception e) {</span><br class="calibre10"/>            <span class="FontName">throw new IllegalArgumentException(e);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">The <span class="FontName">getAsText()</span> method converts a property into a string value, while the <span class="FontName">setAsText()</span> method converts a string back into a property. The property value is retrieved and set by calling the <span class="FontName">getValue()</span> and <span class="FontName">setValue()</span> methods.</p>
<p class="indent">Next, you have to register the custom editor in a <span class="FontName">CustomEditorConfigurer</span> instance before it can be used. Registration is the same as for the built-in editors. Now, you can specify a product in text format for any property whose type is <span class="FontName">Product</span>.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;bean class="org.springframework.beans.factory.config.CustomEditorConfigurer"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="customEditors"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;map&gt;</span><br class="calibre10"/>                <span class="FontName">...</span><br class="calibre10"/>                <span class="FontName">&lt;entry key="com.apress.springrecipes.shop.Product"&gt;</span><br class="calibre10"/>                    <span class="FontName">&lt;bean class="com.apress.springrecipes.shop.ProductEditor" /&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;/entry&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/map&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="productRanking"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.shop.ProductRanking"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="bestSeller"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;value&gt;com.apress.springrecipes.shop.Disc,CD-RW,1.5&lt;/value&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Tip</b>  The JavaBeans API automatically searches for a property editor in a given package. For a property editor to be searched automatically, it must be located in the same package as the target class, and the name must be the target class name with Editor as its suffix. If the property editor is provided with this convention, such as in the preceding ProductEditor, there’s no need to register it again in the Spring IoC container.</p></div>
<p id="Sec106" class="Heading">2-17. Inherit POJO Configurations<a id="cXXX.2061" class="calibre6"></a></p>
<p id="Sec107" class="Heading1">Problem</p>
<p class="noindent"><a id="cXXX.168" class="calibre5"></a>When configuring beans in the Spring IoC container, you can have more than one bean sharing common configurations (e.g., bean properties and attributes in the <span class="FontName">&lt;bean&gt;</span> element). You often have to repeat these configurations for multiple beans.</p>
<p id="Sec108" class="Heading1">Solution</p>
<p class="noindent">Spring allows you to extract common bean configurations to form a parent bean. The beans that inherit from this parent bean are called <a id="cXXX.169" class="calibre5"></a>child beans. The child beans inherit the bean configurations, ncluding bean properties and attributes in the <span class="FontName">&lt;bean&gt;</span> element, from the parent bean to avoid duplicate configurations. The child beans can also override the inherited configurations when necessary.</p>
<p class="indent">The parent bean can act as a configuration template and also as a bean instance at the same time. However, if you want the parent bean to act only as a template that cannot be retrieved, you must set the <span class="FontName">abstract</span> attribute to <span class="FontName">true</span>, asking Spring not to instantiate this bean.</p>
<p class="indent">Be advised that not all attributes defined in the <a id="cXXX.170" class="calibre5"></a>parent <span class="FontName">&lt;bean&gt;</span> element are inherited. For example, the <span class="FontName">autowire</span> attribute is not inherited from the parent. To find out more about which attributes are inherited from the parent and which aren’t, please refer to the Spring documentation about bean inheritance.</p>
<p id="Sec109" class="Heading1">How It Works</p>
<p class="noindent">Suppose you need to add a <a id="cXXX.171" class="calibre5"></a>new sequence generator instance whose initial value and suffix are the same as the existing ones.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="sequenceGenerator"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.sequence.SequenceGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="initial" value="100000" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffix" value="A" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="prefixGenerator" ref="datePrefixGenerator" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="sequenceGenerator1"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.sequence.SequenceGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="initial" value="100000" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffix" value="A" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="prefixGenerator" ref="datePrefixGenerator" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="datePrefixGenerator"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.sequence.DatePrefixGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="pattern" value="yyyyMMdd" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p id="Sec110" class="Heading2">Reuse Common Properties Across POJOs</p>
<p class="noindent">To avoid duplicating the same properties, you can declare a base sequence generator bean with a base set of properties. Then the two sequence generators can inherit this base generator so that they also have the base set of properties set automatically. You needn’t specify the class attributes of the child beans if they are the same as the parent’s.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="baseSequenceGenerator"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.sequence.SequenceGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="initial" value="100000" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffix" value="A" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="prefixGenerator" ref="prefixGenerator" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="sequenceGenerator" parent="baseSequenceGenerator" /&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="sequenceGenerator1" parent="baseSequenceGenerator" /&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent"><a id="cXXX.172" class="calibre5"></a>The inherited properties can be overridden by the child beans. For example, you can add a child sequence generator with a different initial value.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="baseSequenceGenerator"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.sequence.SequenceGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="initial" value="100000" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffix" value="A" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="prefixGenerator" ref="datePrefixGenerator" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="sequenceGenerator2" parent="baseSequenceGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="initial" value="200000" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">The base sequence generator bean can now be retrieved as a bean instance. If you want it to act as a template only, you have to set the <span class="FontName">abstract</span> attribute to <span class="FontName">true</span>. Then Spring will not instantiate the bean.</p>
<pre class="calibre11"><span class="FontName">&lt;bean id="baseSequenceGenerator" abstract="true"</span><br class="calibre10"/>    <span class="FontName">class="com.apress.springrecipes.sequence.SequenceGenerator"&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/bean&gt;</span></pre><p class="indent">You can also omit the class of the parent bean and let the child beans specify their own, especially when the parent bean and child beans are not in the same class hierarchy, but share some properties of the same name. In this case, the parent bean’s abstract attribute must be set to <span class="FontName">true</span>, as the parent bean can’t be instantiated.</p>
<p id="Sec111" class="Heading2">Inherit Properties from Parent POJOs with Different Classes</p>
<p class="noindent">For example, let’s add another <span class="FontName">ReverseGenerator</span><a id="cXXX.173" class="calibre5"></a> class that also has an <span class="FontName">initial</span> property.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.sequence;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class ReverseGenerator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private int initial;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setInitial(int initial) {</span><br class="calibre10"/>        <span class="FontName">this.initial = initial;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">Now <span class="FontName">SequenceGenerator</span> and <span class="FontName">ReverseGenerator</span> don’t extend the same base class—that is, they’re not in the same class hierarchy, but they have a property of the same name: <span class="FontName">initial</span>. To extract this common <span class="FontName">initial</span> property, you need a <span class="FontName">baseGenerator</span> parent bean with no class attribute.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="baseGenerator" abstract="true"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="initial" value="100000" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="baseSequenceGenerator" abstract="true" parent="baseGenerator"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.sequence.SequenceGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffix" value="A" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="prefixGenerator" ref="prefixGenerator" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="reverseGenerator" parent="baseGenerator"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.sequence.ReverseGenerator" /&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="sequenceGenerator" parent="baseSequenceGenerator" /&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="sequenceGenerator1" parent="baseSequenceGenerator" /&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="sequenceGenerator2" parent="baseSequenceGenerator"/&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p id="Sec112" class="Heading2">Merge a Collection of a Parent POJO</p>
<p class="noindent"><a id="cXXX.174" class="calibre5"></a>If you define your beans with inheritance, a child bean’s collection can be merged with that of its parent by setting the <span class="FontName">merge</span> attribute to <span class="FontName">true</span>. For a <span class="FontName">&lt;list&gt;</span> collection, the child elements will be appended after the parent’s to preserve the order. So, the following sequence generator will have four suffixes: A, B, A, and C.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="baseSequenceGenerator"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.sequence.SequenceGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="prefix" value="30" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="initial" value="100000" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffixes"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;list&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;value&gt;A&lt;/value&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;value&gt;B&lt;/value&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/list&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="sequenceGenerator" parent="baseSequenceGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffixes"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;list merge="true"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;value&gt;A&lt;/value&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;value&gt;C&lt;/value&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/list&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">For a <span class="FontName">&lt;set&gt;</span> or <span class="FontName">&lt;map&gt;</span> collection, the child elements will overwrite the parent’s collection if they have the same value. So, the following sequence generator will have three suffixes: A, B, and C.</p>
<pre class="calibre11"><span class="FontName">&lt;beans ...&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean id="baseSequenceGenerator"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.sequence.SequenceGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="prefix" value="30 /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="initial" value="100000" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffixes"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;set&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;value&gt;A&lt;/value&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;value&gt;B&lt;/value&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/set&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="sequenceGenerator" parent="baseSequenceGenerator"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffixes"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;set merge="true"&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;value&gt;A&lt;/value&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;value&gt;C&lt;/value&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/set&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/property&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p id="Sec113" class="Heading">2-18. Implement POJOs with Scripting Languages</p>
<p id="Sec114" class="Heading1">Problem</p>
<p class="noindent"><a id="cXXX.175" class="calibre5"></a>Sometimes, applications have certain modules that require frequent and dynamic changes. If you implement such modules in Java, you have to recompile, repackage, and redeploy an application each time after the change. You may not be allowed to perform these actions at any time you want or need, especially for a 24/7 application.</p>
<p id="Sec115" class="Heading1">Solution</p>
<p class="noindent">You can consider implementing modules<a id="cXXX.176" class="calibre5"></a> that require frequent and dynamic changes with scripting languages. The advantage of scripting languages is that they don’t need to be recompiled after changes, so you simply deploy the new script for the change to take effect.</p>
<p class="indent">Spring allows you to implement beans with one of its supported scripting languages. You can configure a scripted bean in the IoC container just like a normal bean implemented in Java.</p>
<p id="Sec116" class="Heading1">How It Works</p>
<p class="noindent">Suppose you are going to develop an application that requires interest calculation. First of all, you define the following <span class="FontName">InterestCalculator</span> interface<a id="cXXX.177" class="calibre5"></a>:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.interest;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface InterestCalculator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setRate(double rate);</span><br class="calibre10"/>    <span class="FontName">public double calculate(double amount, double year);</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">Implementing this interface is not difficult at all. However, as there are many interest calculation strategies, users may need to change the implementation very frequently and dynamically. You don’t want to recompile, repackage, and redeploy an application every time this happens. So, you consider implementing this interface with one of the supported scripting languages in Spring.</p>
<p class="indent">In Spring’s bean configuration file, you have to include the <span class="FontName">lang</span> schema<a id="cXXX.178" class="calibre5"></a> definition in the <span class="FontName">&lt;beans&gt;</span> root element to make use of the scripting language support.</p>
<pre class="calibre11"><span class="FontName">&lt;beans   xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:lang="</span><span class="FontName"><a href="http://www.springframework.org/schema/lang" class="calibre5">http://www.springframework.org/schema/lang</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans-3.2.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/lang" class="calibre5">http://www.springframework.org/schema/lang</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/lang/spring-lang-3.2.xsd" class="calibre5">http://www.springframework.org/schema/lang/spring-lang-3.2.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre><p class="indent">Spring supports three scripting languages: JRuby, Groovy, and BeanShell. Next, you will implement the <span class="FontName">InterestCalculator</span> interface with these three languages. For simplicity’s sake, let’s consider the following simple interest formula for interest calculation:</p>
<pre class="calibre11"><span class="FontName">Interest = Amount x Rate x Year</span></pre><p id="Sec117" class="Heading2">Scripting Beans with JRuby</p>
<p class="noindent"><a id="cXXX.179" class="calibre5"></a><a id="cXXX.180" class="calibre5"></a>First, let’s implement the <span class="FontName">InterestCalculator</span> interface with JRuby by creating the JRuby script, <span class="FontName">SimpleInterestCalculator.rb</span>, in the <span class="FontName">com.apress.springrecipes.interest</span> package of your classpath.</p>
<pre class="calibre11"><span class="FontName">class SimpleInterestCalculator</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">def setRate(rate)</span><br class="calibre10"/>        <span class="FontName">@rate = rate</span><br class="calibre10"/>    <span class="FontName">end</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">def calculate(amount, year)</span><br class="calibre10"/>        <span class="FontName">amount * year * @rate</span><br class="calibre10"/>    <span class="FontName">end</span><br class="calibre10"/><span class="FontName">end</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">SimpleInterestCalculator.new</span></pre><p class="indent">The preceding JRuby script declares a <span class="FontName">SimpleInterestCalculator</span> class with a setter method for the <span class="FontName">rate</span> property and a <span class="FontName">calculate()</span> method. In Ruby, an instance variable begins with the <span class="FontName">@</span> sign. Note that, in the last line, you return a new instance of the target JRuby class. Failure to return this instance can result in Spring performing a lookup for an appropriate Ruby class to instantiate. As there can be multiple classes defined in a single JRuby script file, Spring will throw an exception if it cannot find an appropriate one that implements the methods declared in the interface.</p>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To use JRuby in a Spring application, you have to include the appropriate dependencies on your classpath (i.e., the org.jruby JAR).</p></div>
<p class="indent">In the bean configuration file, you declare a bean implemented with JRuby using the <span class="FontName">&lt;lang:jruby&gt;</span> element and specifying the script’s location in the <span class="FontName">script-source</span> attribute. You can specify any resource path with a resource prefix supported by Spring, such as file or classpath.</p>
<p class="indent">You also have to specify one or more interfaces in the <span class="FontName">script-interfaces</span> attribute for a JRuby bean. It’s up to Spring to create a dynamic proxy for this bean and convert the Java method calls into JRuby method calls.</p>
<pre class="calibre11"><span class="FontName">&lt;lang:jruby id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-source="classpath:com/apress/springrecipes/interest/</span><br class="calibre10"/>        <span class="FontName">SimpleInterestCalculator.rb"</span><br class="calibre10"/>    <span class="FontName">script-interfaces="com.apress.springrecipes.interest.InterestCalculator"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:property name="rate" value="0.05" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/lang:jruby&gt;</span></pre><p class="indent">Finally, you can specify the property values for a scripting bean in the <span class="FontName">&lt;lang:property&gt;</span> elements. Now, you can get the <span class="FontName">interestCalculator</span> bean from the IoC container to use and inject it into other bean properties as well. The following <span class="FontName">Main</span> class helps you verify whether the scripted bean works properly:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.interest;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.GenericXmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">ApplicationContext context =</span><br class="calibre10"/>            <span class="FontName">new GenericXmlApplicationContext("beans.xml");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">InterestCalculator calculator =</span><br class="calibre10"/>            <span class="FontName">(InterestCalculator) context.getBean("interestCalculator");</span><br class="calibre10"/>        <span class="FontName">System.out.println(calculator.calculate(100000, 1));</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p id="Sec118" class="Heading2">Scripting Beans with Groovy</p>
<p class="noindent"><a id="cXXX.181" class="calibre5"></a><a id="cXXX.182" class="calibre5"></a>Next, let’s implement the <span class="FontName">InterestCalculator</span> interface with Groovy by creating the Groovy script, <span class="FontName">SimpleInterestCalculator.groovy</span>, in the <span class="FontName">com.apress.springrecipes.interest</span> package of your classpath.</p>
<pre class="calibre11"><span class="FontName">import com.apress.springrecipes.interest.InterestCalculator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">class SimpleInterestCalculator implements InterestCalculator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">double rate</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">double calculate(double amount, double year) {</span><br class="calibre10"/>        <span class="FontName">return amount * year * rate</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">The preceding Groovy script declares a <span class="FontName">SimpleInterestCalculator</span> class that implements the <span class="FontName">InterestCalculator</span> interface. In Groovy, you can simply declare a property with no access modifier, and then it generates a private field with a public getter and setter automatically.</p>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To use Groovy in a Spring application, you have to include the appropriate dependencies on your classpath (i.e., the org.codehaus.groovy JAR).</p></div>
<p class="indent">In the bean configuration file, you can declare a bean implemented with Groovy by using the <span class="FontName">&lt;lang:groovy&gt;</span> element and specifying the script’s location in the <span class="FontName">script-source</span> attribute. You can specify the property values for a scripting bean in the <span class="FontName">&lt;lang:property&gt;</span> elements.</p>
<pre class="calibre11"><span class="FontName">&lt;lang:groovy id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-source="classpath:com/apress/springrecipes/interest/SimpleInterestCalculator.groovy"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:property name="rate" value="0.05" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/lang:groovy&gt;</span></pre><p class="indent">Notice that it’s unnecessary to specify the <span class="FontName">script-interfaces</span> attribute for a Groovy bean, as the Groovy class has declared which interfaces it implements.</p>
<p id="Sec119" class="Heading2">Scripting Beans with BeanShell<a id="cXXX.2172" class="calibre6"></a></p>
<p class="noindent"><a id="cXXX.183" class="calibre5"></a><a id="cXXX.184" class="calibre5"></a>Finally, let’s implement the <span class="FontName">InterestCalculator</span> interface with BeanShell by creating the BeanShell script, <span class="FontName">SimpleInterestCalculator.bsh</span>, in the <span class="FontName">com.apress.springrecipes.interest</span> package of your classpath.</p>
<pre class="calibre11"><span class="FontName">double rate;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">void setRate(double aRate) {</span><br class="calibre10"/>    <span class="FontName">rate = aRate;</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">double calculate(double amount, double year) {</span><br class="calibre10"/>    <span class="FontName">return amount * year * rate;</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">In BeanShell, you cannot declare classes explicitly, but you can declare variables and methods. So, you implement your <span class="FontName">InterestCalculator</span> interface by providing all the methods required by the interface.</p>
<div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To use BeanShell in a Spring application, you have to include the appropriate dependencies on your classpath (i.e., the org.beanshell JAR).</p></div>
<p class="indent">In the bean configuration file, you can declare a bean implemented with BeanShell by using the <span class="FontName">&lt;lang:bsh&gt;</span> element and specifying the script’s location in the <span class="FontName">script-source</span> attribute. You can specify the property values for a scripting bean in the <span class="FontName">&lt;lang:property&gt;</span> elements.</p>
<p class="indent">You also have to specify one or more interfaces in the script-interfaces attribute for a bean implemented with BeanShell. It’s up to Spring to create a dynamic proxy for this bean and convert the Java method calls into BeanShell calls.</p>
<pre class="calibre11"><span class="FontName">&lt;lang:bsh id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-source="classpath:com/apress/springrecipes/interest/SimpleInterestCalculator.bsh"</span><br class="calibre10"/>    <span class="FontName">script-interfaces="com.apress.springrecipes.interest.InterestCalculator"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:property name="rate" value="0.05" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/lang:bsh&gt;</span></pre><p id="Sec120" class="Heading">2-19. Inject Spring POJOs into Scripts</p>
<p id="Sec121" class="Heading1">Problem</p>
<p class="noindent"><a id="cXXX.185" class="calibre5"></a>Sometimes, scripts may need the help of certain Java objects to complete their tasks. In Spring, you can allow scripts to access beans declared in the IoC container.</p>
<p id="Sec122" class="Heading1">Solution</p>
<p class="noindent">You can inject beans declared in the Spring IoC container into scripts in the same way as properties of simple data types.</p>
<p id="Sec123" class="Heading1">How It Works</p>
<p class="noindent">Suppose you want the application from the previous recipe to make interest calculations dynamically. First, you define the following interface to allow implementations to return the annual, monthly, and daily interest rates:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.interest;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface RateCalculator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double getAnnualRate();</span><br class="calibre10"/>    <span class="FontName">public double getMonthlyRate();</span><br class="calibre10"/>    <span class="FontName">public double getDailyRate();</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">Next, you can implement this interface to calculate rates from a fixed annual interest rate, which is then injected through a setter method.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.interest;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class FixedRateCalculator implements RateCalculator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private double rate;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setRate(double rate) {</span><br class="calibre10"/>        <span class="FontName">this.rate = rate;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double getAnnualRate() {</span><br class="calibre10"/>        <span class="FontName">return rate;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double getMonthlyRate() {</span><br class="calibre10"/>        <span class="FontName">return rate / 12;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public double getDailyRate() {</span><br class="calibre10"/>        <span class="FontName">return rate / 365;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">Then you declare this rate calculator in the IoC container by supplying an annual interest rate.</p>
<pre class="calibre11"><span class="FontName">&lt;bean id="rateCalculator"</span><br class="calibre10"/>    <span class="FontName">class="com.apress.springrecipes.interest.FixedRateCalculator"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property name="rate" value="0.05" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/bean&gt;</span></pre><p class="indent">Last, the interest calculator should use a <span class="FontName">RateCalculator</span> object rather than a fixed rate value.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.interest;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface InterestCalculator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setRateCalculator(RateCalculator rateCalculator);</span><br class="calibre10"/>    <span class="FontName">public double calculate(double amount, double year);</span><br class="calibre10"/><span class="FontName">}</span></pre><p id="Sec124" class="Heading2">Inject Spring Beans into JRuby</p>
<p class="noindent"><a id="cXXX.186" class="calibre5"></a>In aJRuby script, you can store the injected <span class="FontName">RateCalculator</span> object in an instance variable and use it for rate calculation.</p>
<pre class="calibre11"><span class="FontName">class SimpleInterestCalculator</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">def setRateCalculator(rateCalculator)</span><br class="calibre10"/>        <span class="FontName">@rateCalculator = rateCalculator</span><br class="calibre10"/>    <span class="FontName">end</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">def calculate(amount, year)</span><br class="calibre10"/>        <span class="FontName">amount * year * @rateCalculator.getAnnualRate</span><br class="calibre10"/>    <span class="FontName">end</span><br class="calibre10"/><span class="FontName">end</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">SimpleInterestCalculator.new</span></pre><p class="indent">In the bean declaration, you can inject another bean into a scripted bean’s property by specifying the bean name in the <span class="FontName">ref</span> attribute.</p>
<pre class="calibre11"><span class="FontName">&lt;lang:jruby id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-source="classpath:com/apress/springrecipes/interest/</span><br class="calibre10"/>        <span class="FontName">SimpleInterestCalculator.rb"</span><br class="calibre10"/>    <span class="FontName">script-interfaces="com.apress.springrecipes.interest.InterestCalculator"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:property name="rateCalculator" ref="rateCalculator" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/lang:</span><span class="FontName">jruby&gt;</span></pre><p id="Sec125" class="Heading2">Inject Spring Beans into Groovy<a id="cXXX.2062" class="calibre6"></a></p>
<p class="noindent"><a id="cXXX.187" class="calibre5"></a>In aGroovy script, you just declare a property of type <span class="FontName">RateCalculator</span>, and it automatically generates a public getter and settermethod.</p>
<pre class="calibre11"><span class="FontName">import com.apress.springrecipes.interest.InterestCalculator;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.interest.RateCalculator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">class SimpleInterestCalculator implements InterestCalculator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">RateCalculator rateCalculator</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">double calculate(double amount, double year) {</span><br class="calibre10"/>        <span class="FontName">return amount * year * rateCalculator.getAnnualRate()</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">And you can inject another bean into a scripted bean’s property by specifying the bean name in the <span class="FontName">ref</span> attribute.</p>
<pre class="calibre11"><span class="FontName">&lt;lang:groovy id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-source="classpath:com/apress/springrecipes/interest/SimpleInterestCalculator.groovy"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:property name="rateCalculator" ref="rateCalculator" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/lang:groovy&gt;</span></pre><p id="Sec126" class="Heading2">Injec Spring Beans into BeanShell</p>
<p class="noindent"><a id="cXXX.188" class="calibre5"></a>In aBeanShell script, you need a global variable of type <span class="FontName">RateCalculator</span> and a setter method for it.</p>
<pre class="calibre11"><span class="FontName">import com.apress.springrecipes.interest.RateCalculator;</span><br class="calibre10"/><span class="FontName">RateCalculator rateCalculator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">void setRateCalculator(RateCalculator aRateCalculator) {</span><br class="calibre10"/>    <span class="FontName">rateCalculator = aRateCalculator;</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">double calculate(double amount, double year) {</span><br class="calibre10"/>    <span class="FontName">return amount * year * rateCalculator.getAnnualRate();</span><br class="calibre10"/><span class="FontName">}</span></pre><p class="indent">You can also inject another bean into a scripted bean’s property by specifying the bean name in the <span class="FontName">ref</span> attribute.</p>
<pre class="calibre11"><span class="FontName">&lt;lang:bsh id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-source="classpath:com/apress/springrecipes/interest/SimpleInterestCalculator.bsh"</span><br class="calibre10"/>    <span class="FontName">script-interfaces="com.apress.springrecipes.interest.InterestCalculator"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:property name="rateCalculator" ref="rateCalculator" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/lang:bsh&gt;</span></pre><p id="Sec127" class="Heading">2-20. Refresh POJOs from Scripts</p>
<p id="Sec128" class="Heading1">Problem</p>
<p class="noindent"><a id="cXXX.189" class="calibre5"></a>As the modules implemented with scripting languages may change frequently and dynamically, you want the Spring IoC container to be able to detect and refresh changes automatically from the script sources.</p>
<p id="Sec129" class="Heading1">Solution</p>
<p class="noindent">Spring is able to refresh a scripted bean definition from its source once you have specified the checking interval in the <span class="FontName">refresh-check-delay</span> attribute. When a method is called on that bean, Spring checks the script source to verify if the specified checking interval has elapsed. Then, Spring refreshes the bean definition from the script source if it has changed.</p>
<p id="Sec130" class="Heading1">How It Works</p>
<p class="noindent">By default, the <span class="FontName">refresh-check-delay</span> attribute is negative, so the refresh checking feature is disabled. You can assign the milliseconds for a refresh check in this attribute to enable this feature. For example, you can specify 5 seconds for the refresh check interval for a JRuby bean.</p>
<pre class="calibre11"><span class="FontName">&lt;lang:jruby id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-source="classpath:com/apress/springrecipes/interest/</span><br class="calibre10"/>        <span class="FontName">SimpleInterestCalculator.rb"</span><br class="calibre10"/>    <span class="FontName">script-interfaces="com.apress.springrecipes.interest.InterestCalculator"</span><br class="calibre10"/>    <span class="FontName">refresh-check-delay="5000"&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/lang:jruby&gt;</span></pre><p class="indent">Of course, the <span class="FontName">refresh-check-delay</span> attribute also works for a beans implemented inGroovy or BeanShell.</p>
<pre class="calibre11"><span class="FontName">&lt;lang:groovy id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-source="classpath:com/apress/springrecipes/interest/</span><br class="calibre10"/>        <span class="FontName">SimpleInterestCalculator.groovy"</span><br class="calibre10"/>    <span class="FontName">refresh-check-delay="5000"&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/lang:groovy&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;lang:bsh id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-source="classpath:com/apress/springrecipes/interest/</span><br class="calibre10"/>        <span class="FontName">SimpleInterestCalculator.bsh"</span><br class="calibre10"/>    <span class="FontName">script-interfaces="com.apress.springrecipes.interest.InterestCalculator"</span><br class="calibre10"/>    <span class="FontName">refresh-check-delay="5000"&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/lang:bsh&gt;</span></pre><p id="Sec131" class="Heading">2-21. Define Script Sources as Inline Code and not in External Files</p>
<p id="Sec132" class="Heading1">Problem</p>
<p class="noindent"><a id="cXXX.190" class="calibre5"></a>You want to define script sources, which are not likely to change often directly in the bean configuration file, rather than in external script source files.</p>
<p id="Sec133" class="Heading1">Solution</p>
<p class="noindent">You can define inline script sources in the <span class="FontName">&lt;lang:inline-script&gt;</span> element of a scripted bean to replace references to external script source files that use the <span class="FontName">script-source</span> attribute. Note that the refresh check feature is not applicable for inline script sources, because the Spring IoC container only loads the bean configuration once, at startup.</p>
<p id="Sec134" class="Heading1">How It Works</p>
<p class="noindent">For example, you can define a JRuby script inline using the <span class="FontName">&lt;lang:inline-script&gt;</span> element. To prevent the characters in the script from conflicting with reserved XML characters, you should surround the script source with the <span class="FontName">&lt;![CDATA[...]]&gt;</span>tag. In this scenario, you no longer need to specify the reference to the external script source file in the <span class="FontName">script-source</span> attribute.</p>
<pre class="calibre11"><span class="FontName">&lt;lang:jruby id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-interfaces="com.apress.springrecipes.interest.InterestCalculator"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:inline-script&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;![CDATA[</span><br class="calibre10"/>    <span class="FontName">class SimpleInterestCalculator</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">def setRateCalculator(rateCalculator)</span><br class="calibre10"/>            <span class="FontName">@rateCalculator = rateCalculator</span><br class="calibre10"/>        <span class="FontName">end</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">def calculate(amount, year)</span><br class="calibre10"/>            <span class="FontName">amount * year * @rateCalculator.getAnnualRate</span><br class="calibre10"/>        <span class="FontName">end</span><br class="calibre10"/>    <span class="FontName">end</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">SimpleInterestCalculator.new</span><br class="calibre10"/>    <span class="FontName">]]&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/lang:inline-script&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:property name="rateCalculator" ref="rateCalculator" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/lang:jruby&gt;</span></pre><p class="indent">Of course, you can also define the Groovy or BeanShell script sources inline with the <span class="FontName">&lt;lang:inline-script&gt;</span> element.</p>
<pre class="calibre11"><span class="FontName">&lt;lang:groovy id="interestCalculator"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:inline-script&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;![CDATA[</span><br class="calibre10"/>    <span class="FontName">import com.apress.springrecipes.interest.InterestCalculator;</span><br class="calibre10"/>    <span class="FontName">import com.apress.springrecipes.interest.RateCalculator;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">class SimpleInterestCalculator implements InterestCalculator {</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">RateCalculator rateCalculator</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">double calculate(double amount, double year) {</span><br class="calibre10"/>            <span class="FontName">return amount * year * rateCalculator.getAnnualRate()</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">]]&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/lang:inline-script&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:property name="rateCalculator" ref="rateCalculator" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/lang:groovy&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;lang:bsh id="interestCalculator"</span><br class="calibre10"/>    <span class="FontName">script-interfaces="com.apress.springrecipes.interest.InterestCalculator"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:inline-script&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;![CDATA[</span><br class="calibre10"/>    <span class="FontName">import com.apress.springrecipes.interest.RateCalculator;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">RateCalculator rateCalculator;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">void setRateCalculator(RateCalculator aRateCalculator) {</span><br class="calibre10"/>        <span class="FontName">rateCalculator = aRateCalculator;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">double calculate(double amount, double year) {</span><br class="calibre10"/>        <span class="FontName">return amount * year * rateCalculator.getAnnualRate();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">]]&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/lang:inline-script&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;lang:property name="rateCalculator" ref="rateCalculator" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/lang:bsh&gt;</span></pre><p id="Sec135" class="Heading">2-22. Use the Spring Expression Language to Configure POJOs<a id="cXXX.2200" class="calibre6"></a></p>
<p id="Sec136" class="Heading1">Problem</p>
<p class="noindent"><a id="cXXX.191" class="calibre5"></a>You want to dynamically evaluate a condition or property and use it as a configuration value in the IoC container. Or perhaps want to defer evaluation of something—not at design time but at runtime, as might be the case in a custom scope. Or you just want a way to use an expression language for your applications.</p>
<p id="Sec137" class="Heading1">Solution</p>
<p class="noindent"><a id="cXXX.192" class="calibre5"></a>The Spring Expression Language (SpEL) provides functionality similar to the Unified EL from JSF and JSP, or Object Graph Navigation Language (OGNL). SpEL provides easy-to-use infrastructure that can be leveraged outside of Spring. Within Spring, it can be used to make configuration much easier in a lot of cases.</p>
<p id="Sec138" class="Heading1">How It Works</p>
<p class="noindent">The SpEL provides the means to evaluate certain expressions at arbitrary points in POJO’s life cycle<a id="cXXX.2201" class="calibre5"></a><a id="cXXX.193" class="calibre5"></a>, such as during a scoped beans initialization. It can be used in constructs for both XML configurations, as well as annotations which are described in the chapter.</p>
<p id="Sec139" class="Heading2">Features of the SpEL Syntax</p>
<p class="noindent">The expression language supports a long list of features. <a id="_Tab4" href="part0011.html#Tab4" class="calibre5">Table 2-4</a> briefly runs through the various constructs and demonstrates their usage.<a id="cXXX.194" class="calibre5"></a></p>
<div class="Table" id="Tab4">
<p class="TabCapt"><span class="calibre4"><a href="part0011.html#_Tab4" class="calibre5">Table 2-4</a>.</span> Expression Language Features</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14">
<p class="tab-left">Type</p></th><th valign="top" class="calibre14">
<p class="tab-left">Use</p></th><th valign="top" class="calibre14">
<p class="tab-left">Example</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Literal expression</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">The simplest thing you can do in the expression language, essentially the same as if you were writing Java code. The language supports String literals as well as all sorts of numbers.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">2342</p>
<p class="tab-leftt">‘Hello Spring Enterprise Recipes’</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Boolean and relational operator</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">The expression language provides the ability to evaluate conditionals using standard idioms from Java.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">T(java.lang.Math).random()&gt; .5</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Standard expression</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">You can iterate and return the properties on beans in the same way you might with Unified EL, separating each dereferenced property with a period and using JavaBean-style naming conventions. In the example to the right, the expression would be equivalent to getCat().getMate().getName().</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">cat.mate.name</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Class expression</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">T() tells the expression language to act on the type of the class, not an instance. In the examples on the right, the first would yield the Class instance for java.lang.Math—equivalent to calling java.lang.Math.class. The second example calls a static method on a given type. Thus, T(java.lang.Math).random() is equivalent to calling java.lang.Math.random().</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">T(java.lang.Math)</p>
<p class="tab-leftt">T(java.lang.Math).random()</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Accessing arrays,lists, maps</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">You can index lists, arrays, and maps using brackets and the key—which for arrays or lists is the index number, and for maps is an object. In the examples, you see a java.util.List with four chars being indexed at index 1, which returns ‘b’. The second example demonstrates accessing a map by the index ‘OR’, yielding the value associated with that key.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">T(java.util.Arrays).asList(</p>
<p class="tab-leftt">‘a’, ‘b’, ‘c’, ‘d’)[1]</p>
<p class="tab-leftt">T(SpelExamplesDemo).MapOfStatesAndCapitals[‘OR’]</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Method invocation</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Methods may be invoked in instances just as you would in Java. This is a marked improvement over the basic JSF or JSP expression languages.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">‘Hello, World’.toLowerCase()</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Relational operators</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">You can compare or equate values, and the returned value will be a Boolean.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">23 == person.age</p>
<p class="tab-leftt">‘fala’ &lt; ‘fido’</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Calling constructor</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">You can create objects and invoke their constructors. Here, you create simple String and Cat objects.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">new String(‘Hello Spring Recipes, again!’)</p>
<p class="tab-leftt">new Cat(‘Felix’)</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Ternary operator</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Ternary expressions work as you’d expect, yielding the value in the true case.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">T(java.lang.Math).random() &gt; .5 ? ‘She loves me’ : ‘She loves me not’</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Variable</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">The SpEL lets you set and evaluate variables. The variables can be installed by the context of the expression parser, and there are some implicit variables, such as #this, which always refer to the root object of the context.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">#this.firstName</p>
<p class="tab-leftt">#customer.email</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Collection projection</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">A very powerful feature inside of SpEL is the capability to perform very sophisticated manipulations of maps and collections. Here, you create a projection for the list cats. In this example, the returned value is a collection of as many elements being iterated that has the value for the name property on each cat in the collection. In this case, cats is a collection of Cat objects. The returned value is a collection of String objects.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">cats.![name]</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Collection selection</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Selection lets you dynamically filter objects from a collection or map by evaluating a predicate on each item in the collection and keeping only those elements for which the predicate is true. In this case, you evaluate the java.util.Map.Entry.value property for each Entry in the Map and if the value (in this case a String), lowercased, starts with “s”, then it is kept. Everything else is discarded.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">mapOfStatesAndCapitals.[value.toLowerCase().startsWith(‘s’)]</p></td></tr><tr class="noclass"><td valign="top" class="calibre16">
<p class="tab-leftt">Templated expression</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">You can use the expression language to evaluate expressions inside of string expressions. The result is returned. In this case, the result is dynamically created by evaluating the ternary expression and including ‘good’ or ‘bad’ based on the result.</p></td><td valign="top" class="calibre16">
<p class="tab-leftt">Your fortune is ${T(java.lang.Math).random()&gt; .5 ?‘good’ : ‘bad’}</p></td></tr></tbody></table>
</div>
<p id="Sec140" class="Heading2">Use SpEL in your XML Configurations</p>
<p class="noindent"><a id="cXXX.195" class="calibre5"></a><a id="cXXX.196" class="calibre5"></a>The expression language can be used in XML configuration files. The expressions are evaluated at creation time for the bean, not at the initialization of the context. This has the effect that beans created in a custom scope are not configured until the bean is in the appropriate scope.</p>
<p class="indent">The first example is the injection of a named expression language variable, systemProperties, which is just a special variable for the <span class="FontName">java.util.Properties</span> instance that’s available from <span class="FontName">System.getProperties()</span>. The next example shows a POJO definition, followed by the bean definition which injects the system properties:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.spel;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class CommonData {</span><br class="calibre10"/>    <span class="FontName">private Properties commonProperties;</span><br class="calibre10"/>    <span class="FontName">private String userOS;</span><br class="calibre10"/>    <span class="FontName">private String userRegion;</span><br class="calibre10"/>    <span class="FontName">private double randomNumber;</span><br class="calibre10"/>    <span class="FontName">private String email;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">//Setter &amp; getter methods ommited</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;bean id="commonData"</span><br class="calibre10"/>      <span class="FontName">class="com.apress.springrecipes.spel.CommonData"</span><br class="calibre10"/>        <span class="FontName">p:commonProperties="#{@systemProperties}"</span><br class="calibre10"/>        <span class="FontName">p:userOS="#{@systemProperties['os.name']}"</span><br class="calibre10"/>        <span class="FontName">p:userRegion=</span><span class="FontName">#{@systemProperties['user.region']?:'unknown region'</span><span class="FontName">}/&gt;</span></pre><p class="indent">The first property injects the full <span class="FontName">Properties</span> object using the syntax <span class="FontName">#{@systemProperties}</span>. The second property injects the <span class="FontName">os.name</span> value from the <span class="FontName">Properties</span> object using brackets to qualify a specific property. And the third property uses syntax to specify a default value in case the given property is empty.</p>
<p class="indent">With SpEL you can also inject computations or method invocations, as illustrated next:</p>
<pre class="calibre11"><span class="FontName">&lt;bean id="commonData"</span><br class="calibre10"/>       <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">p:randomNumber="#{  T(java.lang.Math).random() * 100.0 }"/&gt;</span></pre><p class="indent">In addition, you can also reference properties from other beans. To reference your own bean properties, you don’t use the <span class="FontName">@</span> symbol at the start like you did to reference system properties:</p>
<pre class="calibre11"><span class="FontName">&lt;bean id="emailUtilities"</span><br class="calibre10"/>     <span class="FontName">class="com.apress.springrecipes.spel.EmailUtilities"</span><br class="calibre10"/>     <span class="FontName">p:email="</span><span class="FontName"><a href="mailto:webmaster@acme.org" class="calibre5">webmaster@acme.org</a></span><span class="FontName">"</span><br class="calibre10"/>     <span class="FontName">p:password="springrecipes"</span><br class="calibre10"/>     <span class="FontName">p:host="localhost:25"/&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;bean id="commonData"</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>   <span class="FontName">p:email="#{emailUtilities.email}"/&gt;</span></pre><p id="Sec141" class="Heading2">Use SpEL in your Annotation Configurations</p>
<p class="noindent"><a id="cXXX.197" class="calibre5"></a>The expression language can also be used with annotations. The next example shows a POJO that injects system properties directly into a bean using the <span class="FontName">@Value</span> annotation:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.spel;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">@Component</span><br class="calibre10"/><span class="FontName">public class CommonData {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Value("#{systemProperties}")</span><br class="calibre10"/>    <span class="FontName">private Properties commonProperties;</span><br class="calibre10"/>    <span class="FontName">@Value("#{systemProperties['os.name']?:'unknown OS'}")</span><br class="calibre10"/>    <span class="FontName">private String userOS;</span><br class="calibre10"/>    <span class="FontName">@Value("#{systemProperties['user.region']?:'unknown region'}")</span><br class="calibre10"/>    <span class="FontName">private String userRegion;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">//Setter &amp; getter methods omitted</span></pre><div class="notepara">
<p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  The overall setup process to use Spring annotations is different than using Spring XML configurations. The next chapter is dedicated to the use of Spring annotations.</p></div>
<p class="indent">The SpEL syntax used to inject values with the <span class="FontName">@Value</span> annotation, is identical to that of the XML configuration version.</p>
<p class="indent">With annotations you can also use SpEL to inject computations or method invocations, as well as references to other bean properties.</p>
<pre class="calibre11"><span class="FontName">@Value("#{  T(java.lang.Math).random() * 100.0 }")</span><br class="calibre10"/><span class="FontName">private double randomNumber;</span><br class="calibre10"/><span class="FontName">@Value("#{emailUtilities.email}")</span><br class="calibre10"/><span class="FontName">private String email;</span></pre><p id="Sec142" class="Heading">Summary</p>
<p class="noindent">In this chapter, you learned the core tasks associated with Spring’s IoC container. Spring supports both setter injection and constructor injection to define POJO properties, which can be simple values, collections, or bean references. You also learned about referencing POJOs from other POJOs, as well as auto-wiring which can automatically associate POJO’s by either type or name.</p>
<p class="indent">As collections are essential Java programming elements, you explored how Spring provides support to configure collections. You can use the collection tags in the utility schema to specify more details for a collection, and also define collections as stand-alone beans to share between multiple beans.</p>
<p class="indent">You then learned about Spring POJO scopes, which allows POJO instances to be managed differently than the default singleton scope. You also learned how Spring can read external resources (e.g., text files, XML files, properties file, or image files) from different locations (e.g., a file system, classpath, or URL) and use this data in the context of POJO configuration and creation. In addition, you learned how Spring supports different languages in POJOs through the use of i18n resource bundles.</p>
<p class="indent">Next, you learned how to customize the initialization and destruction of POJOs, as well as how to use Spring post processors to validate and modify POJOs after creations. Then you explored how to create POJOs using different factory techniques, via a static method, an instance method and Spring’s factory bean.</p>
<p class="indent">You then learned how to work with Spring environments and profiles to load different sets of POJOs. Next, you explored aspect oriented programming in the context of Spring and learned how to create aspects, pointcuts, and advices. Then you explored how to create POJOs from static fields and object properties, as well as how to make POJOs aware of Spring’s IoC container resources.</p>
<p class="indent">Next, you learned how to communicate application events<a id="cXXX.2016" class="calibre5"></a> between POJOs and use property editors<a id="cXXX.2191" class="calibre5"></a> in Spring to automatically handle complex types when creating POJO instances. And then you learned about inheriting POJO configuration which provides support for bean inheritance by extracting common bean configurations to form a parent bean. The parent bean can act as a configuration template, a bean instance, or both at the same time.</p>
<p class="indent">In this chapter, you also learned how to use scripting languages supported by Spring to implement POJOs and how to declare them in the Spring IoC container. Spring supports three scripting languages: JRuby, Groovy, and BeanShell. Finally, you learned about Spring’s Expression Language or SpEL which provides a means to evaluate certain expressions for configuration purposes or at arbitrary points in POJO’s life cycle.</p>
<p class="FootLine">________________________</p>
<p class="FootNote"><a id="Fn1" href="part0010.html#_Fn1" class="calibre5"><sup class="calibre18">1</sup></a>The term POJO means an ordinary Java object without any specific requirements, such as to implement an interface or to extend a base class. This term is used to distinguish lightweight Java components from heavyweight components in other complex component models (e.g., EJB components prior to version 3.1 of the EJB specification).</p></div>
</body></html>
