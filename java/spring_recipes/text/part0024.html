<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Chapter 14 Spring Java Enterprise Services and Remoting Technologies</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre"><p class="ChapterNumber"><a id="b9781430259084_14" class="calibre6"></a>CHAPTER 14</p>
<p class="Chapimage"><img src="../images/00008.jpeg" alt="image" class="calibre3"/></p>
<p class="ChapterTitle">Spring Java Enterprise Services and Remoting Technologies</p>
<div class="calibre10"><p class="noindent">In this chapter<a id="cXXX.2149" class="calibre5"></a>, you will learn about Spring’s support for the most common Java enterprise services: Java Management Extensions (JMX), sending e-mail with JavaMail, and scheduling tasks with Quartz. In addition, you’ll learn about Spring’s support for various remoting technologies<a id="cXXX.1009" class="calibre5"></a>, such as RMI, Hessian, Burlap, HTTP Invoker, and SOAP web services.</p>
<p class="indent">JMX is part of JavaSE and is a technology for managing and monitoring system resources such as devices, applications, objects, and service-driven networks. These resources are represented as managed beans (MBeans)<a id="cXXX.1010" class="calibre5"></a><i class="calibre8">See also</i> JMX MBeans. Spring supports JMX by exporting any Spring bean as model MBeans without programming against the JMX API. In addition, Spring can easily access remote MBeans.</p>
<p class="indent">JavaMail is the standard API and implementation for sending e-mail in Java. Spring further provides an abstract layer to send e-mail in an implementation-independent fashion.</p>
<p class="indent">There are two main options for scheduling tasks on the Java platform: JDK Timer and Quartz Scheduler (<span class="FontName"><a href="http://quartz-scheduler.org/" class="calibre5">http://quartz-scheduler.org/</a></span>). JDK Timer offers simple task scheduling features that are bundled with JDK. Compared with JDK Timer, Quartz offers more powerful job scheduling features. For both options, Spring supplies utility classes to configure scheduling tasks in a bean configuration file, without using either API directly.</p>
<p class="indent">Remoting is a key technology to develop distributed applications, especially multitier enterprise applications<a id="cXXX.1011" class="calibre5"></a>. It allows different applications or components, running in different JVMs or on different machines, to communicate with each other using a specific protocol.</p>
<p class="indent">Spring’s remoting support is consistent across different remoting technologies. On the server side, Spring allows you to expose an arbitrary bean as a remote service through a service exporter. On the client side, Spring provides various proxy factory beans for you to create a local proxy for a remote service so that you can use the remote service as if they were local beans.</p>
<p class="indent">You’ll learn how to use a series of remoting technologies that include: RMI, Hessian, Burlap, HTTP Invoker, and SOAP web services<a id="cXXX.2178a" class="calibre5"></a> using Spring Web Services (Spring-WS<a id="cXXX.1012" class="calibre5"></a>).</p>
<p id="Sec1" class="Heading">14-1.  Register Spring POJOs as JMX MBeans</p>
<p id="Sec2" class="Heading1">Problem</p>
<p class="noindent">You want to register an object in your Java application as a JMX MBean, to have the ability to look at services that are running and manipulate their state at runtime. This will allow you to run tasks like: rerun batch jobs, invoke methods, and change configuration metadata.</p>
<p id="Sec3" class="Heading1">Solution</p>
<p class="noindent">Spring supports JMX by allowing you to export any beans in its IoC container as model MBeans. This can be done simply by declaring an MBeanExporter instance. With Spring’s JMX support, you don’t need to deal with the JMX API directly. In addition, Spring enables you to declare JSR-160 (Java Management Extensions Remote API<a id="cXXX.1013" class="calibre5"></a>) connectors to expose MBeans for remote access over a specific protocol by using a factory bean. Spring provides factory beans for both servers and clients.</p>
<p class="indent">Spring’s JMX support comes with other mechanisms by which you can assemble an MBean’s management interface<a id="cXXX.1014" class="calibre5"></a>. These options include using exporting beans by method names, interfaces, and annotations. Spring can also detect and export MBeans automatically from beans declared in the IoC container and annotated with JMX-specific annotations defined by Spring.</p>
<p id="Sec4" class="Heading1">How It Works</p>
<p class="noindent">Suppose you’re developing a utility for replicating<a id="cXXX.1015" class="calibre5"></a> files from one directory to another. Let’s design the interface for this utility:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public interface FileReplicator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public String getSrcDir();</span><br class="calibre10"/>    <span class="FontName">public void setSrcDir(String srcDir);</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public String getDestDir();</span><br class="calibre10"/>    <span class="FontName">public void setDestDir(String destDir);</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public FileCopier getFileCopier();</span><br class="calibre10"/>    <span class="FontName">public void setFileCopier(FileCopier fileCopier);</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void replicate() throws IOException;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The source and destination directories<a id="cXXX.1016" class="calibre5"></a> are designed as properties of a replicator object, not method arguments. That means each file replicator instance replicates files only for a particular source and destination directory. You can create multiple replicator instances in your application.</p>
<p class="indent">But before you implement this replicator, let’s create another interface that copies a file from one directory to another, given its name.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public interface FileCopier {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void copyFile(String srcDir, String destDir, String filename)</span><br class="calibre10"/>            <span class="FontName">throws IOException;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">There are many strategies for implementing this file copier. For instance, you can make use of the <span class="FontName">FileCopyUtils</span> class provided by Spring.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.util.FileCopyUtils;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class FileCopierJMXImpl implements FileCopier {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void copyFile(String srcDir, String destDir, String filename)</span><br class="calibre10"/>            <span class="FontName">throws IOException {</span><br class="calibre10"/>        <span class="FontName">File srcFile = new File(srcDir, filename);</span><br class="calibre10"/>        <span class="FontName">File destFile = new File(destDir, filename);</span><br class="calibre10"/>        <span class="FontName">FileCopyUtils.copy(srcFile, destFile);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">With the help of a file copier, you can implement the file replicator, as shown in the following code sample.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.io.File;</span><br class="calibre10"/><span class="FontName">import java.io.IOException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class FileReplicatorJMXImpl implements FileReplicator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String srcDir;</span><br class="calibre10"/>    <span class="FontName">private String destDir;</span><br class="calibre10"/>    <span class="FontName">private FileCopier fileCopier;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// getters ommited for brevity</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// setters</span><br class="calibre10"/>    <span class="FontName">public void setSrcDir(String srcDir) {</span><br class="calibre10"/>        <span class="FontName">this.srcDir = srcDir;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setDestDir(String destDir) {</span><br class="calibre10"/>        <span class="FontName">this.destDir = destDir;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setFileCopier(FileCopier fileCopier) {</span><br class="calibre10"/>        <span class="FontName">this.fileCopier = fileCopier;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public synchronized void replicate() throws IOException {</span><br class="calibre10"/>        <span class="FontName">File[] files = new File(srcDir).listFiles();</span><br class="calibre10"/>        <span class="FontName">for (File file : files) {</span><br class="calibre10"/>            <span class="FontName">if (file.isFile()) {</span><br class="calibre10"/>                <span class="FontName">fileCopier.copyFile(srcDir, destDir, file.getName());</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Each time you call the <span class="FontName">replicate()</span> method<a id="cXXX.1017" class="calibre5"></a>, all files in the source directory are replicated to the destination directory. To avoid unexpected problems caused by concurrent replication, you declare this method as synchronized.</p>
<p class="indent">Now, you can configure one or more file replicator instances in a Java Config class<a id="cXXX.1018" class="calibre5"></a>. The documentReplicator instance needs references to two directories: a source directory from which files are read and a target directory to which files are backed up. The code in this example attempts to read from a directory called docs in your operating system user’s home directory and then copy to a folder called docs_backup in your operating system user’s home directory. When this bean starts up, it creates the two directories if they don’t already exist there.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Tip</b>  The “home directory” is different for each operating system, but typically on Unix it’s the directory that ~ resolves to. On a Linux box, the folder might be /home/user. On Mac OS X, the folder might be /Users/user, and on Windows it might be similar to C:\Documents and Settings\user.</p></div>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator.config;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class FileReplicatorConfig {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Value("#{systemProperties['user.home']}/docs")</span><br class="calibre10"/>    <span class="FontName">private String srcDir;</span><br class="calibre10"/>    <span class="FontName">@Value("#{systemProperties['user.home']}/docs_backup")</span><br class="calibre10"/>    <span class="FontName">private String destDir;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public FileCopier fileCopier() {</span><br class="calibre10"/>        <span class="FontName">FileCopier fCop = new FileCopierJMXImpl();</span><br class="calibre10"/>        <span class="FontName">return fCop;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public FileReplicator documentReplicator() {</span><br class="calibre10"/>        <span class="FontName">FileReplicator fRep = new FileReplicatorJMXImpl();</span><br class="calibre10"/>        <span class="FontName">fRep.setSrcDir(srcDir);</span><br class="calibre10"/>        <span class="FontName">fRep.setDestDir(destDir);</span><br class="calibre10"/>              <span class="FontName">fRep.setFileCopier(fileCopier());</span><br class="calibre10"/>        <span class="FontName">return fRep;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@PostConstruct</span><br class="calibre10"/>    <span class="FontName">public void verifyDirectoriesExist() {</span><br class="calibre10"/>        <span class="FontName">File src = new File(srcDir);</span><br class="calibre10"/>        <span class="FontName">File dest = new File(destDir);</span><br class="calibre10"/>        <span class="FontName">if (!src.exists())</span><br class="calibre10"/>            <span class="FontName">src.mkdirs();</span><br class="calibre10"/>        <span class="FontName">if (!dest.exists())</span><br class="calibre10"/>            <span class="FontName">dest.mkdirs();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Initially two fields are declared using the <span class="FontName">@Value</span> annotations<a id="cXXX.1019" class="calibre5"></a> to gain access to the user’s home directory and define the source and destination directories. Next, two bean instances are created using the <span class="FontName">@Bean</span> annotation. Notice the <span class="FontName">@PostConstuct</span> annotation on the <span class="FontName">verifyDirectoriesExist()</span>, which ensures the source and destination directories exist.</p>
<p class="indent">Now that we have the application’s core beans, let’s take look at how to register and access the beans as an MBean.</p>
<p id="Sec5" class="Heading2">Register MBeans without Spring’s Support</p>
<p class="noindent">First, let’s see how to register a model MBean using the JMX API directly. In the following Main class, you get the <span class="FontName">FileReplicator</span> bean from the IoC container and register it as an MBean for management and monitoring. All properties and methods are included in the MBean’s management interface<a id="cXXX.1020" class="calibre5"></a>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import java.lang.management.ManagementFactory;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.management.Descriptor;</span><br class="calibre10"/><span class="FontName">import javax.management.JMException;</span><br class="calibre10"/><span class="FontName">import javax.management.MBeanServer;</span><br class="calibre10"/><span class="FontName">import javax.management.ObjectName;</span><br class="calibre10"/><span class="FontName">import javax.management.modelmbean.DescriptorSupport;</span><br class="calibre10"/><span class="FontName">import javax.management.modelmbean.InvalidTargetObjectTypeException;</span><br class="calibre10"/><span class="FontName">import javax.management.modelmbean.ModelMBeanAttributeInfo;</span><br class="calibre10"/><span class="FontName">import javax.management.modelmbean.ModelMBeanInfo;</span><br class="calibre10"/><span class="FontName">import javax.management.modelmbean.ModelMBeanInfoSupport;</span><br class="calibre10"/><span class="FontName">import javax.management.modelmbean.ModelMBeanOperationInfo;</span><br class="calibre10"/><span class="FontName">import javax.management.modelmbean.RequiredModelMBean;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.GenericXmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws IOException {</span><br class="calibre10"/>        <span class="FontName">ApplicationContext context =</span><br class="calibre10"/>                            <span class="FontName">new AnnotationConfigApplicationContext("com.apress.springrecipes.replicator.config");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">FileReplicator documentReplicator = context.getBean(FileReplicator.class);</span><br class="calibre10"/>        <span class="FontName">try {</span><br class="calibre10"/>            <span class="FontName">MBeanServer mbeanServer = ManagementFactory.getPlatformMBeanServer();</span><br class="calibre10"/>            <span class="FontName">ObjectName objectName = new ObjectName("bean:name=documentReplicator");</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">RequiredModelMBean mbean = new RequiredModelMBean();</span><br class="calibre10"/>            <span class="FontName">mbean.setManagedResource(documentReplicator, "objectReference");</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">Descriptor srcDirDescriptor = new DescriptorSupport(new String[] {</span><br class="calibre10"/>                    <span class="FontName">"name=SrcDir", "descriptorType=attribute",</span><br class="calibre10"/>                    <span class="FontName">"getMethod=getSrcDir", "setMethod=setSrcDir" });</span><br class="calibre10"/>            <span class="FontName">ModelMBeanAttributeInfo srcDirInfo = new ModelMBeanAttributeInfo(</span><br class="calibre10"/>                    <span class="FontName">"SrcDir", "java.lang.String", "Source directory",</span><br class="calibre10"/>                    <span class="FontName">true, true, false, srcDirDescriptor);</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">Descriptor destDirDescriptor = new DescriptorSupport(new String[] {</span><br class="calibre10"/>                    <span class="FontName">"name=DestDir", "descriptorType=attribute",</span><br class="calibre10"/>                    <span class="FontName">"getMethod=getDestDir", "setMethod=setDestDir" });</span><br class="calibre10"/>            <span class="FontName">ModelMBeanAttributeInfo destDirInfo = new ModelMBeanAttributeInfo(</span><br class="calibre10"/>                    <span class="FontName">"DestDir", "java.lang.String", "Destination directory",</span><br class="calibre10"/>                    <span class="FontName">true, true, false, destDirDescriptor);</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">ModelMBeanOperationInfo getSrcDirInfo = new ModelMBeanOperationInfo</span><span class="FontName">(</span><br class="calibre10"/>                    <span class="FontName">"Get source directory",</span><br class="calibre10"/>                    <span class="FontName">FileReplicator.class.getMethod("getSrcDir"));</span><br class="calibre10"/>            <span class="FontName">ModelMBeanOperationInfo setSrcDirInfo = new ModelMBeanOperationInfo(</span><br class="calibre10"/>                    <span class="FontName">"Set source directory",</span><br class="calibre10"/>                    <span class="FontName">FileReplicator.class.getMethod("setSrcDir", String.class));</span><br class="calibre10"/>            <span class="FontName">ModelMBeanOperationInfo getDestDirInfo = new ModelMBeanOperationInfo(</span><br class="calibre10"/>                    <span class="FontName">"Get destination directory",</span><br class="calibre10"/>                    <span class="FontName">FileReplicator.class.getMethod("getDestDir"));</span><br class="calibre10"/>            <span class="FontName">ModelMBeanOperationInfo setDestDirInfo = new ModelMBeanOperationInfo(</span><br class="calibre10"/>                    <span class="FontName">"Set destination directory",</span><br class="calibre10"/>                    <span class="FontName">FileReplicator.class.getMethod("setDestDir", String.class));</span><br class="calibre10"/>            <span class="FontName">ModelMBeanOperationInfo replicateInfo = new ModelMBeanOperationInfo(</span><br class="calibre10"/>                    <span class="FontName">"Replicate files",</span><br class="calibre10"/>                    <span class="FontName">FileReplicator.class.getMethod("replicate"));</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">ModelMBeanInfo mbeanInfo = new ModelMBeanInfoSupport(</span><br class="calibre10"/>                    <span class="FontName">"FileReplicator", "File replicator",</span><br class="calibre10"/>                    <span class="FontName">new ModelMBeanAttributeInfo[] { srcDirInfo, destDirInfo },</span><br class="calibre10"/>                    <span class="FontName">null,</span><br class="calibre10"/>                    <span class="FontName">new ModelMBeanOperationInfo[] { getSrcDirInfo, setSrcDirInfo,</span><br class="calibre10"/>                            <span class="FontName">getDestDirInfo, setDestDirInfo, replicateInfo },</span><br class="calibre10"/>                    <span class="FontName">null);</span><br class="calibre10"/>            <span class="FontName">mbean.setModelMBeanInfo(mbeanInfo);</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">mbeanServer.registerMBean(mbean, objectName);</span><br class="calibre10"/>        <span class="FontName">} catch (JMException e) {</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">} catch (InvalidTargetObjectTypeException e) {</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">} catch (NoSuchMethodException e) {</span><br class="calibre10"/>            <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">System.in.read();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">To register an MBean, you need an instance of the interface <span class="FontName">javax.managment.MBeanServer</span>. You can call the static method <span class="FontName">ManagementFactory.getPlatformMBeanServer()</span> to locate a platform MBean server. It will create an MBean server if none exists and then register this server instance for future use. Each MBean requires an MBean object name that includes a domain. The preceding MBean is registered under the domain bean with the name <span class="FontName">documentReplicator</span><a id="cXXX.1021" class="calibre5"></a>.</p>
<p class="indent">From the preceding code, you can see that for each MBean attribute and MBean operation, you need to create a <span class="FontName">ModelMBeanAttributeInfo</span> object and a <span class="FontName">ModelMBeanOperationInfo</span> object for describing it. After those, you have to create a ModelMBeanInfo object<a id="cXXX.1022" class="calibre5"></a> for describing the MBean’s management interface by assembling the preceding information. For details about using these classes, you can consult their Javadocs.</p>
<p class="indent">Moreover, you have to handle the JMX-specific exceptions when calling the JMX API. These exceptions are checked exceptions that you must handle.</p>
<p class="indent">Note that you must prevent your application from terminating before you look inside it with a JMX client tool. Requesting a key from the console using <span class="FontName">System.in.read()</span> is a good choice.</p>
<p class="indent">Finally, you have to add the VM argument <span class="FontName">-Dcom.sun.management.jmxremote</span> to enable local monitoring of this application. If you’re using the book’s source code, you can use the following:</p>
<pre class="calibre11"><span class="FontName">java -Dcom.sun.management.jmxremote -jar  Recipe_14_1_i-1.0-SNAPSHOT.jar</span></pre>
<p class="indent">Now, you can use any JMX client tools to monitor your MBeans locally. The simplest one is JConsole<a id="cXXX.2095" class="calibre5"></a>, which comes with JDK. To start JConsole, just execute the jconsole executable file located in the bin directory of the JDK installation.</p>
<p class="indent">When JConsole starts, you can see a list of JMX-enabled applications<a id="cXXX.1023" class="calibre5"></a> on the Local tab of the connection window. Select the process that corresponds to the running Spring app (i.e., Recipe_14_1_i-1.0-SNAPSHOT.jar). This is illustrated in <a id="cXXX.1024" class="calibre5"></a> <a id="_Fig1" href="part0024.html#Fig1" class="calibre5">Figure 14-1</a>.</p>
<div class="Figure" id="Fig1"><p class="img1"><img src="../images/00081.jpeg" alt="9781430259084_Fig14-01.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0024.html#_Fig1" class="calibre5">Figure 14-1</a>.</span> JConsole startup window<a id="cXXX.1025" class="calibre5"></a></p></div>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Caution</b>  If you’re on Windows, you may not see any processes in JConsole. This is a known bug where JConsole isn’t able to detect running Java processes. To solve this issue you’ll need to ensure the user has a hsperfdata folder in his temp folder. This folder is used by Java and JConsole to keep track of running processes and it may not exist. For example if you’re running application as user John.Doe, ensure the following path exists: C:\Users\John.Doe\AppData\Local\Temp\hsperfdata_John.Doe\</p></div>
<p class="indent">After connecting to the replicator application, go to the MBeans tab. Next, click on the Bean folder in the left-hand tree, followed by the operations section. In the main screen you’ll see a series of buttons to invoke the bean’s operations, to invoke replicate() simply click the button “replicate”. This screen is illustrated in <a id="cXXX.1026" class="calibre5"></a> <a id="_Fig2" href="part0024.html#Fig2" class="calibre5">Figure 14-2</a>.</p>
<div class="Figure" id="Fig2"><p class="img1"><img src="../images/00082.jpeg" alt="9781430259084_Fig14-02.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0024.html#_Fig2" class="calibre5">Figure 14-2</a>.</span> JConsole simulate Spring bean operation</p></div>
<p class="indent">You’ll see a ‘Method successfully invoked’ pop-up window. With this action all the filters in the source folder are copied/synchronized with those in the destination folder.</p>
<p id="Sec6" class="Heading2">Register MBean with Spring support</p>
<p class="noindent">The prior application relied on the use of the JMX API directly. As you saw in the Main application class, there’s a lot of code that can be difficult to write, manage, and sometimes understand. To export beans configured in the Spring IoC container<a id="cXXX.1027" class="calibre5"></a> as MBeans, you simply create an <span class="FontName">MBeanExporter</span> instance and specify the beans to export, with their MBean object names as the keys. This can be done by adding the following configuration class. Note that the key entry in the <span class="FontName">beansToExport Map</span> is used as the <span class="FontName">ObjectName</span> for the bean referenced by the corresponding entry value.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.replicator.FileReplicator;</span><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.annotation.Autowired;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.export.MBeanExporter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.HashMap;</span><br class="calibre10"/><span class="FontName">import java.util.Map;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class JmxConfig {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">private FileReplicator fileReplicator;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MBeanExporter mbeanExporter() {</span><br class="calibre10"/>        <span class="FontName">MBeanExporter mbeanExporter = new MBeanExporter();</span><br class="calibre10"/>        <span class="FontName">mbeanExporter.setBeans(beansToExport());</span><br class="calibre10"/>        <span class="FontName">return mbeanExporter;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private Map&lt;String, Object&gt; beansToExport() {</span><br class="calibre10"/>        <span class="FontName">Map&lt;String, Object&gt; beansToExport = new HashMap&lt;&gt;();</span><br class="calibre10"/>        <span class="FontName">beansToExport.put("bean:name=documentReplicator", fileReplicator);</span><br class="calibre10"/>        <span class="FontName">return beansToExport;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The preceding configuration exports the <span class="FontName">FileReplicator</span> bean as an MBean, under the domain bean and with the name documentReplicator. By default, all public properties are included as attributes and all public methods (with the exception of those from java.lang.Object) are included as operations in the MBean’s management interface.</p>
<p class="indent">And with the help of this Spring JMX exported the main class in the application can be cut down to the following lines:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws IOException {</span><br class="calibre10"/>        <span class="FontName">new AnnotationConfigApplicationContext("com.apress.springrecipes.replicator.config");</span><br class="calibre10"/>        <span class="FontName">System.in.read();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec7" class="Heading2">Work with multiple MBean server instances</p>
<p class="noindent">The Spring MBeanExporter approach<a id="cXXX.1028" class="calibre5"></a> can locate an MBean server instance and register MBeans with it implicitly. The JDK creates an MBean server the first time when you locate it, so there’s no need to create an MBean server explicitly. The same case applies if an application is running in an environment that provides an MBean server (e.g., a Java application server).</p>
<p class="indent">However, if you have multiple MBean servers running, you need to tell the mbeanServer bean to which server it should bind. You do this by specifying the agentId of the server. To figure out the agentId of a given server in JConsole, for example, go to the MBeans tab and in the left-hand tree go to JMImplementation<span class="FontName">/MBeanServerDelegate/Attributes/MBeanServerId</span>. There, you’ll see the string value. On our local machine, the value is workstation_1253860476443. To enable it, configure the agentId property of the MBeanServer.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public MBeanServerFactoryBean mbeanServer() {</span><br class="calibre10"/>    <span class="FontName">MBeanServerFactoryBean mbeanServer = new MBeanServerFactoryBean();</span><br class="calibre10"/>    <span class="FontName">mbeanServer.setLocateExistingServerIfPossible(true);</span><br class="calibre10"/>    <span class="FontName">mbeanServer.setAgentId("workstation_1253860476443");</span><br class="calibre10"/>    <span class="FontName">return mbeanServer;</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>If you have multiple MBean server instances in your context, you can explicitly specify a specific MBean server for MBeanExporter to export your MBeans to. In this case, MBeanExporter will not locate an MBean server; it will use the specified MBean server instance. This property is for you to specify a particular MBean server when more than one is available.<br class="calibre10"/><br class="calibre10"/><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public MBeanExporter mbeanExporter() {</span><br class="calibre10"/>    <span class="FontName">MBeanExporter mbeanExporter = new MBeanExporter();</span><br class="calibre10"/>    <span class="FontName">mbeanExporter.setBeans(beansToExport());</span><br class="calibre10"/>    <span class="FontName">mbeanExporter.setServer(mbeanServer().getObject());</span><br class="calibre10"/>    <span class="FontName">return mbeanExporter;</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public MBeanServerFactoryBean mbeanServer() {</span><br class="calibre10"/>    <span class="FontName">MBeanServerFactoryBean mbeanServer = new MBeanServerFactoryBean();</span><br class="calibre10"/>    <span class="FontName">mbeanServer.setLocateExistingServerIfPossible(true);</span><br class="calibre10"/>    <span class="FontName">return mbeanServer;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec8" class="Heading2">Register MBeans for Remote Access with RMI<a id="cXXX.1029" class="calibre6"></a></p>
<p class="noindent">If you want your MBeans to be accessed remotely, you need to enable a remoting protocol for JMX. JSR-160 defines a standard for JMX remoting through a JMX connector. Spring allows you to create a JMX connector server through ConnectorServerFactoryBean.</p>
<p class="indent">By default, <span class="FontName">ConnectorServerFactoryBean</span> creates and starts a JMX connector server bound to the service URL <span class="FontName">service:jmx:jmxmp://localhost:9875</span>, which exposes the JMX connector through the JMX Messaging Protocol (JMXMP). However, most JMX implementations don’t support JMXMP. Therefore, you should choose a widely supported remoting protocol for your JMX connector, such as RMI. To expose your JMX connector through a specific protocol, you just provide the service URL for it.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public FactoryBean&lt;Registry&gt; rmiRegistry() {</span><br class="calibre10"/>    <span class="FontName">return new RmiRegistryFactoryBean();</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">@DependsOn("rmiRegistry")</span><br class="calibre10"/><span class="FontName">public FactoryBean&lt;JMXConnectorServer&gt; connectorServer() {</span><br class="calibre10"/>    <span class="FontName">ConnectorServerFactoryBean connectorServerFactoryBean = new ConnectorServerFactoryBean();</span><br class="calibre10"/>    <span class="FontName">connectorServerFactoryBean</span><br class="calibre10"/>        <span class="FontName">.setServiceUrl("service:jmx:rmi://localhost/jndi/rmi://localhost:1099/replicator");</span><br class="calibre10"/>    <span class="FontName">return connectorServerFactoryBean;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You specify the preceding URL to bind your JMX connector to an RMI registry listening on port 1099 of localhost. If no RMI registry has been created externally, you should create one by using RmiRegistryFactoryBean. The default port for this registry is 1099, but you can specify another one in its port property. Note that ConnectorServerFactoryBean must create the connector server after the RMI registry is created and ready. You can set the depends-on attribute for this purpose.</p>
<p class="indent">Now, your MBeans can be accessed remotely via RMI. Note there’s no need to start an RMI enabled app with the JMX -<span class="FontName">Dcom.sun.management.jmxremote</span> flag, as you did in previous apps.</p>
<p class="indent">When JConsole starts, you can enter <span class="FontName">service:jmx:rmi://localhost/jndi/rmi://localhost:1099/replicator</span> in the service URL on the ’Remote processes’ section of the connection window. This is illustrated in <a id="_Fig3" href="part0024.html#Fig3" class="calibre5">Figure 14-3</a>.</p>
<div class="Figure" id="Fig3"><p class="img1"><img src="../images/00083.jpeg" alt="9781430259084_Fig14-03.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0024.html#_Fig3" class="calibre5">Figure 14-3</a>.</span> JConsole connection to MBean through RMI<a id="cXXX.1030" class="calibre5"></a></p></div>
<p class="indent">Once the connection is established, you can invoke bean methods just as you did with previous examples.</p>
<p id="Sec9" class="Heading2">Assemble the Management Interface of MBeans</p>
<p class="noindent">By default, the Spring MBeanExporter exports all public properties of a bean as MBean attributes and all public methods as MBean operations. But you can assemble the management interface of MBeans using an MBean assembler. The simplest MBean assembler in Spring is <span class="FontName">MethodNameBasedMBeanInfoAssembler</span>, which allows you to specify the names of the methods to export.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class JmxConfig {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MBeanExporter mbeanExporter() {</span><br class="calibre10"/>        <span class="FontName">MBeanExporter mbeanExporter = new MBeanExporter();</span><br class="calibre10"/>        <span class="FontName">mbeanExporter.setBeans(beansToExport());</span><br class="calibre10"/>        <b class="calibre4">mbeanExporter.setAssembler(assembler());</b><br class="calibre10"/>        <span class="FontName">return mbeanExporter;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MBeanInfoAssembler assembler() {</span><br class="calibre10"/>        <span class="FontName">MethodNameBasedMBeanInfoAssembler assembler;</span><br class="calibre10"/>        <span class="FontName">assembler = new MethodNameBasedMBeanInfoAssembler();</span><br class="calibre10"/>        <span class="FontName">assembler.setManagedMethods(new String[] {"getSrcDir","setSrcDir","getDestDir","setDestDir","replicate"});</span><br class="calibre10"/>        <span class="FontName">return assembler;</span><br class="calibre10"/>    <span class="FontName">}</span></pre>
<p class="indent">Another MBean assembler is <span class="FontName">InterfaceBasedMBeanInfoAssembler</span><a id="cXXX.1031" class="calibre5"></a>, which exports all methods defined in the interfaces you specified.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MBeanInfoAssembler assembler() {</span><br class="calibre10"/>        <span class="FontName">InterfaceBasedMBeanInfoAssembler assembler = new InterfaceBasedMBeanInfoAssembler();</span><br class="calibre10"/>        <span class="FontName">assembler.setManagedInterfaces(new Class[] {FileReplicator.class});</span><br class="calibre10"/>        <span class="FontName">return assembler;</span><br class="calibre10"/>    <span class="FontName">}</span></pre>
<p class="indent">Spring also provides <span class="FontName">MetadataMBeanInfoAssembler</span> to assemble an MBean’s management interface based on the metadata in the bean class. It supports two types of metadata: JDK annotations and Apache Commons Attributes (behind the scenes, this is accomplished using a strategy interface <span class="FontName">JmxAttributeSource</span>). For a bean class annotated with JDK annotations, you specify an <span class="FontName">AnnotationJmxAttributeSource</span> instance as the attribute source of <span class="FontName">MetadataMBeanInfoAssembler</span>.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MBeanInfoAssembler assembler() {</span><br class="calibre10"/>        <span class="FontName">MetadataMBeanInfoAssembler assembler = new MetadataMBeanInfoAssembler();</span><br class="calibre10"/>        <span class="FontName">assembler.setAttributeSource(new AnnotationJmxAttributeSource());</span><br class="calibre10"/>        <span class="FontName">return assembler;</span><br class="calibre10"/><span class="FontName">    }</span></pre>
<p class="indent">Then, you annotate your bean class and methods with the annotations <span class="FontName">@ManagedResource</span>, <span class="FontName">@ManagedAttribute</span>, and <span class="FontName">@ManagedOperation</span> for <span class="FontName">MetadataMBeanInfoAssembler</span> to assemble the management interface for this bean. The annotations are easily interpreted. They expose the element that they annotate. If you have a JavaBeans-compliant property, JMX will use the term attribute. Classes themselves are referred to as resources. In JMX, methods will be called operations. Knowing that, it’s easy to see what the following code does:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.export.annotation.ManagedAttribute;</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.export.annotation.ManagedOperation;</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.export.annotation.ManagedResource;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@ManagedResource(description = "File replicator")</span><br class="calibre10"/><span class="FontName">public class FileReplicatorJMXImpl implements FileReplicator {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@ManagedAttribute(description = "Get source directory")</span><br class="calibre10"/>    <span class="FontName">public String getSrcDir() {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@ManagedAttribute(description = "Set source directory")</span><br class="calibre10"/>    <span class="FontName">public void setSrcDir(String srcDir) {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@ManagedAttribute(description = "Get destination directory")</span><br class="calibre10"/>    <span class="FontName">public String getDestDir() {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@ManagedAttribute(description = "Set destination directory")</span><br class="calibre10"/>    <span class="FontName">public void setDestDir(String destDir) {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@ManagedOperation(description = "Replicate files")</span><br class="calibre10"/>    <span class="FontName">public synchronized void replicate() throws IOException {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec10" class="Heading2">Register MBeans with Annotations</p>
<p class="noindent">In addition to exporting<a id="cXXX.1032" class="calibre5"></a> a bean explicitly with <span class="FontName">MBeanExporter</span>, you can simply configure its subclass <span class="FontName">AnnotationMBeanExporter</span><a id="cXXX.1033" class="calibre5"></a> to auto-detect MBeans from beans declared in the IoC container. You don’t need to configure an MBean assembler for this exporter, because it uses <span class="FontName">MetadataMBeanInfoAssembler</span><a id="cXXX.1034" class="calibre5"></a> with <span class="FontName">AnnotationJmxAttributeSource</span> by default. You can delete the previous beans and assembler properties for this registration and simply leave the following:</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class JmxConfig {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MBeanExporter mbeanExporter() {</span><br class="calibre10"/>        <span class="FontName">AnnotationMBeanExporter mbeanExporter = new AnnotationMBeanExporter();</span><br class="calibre10"/>        <span class="FontName">return mbeanExporter;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent"><span class="FontName">AnnotationMBeanExporter</span> detects any beans configured in the IoC container with the <span class="FontName">@ManagedResource</span> annotation and exports them as MBeans. By default, this exporter exports a bean to the domain whose name is the same as its package name. Also, it uses the bean’s name in the IoC container as its MBean name, and the bean’s short class name as its type. So the documentReplicator bean will be exported under the following MBean object name:</p>
<pre class="calibre11"><span class="FontName">com.apress.springrecipes.replicator:name=documentReplicator, type=FileReplicatorJMXImpl</span></pre>
<p class="indent">If you don’t want to use the package name as the domain name, you can set the default domain for the exporter by adding the <span class="FontName">defaultDomain</span> property.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public MBeanExporter mbeanExporter() {</span><br class="calibre10"/>    <span class="FontName">AnnotationMBeanExporter mbeanExporter = new AnnotationMBeanExporter();</span><br class="calibre10"/>    <span class="FontName">mbeanExporter.setDefaultDomain("bean");</span><br class="calibre10"/>    <span class="FontName">return mbeanExporter;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">After setting the default domain to bean, the documentReplicator bean is exported under the following MBean object name:</p>
<pre class="calibre11"><span class="FontName">bean:name=documentReplicator,type=FileReplicatorJMXImpl</span></pre>
<p class="indent">In addition, you can specify a bean’s MBean object name in the <span class="FontName">objectName</span> attribute of the <span class="FontName">@ManagedResource</span> annotation. For example, you can export the file copier as an MBean by annotating it with the following annotations:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.export.annotation.ManagedOperation;</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.export.annotation.ManagedOperationParameter;</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.export.annotation.ManagedOperationParameters;</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.export.annotation.ManagedResource;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@ManagedResource(</span><br class="calibre10"/>    <span class="FontName">objectName = "bean:name=fileCopier,type=FileCopierJMXImpl",</span><br class="calibre10"/>    <span class="FontName">description = "File Copier")</span><br class="calibre10"/><span class="FontName">public class FileCopierImpl implements FileCopier {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@ManagedOperation(</span><br class="calibre10"/>        <span class="FontName">description = "Copy file from source directory to destination directory")</span><br class="calibre10"/>    <span class="FontName">@ManagedOperationParameters( {</span><br class="calibre10"/>        <span class="FontName">@ManagedOperationParameter(</span><br class="calibre10"/>            <span class="FontName">name = "srcDir", description = "Source directory"),</span><br class="calibre10"/>        <span class="FontName">@ManagedOperationParameter(</span><br class="calibre10"/>            <span class="FontName">name = "destDir", description = "Destination directory"),</span><br class="calibre10"/>        <span class="FontName">@ManagedOperationParameter(</span><br class="calibre10"/>            <span class="FontName">name = "filename", description = "File to copy") })</span><br class="calibre10"/>    <span class="FontName">public void copyFile(String srcDir, String destDir, String filename)</span><br class="calibre10"/>            <span class="FontName">throws IOException {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">However, specifying the object name in this way works only for classes that you’re going to create a single instance of in the IoC container (e.g., file copier), not for classes that you may create multiple instances of (e.g., file replicator). This is because you can only specify a single object name for a class. As a result, you shouldn’t try to run the same server multiple times without changing the names.</p>
<p class="indent">Finally, another possibility is to rely on Spring class scanning to export MBeans decorated with <span class="FontName">@ManagedResource</span><a id="cXXX.1035" class="calibre5"></a>. If the beans are initialized in a Java Config class, you can decorate the configuration class with the <span class="FontName">@EnableMBeanExport</span><a id="cXXX.1036" class="calibre5"></a>. This tells Spring to export any beans created with the <span class="FontName">@Bean</span> annotation, which are decorated with the <span class="FontName">@EnableMBeanSupport</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.EnableMBeanExport;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableMBeanExport</span><br class="calibre10"/><span class="FontName">public class FileReplicatorConfig {</span><br class="calibre10"/>     <span class="FontName">....</span><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public FileReplicatorJMXImpl documentReplicator() {</span><br class="calibre10"/>        <span class="FontName">FileReplicatorJMXImpl fRep = new FileReplicatorJMXImpl();</span><br class="calibre10"/>        <span class="FontName">fRep.setSrcDir(srcDir);</span><br class="calibre10"/>        <span class="FontName">fRep.setDestDir(destDir);</span><br class="calibre10"/>              <span class="FontName">fRep.setFileCopier(fileCopier());</span><br class="calibre10"/>        <span class="FontName">return fRep;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>   <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Due to the presence of the <span class="FontName">@EnableMBeanExport</span>, the bean <span class="FontName">documentReplicatior</span> of the type <span class="FontName">FileReplicatorJMXImpl</span> gets exported as an MBean because its source is decorated with the <span class="FontName">@ManagedResource</span> annotation.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Caution</b>  The use of the @EnableMBeanExport is done on @Bean instances with concrete classes, not interfaces like previous examples. Interface-based beans ’hide’ the target class, which also hide the JMX managed resource annotations and the MBean is not exported.</p></div>
<p id="Sec11" class="Heading">14-2. Publish and Listen to JMX Notifications</p>
<p id="Sec12" class="Heading1">Problem</p>
<p class="noindent">You want to publish JMX notifications from your MBeans and listen to them with JMX notification listeners.</p>
<p id="Sec13" class="Heading1">Solution</p>
<p class="noindent">Spring allows your beans to publish JMX notifications through the <span class="FontName">NotificationPublisher</span> interface<a id="cXXX.1037" class="calibre5"></a>. You can also register standard JMX notification listeners in the IoC container to listen to JMX notifications.</p>
<p id="Sec14" class="Heading1">How It Works</p>
<p id="Sec15" class="Heading2">Publish JMX Notifications</p>
<p class="noindent">The Spring IoC container supports the beans that are going to be exported as MBeans to publish JMX notifications. These beans must implement the <span class="FontName">NotificationPublisherAware</span> interface, to get access to <span class="FontName">NotificationPublisher</span> so that they can publish notifications.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import javax.management.Notification;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.jmx.export.notification.NotificationPublisher;</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.export.notification.NotificationPublisherAware;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@ManagedResource(description = "File replicator")</span><br class="calibre10"/><span class="FontName">public class FileReplicatorImpl implements FileReplicator,</span><br class="calibre10"/>        <span class="FontName">NotificationPublisherAware {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">private int sequenceNumber;</span><br class="calibre10"/>    <span class="FontName">private NotificationPublisher notificationPublisher;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setNotificationPublisher(</span><br class="calibre10"/>            <span class="FontName">NotificationPublisher notificationPublisher) {</span><br class="calibre10"/>        <span class="FontName">this.notificationPublisher = notificationPublisher;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">@ManagedOperation(description = "Replicate files")</span><br class="calibre10"/>    <span class="FontName">public void replicate() throws IOException {</span><br class="calibre10"/>        <span class="FontName">notificationPublisher.sendNotification(</span><br class="calibre10"/>                <span class="FontName">new Notification("replication.start", this, sequenceNumber));</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">notificationPublisher.sendNotification(</span><br class="calibre10"/>                <span class="FontName">new Notification("replication.complete", this, sequenceNumber));</span><br class="calibre10"/>        <span class="FontName">sequenceNumber++;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In this file replicator, you send a JMX notification whenever a replication starts or completes. The notification is visible both in the standard output in the console and can also be seen in the JConsole Notifications menu in the MBeans tab, as illustrated in <a id="cXXX.1038" class="calibre5"></a> <a id="_Fig4" href="part0024.html#Fig4" class="calibre5">Figure 14-4</a>.</p>
<div class="Figure" id="Fig4"><p class="img1"><img src="../images/00084.jpeg" alt="9781430259084_Fig14-04.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0024.html#_Fig4" class="calibre5">Figure 14-4</a>.</span> MBean events reported in JConsole</p></div>
<p class="indent">To see notifications in JConsole you must first click the ‘Subscribe’ button that appears toward the bottom, as illustrated in <a href="part0024.html#Fig4" class="calibre5">Figure 14-4</a>. Then, when invoke the <span class="FontName">replicate()</span> method using the JConsole button in the MBean ’operations’ section, you’ll see two new notifications arrive. The first argument in the Notification constructor is the notification type, while the second is the notification source.</p>
<p id="Sec16" class="Heading2">Listen to JMX Notifications<a id="cXXX.2097" class="calibre6"></a></p>
<p class="noindent">Now, let’s create a notification listener to listen to JMX notifications. Because a listener will be notified of many different types<a id="cXXX.1039" class="calibre5"></a> of notifications, such as <span class="FontName">javax.management.AttributeChangeNotification</span> when an MBean’s attribute has changed, you have to filter those notifications that you are interested in handling.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.management.Notification;</span><br class="calibre10"/><span class="FontName">import javax.management.NotificationListener;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class ReplicationNotificationListener implements NotificationListener {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void handleNotification(Notification notification, Object handback) {</span><br class="calibre10"/>        <span class="FontName">if (notification.getType().startsWith("replication")) {</span><br class="calibre10"/>            <span class="FontName">System.out.println(</span><br class="calibre10"/>                    <span class="FontName">notification.getSource() + " " +</span><br class="calibre10"/>                    <span class="FontName">notification.getType() + " #" +</span><br class="calibre10"/>                    <span class="FontName">notification.getSequenceNumber());</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Then, you can register this notification listener with your MBean exporter<a id="cXXX.1040" class="calibre5"></a> to listen to notifications emitted from certain MBeans.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public AnnotationMBeanExporter mbeanExporter() {</span><br class="calibre10"/>    <span class="FontName">AnnotationMBeanExporter mbeanExporter = new AnnotationMBeanExporter();</span><br class="calibre10"/>    <span class="FontName">mbeanExporter.setDefaultDomain("bean");</span><br class="calibre10"/>    <span class="FontName">mbeanExporter.setNotificationListenerMappings<a id="cXXX.2105" class="calibre5"></a>(notificationMappings());</span><br class="calibre10"/>    <span class="FontName">return mbeanExporter;</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public Map&lt;String, NotificationListener&gt; notificationMappings() {</span><br class="calibre10"/>    <span class="FontName">Map&lt;String, NotificationListener&gt; mappings = new HashMap&lt;&gt;();</span><br class="calibre10"/>    <span class="FontName">mappings.put("bean:name=documentReplicator,type=FileReplicatorJMXImpl",</span><br class="calibre10"/>                           <span class="FontName">new ReplicationNotificationListener());</span><br class="calibre10"/>    <span class="FontName">return mappings;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec17" class="Heading">14-3. Access Remote JMX MBeans in Spring</p>
<p id="Sec18" class="Heading1">Problem</p>
<p class="noindent">You want to access JMX MBeans<a id="cXXX.2096" class="calibre5"></a> running on a remote MBean server exposed by a JMX connector. When accessing remote MBeans directly with the JMX API, you have to write complex JMX-specific code.</p>
<p id="Sec19" class="Heading1">Solution</p>
<p class="noindent">Spring offers two approaches to simplify remote MBean access. First, it provides a factory bean to create an MBean server connection declaratively. With this server connection, you can query and update an MBean’s attributes, as well as invoke its operations. Second, Spring provides another factory bean that allows you to create a proxy for a remote MBean. With this proxy, you can operate a remote MBean as if it were a local bean.</p>
<p id="Sec20" class="Heading1">How It Works</p>
<p id="Sec21" class="Heading2">Access Remote MBeans through an MBean Server Connection<a id="cXXX.1041" class="calibre6"></a></p>
<p class="noindent">A JMX client requires an MBean server connection to access MBeans running on a remote MBean server. Spring provides <span class="FontName">org.springframework.jmx.support.MBeanServerConnectionFactoryBean</span> for you to create a connection to a remote JSR-160–enabled MBean server declaratively. You only have to provide the service URL for it to locate the MBean server. Now let’s declare this factory bean in your client bean configuration file (e.g., beans-jmx-client.xml).</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.FactoryBean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.support.MBeanServerConnectionFactoryBean;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.management.MBeanServerConnection;</span><br class="calibre10"/><span class="FontName">import java.net.MalformedURLException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class JmxClientConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public FactoryBean&lt;MBeanServerConnection&gt; mbeanServerConnection()</span><br class="calibre10"/>    <span class="FontName">throws MalformedURLException {</span><br class="calibre10"/>        <span class="FontName">MBeanServerConnectionFactoryBean mBeanServerConnectionFactoryBean =</span><br class="calibre10"/>        <span class="FontName">new MBeanServerConnectionFactoryBean();</span><br class="calibre10"/>        <span class="FontName">mBeanServerConnectionFactoryBean</span><br class="calibre10"/>           <span class="FontName">.setServiceUrl("service:jmx:rmi://localhost/jndi/rmi://localhost:1099/replicator");</span><br class="calibre10"/>        <span class="FontName">return mBeanServerConnectionFactoryBean;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">With the MBean server connection created by this factory bean, you can access and operate the MBeans running on the RMI server running on port 1099.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Tip</b>  You can use the RMI server presented in Recipe 14-1 which exposes MBeans. If you’re using the book’s source code, after you build the application with Gradle, you can start the server with the command: java -jar Recipe_14_1_iii-1.0-SNAPSHOT.jar.</p></div>
<p class="indent">With the connection established between both points, you can query and update an MBean’s attributes through the <span class="FontName">getAttribute()</span> and <span class="FontName">setAttribute()</span> methods, giving the MBean’s object name and attribute name. You can also invoke an MBean’s operations by using the <span class="FontName">invoke()</span> method.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.management.Attribute;</span><br class="calibre10"/><span class="FontName">import javax.management.MBeanServerConnection;</span><br class="calibre10"/><span class="FontName">import javax.management.ObjectName;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.Generic XmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Client {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">ApplicationContext context =</span><br class="calibre10"/>                <span class="FontName">new AnnotationConfigApplicationContext("com.apress.springrecipes.replicator.config");</span><br class="calibre10"/><br class="calibre10"/>                <span class="FontName">MBeanServerConnection mbeanServerConnection = context.getBean(MBeanServerConnection.class);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ObjectName mbeanName = new ObjectName(</span><br class="calibre10"/>                <span class="FontName">"bean:name=documentReplicator);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">String srcDir = (String) mbeanServerConnection.getAttribute(</span><br class="calibre10"/>                <span class="FontName">mbeanName, "SrcDir");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">mbeanServerConnection.setAttribute(</span><br class="calibre10"/>                <span class="FontName">mbeanName, new Attribute("DestDir", srcDir + "_backup"));</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">mbeanServerConnection.invoke(</span><br class="calibre10"/>                <span class="FontName">mbeanName, "replicate", new Object[] {}, new String[] {});</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In addition, let’s create a JMX notification listener, so we can listen in on file replication notifications:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.management.Notification;</span><br class="calibre10"/><span class="FontName">import javax.management.NotificationListener;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class ReplicationNotificationListener implements NotificationListener {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void handleNotification(Notification notification, Object handback) {</span><br class="calibre10"/>        <span class="FontName">if (notification.getType().startsWith("replication")) {</span><br class="calibre10"/>            <span class="FontName">System.out.println(</span><br class="calibre10"/>                    <span class="FontName">notification.getSource() + " " +</span><br class="calibre10"/>                    <span class="FontName">notification.getType() + " #" +</span><br class="calibre10"/>                    <span class="FontName">notification.getSequenceNumber());</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You can register this notification listener to the MBean server connection to listen to notifications emitted from this MBean server.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import javax.management.MBeanServerConnection;</span><br class="calibre10"/><span class="FontName">import javax.management.ObjectName;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Client {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">MBeanServerConnection mbeanServerConnection =</span><br class="calibre10"/>            <span class="FontName">(MBeanServerConnection) context.getBean("mbeanServerConnection");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ObjectName mbeanName = new ObjectName(</span><br class="calibre10"/>                <span class="FontName">"bean:name=documentReplicator);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">mbeanServerConnection.addNotificationListener(</span><br class="calibre10"/>                <span class="FontName">mbeanName, new ReplicationNotificationListener(), null, null);</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">After you run this application client, check JConsole for the RMI server application — using ‘Remote process’ at <span class="FontName">service:jmx:rmi://localhost/jndi/rmi://localhost:1099/replicator</span>. Under the ‘Notifications’ menu of the MBeans tab, you’ll see new notification of <span class="FontName">type jmx.attribute.change</span> as illustrated in <a id="_Fig5" href="part0024.html#Fig5" class="calibre5">Figure 14-5</a>.</p>
<div class="Figure" id="Fig5"><p class="img1"><img src="../images/00085.jpeg" alt="9781430259084_Fig14-05.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0024.html#_Fig5" class="calibre5">Figure 14-5</a>.</span> JConsole notification event invoked through RMI<a id="cXXX.1042" class="calibre5"></a></p></div>
<p id="Sec22" class="Heading2">Access Remote MBeans Through an MBean Proxy</p>
<p class="noindent">Another approach that Spring offers for remote MBean access<a id="cXXX.2146" class="calibre5"></a> is through MBeanProxy,<a id="cXXX.1043" class="calibre5"></a> which can be created by MBeanProxyFactoryBean<a id="cXXX.1044" class="calibre5"></a>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.FactoryBean;</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.access.MBeanProxyFactoryBean;</span><br class="calibre10"/><span class="FontName">import org.springframework.jmx.support.MBeanServerConnectionFactoryBean;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.management.MBeanServerConnection;</span><br class="calibre10"/><span class="FontName">import java.net.MalformedURLException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class JmxClientConfiguration {</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MBeanProxyFactoryBean fileReplicatorProxy() throws Exception {</span><br class="calibre10"/>        <span class="FontName">MBeanProxyFactoryBean fileReplicatorProxy = new MBeanProxyFactoryBean();</span><br class="calibre10"/>        <span class="FontName">fileReplicatorProxy.setServer(mbeanServerConnection().getObject());</span><br class="calibre10"/>        <span class="FontName">fileReplicatorProxy.setObjectName("bean:name=documentReplicator");</span><br class="calibre10"/>        <span class="FontName">fileReplicatorProxy.setProxyInterface(FileReplicator.class);</span><br class="calibre10"/>        <span class="FontName">return fileReplicatorProxy;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You need to specify the object name and the server connection for the MBean you are going to proxy. The most important is the proxy interface, whose local method calls will be translated into remote MBean calls behind the scenes.</p>
<p class="indent">Now, you can operate the remote MBean through this proxy as if it were a local bean. The preceding MBean operations invoked on the MBean server connection directly can be simplified as follows:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class Client {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>        <span class="FontName">FileReplicator fileReplicatorProxy = context.getBean(FileReplicator.class);</span><br class="calibre10"/>        <span class="FontName">String srcDir = fileReplicatorProxy.getSrcDir();</span><br class="calibre10"/>        <span class="FontName">fileReplicatorProxy.setDestDir(srcDir + "_backup");</span><br class="calibre10"/>        <span class="FontName">fileReplicatorProxy.replicate();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec23" class="Heading">14-4. Send E-mail with Spring’s E-mail Support</p>
<p id="Sec24" class="Heading1">Problem</p>
<p class="noindent">Many applications need to send e-mail. In a Java application, you can send e-mail with the JavaMail API. However, when using JavaMail, you have to handle JavaMail-specific mail sessions and exceptions. As a result, an application becomes JavaMail dependent and hard to switch to another e-mail API.</p>
<p id="Sec25" class="Heading1">Solution</p>
<p class="noindent">Spring’s e-mail support makes it easier to send e-mail by providing an abstract and implementation-independent API for sending e-mail. The core interface of Spring’s e-mail support is MailSender.</p>
<p class="indent">The JavaMailSender interface is a subinterface of <span class="FontName">MailSender</span> that includes specialized JavaMail features<a id="cXXX.1045" class="calibre5"></a> such as Multipurpose Internet Mail Extensions<a id="cXXX.2123" class="calibre5"></a> (MIME message support. To send an e-mail message with HTML content, inline images, or attachments, you have to send it as a MIME message.</p>
<p id="Sec26" class="Heading1">How It Works</p>
<p class="noindent">Suppose you want the file replicator application from the previous recipes to notify the administrator of any error. First, you create the following ErrorNotifier interface<a id="cXXX.1046" class="calibre5"></a>, which includes a method for notifying of a file copy error:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public interface ErrorNotifier {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void notifyCopyError(String srcDir, String destDir, String filename);</span><br class="calibre10"/><span class="FontName">}</span></pre>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  Invoking this notifier in case of error is left for you to accomplish. As you can consider error handling a crosscutting concern, AOP would be an ideal solution to this problem. You can write an after throwing advice to invoke this notifier.</p></div>
<p class="indent">Next, you can implement this interface to send a notification in a way of your choice. The most common way is to send e-mail. Before you implement the interface in this way, you may need a local e-mail server that supports the Simple Mail Transfer Protocol (SMTP)<a id="cXXX.1047" class="calibre5"></a> for testing purposes. We recommend installing Apache James Server<a id="cXXX.1048" class="calibre5"></a> (<span class="FontName"><a href="http://james.apache.org/server/index.html" class="calibre5">http://james.apache.org/server/index.html</a></span>), which is very easy to install and configure.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  You can download Apache James Server (e.g., version 2.3.2) from the Apache James web site and extract it to a directory of your choice to complete the installation. To start it, just execute the run script (located in the bin directory).</p></div>
<p class="indent">Let’s create two user accounts for sending and receiving e-mail with this server. By default, the remote manager service of James listens on port 4555. You can telnet, using a console, to this port and run the following commands to add the users system and admin, whose passwords are 12345:</p>
<pre class="calibre11"><span class="FontName">&gt; telnet 127.0.0.1 4555</span><br class="calibre10"/><span class="FontName">JAMES Remote Administration Tool 2.3.2</span><br class="calibre10"/><span class="FontName">Please enter your login and password</span><br class="calibre10"/><span class="FontName">Login id:</span><br class="calibre10"/><span class="FontName">root</span><br class="calibre10"/><span class="FontName">Password:</span><br class="calibre10"/><span class="FontName">itroot</span><br class="calibre10"/><span class="FontName">Welcome root. HELP for a list of commands</span><br class="calibre10"/><span class="FontName">adduser system 12345</span><br class="calibre10"/><span class="FontName">User system added</span><br class="calibre10"/><span class="FontName">adduser admin 12345</span><br class="calibre10"/><span class="FontName">User admin added</span><br class="calibre10"/><span class="FontName">listusers</span><br class="calibre10"/><span class="FontName">Existing accounts 2</span><br class="calibre10"/><span class="FontName">user: admin</span><br class="calibre10"/><span class="FontName">user: system</span><br class="calibre10"/><span class="FontName">quit</span><br class="calibre10"/><span class="FontName">Bye</span></pre>
<p id="Sec27" class="Heading2">Send E-mail Using the JavaMail<a id="cXXX.2080" class="calibre6"></a> API</p>
<p class="noindent">Now, let’s take a look at how to send e-mail using the JavaMail API<a id="cXXX.1049" class="calibre5"></a>. You can implement the <span class="FontName">ErrorNotifier</span> interface to send e-mail notifications in case of errors.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.Properties;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.mail.Message;</span><br class="calibre10"/><span class="FontName">import javax.mail.MessagingException;</span><br class="calibre10"/><span class="FontName">import javax.mail.Session;</span><br class="calibre10"/><span class="FontName">import javax.mail.Transport;</span><br class="calibre10"/><span class="FontName">import javax.mail.internet.InternetAddress;</span><br class="calibre10"/><span class="FontName">import javax.mail.internet.MimeMessage;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class EmailErrorNotifier implements ErrorNotifier {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void notifyCopyError(String srcDir, String destDir, String filename) {</span><br class="calibre10"/>        <span class="FontName">Properties props = new Properties();</span><br class="calibre10"/>        <span class="FontName">props.put("mail.smtp.host", "localhost");</span><br class="calibre10"/>        <span class="FontName">props.put("mail.smtp.port", "25");</span><br class="calibre10"/>        <span class="FontName">props.put("mail.smtp.username", "system");</span><br class="calibre10"/>        <span class="FontName">props.put("mail.smtp.password", "12345");</span><br class="calibre10"/>        <span class="FontName">Session session = Session.getDefaultInstance(props, null);</span><br class="calibre10"/>        <span class="FontName">try {</span><br class="calibre10"/>            <span class="FontName">Message message = new MimeMessage(session);</span><br class="calibre10"/>            <span class="FontName">message.setFrom(new InternetAddress("system@localhost"));</span><br class="calibre10"/>            <span class="FontName">message.setRecipients(Message.RecipientType.TO,</span><br class="calibre10"/>                    <span class="FontName">InternetAddress.parse("admin@localhost"));</span><br class="calibre10"/>            <span class="FontName">message.setSubject("File Copy Error");</span><br class="calibre10"/>            <span class="FontName">message.setText(</span><br class="calibre10"/>                <span class="FontName">"Dear Administrator,\n\n" +</span><br class="calibre10"/>                <span class="FontName">"An error occurred when copying the following file :\n" +</span><br class="calibre10"/>                <span class="FontName">"Source directory : " + srcDir + "\n" +</span><br class="calibre10"/>                <span class="FontName">"Destination directory : " + destDir + "\n" +</span><br class="calibre10"/>                <span class="FontName">"Filename : " + filename);</span><br class="calibre10"/>            <span class="FontName">Transport.send(message);</span><br class="calibre10"/>        <span class="FontName">} catch (MessagingException e) {</span><br class="calibre10"/>            <span class="FontName">throw new RuntimeException(e);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You first open a mail session connecting to an SMTP server by defining the properties. Then, you create a message from this session for constructing your e-mail. After that, you send the e-mail by making a call to <span class="FontName">Transport.send()</span>. When dealing with the JavaMail API, you have to handle the checked exception MessagingException. Note that all of these classes, interfaces, and exceptions are defined by JavaMail.</p>
<p class="indent">Next, declare an instance of <span class="FontName">EmailErrorNotifier</span> in the Spring IoC container for sending e-mail notifications in case of file replication errors.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.replicator.EmailErrorNotifier;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.replicator.ErrorNotifier;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class MailConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public ErrorNotifier errorNotifier() {</span><br class="calibre10"/>        <span class="FontName">return new EmailErrorNotifier();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You can write the following Main class to test <span class="FontName">EmailErrorNotifier</span>. After running it, you can configure your e-mail application to receive the e-mail from your James Server via POP3<a id="cXXX.1050" class="calibre5"></a>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.GenericXmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">ApplicationContext context =</span><br class="calibre10"/>            <span class="FontName">new AnnotationConfigApplicationContext("com.apress.springrecipes.replicator.config");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ErrorNotifier errorNotifier = context.getBean(ErrorNotifier.class);</span><br class="calibre10"/>        <span class="FontName">errorNotifier.notifyCopyError("c:/documents", "d:/documents", "spring.doc");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">To verify the email was sent, you can login to the POP server included with Apache James. You can telnet, using a console, to port 110 and run the following commands to view the email for user admin, whose password is the same you set on creation:</p>
<pre class="calibre11"><span class="FontName">&gt; telnet 127.0.0.1 110</span><br class="calibre10"/><span class="FontName">OK workstation POP3 server &lt;JAMES POP3 Server 2.3.2&gt; ready</span><br class="calibre10"/><span class="FontName">USER admin</span><br class="calibre10"/><span class="FontName">+OK</span><br class="calibre10"/><span class="FontName">PASS 12345</span><br class="calibre10"/><span class="FontName">+OK Welcome admin</span><br class="calibre10"/><span class="FontName">LIST</span><br class="calibre10"/><span class="FontName">+ OK 1 698</span><br class="calibre10"/><span class="FontName">RETR 1</span><br class="calibre10"/><span class="FontName">+OK Message follows</span><br class="calibre10"/><span class="FontName">...</span></pre>
<p id="Sec28" class="Heading2">Send E-mail with Spring’s MailSender<a id="cXXX.1051" class="calibre6"></a></p>
<p class="noindent">Now, let’s look at how to send e-mail with the help of Spring’s <span class="FontName">MailSender</span> interface, which can send <span class="FontName">SimpleMailMessage</span> in its <span class="FontName">send()</span> method. With this interface, your code is no longer JavaMail specific, and now it’s easier to test.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.mail.MailSender;</span><br class="calibre10"/><span class="FontName">import org.springframework.mail.SimpleMailMessage;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class EmailErrorNotifier implements ErrorNotifier {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private MailSender mailSender;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setMailSender(MailSender mailSender) {</span><br class="calibre10"/>        <span class="FontName">this.mailSender = mailSender;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void notifyCopyError(String srcDir, String destDir, String filename) {</span><br class="calibre10"/>        <span class="FontName">SimpleMailMessage message = new SimpleMailMessage();</span><br class="calibre10"/>        <span class="FontName">message.setFrom("system@localhost");</span><br class="calibre10"/>        <span class="FontName">message.setTo("admin@localhost");</span><br class="calibre10"/>        <span class="FontName">message.setSubject("File Copy Error");</span><br class="calibre10"/>        <span class="FontName">message.setText(</span><br class="calibre10"/>                <span class="FontName">"Dear Administrator,\n\n" +</span><br class="calibre10"/>                <span class="FontName">"An error occurred when copying the following file :\n" +</span><br class="calibre10"/>                <span class="FontName">"Source directory : " + srcDir + "\n" +</span><br class="calibre10"/>                <span class="FontName">"Destination directory : " + destDir + "\n" +</span><br class="calibre10"/>                <span class="FontName">"Filename : " + filename);</span><br class="calibre10"/>        <span class="FontName">mailSender.send(message);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Next, you have to configure a <span class="FontName">MailSender</span> implementation in the bean configuration file and inject it into <span class="FontName">EmailErrorNotifier</span>. In Spring, the unique implementation of this interface is <span class="FontName">JavaMailSenderImpl</span>, which uses JavaMail to send e-mail.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class MailConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public ErrorNotifier errorNotifier() {</span><br class="calibre10"/>        <span class="FontName">EmailErrorNotifier errorNotifier = new EmailErrorNotifier();</span><br class="calibre10"/>        <span class="FontName">errorNotifier.setMailSender(mailSender());</span><br class="calibre10"/>        <span class="FontName">return errorNotifier;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public JavaMailSenderImpl mailSender() {</span><br class="calibre10"/>        <span class="FontName">JavaMailSenderImpl mailSender = new JavaMailSenderImpl();</span><br class="calibre10"/>        <span class="FontName">mailSender.setHost("localhost");</span><br class="calibre10"/>        <span class="FontName">mailSender.setPort(25);</span><br class="calibre10"/>        <span class="FontName">mailSender.setUsername("system");</span><br class="calibre10"/>        <span class="FontName">mailSender.setPassword("12345");</span><br class="calibre10"/>        <span class="FontName">return mailSender;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The default port used by <span class="FontName">JavaMailSenderImpl</span> is the standard SMTP port 25, so if your e-mail server listens on this port for SMTP, you can simply omit this property. Also, if your SMTP server doesn’t require user authentication, you needn’t set the username and password.</p>
<p class="indent">If you have a JavaMail session configured in your Java app server, you can first look it up with the help of <span class="FontName">JndiLocatorDelegate</span>.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public Session mailSession() throws NamingException {</span><br class="calibre10"/>    <span class="FontName">return JndiLocatorDelegate</span><br class="calibre10"/>                <span class="FontName">.createDefaultResourceRefLocator()</span><br class="calibre10"/>                <span class="FontName">.lookup("mail/Session", Session.class);</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You can inject the JavaMail session into <span class="FontName">JavaMailSenderImpl</span> for its use. In this case, you no longer need to set the host, port, username, or password.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public JavaMailSenderImpl mailSender() {</span><br class="calibre10"/>        <span class="FontName">JavaMailSenderImpl mailSender = new JavaMailSenderImpl();</span><br class="calibre10"/>        <b class="calibre4">mailSender.setSession(mailSession());</b><br class="calibre10"/>        <span class="FontName">return mailSender;</span><br class="calibre10"/>    <span class="FontName">}</span></pre>
<p id="Sec29" class="Heading2">Define an E-mail Template</p>
<p class="noindent">Constructing an e-mail message from scratch in the method body is not efficient, because you have to hard-code the e-mail properties. Also, you may have difficulty in writing the e-mail text in terms of Java strings. You can consider defining an e-mail message template<a id="cXXX.1052" class="calibre5"></a> in the bean configuration file and construct a new e-mail message from it.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class MailConfiguration {</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public ErrorNotifier errorNotifier() {</span><br class="calibre10"/>        <span class="FontName">EmailErrorNotifier errorNotifier = new EmailErrorNotifier();</span><br class="calibre10"/>        <span class="FontName">errorNotifier.setMailSender(mailSender());</span><br class="calibre10"/>        <b class="calibre4">errorNotifier.setCopyErrorMailMessage(copyErrorMailMessage());</b><br class="calibre10"/>        <span class="FontName">return errorNotifier;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public SimpleMailMessage copyErrorMailMessage() {</span><br class="calibre10"/>        <span class="FontName">SimpleMailMessage message = new SimpleMailMessage();</span><br class="calibre10"/>        <span class="FontName">message.setFrom("system@localhost");</span><br class="calibre10"/>        <span class="FontName">message.setTo("admin@localhost");</span><br class="calibre10"/>        <span class="FontName">message.setSubject("File Copy Error");</span><br class="calibre10"/>        <span class="FontName">message.setText("Dear Administrator,\n" +</span><br class="calibre10"/>                <span class="FontName">"\n" +</span><br class="calibre10"/>                <span class="FontName">" An error occurred when copying the following file :\n" +</span><br class="calibre10"/>                <span class="FontName">"\t\t Source directory : %s\n" +</span><br class="calibre10"/>                <span class="FontName">"\t\t Destination directory : %s\n" +</span><br class="calibre10"/>                <span class="FontName">"\t\t Filename : %s");</span><br class="calibre10"/>        <span class="FontName">return message;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Note that in the preceding message text, you include the placeholders %s, which will be replaced by message parameters through <span class="FontName">String.format()</span>. Of course, you can also use a powerful templating language such as Velocity or FreeMarker to generate the message text according to a template. It’s also a good practice to separate mail message templates from bean configuration files.</p>
<p class="indent">Each time you send e-mail, you can construct a new <span class="FontName">SimpleMailMessage</span> instance from this injected template. Then you can generate the message text using <span class="FontName">String.format()</span> to replace the %s placeholders with your message parameters.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.mail.SimpleMailMessage;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class EmailErrorNotifier implements ErrorNotifier {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">private SimpleMailMessage copyErrorMailMessage;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setCopyErrorMailMessage(SimpleMailMessage copyErrorMailMessage) {</span><br class="calibre10"/>        <span class="FontName">this.copyErrorMailMessage = copyErrorMailMessage;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void notifyCopyError(String srcDir, String destDir, String filename) {</span><br class="calibre10"/>        <span class="FontName">SimpleMailMessage message = new SimpleMailMessage(copyErrorMailMessage);</span><br class="calibre10"/>        <span class="FontName">message.setText(String.format(</span><br class="calibre10"/>                <span class="FontName">copyErrorMailMessage.getText(), srcDir, destDir, filename));</span><br class="calibre10"/>        <span class="FontName">mailSender.send(message</span><span class="FontName">);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec30" class="Heading2">Send e-mail with attachments (MIME Messages)</p>
<p class="noindent">So far, the <span class="FontName">SimpleMailMessage</span> class you used can send only a simple plain text e-mail message. To send e-mail that contains HTML content, inline images, or attachments, you have to construct and send a MIME message instead. MIME is supported by JavaMail through the javax.mail.internet.MimeMessage class.</p>
<p class="indent">First of all, you have to use the <span class="FontName">JavaMailSender</span> interface instead of its parent interface <span class="FontName">MailSender</span>. The <span class="FontName">JavaMailSenderImpl</span> instance you injected does implement this interface, so you needn’t modify your bean configurations. The following notifier sends Spring’s bean configuration file<a id="cXXX.1053" class="calibre5"></a> as an e-mail attachment to the administrator:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.mail.MessagingException;</span><br class="calibre10"/><span class="FontName">import javax.mail.internet.MimeMessage;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.core.io.ClassPathResource;</span><br class="calibre10"/><span class="FontName">import org.springframework.mail.MailParseException;</span><br class="calibre10"/><span class="FontName">import org.springframework.mail.SimpleMailMessage;</span><br class="calibre10"/><span class="FontName">import org.springframework.mail.javamail.JavaMailSender;</span><br class="calibre10"/><span class="FontName">import org.springframework.mail.javamail.MimeMessageHelper;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class EmailErrorNotifier implements ErrorNotifier {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private JavaMailSender mailSender;</span><br class="calibre10"/>    <span class="FontName">private SimpleMailMessage copyErrorMailMessage;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setMailSender(JavaMailSender mailSender) {</span><br class="calibre10"/>        <span class="FontName">this.mailSender = mailSender;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setCopyErrorMailMessage(SimpleMailMessage copyErrorMailMessage) {</span><br class="calibre10"/>        <span class="FontName">this.copyErrorMailMessage = copyErrorMailMessage;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void notifyCopyError(String srcDir, String destDir, String filename) {</span><br class="calibre10"/>        <span class="FontName">MimeMessage message = mailSender.createMimeMessage();</span><br class="calibre10"/>        <span class="FontName">try {</span><br class="calibre10"/>            <span class="FontName">MimeMessageHelper helper = new MimeMessageHelper(message, true);</span><br class="calibre10"/>            <span class="FontName">helper.setFrom(copyErrorMailMessage.getFrom());</span><br class="calibre10"/>            <span class="FontName">helper.setTo(copyErrorMailMessage.getTo());</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">helper.setSubject(copyErrorMailMessage.getSubject());</span><br class="calibre10"/>            <span class="FontName">helper.setText(String.format(</span><br class="calibre10"/>                    <span class="FontName">copyErrorMailMessage.getText(), srcDir, destDir, filename));</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">ClassPathResource config = new ClassPathResource("beans.xml");</span><br class="calibre10"/>            <span class="FontName">helper.addAttachment("beans.xml", config);</span><br class="calibre10"/>        <span class="FontName">} catch (MessagingException e) {</span><br class="calibre10"/>            <span class="FontName">throw new MailParseException(e);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">mailSender.send(message);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Unlike <span class="FontName">SimpleMailMessage</span>, the <span class="FontName">MimeMessage</span> class is defined by JavaMail, so you can only instantiate it by calling <span class="FontName">mailSender.createMimeMessage()</span>. Spring provides the helper class <span class="FontName">MimeMessageHelper</span> to simplify the operations of <span class="FontName">MimeMessage</span>. It allows you to add an attachment from a Spring Resource object<a id="cXXX.1054" class="calibre5"></a>. However, the operations of this helper class can still throw JavaMail’s <span class="FontName">MessagingException</span>. You have to convert this exception into Spring’s mail runtime exception for consistency.</p>
<p class="indent">Spring offers another method for you to construct a MIME message, which is through implementing the <span class="FontName">MimeMessagePreparator</span> interface.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import javax.mail.internet.MimeMessage;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.mail.javamail.MimeMessagePreparator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class EmailErrorNotifier implements ErrorNotifier {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">public void notifyCopyError(</span><br class="calibre10"/>            <span class="FontName">final String srcDir, final String destDir, final String filename) {</span><br class="calibre10"/>        <span class="FontName">MimeMessagePreparator preparator = new MimeMessagePreparator() {</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">public void prepare(MimeMessage mimeMessage) throws Exception {</span><br class="calibre10"/>                <span class="FontName">MimeMessageHelper helper =</span><br class="calibre10"/>                    <span class="FontName">new MimeMessageHelper(mimeMessage, true);</span><br class="calibre10"/>                <span class="FontName">helper.setFrom(copyErrorMailMessage.getFrom());</span><br class="calibre10"/>                <span class="FontName">helper.setTo(copyErrorMailMessage.getTo());</span><br class="calibre10"/>                <span class="FontName">helper.setSubject(copyErrorMailMessage.getSubject());</span><br class="calibre10"/>                <span class="FontName">helper.setText(String.format(</span><br class="calibre10"/>                    <span class="FontName">copyErrorMailMessage.getText(), srcDir, destDir, filename));</span><br class="calibre10"/><br class="calibre10"/>                <span class="FontName">ClassPathResource config = new ClassPathResource("beans.xml");</span><br class="calibre10"/>                <span class="FontName">helper.addAttachment("beans.xml", config);</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">};</span><br class="calibre10"/>        <span class="FontName">mailSender.send(preparator);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In the <span class="FontName">prepare()</span> method, you can prepare the <span class="FontName">MimeMessage</span> object, which is precreated for <span class="FontName">JavaMailSender</span>. If there’s any exception thrown, it will be converted into Spring’s mail runtime exception automatically.</p>
<p id="Sec31" class="Heading">14-5. Schedule tasks with Spring’s Quartz Support</p>
<p id="Sec32" class="Heading1">Problem</p>
<p class="noindent">Your application has an advanced scheduling requirement that you want to fulfill using Quartz Scheduler<a id="cXXX.2142" class="calibre5"></a>. Such a requirement might be something seemingly complex like the ability to run at arbitrary times, or at strange intervals (“every other Thursday, but only after 10 am and before 2 pm”). Moreover, you want to configure scheduling jobs in a declarative way.</p>
<p id="Sec33" class="Heading1">Solution</p>
<p class="noindent">Spring provides utility classes for Quartz to enable scheduling jobs without programming against the Quartz API.</p>
<p id="Sec34" class="Heading1">How It Works</p>
<p id="Sec35" class="Heading2">Use Quartz Without Spring’s Support</p>
<p class="noindent">To use Quartz for scheduling, you first need to create a job by implementing the Job interface<a id="cXXX.1055" class="calibre5"></a>. For example, the following job executes the <span class="FontName">replicate()</span> method of the file replicator designed in the previous recipes. It retrieves a job data map — which is a Quartz concept to define jobs — through the <span class="FontName">JobExecutionContext</span> object.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.quartz.Job;</span><br class="calibre10"/><span class="FontName">import org.quartz.JobExecutionContext;</span><br class="calibre10"/><span class="FontName">import org.quartz.JobExecutionException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class FileReplicationJob implements Job {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void execute(JobExecutionContext context)</span><br class="calibre10"/>            <span class="FontName">throws JobExecutionException {</span><br class="calibre10"/>        <span class="FontName">Map dataMap = context.getJobDetail().getJobDataMap();</span><br class="calibre10"/>        <span class="FontName">FileReplicator fileReplicator =</span><br class="calibre10"/>            <span class="FontName">(FileReplicator) dataMap.get("fileReplicator");</span><br class="calibre10"/>        <span class="FontName">try {</span><br class="calibre10"/>            <span class="FontName">fileReplicator.replicate();</span><br class="calibre10"/>        <span class="FontName">} catch (IOException e) {</span><br class="calibre10"/>            <span class="FontName">throw new JobExecutionException(e);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">After creating the job, you configure and schedule it with the Quartz API<a id="cXXX.1056" class="calibre5"></a>. For instance, the following scheduler runs your file replication job every 60 seconds with a 5-second delay for the first time of execution:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.quartz.JobDetail;</span><br class="calibre10"/><span class="FontName">import org.quartz.JobDataMap;</span><br class="calibre10"/><span class="FontName">import org.quartz.JobBuilder;</span><br class="calibre10"/><span class="FontName">import org.quartz.Trigger;</span><br class="calibre10"/><span class="FontName">import org.quartz.TriggerBuilder;</span><br class="calibre10"/><span class="FontName">import org.quartz.SimpleScheduleBuilder;</span><br class="calibre10"/><span class="FontName">import org.quartz.DateBuilder.IntervalUnit.*;</span><br class="calibre10"/><span class="FontName">import org.quartz.Scheduler;</span><br class="calibre10"/><span class="FontName">import org.quartz.impl.StdSchedulerFactory;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.GenericXmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">ApplicationContext context =</span><br class="calibre10"/>                <span class="FontName">new AnnotationConfigApplicationContext("com.apress.springrecipes.replicator.config");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">FileReplicator documentReplicator = context.getBean(FileReplicator.class);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">JobDataMap jobDataMap = new JobDataMap();</span><br class="calibre10"/>        <span class="FontName">jobDataMap.put("fileReplicator", documentReplicator);</span><br class="calibre10"/><br class="calibre10"/>         <span class="FontName">JobDetail job = JobBuilder.newJob(FileReplicationJob.class)</span><br class="calibre10"/>            <span class="FontName">.withIdentity("documentReplicationJob")</span><br class="calibre10"/>            <span class="FontName">.storeDurably()</span><br class="calibre10"/>            <span class="FontName">.usingJobData(jobDataMap)</span><br class="calibre10"/>            <span class="FontName">.build();</span><br class="calibre10"/><br class="calibre10"/>         <span class="FontName">Trigger trigger = TriggerBuilder.newTrigger()</span><br class="calibre10"/>            <span class="FontName">.withIdentity("documentReplicationTrigger")</span><br class="calibre10"/>            <span class="FontName">.startAt(new Date(System.currentTimeMillis() + 5000))</span><br class="calibre10"/>            <span class="FontName">.forJob(job)</span><br class="calibre10"/>            <span class="FontName">.withSchedule(SimpleScheduleBuilder.simpleSchedule()</span><br class="calibre10"/>                         <span class="FontName">.withIntervalInSeconds(60)</span><br class="calibre10"/>                         <span class="FontName">.repeatForever())</span><br class="calibre10"/>                         <span class="FontName">.build();</span><br class="calibre10"/><br class="calibre10"/>         <span class="FontName">Scheduler scheduler = new StdSchedulerFactory().getScheduler();</span><br class="calibre10"/>         <span class="FontName">scheduler.start();</span><br class="calibre10"/>         <span class="FontName">scheduler.scheduleJob(job, trigger);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In the <span class="FontName">Main</span> class, you first create a job map. In this case it’s a single job, where the key is a descriptive name and the value is an object reference for the job. Next, you define the job details for the file replication job in a <span class="FontName">Job Detail</span> object and prepare job data in its <span class="FontName">jobDataMap</span> property. Next, you create a <span class="FontName">SimpleTrigger</span> object to configure the scheduling properties. Finally, you create a scheduler to run your job using this trigger.</p>
<p class="indent">Quartz supports various types of schedules<a id="cXXX.1057" class="calibre5"></a> to run jobs at different intervals. Schedules are defined as part of triggers. In the most recent release Quartz schedules are: <span class="FontName">SimpleScheduleBuilder</span>, <span class="FontName">CronScheduleBuilder</span>, <span class="FontName">CalendarIntervalScheduleBuilder</span> and <span class="FontName">DailyTimeIntervalScheduleBuilder</span>. <span class="FontName">SimpleScheduleBuilder</span> allows you to schedule jobs setting properties such as start time, end time, repeat interval, and repeat count. <span class="FontName">CronScheduleBuilder</span> accepts a Unix cron expression for you to specify the times to run your job. For example, you can replace the preceding <span class="FontName">SimpleScheduleBuilder</span> with the following <span class="FontName">CronScheduleBuilder</span> to run a job at 17:30 every day:</p>
<pre class="calibre11"><span class="FontName">.withSchedule(CronScheduleBuilder.cronSchedule(" 0 30 17 * * ?"))</span></pre>
<p class="indent">A cron expression is made up of seven fields (the last field is optional), separated by spaces. <a id="_Tab1" href="part0024.html#Tab1" class="calibre5">Table 14-1</a> shows the field description for a cron expression.</p>
<div class="Table" id="Tab1"><p class="TabCapt"><span class="calibre4"><a href="part0024.html#_Tab1" class="calibre5">Table 14-1</a>.</span> Field Description for a Cron Expression<a id="cXXX.1058" class="calibre5"></a></p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14"><p class="tab-left">Position</p></th><th valign="top" class="calibre14"><p class="tab-left">Field Name</p></th><th valign="top" class="calibre14"><p class="tab-left">Range</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">1</p></td><td valign="top" class="calibre16"><p class="tab-leftt">Second</p></td><td valign="top" class="calibre16"><p class="tab-leftt">0–59</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">2</p></td><td valign="top" class="calibre16"><p class="tab-leftt">Minute</p></td><td valign="top" class="calibre16"><p class="tab-leftt">0–59</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">3</p></td><td valign="top" class="calibre16"><p class="tab-leftt">Hour</p></td><td valign="top" class="calibre16"><p class="tab-leftt">0–23</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">4</p></td><td valign="top" class="calibre16"><p class="tab-leftt">Day of month</p></td><td valign="top" class="calibre16"><p class="tab-leftt">1–31</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">5</p></td><td valign="top" class="calibre16"><p class="tab-leftt">Month</p></td><td valign="top" class="calibre16"><p class="tab-leftt">1–12 or JAN–DEC</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">6</p></td><td valign="top" class="calibre16"><p class="tab-leftt">Day of week</p></td><td valign="top" class="calibre16"><p class="tab-leftt">1–7 or SUN–SAT</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">7</p></td><td valign="top" class="calibre16"><p class="tab-leftt">Year (optional)</p></td><td valign="top" class="calibre16"><p class="tab-leftt">1970–2099</p></td></tr></tbody></table>
</div>
<p class="indent">Each part of a cron expression can be assigned a specific value (e.g., 3), a range (e.g., 1–5), a list (e.g., 1,3,5), a wildcard (* matches all values), or a question mark (? is used in either of the “Day of month” and “Day of week” fields for matching one of these fields but not both).</p>
<p class="indent"><span class="FontName">CalendarIntervalScheduleBuilder</span> allows you to schedule jobs based on calendar times (day, week, month, year), whereas the <span class="FontName">DailyTimeIntervalScheduleBuilder</span> provides convenience utilities to set a job’s end time (e.g., methods like <span class="FontName">endingDailyAt() &amp; endingDailyAfterCount()</span>)</p>
<p id="Sec36" class="Heading2">Use Quartz with Spring’s Support</p>
<p class="noindent">When using Quartz, you can create a job by implementing the Job interface and retrieve job data from the job data map through <span class="FontName">JobExecutionContext</span>. To decouple your job class from the Quartz API, Spring<a id="cXXX.1059" class="calibre5"></a> provides <span class="FontName">QuartzJobBean</span>, which you can extend to retrieve job data through setter methods. <span class="FontName">QuartzJobBean</span> converts the job data map into properties and injects them via the setter methods.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.quartz.JobExecutionContext;</span><br class="calibre10"/><span class="FontName">import org.quartz.JobExecutionException;</span><br class="calibre10"/><span class="FontName">import org.springframework.scheduling.quartz.QuartzJobBean;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class FileReplicationJob extends QuartzJobBean {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private FileReplicator fileReplicator;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setFileReplicator(FileReplicator fileReplicator) {</span><br class="calibre10"/>        <span class="FontName">this.fileReplicator = fileReplicator;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">protected void executeInternal(JobExecutionContext context)</span><br class="calibre10"/>            <span class="FontName">throws JobExecutionException {</span><br class="calibre10"/>        <span class="FontName">try {</span><br class="calibre10"/>            <span class="FontName">fileReplicator.replicate();</span><br class="calibre10"/>        <span class="FontName">} catch (IOException e) {</span><br class="calibre10"/>            <span class="FontName">throw new JobExecutionException(e);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Then, you can configure a Quartz JobDetail object in Spring’s bean configuration file through <span class="FontName">JobDetailBean</span>. By default, Spring uses this bean’s name as the job name. You can modify it by setting the <span class="FontName">name</span> property.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">@Autowired</span><br class="calibre10"/><span class="FontName">public JobDetailFactoryBean documentReplicationJob(FileReplicator fileReplicator) {</span><br class="calibre10"/>    <span class="FontName">JobDetailFactoryBean documentReplicationJob = new JobDetailFactoryBean();</span><br class="calibre10"/>    <span class="FontName">documentReplicationJob.setJobClass(FileReplicationJob.class);</span><br class="calibre10"/>    <span class="FontName">documentReplicationJob.setDurability(true);</span><br class="calibre10"/>    <span class="FontName">documentReplicationJob.setJobDataAsMap(Collections.singletonMap("fileReplicator", fileReplicator));</span><br class="calibre10"/>    <span class="FontName">return documentReplicationJob;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Spring also offers <span class="FontName">MethodInvokingJobDetailFactoryBean</span> for you to define a job that executes a single method of a particular object. This saves you the trouble of creating a job class. You can use the following job detail to replace the previous:</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">@Autowired</span><br class="calibre10"/><span class="FontName">public MethodInvokingJobDetailFactoryBean documentReplicationJob(FileReplicator fileReplicator) {</span><br class="calibre10"/>    <span class="FontName">MethodInvokingJobDetailFactoryBean documentReplicationJob =</span><br class="calibre10"/>    <span class="FontName">new MethodInvokingJobDetailFactoryBean();</span><br class="calibre10"/>    <span class="FontName">documentReplicationJob.setTargetObject(fileReplicator);</span><br class="calibre10"/>    <span class="FontName">documentReplicationJob.setTargetMethod("replicatie");</span><br class="calibre10"/>    <span class="FontName">return documentReplicationJob;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Once you define a job , you can configure a Quartz Trigger. Spring supports the <span class="FontName">SimpleTriggerFactoryBean</span> and the <span class="FontName">CronTriggerFactoryBean</span>. The <span class="FontName">SimpleTriggerFactoryBean</span>, requires a reference to a <span class="FontName">JobDetail</span> object and provides common values for schedule properties, such as start time and repeat count.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">@Autowired</span><br class="calibre10"/><span class="FontName">public SimpleTriggerFactoryBean documentReplicationTrigger(JobDetail documentReplicationJob) {</span><br class="calibre10"/>    <span class="FontName">SimpleTriggerFactoryBean documentReplicationTrigger = new SimpleTriggerFactoryBean();</span><br class="calibre10"/>    <span class="FontName">documentReplicationTrigger.setJobDetail(documentReplicationJob);</span><br class="calibre10"/>    <span class="FontName">documentReplicationTrigger.setStartDelay(5000);</span><br class="calibre10"/>    <span class="FontName">documentReplicationTrigger.setRepeatInterval(60000);</span><br class="calibre10"/>    <span class="FontName">return documentReplicationTrigger;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You can also use the <span class="FontName">CronTriggerFactoryBean</span> to configure a cron like schedule.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">@Autowired</span><br class="calibre10"/><span class="FontName">public CronTriggerFactoryBean documentReplicationTrigger(JobDetail documentReplicationJob) {</span><br class="calibre10"/>    <span class="FontName">CronTriggerFactoryBean documentReplicationTrigger = new CronTriggerFactoryBean();</span><br class="calibre10"/>    <span class="FontName">documentReplicationTrigger.setJobDetail(documentReplicationJob);</span><br class="calibre10"/>    <span class="FontName">documentReplicationTrigger.setStartDelay(5000);</span><br class="calibre10"/>    <span class="FontName">documentReplicationTrigger.setCronExpression("0/60 * * * * ?");</span><br class="calibre10"/>    <span class="FontName">return documentReplicationTrigger;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Finally, you once you have the Quartz job and trigger, you can configure a <span class="FontName">SchedulerFactoryBean</span> instance to create a Scheduler object for running your trigger. You can specify multiple triggers in this factory bean.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">@Autowired</span><br class="calibre10"/><span class="FontName">public SchedulerFactoryBean scheduler(Trigger[] triggers) {</span><br class="calibre10"/>    <span class="FontName">SchedulerFactoryBean scheduler = new SchedulerFactoryBean();</span><br class="calibre10"/>    <span class="FontName">scheduler.setTriggers(triggers);</span><br class="calibre10"/>    <span class="FontName">return scheduler;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now, you can simply start your scheduler with the following Main class. In this way, you don’t require a single line of code for scheduling jobs.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Main {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) throws Exception {</span><br class="calibre10"/>        <span class="FontName">new AnnotationConfigApplicationContext("com.apress.springrecipes.replicator.config");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec37" class="Heading">14-6. Schedule tasks with Spring’s Scheduling<a id="cXXX.2173" class="calibre6"></a><a id="cXXX.1060" class="calibre6"></a></p>
<p id="Sec38" class="Heading1">Problem</p>
<p class="noindent">You want to schedule a method invocation in a consistent manner, using either a cron expression, an interval, or a rate, and you don’t want to have to go through Quartz just to do it.</p>
<p id="Sec39" class="Heading1">Solution</p>
<p class="noindent">Spring has support to configure <span class="FontName">TaskExecutor</span>s and <span class="FontName">TaskScheduler</span>s. This capability, coupled with the ability to schedule method execution using the <span class="FontName">@Scheduled</span> annotation, makes Spring scheduling support work with a minimum of fuss: all you need are a method, an annotation, and to have switched on the scanner for annotations.</p>
<p id="Sec40" class="Heading1">How It Works</p>
<p class="noindent">Let’s revisit the example in the last recipe: we want to schedule a call to the replication method on the bean using a cron expression. Our configuration class looks like the following:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.scheduling.annotation.EnableScheduling;</span><br class="calibre10"/><span class="FontName">import org.springframework.scheduling.annotation.SchedulingConfigurer;</span><br class="calibre10"/><span class="FontName">import org.springframework.scheduling.config.ScheduledTaskRegistrar;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.concurrent.Executor;</span><br class="calibre10"/><span class="FontName">import java.util.concurrent.Executors;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableScheduling</span><br class="calibre10"/><span class="FontName">public class SchedulingConfiguration implements SchedulingConfigurer {</span><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void configureTasks(ScheduledTaskRegistrar taskRegistrar) {</span><br class="calibre10"/>        <span class="FontName">taskRegistrar.setScheduler(scheduler());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <br class="calibre10"/>    <span class="FontName">@Bean(destroyMethod = "shutdown")</span><br class="calibre10"/>    <span class="FontName">public Executor scheduler() {</span><br class="calibre10"/>        <span class="FontName">return Executors.newScheduledThreadPool(10);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">We enable the annotation driven scheduling support by specifying <span class="FontName">@EnableScheduling</span>., this will register a bean which scans the beans in the application context for the <span class="FontName">@Scheduled</span> annotation. We also implemented the interface SchedulingConfigurer as we wanted to do some additional configuration of our scheduler. We want to give it a pool of 10 threads to execute our scheduled tasks.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.replicator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.scheduling.annotation.Scheduled;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.io.File;</span><br class="calibre10"/><span class="FontName">import java.io.IOException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class FileReplicatorImpl implements FileReplicator {</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Scheduled(fixedDelay = 60 * 1000)</b><br class="calibre10"/>    <span class="FontName">public synchronized void replicate() throws IOException {</span><br class="calibre10"/>        <span class="FontName">File[] files = new File(srcDir).listFiles();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">for (File file : files) {</span><br class="calibre10"/>            <span class="FontName">if (file.isFile()) {</span><br class="calibre10"/>                <span class="FontName">fileCopier.copyFile(srcDir, destDir, file.getName());</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Note that we’ve annotated the <span class="FontName">replicate()</span> method with a <span class="FontName">@Scheduled</span> annotation. Here, we’ve told the scheduler to execute the method every 60 seconds. Alternatively, we might specify a <span class="FontName">fixedRate</span> value for the <span class="FontName">@Scheduled</span> annotation, which would measure the time between successive starts and then trigger another run.</p>
<pre class="calibre11"><b class="calibre4">@Scheduled(fixedRate = 60 * 1000)</b><br class="calibre10"/><span class="FontName">public synchronized void replicate() throws IOException {</span><br class="calibre10"/>    <span class="FontName">File[] files = new File(srcDir).listFiles();</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">for (File file : files) {</span><br class="calibre10"/>        <span class="FontName">if (file.isFile()) {</span><br class="calibre10"/>            <span class="FontName">fileCopier.copyFile(srcDir, destDir, file.getName());</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Finally, we might want more complex control over the execution of the method. In this case, we can use a cron expression, just as we did in the Quartz example.</p>
<pre class="calibre11"><b class="calibre4">@Scheduled( cron = "0/60 * * * * ? " )</b><br class="calibre10"/><span class="FontName">public synchronized void replicate() throws IOException {</span><br class="calibre10"/>    <span class="FontName">File[] files = new File(srcDir).listFiles();</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">for (File file : files) {</span><br class="calibre10"/>        <span class="FontName">if (file.isFile()) {</span><br class="calibre10"/>            <span class="FontName">fileCopier.copyFile(srcDir, destDir, file.getName());</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">There is support for configuring all of this in the Java too. This might be useful if you didn’t want to, or couldn’t, add an annotation to an existing bean method. Here’s a look at how we might re-create the preceding annotation-centric examples using the Spring <span class="FontName">ScheduledTaskRegistrar</span>.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableScheduling</span><br class="calibre10"/><span class="FontName">public class SchedulingConfiguration implements SchedulingConfigurer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">private FileReplicator fileReplicator;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void configureTasks(ScheduledTaskRegistrar taskRegistrar) {</span><br class="calibre10"/>        <span class="FontName">taskRegistrar.setScheduler(scheduler();</span><br class="calibre10"/>        <b class="calibre4">taskRegistrar.addFixedDelayTask(new Runnable(){</b><br class="calibre10"/>            <b class="calibre4">@Override</b><br class="calibre10"/>            <b class="calibre4">public void run() {</b><br class="calibre10"/>                <b class="calibre4">try {</b><br class="calibre10"/>                    <b class="calibre4">fileReplicator.replicate();</b><br class="calibre10"/>                <b class="calibre4">} catch (IOException e) {</b><br class="calibre10"/>                    <b class="calibre4">e.printStackTrace();</b><br class="calibre10"/>                <b class="calibre4">}</b><br class="calibre10"/>            <b class="calibre4">}</b><br class="calibre10"/>        <b class="calibre4">}, 60000);</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean(destroyMethod = "shutdown")</span><br class="calibre10"/>    <span class="FontName">public Executor scheduler() {</span><br class="calibre10"/>        <span class="FontName">return Executors.newScheduledThreadPool(10);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec41" class="Heading">14-7. Expose and Invoke Services through RMI</p>
<p id="Sec42" class="Heading1">Problem</p>
<p class="noindent">You want to expose a service from your Java application for other Java-based clients to invoke remotely. Because both parties are running on the Java platform, you can choose a pure Java-based solution without considering cross-platform portability.</p>
<p id="Sec43" class="Heading1">Solution</p>
<p class="noindent">Remote Method Invocation (RMI) is a Java-based remoting technology<a id="cXXX.1061" class="calibre5"></a><a id="cXXX.2147" class="calibre5"></a> that allows two Java applications running in different JVMs to communicate with each other. With RMI, an object can invoke the methods of a remote object. RMI relies on object serialization to marshal and unmarshal method arguments and return values.</p>
<p class="indent">To expose a service through RMI, you have to create the service interface that extends <span class="FontName">java.rmi.Remote</span> and whose methods declare throwing java.rmi.RemoteException. Then, you create the service implementation for this interface. After that, you start an RMI registry and register your service to it. So there are quite a lot of steps required for exposing a simple service.</p>
<p class="indent">To invoke a service through RMI, you first look up the remote service reference in an RMI registry, and then, you can call the methods on it. However, to call the methods on a remote service, you must handle java.rmi.RemoteException in case any exception is thrown by the remote service.</p>
<p class="indent">Spring’s remoting facilities<a id="cXXX.1062" class="calibre5"></a> can significantly simplify the RMI usage on both the server and client sides. On the server side, you can use <span class="FontName">RmiServiceExporter</span> to export a Spring POJO as an RMI service whose methods can be invoked remotely. It’s just several lines of bean configuration without any programming. Beans exported in this way don’t need to implement java.rmi.Remote or throw <span class="FontName">java.rmi.RemoteException</span>. On the client side, you can simply use <span class="FontName">RmiProxyFactoryBean</span> to create a proxy for the remote service. It allows you to use the remote service as if it were a local bean. Again, it requires no additional programming at all.</p>
<p id="Sec44" class="Heading1">How It Works</p>
<p class="noindent">Suppose you’re going to build a weather web service for clients running on different platforms. This service includes an operation for querying a city’s temperatures on multiple dates. First, let’s create the TemperatureInfo class representing the minimum, maximum, and average temperatures of a particular city and date.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class TemperatureInfo implements Serializable {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String city;</span><br class="calibre10"/>    <span class="FontName">private Date date;</span><br class="calibre10"/>    <span class="FontName">private double min;</span><br class="calibre10"/>    <span class="FontName">private double max;</span><br class="calibre10"/>    <span class="FontName">private double average;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Constructors, Getters and Setters</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Next, let’s define the service interface that includes the <span class="FontName">getTemperatures()</span> operation, which returns a city’s temperatures on multiple dates.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public interface WeatherService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public List&lt;TemperatureInfo&gt; getTemperatures(String city, List&lt;Date&gt; dates);</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You have to provide an implementation for this interface. In a production application<a id="cXXX.1063" class="calibre5"></a>, you would implement this service interface by querying the database. Here, we’ll hard-code the temperatures for testing purposes.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class WeatherServiceImpl implements WeatherService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public List&lt;TemperatureInfo&gt; getTemperatures(String city, List&lt;Date&gt; dates) {</span><br class="calibre10"/>        <span class="FontName">List&lt;TemperatureInfo&gt; temperatures = new ArrayList&lt;TemperatureInfo&gt;();</span><br class="calibre10"/>        <span class="FontName">for (Date date : dates) {</span><br class="calibre10"/>            <span class="FontName">temperatures.add(new TemperatureInfo(city, date, 5.0, 10.0, 8.0));</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">return temperatures;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec45" class="Heading2">Expose an RMI Service</p>
<p class="noindent">Next, let’s expose the weather service as an RMI service. To use Spring’s remoting facilities, we’ll create a Java Config class to create the necessary beans and export the weather service<a id="cXXX.1064" class="calibre5"></a> as an RMI service by using <span class="FontName">RmiServiceExporter</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.weather.WeatherService;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.weather.WeatherServiceImpl;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.remoting.rmi.RmiServiceExporter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class WeatherConfig {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public WeatherService weatherService() {</span><br class="calibre10"/>        <span class="FontName">WeatherService wService = new WeatherServiceImpl();</span><br class="calibre10"/>        <span class="FontName">return wService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public RmiServiceExporter rmiService() {</span><br class="calibre10"/>        <span class="FontName">RmiServiceExporter rmiService = new RmiServiceExporter();</span><br class="calibre10"/>        <span class="FontName">rmiService.setServiceName("WeatherService");</span><br class="calibre10"/>        <span class="FontName">rmiService.setServiceInterface(com.apress.springrecipes.weather.WeatherService.class);</span><br class="calibre10"/>        <span class="FontName">rmiService.setService(weatherService());</span><br class="calibre10"/>        <span class="FontName">return rmiService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">There are several properties you must configure for an <span class="FontName">RmiServiceExporter</span> instance, including the service name, the service interface, and the service object to export. You can export any bean configured in the IoC container as an RMI service. <span class="FontName">RmiServiceExporter</span> will create an RMI proxy to wrap this bean and bind it to the RMI registry. When the proxy receives an invocation request from the RMI registry, it will invoke the corresponding method on the bean.</p>
<p class="indent">By default, <span class="FontName">RmiServiceExporter</span> attempts to look up an RMI registry at localhost port 1099. If it can’t find the RMI registry, it will start a new one. However, if you want to bind your service to another running RMI registry, you can specify the host and port of that registry in the <span class="FontName">registryHost</span> and <span class="FontName">registryPort</span> properties. Note that once you specify the registry host, <span class="FontName">RmiServiceExporter</span> will not start a new registry, even if the specified registry doesn’t exist.</p>
<p class="indent">Run the following RmiServer class to create an application context:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.support.GenericXmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class RmiServer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">new AnnotationConfigApplicationContext("com.apress.springrecipes.weather.config");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In this configuration, the server will launch; among the output, you should see a message indicating that an existing RMI registry could not be found.</p>
<p id="Sec46" class="Heading2">Invoke an RMI Service</p>
<p class="noindent">By using Spring’s remoting facilities, you can invoke a remote service just like a local bean. For example, you can create a client that refers to the weather service by its interface.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class WeatherServiceClient {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">private WeatherService weatherService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setWeatherService(WeatherService weatherService) {</span><br class="calibre10"/>        <span class="FontName">this.weatherService = weatherService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public TemperatureInfo getTodayTemperature(String city) {</span><br class="calibre10"/>        <span class="FontName">List&lt;Date&gt; dates = Arrays.asList(new Date[] { new Date() });</span><br class="calibre10"/>        <span class="FontName">List&lt;TemperatureInfo&gt; temperatures =</span><br class="calibre10"/>            <span class="FontName">weatherService.getTemperatures(city, dates);</span><br class="calibre10"/>        <span class="FontName">return temperatures.get(0);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice the <span class="FontName">weatherService</span> field is marked as <span class="FontName">@Autowired</span>, so we’ll need to create an instance of this bean. The <span class="FontName">weatherService</span> will use <span class="FontName">RmiProxyFactoryBean</span> to create a proxy for the remote service. Then, you can use this service as if it were a local bean. The following<a id="cXXX.1065" class="calibre5"></a> Java Config class illustrates the necessary beans for the RMI client:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.remoting.rmi.RmiProxyFactoryBean;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.weather.WeatherServiceClient;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.weather.WeatherService;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class WeatherConfigClient {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public RmiProxyFactoryBean weatherService() {</span><br class="calibre10"/>        <span class="FontName">RmiProxyFactoryBean rmiProxy = new RmiProxyFactoryBean();</span><br class="calibre10"/>        <span class="FontName">rmiProxy.setServiceUrl("rmi://localhost:1099/WeatherService");</span><br class="calibre10"/>        <span class="FontName">rmiProxy.setServiceInterface(com.apress.springrecipes.weather.WeatherService.class);</span><br class="calibre10"/>        <span class="FontName">return rmiProxy;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public WeatherServiceClient weatherClient() {</span><br class="calibre10"/>        <span class="FontName">WeatherServiceClient wServiceClient = new WeatherServiceClient();</span><br class="calibre10"/>        <span class="FontName">return wServiceClient;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">There are two properties you must configure for an <span class="FontName">RmiProxyFactoryBean</span> instance. The service URL property<a id="cXXX.1066" class="calibre5"></a> specifies the host and port of the RMI registry, as well as the service name. The service interface allows this factory bean to create a proxy for the remote service against a known, shared Java interface. The proxy will transfer the invocation requests to the remote service transparently. In addition to the <span class="FontName">RmiProxyFactoryBean</span> instance, we also create an instance of the <span class="FontName">WeatherServiceClient</span> called <span class="FontName">weatherClient</span>.</p>
<p class="indent">To start the client, simply create a configuration file to scan the Java Config class.</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:context="</span><span class="FontName"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans-3.2.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/context/spring-context-3.2.xsd" class="calibre5">http://www.springframework.org/schema/context/spring-context-3.2.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;context:component-scan base-package="com.apress.springrecipes.weather.config" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">And next, run the following RmiClient main class:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.GenericXmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class RmiClient {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">ApplicationContext context =</span><br class="calibre10"/>            <span class="FontName">new GenericXmlApplicationContext("appContext.xml");</span><br class="calibre10"/>        <span class="FontName">WeatherServiceClient client =</span><br class="calibre10"/>            <span class="FontName">(WeatherServiceClient) context.getBean("weatherClient");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">TemperatureInfo temperature = client.getTodayTemperature("Houston");</span><br class="calibre10"/>        <span class="FontName">System.out.println("Min temperature : " + temperature.getMin());</span><br class="calibre10"/>        <span class="FontName">System.out.println("Max temperature : " + temperature.getMax());</span><br class="calibre10"/>        <span class="FontName">System.out.println("Average temperature : " + temperature.getAverage());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec47" class="Heading">14-8. Expose and Invoke Services through HTTP</p>
<p id="Sec48" class="Heading1">Problem</p>
<p class="noindent">RMI communicates through its own protocol, which may not pass through firewalls. Ideally, you’d like to communicate over HTTP.</p>
<p id="Sec49" class="Heading1">Solution</p>
<p class="noindent">Hessian and Burlap are two simple lightweight remoting technologies developed by Caucho Technology (<span class="FontName"><a href="http://www.caucho.com/" class="calibre5">http://www.caucho.com/</a></span>). They both communicate using proprietary messages over HTTP and have their own serialization mechanism, but they are much simpler than RMI. The only difference between Hessian and Burlap is that Hessian communicates using binary messages, and Burlap communicates using XML messages. The message formats of both Hessian and Burlap are also supported on other platforms besides Java, such as PHP, Python, C#, and Ruby. This allows your Java applications to communicate with applications running on the other platforms.</p>
<p class="indent">In addition to the preceding two technologies, the Spring framework itself also offers a remoting technology<a id="cXXX.1067" class="calibre5"></a> called HTTP Invoker. It also communicates over HTTP, but uses Java’s object serialization mechanism to serialize objects. Unlike Hessian and Burlap, HTTP Invoker requires both sides of a service to be running on the Java platform and using the Spring framework. However, it can serialize all kinds of Java objects, some of which may not be serialized by Hessian/Burlap’s proprietary mechanism.</p>
<p class="indent">Spring’s remoting facilities are consistent in exposing and invoking remote services with these technologies. On the server side, you can create a service exporter such as <span class="FontName">HessianServiceExporter</span>, <span class="FontName">BurlapServiceExporter</span>, or <span class="FontName">HttpInvokerServiceExporter</span> to export a Spring bean as a remote service whose methods can be invoked remotely. It’s just a few lines of bean configurations without any programming. On the client side, you can also configure a proxy factory bean such as <span class="FontName">HessianProxyFactoryBean</span>, <span class="FontName">BurlapProxyFactoryBean</span>, or <span class="FontName">HttpInvokerProxyFactoryBean</span> to create a proxy for a remote service. It allows you to use the remote service as if it were a local bean. Again, it requires no additional programming at all.</p>
<p id="Sec50" class="Heading1">How It Works</p>
<p id="Sec51" class="Heading2">Expose a Hessian Service<a id="cXXX.1068" class="calibre6"></a></p>
<p class="noindent">We’ll use the same weather service from the previous RMI recipe and expose it as a Hessian service with Spring. We’ll create a simple web application using Spring MVC to deploy the service. First, let’s create an Initializer class to bootstrap the web application<a id="cXXX.1069" class="calibre5"></a> and Spring application context.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.web.WebApplicationInitializer;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.support.AnnotationConfigWebApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.DispatcherServlet;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.ServletContext;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletException;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletRegistration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Initializer implements WebApplicationInitializer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void onStartup(ServletContext container)</span><br class="calibre10"/>            <span class="FontName">throws ServletException {</span><br class="calibre10"/>        <span class="FontName">AnnotationConfigWebApplicationContext context = new AnnotationConfigWebApplicationContext();</span><br class="calibre10"/>        <span class="FontName">context.scan("com.apress.springrecipes.weather.config");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ServletRegistration.Dynamic dispatcher =</span><br class="calibre10"/>        <span class="FontName">container.addServlet("dispatcher", new DispatcherServlet(context));</span><br class="calibre10"/>        <span class="FontName">dispatcher.setLoadOnStartup(1);</span><br class="calibre10"/>        <span class="FontName">dispatcher.addMapping("/*");</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">Initializer</span> class defines a <span class="FontName">DispatcherServlet</span> to map all URLs under the root path (/*). Note the servlet instance is initialized with the Spring application context. The Spring application context scans the <span class="FontName">com.apress.springrecipes.weather.config</span> package for <span class="FontName">@Configuration</span> classes.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.weather.WeatherService;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.weather.WeatherServiceImpl;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.remoting.caucho.HessianServiceExporter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class WeatherConfigHessianServer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public WeatherService weatherService() {</span><br class="calibre10"/>        <span class="FontName">WeatherService wService = new WeatherServiceImpl();</span><br class="calibre10"/>        <span class="FontName">return wService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean(name = "/weather")</span><br class="calibre10"/>    <span class="FontName">public HessianServiceExporter exporter() {</span><br class="calibre10"/>        <span class="FontName">HessianServiceExporter exporter = new HessianServiceExporter();</span><br class="calibre10"/>        <span class="FontName">exporter.setService(weatherService());</span><br class="calibre10"/>        <span class="FontName">exporter.setServiceInterface(WeatherService.class);</span><br class="calibre10"/>        <span class="FontName">return exporter;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The scanning component allows Spring to inspect a Java Config class that instantiates the <span class="FontName">weatherService</span> bean, which contains the operations that are to be exposed by the <span class="FontName">HessianServiceExporter</span>. The <span class="FontName">weatherService</span> bean in this case is identical to the one used in the previous RMI recipe. You can also consult the book’s source code to get the pre-built application.</p>
<p class="indent">For a <span class="FontName">HessianServiceExporter</span> instance, you have to configure a service object to export and its service interface. You can export any Spring bean as a Hessian service,<a id="cXXX.2054" class="calibre5"></a> and <span class="FontName">HessianServiceExporter</span> creates a proxy to wrap this bean. When the proxy receives an invocation request, it invokes the corresponding method on that bean. By default, <span class="FontName">BeanNameUrlHandlerMapping</span> is preconfigured for Spring MVC applications<a id="cXXX.1070" class="calibre5"></a>, so this means beans are mapped to URL patterns specified as bean names. The preceding configuration maps the URL pattern /weather to this exporter.</p>
<p class="indent">Next, you can deploy this web application to a web container<a id="cXXX.1071" class="calibre5"></a> (e.g., Apache Tomcat 7.0). By default, Tomcat listens on port 8080, so if you deploy your application to the hessian context path, you can access this service with the following URL:</p>
<pre class="calibre11"><span class="FontName">http://localhost:8080/hessian/weather</span></pre>
<p id="Sec52" class="Heading2">Invoke a Hessian Service</p>
<p class="noindent">By using Spring’s remoting facilities, you can invoke a remote service just like a local bean. In a client application you can create a HessianProxyFactoryBean instance<a id="cXXX.1072" class="calibre5"></a> in a Java config class to create a proxy for the remote Hessian service. Then you can use this service as if it were a local bean.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public HessianProxyFactoryBean weatherService() {</span><br class="calibre10"/>    <span class="FontName">HessianProxyFactoryBean factory = new HessianProxyFactoryBean();</span><br class="calibre10"/>    <span class="FontName">factory.setServiceUrl("</span><span class="FontName">http://localhost:8080/hessian/weather</span><span class="FontName">");</span><br class="calibre10"/>    <span class="FontName">factory.setServiceInterface(WeatherService.class);</span><br class="calibre10"/>    <span class="FontName">return factory;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">For a <span class="FontName">HessianProxyFactoryBean</span> instance you have to configure two properties. The service URL property specifies the URL for the target service. The service interface property is for this factory bean to create a local proxy for the remote service. The proxy will send the invocation requests to the remote service transparently.</p>
<p id="Sec53" class="Heading2">Expose a Burlap Service<a id="cXXX.1073" class="calibre6"></a></p>
<p class="noindent">The configuration for exposing a Burlap service<a id="cXXX.1074" class="calibre5"></a> is similar to that for Hessian, except you should use <span class="FontName">BurlapServiceExporter</span> instead.</p>
<pre class="calibre11"><span class="FontName">@Bean(name = "/weather")</span><br class="calibre10"/><span class="FontName">public BurlapServiceExporter exporter() {</span><br class="calibre10"/>    <span class="FontName">BurlapServiceExporter exporter = new BurlapServiceExporter();</span><br class="calibre10"/>    <span class="FontName">exporter.setService(weatherService());</span><br class="calibre10"/>    <span class="FontName">exporter.setServiceInterface(WeatherService.class);</span><br class="calibre10"/>    <span class="FontName">return exporter;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec54" class="Heading2">Invoke a Burlap Service</p>
<p class="noindent">Invoking a Burlap service is very similar to Hessian. The only difference is that you should use <span class="FontName">BurlapProxyFactoryBean</span>.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public BurlapProxyFactoryBean weatherService() {</span><br class="calibre10"/>    <span class="FontName">BurlapProxyFactoryBean factory = new BurlapProxyFactoryBean();</span><br class="calibre10"/>    <span class="FontName">factory.setServiceUrl("</span><span class="FontName">http://localhost:8080/burlap/weather</span><span class="FontName">");</span><br class="calibre10"/>    <span class="FontName">factory.setServiceInterface(WeatherService.class);</span><br class="calibre10"/>    <span class="FontName">return factory;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec55" class="Heading2">Expose an HTTP Invoker Service<a id="cXXX.1075" class="calibre6"></a></p>
<p class="noindent">Similarly, the configuration for exposing a service using HTTP Invoker is similar to that of Hessian and Burlap, except you have to use <span class="FontName">HttpInvokerServiceExporter</span> instead.</p>
<pre class="calibre11"><span class="FontName">@Bean(name = "/weather")</span><br class="calibre10"/><span class="FontName">public HttpInvokerServiceExporter exporter() {</span><br class="calibre10"/>    <span class="FontName">HttpInvokerServiceExporter exporter = new HttpInvokerServiceExporter();</span><br class="calibre10"/>    <span class="FontName">exporter.setService(weatherService());</span><br class="calibre10"/>    <span class="FontName">exporter.setServiceInterface(WeatherService.class);</span><br class="calibre10"/>    <span class="FontName">return exporter;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec56" class="Heading2">Invoke an HTTP Invoker Service</p>
<p class="noindent">Invoking a service exposed by HTTP Invoker is also similar to Hessian and Burlap. This time, you have to use <span class="FontName">HttpInvokerProxyFactoryBean</span>.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public HttpInvokerProxyFactoryBean weatherService() {</span><br class="calibre10"/>    <span class="FontName">HttpInvokerProxyFactoryBean factory = new HttpInvokerProxyFactoryBean();</span><br class="calibre10"/>    <span class="FontName">factory.setServiceUrl("</span><span class="FontName">http://localhost:8080/httpinvoker/weather</span><span class="FontName">");</span><br class="calibre10"/>    <span class="FontName">factory.setServiceInterface(WeatherService.class);</span><br class="calibre10"/>    <span class="FontName">return factory</span><span class="FontName">;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec57" class="Heading">14-9. Expose and invoke SOAP Web Services with JAX-WS</p>
<p id="Sec58" class="Heading1">Problem</p>
<p class="noindent">SOAP is an enterprise standard and cross-platform application communication technology. Most modern and mission critical software remoting tasks (e.g., banking services, inventory applications) typically use this standard. You want to be able to invoke third-party SOAP web services from your Java applications, as well as expose web services from your Java applications so third parties on different platforms can invoke them via SOAP.</p>
<p id="Sec59" class="Heading1">Solution</p>
<p class="noindent">Use JAX-WS <span class="FontName">@WebService</span> and <span class="FontName">@WebMethod</span> annotations, as well as Spring’s <span class="FontName">SimpleJaxWsServiceExporter</span> to allows access to bean business logic via SOAP. You can also leverage Apache CXF with Spring to expose SOAP services in a Java server like Tomcat. To access SOAP services you can use Apache CXF with Spring or leverage Spring’s <span class="FontName">JaxWsPortProxyFactoryBean</span>.</p>
<p id="Sec60" class="Heading1">How It Works</p>
<p class="noindent">JAX-WS 2.0 is the successor of JAX-RPC 1.1 — the Java API for XML-based Web services. So if you’re going to use SOAP in the context of Java, JAX-WS is the most recent standard which enjoys support in both Java EE and the standard JDK.</p>
<p id="Sec61" class="Heading2">Expose a Web Service Using the JAX-WS Endpoint Support in the JDK</p>
<p class="noindent">You can rely on Java’s JDK JAX-WS<a id="cXXX.1076" class="calibre5"></a><a id="cXXX.2180" class="calibre5"></a> runtime support to expose JAX-WS services. This means you don’t necessarily need to deploy JAX-WS services as part of a Java web application. By default, the JAX-WS support in the JDK is used if you have no other runtime. Let’s implement the weather service application from previous recipes with JAX-WS using the JDK.</p>
<p class="indent">We need to annotate the weather service to indicate that it should be exposed to clients. The revised WeatherServiceImpl needs to be decorated with <span class="FontName">@WebService</span> and <span class="FontName">@WebMethod</span> annotations. Where the main class is decorated with <span class="FontName">@WebService</span> and the method that will be exposed by the service is decorated with <span class="FontName">@WebMethod</span>.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.jws.WebMethod;</span><br class="calibre10"/><span class="FontName">import javax.jws.WebService;</span><br class="calibre10"/><span class="FontName">import java.util.ArrayList;</span><br class="calibre10"/><span class="FontName">import java.util.Date;</span><br class="calibre10"/><span class="FontName">import java.util.List;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@WebService(serviceName = "weather", endpointInterface = " com.apress.springrecipes.weather.WeatherService ")</span><br class="calibre10"/><span class="FontName">public class WeatherServiceImpl implements WeatherService {</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">@WebMethod(operationName = "getTemperatures")</span><br class="calibre10"/>        <span class="FontName">public List&lt;TemperatureInfo&gt; getTemperatures(String city, List&lt;Date&gt; dates) {</span><br class="calibre10"/>        <span class="FontName">List&lt;TemperatureInfo&gt; temperatures = new ArrayList&lt;TemperatureInfo&gt;();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">for (Date date : dates) {</span><br class="calibre10"/>            <span class="FontName">temperatures.add(new TemperatureInfo(city, date, 5.0, 10.0, 8.0));</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">return temperatures;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Note you don’t need to provide any parameters to the annotations, like <span class="FontName">endpointInterface</span> or <span class="FontName">serviceName</span>, but we do here for to make the resulting SOAP contract more readable. Similarly, you don’t need to provide an operationName on the <span class="FontName">@WebMethod</span> annotation. This is generally good practice anyway, because it insulates clients of the SOAP endpoint from any refactoring you may do on the Java implementation.</p>
<p class="indent">Next, so Spring is able to detect beans with <span class="FontName">@WebService</span> annotations we rely on Spring’s <span class="FontName">SimpleJaxWsServiceExporter</span>. This is an <span class="FontName">@Bean</span> definition of this class in a Java Config class.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public SimpleJaxWsServiceExporter jaxWsService() {</span><br class="calibre10"/>    <span class="FontName">SimpleJaxWsServiceExporter simpleJaxWs = new SimpleJaxWsServiceExporter();</span><br class="calibre10"/>    <span class="FontName">simpleJaxWs.setBaseAddress("</span><span class="FontName">http://localhost:8888/jaxws/</span><span class="FontName">");</span><br class="calibre10"/>    <span class="FontName">return simpleJaxWs;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice the bean definition calls <span class="FontName">setBaseAddress</span> and sets it <span class="FontName">to</span> <span class="FontName">http://localhost:8888/jaxws/</span>. This is the endpoint for the application’s JAX-WS service. Under this address — which is a standalone server spun by the JDK — is where all the beans defined with <span class="FontName">@WebService</span> annotations will reside. So if there’s a <span class="FontName">@Webservice</span> name called weather it will become accessible under <span class="FontName">http://localhost:8888/jaxws/</span><span class="FontName">weather</span>.</p>
<p class="indent">If you launch a browser and inspect the results at <span class="FontName">http://localhost:8888/jaxws/weather?wsdl</span>, you’ll see the generated SOAP WSDL contract, as follows:</p>
<pre class="calibre11"><span class="FontName">&lt;!--</span><br class="calibre10"/> <span class="FontName">Published by JAX-WS RI at</span> <span class="FontName"><a href="http://jax-ws.dev.java.net" class="calibre5">http://jax-ws.dev.java.net</a></span><span class="FontName">. RI's version is JAX-WS RI 2.2.4-b01.</span><br class="calibre10"/><span class="FontName">--&gt;</span><br class="calibre10"/><span class="FontName">&lt;!--</span><br class="calibre10"/> <span class="FontName">Generated by JAX-WS RI at</span> <span class="FontName"><a href="http://jax-ws.dev.java.net" class="calibre5">http://jax-ws.dev.java.net</a></span><span class="FontName">. RI's version is JAX-WS RI 2.2.4-b01.</span><br class="calibre10"/><span class="FontName">--&gt;</span><br class="calibre10"/><span class="FontName">&lt;definitions xmlns:wsu="</span><span class="FontName"><a href="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" class="calibre5">http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd</a></span><span class="FontName">" xmlns:wsp="</span><span class="FontName"><a href="http://www.w3.org/ns/ws-policy&quot;xmlns:wsp1_2=&quot;http://schemas.xmlsoap.org/ws/2004/09/policy" class="calibre5">http://www.w3.org/ns/ws-policy"xmlns:wsp1_2="http://schemas.xmlsoap.org/ws/2004/09/policy</a></span><span class="FontName">" xmlns:wsam="</span><span class="FontName"><a href="http://www.w3.org/2007/05/addressing/metadata&quot;xmlns:soap=&quot;http://schemas.xmlsoap.org/wsdl/soap/" class="calibre5">http://www.w3.org/2007/05/addressing/metadata"xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/</a></span><span class="FontName">" xmlns:tns="</span><span class="FontName"><a href="http://weather.springrecipes.apress.com/" class="calibre5">http://weather.springrecipes.apress.com/</a></span><span class="FontName">" xmlns:xsd="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema&quot; xmlns=&quot;http://schemas.xmlsoap.org/wsdl/" class="calibre5">http://www.w3.org/2001/XMLSchema" xmlns="http://schemas.xmlsoap.org/wsdl/</a></span><span class="FontName">" targetNamespace="</span><span class="FontName"><a href="http://weather.springrecipes.apress.com/" class="calibre5">http://weather.springrecipes.apress.com/</a></span><span class="FontName">" name="weather"&gt;</span><br class="calibre10"/><span class="FontName">&lt;types&gt;</span><br class="calibre10"/><span class="FontName">&lt;xsd:schema&gt;</span><br class="calibre10"/><span class="FontName">&lt;xsd:import namespace="</span><span class="FontName"><a href="http://weather.springrecipes.apress.com/" class="calibre5">http://weather.springrecipes.apress.com/</a></span><span class="FontName">" schemaLocation="</span><span class="FontName">http://localhost:8888/jaxws/weather?xsd=1</span><span class="FontName">"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/xsd:schema&gt;</span><br class="calibre10"/><span class="FontName">&lt;/types&gt;</span><br class="calibre10"/><span class="FontName">&lt;message name="getTemperatures"&gt;</span><br class="calibre10"/><span class="FontName">&lt;part name="parameters" element="tns:getTemperatures"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/message&gt;</span><br class="calibre10"/><span class="FontName">&lt;message name="getTemperaturesResponse"&gt;</span><br class="calibre10"/><span class="FontName">&lt;part name="parameters" element="tns:getTemperaturesResponse"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/message&gt;</span><br class="calibre10"/><span class="FontName">&lt;portType name="WeatherService"&gt;</span><br class="calibre10"/><span class="FontName">&lt;operation name="getTemperatures"&gt;</span><br class="calibre10"/><span class="FontName">&lt;input wsam:Action="</span><span class="FontName"><a href="http://weather.springrecipes.apress.com/WeatherService/getTemperaturesRequest" class="calibre5">http://weather.springrecipes.apress.com/WeatherService/getTemperaturesRequest</a></span><span class="FontName">" message="tns:getTemperatures"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;output wsam:Action="</span><span class="FontName"><a href="http://weather.springrecipes.apress.com/WeatherService/getTemperaturesResponse" class="calibre5">http://weather.springrecipes.apress.com/WeatherService/getTemperaturesResponse</a></span><span class="FontName">" message="tns:getTemperaturesResponse"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/operation&gt;</span><br class="calibre10"/><span class="FontName">&lt;/portType&gt;</span><br class="calibre10"/><span class="FontName">&lt;binding name="WeatherServiceImplPortBinding</span><span class="FontName">" type="tns:WeatherService"&gt;</span><br class="calibre10"/><span class="FontName">&lt;soap:binding transport="</span><span class="FontName"><a href="http://schemas.xmlsoap.org/soap/http" class="calibre5">http://schemas.xmlsoap.org/soap/http</a></span><span class="FontName">" style="document"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;operation name="getTemperatures"&gt;</span><br class="calibre10"/><span class="FontName">&lt;soap:operation soapAction=""/&gt;</span><br class="calibre10"/><span class="FontName">&lt;input&gt;</span><br class="calibre10"/><span class="FontName">&lt;soap:body use="literal"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/input&gt;</span><br class="calibre10"/><span class="FontName">&lt;output&gt;</span><br class="calibre10"/><span class="FontName">&lt;soap:body use="literal"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/output&gt;</span><br class="calibre10"/><span class="FontName">&lt;/operation&gt;</span><br class="calibre10"/><span class="FontName">&lt;/binding&gt;</span><br class="calibre10"/><span class="FontName">&lt;service name="weather"&gt;</span><br class="calibre10"/><span class="FontName">&lt;port name="WeatherServiceImplPort" binding="tns:WeatherServiceImplPortBinding"&gt;</span><br class="calibre10"/><span class="FontName">&lt;soap:address location="</span><span class="FontName">http://localhost:8888/jaxws/weather</span><span class="FontName">"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/port&gt;</span><br class="calibre10"/><span class="FontName">&lt;/service&gt;</span><br class="calibre10"/><span class="FontName">&lt;/definitions&gt;</span></pre>
<p class="indent">The SOAP WSDL contract is used by clients to access the service. If you inspect the generated WSDL you’ll see it’s pretty basic — describing the weather service method — but more importantly it’s programming language neutral. This neutrality is the whole purpose of SOAP, to be able to access services across diverse platforms that can interpret SOAP.</p>
<p id="Sec62" class="Heading2">Expose a Web Service Using CXF</p>
<p class="noindent">Exposing a stand-alone SOAP endpoint using the <span class="FontName">SimpleJaxWsServiceExporter</span> and the JAX-WS JDK support is simple. However, this solution ignores the fact that most Java applications in real-world environments operate on Java app runtimes, such as Tomcat. Tomcat by itself doesn’t support JAX-WS, so we’ll need to equip the application with a JAX-WS runtime.</p>
<p class="indent">There are many choices, and you’re free to take your pick. Two popular choices are Axis2 and CXF<a id="cXXX.1077" class="calibre5"></a>, both of which are Apache projects. For our example, we’ll embed CXF since it’s robust, fairly well tested, and provides support for other important standards like JAX-RS, the API for REST-ful endpoints.</p>
<p class="indent">First let’s take a look at the <span class="FontName">Initializer</span> class to bootstrap an application under a Servlet 3.0 compliant server like Apache Tomcat 7.0</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.web.WebApplicationInitializer;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.DispatcherServlet;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.context.ContextLoaderListener;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.web.context.support.XmlWebApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.apache.cxf.transport.servlet.CXFServlet;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.ServletRegistration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import javax.servlet.ServletContext;</span><br class="calibre10"/><span class="FontName">import javax.servlet.ServletException;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Initializer implements WebApplicationInitializer {</span><br class="calibre10"/>    <span class="FontName">public void onStartup(ServletContext container) throws ServletException {</span><br class="calibre10"/>        <span class="FontName">XmlWebApplicationContext context = new XmlWebApplicationContext();</span><br class="calibre10"/>        <span class="FontName">context.setConfigLocation("/WEB-INF/appContext.xml");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">container.addListener(new ContextLoaderListener(context));</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">ServletRegistration.Dynamic cxf = container.addServlet("cxf", new CXFServlet());</span><br class="calibre10"/>        <span class="FontName">cxf.setLoadOnStartup(1);</span><br class="calibre10"/>        <span class="FontName">cxf.addMapping("/*");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This <span class="FontName">Initializer</span> class will look pretty much as all Spring MVC applications do. The only exception here is that we’ve configured a <span class="FontName">CXFServlet</span>, which handles a lot of the heavy lifting required to expose our service. In the Spring MVC configuration file, we’ll be using the Spring namespace support that CXF provides for configuring services.</p>
<p class="indent">The Spring context file is simple, most of it is boilerplate XML namespace and Spring context file imports. The only two salient stanzas are below, where we first configure the service itself as usual. Finally, we use the CXF <span class="FontName">jaxws:endpoint</span> namespace to configure our endpoint.</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:jaxrs="</span><span class="FontName"><a href="http://cxf.apache.org/jaxrs" class="calibre5">http://cxf.apache.org/jaxrs</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:simple="</span><span class="FontName"><a href="http://cxf.apache.org/simple" class="calibre5">http://cxf.apache.org/simple</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:soap="</span><span class="FontName"><a href="http://cxf.apache.org/bindings/soap" class="calibre5">http://cxf.apache.org/bindings/soap</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:jaxws="</span><span class="FontName"><a href="http://cxf.apache.org/jaxws" class="calibre5">http://cxf.apache.org/jaxws</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>       <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans-3.2.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</a></span><br class="calibre10"/>       <span class="FontName"><a href="http://cxf.apache.org/jaxrs" class="calibre5">http://cxf.apache.org/jaxrs</a></span> <span class="FontName"><a href="http://cxf.apache.org/schemas/jaxrs.xsd" class="calibre5">http://cxf.apache.org/schemas/jaxrs.xsd</a></span><br class="calibre10"/>       <span class="FontName"><a href="http://cxf.apache.org/simple" class="calibre5">http://cxf.apache.org/simple</a></span> <span class="FontName"><a href="http://cxf.apache.org/schemas/simple.xsd" class="calibre5">http://cxf.apache.org/schemas/simple.xsd</a></span><br class="calibre10"/>       <span class="FontName"><a href="http://cxf.apache.org/bindings/soap" class="calibre5">http://cxf.apache.org/bindings/soap</a></span><br class="calibre10"/>       <span class="FontName"><a href="http://cxf.apache.org/schemas/configuration/soap.xsd" class="calibre5">http://cxf.apache.org/schemas/configuration/soap.xsd</a></span><br class="calibre10"/>       <span class="FontName"><a href="http://cxf.apache.org/jaxws" class="calibre5">http://cxf.apache.org/jaxws</a></span> <span class="FontName"><a href="http://cxf.apache.org/schemas/jaxws.xsd" class="calibre5">http://cxf.apache.org/schemas/jaxws.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;import resource="classpath:META-INF/cxf/cxf-servlet.xml"/&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;import resource="classpath:META-INF/cxf/cxf.xml"/&gt;</span>  <br class="calibre10"/>    <span class="FontName">&lt;jaxws:endpoint implementor="#weatherService" address="/weather"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;jaxws:binding&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;soap:soapBinding version="1.2"/&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/jaxws:binding&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/jaxws:endpoint&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">We tell the <span class="FontName">jaxws:endpoint</span> factory to use the <span class="FontName">weatherService</span> Spring bean as the implementation. We tell it at what address to publish the service using the address element. In this case, because the Initializer mounts the CXF servlet under the root directory (/), the CXF <span class="FontName">weatherService</span> endpoint becomes accessible under /weather.</p>
<p class="indent">Note the Java code in <span class="FontName">weatherServiceImpl</span> stays the same as before, with the <span class="FontName">@WebService</span> and <span class="FontName">@WebMethod</span> annotations in place. Launch the application and your web container, and then bring up the application in your browser. In the book’s source code, the application is built in a WAR called jaxws.war and given CXF is deployed at the root context (/), the SOAP WSDL contract is available at <span class="FontName">http://localhost:8080/weather</span>. If you bring up the page at <span class="FontName">http://localhost:8080/</span> , you’ll see a directory of the available services and their operations. Click the link for the service’s WSDL—or simply append ?wsdl to the service endpoint—to see the WSDL for the service. The WSDL contract is pretty similar to the ones described in the previous section using JAX-WS JDK support. The only difference is the WSDL contract is generated with the help of CXF.</p>
<p id="Sec63" class="Heading2">Invoke a Web Service Using Spring’s JaxWsPortProxyFactoryBean<a id="cXXX.2181" class="calibre6"></a><a id="cXXX.1078" class="calibre6"></a></p>
<p class="noindent">Spring provides the functionality to access a SOAP WSDL contract and communicate with the underlying services as if it were a regular Spring bean. This functionality is provided by <span class="FontName">JaxWsPortProxyFactoryBean</span>. The following is a sample bean definition to access the SOAP weather service with <span class="FontName">JaxWsPortProxyFactoryBean</span>.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public JaxWsPortProxyFactoryBean weatherService() throws MalformedURLException {</span><br class="calibre10"/>    <span class="FontName">JaxWsPortProxyFactoryBean weatherService = new JaxWsPortProxyFactoryBean();</span><br class="calibre10"/>    <span class="FontName">weatherService.setServiceInterface(WeatherService.class);</span><br class="calibre10"/>    <span class="FontName">weatherService.setWsdlDocumentUrl(new URL("</span><span class="FontName">http://localhost:8888/jaxws/weather?WSDL</span><span class="FontName">"));</span><br class="calibre10"/>    <span class="FontName">weatherService.setNamespaceUri("</span><span class="FontName"><a href="http://weather.springrecipes.apress.com/" class="calibre5">http://weather.springrecipes.apress.com/</a></span><span class="FontName">");</span><br class="calibre10"/>    <span class="FontName">weatherService.setServiceName("weather");</span><br class="calibre10"/>    <span class="FontName">weatherService.setPortName("WeatherServiceImplPort");</span><br class="calibre10"/>    <span class="FontName">return weatherService;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The bean instance is given the weatherService name. It’s through this reference that you’ll be able to invoke the underlying SOAP service methods, as if they were running locally (e.g., <span class="FontName">weatherService.getTemperatures(city, dates)</span> ). The <span class="FontName">JaxWsPortProxyFactoryBean</span> requires several properties which are described next.</p>
<p class="indent">The <span class="FontName">serviceInterface</span> property defines the service interface for the SOAP call. In the case of the weather service, you can use the server-side implementation code which is the same. In case you’re accessing a SOAP service for which you don’t have the server-side code, you can always create this Java interface parting from the WSDL contract with a tool like java2wsdl. Note the <span class="FontName">serviceInterface</span> used by the client side needs to use the same JAX-WS annotation used by the server-side implementation (i.e., <span class="FontName">@WebService</span>).</p>
<p class="indent">The <span class="FontName">wsdlDocumentUrl</span> property represents the location of the WSDL contract. In this case, it’s pointing toward the CXF SOAP endpoint from this recipe, but you can equally define this property to access the JAX-WS JDK endpoint from this recipe or any WSDL contract for that matter.</p>
<p class="indent">The <span class="FontName">namesapceUrl</span>, <span class="FontName">serviceName</span>, and <span class="FontName">portName</span> are properties that pertain to the WSDL contract itself. Since there can be various namespaces, services, and ports in a WSDL contract, you need to tell Spring which values to use for the purpose of accessing the service. The values presented here can easily be verified by doing a manual inspection to the weather WSDL contract.</p>
<p id="Sec64" class="Heading2">Invoke a Web Service Using CXF</p>
<p class="noindent">Let’s now use CXF to define a web service client. Our client is the same as in previous recipes, and there is no special Java configuration or coding to be done. We simply need the interface of the service on the classpath. Once that’s done, you can use CXF’s namespace support to create a client.</p>
<pre class="calibre11"><span class="FontName">&lt;beans xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:context="</span><span class="FontName"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:aop="</span><span class="FontName"><a href="http://www.springframework.org/schema/aop" class="calibre5">http://www.springframework.org/schema/aop</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:jaxws="</span><span class="FontName"><a href="http://cxf.apache.org/jaxws" class="calibre5">http://cxf.apache.org/jaxws</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>                           <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans-3.2.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</a></span><br class="calibre10"/>                           <span class="FontName"><a href="http://www.springframework.org/schema/aop" class="calibre5">http://www.springframework.org/schema/aop</a></span><br class="calibre10"/>                           <span class="FontName"><a href="http://www.springframework.org/schema/aop/spring-aop-3.2.xsd" class="calibre5">http://www.springframework.org/schema/aop/spring-aop-3.2.xsd</a></span><br class="calibre10"/>                           <span class="FontName"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></span><br class="calibre10"/>                           <span class="FontName"><a href="http://www.springframework.org/schema/context/spring-context-3.2.xsd" class="calibre5">http://www.springframework.org/schema/context/spring-context-3.2.xsd</a></span><br class="calibre10"/>                           <span class="FontName"><a href="http://cxf.apache.org/jaxws" class="calibre5">http://cxf.apache.org/jaxws</a></span> <span class="FontName"><a href="http://cxf.apache.org/schemas/jaxws.xsd" class="calibre5">http://cxf.apache.org/schemas/jaxws.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>   <span class="FontName">&lt;import resource="classpath:META-INF/cxf/cxf.xml"/&gt;</span><br class="calibre10"/>   <span class="FontName">&lt;import resource="classpath:META-INF/cxf/cxf-servlet.xml"/&gt;</span>  <br class="calibre10"/>   <span class="FontName">&lt;jaxws:client serviceClass="com.apress.springrecipes.weather.WeatherService"</span><br class="calibre10"/>               <span class="FontName">address="</span><span class="FontName">http://localhost:8080/weather</span><span class="FontName">" id="weatherService"/&gt;</span>  <br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">We use the <span class="FontName">jaxws:client</span> namespace support to define to which interface the proxy should be bound, and the endpoint of the service itself. That is all that’s required. Our examples from previous recipes works otherwise unchanged: here we inject the client into the <span class="FontName">WeatherServiceClient</span> and invoke it using the <span class="FontName">weatherService</span> reference (e.g., weatherService.getTemperatures(city, dates)).</p>
<p id="Sec65" class="Heading">14-10. Introduction to contract first SOAP Web Services<a id="cXXX.2179" class="calibre6"></a></p>
<p id="Sec66" class="Heading1">Problem</p>
<p class="noindent">You want to develop a contract first SOAP Web Service instead of a code first SOAP Web service as you did in the previous recipe.</p>
<p id="Sec67" class="Heading1">Solution</p>
<p class="noindent">There are two ways to develop SOAP web services. One is called ‘code first’ which means you start with a Java class and then build out toward a WSDL contract. The other method is called ‘contract first’ which means you start with an XML data contract — something simpler than WSDL — and build in toward a Java class to implement the service.</p>
<p class="indent">To create a data contract for a ‘contract first’ SOAP web service, you’ll need an XSD file or XML Schema file that describes the operations and data supported by the service. The requirement for an XSD file is because ‘under the hood’ the communication between a SOAP service client and server takes place as XML defined in an XSD file.</p>
<p class="indent">However, because an XSD file can be difficult to write correctly, it’s preferable to start by creating sample XML messages and then generating the XSD file from them. Then with the XSD file, you can leverage something like Spring-WS to build the SOAP web service parting from the XSD file.</p>
<p id="Sec68" class="Heading1">How It Works</p>
<p id="Sec69" class="Heading2">CreateSample XML Messages<a id="cXXX.1079" class="calibre6"></a></p>
<p class="noindent">Let’s do the same weather service presented in previous recipes, but this time using the SOAP ‘contract first’ approach. So you’re asked to write a SOAP service that is able to communicate weather information based on a city and date, returning the minimum, maximum, and average temperatures.</p>
<p class="indent">Instead of going in head first and writing code to support the previous functionality as you did in the previous recipe, let’s describe the temperature of a particular city and date using a ‘contract first’ approach with an XML message like the following:</p>
<pre class="calibre11"><span class="FontName">&lt;TemperatureInfo city="Houston" date="2014-12-01"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;min&gt;5.0&lt;/min&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;max&gt;10.0&lt;/max&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;average&gt;8.0&lt;/average&gt;</span><br class="calibre10"/><span class="FontName">&lt;/TemperatureInfo&gt;</span></pre>
<p class="indent">This is the first step toward having a data contract in a SOAP ‘contract first’ way for the weather service. Now let’s define some operations. You want to allow clients to query the temperatures of a particular city for multiple dates. Each request consists of a city element and multiple date elements. We’ll also specify the namespace for this request to avoid naming conflicts with other XML documents. Let’s create this XML message and save it into a file called request.xml.</p>
<pre class="calibre11"><span class="FontName">&lt;GetTemperaturesRequest</span><br class="calibre10"/>    <span class="FontName">xmlns="</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;city&gt;Houston&lt;/city&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;date&gt;2014-12-01&lt;/date&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;date&gt;2014-12-08&lt;/date&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;date&gt;2014-12-15&lt;/date&gt;</span><br class="calibre10"/><span class="FontName">&lt;/GetTemperaturesRequest&gt;</span></pre>
<p class="indent">The response for a request of the previous type would consist of multiple <span class="FontName">TemperatureInfo</span> elements, each of which represents the temperature of a particular city and date, in accordance with the requested dates. Let’s create this XML message and save it to a file called response.xml.</p>
<pre class="calibre11"><span class="FontName">&lt;GetTemperaturesResponse</span><br class="calibre10"/>    <span class="FontName"> xmlns="</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;TemperatureInfo city="Houston" date="2014-12-01"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;min&gt;5.0&lt;/min&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;max&gt;10.0&lt;/max&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;average&gt;8.0&lt;/average&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/TemperatureInfo&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;TemperatureInfo city="Houston" date="2007-12-08"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;min&gt;4.0&lt;/min&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;max&gt;13.0&lt;/max&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;average&gt;7.0&lt;/average&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/TemperatureInfo&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;TemperatureInfo city="Houston" date="2007-12-15"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;min&gt;10.0&lt;/min&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;max&gt;18.0&lt;/max&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;average&gt;15.0&lt;/average&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/TemperatureInfo&gt;</span><br class="calibre10"/><span class="FontName">&lt;/GetTemperaturesResponse&gt;</span></pre>
<p id="Sec70" class="Heading2">Generate an XSD File from sample XML Messages</p>
<p class="noindent">Now, you can generate the XSD file<a id="cXXX.1080" class="calibre5"></a> from the preceding sample XML messages. Most XML tools and enterprise Java IDEs can generate an XSD file from a couple of XML files. Here, we’ll use Apache XMLBeans (<span class="FontName"><a href="http://xmlbeans.apache.org/" class="calibre5">http://xmlbeans.apache.org/</a></span>) to generate the XSD file.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  You can download Apache XMLBeans (e.g., v2.6.0) from the Apache XMLBeans web site and extract it to a directory of your choice to complete the installation.</p></div>
<p class="indent">Apache XMLBeans provides a tool called inst2xsd to generate XSD files from XML files. It supports several design types for generating XSD files. The simplest is called Russian doll design, which generates local elements and local types for the target XSD file. Because there’s no enumeration type used in your XML messages, you can disable the enumeration generation feature. You can execute the following command to generate the XSD file from the previous XML files:</p>
<pre class="calibre11"><span class="FontName">inst2xsd -design rd -enumerations never request.xml response.xml</span></pre>
<p class="indent">The generated XSD file will have the default name schema0.xsd, located in the same directory. Let’s rename it to temperature.xsd.</p>
<pre class="calibre11"><span class="FontName">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br class="calibre10"/><span class="FontName">&lt;xs:schema attributeFormDefault="unqualified"</span><br class="calibre10"/>    <span class="FontName">elementFormDefault="qualified"</span><br class="calibre10"/>    <span class="FontName">targetNamespace="</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xs="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema" class="calibre5">http://www.w3.org/2001/XMLSchema</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;xs:element name="GetTemperaturesRequest"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;xs:complexType&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;xs:sequence&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;xs:element type="xs:string" name="city" /&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;xs:element type="xs:date" name="date"</span><br class="calibre10"/>                    <span class="FontName">maxOccurs="unbounded" minOccurs="0" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/xs:sequence&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/xs:complexType&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/xs:element&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;xs:element name="GetTemperaturesResponse"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;xs:complexType&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;xs:sequence&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;xs:element name="TemperatureInfo"</span><br class="calibre10"/>                    <span class="FontName">maxOccurs="unbounded" minOccurs="0"&gt;</span><br class="calibre10"/>                    <span class="FontName">&lt;xs:complexType&gt;</span><br class="calibre10"/>                        <span class="FontName">&lt;xs:sequence&gt;</span><br class="calibre10"/>                            <span class="FontName">&lt;xs:element type="xs:float" name="min" /&gt;</span><br class="calibre10"/>                            <span class="FontName">&lt;xs:element type="xs:float" name="max" /&gt;</span><br class="calibre10"/>                            <span class="FontName">&lt;xs:element type="xs:float" name="average" /&gt;</span><br class="calibre10"/>                        <span class="FontName">&lt;/xs:sequence&gt;</span><br class="calibre10"/>                        <span class="FontName">&lt;xs:attribute type="xs:string" name="city"</span><br class="calibre10"/>                            <span class="FontName">use="optional" /&gt;</span><br class="calibre10"/>                        <span class="FontName">&lt;xs:attribute type="xs:date" name="date"</span><br class="calibre10"/>                            <span class="FontName">use="optional" /&gt;</span><br class="calibre10"/>                    <span class="FontName">&lt;/xs:complexType&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;/xs:element&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/xs:sequence&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/xs:complexType&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/xs:element&gt;</span><br class="calibre10"/><span class="FontName">&lt;/xs:schema</span><span class="FontName">&gt;</span></pre>
<p id="Sec71" class="Heading2">Optimizing the Generated XSD File</p>
<p class="noindent">As you can see, the generated XSD file<a id="cXXX.1081" class="calibre5"></a> allows clients to query temperatures for unlimited dates. If you want to add a constraint on the maximum and minimum query dates, you can modify the maxOccurs and minOccurs a minOccurs attributes.</p>
<pre class="calibre11"><span class="FontName">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br class="calibre10"/><span class="FontName">&lt;xs:schema attributeFormDefault="unqualified"</span><br class="calibre10"/>    <span class="FontName">elementFormDefault="qualified"</span><br class="calibre10"/>    <span class="FontName">targetNamespace="</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xs="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema" class="calibre5">http://www.w3.org/2001/XMLSchema</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;xs:element name="GetTemperaturesRequest"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;xs:complexType&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;xs:sequence&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;xs:element type="xs:string" name="city" /&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;xs:element type="xs:date" name="date"</span><br class="calibre10"/>                    <span class="FontName">maxOccurs="5" minOccurs="1" /&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/xs:sequence&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/xs:complexType&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/xs:element&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;xs:element name="GetTemperaturesResponse"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;xs:complexType&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;xs:sequence&gt;</span><br class="calibre10"/>                <span class="FontName">&lt;xs:element name="TemperatureInfo"</span><br class="calibre10"/>                    <span class="FontName">maxOccurs="5" minOccurs="1"&gt;</span><br class="calibre10"/>                    <span class="FontName">...</span><br class="calibre10"/>                <span class="FontName">&lt;/xs:element&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/xs:sequence&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/xs:complexType&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/xs:element&gt;</span><br class="calibre10"/><span class="FontName">&lt;/xs:schema</span><span class="FontName">&gt;</span></pre>
<p id="Sec72" class="Heading2">Previewing the Generated WSDL File</p>
<p class="noindent">As you will learn shortly and in full detail, Spring-WS is equipped to automatically generate a WSDL<a id="cXXX.1082" class="calibre5"></a> contract parting from an XSD file. The following snippet illustrates the Spring bean configuration for this purpose — we’ll add context on how to use this snippet in the next recipe which describes how to build SOAP web services with Spring-WS.</p>
<pre class="calibre11"><span class="FontName">&lt;sws:dynamic-wsdl id="temperature" portTypeName="Weather" locationUri="/"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;sws:xsd location="/WEB-INF/temperature.xsd"/&gt;</span><br class="calibre10"/><span class="FontName">&lt;/sws:dynamic-wsdl&gt;</span></pre>
<p class="indent">Here, we’ll preview the generated WSDL file to better understand the service contract. For simplicity’s sake, the less important parts are omitted.</p>
<pre class="calibre11"><span class="FontName">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><br class="calibre10"/><span class="FontName">&lt;wsdl:definitions ...</span><br class="calibre10"/>    <span class="FontName">targetNamespace="</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;wsdl:types&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;!-- Copied from the XSD file --&gt;</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;/wsdl:types&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;wsdl:message name="GetTemperaturesResponse"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;wsdl:part element="schema:GetTemperaturesResponse"</span><br class="calibre10"/>            <span class="FontName">name="GetTemperaturesResponse"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/wsdl:part&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/wsdl:message&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;wsdl:message name="GetTemperaturesRequest"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;wsdl:part element="schema:GetTemperaturesRequest"</span><br class="calibre10"/>            <span class="FontName">name="GetTemperaturesRequest"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/wsdl:part&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/wsdl:message&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;wsdl:portType name="Weather"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;wsdl:operation name="GetTemperatures"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;wsdl:input message="schema:GetTemperaturesRequest"</span><br class="calibre10"/>                <span class="FontName">name="GetTemperaturesRequest"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/wsdl:input&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;wsdl:output message="schema:GetTemperaturesResponse"</span><br class="calibre10"/>                <span class="FontName">name="GetTemperaturesResponse"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;/wsdl:output&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/wsdl:operation&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/wsdl:portType&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">&lt;wsdl:service name="WeatherService"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;wsdl:port binding="schema:WeatherBinding" name="WeatherPort"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;soap:address</span><br class="calibre10"/>                <span class="FontName">location="</span><span class="FontName">http://localhost:8080/weather/services</span><span class="FontName">" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/wsdl:port&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/wsdl:service&gt;</span><br class="calibre10"/><span class="FontName">&lt;/wsdl:definitions&gt;</span></pre>
<p class="indent">In the Weather port type, a <span class="FontName">GetTemperatures</span> operation is defined whose name is derived from the prefix of the input and output messages (i.e., <span class="FontName">&lt;GetTemperaturesRequest&gt;</span> and <span class="FontName">&lt;GetTemperaturesResponse&gt;</span>). The definitions of these two elements are included in the &lt;wsdl:types&gt; part, as defined in the data contract.</p>
<p class="indent">Now with the WSDL contract in hand, you can generate the necessary Java interfaces and then write the backing code for each of the operations that started out as XML messages. This full technique is explored in the next recipe which uses Spring-WS for the process.</p>
<p id="Sec73" class="Heading">14-11. Expose and invoke SOAP Web Services with Spring-WS<a id="cXXX.1083" class="calibre6"></a></p>
<p id="Sec74" class="Heading1">Problem</p>
<p class="noindent">You’ve have an XSD file to develop a ‘contract first’ SOAP web service and don’t know how or what to use to implement the ‘contract first’ SOAP service.</p>
<div class="Singlethin"><p class="Heading4a"><b class="calibre1">SPRING-WS AND JAX-WS 'CONTRACT FIRST' SUPPORT</b></p>
<p class="box-left">Spring-WS was designed from the outset to support ‘contract first’ SOAP web services. However, this does not mean Spring-WS is the only way to create SOAP web services in Java. JAX-WS implementations like CXF &amp; Axis also support this technique.</p>
<p class="box-left">Nevertheless, Spring-WS is the more mature and natural approach to do ‘contract first’ SOAP web services in the context of Spring applications. Describing other ’contract first’ SOAP Java techniques, would lead us outside the scope of the Spring framework.</p></div>
<p id="Sec75" class="Heading1">Solution</p>
<p class="noindent">Spring-WS provides a set of facilities to develop ‘contract first’ SOAP web services. The essential tasks for building a Spring-WS web service include the following:</p>
<ul class="bulleted"><li class="calibre17">Set up and configure a Spring MVC application for Spring-WS</li>
<li class="calibre17">Map web service requests to endpoints</li>
<li class="calibre17">Create service endpoints to handle the request messages and return the response messages</li>
<li class="calibre17">Publish the WSDL file for the web service</li></ul>
<p id="Sec76" class="Heading1">How It Works</p>
<p id="Sec77" class="Heading2">Set Up a Spring-WS Application</p>
<p class="noindent">To implement a web service using Spring-WS, let’s first create a web application initializer class to bootstrap a web application<a id="cXXX.1084" class="calibre5"></a> with a SOAP web service. You need to configure the <span class="FontName">MessageDispatcherServlet</span> servlet which is part of Spring-WS. This servlet specializes in dispatching web service messages to appropriate endpoints and detecting the framework facilities of Spring-WS.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.ws.transport.http.support.AbstractAnnotationConfigMessageDispatcherServletInitializer;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Initializer extends AbstractAnnotationConfigMessageDispatcherServletInitializer {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected Class&lt;?&gt;[] getRootConfigClasses() {</span><br class="calibre10"/>        <span class="FontName">return null;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected Class&lt;?&gt;[] getServletConfigClasses() {</span><br class="calibre10"/>        <span class="FontName">return new Class&lt;?&gt;[] {SpringWsConfiguration.class};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">To make configuration easier there is the <span class="FontName">AbstractAnnotationConfigMessageDispatcher ServletInitializer</span> base class we can extend. We need to supply it with the configuration classes which make up the rootConfig and the servletConfig, the first can be null the latter is required.</p>
<p class="indent">The configuration above will bootstrap a <span class="FontName">MessageDispatcherServlet</span> using the <span class="FontName">SpringWsConfiguration</span> class and register it for the <span class="FontName">/services/*</span> and <span class="FontName">*.wsdl</span> urls.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.ComponentScan;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.core.io.ClassPathResource;</span><br class="calibre10"/><span class="FontName">import org.springframework.ws.config.annotation.EnableWs;</span><br class="calibre10"/><span class="FontName">import org.springframework.ws.wsdl.wsdl11.DefaultWsdl11Definition;</span><br class="calibre10"/><span class="FontName">import org.springframework.xml.xsd.SimpleXsdSchema;</span><br class="calibre10"/><span class="FontName">import org.springframework.xml.xsd.XsdSchema;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><b class="calibre4">@EnableWs</b><br class="calibre10"/><b class="calibre4">@ComponentScan("com.apress.springrecipes.weather")</b><br class="calibre10"/><span class="FontName">public class SpringWsConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The SpringWsConfiguration class<a id="cXXX.1085" class="calibre5"></a> is annotated with <span class="FontName">@EnableWs</span> that registers necessary beans to make the <span class="FontName">MessageDispatcherServlet</span> work. We also have a <span class="FontName">@ComponentScan</span> that scans for our @Service and @Endpoint bean.</p>
<p id="Sec78" class="Heading2">Create Service Endpoints<a id="cXXX.1086" class="calibre6"></a></p>
<p class="noindent">Spring-WS supports annotating an arbitrary class as a service endpoint by the <span class="FontName">@Endpoint</span> annotation so it becomes accessible as a service. Besides the <span class="FontName">@Endpoint</span> annotation, you also need to annotate handler methods with the <span class="FontName">@PayloadRoot</span> annotation to map service requests. And each handler method also relies on the <span class="FontName">@ResponsePayload</span> and <span class="FontName">@RequestPayload</span> annotations to handle the incoming and outgoing service data.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.ws.server.endpoint.annotation.Endpoint;</span><br class="calibre10"/><span class="FontName">import org.springframework.ws.server.endpoint.annotation.PayloadRoot;</span><br class="calibre10"/><span class="FontName">import org.springframework.ws.server.endpoint.annotation.ResponsePayload;</span><br class="calibre10"/><span class="FontName">import org.springframework.ws.server.endpoint.annotation.RequestPayload;</span><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.annotation.Autowired;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.dom4j.DocumentHelper;</span><br class="calibre10"/><span class="FontName">import org.dom4j.Document;</span><br class="calibre10"/><span class="FontName">import org.dom4j.Element;</span><br class="calibre10"/><span class="FontName">import org.dom4j.XPath;</span><br class="calibre10"/><span class="FontName">import org.dom4j.xpath.DefaultXPath;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Endpoint</span><br class="calibre10"/><span class="FontName">public class TemperatureEndpoint {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private static final String namespaceUri = "</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">";</span><br class="calibre10"/>    <span class="FontName">private XPath cityPath;</span><br class="calibre10"/>    <span class="FontName">private XPath datePath;</span><br class="calibre10"/>    <span class="FontName">private DateFormat dateFormat;</span><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">private WeatherService weatherService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public TemperatureEndpoint() {</span><br class="calibre10"/>        <span class="FontName">// Create the XPath objects, including the namespace</span><br class="calibre10"/>        <span class="FontName">Map&lt;String, String&gt; namespaceUris = new HashMap&lt;String, String&gt;();</span><br class="calibre10"/>        <span class="FontName">namespaceUris.put("weather", namespaceUri);</span><br class="calibre10"/>        <span class="FontName">cityPath = new DefaultXPath("/weather:GetTemperaturesRequest/weather:city");</span><br class="calibre10"/>        <span class="FontName">cityPath.setNamespaceURIs(namespaceUris);</span><br class="calibre10"/>        <span class="FontName">datePath = new DefaultXPath("/weather:GetTemperaturesRequest/weather:date");</span><br class="calibre10"/>        <span class="FontName">datePath.setNamespaceURIs(namespaceUris);</span><br class="calibre10"/>        <span class="FontName">dateFormat = new SimpleDateFormat("yyyy-MM-dd");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setWeatherService(WeatherService weatherService) {</span><br class="calibre10"/>        <span class="FontName">this.weatherService = weatherService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@PayloadRoot(localPart="GetTemperaturesRequest",namespace=namespaceUri)</span><br class="calibre10"/>    <span class="FontName">@ResponsePayload</span><br class="calibre10"/>    <span class="FontName">public Element getTemperature(@RequestPayload Element requestElement) throws Exception {</span><br class="calibre10"/>        <span class="FontName">// Extract the service parameters from the request message</span><br class="calibre10"/>        <span class="FontName">String city = cityPath.valueOf(requestElement);</span><br class="calibre10"/>        <span class="FontName">List&lt;Date&gt; dates = new ArrayList&lt;Date&gt;();</span><br class="calibre10"/>        <span class="FontName">for (Object node : datePath.selectNodes(requestElement)) {</span><br class="calibre10"/>            <span class="FontName">Element element = (Element) node;</span><br class="calibre10"/>            <span class="FontName">dates.add(dateFormat.parse(element.getText()));</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Invoke the back-end service to handle the request</span><br class="calibre10"/>        <span class="FontName">List&lt;TemperatureInfo&gt; temperatures =</span><br class="calibre10"/>            <span class="FontName">weatherService.getTemperatures(city, dates);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Build</span> <span class="FontName">the response message from the result of back-end service</span><br class="calibre10"/>        <span class="FontName">Document responseDocument = DocumentHelper.createDocument();</span><br class="calibre10"/>        <span class="FontName">Element responseElement = responseDocument.addElement(</span><br class="calibre10"/>                <span class="FontName">"GetTemperaturesResponse", namespaceUri);</span><br class="calibre10"/>        <span class="FontName">for (TemperatureInfo temperature : temperatures) {</span><br class="calibre10"/>            <span class="FontName">Element temperatureElement = responseElement.addElement(</span><br class="calibre10"/>                    <span class="FontName">"TemperatureInfo");</span><br class="calibre10"/>            <span class="FontName">temperatureElement.addAttribute("city", temperature.getCity());</span><br class="calibre10"/>            <span class="FontName">temperatureElement.addAttribute(</span><br class="calibre10"/>                    <span class="FontName">"date", dateFormat.format(temperature.getDate()));</span><br class="calibre10"/>            <span class="FontName">temperatureElement.addElement("min").setText(</span><br class="calibre10"/>                    <span class="FontName">Double.toString(temperature.getMin()));</span><br class="calibre10"/>            <span class="FontName">temperatureElement.addElement("max").setText(</span><br class="calibre10"/>                    <span class="FontName">Double.toString(temperature.getMax()));</span><br class="calibre10"/>            <span class="FontName">temperatureElement.addElement("average").setText(</span><br class="calibre10"/>                    <span class="FontName">Double.toString(temperature.getAverage()));</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">return responseElement;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In the <span class="FontName">@PayloadRoot</span> annotation, you specify the local name (<span class="FontName">getTemperaturesRequest</span>) and namespace (<span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span>) of the payload root element to be handled. Next, the method is decorated with the <span class="FontName">@ResponsePayload</span> indicating the method’s return value is the service response data. In addition, the method’s input parameter is decorated with the <span class="FontName">@RequestPayload</span> annotation to indicate it’s the service input value.</p>
<p class="indent">Then inside the handler method, you first extract the service parameters from the request message. Here, you use XPath to help locate the elements. The XPath objects are created in the constructor so that they can be reused for subsequent request handling. Note that you must also include the namespace in the XPath expressions, or else they will not be able to locate the elements correctly.</p>
<p class="indent">After extracting the service parameters, you invoke the back-end service to handle the request. Because this endpoint is configured in the Spring IoC container, it can easily refer to other beans through dependency injection.</p>
<p class="indent">Finally, you build the response message from the back-end service’s result. In this case we used the dom4j library that provides a rich set of APIs for you to build an XML message. But you can use any other XML processing API or Java parser you wish (e.g., DOM).</p>
<p class="indent">Because you already defined a <span class="FontName">@ComponentScan</span> in the <span class="FontName">SpringWsConfiguration</span> class, Spring automatically picks up all the Spring-WS annotations and deploys the endpoint to the servlet.</p>
<p id="Sec79" class="Heading2">Publish the WSDL<a id="cXXX.1087" class="calibre6"></a> File</p>
<p class="noindent">The last step to complete the SOAP web service is to publish the WSDL file. In Spring-WS, it’s not necessary for you to write the WSDL file manually, you only need to add a bean to the <span class="FontName">SpringWsConfiguration</span> class.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public DefaultWsdl11Definition temperature() {</span><br class="calibre10"/>    <span class="FontName">DefaultWsdl11Definition temperature = new DefaultWsdl11Definition();</span><br class="calibre10"/>    <span class="FontName">temperature.setPortTypeName("Weather");</span><br class="calibre10"/>    <span class="FontName">temperature.setLocationUri("/");</span><br class="calibre10"/>    <span class="FontName">temperature.setSchema(temperatureSchema());</span><br class="calibre10"/>    <span class="FontName">return temperature;</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public XsdSchema temperatureSchema() {</span><br class="calibre10"/>    <span class="FontName">return new SimpleXsdSchema(new ClassPathResource("/META-INF/xsd/temperature.xsd"));</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The <span class="FontName">DefaultWsdl11Definition</span> class requires that you specify two properties: a <span class="FontName">portTypeName</span> for the service, as well as a <span class="FontName">locationUri</span> on which to deploy the final WSDL. In addition, it also requires that you specify the location of the XSD file from which to create the WSDL — see the previous recipe for details on how to create and XSD file. In this case, the XSD file will be located inside the application’s META-INF directory.</p>
<p class="indent">Because you have defined <span class="FontName">&lt;GetTemperaturesRequest&gt;</span> and <span class="FontName">&lt;GetTemperaturesResponse&gt;</span> in your XSD file, and you have specified the port type name as Weather, the WSDL builder will generate the following WSDL port type and operation for you. The following snippet is taken from the generated WSDL file:</p>
<pre class="calibre11"><span class="FontName">&lt;wsdl:portType name="Weather"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;wsdl:operation name="GetTemperatures"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;wsdl:input message="schema:GetTemperaturesRequest"</span><br class="calibre10"/>            <span class="FontName">name="GetTemperaturesRequest" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;wsdl:output message="schema:GetTemperaturesResponse"</span><br class="calibre10"/>            <span class="FontName">name="GetTemperaturesResponse" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/wsdl:operation&gt;</span><br class="calibre10"/><span class="FontName">&lt;/wsdl:portType&gt;</span></pre>
<p class="indent">Finally, you can access this WSDL file by joining its definition’s bean name and the .wsdl suffix. Assuming the web application is packaged in a WAR file named springws, then the service is deployed in <span class="FontName">http://localhost:8080/springws</span> /— because the Spring-WS servlet in the initializer is deployed on the /services directory — and the WSDL file’s URL would be <span class="FontName">http://localhost:8080/springws/services/weather/temperature.wsdl</span>, given that the bean name of the WSDL definition is temperature.</p>
<p id="Sec80" class="Heading2">Invoke SOAP Web Services with Spring-WS</p>
<p class="noindent">Now, let’s create a Spring-WS client to invoke the weather service according to the contract it publishes. You can create a Spring-WS client by parsing the request and response XML messages<a id="cXXX.1088" class="calibre5"></a>. As an example, we will use dom4j to implement it. But you are free to choose any other XML parsing APIs for it.</p>
<p class="indent">To shield the client from the low-level invocation details, we’ll create a local proxy to call the SOAP web service. This proxy also implements the <span class="FontName">WeatherService</span> interface, and it translates local method calls into remote SOAP web service calls.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.dom4j.Document;</span><br class="calibre10"/><span class="FontName">import org.dom4j.DocumentHelper;</span><br class="calibre10"/><span class="FontName">import org.dom4j.Element;</span><br class="calibre10"/><span class="FontName">import org.dom4j.io.DocumentResult;</span><br class="calibre10"/><span class="FontName">import org.dom4j.io.DocumentSource;</span><br class="calibre10"/><span class="FontName">import org.springframework.ws.client.core.WebServiceTemplate;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class WeatherServiceProxy implements WeatherService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private static final String namespaceUri =</span><br class="calibre10"/>        <span class="FontName">"</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">";</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private DateFormat dateFormat;</span><br class="calibre10"/>    <span class="FontName">private WebServiceTemplate webServiceTemplate;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public WeatherServiceProxy() throws Exception {</span><br class="calibre10"/>        <span class="FontName">dateFormat = new SimpleDateFormat("yyyy-MM-dd");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setWebServiceTemplate(WebServiceTemplate webServiceTemplate) {</span><br class="calibre10"/>        <span class="FontName">this.webServiceTemplate = webServiceTemplate;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public List&lt;TemperatureInfo&gt; getTemperatures(String city, List&lt;Date&gt; dates) {</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Build the request document from the method arguments</span><br class="calibre10"/>        <span class="FontName">Document requestDocument = DocumentHelper.createDocument();</span><br class="calibre10"/>        <span class="FontName">Element requestElement = requestDocument.addElement(</span><br class="calibre10"/>                <span class="FontName">"GetTemperaturesRequest", namespaceUri);</span><br class="calibre10"/>        <span class="FontName">requestElement.addElement("city").setText(city);</span><br class="calibre10"/>        <span class="FontName">for (Date date : dates) {</span><br class="calibre10"/>            <span class="FontName">requestElement.addElement("date").setText(dateFormat.format(date));</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Invoke the remote web service</span><br class="calibre10"/>        <span class="FontName">DocumentSource source = new DocumentSource(requestDocument);</span><br class="calibre10"/>        <span class="FontName">DocumentResult result = new DocumentResult();</span><br class="calibre10"/>        <span class="FontName">webServiceTemplate.sendSourceAndReceiveToResult(source, result);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">// Extract the result from the response document</span><br class="calibre10"/>        <span class="FontName">Document responsetDocument = result.getDocument();</span><br class="calibre10"/>        <span class="FontName">Element responseElement = responsetDocument.getRootElement();</span><br class="calibre10"/>        <span class="FontName">List&lt;TemperatureInfo&gt; temperatures = new ArrayList&lt;TemperatureInfo&gt;();</span><br class="calibre10"/>        <span class="FontName">for (Object node : responseElement.elements("TemperatureInfo")) {</span><br class="calibre10"/>            <span class="FontName">Element element = (Element) node;</span><br class="calibre10"/>            <span class="FontName">try {</span><br class="calibre10"/>                <span class="FontName">Date date = dateFormat.parse(element.attributeValue("date"));</span><br class="calibre10"/>                <span class="FontName">double min = Double.parseDouble(element.elementText("min"));</span><br class="calibre10"/>                <span class="FontName">double max = Double.parseDouble(element.elementText("max"));</span><br class="calibre10"/>                <span class="FontName">double average = Double.parseDouble(</span><br class="calibre10"/>                        <span class="FontName">element.elementText("average"));</span><br class="calibre10"/>                <span class="FontName">temperatures.add(</span><br class="calibre10"/>                        <span class="FontName">new TemperatureInfo(city, date, min, max, average));</span><br class="calibre10"/>            <span class="FontName">} catch (ParseException e) {</span><br class="calibre10"/>                <span class="FontName">throw new RuntimeException(e);</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">return temperatures;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In the <span class="FontName">getTemperatures()</span> method, you first build the request message using the dom4j API. WebServiceTemplate provides a <span class="FontName">sendSourceAndReceiveToResult()</span> method that accepts a <span class="FontName">java.xml.transform.Source</span> and a <span class="FontName">java.xml.transform.Result</span> object as arguments. You have to build a dom4j <span class="FontName">DocumentSource</span> object to wrap your request document and create a new dom4j <span class="FontName">DocumentResult</span> object for the method to write the response document to it. Finally, you get the response message and extract the results from it.</p>
<p class="indent">With the service proxy written, we can declare it in a configuration class and later call it using a standalone class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.weather.WeatherServiceClient;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.weather.WeatherServiceProxy;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><span class="FontName">import org.springframework.ws.client.core.WebServiceTemplate;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class SpringWsClientConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public WeatherServiceClient weatherServiceClient() throws Exception {</span><br class="calibre10"/>        <span class="FontName">WeatherServiceClient weatherServiceClient = new WeatherServiceClient();</span><br class="calibre10"/>        <span class="FontName">weatherServiceClient.setWeatherService(weatherServiceProxy());</span><br class="calibre10"/>        <span class="FontName">return weatherServiceClient;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public WeatherServiceProxy weatherServiceProxy() throws Exception {</span><br class="calibre10"/>        <span class="FontName">WeatherServiceProxy weatherServiceProxy = new WeatherServiceProxy();</span><br class="calibre10"/>        <span class="FontName">weatherServiceProxy.setWebServiceTemplate(webServiceTemplate());</span><br class="calibre10"/>        <span class="FontName">return weatherServiceProxy;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public WebServiceTemplate webServiceTemplate() {</span><br class="calibre10"/>        <span class="FontName">WebServiceTemplate webServiceTemplate = new WebServiceTemplate();</span><br class="calibre10"/>        <span class="FontName">webServiceTemplate.setDefaultUri("</span><span class="FontName">http://localhost:8080/springws/services</span><span class="FontName">");</span><br class="calibre10"/>        <span class="FontName">return webServiceTemplate;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Note the webServiceTemplate has its <span class="FontName">defaultUri</span> value set to the endpoint defined for the Spring-WS endpoint in the previous sections. Once the configuration is loaded by an application, you can call the SOAP service using the following class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.context.ApplicationContext;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.support.GenericXmlApplicationContext;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class SpringWSInvokerClient {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static void main(String[] args) {</span><br class="calibre10"/>        <span class="FontName">ApplicationContext context =</span><br class="calibre10"/>            <span class="FontName">new AnnotationConfigApplicationContext("com.apress.springrecipes.weather.config");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">WeatherServiceClient client = context.getBean(WeatherServiceClient.class);</span><br class="calibre10"/>        <span class="FontName">TemperatureInfo temperature = client.getTodayTemperature("Houston");</span><br class="calibre10"/>        <span class="FontName">System.out.println("Min temperature : " + temperature.getMin());</span><br class="calibre10"/>        <span class="FontName">System.out.println("Max temperature : " + temperature.getMax());</span><br class="calibre10"/>        <span class="FontName">System.out.println("Average temperature : " + temperature.getAverage());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec81" class="Heading">14-12. Develop SOAP Web Services with Spring-WS and XML Marshalling<a id="cXXX.1089" class="calibre6"></a></p>
<p id="Sec82" class="Heading1">Problem</p>
<p class="noindent">To develop web services with the contract-first approach, you have to process request and response XML messages. If you parse the XML messages with XML parsing APIs directly, you’ll have to deal with the XML elements one by one with low-level APIs, which is a cumbersome and inefficient task.</p>
<p id="Sec83" class="Heading1">Solution</p>
<p class="noindent">Spring-WS supports using XML marshalling technology<a id="cXXX.2280" class="calibre5"></a> to marshal and unmarshal objects to and from XML documents. In this way, you can deal with object properties instead of XML elements. This technology is also known as object/XML mapping (OXM), because you are actually mapping objects to and from XML documents.</p>
<p class="indent">To implement endpoints with an XML marshalling technology, you can configure an XML marshaller for it. <a id="_Tab2" href="part0024.html#Tab2" class="calibre5">Table 14-2</a> lists the marshallers provided by Spring for different XML marshalling APIs.</p>
<div class="Table" id="Tab2"><p class="TabCapt"><span class="calibre4"><a href="part0024.html#_Tab2" class="calibre5">Table 14-2</a>.</span> Marshallers for Different XML Marshalling APIs</p>
<table border="0" class="calibre12"><thead class="calibre13"><tr class="header"><th valign="top" class="calibre14"><p class="tab-left">API</p></th><th valign="top" class="calibre14"><p class="tab-left">Marshaller</p></th></tr></thead><tbody class="calibre15"><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">JAXB 2.0</p></td><td valign="top" class="calibre16"><p class="tab-leftt">org.springframework.oxm.jaxb.Jaxb2Marshaller</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">Castor</p></td><td valign="top" class="calibre16"><p class="tab-leftt">org.springframework.oxm.castor.CastorMarshaller</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">XMLBeans</p></td><td valign="top" class="calibre16"><p class="tab-leftt">org.springframework.oxm.xmlbeans.XmlBeansMarshaller</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">JiBX</p></td><td valign="top" class="calibre16"><p class="tab-leftt">org.springframework.oxm.jibx.JibxMarshaller</p></td></tr><tr class="noclass"><td valign="top" class="calibre16"><p class="tab-leftt">XStream</p></td><td valign="top" class="calibre16"><p class="tab-leftt">org.springframework.oxm.xstream.XStreamMarshaller</p></td></tr></tbody></table>
</div>
<p class="indent">Similarly, Spring WS clients can also use this same marshalling and unmarshalling technique to simplify XML data processing.</p>
<p id="Sec84" class="Heading1">How It Works</p>
<p id="Sec85" class="Heading2">Create Service Endpoints<a id="cXXX.1090" class="calibre6"></a> with XML Marshalling</p>
<p class="noindent">Spring-WS supports various XML marshalling APIs, including JAXB 2.0, Castor, XMLBeans, JiBX, and XStream. As an example, we’ll create a service endpoint using Castor (<span class="FontName"><a href="http://www.castor.org" class="calibre5">www.castor.org</a></span>) as the marshaller. Using other XML marshalling APIs is very similar.</p>
<p class="indent">The first step in using XML marshalling is creating the object model according to the XML message formats. This model can usually be generated by the marshalling API. For some marshalling APIs, the object model must be generated by them so that they can insert marshalling-specific information. Because Castor supports marshalling between XML messages and arbitrary Java objects, you can start creating the following classes by yourself.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class GetTemperaturesRequest {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String city;</span><br class="calibre10"/>    <span class="FontName">private List&lt;Date&gt; dates;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Constructors, Getters and Setters</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class GetTemperaturesResponse {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private List&lt;TemperatureInfo&gt; temperatures;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Constructors, Getters and Setters</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">With the object model created, you can easily integrate marshalling on any endpoint. Let’s apply this technique to the endpoint presented in the previous recipe.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Endpoint</span><br class="calibre10"/><span class="FontName">public class TemperatureMarshallingEndpoint {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private static final String namespaceUri = "</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">";</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">private WeatherService weatherService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void setWeatherService(WeatherService weatherService) {</span><br class="calibre10"/>        <span class="FontName">this.weatherService = weatherService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@PayloadRoot(localPart="GetTemperaturesRequest",namespace=namespaceUri)</span><br class="calibre10"/>    <span class="FontName">public GetTemperaturesResponse getTemperature(GetTemperaturesRequest request) {</span><br class="calibre10"/>        <span class="FontName">List&lt;TemperatureInfo&gt; temperatures = weatherService.getTemperatures(request.getCity(), request.getDates());</span><br class="calibre10"/>        <span class="FontName">return new GetTemperaturesResponse(temperatures);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Notice that all you have to do in this new method endpoint is handle the request object and return the response object. Then, it will be marshalled to the response XML message.</p>
<p class="indent">In addition to this endpoint modification, a marshalling endpoint also requires that both the <span class="FontName">marshaller</span> and <span class="FontName">unmarshaller</span> properties be set. Usually, you can specify a single marshaller for both properties. For Castor, you declare a <span class="FontName">CastorMarshaller</span> bean as the marshaller. Next to the marshaller we also need to register a <span class="FontName">MethodArgumentResolver</span> and <span class="FontName">MethodReturnValueHandler</span> to actually handle the marshalling of the method argument and return type. For this we extend the <span class="FontName">WsConfigurerAdapter</span> and override the <span class="FontName">addArgumentResolvers</span> and <span class="FontName">addReturnValueHandlers</span> methods and add the <span class="FontName">MarshallingPayloadMethodProcessor</span> to both the lists.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWs</span><br class="calibre10"/><span class="FontName">@ComponentScan("com.apress.springrecipes.weather")</span><br class="calibre10"/><span class="FontName">public class SpringWsConfiguration</span> <b class="calibre4">extends WsConfigurerAdapter</b> <span class="FontName">{</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MarshallingPayloadMethodProcessor marshallingPayloadMethodProcessor() {</span><br class="calibre10"/>        <span class="FontName">return new MarshallingPayloadMethodProcessor(marshaller());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public Marshaller marshaller() {</span><br class="calibre10"/>        <span class="FontName">CastorMarshaller marshaller = new CastorMarshaller();</span><br class="calibre10"/>        <span class="FontName">marshaller.setMappingLocation(new ClassPathResource("/mapping.xml"));</span><br class="calibre10"/>        <span class="FontName">return marshaller;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void addArgumentResolvers(List&lt;MethodArgumentResolver&gt; argumentResolvers) {</span><br class="calibre10"/>        <span class="FontName">argumentResolvers.add(marshallingPayloadMethodProcessor());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void addReturnValueHandlers(List&lt;MethodReturnValueHandler&gt; returnValueHandlers) {</span><br class="calibre10"/>        <span class="FontName">returnValueHandlers.add(marshallingPayloadMethodProcessor());</span><br class="calibre10"/>    <span class="FontName">}</span></pre>
<p class="indent">Note that Castor requires a mapping configuration file to know how to map objects to and from XML documents. You can create this file in the classpath root and specify it in the <span class="FontName">mappingLocation</span> property (e.g., mapping.xml). The following Castor mapping file defines the mappings for the <span class="FontName">GetTemperaturesRequest</span>, <span class="FontName">GetTemperaturesResponse</span>, and <span class="FontName">TemperatureInfo</span> classes:</p>
<pre class="calibre11"><span class="FontName">&lt;!DOCTYPE mapping PUBLIC "-//EXOLAB/Castor Mapping DTD Version 1.0//EN"</span><br class="calibre10"/>    <span class="FontName">"</span><span class="FontName"><a href="http://castor.org/mapping.dtd" class="calibre5">http://castor.org/mapping.dtd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;mapping&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;class name="com.apress.springrecipes.weather.GetTemperaturesRequest"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;map-to xml="GetTemperaturesRequest"</span><br class="calibre10"/>            <span class="FontName">ns-uri="</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;field name="city" type="string"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bind-xml name="city" node="element" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/field&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;field name="dates" collection="arraylist" type="string"</span><br class="calibre10"/>            <span class="FontName">handler="com.apress.springrecipes.weather.DateFieldHandler"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bind-xml name="date" node="element" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/field&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/class&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;class name="com.apress.springrecipes.weather.<img src="../images/00053.jpeg" alt="image" class="calibre3"/></span><br class="calibre10"/>    <span class="FontName">GetTemperaturesResponse"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;map-to xml="GetTemperaturesResponse"</span><br class="calibre10"/>            <span class="FontName">ns-uri="</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;field name="temperatures" collection="arraylist"</span><br class="calibre10"/>            <span class="FontName">type="com.apress.springrecipes.weather.TemperatureInfo"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bind-xml name="TemperatureInfo" node="element" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/field&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/class&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;class name="com.apress.springrecipes.weather.TemperatureInfo"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;map-to xml="TemperatureInfo"</span><br class="calibre10"/>            <span class="FontName">ns-uri="</span><span class="FontName"><a href="http://springrecipes.apress.com/weather/schemas" class="calibre5">http://springrecipes.apress.com/weather/schemas</a></span><span class="FontName">" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;field name="city" type="string"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bind-xml name="city" node="attribute" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/field&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;field name="date" type="string"</span><br class="calibre10"/>            <span class="FontName">handler="com.apress.springrecipes.weather.DateFieldHandler"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bind-xml name="date" node="attribute" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/field&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;field name="min" type="double"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bind-xml name="min" node="element" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/field&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;field name="max" type="double"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bind-xml name="max" node="element" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/field&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;field name="average" type="double"&gt;</span><br class="calibre10"/>            <span class="FontName">&lt;bind-xml name="average" node="element" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;/field&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/class&gt;</span><br class="calibre10"/><span class="FontName">&lt;/mapping&gt;</span></pre>
<p class="indent">In addition, in all the date fields you have to specify a handler to convert the dates with a particular date format. This handler is shown next:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.exolab.castor.mapping.GeneralizedFieldHandler;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class DateFieldHandler extends GeneralizedFieldHandler {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private DateFormat format = new SimpleDateFormat("yyyy-MM-dd");</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Object convertUponGet(Object value) {</span><br class="calibre10"/>        <span class="FontName">return format.format((Date) value);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Object convertUponSet(Object value) {</span><br class="calibre10"/>        <span class="FontName">try {</span><br class="calibre10"/>            <span class="FontName">return format.parse((String) value);</span><br class="calibre10"/>        <span class="FontName">} catch (ParseException e) {</span><br class="calibre10"/>            <span class="FontName">throw new RuntimeException(e);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public Class getFieldType() {</span><br class="calibre10"/>        <span class="FontName">return Date.class;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec86" class="Heading2">Invoking Web Services<a id="cXXX.1091" class="calibre6"></a> with XML Marshalling</p>
<p class="noindent">A Spring-WS client can also marshal and unmarshal the request and response objects to and from XML messages. As an example, we will create a client using Castor as the marshaller so that you can reuse the object models <span class="FontName">GetTemperaturesRequest</span>, <span class="FontName">GetTemperaturesResponse</span>, and <span class="FontName">TemperatureInfo</span>, and the mapping configuration file, mapping.xml, from the service endpoint.</p>
<p class="indent">Let’s implement the service proxy with XML marshalling. <span class="FontName">WebServiceTemplate</span> provides a <span class="FontName">marshalSendAndReceive()</span> method that accepts a request object as the method argument, which will be marshalled to the request message. This method has to return a response object that will be unmarshalled from the response message.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.weather;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class WeatherServiceProxy implements WeatherService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">public void setWebServiceTemplate(WebServiceTemplate webServiceTemplate) {</span><br class="calibre10"/>        <span class="FontName">this.webServiceTemplate = webServiceTemplate;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public WebServiceTemplate getWebServiceTemplate() {</span><br class="calibre10"/>        <span class="FontName">return webServiceTemplate;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public List&lt;TemperatureInfo&gt; getTemperatures(String city, List&lt;Date&gt; dates) {</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">GetTemperaturesRequest request = new GetTemperaturesRequest(city, dates);</span><br class="calibre10"/>        <span class="FontName">GetTemperaturesResponse response = (GetTemperaturesResponse) getWebServiceTemplate().marshalSendAndReceive(request);</span><br class="calibre10"/>        <span class="FontName">return response.getTemperatures();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">When you are using XML marshalling, <span class="FontName">WebServiceTemplate</span> requires both the <span class="FontName">marshaller</span> and <span class="FontName">unmarshaller</span> properties to be set. You can also set them to <span class="FontName">WebServiceGatewaySupport</span> if you extend this class to have <span class="FontName">WebServiceTemplate</span> auto-created. Usually, you can specify a single marshaller for both properties. For Castor, you declare a <span class="FontName">CastorMarshaller</span> bean as the marshaller.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class SpringWsClientConfiguration {</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public WebServiceTemplate webServiceTemplate() {</span><br class="calibre10"/>        <span class="FontName">WebServiceTemplate webServiceTemplate =</span> <b class="calibre4">new WebServiceTemplate(marshaller());</b><br class="calibre10"/>        <span class="FontName">webServiceTemplate.setDefaultUri("</span><span class="FontName">http://localhost:8080/springws/services</span><span class="FontName">");</span><br class="calibre10"/>        <span class="FontName">return webServiceTemplate;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public Marshaller marshaller() {</span><br class="calibre10"/>        <span class="FontName">CastorMarshaller marshaller = new CastorMarshaller();</span><br class="calibre10"/>        <span class="FontName">marshaller.setMappingLocation(new ClassPathResource("/mapping.xml"));</span><br class="calibre10"/>        <span class="FontName">return marshaller</span><span class="FontName">;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec87" class="Heading">Summary</p>
<p class="noindent">This chapter discussed JMX and a few of the surrounding specifications. You learned how to export Spring beans as JMX MBeans and how to use those MBeans from a client, both remotely and locally by using Spring’s proxies. You published and listened to notification events on a JMX server from Spring.</p>
<p class="indent">You also learned how to do e-mail tasks with the aid of Spring, including how to create e-mail templates and send emails with attachments (MIME messages). You also learned how to schedule tasks using the Quartz Scheduler, as well as Spring’s task namespace.</p>
<p class="indent">This chapter also introduced you to the various remoting technologies supported by Spring. You learned how to both publish and consume an RMI<a id="cXXX.1092" class="calibre5"></a> service. We also discussed how to build services that operate through HTTP, using three different techniques/protocols: Burlap, Hessian, and HTTPInovker. Next, we discussed SOAP web services and how to use JAX-WS, as well as the Apache CXF framework to build and consume these types of services. Finally, we discussed contract first SOAP web services and how to leverage Spring-WS to create and consume these types of services.</p></div>
</body></html>
