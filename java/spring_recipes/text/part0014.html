<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Chapter 4 Spring @MVC</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre"><p class="ChapterNumber"><a id="b9781430259084_4" class="calibre6"></a>CHAPTER 4</p>
<p class="Chapimage"><img src="../images/00008.jpeg" alt="image" class="calibre3"/></p>
<p class="ChapterTitle">Spring @MVC</p>
<div class="calibre10"><p class="noindent">MVC is one of the most important modules of the Spring framework. It builds on the powerful Spring IoC container and makes extensive use of the container features to simplify its configuration.</p>
<p class="indent"><i class="calibre8">Model-view-controller (MVC</i><a id="cXXX.342" class="calibre5"></a>)<a id="cXXX.2120" class="calibre5"></a> is a common design pattern in UI design. It decouples business logic from UIs by separating the roles of model, view, and controller in an application. <i class="calibre8">Models</i> are responsible for encapsulating application data for views to present. <i class="calibre8">Views</i> should only present this data, without including any business logic. <i class="calibre8">Controllers</i> are responsible for receiving requests from users and invoking back-end services for business processing. After processing, back-end services may return some data for views to present. Controllers collect this data and prepare models for views to present. The core idea of the MVC pattern is to separate business logic from UIs to allow them to change independently without affecting each other.</p>
<p class="indent">In a Spring MVC application, models usually consist of domain objects that are processed by the service layer and persisted by the persistence layer. Views are usually JSP templates written with Java Standard Tag Library (JSTL).<a id="cXXX.343" class="calibre5"></a> However, it’s also possible to define views as PDF files<a id="cXXX.344" class="calibre5"></a>, Excel files<a id="cXXX.345" class="calibre5"></a>, RESTful web services or even Flex interfaces the last of which are often dubbed a Rich Internet Application (RIA).<a id="cXXX.346" class="calibre5"></a></p>
<p class="indent">Upon finishing this chapter, you will be able to develop Java web applications using Spring MVC. You will also understand Spring MVC’s common controller and view types, including, what has become the de facto use of annotations for creating controllers as of Spring 3.0. Moreover, you will understand the basic principles of Spring MVC, which will serve as the foundations for more advanced topics covered in the upcoming chapters.</p>
<p id="Sec1" class="Heading">4-1. Developing a Simple Web Application<a id="cXXX.347" class="calibre6"></a> with Spring MVC</p>
<p id="Sec2" class="Heading1">Problem</p>
<p class="noindent">You want to develop a simple web application with Spring MVC to learn the basic concepts and configurations<a id="cXXX.348" class="calibre5"></a> of this framework.</p>
<p id="Sec3" class="Heading1">Solution</p>
<p class="noindent">The central component of Spring MVC is a controller. In the simplest Spring MVC application, a controller is the only servlet you need to configure in a Java web deployment descriptor (i.e., the <span class="FontName">web.xml</span> file or a <span class="FontName">ServletContainerInitializer</span>). A Spring MVC controller—often referred to as a Dispatcher Servlet—implements one of Sun’s core Java EE design patterns called <i class="calibre8">front controller</i><a id="cXXX.349" class="calibre5"></a>. It acts as the front controller of the Spring MVC framework, and every web request must go through it so that it can manage the entire request-handling process.</p>
<p class="indent">When a web request is sent to a Spring MVC application, a controller first receives the request. Then it organizes the different components configured in Spring’s web application context or annotations present in the controller itself, all needed to handle the request. <a id="_Fig1" href="part0014.html#Fig1" class="calibre5">Figure 4-1</a> shows the primary flow of request handling in Spring MVC.</p>
<div class="Figure" id="Fig1"><p class="img1"><img src="../images/00052.jpeg" alt="9781430259084_Fig04-01.jpg" class="calibre3"/></p>
<p class="FigCapt"><span class="calibre4"><a href="part0014.html#_Fig1" class="calibre5">Figure 4-1</a>.</span> Primary flow of request handling<a id="cXXX.350" class="calibre5"></a> in Spring MVC</p></div>
<p class="indent">To define a controller class in Spring 4.0, a class has to be marked with the <span class="FontName">@Controller</span> annotation. In contrast to other framework controllers or earlier Spring versions, an annotated controller class need not implement a framework-specific interface or extend a framework-specific base class.</p>
<p class="indent">For example, prior to Spring 3.0 one of a series of classes, such as <span class="FontName">AbstractController</span>, were used to give a class the behavior of a Dispatcher Servlet. Starting from Spring 2.5, annotated classes for defining Dispatcher Servlets became available. As of Spring 3.0, these series of classes for giving a class the behavior of a Dispatcher Servlet have been deprecated in favor of annotated classes.</p>
<p class="indent">When a <span class="FontName">@Controller</span><a id="cXXX.351" class="calibre5"></a> annotated class (i.e., a controller class) receives a request, it looks for an appropriate handler method to handle the request. This requires that a controller class map each request to a handler method by one or more handler mappings. In order to do so, a controller class’s methods are decorated with the <span class="FontName">@RequestMapping</span> annotation<a id="cXXX.352" class="calibre5"></a>, making them handler methods.</p>
<p class="indent">The signature for these handler methods—as you can expect from any standard class—is open ended. You can specify an arbitrary name for a handler method and define a variety of method arguments. Equally, a handler method can return any of a series of values (e.g., <span class="FontName">String</span> or <span class="FontName">void</span>), depending on the application logic it fulfills.</p>
<p class="indent">As the book progresses, you will encounter the various method arguments that can be used in handler methods using the <span class="FontName">@RequestMapping</span> annotation. The following is only a partial list of valid argument types, just to give you an idea.</p>
<ul class="bulleted"><li class="calibre17"><span class="FontName">HttpServletRequest</span> or <span class="FontName">HttpServleResponse</span></li>
<li class="calibre17">Request parameters of arbitrary type, annotated with <span class="FontName">@RequestParam</span></li>
<li class="calibre17">Model attributes of arbitrary type, annotated with <span class="FontName">@ModelAttribute</span></li>
<li class="calibre17">Cookie values included in an incoming request, annotated with <span class="FontName">@CookieValue</span></li>
<li class="calibre17"><span class="FontName">Map</span> or <span class="FontName">ModelMap</span>, for the handler method to add attributes to the model</li>
<li class="calibre17"><span class="FontName">Errors</span> or <span class="FontName">BindingResult</span>, for the handler method to access the binding and validation result for the command object</li>
<li class="calibre17"><span class="FontName">SessionStatus</span>, for the handler method to notify its completion of session processing</li></ul>
<p class="indent">Once the controller class has picked an appropriate handler method, it invokes the handler method’s logic with the request. Usually, a controller’s logic invokes back-end services to handle the request. In addition, a handler method’s logic is likely to add or remove information from the numerous input arguments (e.g., <span class="FontName">HttpServletRequest</span>, <span class="FontName">Map</span>, <span class="FontName">Errors</span>, or <span class="FontName">SessionStatus</span>) that will form part of the ongoing Spring MVC flow.</p>
<p class="indent">After a handler method has finished processing the request, it delegates control to a view, which is represented as the handler method’s return value. To provide a flexible approach, a handler method’s return value doesn’t represent a view’s implementation (e.g., <span class="FontName">user.jsp</span> or <span class="FontName">report.pdf</span>) but rather a <i class="calibre8">logical</i> view (e.g., <span class="FontName">user</span> or <span class="FontName">report</span>)—note the lack of file extension.</p>
<p class="indent">A handler method’s return value can be either a <span class="FontName">String—</span>representing a logical view name—or <span class="FontName">void</span>, in which case a default logical view name is determined on the basis of a handler method’s or controller’s name.</p>
<p class="indent">In order to pass information from a controller to a view, it’s irrelevant that a handler’s method returns a logical view name—<span class="FontName">String</span> or a <span class="FontName">void—</span>since the handler method input arguments will be available to a view.</p>
<p class="indent">For example, if a handler method<a id="cXXX.353" class="calibre5"></a> takes a <span class="FontName">Map</span> and <span class="FontName">SessionStatus</span> objects as input parameters—modifying their contents inside the handler method’s logic—these same objects will be accessible to the view returned by the handler method.</p>
<p class="indent">When the controller class receives a view, it resolves the <i class="calibre8">logical</i> view name into a specific view implementation (e.g., <span class="FontName">user.jsp</span> or <span class="FontName">report.pdf</span>) by means of a view resolver. A view resolver is a bean configured in the web application context that implements the <span class="FontName">ViewResolver</span> interface. Its responsibility is to return a specific view implementation (HTML, JSP, PDF, or other) for a logical view name.</p>
<p class="indent">Once the controller class has resolved a view name into a view implementation, per the view implementation’s design, it renders the objects (e.g., <span class="FontName">HttpServletRequest</span>, <span class="FontName">Map</span>, <span class="FontName">Errors</span>, or <span class="FontName">SessionStatus</span>) passed by the controller’s handler method. The view’s responsibility is to display the objects added in the handler method’s logic to the user.</p>
<p id="Sec4" class="Heading1">How It Works</p>
<p class="noindent">Suppose you are going to develop a court reservation system for a sports center. The UIs of this application are web-based so that users can make online reservations through the Internet. You want to develop this application using Spring MVC. First of all, you create the following domain classes in the <span class="FontName">domain</span> subpackage<a id="cXXX.354" class="calibre5"></a>:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.domain;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class Reservation {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String courtName;</span><br class="calibre10"/>    <span class="FontName">private Date date;</span><br class="calibre10"/>    <span class="FontName">private int hour;</span><br class="calibre10"/>    <span class="FontName">private Player player;</span><br class="calibre10"/>    <span class="FontName">private SportType sportType;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Constructors, Getters and Setters</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">package com.apress.springrecipes.court.domain;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class Player {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String name;</span><br class="calibre10"/>    <span class="FontName">private String phone;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Constructors, Getters and Setters</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">package com.apress.springrecipes.court.domain;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class SportType {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private int id;</span><br class="calibre10"/>    <span class="FontName">private String name;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Constructors, Getters and Setters</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Then you define the following service interface in the <span class="FontName">service</span> subpackage to provide reservation services to the presentation layer:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public interface ReservationService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public List&lt;Reservation&gt; query(String courtName);</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In a production application, you should implement this interface with database persistence. But for simplicity’s sake, you can store the reservation records in a list and hard-code several reservations for testing purposes:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class ReservationServiceImpl implements ReservationService {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public static final SportType TENNIS = new SportType(1, "Tennis");</span><br class="calibre10"/>    <span class="FontName">public static final SportType SOCCER = new SportType(2, "Soccer");</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private List&lt;Reservation&gt; reservations;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public ReservationServiceImpl() {</span><br class="calibre10"/>        <span class="FontName">reservations = new ArrayList&lt;&gt;();</span><br class="calibre10"/>        <span class="FontName">reservations.add(new Reservation("Tennis #1",</span><br class="calibre10"/>                <span class="FontName">new GregorianCalendar(2008, 0, 14).getTime(), 16,</span><br class="calibre10"/>                <span class="FontName">new Player("Roger", "N/A"), TENNIS));</span><br class="calibre10"/>        <span class="FontName">reservations.add(new Reservation("Tennis #2",</span><br class="calibre10"/>                <span class="FontName">new GregorianCalendar(2008, 0, 14).getTime(), 20,</span><br class="calibre10"/>                <span class="FontName">new Player("James", "N/A"), TENNIS));</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public List&lt;Reservation&gt; query(String courtName) {</span><br class="calibre10"/>        <span class="FontName">List&lt;Reservation&gt; result = new ArrayList&lt;&gt;();</span><br class="calibre10"/>        <span class="FontName">for (Reservation reservation : reservations) {</span><br class="calibre10"/>            <span class="FontName">if (reservation.getCourtName().equals(courtName)) {</span><br class="calibre10"/>                <span class="FontName">result.add(reservation);</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">return result;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p id="Sec5" class="Heading2">Setting up a Spring MVC Application</p>
<p class="noindent">Next, you need to create a Spring MVC application layout. In general, a web application developed with Spring MVC is set up in the same way as a standard Java web application, except that you have to add a couple of configuration files and required libraries specific to Spring MVC.</p>
<p class="indent">The Java EE specification<a id="cXXX.355" class="calibre5"></a> defines the valid directory structure of a Java web application made up of a Web Archive or WAR file. For example, you have to provide a web deployment descriptor (i.e., <span class="FontName">web.xml</span>) in the <span class="FontName">WEB-INF</span> root or 1 or more classes implementing <span class="FontName">ServletContainerInitializer</span>. The class files and JAR files for this web application should be put in the <span class="FontName">WEB-INF/classes</span> and <span class="FontName">WEB-INF/lib</span> directories, respectively.</p>
<p class="indent">For your court reservation system, you create the following directory structure. Note that the highlighted files are Spring-specific configuration files.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To develop a web application with Spring MVC, you<a id="cXXX.356" class="calibre5"></a> have to add all the normal Spring dependencies (see <a href="part0009.html" class="calibre5">Chapter 1</a> for more information) as well as the Spring Web and Spring MVC dependencies to your CLASSPATH. If you are using Maven, add the following dependencies to your Maven Project:</p>
<pre class="calibre19"><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;${spring.version}&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span><br class="calibre2"/><br class="calibre2"/>  <span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;spring-web&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;${spring.version}&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span></pre></div>
<pre class="calibre11"><span class="FontName">court/</span><br class="calibre10"/>    <span class="FontName">css/</span><br class="calibre10"/>    <span class="FontName">images/</span><br class="calibre10"/>    <span class="FontName">WEB-INF/</span><br class="calibre10"/>        <span class="FontName">classes/</span><br class="calibre10"/>        <span class="FontName">lib/*.jar</span><br class="calibre10"/>        <span class="FontName">jsp/</span><br class="calibre10"/>            <span class="FontName">welcome.jsp</span><br class="calibre10"/>            <span class="FontName">reservationQuery.jsp</span><br class="calibre10"/>        <b class="calibre4">court-service.xml</b><br class="calibre10"/>        <b class="calibre4">court-servlet.xml</b><br class="calibre10"/>        <span class="FontName">web.xml</span></pre>
<p class="indent">The files outside the <span class="FontName">WEB-INF</span> directory are directly accessible to users via URLs, so the CSS files and image files must be put there. When using Spring MVC, the JSP files act as templates. They are read by the framework for generating dynamic content, so the JSP files should be put inside the <span class="FontName">WEB-INF</span> directory to prevent direct access to them. However, some application servers don’t allow the files inside <span class="FontName">WEB-INF</span> to be read by a web application internally. In that case, you can only put them outside the <span class="FontName">WEB-INF</span> directory.</p>
<p id="Sec6" class="Heading2">Creating the Configuration Files</p>
<p class="noindent">The web deployment descriptor <span class="FontName">web.xml</span> is the essential configuration file<a id="cXXX.357" class="calibre5"></a> for a Java web application. In this file, you define the servlets for your application and how web requests are mapped to them. For a Spring MVC application, you only have to define a single <span class="FontName">DispatcherServlet</span> instance that acts as the front controller for Spring MVC, although you are allowed to define more than one if required.</p>
<p class="indent">In large applications, it can be convenient to use multiple <span class="FontName">DispatcherServlet</span> instances. This allows <span class="FontName">DispatcherServlet</span><a id="cXXX.358" class="calibre5"></a> instances to be designated to specific URLs, making code management easier and letting individual team members work on an application’s logic without getting in each other’s way.</p>
<pre class="calibre11"><span class="FontName">&lt;web-app version="3.0"  xmlns="</span><span class="FontName"><a href="http://java.sun.com/xml/ns/j2ee" class="calibre5">http://java.sun.com/xml/ns/j2ee</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://java.sun.com/xml/ns/j2ee" class="calibre5">http://java.sun.com/xml/ns/j2ee</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://java.sun.com/xml/ns/j2ee/web-app_3_0.xsd" class="calibre5">http://java.sun.com/xml/ns/j2ee/web-app_3_0.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;display-name&gt;Court Reservation System&lt;/display-name&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;servlet&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;servlet-name&gt;court&lt;/servlet-name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;servlet-class&gt;</span><br class="calibre10"/>            <span class="FontName">org.springframework.web.servlet.DispatcherServlet</span><br class="calibre10"/>        <span class="FontName">&lt;/servlet-class&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/servlet&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;servlet-mapping&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;servlet-name&gt;court&lt;/servlet-name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;url-pattern&gt;/&lt;/url-pattern&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/servlet-mapping&gt;</span><br class="calibre10"/><span class="FontName">&lt;/web-app&gt;</span></pre>
<p class="indent">In this web deployment descriptor, you define a servlet of type <span class="FontName">DispatcherServlet</span>.<a id="cXXX.359" class="calibre5"></a> This is the core servlet class in Spring MVC that receives web requests and dispatches them to appropriate handlers. You set this servlet’s name to <span class="FontName">court</span> and map all URLs using a <span class="FontName">/</span> (slash), with the slash representing the root directory. Note that the URL pattern can be set to more granular patterns. In larger application’s it can make more sense to delegate patterns among various servlets, but for simplicity all URLs in the application are delegated to the single <span class="FontName">court</span> servlet.</p>
<p class="indent">Another purpose of the servlet name is for <span class="FontName">DispatcherServlet</span> to decide which file to load for Spring MVC configurations. By default, a look is made for a file by joining the servlet name with <span class="FontName">-servlet.xml</span> as the file name. You can explicitly specify a configuration file in the <span class="FontName">contextConfigLocation</span><a id="cXXX.360" class="calibre5"></a> servlet parameter. With the preceding setting, the <span class="FontName">court</span> servlet loads the Spring MVC configuration file <span class="FontName">court-servlet.xml</span> by default. This file should be a standard Spring bean configuration file, as shown in the following:</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">Later, you can configure Spring MVC with a series of Spring beans declared in this configuration file. You may also declare other application components such as data access objects and service objects in this file. However, it’s not a good practice to mix beans of different layers in a single configuration file. Instead, you should declare one bean configuration file per layer (e.g., <span class="FontName">court-persistence.xml</span> for the persistence layer and <span class="FontName">court-service.xml</span> for the service layer). For example, <span class="FontName">court-service.xml</span><a id="cXXX.361" class="calibre5"></a> should include the following service object:</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="reservationService"</span><br class="calibre10"/>        <span class="FontName">class="com.apress.springrecipes.court.service.ReservationServiceImpl" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">In order for Spring to load your configuration files besides <span class="FontName">court-servlet.xml</span>, you need to define the servlet listener <span class="FontName">ContextLoaderListener</span> in <span class="FontName">web.xml</span>.<a id="cXXX.362" class="calibre5"></a> By default, it loads the bean configuration file <span class="FontName">/WEB-INF/applicationContext.xml</span>, but you can specify your own in the context parameter <span class="FontName">contextConfigLocation</span>. You can specify multiple configuration files by separating their locations with either commas or spaces.</p>
<pre class="calibre11"><span class="FontName">&lt;web-app ...&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;context-param&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;param-value&gt;/WEB-INF/court-service.xml&lt;/param-value&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/context-param&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;listener&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;listener-class&gt;</span><br class="calibre10"/>            <b class="calibre4">org.springframework.web.context.ContextLoaderListener</b><br class="calibre10"/>        <span class="FontName">&lt;/listener-class&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/listener&gt;</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/web-app&gt;</span></pre>
<p class="indent">Note that <span class="FontName">ContextLoaderListener</span> loads the specified bean configuration files into the root application context, while each <span class="FontName">DispatcherServlet</span> instance loads its configuration file into its own application context and refers to the root application context as its parent. So, the context loaded by each <span class="FontName">DispatcherServlet</span> instance can access and even override beans declared in the root application context (but not vice versa). However, the contexts loaded by the <span class="FontName">DispatcherServlet</span> instances cannot access each other.</p>
<p id="Sec7" class="Heading2">Activating Spring MVC annotation scanning<a id="cXXX.363" class="calibre6"></a></p>
<p class="noindent">Before you create an application’s controllers, you have to set up the web application for classes to be scanned for the presence of <span class="FontName">@Controller</span> and <span class="FontName">@RequestMapping</span> annotations. Only then can they operate as controllers. First, for Spring to auto-detect annotations, you have to enable Spring’s component scanning feature through the <span class="FontName">&lt;context:component-scan&gt;</span> element.</p>
<p class="indent">In addition to this statement, since Spring MVC’s <span class="FontName">@RequestMapping</span> annotation maps URL requests to controller classes and their corresponding handler methods, this requires additional statements in a web application’s context. To make this work, you have to register a <span class="FontName">RequestMappingHandlerMapping</span> instance and an <span class="FontName">RequestMappingHandlerAdapter</span> instance in the web application context. These instances process the <span class="FontName">@RequestMapping</span> annotations at the class level and the method level, respectively.</p>
<p class="indent">To enable support for annotation-based controllers, include the following configuration in the <span class="FontName">court-servlet.xml</span> file:</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <b class="calibre4">xmlns:context="</b><b class="calibre4"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></b><b class="calibre4">"</b><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><br class="calibre10"/>        <b class="calibre4"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></b><br class="calibre10"/>        <b class="calibre4"><a href="http://www.springframework.org/schema/context/spring-context.xsd" class="calibre5">http://www.springframework.org/schema/context/spring-context.xsd</a></b><b class="calibre4">"&gt;</b><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">&lt;context:component-scan</b><br class="calibre10"/>        <b class="calibre4">base-package="com.apress.springrecipes.court.web" /&gt;</b>  <br class="calibre10"/>    <span class="FontName">&lt;bean class="org.springframework.web.servlet.mvc.method.annotation.</span>       <b class="calibre4">RequestMappingHandlerMapping" /&gt;</b>  <br class="calibre10"/>    <span class="FontName">&lt;bean class="org.springframewo</span><span class="FontName">rk.web.servlet.mvc.method.annotation.</span>    <b class="calibre4">RequestMappingHandlerAdapter</b><span class="FontName">" /&gt;</span>  <br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">Notice the element <span class="FontName">&lt;context:component-scan&gt;</span> with a <span class="FontName">base-package</span> value of <span class="FontName">com.apress.springrecipes.court.web</span>. This package corresponds to the same one used in the Spring MVC controller, which is illustrated next.</p>
<p class="indent">Next, the <span class="FontName">RequestMappingHandlerMapping</span> and <span class="FontName">RequestMappingHandlerAdapter</span> bean classes are preregistered in the web application context by default.</p>
<p class="indent">Once you have the basic context configuration file for scanning Spring MVC annotations, you can proceed to creating the controller class itself, as well as finishing the configuration set-up for <span class="FontName">court-servlet.xml</span>.</p>
<p id="Sec8" class="Heading2">Creating Spring MVC Controllers</p>
<p class="noindent">An annotation-based controller class can be an arbitrary class that doesn’t implement a particular interface or extend a particular base class. You can annotate it with the <span class="FontName">@Controller</span> annotation<a id="cXXX.364" class="calibre5"></a>. There can be one or more handler methods defined in a controller to handle single or multiple actions. The signature of the handler methods is flexible enough to accept a range of arguments.</p>
<p class="indent">The <span class="FontName">@RequestMapping</span> annotation can be applied to the class level or the method level. The first mapping strategy is to map a particular URL pattern to a controller class, and then a particular HTTP method to each handler method:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.stereotype.Controller;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.bind.annotation.RequestMapping;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.bind.annotation.RequestMethod;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.ModelAndView;</span><br class="calibre10"/><span class="FontName">import org.springframework.ui.Model;</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">@Controller</b><br class="calibre10"/><b class="calibre4">@RequestMapping("/welcome")</b><br class="calibre10"/><span class="FontName">public class WelcomeController {</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@RequestMapping(method = RequestMethod.GET)</b><br class="calibre10"/>    <span class="FontName">public String welcome(Model model) {</span><br class="calibre10"/>        <span class="FontName">Date today = new Date();</span><br class="calibre10"/>        <span class="FontName">model.addAttribute("today", today);</span><br class="calibre10"/>        <span class="FontName">return "welcome";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This controller creates a <span class="FontName">java.util.Date</span><a id="cXXX.365" class="calibre5"></a> object to retrieve the current date, and then adds it to the input <span class="FontName">Model</span> object as an attribute so the target view can display it.</p>
<p class="indent">Since you’ve already activated annotation scanning on the <span class="FontName">com.apress.springrecipes.court.web</span> package declared inside the <span class="FontName">court-servlet.xml</span> file, the annotations for the controller class are detected upon deployment.</p>
<p class="indent">The <span class="FontName">@Controller</span> annotation defines the class as a Spring MVC controller. The <span class="FontName">@RequestMapping</span> annotation is more interesting since it contains properties and can be declared at the class or handler method level. The first value used in this class— <span class="FontName">("/welcome")—</span>is used to specify the URL on which the controller is actionable, meaning any request received on the <span class="FontName">/welcome</span> URL is attended by the <span class="FontName">WelcomeController</span> class.</p>
<p class="indent">Once a request is attended by the controller class, it delegates the call to the default HTTP <span class="FontName">GET</span><a id="cXXX.366" class="calibre5"></a> handler method declared in the controller. The reason for this behavior is that every initial request made on a URL is of the HTTP <span class="FontName">GET</span> kind. So when the controller attends a request on the <span class="FontName">/welcome</span> URL it subsequently delegates to the default HTTP <span class="FontName">GET</span> handler method for processing.</p>
<p class="indent">The annotation <span class="FontName">@RequestMapping</span><a id="cXXX.367" class="calibre5"></a><span class="FontName">(method = RequestMethod.GET)</span> is used to decorate the <span class="FontName">welcome</span> method as the controller’s default HTTP <span class="FontName">GET</span> handler method. It’s worth mentioning that if no default HTTP <span class="FontName">GET</span> handler method is declared, a <span class="FontName">ServletException</span> is thrown. Hence the importance of a Spring MVC controller having at a minimum a URL route and default HTTP <span class="FontName">GET</span> handler method.</p>
<p class="indent">Another variation to this approach can be declaring both values—URL route and default HTTP <span class="FontName">GET</span> handler method—in the <span class="FontName">@RequestMapping</span> annotation used at the method level. This declaration is illustrated next:</p>
<pre class="calibre11"><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">public class WelcomeController {</span><br class="calibre10"/><br class="calibre10"/><b class="calibre4">@RequestMapping(value = "/welcome", method=RequestMethod.GET)</b><br class="calibre10"/><span class="FontName">public String welcome(Model model) {</span><br class="calibre10"/><span class="FontName">...</span></pre>
<p class="indent">This last declaration is equivalent to the earlier one. The <span class="FontName">value</span> attribute indicates the URL to which the handler method is mapped and the <span class="FontName">method</span> attribute defines the handler method as the controller’s default HTTP <span class="FontName">GET</span> method<a id="cXXX.368" class="calibre5"></a>.</p>
<p class="indent">This last controller illustrates the basic principles of Spring MVC. However, a typical controller may invoke back-end services for business processing. For example, you can create a controller for querying reservations of a particular court as follows:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.court.domain.Reservation;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.court.service.ReservationService;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.annotation.Autowired;</span><br class="calibre10"/><span class="FontName">import org.springframework.stereotype.Controller;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.bind.annotation.RequestMapping;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.bind.annotation.RequestMethod;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.web.bind.annotation.RequestParam;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.ui.Model;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">@RequestMapping("/reservationQuery")</span><br class="calibre10"/><span class="FontName">public class ReservationQueryController {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private ReservationService reservationService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public void ReservationQueryController(ReservationService reservationService) {</span><br class="calibre10"/>        <span class="FontName">this.reservationService = reservationService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.GET)</span><br class="calibre10"/>    <span class="FontName">public void setupForm() {</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.POST)</span><br class="calibre10"/>    <span class="FontName">public String sumbitForm(@RequestParam("courtName") String courtName,Model model) {</span><br class="calibre10"/>        <span class="FontName">List&lt;Reservation&gt; reservations = java.util.Collections.emptyList();</span><br class="calibre10"/>        <span class="FontName">if (courtName != null) {</span><br class="calibre10"/>            <span class="FontName">reservations = reservationService.query(courtName);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">model.addAttribute("reservations", reservations);</span><br class="calibre10"/>        <span class="FontName">return "reservationQuery";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This controller equally relies on the <span class="FontName">@Controller</span> annotation to indicate the class in question is a Spring MVC controller. A new addition though is the <span class="FontName">@Autowired</span> annotation<a id="cXXX.369" class="calibre5"></a> assigned to the class’s constructor. This allows a class’s constructor to instantiate its fields from declarations made in the application’s configuration files (i.e., <span class="FontName">court-service.xml</span>). So for example, in this last controller an attempt is made to locate a bean named <span class="FontName">reservationService</span> to instantiate the field by the same name.</p>
<p class="indent">If you recall from earlier, the <span class="FontName">court-service.xml</span> file<a id="cXXX.370" class="calibre5"></a> was used to define a service bean by this same name. This allows the service bean to be injected into the controller class and assigned to the field implicitly. Without the <span class="FontName">@Autowired</span> annotation, the service bean can be injected explicitly inside the <span class="FontName">court-servlet.xml</span> configuration using a statement like the following:</p>
<pre class="calibre11"><span class="FontName">&lt;bean</span> <br class="calibre10"/>    <span class="FontName">class="com.apress.springrecipes.court.web.ReservationQueryController"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property name="reservationService" ref="reservationService" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/bean&gt;</span></pre>
<p class="indent">Thus the <span class="FontName">@Autowired</span> annotation saves you time by not having to inject properties using XML. Continuing with the controller class statements, you can find the <span class="FontName">@RequestMapping("/reservationQuery")</span> statement used to indicate that any request on the <span class="FontName">/reservationQuery</span> URL be attended by the controller.</p>
<p class="indent">As outlined earlier, the controller then looks for a default HTTP <span class="FontName">GET</span> handler method. Since the public void <span class="FontName">setupForm()</span> method<a id="cXXX.371" class="calibre5"></a> is assigned the necessary <span class="FontName">@RequestMapping</span> annotation for this purpose, it’s called next.</p>
<p class="indent">Unlike the previous default HTTP <span class="FontName">GET</span> handler method, notice that this method has no input parameters, no logic, and has a <span class="FontName">void</span> return value. This means two things. By having no input parameters and no logic, a view only displays data hard-coded in the implementation template (e.g., JSP), since no data is being added by the controller. By having a <span class="FontName">void</span> return value, a default view name based on the request URL is used, therefore since the requesting URL is <span class="FontName">/reservationQuery</span> a return view named <span class="FontName">reservationQuery</span> is assumed.</p>
<p class="indent">The remaining handler method is decorated with the <span class="FontName">@RequestMapping(method = RequestMethod.POST)</span> annotation. At first sight, having two handler methods with only the class level <span class="FontName">/reservationQuery</span> URL statement can be confusing, but it’s really simple. One method is invoked when HTTP <span class="FontName">GET</span> requests are made on the <span class="FontName">/reservationQuery</span> URL, the other when HTTP <span class="FontName">POST</span> requests are made on the same URL.</p>
<p class="indent">The majority of requests in web applications are of the HTTP <span class="FontName">GET</span> kind, where as requests of the HTTP <span class="FontName">POST</span> kind are generally made when a user submits an HTML form. So revealing more of the application’s view (which we will describe shortly), one method is called when the HTML form is initially loaded (i.e., HTTP <span class="FontName">GET</span>), where as the other is called when the HTML form is submitted (i.e., HTTP <span class="FontName">POST</span>).</p>
<p class="indent">Looking closer at the HTTP <span class="FontName">POST</span><a id="cXXX.372" class="calibre5"></a> default handler method, notice the two input parameters. First the <span class="FontName">@RequestParam("courtName") String courtName</span> declaration, used to extract a request parameter named <span class="FontName">courtName</span>. In this case, the HTTP <span class="FontName">POST</span> request comes in the form <span class="FontName">/reservationQuery?courtName=&lt;value&gt;</span>, this declaration makes said value available in the method under the variable named <span class="FontName">courtName</span>. And second the <span class="FontName">Model</span> declaration, used to define an object in which to pass data onto the returning view.</p>
<p class="indent">The logic executed by the handler method consists of using the controller’s <span class="FontName">reservationService</span> to perform a query using the <span class="FontName">courtName</span> variable. The results obtained from this query are assigned to the <span class="FontName">Model</span> object, that will later become available to the returning view for display.</p>
<p class="indent">Finally, note that the method returns a view named <span class="FontName">reservationQuery</span>. This method could have also returned <span class="FontName">void</span>, just like the default HTTP <span class="FontName">GET</span>, and have been assigned to the same <span class="FontName">reservationQuery</span> default view on account of the requesting URL. Both approaches are identical.</p>
<p class="indent">Now that you are aware of how Spring MVC controllers are constituted, it’s time to explore the views to which a controller’s handler methods delegate their results.</p>
<p id="Sec9" class="Heading2">Creating JSP Views<a id="cXXX.373" class="calibre6"></a></p>
<p class="noindent">Spring MVC supports many types of views for different presentation technologies. These include: JSPs, HTML, PDF, Excel worksheets (XLS), XML, JSON, Atom and RSS feeds, JasperReports, and other third-party view implementations.</p>
<p class="indent">In a Spring MVC application, views are most commonly JSP templates written with JSTL. When the <span class="FontName">DispatcherServlet</span>—defined in an application’s <span class="FontName">web.xml</span> file—receives a view name returned from a handler, it resolves the <i class="calibre8">logical</i> view name into a view implementation for rendering. For example, you can configure the <span class="FontName">InternalResourceViewResolver</span> bean, in this case inside <span class="FontName">court-servlet.xml</span>, of a web application’s context to resolve view names into JSP files in the <span class="FontName">/WEB-INF/jsp/</span> directory:</p>
<pre class="calibre11"><span class="FontName">&lt;bean class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property name="prefix" value="/WEB-INF/jsp/" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;property name="suffix" value=".jsp" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/bean&gt;</span></pre>
<p class="indent">By using this last configuration, a <i class="calibre8">logical</i> view named <span class="FontName">reservationQuery</span> is delegated to a view implementation located at <span class="FontName">/WEB-INF/jsp/</span><b class="calibre4">reservationQuery</b><span class="FontName">.jsp</span> . Knowing this you can create the following JSP template for the welcome controller, naming it <span class="FontName">welcome.jsp</span> and putting it in the <span class="FontName">/WEB-INF/jsp/</span> directory:</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="fmt" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/fmt" class="calibre5">http://java.sun.com/jsp/jstl/fmt</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Welcome&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">Welcome to Court Reservation System&lt;/h2&gt;</span><br class="calibre10"/><span class="FontName">Today is &lt;fmt:formatDate value="${today}" pattern="yyyy-MM-dd" /&gt;.</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">In this JSP template, you make use of the <span class="FontName">fmt</span> tag library in JSTL to format the <span class="FontName">today</span> model attribute into the pattern <span class="FontName">yyyy-MM-dd</span>. Don’t forget to include the <span class="FontName">fmt</span> tag library definition at the top of this JSP template.</p>
<p class="indent">Next, you can create another JSP template for the reservation query controller and name it <span class="FontName">reservationQuery.jsp</span> to match the view name:</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="c" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/core" class="calibre5">http://java.sun.com/jsp/jstl/core</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><span class="FontName">&lt;%@ taglib prefix="fmt" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/fmt" class="calibre5">http://java.sun.com/jsp/jstl/fmt</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Reservation Query&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;form method="post"&gt;</span><br class="calibre10"/><span class="FontName">Court Name</span><br class="calibre10"/><span class="FontName">&lt;input type="text" name="courtName" value="${courtName}" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;input type="submit" value="Query" /&gt;</span><br class="calibre10"/><span class="FontName">&lt;/form&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;table border="1"&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;th&gt;Court Name&lt;/th&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;th&gt;Date&lt;/th&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;th&gt;Hour&lt;/th&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;th&gt;Player&lt;/th&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;c:forEach items="${reservations}" var="reservation"&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;${reservation.courtName}&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;fmt:formatDate value="${reservation.date}" pattern="yyyy-MM-dd" /&gt;&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;${reservation.hour}&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;${reservation.player.name}&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/c:forEach&gt;</span><br class="calibre10"/><span class="FontName">&lt;/table&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">In this JSP template, you include a form for users to input the court name they want to query, and then use the <span class="FontName">&lt;c:forEach&gt;</span> tag to loop the <span class="FontName">reservations</span> model attribute to generate the result table.</p>
<p id="Sec10" class="Heading2">Deploying the Web Application</p>
<p class="noindent">In a web application’s development process<a id="cXXX.374" class="calibre5"></a>, we strongly recommend installing a local Java EE application server that comes with a web container for testing and debugging purposes. For the sake of easy configuration and deployment, we have chosen Apache Tomcat 7.0.x as the web container.</p>
<p class="indent">The deployment directory for this web container is located under the <span class="FontName">webapps</span> directory. By default, Tomcat listens on port 8080 and deploys applications onto a context by the same name of an application WAR. Therefore, if you package the application in a WAR named <span class="FontName">court.war</span>, the welcome controller and the reservation query controller can be accessed through the following URLs:</p>
<pre class="calibre11"><span class="FontName">http://localhost:8080/court/welcome</span><br class="calibre10"/><span class="FontName">http://localhost:8080/court/reservationQuery</span></pre>
<p id="Sec11" class="Heading2">Reducing the amount of XML<a id="cXXX.375" class="calibre6"></a></p>
<p class="noindent">The current configuration is a classic configuration, it is all XML based and isn’t using namespaces. Namespaces can help you minimize the amount of XML you<a id="cXXX.376" class="calibre5"></a> need to write. To minimize the XML we can leverage the <span class="FontName">mvc</span> namespace, we could use <span class="FontName">&lt;mvc:annotation-driven /&gt;</span>instead of declaring the <span class="FontName">RequestMappingHandlerMapping</span> and <span class="FontName">RequestMappingHandlerAdapter</span> explicitly. The configuration would then look like the following:</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:context="</span><span class="FontName"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></span><span class="FontName">"</span><br class="calibre10"/>       <b class="calibre4">xmlns:mvc="</b><b class="calibre4"><a href="http://www.springframework.org/schema/mvc" class="calibre5">http://www.springframework.org/schema/mvc</a></b><b class="calibre4">"</b><br class="calibre10"/>       <span class="FontName">xsi:schemaLocation="</span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span> <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></span> <span class="FontName"><a href="http://www.springframework.org/schema/context/spring-context.xsd" class="calibre5">http://www.springframework.org/schema/context/spring-context.xsd</a></span> <br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/mvc" class="calibre5">http://www.springframework.org/schema/mvc</a></span> <span class="FontName"><a href="http://www.springframework.org/schema/mvc/spring-mvc.xsd" class="calibre5">http://www.springframework.org/schema/mvc/spring-mvc.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;!-- Scanning enablement on package --&gt;</span> <br class="calibre10"/>    <span class="FontName">&lt;context:component-scan base-package="com.apress.springrecipes.court.web" /&gt;</span>  <br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;!-- Annotation handlers (Applied by default to ALL @controllers --&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;mvc:annotation-driven /&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;!-- Views mapped in JSPs under /WEB-INF/jsp --&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;bean class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="prefix" value="/WEB-INF/jsp/" /&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="suffix" value=".jsp" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">The <span class="FontName">&lt;mvc:annotation-driven&gt;</span> tag registers, among other things, the <span class="FontName">RequestMappingHandlerMapping</span> and <span class="FontName">RequestMappingHandlerAdapter</span>.</p>
<p class="indent">As of Spring 3.1 it is also possible to use a Java based configuration approach which we can leverage to eliminate the XML (we will only be left with the <span class="FontName">&lt;context:component-scan /&gt;</span>for now). The Java based configuration looks like this</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">// ... Imports omitted</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><b class="calibre4">@EnableWebMvc</b><br class="calibre10"/><span class="FontName">public class WebConfigurati</span><span class="FontName">on {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public ViewResolver internalResourceViewResolver() {</span><br class="calibre10"/>        <span class="FontName">InternalResourceViewResolver viewResolver = new InternalResourceViewResolver();</span><br class="calibre10"/>        <span class="FontName">viewResolver.setPrefix("/WEB-INF/jsp/");</span><br class="calibre10"/>        <span class="FontName">viewResolver.setSuffix(".jsp");</span><br class="calibre10"/>        <span class="FontName">return viewResolver;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The important thing to notice here is the <span class="FontName">@EnableWebMvc</span> annotation, which takes care of registering the <span class="FontName">RequestMappingHandlerMapping</span> and <span class="FontName">RequestMappingHandlerAdapter</span> as does the <span class="FontName">&lt;mvc:annotation-driven /&gt;</span>tag. We also added the <span class="FontName">@Configuration</span> annotation so that Spring knows that this class needs to be used to configure out application. Our XML is now reduced to only a <span class="FontName">&lt;context:component-scan /&gt;</span>which will pickup our @Configuration annotated class. We could do the same for our service configuration and move that to Java configuration.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.court.service.ReservationService;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.court.service.ReservationServiceImpl;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Bean;</span><br class="calibre10"/><span class="FontName">import org.springframework.context.annotation.Configuration;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">public class ServiceConfiguration {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public ReservationService reservationService() {</span><br class="calibre10"/>        <span class="FontName">return new ReservationServiceImpl();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now we would need to modify our <span class="FontName">court-service.xml</span> to do component scanning of the service sub package to detect this configuration class.</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>       <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>       <b class="calibre4">xmlns:context="</b><b class="calibre4"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></b><b class="calibre4">"</b><br class="calibre10"/>       <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span> <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/context" class="calibre5">http://www.springframework.org/schema/context</a></span> <span class="FontName"><a href="http://www.springframework.org/schema/context/spring-context.xsd" class="calibre5">http://www.springframework.org/schema/context/spring-context.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;!-- Scanning enablement on package --&gt;</span><br class="calibre10"/>    <b class="calibre4">&lt;context:component-scan base-package="com.apress.springrecipes.court.</b><b class="calibre4">service"/&gt;</b>  <br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p class="indent">If we rebuild and redeploy our application it should still work.</p>
<p class="indent">As of the release of the Servlet 3.0 specification it isn’t necessary to have a <span class="FontName">web.xml</span> file anymore, it became optional. As hinted earlier we can use an implementation of a <span class="FontName">ServletContainerInitializer</span> (or multiple) to configure our application.</p>
<p class="indent">Instead of implementing our own we are going to leverage the convenient Spring implementation the <span class="FontName">SpringServletContainerInitializer</span>. This class is an implementation of the <span class="FontName">ServletContainerInitializer</span> interface and scans the classpath for implementations of a <span class="FontName">WebApplicationInitializer</span><a id="cXXX.2261" class="calibre5"></a> interface. Luckily Spring provides some convenience implementations of this interface which we can leverage for our application we are going to use the <span class="FontName">AbstractAnnotationConfigDispatcherServletInitializer</span> to reduce our Spring XML to zero.</p>
<p class="indent">Create a class which extends <span class="FontName">AbstractAnnotationConfigDispatcherServletInitializer</span>  and implements the necessary methods.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.court.service.config.ServiceConfiguration;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.court.web.config.WebConfiguration;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class CourtApplicationInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {</span><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected Class&lt;?&gt;[] getRootConfigClasses() {</span><br class="calibre10"/>        <span class="FontName">return new Class&lt;?&gt;[] {ServiceConfiguration.class};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected Class&lt;?&gt;[] getServletConfigClasses() {</span><br class="calibre10"/>        <span class="FontName">return new Class&lt;?&gt;[] {WebConfiguration.class};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">protected String[] getServletMappings() {</span><br class="calibre10"/>        <span class="FontName">return new String[] {"/", "/welcome"};</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">We need to configure the root-context and the servlet-context, respectively the <span class="FontName">ContextLoaderListener</span> and <span class="FontName">DispatcherServlet</span>. We do this by implementing the <span class="FontName">getRootConfigClasses</span> and <span class="FontName">getServletConfigClasses</span> methods. The first is for the <span class="FontName">ContextLoaderListener</span> and this we pass the <span class="FontName">ServiceConfiguration</span> class we created earlier. The second is for the <span class="FontName">DispatcherServlet</span> and that we pass the <span class="FontName">WebConfiguration</span> class (which requires a minor addition).  Finally we need to map the servlet to 1 or more URLs for this we implement the <span class="FontName">getServle</span><span class="FontName">tMappings</span> method.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvc</span><br class="calibre10"/><b class="calibre4">@ComponentScan("com.apress.springrecipes.court.web")</b><br class="calibre10"/><span class="FontName">public class WebConfiguration { ... }</span></pre>
<p class="indent">As we want to eliminate XML as much as possible we also need to move the component-scanning to Java configuration. For this we use the @ComponentScan tag, which replaces the <span class="FontName">&lt;context:component-scan /&gt;</span>tag.</p>
<p class="indent">With the configuration above we can remove the <span class="FontName">court-service.xml</span> and <span class="FontName">court-servlet.xml</span> however we, sadly, still need the web.xml. This is due to some omissions in the Servlet 3.0 spec, not everything that can be configured in the web.xml has a Java based alternative yet. For instance the welcome pages can only be specified in XML not in Java, the same goes for the <span class="FontName">display-name</span> and <span class="FontName">error-pages</span> (which we will see later).  However the following is what is left of the web.xml and all the XML we have left in our application.</p>
<pre class="calibre11"><span class="FontName">&lt;web-app  xmlns="</span><span class="FontName"><a href="http://java.sun.com/xml/ns/" class="calibre5">http://java.sun.com/xml/ns/</a></span><span class="FontName">javaee"</span><br class="calibre10"/>         <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>         <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://java.sun.com/xml/ns/javaee" class="calibre5">http://java.sun.com/xml/ns/javaee</a></span><br class="calibre10"/>              <span class="FontName"><a href="http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd" class="calibre5">http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd</a></span><span class="FontName">"</span><br class="calibre10"/>         <span class="FontName">version="3.0"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;display-name&gt;Court Reservation System&lt;/display-name&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;welcome-file-list&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;welcome-file&gt;welcome&lt;/welcome-file&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/welcome-file-list&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;/web-app&gt;</span></pre>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  From this point on the recipes will use Java-based configuration, however if you prefer an XML-based approach we also included the XML equivalent of the configuration. See the <span class="FontName">court-servlet.xml</span> file in the project.</p></div>
<p id="Sec12" class="Heading">4-2. Mapping requests with @RequestMapping<a id="cXXX.377" class="calibre6"></a></p>
<p id="Sec13" class="Heading1">Problem</p>
<p class="noindent">When <span class="FontName">DispatcherServlet</span><a id="cXXX.378" class="calibre5"></a> receives a web request, it attempts to dispatch requests to the various controllers classes that have been declared with the <span class="FontName">@Controller</span> annotation. The dispatching process depends on the various <span class="FontName">@RequestMapping</span> annotations declared in a controller class and its handler methods. You want to define a strategy for mapping requests using the <span class="FontName">@RequestMapping</span> annotation.</p>
<p id="Sec14" class="Heading1">Solution</p>
<p class="noindent">In a Spring MVC application, web requests are mapped to handlers by one or more <span class="FontName">@RequestMapping</span> annotations declared in controller classes.</p>
<p class="indent">Handler mappings match URLs according to their paths relative to the context path (i.e., the web application context’s deployed path) and the servlet path (i.e., the path mapped to <span class="FontName">DispatcherServlet</span>). So for example, in the URL <span class="FontName">http://localhost:8080/court/welcome</span> the path to match is <span class="FontName">/welcome</span>, as the context path is <span class="FontName">/court</span> and there’s no servlet path—recall the servlet path declared as <span class="FontName">/</span> in <span class="FontName">web.xml</span>.</p>
<p id="Sec15" class="Heading1">How It Works</p>
<p id="Sec16" class="Heading2">Mapping requests by method</p>
<p class="noindent">The simplest strategy for using <span class="FontName">@RequestMapping</span> annotations is to decorate the handler methods directly. For this strategy to work, you have to declare each handler method with the <span class="FontName">@RequestMapping</span> annotation containing a URL pattern. If a handler’s <span class="FontName">@RequestMapping</span> annotation matches a request’s URL, <span class="FontName">DispatcherServlet</span> it dispatches the request to this handler for it to handle the request.</p>
<pre class="calibre11"><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">public class MemberController {</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private MemberService memberService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public MemberController(MemberService memberService) {</span><br class="calibre10"/>        <span class="FontName">this.memberService = memberService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@RequestMapping("/member/add")</b><br class="calibre10"/>    <span class="FontName">public String addMember(Model model) {</span><br class="calibre10"/>        <span class="FontName">model.addAttribute("member", new Member());</span><br class="calibre10"/>        <span class="FontName">model.addAttribute("guests", memberService.list());</span><br class="calibre10"/>        <span class="FontName">return "memberList";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@RequestMapping(value={"/member/remove","/member/delete"}, method=RequestMethod.GET)</b><br class="calibre10"/>    <span class="FontName">public String removeMember(</span><br class="calibre10"/>            <span class="FontName">@RequestParam("memberName") String memberName) {</span><br class="calibre10"/>           <span class="FontName">memberService.remove(memberName);</span><br class="calibre10"/>           <span class="FontName">return "redirect:";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This last listing illustrates how each handler method is mapped to a particular URL using the <span class="FontName">@RequestMapping</span> annotation. The second handler method illustrates the assignment of multiple URLs, so both <span class="FontName">/member/remove</span> and <span class="FontName">/member/delete</span> trigger the execution of the handler method. By default, it’s assumed all incoming requests to URLs are of the HTTP <span class="FontName">GET</span>  kind.</p>
<p id="Sec17" class="Heading2">Mapping requests by class</p>
<p class="noindent">The <span class="FontName">@RequestMapping</span><a id="cXXX.2157" class="calibre5"></a> annotation can also be used to decorate a controller class<a id="cXXX.379" class="calibre5"></a>. This allows handler methods to either forgo the use of <span class="FontName">@RequestMapping</span> annotations, as illustrated in the <span class="FontName">ReservationQueryController</span> controller in recipe 4-1, or use finer grained URLs with their own <span class="FontName">@RequestMapping</span> annotation. For broader URL matching, the <span class="FontName">@RequestMapping</span> annotation also supports the use wildcards (i.e., <span class="FontName">*</span>) .</p>
<p class="indent">The following listing illustrates the use of URL wildcards<a id="cXXX.380" class="calibre5"></a> in a <span class="FontName">@RequestMapping</span> annotation, as well as finer grained URL matching on <span class="FontName">@RequestMapping</span> annotations for handler methods.</p>
<pre class="calibre11"><span class="FontName">@Controller</span><br class="calibre10"/><b class="calibre4">@RequestMapping("/member/*")</b><br class="calibre10"/><span class="FontName">public class MemberController {</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private MemberService memberService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public MemberController(MemberService memberService) {</span><br class="calibre10"/>        <span class="FontName">this.memberService = memberService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@RequestMapping("add")</b><br class="calibre10"/>    <span class="FontName">public String addMember(Model model) {</span><br class="calibre10"/>        <span class="FontName">model.addAttribute("member", new Member());</span><br class="calibre10"/>        <span class="FontName">model.addAttribute("guests", memberService.list());</span><br class="calibre10"/>        <span class="FontName">return "memberList";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@RequestMapping(value={"remove","delete"}, method=RequestMethod.GET)</b> <br class="calibre10"/>    <span class="FontName">public String removeMember(</span><br class="calibre10"/>            <span class="FontName">@RequestParam("memberName") String memberName) {</span><br class="calibre10"/>           <span class="FontName">memberService.remove(memberName);</span><br class="calibre10"/>           <span class="FontName">return "redirect:";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@RequestMapping("display/{user}")</b><br class="calibre10"/>    <span class="FontName">public String removeMember(</span><br class="calibre10"/>            <span class="FontName">@RequestParam("memberName") String memberName,</span><br class="calibre10"/>            <span class="FontName">@PathVariable("user") String user) {</span><br class="calibre10"/>          <span class="FontName">.....</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@RequestMapping</b><br class="calibre10"/>    <span class="FontName">public void memberList() {</span> <br class="calibre10"/>           <span class="FontName">.....</span><br class="calibre10"/>    <span class="FontName">}</span> <br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void memberLogic(String memberName) {</span> <br class="calibre10"/>           <span class="FontName">.....</span><br class="calibre10"/>    <span class="FontName">}</span> <br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Note the class level <span class="FontName">@RequestMapping</span> annotation uses a URL wildcard: <span class="FontName">/member/*</span> . This in turn delegates all requests under the <span class="FontName">/member/</span> URL to the controller’s handler methods.</p>
<p class="indent">The first two handler methods make use of the <span class="FontName">@RequestMapping</span> annotation. The <span class="FontName">addMember()</span> method is invoked when an HTTP <span class="FontName">GET</span> request is made on the <span class="FontName">/member/add</span> URL. Whereas the <span class="FontName">removeMember()</span> method is invoked when an HTTP <span class="FontName">GET</span> request is made on either the <span class="FontName">/member/remove</span> or <span class="FontName">/member/delete</span> URL.</p>
<p class="indent">The third handler method uses the special notation <span class="FontName">{path_variable}</span> to specify its <span class="FontName">@RequestMapping</span> value. By doing so, a value present in the URL can be passed as input to the handler method. Notice the handler method declares <span class="FontName">@PathVariable</span><a id="cXXX.381" class="calibre5"></a><span class="FontName">("user") String user</span>. In this manner, if a request is received in the form <span class="FontName">member/display/jdoe</span> , the handler method has access to the <span class="FontName">user</span> variable with a <span class="FontName">jdoe</span> value. This is mainly a facility that allows you to avoid tinkering with a handler’s request object and an approach that is especially helpful when you design RESTful web services.</p>
<p class="indent">The fourth handler method also uses the <span class="FontName">@RequestMapping</span> annotation, but in this case lacks a URL value. Since the class level uses the <span class="FontName">/member/*</span> URL wildcard, this handler method is executed as a catch-all. So any URL request (e.g., <span class="FontName">/member/abcdefg</span> or <span class="FontName">/member/randomroute</span>) triggers this method. Note the <span class="FontName">void</span> return value, that in turn makes the handler method default to a view by its name (i.e., <span class="FontName">memberList</span>).</p>
<p class="indent">The last method—<span class="FontName">memberLogic</span><a id="cXXX.382" class="calibre5"></a>—lacks any <span class="FontName">@RequestMapping</span> annotations, this means the method is a utility for the class and has no influence on Spring MVC.</p>
<p id="Sec18" class="Heading2">Mapping requests by HTTP<a id="cXXX.383" class="calibre6"></a> request type</p>
<p class="noindent">By default, <span class="FontName">@RequestMapping</span> annotations handle all types of incoming requests. It is however, in most cases, not wanted that the same method is executed for both a GET and POST request. To differentiate on HTTP request, it’s necessary to specify the type explicitly in the <span class="FontName">@RequestMapping</span> annotation as follows:</p>
<pre class="calibre11"><span class="FontName">@RequestMapping(value= "processUser", method =  RequestMethod.POST)</span><br class="calibre10"/><span class="FontName">public String submitForm(@ModelAttribute("member") Member member,<img src="../images/00053.jpeg" alt="image" class="calibre3"/></span><br class="calibre10"/>                                        <span class="FontName">BindingResult result, Model model) {</span> <br class="calibre10"/><span class="FontName">.....</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The extent to which you require specifying a handler method’s HTTP type depends on how and what is interacting with a controller. For the most part, web browsers perform the bulk of their operations using HTTP <span class="FontName">GET</span> and HTTP <span class="FontName">POST</span> requests. However, other devices or applications (e.g., RESTful web services) may require support for other HTTP request types.</p>
<p class="indent">In all, there are eight different HTTP request types: <span class="FontName">HEAD</span>, <span class="FontName">GET</span>, <span class="FontName">POST</span>, <span class="FontName">PUT</span>, <span class="FontName">DELETE</span>, <span class="FontName">TRACE</span>, <span class="FontName">OPTIONS</span> and <span class="FontName">CONNECT</span>. However, support for handling all these request types goes beyond the scope of an MVC controller, since a web server, as well as the requesting party need to support such HTTP request types. Considering the majority of HTTP requests are of the <span class="FontName">GET</span> or <span class="FontName">POST</span> kind, you will rarely if ever require implementing support for these additional HTTP request types.</p>
<div class="Singlethin"><p class="Heading4a">WHERE ARE THE URL EXTENSIONS LIKE .HTML AND .JSP ?</p>
<p class="box-left">You might have noticed that in all the URLs specified in <span class="FontName">@RequestMapping</span> annotations, there was no trace of a file extension like <span class="FontName">.html</span> or <span class="FontName">.jsp</span>. This is good practice in accordance with MVC design, even though it’s not widely adopted.</p>
<p class="box-left">A controller should not be tied to any type of extension that is indicative of a view technology, like HTML or JSP. This is why controllers return logical views and also why matching URLs should be declared without extensions.</p>
<p class="box-left">In an age where it’s common to have applications serve the same content in different formats, such as XML, JSON, PDF, or XLS (Excel). It should be left to a view resolver to inspect the extension provided in a request—if any—and determine which view technology to use.</p>
<p class="box-left">In this short introduction, you’ve seen how a resolver is configured in an MVC’s configuration file (<span class="FontName">*-servlet.xml</span> ) to map logical views to JSP files, all without every using a URL file extension like <span class="FontName">.jsp</span>.</p>
<p class="box-left">In later recipes, you will learn how Spring MVC uses this same non-extension URL approach to serve content using different view technologies.</p></div>
<p id="Sec19" class="Heading">4-3. Intercepting Requests with Handler Interceptors<a id="cXXX.2052" class="calibre6"></a><a id="cXXX.384" class="calibre6"></a></p>
<p id="Sec20" class="Heading1">Problem</p>
<p class="noindent">Servlet filters defined by the Servlet API can pre-handle and post-handle every web request before and after it’s handled by a servlet. You want to configure something with similar functions as filters in Spring’s web application context to take advantage of the container features.</p>
<p class="indent">Moreover, sometimes you may want to pre-handle and post-handle web requests that are handled by Spring MVC handlers, and manipulate the model attributes returned by these handlers before they are passed to the views.</p>
<p id="Sec21" class="Heading1">Solution</p>
<p class="noindent">Spring MVC allows you to intercept web requests for pre-handling and post-handling through <i class="calibre8">handler interceptors</i>. Handler interceptors are configured in Spring’s web application<a id="cXXX.385" class="calibre5"></a> context, so they can make use of any container features and refer to any beans declared in the container. A handler interceptor can be registered for particular URL mappings, so it only intercepts requests mapped to certain URLs.</p>
<p class="indent">Each handler interceptor must implement the <span class="FontName">HandlerInterceptor</span> interface, which contains three callback methods for you to implement: <span class="FontName">preHandle()</span>,<a id="cXXX.386" class="calibre5"></a> <span class="FontName">postHandle()</span>,<a id="cXXX.387" class="calibre5"></a> and <span class="FontName">afterCompletion()</span><a id="cXXX.388" class="calibre5"></a>. The first and second methods are called before and after a request is handled by a handler. The second method also allows you to get access to the returned <span class="FontName">ModelAndView</span> object, so you can manipulate the model attributes in it. The last method is called after the completion of all request processing (i.e., after the view has been rendered).</p>
<p id="Sec22" class="Heading1">How It Works</p>
<p class="noindent">Suppose you are going to measure each web request’s handling time by each request handler and allow the views to show this time to the user. You can create a custom handler interceptor for this purpose:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.HandlerInterceptor;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.ModelAndView;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class MeasurementInterceptor implements HandlerInterceptor {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public boolean preHandle(HttpServletRequest request,</span><br class="calibre10"/>            <span class="FontName">HttpServletResponse response, Object handler) throws Exception {</span><br class="calibre10"/>        <span class="FontName">long startTime = System.currentTimeMillis();</span><br class="calibre10"/>        <span class="FontName">request.setAttribute("startTime", startTime);</span><br class="calibre10"/>        <span class="FontName">return true;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void postHandle(HttpServletRequest request,</span><br class="calibre10"/>            <span class="FontName">HttpServletResponse response, Object handler,</span><br class="calibre10"/>            <span class="FontName">ModelAndView modelAndView) throws Exception {</span><br class="calibre10"/>        <span class="FontName">long startTime = (Long) request.getAttribute("startTime");</span><br class="calibre10"/>        <span class="FontName">request.removeAttribute("startTime");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">long endTime = System.currentTimeMillis();</span><br class="calibre10"/>        <span class="FontName">modelAndView.addObject("handlingTime", endTime - startTime);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void afterCompletion(HttpServletRequest request,</span><br class="calibre10"/>            <span class="FontName">HttpServletResponse response, Object handler, Exception ex)</span><br class="calibre10"/>            <span class="FontName">throws Exception {</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In the <span class="FontName">preHandle()</span> method<a id="cXXX.389" class="calibre5"></a> of this interceptor, you record the start time and save it to a request attribute. This method should return <span class="FontName">true</span>, allowing <span class="FontName">DispatcherServlet</span> to proceed with request handling. Otherwise, <span class="FontName">DispatcherServlet</span> assumes that this method has already handled the request, so <span class="FontName">DispatcherServlet</span> returns the response to the user directly. Then, in the <span class="FontName">postHandle()</span> method, you load the start time from the request attribute and compare it with the current time. You can calculate the total duration and then add this time to the model for passing to the view. Finally, as there is nothing for the <span class="FontName">afterCompletion()</span> method<a id="cXXX.390" class="calibre5"></a> to do, you can leave its body empty.</p>
<p class="indent">When implementing an interface, you must implement all the methods even though you may not have a need for all of them. A better way is to extend the interceptor adapter class instead. This class implements all the interceptor methods by default. You can override only the methods that you need.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.ModelAndView;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class MeasurementInterceptor extends HandlerInterceptorAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public boolean preHandle(HttpServletRequest request,</span><br class="calibre10"/>            <span class="FontName">HttpServletResponse response, Object handler) throws Exception {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void postHandle(HttpServletRequest request,</span><br class="calibre10"/>            <span class="FontName">HttpServletResponse response, Object handler,</span><br class="calibre10"/>            <span class="FontName">ModelAndView modelAndView) throws Exception {</span><br class="calibre10"/>        <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">To register an interceptor you need to modify the WebConfiguration which was created in the first recipe. You need to have it extend <span class="FontName">WebMvcConfigurerAdapter</span><a id="cXXX.391" class="calibre5"></a> and override the <span class="FontName">addInterceptors</span> method. The method gives you access to the <span class="FontName">InterceptorRegistry</span> which you can use the add interceptors. The modified class looks like the following.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvc</span><br class="calibre10"/><span class="FontName">@ComponentScan("com.apress.springrecipes.court.web")</span><br class="calibre10"/><span class="FontName">public class WebConfiguration</span> <b class="calibre4">extends WebMvcConfigurerAdapter</b> <span class="FontName">{</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Override</b><br class="calibre10"/>    <b class="calibre4">public void addInterceptors(InterceptorRegistry registry) {</b><br class="calibre10"/>        <b class="calibre4">registry.addInterceptor(measurementInterceptor());</b><br class="calibre10"/>    <b class="calibre4">}</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MeasurementInterceptor measurementInterceptor() {</span><br class="calibre10"/>        <span class="FontName">return new MeasurementInterceptor();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now you can show this time in <span class="FontName">welcome.jsp</span> to verify this interceptor’s functionality. As <span class="FontName">WelcomeController</span> doesn’t have much to do, you may likely see that the handling time is 0 milliseconds. If this is the case, you may add a <span class="FontName">sleep</span> statement to this class to see a longer handling time.</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="fmt" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/fmt" class="calibre5">http://java.sun.com/jsp/jstl/fmt</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Welcome&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><b class="calibre4">&lt;hr /&gt;Handling time : ${handlingTime} ms</b><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">By default <span class="FontName">HandlerInterceptor</span>s apply to all @Controllers<a id="cXXX.392" class="calibre5"></a> however sometimes you want to discriminate on which controllers interceptors are applied. The namespace as well as the Java-based configuration allow for interceptors to be mapped to particular URLs. It is only a matter of configuration. Below is the Java configuration of this.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web.config;</span><br class="calibre10"/><span class="FontName">// Other imports omitted for brevity</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.court.web.ExtensionInterceptor;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvc</span><br class="calibre10"/><span class="FontName">@ComponentScan("com.apress.springrecipes.court.web")</span><br class="calibre10"/><span class="FontName">public class WebConfiguration extends WebMvcConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void addInterceptors(InterceptorRegistry registry) {</span><br class="calibre10"/>        <span class="FontName">registry.addInterceptor(measurementInterceptor());</span><br class="calibre10"/>        <b class="calibre4">registry.addInterceptor(summaryReportInterceptor()).addPathPatterns("/reservationSummary*");</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public MeasurementInterceptor measurementInterceptor() {</span><br class="calibre10"/>        <span class="FontName">return new MeasurementInterceptor();</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@Bean</b><br class="calibre10"/>    <b class="calibre4">public ExtensionInterceptor summaryReportInterceptor() { return new ExtensionInterceptor();}</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public ViewResolver internalResourceViewResolver() {</span><br class="calibre10"/>        <span class="FontName">InternalResourceViewResolver viewResolver = new InternalResourceViewResolver();</span><br class="calibre10"/>        <span class="FontName">viewResolver.setPrefix("/WEB-INF/jsp/");</span><br class="calibre10"/>        <span class="FontName">viewResolver.setSuffix(".jsp");</span><br class="calibre10"/>        <span class="FontName">return viewResolver;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">First there is the addition of the interceptor bean <span class="FontName">summaryReportInterceptor</span>. The structure of the backing class for this bean is identical to that of the <span class="FontName">measurementInterceptor</span>. (i.e., it implements the <span class="FontName">HandlerInterceptor</span> interface). However, this interceptor performs logic that should be restricted to a particular controller which is mapped to the <span class="FontName">/reservationSummary</span> URI.</p>
<p class="indent">When registering an interceptor we can specify which URLs it maps to, by default this takes a ANT-style expression. We pass this pattern into the <span class="FontName">addPathPatterns</span> method, there is also an <span class="FontName">excludePathPatterns</span> method which you can use to exclude the interceptor for certain URLs.</p>
<p id="Sec23" class="Heading">4-4. Resolving User Locales<a id="cXXX.393" class="calibre6"></a></p>
<p id="Sec24" class="Heading1">Problem</p>
<p class="noindent">In order for your web application to support internationalization, you have to identify each user’s preferred locale and display contents according to this locale.</p>
<p id="Sec25" class="Heading1">Solution</p>
<p class="noindent">In a Spring MVC application, a user’s locale is identified by a locale resolver, which has to implement the <span class="FontName">LocaleResolver</span> interface. Spring MVC comes with several <span class="FontName">LocaleResolver</span> implementations for you to resolve locales by different criteria. Alternatively, you may create your own custom locale resolver by implementing this interface.</p>
<p class="indent">You can define a locale resolver by registering a bean of type <span class="FontName">LocaleResolver</span> in the web application context. You must set the bean name of the locale resolver to <span class="FontName">localeResolver</span> for <span class="FontName">DispatcherServlet</span> to auto-detect. Note that you can register only one locale resolver per <span class="FontName">DispatcherServlet</span>.</p>
<p id="Sec26" class="Heading1">How It Works</p>
<p id="Sec27" class="Heading2">Resolving Locales by an HTTP Request Header<a id="cXXX.394" class="calibre6"></a></p>
<p class="noindent">The default locale<a id="cXXX.2100" class="calibre5"></a> resolver used by Spring is <span class="FontName">AcceptHeaderLocaleResolver</span>. It resolves locales by inspecting the <span class="FontName">accept-language</span><a id="cXXX.395" class="calibre5"></a> header of an HTTP request. This header is set by a user’s web browser according to the locale setting of the underlying operating system. Note that this locale resolver cannot change a user’s locale because it is unable to modify the locale setting of the user’s operating system.</p>
<p id="Sec28" class="Heading2">Resolving Locales by a Session Attribute</p>
<p class="noindent">Another option of resolving locales is by <span class="FontName">SessionLocaleResolver</span>. It resolves locales by inspecting a predefined attribute in a user’s session. If the session attribute doesn’t exist, this locale resolver determines the default locale from the <span class="FontName">accept-language</span> HTTP header.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public LocaleResolver localeResolver () {</span><br class="calibre10"/>    <span class="FontName">SessionLocaleResolver localeResolver = new SessionLocaleResolver();</span><br class="calibre10"/>    <span class="FontName">localeResolver.setDefaultLocale(new Locale("en"));</span><br class="calibre10"/>    <span class="FontName">return localeResolver;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You can set the <span class="FontName">defaultLocale</span> property for this resolver in case the session attribute doesn’t exist. Note that this locale resolver is able to change a user’s locale by altering the session attribute that stores the locale.</p>
<p id="Sec29" class="Heading2">Resolving Locales by a Cookie</p>
<p class="noindent">You can also use <span class="FontName">CookieLocaleResolver</span><a id="cXXX.396" class="calibre5"></a> to resolve locales by inspecting a cookie in a user’s browser. If the cookie doesn’t exist, this locale resolver determines the default locale from the <span class="FontName">accept-language</span> HTTP header.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public LocaleResolver localeResolver() {</span><br class="calibre10"/>    <span class="FontName">return new CookieLocaleResolver();</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The cookie used by this locale resolver can be customized by setting the <span class="FontName">cookieName</span> and <span class="FontName">cookieMaxAge</span><a id="cXXX.397" class="calibre5"></a> properties. The <span class="FontName">cookieMaxAge</span> property indicates how many seconds this cookie should be persisted. The value <span class="FontName">-1</span> indicates that this cookie will be invalid after the browser is closed.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public LocaleResolver localeResolver() {</span><br class="calibre10"/>    <span class="FontName">CookieLocaleResolver cookieLocaleResolver = new CookieLocaleResolver();</span><br class="calibre10"/>    <span class="FontName">cookieLocaleResolver.setCookieName("language");</span><br class="calibre10"/>    <span class="FontName">cookieLocaleResolver.setCookieMaxAge(3600);</span><br class="calibre10"/>    <span class="FontName">cookieLocaleResolver.setDefaultLocale(new Locale("en"));</span><br class="calibre10"/>    <span class="FontName">return cookieLocaleResolver;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">You can also set the <span class="FontName">defaultLocale</span> property<a id="cXXX.398" class="calibre5"></a> for this resolver in case the cookie doesn’t exist in a user’s browser. This locale resolver is able to change a user’s locale by altering the cookie that stores the locale.</p>
<p id="Sec30" class="Heading2">Changing a User’s Locale</p>
<p class="noindent">In addition to changing a user’s locale by calling <span class="FontName">LocaleResolver.setLocale()</span> explicitly, you can also apply <span class="FontName">LocaleChangeInterceptor</span> to your handler mappings. This interceptor detects if a special parameter is present in the current HTTP request. The parameter name can be customized with the <span class="FontName">paramName</span> property<a id="cXXX.399" class="calibre5"></a> of this interceptor. If such a parameter is present in the current request, this interceptor changes the user’s locale according to the parameter value.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web.config;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.LocaleResolver;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.i18n.CookieLocaleResolver;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.i18n.LocaleChangeInterceptor;</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.view.InternalResourceViewResolver;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import java.util.Locale;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">// Other imports omitted</span> <br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvc</span><br class="calibre10"/><span class="FontName">@ComponentScan("com.apress.springrecipes.court.web")</span><br class="calibre10"/><span class="FontName">public class WebConfiguration extends WebMvcConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void addInterceptors(InterceptorRegistry registry) {</span><br class="calibre10"/>        <span class="FontName">registry.addInterceptor(measurementInterceptor());</span><br class="calibre10"/>        <b class="calibre4">registry.addInterceptor(localeChangeInterceptor());</b><br class="calibre10"/>        <span class="FontName">registry.addInterceptor(summaryReportInterceptor()).addPathPatterns("/reservationSummary*");</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public LocaleChangeInterceptor localeChangeInterceptor() {</span><br class="calibre10"/>        <span class="FontName">LocaleChangeInterceptor localeChangeInterceptor = new LocaleChangeInterceptor();</span><br class="calibre10"/>        <span class="FontName">localeChangeInterceptor.setParamName("language");</span><br class="calibre10"/>        <span class="FontName">return localeChangeInterceptor;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public LocaleResolver localeResolver() {</span><br class="calibre10"/>        <span class="FontName">CookieLocaleResolver cookieLocaleResolver = new CookieLocaleResolver();</span><br class="calibre10"/>        <span class="FontName">cookieLocaleResolver.setCookieName("language");</span><br class="calibre10"/>        <span class="FontName">cookieLocaleResolver.setCookieMaxAge(3600);</span><br class="calibre10"/>        <span class="FontName">cookieLocaleResolver.setDefaultLocale(new Locale("en"));</span><br class="calibre10"/>        <span class="FontName">return cookieLocaleResolver;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now a user’s locale can be changed by any URLs with the <span class="FontName">language</span> parameter<a id="cXXX.400" class="calibre5"></a>. For example, the following two URLs change the user’s locale to English for the United States, and to German, respectively:</p>
<pre class="calibre11"><span class="FontName">http://localhost:8080/court/welcome?language=en_US</span><br class="calibre10"/><span class="FontName">http://localhost:8080/court/welcome?language=de</span></pre>
<p class="indent">Then you can show the HTTP response object’s locale in <span class="FontName">welcome.jsp</span> to verify the locale interceptor’s configuration:</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="fmt" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/fmt" class="calibre5">http://java.sun.com/jsp/jstl/fmt</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Welcome&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><b class="calibre4">&lt;br /&gt;Locale : ${pageContext.response.locale}</b><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p id="Sec31" class="Heading">4-5. Externalizing Locale-Sensitive Text Messages<a id="cXXX.401" class="calibre6"></a></p>
<p id="Sec32" class="Heading1">Problem</p>
<p class="noindent">When developing an internationalized web application, you have to display your web pages in a user’s preferred locale. You don’t want to create different versions of the same page for different locales.</p>
<p id="Sec33" class="Heading1">Solution</p>
<p class="noindent">To avoid creating different versions of a page for different locales, you should make your web page independent of the locale by externalizing locale-sensitive text messages. Spring is able to resolve text messages for you by using a message source, which has to implement the <span class="FontName">MessageSource</span> interface. Then your JSP files can use the <span class="FontName">&lt;spring:message&gt;</span> tag, defined in Spring’s tag library, to resolve a message given the code.</p>
<p id="Sec34" class="Heading1">How It Works</p>
<p class="noindent">You can define a message source by registering a bean of type <span class="FontName">MessageSource</span> in the web application context. You must set the bean name of the message source to <span class="FontName">messageSource</span> for <span class="FontName">DispatcherServlet</span> to auto-detect. Note that you can register only one message source per <span class="FontName">DispatcherServlet</span>.</p>
<p class="indent">The <span class="FontName">ResourceBundleMessageSource</span> implementation resolves messages from different resource bundles for different locales. For example, you can register it in <span class="FontName">WebConfiguration</span> to load resource bundles whose base name is <span class="FontName">messages</span>:</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public MessageSource</span> <b class="calibre4">messageSource</b><span class="FontName">() {</span><br class="calibre10"/>    <span class="FontName">ResourceBundleMessageSource messageSource = new ResourceBundleMessageSource();</span><br class="calibre10"/>    <span class="FontName">messageSource.setBasename("messages");</span><br class="calibre10"/>    <span class="FontName">return messageSource;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Then you create two resource bundles, <span class="FontName">messages.properties</span> and <span class="FontName">messages_de.properties</span>, to store messages for the default and German locales. These resource bundles should be put in the root of the classpath.</p>
<pre class="calibre11"><span class="FontName">welcome.title=Welcome</span><br class="calibre10"/><span class="FontName">welcome.message=Welcome to Court Reservation System</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">welcome.title=Willkommen</span><br class="calibre10"/><span class="FontName">welcome.message=Willkommen zum Spielplatz-Reservierungssystem</span></pre>
<p class="indent">Now, in a JSP file such as <span class="FontName">welcome.jsp</span>, you can use the <span class="FontName">&lt;spring:message&gt;</span> tag to resolve a message given the code. This tag automatically resolves the message according to a user’s current locale. Note that this tag is defined in Spring’s tag library, so you have to declare it at the top of your JSP file.</p>
<pre class="calibre11"><b class="calibre4">&lt;%@ taglib prefix="spring" uri="</b><b class="calibre4"><a href="http://www.springframework.org/tags" class="calibre5">http://www.springframework.org/tags</a></b><b class="calibre4">" %&gt;</b><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;</span><b class="calibre4">&lt;spring:message code="welcome.title" text="Welcome" /&gt;</b><span class="FontName">&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/>&lt;h2&gt;<b class="calibre4">&lt;spring:message code="welcome.message"</b><br class="calibre10"/>        <b class="calibre4">text="Welcome to Court Reservation System" /&gt;&lt;/h2&gt;</b><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">In <span class="FontName">&lt;spring:message&gt;</span>, you can specify the default text to output when a message for the given code cannot be resolved.</p>
<p id="Sec35" class="Heading">4-6. Resolving Views by Names</p>
<p id="Sec36" class="Heading1">Problem</p>
<p class="noindent">After a handler has finished handling a request, it returns a logical view name. In which case the <span class="FontName">DispatcherServlet</span> has to delegate control to a view template so the information is rendered. You want to define a strategy for <span class="FontName">DispatcherServlet</span> to resolve views by their logical names.</p>
<p id="Sec37" class="Heading1">Solution</p>
<p class="noindent">In a Spring MVC application, views are resolved by one or more view resolver beans declared in the web application context. These beans have to implement the <span class="FontName">ViewResolver</span> interface for <span class="FontName">DispatcherServlet</span> to auto-detect them. Spring MVC comes with several <span class="FontName">ViewResolver</span> implementations for you to resolve views using different strategies.</p>
<p id="Sec38" class="Heading1">How It Works</p>
<p id="Sec39" class="Heading2">Resolving Views Based on a template’s name and location<a id="cXXX.402" class="calibre6"></a></p>
<p class="noindent">The basic strategy of resolving views is to map them to a template’s name and location directly. The view resolver <span class="FontName">InternalResourceViewResolver</span> maps each view name to an application’s<a id="cXXX.403" class="calibre5"></a> directory by means of a prefix and a suffix declaration. To register <span class="FontName">InternalResourceViewResolver</span>, you can declare a bean of this type in the web application context.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public ViewResolver viewResolver() {</span><br class="calibre10"/>    <span class="FontName">InternalResourceViewResolver viewResolver = new InternalResourceViewResolver();</span><br class="calibre10"/>    <span class="FontName">viewResolver.setPrefix("/WEB-INF/jsp/");</span><br class="calibre10"/>    <span class="FontName">viewResolver.setSuffix(".jsp");</span><br class="calibre10"/>    <span class="FontName">return viewResolver;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">For example, <span class="FontName">InternalResourceViewResolver</span> resolves the view names <span class="FontName">welcome</span> and <span class="FontName">reservationQuery</span> in the following way:</p>
<pre class="calibre11"><span class="FontName">welcome ' /WEB-INF/jsp/welcome.jsp</span><br class="calibre10"/><span class="FontName">reservationQuery ' /WEB-INF/jsp/reservationQuery.jsp</span></pre>
<p class="indent">The type of the resolved views can be specified by the <span class="FontName">viewClass</span> property. By default, <span class="FontName">InternalResourceViewResolver</span> resolves view names into view objects of type <span class="FontName">JstlView</span> if the JSTL library (i.e., <span class="FontName">jstl.jar</span>) is present in the classpath. So, you can omit the <span class="FontName">viewClass</span> property if your views are JSP templates with JSTL tags.</p>
<p class="indent"><span class="FontName">InternalResourceViewResolver</span> is simple, but it can only resolve internal resource views that can be forwarded by the Servlet API’s <span class="FontName">RequestDispatcher</span> (e.g., an internal JSP file or a servlet). As for other view types supported by Spring MVC, you have to resolve them using other strategies.</p>
<p id="Sec40" class="Heading2">Resolving Views from an XML Configuration File</p>
<p class="noindent">Another strategy for resolving views is to declare them as Spring beans and resolve them by their bean names. You can declare the view beans in the same configuration file as the web application context, but it’s better to isolate them in a separate configuration file. By default, <span class="FontName">XmlViewResolver</span> loads view beans from <span class="FontName">/WEB-INF/views.xml</span>, but this location can be overridden through the <span class="FontName">location</span> property.</p>
<pre class="calibre11"><span class="FontName">Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvc</span><br class="calibre10"/><span class="FontName">@ComponentScan("com.apress.springrecipes.court.web")</span><br class="calibre10"/><span class="FontName">public class WebConfiguration extends WebMvcConfigurerAdapter implements ResourceLoaderAware {</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private ResourceLoader resourceLoader;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public ViewResolver viewResolver() {</span><br class="calibre10"/>        <span class="FontName">XmlViewResolver viewResolver = new XmlViewResolver();</span><br class="calibre10"/>        <span class="FontName">viewResolver.setLocation(resourceLoader.getResource("/WEB-INF/court-views.nl"));</span><br class="calibre10"/>        <span class="FontName">return viewResolver;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void setResourceLoader(ResourceLoader resourceLoader) {</span><br class="calibre10"/>        <span class="FontName">this.resourceLoader=resourceLoader;</span><br class="calibre10"/>    <span class="FontName">}</span></pre>
<p class="indent">Note the implementation of the <span class="FontName">ResourceLoaderAware</span> interface, we need to load resources as the <span class="FontName">location</span> property takes an argument of the type <span class="FontName">Resource</span>. In a Spring XML file the conversion from <span class="FontName">String</span> to <span class="FontName">Resource</span> is handled for us, however when using Java-based configuration we have to do some additional work.</p>
<p class="indent">In the <span class="FontName">court-views.xml</span> configuration file, you can declare each view as a normal Spring bean by setting the class name and properties. In this way, you can declare any types of views (e.g., <span class="FontName">RedirectView</span> and even custom view types).</p>
<pre class="calibre11"><span class="FontName">&lt;beans  xmlns="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xmlns:xsi="</span><span class="FontName"><a href="http://www.w3.org/2001/XMLSchema-instance" class="calibre5">http://www.w3.org/2001/XMLSchema-instance</a></span><span class="FontName">"</span><br class="calibre10"/>    <span class="FontName">xsi:schemaLocation="</span><span class="FontName"><a href="http://www.springframework.org/schema/beans" class="calibre5">http://www.springframework.org/schema/beans</a></span><br class="calibre10"/>        <span class="FontName"><a href="http://www.springframework.org/schema/beans/spring-beans.xsd" class="calibre5">http://www.springframework.org/schema/beans/spring-beans.xsd</a></span><span class="FontName">"&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="welcome"</span><br class="calibre10"/>        <span class="FontName">class="org.springframework.web.servlet.view.JstlView"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="url" value="/WEB-INF/jsp/welcome.jsp" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="reservationQuery"</span><br class="calibre10"/>        <span class="FontName">class="org.springframework.web.servlet.view.JstlView"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="url" value="/WEB-INF/jsp/reservationQuery.jsp" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">&lt;bean id="welcomeRedirect"</span><br class="calibre10"/>        <span class="FontName">class="org.springframework.web.servlet.view.RedirectView"&gt;</span><br class="calibre10"/>        <span class="FontName">&lt;property name="url" value="welcome" /&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;/bean&gt;</span><br class="calibre10"/><span class="FontName">&lt;/beans&gt;</span></pre>
<p id="Sec41" class="Heading2">Resolving Views from a Resource Bundle<a id="cXXX.404" class="calibre6"></a></p>
<p class="noindent">In addition to an XML configuration file, you can declare view beans in a resource bundle. <span class="FontName">ResourceBundleViewResolver</span> loads view beans from a resource bundle in the classpath root. Note that <span class="FontName">ResourceBundleViewResolver</span> can also take advantage of the resource bundle capability to load view beans from different resource bundles for different locales.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public ViewResolver viewResolver() {</span><br class="calibre10"/>    <span class="FontName">ResourceBundleViewResolver viewResolver = new ResourceBundleViewResolver();</span><br class="calibre10"/>    <span class="FontName">viewResolver.setBasename("court-views");</span><br class="calibre10"/>    <span class="FontName">return viewResolver;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">As you specify court-<span class="FontName">views</span> as the base name of <span class="FontName">ResourceBundleViewResolver</span>, the resource bundle is court-<span class="FontName">views.properties</span>. In this resource bundle, you can declare view beans in the format of properties. This type of declaration is equivalent to the XML bean declaration.</p>
<pre class="calibre11"><span class="FontName">welcome.(class)=org.springframework.web.servlet.view.JstlView</span><br class="calibre10"/><span class="FontName">welcome.url=/WEB-INF/jsp/welcome.jsp</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">reservationQuery.(class)=org.springframework.web.servlet.view.JstlView</span><br class="calibre10"/><span class="FontName">reservationQuery.url=/WEB-INF/jsp/reservationQuery.jsp</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">welcomeRedirect.(class)=org.springfram</span><span class="FontName">ework.web.servlet.view.RedirectView</span><br class="calibre10"/><span class="FontName">welcomeRedirect.url=welcome</span></pre>
<p id="Sec42" class="Heading2">Resolving Views with Multiple Resolvers</p>
<p class="noindent">If you have a lot of views in your web application, it is often insufficient to choose only one view-resolving strategy. Typically, <span class="FontName">InternalResourceViewResolver</span><a id="cXXX.405" class="calibre5"></a> can resolve most of the internal JSP views, but there are usually other types of views that have to be resolved by <span class="FontName">ResourceBundleViewResolver</span>. In this case, you have to combine both strategies for view resolution.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public ViewResolver viewResolver() {</span><br class="calibre10"/>    <span class="FontName">ResourceBundleViewResolver viewResolver = new ResourceBundleViewResolver();</span><br class="calibre10"/>    <b class="calibre4">viewResolver.setOrder(0);</b><br class="calibre10"/>    <span class="FontName">viewResolver.setBasename("court-views");</span><br class="calibre10"/>    <span class="FontName">return viewResolver;</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public ViewResolver internalResourceViewResolver() {</span><br class="calibre10"/>    <span class="FontName">InternalResourceViewResolver viewResolver = new InternalResourceViewResolver();</span><br class="calibre10"/>    <b class="calibre4">viewResolver.setOrder(1);</b><br class="calibre10"/>    <span class="FontName">viewResolver.setPrefix("/WEB-INF/jsp/");</span><br class="calibre10"/>    <span class="FontName">viewResolver.setSuffix(".jsp");</span><br class="calibre10"/>    <span class="FontName">return viewResolver;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">When choosing more than one strategy at the same time, it’s important to specify the resolving priority. You can set the <span class="FontName">order</span> properties of the view resolver beans for this purpose. The lower order value represents the higher priority. Note that you should assign the lowest priority to <span class="FontName">InternalResourceViewResolver</span> because it always resolves a view no matter whether it exists or not. So, other resolvers will have no chance to resolve a view if they have lower priorities.</p>
<p class="indent">Now the resource bundle court-<span class="FontName">views.properties</span> should only contain the views that can’t be resolved by <span class="FontName">InternalResourceViewResolver</span> (e.g., the redirect views):</p>
<pre class="calibre11"><span class="FontName">welcomeRedirect.(class)=org.springframework.web.servlet.view.RedirectView</span><br class="calibre10"/><span class="FontName">welcomeRedirect.url=welcome</span></pre>
<p id="Sec43" class="Heading2">The Redirect Prefix<a id="cXXX.406" class="calibre6"></a></p>
<p class="noindent">If you have <span class="FontName">InternalResourceViewResolver</span> configured in your web application context, it can resolve redirect views by using the <span class="FontName">redirect</span> prefix in the view name. Then the rest of the view name is treated as the redirect URL. For example, the view name <span class="FontName">redirect:welcome</span> triggers a redirect to the relative URL <span class="FontName">welcome</span>. You may also specify an absolute URL in the view name.</p>
<p id="Sec44" class="Heading">4-7. Views and Content Negotiation<a id="cXXX.407" class="calibre6"></a></p>
<p id="Sec45" class="Heading1">Problem</p>
<p class="noindent">You are relying on extension-less URLs in your controllers—<span class="FontName">welcome</span> and not <span class="FontName">welcome.html</span> or <span class="FontName">welcome.pdf</span>. You want to devise a strategy so the correct content and type is returned for all requests.</p>
<p id="Sec46" class="Heading1">Solution</p>
<p class="noindent">When a request is received for a web application, it contains a series of properties that allow the processing framework, in this case Spring MVC, to determine the correct content and type to return to the requesting party. The main two properties include:</p>
<ul class="bulleted"><li class="calibre17">The URL extension provided in a request</li>
<li class="calibre17">The HTTP <span class="FontName">Accept</span> header</li></ul>
<p class="indent">For example, if a request is made to a URL<a id="cXXX.408" class="calibre5"></a> in the form <span class="FontName">/reservationSummary.xml</span>, a controller is capable of inspecting the extension and delegating it to a logical view representing an XML view.</p>
<p class="indent">However, the possibility can arise for a request to be made to a URL in the form <span class="FontName">/reservationSummary</span>. Should this request be delegated to an XML view or an HTML view? Or perhaps some other type of view? It’s impossible to tell through the URL. But instead of deciding on a default view for such requests, a request can be inspected for its HTTP Accept header to decide what type of view is more appropriate.</p>
<p class="indent">Inspecting HTTP Accept headers in a controller can be a messy process. So Spring MVC supports the inspection of headers through the <span class="FontName">ContentNegotiatingViewResolver</span> allowing view delegation to be made based on either a URL file extension or HTTP Accept header value.</p>
<p id="Sec47" class="Heading1">How It Works</p>
<p class="noindent">The first thing you need to realize about Spring MVC content negotiation is that it’s configured as a resolver, just like those illustrated in the previous recipe “Resolving Views by Names.”</p>
<p class="indent">The Spring MVC content negotiating resolver is based on the <span class="FontName">ContentNegotiatingViewResolver</span><a id="cXXX.409" class="calibre5"></a> class. But before we describe how it works, we will illustrate how to configure and integrate it with other resolvers.</p>
<pre class="calibre11"><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvc</span><br class="calibre10"/><span class="FontName">@ComponentScan("com.apress.springrecipes.court.web")</span><br class="calibre10"/><span class="FontName">public class WebConfiguration extends WebMvcConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">private ContentNegotiationManager contentNegotiationManager;</span><br class="calibre10"/><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void configureContentNegotiation(ContentNegotiationConfigurer configurer) {</span><br class="calibre10"/>        <span class="FontName">Map&lt;String, MediaType&gt; mediatypes = new HashMap&lt;&gt;();</span><br class="calibre10"/>        <span class="FontName">mediatypes.put("html", MediaType.TEXT_HTML);</span><br class="calibre10"/>        <span class="FontName">mediatypes.put("pdf", new MediaType("application/pdf"));</span><br class="calibre10"/>        <span class="FontName">mediatypes.put("xls", new MediaType("application/vnd.ms-excel"));</span><br class="calibre10"/>        <span class="FontName">mediatypes.put("xml", MediaType.APPLICATION_XML);</span><br class="calibre10"/>        <span class="FontName">mediatypes.put("json", MediaType.APPLICATION_JSON);</span><br class="calibre10"/>        <span class="FontName">configurer.mediaTypes(mediatypes);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Bean</span><br class="calibre10"/>    <span class="FontName">public ContentNegotiatingViewResolver contentNegotiatingViewResolver() {</span><br class="calibre10"/>        <span class="FontName">ContentNegotiatingViewResolver viewResolver = new ContentNegotiatingViewResolver();</span><br class="calibre10"/>        <span class="FontName">viewResolver.setContentNegotiationManager(contentNegotiationManager);</span><br class="calibre10"/>        <span class="FontName">return viewResolver;</span><br class="calibre10"/>    <span class="FontName">}</span></pre>
<p class="indent">First of all we need to configure content negotiation, the default configuration adds a <span class="FontName">ContentNegotiationManager</span>, which can be configured by implementing the <span class="FontName">configureContentNegotiation</span> method. To get access to the configured <span class="FontName">ContentNegotiationManager</span> we can simply autowire it in our configuration class.</p>
<p class="indent">Turning our attention back to the <span class="FontName">ContentNegotiatingViewResolver</span> resolver. This configuration sets up the resolver to have the highest priority among all resolvers, which <b class="calibre4">is necessary to make the content negotiating resolver work</b>. The reason for this resolver having the highest priority is that it does not resolve views themselves, but rather delegates them to other view resolvers (which it automatically detects). Since a resolver that does not resolve views can be confusing, we will elaborate with an example.</p>
<p class="indent">Let’s assume a controller receives a request for <span class="FontName">/reservationSummary.xml</span>. Once the handler method finishes, it sends control to a logical view named <span class="FontName">reservation</span>. At this point Spring MVC resolvers come into play, the first of which is the <span class="FontName">ContentNegotiatingViewResolver</span> resolver, since it has the highest priority.</p>
<p class="indent">The <span class="FontName">ContentNegotiatingViewResolver</span> resolver first determines the media type for a request based on the following criteria:</p>
<p class="indent">It checks a request path extension (e.g., <span class="FontName">.html</span>, <span class="FontName">.xml</span>, or <span class="FontName">.pdf</span>) against the default media types (e.g., <span class="FontName">text/html</span>) specified by the <span class="FontName">mediaTypes</span> map in the configuration of the <span class="FontName">ContentNegotiatingManager</span> bean.</p>
<p class="indent">If a request path has an extension but no match can be found in the default <span class="FontName">mediaTypes</span> section attempt is made to determine an extension’s media type using <span class="FontName">FileTypeMap</span> belonging to Java Activation Framework.</p>
<p class="indent">If no extension is present in a request path, the HTTP Accept header of the request is used.</p>
<p class="indent">For the case of a request made on <span class="FontName">/reservationSummary.xml</span>, the media type is determined in step 1 to be <span class="FontName">application/xml</span>. However, for a request made on a URL like <span class="FontName">/reservationSummary</span><a id="cXXX.410" class="calibre5"></a>, the media type is not determined until step 3.</p>
<p class="indent">The HTTP Accept header contains values like <span class="FontName">Accept: text/html</span> or <span class="FontName">Accept:application/pdf</span> , these values help the resolver determine the media type a requester is expecting, given that no extension is present in the requesting URL.</p>
<p class="indent">At this juncture, the <span class="FontName">ContentNegotiatingViewResolver</span> resolver has a media type and logical view named <span class="FontName">reservation</span>. Based on this information, an iteration is performed over the remaining resolvers—based on their order—to determine what view best matches the logical name based on the detected media type.</p>
<p class="indent">This process allows you to have multiple logical views with the same name, each supporting a different media type (e.g., HTML, PDF, or XLS), with <span class="FontName">ContentNegotiatingViewResolver</span> resolving which is the best match.</p>
<p class="indent">In such cases a controller’s design is further simplified, since it won’t be necessary to hard-code the logical view necessary to create a certain media type (e.g., <span class="FontName">pdfReservation</span>, <span class="FontName">xlsReservation</span>, or <span class="FontName">htmlReservation</span>), but instead a single view (e.g., <span class="FontName">reservation</span>), letting the <span class="FontName">ContentNegotiatingViewResolver</span> resolver determine the best match.</p>
<p class="indent">A series of outcomes for this process can be the following:</p>
<ul class="bulleted"><li class="calibre17">The media type is determined to be <span class="FontName">application/pdf</span>.<a id="cXXX.411" class="calibre5"></a> If the resolver with the highest priority (lower <span class="FontName">order</span>) contains a mapping to a logical view named <span class="FontName">reservation</span>, but such a view does not support the <span class="FontName">application/pdf</span> type, no match occurs—the lookup process continues onto the remaining resolvers.</li>
<li class="calibre17">The media type is determined to be <span class="FontName">application/pdf</span>. The resolver with the highest priority (lower <span class="FontName">order</span>) containing a mapping to a logical view named <span class="FontName">reservation</span> and having support for <span class="FontName">application/pdf</span> is matched.</li>
<li class="calibre17">The media type is determined to be <span class="FontName">text/html</span>. There are four resolvers with a logical view named <span class="FontName">reservation</span>, but the views mapped to the two resolvers with highest priority do not support <span class="FontName">text/html</span>. It’s the remaining resolver containing a mapping for a view named <span class="FontName">reservation</span> that supports <span class="FontName">text/html</span> that is matched.</li></ul>
<p class="indent">This search process for views automatically take place on all the resolvers configured in an application. It’s also possible to configure—within the <span class="FontName">ContentNegotiatingViewResolver</span> bean—default views and resolvers, in case you don’t want to fall-back on configurations made outside the <span class="FontName">ContentNegotiatingViewResolver</span> resolver.</p>
<p class="indent">Recipe 4-13, “Creating Excel and PDF Views,” will illustrate a controller that relies on the <span class="FontName">ContentNegotiatingViewResolver</span> resolver to determine an application’s views.</p>
<p id="Sec48" class="Heading">4-8. Mapping Exceptions to Views<a id="cXXX.2110" class="calibre6"></a></p>
<p id="Sec49" class="Heading1">Problem</p>
<p class="noindent">When an unknown exception occurs, your application server usually displays the evil exception stack trace to the user. Your users have nothing to do with this stack trace and complain that your application is not user friendly. Moreover, it’s also a potential security risk, as you may expose the internal method call hierarchy to users.</p>
<p class="indent">Though a web application’s <span class="FontName">web.xml</span> can be configured to display friendly JSP pages in case an HTTP error or class exception occur. Spring MVC supports a more robust approach to managing views for class exceptions.</p>
<p id="Sec50" class="Heading1">Solution</p>
<p class="noindent">In a Spring MVC application, you can register one or more exception resolver beans in the web application context to resolve uncaught exceptions. These beans have to implement the <span class="FontName">HandlerExceptionResolver</span> i<a id="cXXX.412" class="calibre5"></a>nterface for <span class="FontName">DispatcherServlet</span> to auto-detect them. Spring MVC comes with a simple exception resolver for you to map each category of exceptions to a view.</p>
<p id="Sec51" class="Heading1">How It Works</p>
<p class="noindent">Suppose your reservation service throws the following exception due to a reservation not being available:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class ReservationNotAvailableException extends RuntimeException {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private String courtName;</span><br class="calibre10"/>    <span class="FontName">private Date date;</span><br class="calibre10"/>    <span class="FontName">private int hour;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Constructors and Getters</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">To resolve uncaught exceptions, you can write your custom exception resolver by implementing the <span class="FontName">HandlerExceptionResolver</span> interface. Usually, you’ll want to map different categories of exceptions into different error pages. Spring MVC comes with the exception resolver <span class="FontName">SimpleMappingExceptionResolver</span> for you to configure the exception mappings in the web application context. For example, you can register the following exception resolver in <span class="FontName">WebConfiguration</span><a id="cXXX.413" class="calibre5"></a>:</p>
<pre class="calibre11">    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public void configureHandlerExceptionResolvers(List&lt;HandlerExceptionResolver&gt; exceptionResolvers) {</span><br class="calibre10"/>        <span class="FontName">exceptionResolvers.add(handlerExceptionResolver());</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/> <span class="FontName">@Bean</span><br class="calibre10"/> <span class="FontName">public HandlerExceptionResolver handlerExceptionResolver() {</span><br class="calibre10"/>    <span class="FontName">Properties exceptionMapping = new Properties();</span><br class="calibre10"/>    <span class="FontName">exceptionMapping.setProperty(</span><br class="calibre10"/>                        <span class="FontName">ReservationNotAvailableException.class.getName(),</span> <br class="calibre10"/>                <span class="FontName">"reservationNotAvailable");</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">SimpleMappingExceptionResolver exceptionResolver = new SimpleMappingExceptionResolver();</span><br class="calibre10"/>    <span class="FontName">exceptionResolver.setExceptionMappings(exceptionMapping);</span><br class="calibre10"/>    <span class="FontName">exceptionResolver.setDefaultErrorView("error");</span><br class="calibre10"/>    <span class="FontName">return exceptionResolver;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In this exception resolver, you define the logical view name <span class="FontName">reservationNotAvailable</span><a id="cXXX.414" class="calibre5"></a> for <span class="FontName">ReservationNotAvailableException</span>. You can add any number of exception classes using the <span class="FontName">exceptionMappings property</span>, all the way down to the more general exception class <span class="FontName">java.lang.Exception</span>. In this manner, depending on the type of class exception, a user is served a view in accordance with the exception.</p>
<p class="indent">The property <span class="FontName">defaultErrorView</span><a id="cXXX.415" class="calibre5"></a><span class="FontName">,</span> is used to define a default view named <span class="FontName">error</span>, used in case an exception class not mapped in the <span class="FontName">exceptionMapping</span> element is raised.</p>
<p class="indent">Addressing the corresponding views, if the <span class="FontName">InternalResourceViewResolver</span> is configured in your web application context, the following <span class="FontName">reservationNotAvailable.jsp</span> page is shown in case of a reservation not being available:</p>
<pre class="calibre11"><span class="FontName">&lt;%@ taglib prefix="fmt" uri="</span><span class="FontName"><a href="http://java.sun.com/jsp/jstl/fmt" class="calibre5">http://java.sun.com/jsp/jstl/fmt</a></span><span class="FontName">" %&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Reservation Not Available&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">Your reservation for ${exception.courtName} is not available on</span><br class="calibre10"/><span class="FontName">&lt;fmt:formatDate value="${exception.date}" pattern="yyyy-MM-dd" /&gt;at</span><br class="calibre10"/><span class="FontName">${exception.hour}:00.</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">In an error page, the exception instance can be accessed by the variable <span class="FontName">${exception}</span>, so you can show the user more details on this exception.</p>
<p class="indent">It’s a good practice to define a default error page for any unknown exceptions. You can use <span class="FontName">&lt;property name="defaultErrorView" value="error"/&gt;</span>to define a default view or map a page to the key <span class="FontName">java.lang.Exception</span><a id="cXXX.416" class="calibre5"></a> as the last entry of the mapping, so it will be shown if no other entry has been matched before. Then you can create this view’s JSP— <span class="FontName">error.jsp</span>—as follows:</p>
<pre class="calibre11"><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Error&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">An error has occurred. Please contact our administrator for details.</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p id="Sec52" class="Heading1">Mappings exceptions using @ExceptionHandler<a id="cXXX.417" class="calibre6"></a></p>
<p class="noindent">Instead of configuring a HandlerExceptionResolver we can also annotate a method with <span class="FontName">@ExceptionHandler</span>. It works in a similar way as the <span class="FontName">@RequestMapping</span> annotation.</p>
<pre class="calibre11"><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">@RequestMapping("/reservationForm")</span><br class="calibre10"/><span class="FontName">@SessionAttributes("reservation") // Command name class was used in earlier Spring versions</span><br class="calibre10"/><span class="FontName">public class ReservationFormController {</span><br class="calibre10"/>    <span class="FontName">@ExceptionHandler(ReservationNotAvailableException.class)</span><br class="calibre10"/>    <span class="FontName">public String handle(ReservationNotAvailableException ex) {</span><br class="calibre10"/>        <span class="FontName">return "reservationNotAvailable";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@ExceptionHandler</span><br class="calibre10"/>    <span class="FontName">public String handleDefault(Exception e) {</span><br class="calibre10"/>        <span class="FontName">return "error";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">We have here two methods annotated <span class="FontName">@ExceptionHandler</span>. The first is for handling the specific <span class="FontName">ReservationNotAvailableException</span>, the second is the general (catch-all) exception handling method. You also don’t have to specify a <span class="FontName">HandlerExceptionResolver</span> in the <span class="FontName">WebConfiguration</span> anymore.</p>
<p class="indent">Methods annotated with <span class="FontName">@ ExceptionHandler</span> can have a variety of return types (like the <span class="FontName">@RequestMapping</span> methods), here we just return the name of the view which needs to be rendered, but we could also have returned a <span class="FontName">ModelAndView</span>, a <span class="FontName">View</span> etc.</p>
<p class="indent">Although using <span class="FontName">@ExceptionHandler</span> annotated methods is very powerful and flexible there is a drawback when you put them in controllers. Those methods will only work in the controller they are defined in, so if we have an exception occurring in another controller (for instance the WelcomeController) these methods won’t be called. Generic exception handling methods have to be moved to a separate class and that class has to be annotated with <span class="FontName">@ControllerAdvice</span></p>
<pre class="calibre11"><span class="FontName">@ControllerAdvice</span><br class="calibre10"/><span class="FontName">public class ExceptionHandlingAdvice {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@ExceptionHandler(ReservationNotAvailableException.class)</span><br class="calibre10"/>    <span class="FontName">public String handle(ReservationNotAvailableException ex) {</span><br class="calibre10"/>        <span class="FontName">return "reservationNotAvailable";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@ExceptionHandler</span><br class="calibre10"/>    <span class="FontName">public String handleDefault(Exception e) {</span><br class="calibre10"/>        <span class="FontName">return "error";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This class will apply to all controllers<a id="cXXX.2019" class="calibre5"></a> in the application context, hence the name @ControllerAdvice.</p>
<p id="Sec53" class="Heading">4-9. Handling Forms with Controllers<a id="cXXX.418" class="calibre6"></a></p>
<p id="Sec54" class="Heading1">Problem</p>
<p class="noindent">In a web application, you often have to deal with forms. A form controller has to show a form to a user and also handle the form submission. Form handling can be a complex and variable task.</p>
<p id="Sec55" class="Heading1">Solution</p>
<p class="noindent">When a user interacts with a form, it requires support for two operations from a controller. First when a form is initially requested, it asks the controller to show a form by an HTTP <span class="FontName">GET</span> request<a id="cXXX.419" class="calibre5"></a>, that renders the form view to the user. Then when the form is submitted, an HTTP <span class="FontName">POST</span> request<a id="cXXX.420" class="calibre5"></a> is made to handle things like validation and business processing for the data present in the form.</p>
<p class="indent">If the form is handled successfully, it renders the success view to the user. Otherwise, it renders the form view again with errors.</p>
<p id="Sec56" class="Heading1">How It Works</p>
<p class="noindent">Suppose you want to allow a user to make a court reservation by filling out a form. To give you a better idea of the data handled by a controller, we will introduce the controller’s view (i.e., the form) first.</p>
<p id="Sec57" class="Heading2">Creating a form’s views</p>
<p class="noindent">Let’s create the form view <span class="FontName">reservationForm.jsp</span><a id="cXXX.421" class="calibre5"></a>. The form relies on Spring’s form tag library, as this simplifies a form’s data binding, display of error messages and the re-display of original values entered by the user in case of errors.</p>
<pre class="calibre11"><b class="calibre4">&lt;%@ taglib prefix="form" uri="</b><b class="calibre4"><a href="http://www.springframework.org/tags/form" class="calibre5">http://www.springframework.org/tags/form</a></b><b class="calibre4">"%&gt;</b><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Reservation Form&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;style&gt;</span><br class="calibre10"/><span class="FontName">.error {</span><br class="calibre10"/>  <span class="FontName">color: #ff0000;</span><br class="calibre10"/>  <span class="FontName">font-weight: bold;</span><br class="calibre10"/><span class="FontName">}</span><br class="calibre10"/><span class="FontName">&lt;/style&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><b class="calibre4">&lt;form:form method="post" modelAttribute="reservation"&gt;</b><br class="calibre10"/><b class="calibre4">&lt;form:errors path="*" cssClass="error" /&gt;</b><br class="calibre10"/><span class="FontName">&lt;table&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Court Name&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:input path="courtName" /&gt;&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:errors path="courtName" cssClass="error" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Date&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:input path="date" /&gt;&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:errors path="date" cssClass="error" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Hour&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:input path="hour" /&gt;&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:errors path="hour" cssClass="error" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td colspan="3"&gt;&lt;input type="submit" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/><span class="FontName">&lt;/table&gt;</span><br class="calibre10"/><span class="FontName">&lt;/form:form&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">The Spring <span class="FontName">&lt;form:form&gt;</span> declares two attributes. The <span class="FontName">method="post"</span> attribute used to indicate a form performs an HTTP <span class="FontName">POST</span> request upon submission. And the <span class="FontName">modelAttribute="reservation"</span> attribute used to indicate the form data is bound to a model named <span class="FontName">reservation</span>. The first attribute should be familiar to you since it’s used on most HTML forms. The second attribute will become clearer once we describe the controller that handles the form.</p>
<p class="indent">Bear in mind the <span class="FontName">&lt;form:form&gt;</span> tag is rendered into a standard HTML before it’s sent to a user, so it’s not that the <span class="FontName">modelAttribute="reservation"</span> is of use to a browser, the attribute is used as facility to generate the actual HTML form.</p>
<p class="indent">Next, you can find the <span class="FontName">&lt;form:errors&gt;</span> tag, used to define a location in which to place errors in case a form does not meet the rules set forth by a controller. The attribute <span class="FontName">path="*"</span> is used to indicate the display of all errors—given the wildcard <span class="FontName">*</span>—where as the attribute <span class="FontName">cssClass="error"</span> is used to indicate a CSS formatting class to display the errors.</p>
<p class="indent">Next, you can find the form’s various <span class="FontName">&lt;form:input&gt;</span> tags accompanied by another set of corresponding <span class="FontName">&lt;form:errors&gt;</span> tags. These tags make use of the attribute <span class="FontName">path</span> to indicate the form’s fields, which in this case are <span class="FontName">courtName</span>, <span class="FontName">date</span> and <span class="FontName">hour</span>.</p>
<p class="indent">The <span class="FontName">&lt;form:input&gt;</span> tags are bound to properties corresponding to the <span class="FontName">modelAttribute</span> by using the <span class="FontName">path</span> attribute. They show the user the original value of the field, which will either be the bound property value or the value rejected due to a binding error. They must be used inside the <span class="FontName">&lt;form:form&gt;</span> tag, which defines a form that binds to the <span class="FontName">modelAttribute</span> by its name.</p>
<p class="indent">Finally, you can find the standard HTML tag <span class="FontName">&lt;input type="submit" /&gt;</span>that generates a ‘Submit’ button and trigger the sending of data to the server, followed by the <span class="FontName">&lt;/form:form&gt;</span> tag that closes out the form.</p>
<p class="indent">In case the form and its data are processed correctly, you need to create a success view to notify the user of a successful reservation. The <span class="FontName">reservationSuccess.jsp</span><a id="cXXX.422" class="calibre5"></a> illustrated next serves this purpose.</p>
<pre class="calibre11"><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Reservation Success&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">Your reservation has been made successfully.</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">It’s also possible for errors to occur due to invalid values being submitted in a form. For example, if the date is not in a valid format, or an alphabetic character is presented for the hour, the controller is designed to reject such field values. The controller will then generate a list of selective error codes for each error to be returned to the form view, values that are placed inside the <span class="FontName">&lt;form:errors&gt;</span> tag.</p>
<p class="indent">For example, for an invalid value input in the <span class="FontName">date</span> field, the following error codes are generated by a controller:</p>
<pre class="calibre11"><span class="FontName">typeMismatch.command.date</span><br class="calibre10"/><span class="FontName">typeMismatch.date</span><br class="calibre10"/><span class="FontName">typeMismatch.java.util.Date</span><br class="calibre10"/><span class="FontName">typeMismatch</span></pre>
<p class="indent">If you have a <span class="FontName">ResourceBundleMessageSource</span><a id="cXXX.423" class="calibre5"></a> defined, you can include the following error messages in your resource bundle for the appropriate locale (e.g., <span class="FontName">messages.properties</span> for the default locale):</p>
<pre class="calibre11"><span class="FontName">typeMismatch.date=Invalid date format</span><br class="calibre10"/><span class="FontName">typeMismatch.hour=Invalid hour format</span></pre>
<p class="indent">The corresponding error codes and their values are what is returned to a user if a failure occurs processing form data.</p>
<p class="indent">Now that you know the structure of the views involved with a form, as well as the data handled by it, let’s take a look at the logic that handles the submitted data (i.e., the reservation) in a form.</p>
<p id="Sec58" class="Heading2">Creating a form’s service processing<a id="cXXX.424" class="calibre6"></a></p>
<p class="noindent">This is not the controller, but rather the service used by the controller to process the form’s data reservation. First define a <span class="FontName">make()</span> method in the <span class="FontName">ReservationService</span> interface:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public interface ReservationService {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">public void make(Reservation reservation)</span><br class="calibre10"/>            <span class="FontName">throws ReservationNotAvailableException;</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Then you implement this <span class="FontName">make()</span> method by adding a <span class="FontName">Reservation</span> item to the list that stores the reservations. You throw a <span class="FontName">ReservationNotAvailableException</span> in case of a duplicate reservation.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class ReservationServiceImpl implements ReservationService {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">public void make(Reservation reservation)</span><br class="calibre10"/>            <span class="FontName">throws ReservationNotAvailableException {</span><br class="calibre10"/>        <span class="FontName">for (Reservation made : reservations) {</span><br class="calibre10"/>            <span class="FontName">if (made.getCourtName().equals(reservation.getCourtName())</span><br class="calibre10"/>                    <span class="FontName">&amp;&amp; made.getDate().equals(reservation.getDate())</span><br class="calibre10"/>                    <span class="FontName">&amp;&amp; made.getHour() == reservation.getHour()) {</span><br class="calibre10"/>                <span class="FontName">throw new ReservationNotAvailableException(</span><br class="calibre10"/>                        <span class="FontName">reservation.getCourtName(), reservation.getDate(),</span><br class="calibre10"/>                        <span class="FontName">reservation.getHour());</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">reservations.add(reservation);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now that you have a better understanding of the two elements that interact with a controller—a form’s views and the reservation service class—let’s create a controller to handle the court reservation form.</p>
<p id="Sec59" class="Heading2">Creating a form’s controller</p>
<p class="noindent">A controller used to handle forms makes use of practically the same annotations you’ve already used in the previous recipes. So let’s get right to the code.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">@RequestMapping("/reservationForm")</span><br class="calibre10"/><span class="FontName">@SessionAttributes("reservation")</span><br class="calibre10"/><span class="FontName">public class ReservationFormController {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private ReservationService reservationService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public ReservationFormController(ReservationService reservationService) {</span><br class="calibre10"/>           <span class="FontName">this.reservationService = reservationService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.GET)</span><br class="calibre10"/>    <span class="FontName">public String setupForm(Model model) {</span><br class="calibre10"/>        <span class="FontName">Reservation reservation = new Reservation();</span><br class="calibre10"/>        <span class="FontName">model.addAttribute("reservation", reservation);</span><br class="calibre10"/>        <span class="FontName">return "reservationForm";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.POST)</span><br class="calibre10"/>    <span class="FontName">public String submitForm(</span><br class="calibre10"/>            <span class="FontName">@ModelAttribute("reservation") Reservation reservation,</span><br class="calibre10"/>            <span class="FontName">BindingResult result, SessionStatus status) {</span><br class="calibre10"/>              <span class="FontName">reservationService.make(reservation);</span><br class="calibre10"/>              <span class="FontName">return "redirect:reservationSuccess";</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The controller starts by using the standard <span class="FontName">@Controller</span> annotation<a id="cXXX.425" class="calibre5"></a>, as well as the <span class="FontName">@RequestMapping</span> annotation<a id="cXXX.426" class="calibre5"></a> that allows access to the controller through the following URL:</p>
<pre class="calibre11"><span class="FontName">http://localhost:8080/court/reservationForm</span></pre>
<p class="indent">When you enter this URL in your browser, it will send an HTTP <span class="FontName">GET</span> request to your web application. This in turn triggers the execution of the <span class="FontName">setupForm</span> method, which is designated to attend this type of request based on its <span class="FontName">@RequestMapping</span> annotation.</p>
<p class="indent">The <span class="FontName">setupForm</span> method<a id="cXXX.427" class="calibre5"></a> defines a <span class="FontName">Model</span> object as an input parameter, which serves to send model data to the view (i.e., the form). Inside the handler method, an empty <span class="FontName">Reservation</span> object is created that is added as an attribute to the controller’s <span class="FontName">Model</span> object. Then the controller returns the execution flow to the <span class="FontName">reservationForm</span> view, which in this case is resolved to <span class="FontName">reservationForm.jsp</span> (i.e., the form).</p>
<p class="indent">The most important aspect of this last method is the addition of empty <span class="FontName">Reservation</span> object. If you analyze the form <span class="FontName">reservationForm.jsp</span> ,you will notice the <span class="FontName">&lt;form:form&gt;</span> tag declares an attribute <span class="FontName">modelAttribute="reservation"</span> . This means that upon rendering the view, the form expects an object named <span class="FontName">reservation</span> to be available, which is achieved by placing it inside the handler method’s <span class="FontName">Model</span>. In fact further inspection reveals that the <span class="FontName">path</span> values for each <span class="FontName">&lt;form:input&gt;</span> tag correspond to the field names belonging to the <span class="FontName">Reservation</span> object. Since the form is being loaded for the first time, it should be evident that an empty <span class="FontName">Reservation</span> object is expected.</p>
<p class="indent">Another aspect that is vital to describe prior to analyzing the other controller handler method is the <span class="FontName">@SessionAttributes("reservation")</span> annotation—declared at the top of the controller class. Since it’s possible for a form to contain errors, it can be an inconvenience to lose whatever valid data was already provided by a user on every subsequent submission. To solve this problem, the <span class="FontName">@SessionAttributes</span><a id="cXXX.428" class="calibre5"></a> is used to save a <span class="FontName">reservation</span> field to a user’s session, so that any future reference to the <span class="FontName">reservation</span> field is in fact made on the same reference, whether a form is submitted twice or more times. This is also the reason why only a single <span class="FontName">Reservation</span> object is created and assigned to the <span class="FontName">reservation</span> field in the entire controller. Once the empty <span class="FontName">Reservation</span> object is created—inside the HTTP <span class="FontName">GET</span> handler method—all actions are made on the same object, since it’s assigned to a user’s session.</p>
<p class="indent">Now let’s turn our attention to submitting the form for the first time. After you have filled in the form fields, submitting the form triggers an HTTP <span class="FontName">POST</span> request, that in turn invokes the <span class="FontName">submitForm</span> method—on account of this method’s <span class="FontName">@RequestMapping</span> value.</p>
<p class="indent">The input fields declared for the <span class="FontName">submitForm</span> method are three. The <span class="FontName">@ModelAttribute</span><a id="cXXX.429" class="calibre5"></a><span class="FontName">("reservation") Reservation reservation</span> used to reference the <span class="FontName">reservation</span> object. The <span class="FontName">BindingResult</span> object that contains newly submitted data by the user. And the <span class="FontName">SessionStatus</span> object used in case it’s necessary to access a user’s session.</p>
<p class="indent">At this juncture, the handler method doesn’t incorporate validation or perform access to a user’s session, which is the purpose of the <span class="FontName">BindingResult</span> object and <span class="FontName">SessionStatus</span> object—I will describe and incorporate them shortly.</p>
<p class="indent">The only operation performed by the handler method is <span class="FontName">reservationService.make</span><a id="cXXX.430" class="calibre5"></a><span class="FontName">(reservation);</span>. This operation invokes the reservation service using the current state of the <span class="FontName">reservation</span> object. Generally, controller objects are first validated prior to performing this type of operation on them.</p>
<p class="indent">Finally, note the handler method returns a view named <span class="FontName">redirect:reservationSuccess</span>. The actual name of the view in this case is <span class="FontName">reservationSuccess</span>, which is resolved to the <span class="FontName">reservationSuccess.jsp</span> page you created earlier.</p>
<p class="indent">The <span class="FontName">redirect:</span> prefix in the view name is used to avoid a problem known as <i class="calibre8">duplicate form submission</i>.</p>
<p class="indent">When you refresh the web page in the form success view, the form you just submitted is resubmitted again. To avoid this problem, you can apply the <i class="calibre8">post/redirect/get</i> design pattern, which recommends redirecting to another URL after a form submission is handled successfully, instead of returning an HTML page directly. This is the purpose of prefixing a view name with <span class="FontName">redirect:</span>.</p>
<p id="Sec60" class="Heading2">Initializing a model attribute object and pre-populating a form with values</p>
<p class="noindent">The form is designed to let users make reservations. However, if you analyze the <span class="FontName">Reservation</span> domain<a id="cXXX.431" class="calibre5"></a> class, you will note the form is still missing two fields in order to create a complete reservation object. One of these fields is the <span class="FontName">player</span> field, which corresponds to a <span class="FontName">Player</span> object. Per the <span class="FontName">Player</span> class definition, a <span class="FontName">Player</span> object has both a <span class="FontName">name</span> and <span class="FontName">phone</span> fields.</p>
<p class="indent">So can the <span class="FontName">player</span> field be incorporated into a form view and controller? Let’s analyze the form view first:</p>
<pre class="calibre11"><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Reservation Form&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;form method="post" modelAttribute="reservation"&gt;</span><br class="calibre10"/><span class="FontName">&lt;table&gt;</span><br class="calibre10"/>  <span class="FontName">...</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Player Name&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:input path="player.name" /&gt;&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:errors path="player.name" cssClass="error" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Player Phone&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:input path="player.phone" /&gt;&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:errors path="player.phone" cssClass="error" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td colspan="3"&gt;&lt;input type="submit" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/><span class="FontName">&lt;/table&gt;</span><br class="calibre10"/><span class="FontName">&lt;/form&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">Using a straightforward approach, you add two additional <span class="FontName">&lt;form:input&gt;</span> tags used to represent the <span class="FontName">Player</span> object’s fields. Though these forms declaration are simple, you also need to perform modifications to the controller. Recall that by using <span class="FontName">&lt;form:input&gt;</span> tags, a view expects to have access to model objects passed by the controller, that match the <span class="FontName">path</span> value for <span class="FontName">&lt;form:input&gt;</span> tags.</p>
<p class="indent">Though the controller’s HTTP <span class="FontName">GET</span> handler method returns an empty reservation <span class="FontName">Reservation</span> to this last view, the <span class="FontName">player</span> property is <span class="FontName">null</span>, so it causes an exception when rendering the form. To solve this problem, you have to initialize an empty <span class="FontName">Player</span> object and assign it to the <span class="FontName">Reservation</span> object returned to the view.</p>
<pre class="calibre11">    <span class="FontName">@RequestMapping(method = RequestMethod.GET)</span><br class="calibre10"/>    <span class="FontName">public String setupForm(</span><br class="calibre10"/><span class="FontName">@RequestParam(required = false, value = "username") String username, Model model) {</span><br class="calibre10"/>        <span class="FontName">Reservation reservation = new Reservation();</span><br class="calibre10"/>        <b class="calibre4">reservation.setPlayer(new Player(username, null));</b> <br class="calibre10"/>        <span class="FontName">model.addAttribute("reservation", reservation);</span><br class="calibre10"/>        <span class="FontName">return "reservationForm";</span><br class="calibre10"/>    <span class="FontName">}</span></pre>
<p class="indent">In this case, after creating the empty <span class="FontName">Reservation</span> object, the <span class="FontName">setPlayer</span> method<a id="cXXX.432" class="calibre5"></a> is used to assign it an empty <span class="FontName">Player</span> object.</p>
<p class="indent">Further note that the creation of the <span class="FontName">Person</span> object relies on the <span class="FontName">username</span> value. This particular value is obtained from the <span class="FontName">@RequestParam</span> input value which was also added to the handler method. By doing so, the <span class="FontName">Player</span> object can be created with a specific <span class="FontName">username</span> value passed in as a request parameter, resulting in the <span class="FontName">username</span> form field being pre-populated with this value.</p>
<p class="indent">So for example, if a request to the form is made in the following manner:</p>
<pre class="calibre11"><span class="FontName">http://localhost:8080/court/reservationForm?username=Roger</span></pre>
<p class="indent">This allows the handler method to extract the <span class="FontName">username</span> parameter to create the <span class="FontName">Player</span> object, in turn pre-populating the form’s <span class="FontName">username</span> form field with a <span class="FontName">Roger</span> value. It’s worth noting that the <span class="FontName">@RequestParam</span> annotation for the <span class="FontName">username</span> parameter uses the property <span class="FontName">required=false</span>, this allows a form request to be processed even if such a request parameter is not present.</p>
<p id="Sec61" class="Heading2">Providing form Reference Data</p>
<p class="noindent">When a form controller is requested to render the form view, it may have some types of reference data to provide to the form (e.g., the items to display in an HTML selection). Now suppose you want to allow a user to select the sport type when reserving a court—which is the final unaccounted field for the <span class="FontName">Reservation</span> class<a id="cXXX.433" class="calibre5"></a>.</p>
<pre class="calibre11"><span class="FontName">&lt;html&gt;</span><br class="calibre10"/><span class="FontName">&lt;head&gt;</span><br class="calibre10"/><span class="FontName">&lt;title&gt;Reservation Form&lt;/title&gt;</span><br class="calibre10"/><span class="FontName">&lt;/head&gt;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">&lt;body&gt;</span><br class="calibre10"/><span class="FontName">&lt;form method="post" modelAttribute="reservation"&gt;</span><br class="calibre10"/><span class="FontName">&lt;table&gt;</span><br class="calibre10"/>  <span class="FontName">...</span><br class="calibre10"/> <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;Sport Type&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;</span><br class="calibre10"/>      <b class="calibre4">&lt;form:select path="sportType" items="${sportTypes}"</b><br class="calibre10"/>        <b class="calibre4">itemValue="id" itemLabel="name" /&gt;</b><br class="calibre10"/>    <span class="FontName">&lt;/td&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td&gt;&lt;form:errors path="sportType" cssClass="error" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;tr&gt;</span><br class="calibre10"/>    <span class="FontName">&lt;td colspan="3"&gt;&lt;input type="submit" /&gt;&lt;/td&gt;</span><br class="calibre10"/>  <span class="FontName">&lt;/tr&gt;</span><br class="calibre10"/><span class="FontName">&lt;/table&gt;</span><br class="calibre10"/><span class="FontName">&lt;/form&gt;</span><br class="calibre10"/><span class="FontName">&lt;/body&gt;</span><br class="calibre10"/><span class="FontName">&lt;/html&gt;</span></pre>
<p class="indent">The <span class="FontName">&lt;form:select&gt;</span> tag provides a way to generate a drop-down list of values passed to the view by the controller. Thus the form represents the <span class="FontName">sportType</span> field as a set of HTML <span class="FontName">&lt;select&gt;</span> elements, instead of the previous open-ended fields—<span class="FontName">&lt;input&gt;</span>—that require a user to introduce text values.</p>
<p class="indent">Next, let’s take a look at how the controller assigns the <span class="FontName">sportType</span> field as a model attribute, the process is a little different than the previous fields.</p>
<p class="indent">First let’s define the <span class="FontName">getAllSportTypes()</span> method in the <span class="FontName">ReservationService</span> interface for retrieving all available sport types:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public interface ReservationService {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">public List&lt;SportType&gt; getAllSportTypes();</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Then you can implement this method by returning a hard-coded list:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class ReservationServiceImpl implements ReservationService {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">public static final SportType TENNIS = new SportType(1, "Tennis");</span><br class="calibre10"/>    <span class="FontName">public static final SportType SOCCER = new SportType(2, "Soccer");</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public List&lt;SportType&gt; getAllSportTypes() {</span><br class="calibre10"/>        <span class="FontName">return Arrays.asList(new SportType[] { TENNIS, SOCCER });</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now that you have an implementation that returns a hard-coded list of <span class="FontName">SportType</span> objects, let’s take a look at how the controller associates this list for it to be returned to the form view.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">.....</span><br class="calibre10"/>    <b class="calibre4">@ModelAttribute("sportTypes")</b><br class="calibre10"/>    <b class="calibre4">public List&lt;SportType&gt; populateSportTypes() {</b><br class="calibre10"/>        <b class="calibre4">return reservationService.getAllSportTypes();</b><br class="calibre10"/>    <b class="calibre4">}</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.GET)</span><br class="calibre10"/>    <span class="FontName">public String setupForm(</span><br class="calibre10"/>    <span class="FontName">@RequestParam(required = false, value = "username") String username, Model model) {</span><br class="calibre10"/>        <span class="FontName">Reservation reservation = new Reservation();</span><br class="calibre10"/>        <span class="FontName">reservation.setPlayer(new Player(username, null));</span> <br class="calibre10"/>        <span class="FontName">model.addAttribute("reservation", reservation);</span><br class="calibre10"/>        <span class="FontName">return "reservationForm";</span><br class="calibre10"/>    <span class="FontName">}</span></pre>
<p class="indent">Notice that the <span class="FontName">setupForm</span> handler method<a id="cXXX.434" class="calibre5"></a> charged with returning the empty <span class="FontName">Reservation</span> object to the form view remains unchanged.</p>
<p class="indent">The new addition and what is responsible for passing a <span class="FontName">SportType</span> list as a model attribute to the form view is the method decorated with the <span class="FontName">@ModelAttribute</span><span class="FontName">("sportTypes")</span> annotation.</p>
<p class="indent">The <span class="FontName">@ModelAttribute</span> annotation is used to define global model attributes, available to any returning view used in handler methods. In the same way a handler method declares a <span class="FontName">Model</span> object as an input parameter and assigns attributes that can be accessed in the returning view.</p>
<p class="indent">Since the method decorated with the <span class="FontName">@ModelAttribute("sportTypes")</span> annotation has a return type of <span class="FontName">List&lt;SportType&gt;</span> and makes a call to <span class="FontName">reservationService.getAllSportTypes()</span>, the hard-coded <span class="FontName">TENNIS</span> and <span class="FontName">SOCCER SportType</span> objects are assigned to the model attribute named <span class="FontName">sportTypes</span>. With this last model attribute used in the form view to populate a drop down list (i.e.,<span class="FontName">&lt;form:select&gt;</span> tag).</p>
<p id="Sec62" class="Heading2">Binding Properties of Custom Types</p>
<p class="noindent">When a form is submitted, a controller binds the form field values to model object’s properties of the same name, in this case a <span class="FontName">Reservation</span> object. However, for properties of custom types, a controller is not able to convert them unless you specify the corresponding property editors for them.</p>
<p class="indent">For example, the sport type selection field only submits the selected sport type ID—as this is the way HTML <span class="FontName">&lt;select&gt;</span> fields operate. Therefore, you have to convert this ID into a <span class="FontName">SportType</span> object with a property editor. First of all, you require the <span class="FontName">getSportType()</span> method<a id="cXXX.435" class="calibre5"></a> in <span class="FontName">ReservationService</span> to retrieve a <span class="FontName">SportType</span> object by its ID:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public interface ReservationService {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">public SportType getSportType(int sportTypeId);</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">For testing purposes, you can implement this method with a switch/case statement:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class ReservationServiceImpl implements ReservationService {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">public SportType getSportType(int sportTypeId) {</span><br class="calibre10"/>        <span class="FontName">switch (sportTypeId) {</span><br class="calibre10"/>        <span class="FontName">case 1:</span><br class="calibre10"/>            <span class="FontName">return TENNIS;</span><br class="calibre10"/>        <span class="FontName">case 2:</span><br class="calibre10"/>            <span class="FontName">return SOCCER;</span><br class="calibre10"/>        <span class="FontName">default:</span><br class="calibre10"/>            <span class="FontName">return null;</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Then you create the <span class="FontName">SportTypeConverter</span><a id="cXXX.436" class="calibre5"></a> class to convert a sport type ID into a <span class="FontName">SportType</span> object. This converter requires <span class="FontName">ReservationService</span> to perform the lookup.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.domain;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.court.service.ReservationService;</span><br class="calibre10"/><span class="FontName">import org.springframework.core.convert.converter.Converter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class SportTypeConverter implements Converter&lt;String, SportType&gt; {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">private ReservationService reservationService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public SportTypeConverter(ReservationService reservationService) {</span><br class="calibre10"/>        <span class="FontName">this.reservationService = reservationService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Override</span><br class="calibre10"/>    <span class="FontName">public SportType convert(String source) {</span><br class="calibre10"/>        <span class="FontName">int sportTypeId = Integer.parseInt(source);</span><br class="calibre10"/>        <span class="FontName">SportType sportType = reservationService.getSportType(sportTypeId);</span><br class="calibre10"/>        <span class="FontName">return sportType;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now that you have the supporting <span class="FontName">SportTypeConverter</span> class required to bind form properties to a custom class like <span class="FontName">SportType</span>, you need to associate it with the controller. For this purpose, we can use the <span class="FontName">addFormatters</span> method from the <span class="FontName">WebMvcConfigurer</span>.</p>
<p class="indent">By overriding this method in our <span class="FontName">WebConfiguration</span> class custom types can be associated with a controller. This includes the <span class="FontName">SportTypeConverter</span> class and other custom types like <span class="FontName">Date</span>.</p>
<p class="indent">Though we didn’t mention the date field earlier, it suffers from the same problem as the sport type selection field. A user introduces date fields as text values. In order for the controller to assign these text values to the <span class="FontName">Reservation</span> object’s <span class="FontName">date</span> field, this requires the date fields be associated with a <span class="FontName">Date</span> object,. Given the <span class="FontName">Date</span> class is part of the Java language, it won’t be necessary to create special a class like <span class="FontName">SportTypeConverter</span>  for this purpose, the Spring framework already includes a custom class for this purpose.</p>
<p class="indent">Knowing you need to bind both the <span class="FontName">SportTypeConverter</span> class and a <span class="FontName">Date</span> class to the underlying controller, the following listing illustrates the modifications to the <span class="FontName">WebConfiguration</span> class.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web.config;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.court.domain.SportTypeConverter;</span><br class="calibre10"/><span class="FontName">import com.apress.springrecipes.court.service.ReservationService;</span><br class="calibre10"/><span class="FontName">import org.springframework.beans.factory.annotation.Autowired;</span><br class="calibre10"/><span class="FontName">import org.springframework.format.FormatterRegistry;</span><br class="calibre10"/><span class="FontName">import org.springframework.format.datetime.DateFormatter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">@Configuration</span><br class="calibre10"/><span class="FontName">@EnableWebMvc</span><br class="calibre10"/><span class="FontName">@ComponentScan("com.apress.springrecipes.court.web")</span><br class="calibre10"/><span class="FontName">public class WebConfiguration extends WebMvcConfigurerAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">private ReservationService reservationService;</span><br class="calibre10"/> <span class="FontName">...</span><br class="calibre10"/>    <b class="calibre4">@Override</b><br class="calibre10"/>    <b class="calibre4">public void addFormatters(FormatterRegistry registry) {</b><br class="calibre10"/>        <b class="calibre4">registry.addFormatterForFieldType(Date.class, new DateFormatter("yyyy-MM-dd"));</b><br class="calibre10"/>        <b class="calibre4">registry.addConverter(new SportTypeConverter(reservationService));</b><br class="calibre10"/>    <b class="calibre4">}</b><br class="calibre10"/> <span class="FontName">}</span></pre>
<p class="indent">The only field for this last class corresponds to <span class="FontName">reservationService</span>, used to access the application’s <span class="FontName">ReservationService</span> bean. Note the use of the <span class="FontName">@Autowired</span> annotation<a id="cXXX.437" class="calibre5"></a> that enables the injection of the bean.</p>
<p class="indent">Next, you can find the <span class="FontName">addFormatters</span> method<a id="cXXX.438" class="calibre5"></a> used to bind the <span class="FontName">Date</span> and <span class="FontName">SportTypeConverter</span> classes. You can then find two calls to register the converter and formatter. These methods belong to the <span class="FontName">FormatterRegistry</span> object, which is passed as an input parameter to <span class="FontName">addFormatters</span> method.</p>
<p class="indent">The first call is used to bind a <span class="FontName">Date</span> class to the <span class="FontName">DateFormatter</span> class. The <span class="FontName">DateFormatter</span> class is provided by the Spring framework and offers functionality to parse and print <span class="FontName">Date</span> objects.</p>
<p class="indent">The second call is used to register the <span class="FontName">SportTypeConverter</span> class. Since you created the <span class="FontName">SportTypeConverter</span> class, you should be familiar that its only input parameter is a <span class="FontName">ReservationService</span> bean.</p>
<p class="indent">By using this approach, every annotation-based controller (i.e., classes using the <span class="FontName">@Controller</span> annotation) can have access to the same custom converters and formatters in their handler methods.</p>
<p id="Sec63" class="Heading2">Validating Form Data</p>
<p class="noindent">When a form is submitted, it’s standard practice to validate the data provided by a user before a submission is successful. Spring MVC supports validation by means of a validator object that implements the <span class="FontName">Validator</span> interface<a id="cXXX.439" class="calibre5"></a>. You can write the following validator to check if the required form fields are filled, and if the reservation hour is valid on holidays and weekdays:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.domain;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.validation.Errors;</span><br class="calibre10"/><span class="FontName">import org.springframework.validation.ValidationUtils;</span><br class="calibre10"/><span class="FontName">import org.springframework.validation.Validator;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.stereotype.Component;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class ReservationValidator implements Validator {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public boolean supports(Class clazz) {</span><br class="calibre10"/>        <span class="FontName">return Reservation.class.isAssignableFrom(clazz);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void validate(Object target, Errors errors) {</span><br class="calibre10"/>        <span class="FontName">ValidationUtils.rejectIfEmptyOrWhitespace(errors, "courtName",</span><br class="calibre10"/>                <span class="FontName">"required.courtName", "Court name is required.");</span><br class="calibre10"/>        <span class="FontName">ValidationUtils.rejectIfEmpty(errors, "date",</span><br class="calibre10"/>                <span class="FontName">"required.date", "Date is required.");</span><br class="calibre10"/>        <span class="FontName">ValidationUtils.rejectIfEmpty(errors, "hour",</span><br class="calibre10"/>                <span class="FontName">"required.hour", "Hour is required.");</span><br class="calibre10"/>        <span class="FontName">ValidationUtils.rejectIfEmptyOrWhitespace(errors, "player.name",</span><br class="calibre10"/>                <span class="FontName">"required.playerName", "Player name is required.");</span><br class="calibre10"/>        <span class="FontName">ValidationUtils.rejectIfEmpty(errors, "sportType",</span><br class="calibre10"/>                <span class="FontName">"required.sportType", "Sport type is required.");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">Reservation reservation = (Reservation) target;</span><br class="calibre10"/>        <span class="FontName">Date date = reservation.getDate();</span><br class="calibre10"/>        <span class="FontName">int hour = reservation.getHour();</span><br class="calibre10"/>        <span class="FontName">if (date != null) {</span><br class="calibre10"/>            <span class="FontName">Calendar calendar = Calendar.getInstance();</span><br class="calibre10"/>            <span class="FontName">calendar.setTime(date);</span><br class="calibre10"/>            <span class="FontName">if (calendar.get(Calendar.DAY_OF_WEEK) == Calendar.SUNDAY) {</span><br class="calibre10"/>                <span class="FontName">if (hour &lt; 8 || hour &gt; 22) {</span><br class="calibre10"/>                    <span class="FontName">errors.reject("invalid.holidayHour", "Invalid holiday hour.");</span><br class="calibre10"/>                <span class="FontName">}</span><br class="calibre10"/>            <span class="FontName">} else {</span><br class="calibre10"/>                <span class="FontName">if (hour &lt; 9 || hour &gt; 21) {</span><br class="calibre10"/>                    <span class="FontName">errors.reject("invalid.weekdayHour", "Invalid weekday hour.");</span><br class="calibre10"/>                <span class="FontName">}</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In this validator, you use utility methods such as <span class="FontName">rejectIfEmptyOrWhitespace()</span> and <span class="FontName">rejectIfEmpty()</span> in the <span class="FontName">ValidationUtils</span> class to validate the required form fields. If any of these form fields is empty, these methods will create a <i class="calibre8">field error</i> and bind it to the field. The second argument of these methods is the property name, while the third and fourth are the error code and default error message.</p>
<p class="indent">You also check whether the reservation hour is valid on holidays and weekdays. In case of invalidity, you should use the <span class="FontName">reject()</span> method to create an <i class="calibre8">object error</i> to be bound to the reservation object, not to a field.</p>
<p class="indent">Since the validator class is annotated with the <span class="FontName">@Component</span> annotation, Spring attempts to instantiate the class as a bean in accordance with the class name, in this case <span class="FontName">reservationValidator</span>.</p>
<p class="indent">We need to register the validator as a bean in our context, for this we can simply add a <span class="FontName">@Bean</span> annotated method to our <span class="FontName">WebConfiguration</span>.</p>
<pre class="calibre11"><span class="FontName">@Bean</span><br class="calibre10"/><span class="FontName">public ReservationValidator reservationValidator() {</span><br class="calibre10"/>    <span class="FontName">return new ReservationValidator();</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Since validators may create errors during validation, you should define messages for the error codes for displaying to the user. If you have <span class="FontName">ResourceBundleMessageSource</span> defined, you can include the following error messages in your resource bundle for the appropriate locale (e.g., <span class="FontName">messages.properties</span> for the default locale):</p>
<pre class="calibre11"><span class="FontName">required.courtName=Court name is required</span><br class="calibre10"/><span class="FontName">required.date=Date is required</span><br class="calibre10"/><span class="FontName">required.hour=Hour is required</span><br class="calibre10"/><span class="FontName">required.playerName=Player name is required</span><br class="calibre10"/><span class="FontName">required.sportType=Sport type is required</span><br class="calibre10"/><span class="FontName">invalid.holidayHour=Invalid holiday hour</span><br class="calibre10"/><span class="FontName">invalid.weekdayHour=Invalid weekday hour</span></pre>
<p class="indent">To apply this validator, you need to perform the following modification to your controller:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">.....</span><br class="calibre10"/>   <span class="FontName">private ReservationService reservationService;</span><br class="calibre10"/>   <b class="calibre4">private ReservationValidator reservationValidator;</b><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public ReservationFormController(ReservationService reservationService,</span><br class="calibre10"/>            <span class="FontName">ReservationValidator reservationValidator) {</span><br class="calibre10"/>        <span class="FontName">this.reservationService = reservationService;</span><br class="calibre10"/>        <b class="calibre4">this.reservationValidator = reservationValidator;</b><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.POST)</span><br class="calibre10"/>    <span class="FontName">public String submitForm(</span><br class="calibre10"/>            <span class="FontName">@ModelAttribute("reservation")</span> <b class="calibre4">@Validated</b> <span class="FontName">Reservation reservation,</span><br class="calibre10"/>            <span class="FontName">BindingResult result, SessionStatus status) {</span><br class="calibre10"/>        <b class="calibre4">if (result.hasErrors()) {</b><br class="calibre10"/>            <b class="calibre4">return "reservationForm";</b><br class="calibre10"/>        <span class="FontName">} else {</span><br class="calibre10"/>            <span class="FontName">reservationService.make(reservation);</span><br class="calibre10"/>            <span class="FontName">return "redirect:reservationSuccess";</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <b class="calibre4">@InitBinder</b><a id="cXXX.440" class="calibre5"></a><br class="calibre10"/>    <b class="calibre4">public void initBinder(WebDataBinder binder) {</b><br class="calibre10"/>        <b class="calibre4">binder.setValidator(reservationValidator);</b><br class="calibre10"/>    <b class="calibre4">}</b></pre>
<p class="indent">The first addition to the controller is the <span class="FontName">ReservationValidator</span> field, that gives the controller access to an instance of the validator bean. By relying on the <span class="FontName">@Autowired</span> annotation, a <span class="FontName">ReservationValidator</span> bean is injected along with the pre-existing <span class="FontName">ReservationService</span> bean.</p>
<p class="indent">The next modification takes place in the HTTP <span class="FontName">POST</span> handler method, which is always called when a user submits a form.  Next to the <span class="FontName">@ModelAttribute</span> annotation there is now a <span class="FontName">@Validated</span> annotation, this annotation triggers validation of the object.  After the validation, the <span class="FontName">result</span> parameter—<span class="FontName">BindingResult</span> object—contains the results for the validation process. So next, a conditional based on the value of <span class="FontName">result.hasErrors()</span> is made. If the validation class detects errors this value is true.</p>
<p class="indent">In case errors are detected in the validation process the method handler returns the view <span class="FontName">reservationForm</span> , which corresponds to the same form that so a user can re-submit information. In case no errors are detected in the validation process, a call is made to perform the reservation— <span class="FontName">reservationService.make(reservation);</span>—followed by a redirection to the success view <span class="FontName">reservationSuccess</span>.</p>
<p class="indent">The registration of the validator is done in the <span class="FontName">@InitBinder</span> annotated method, the validator is set on the <span class="FontName">WebDataBinder</span> so that it can be used after binding. To register the validator one needs to use the <span class="FontName">setValidator</span> method.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  The <span class="FontName">WebDataBinder</span> can also be used to register additional <span class="FontName">ProperyEditor</span>s for type conversion. This can be used instead of registering global <span class="FontName">PropertyEditor</span>s, <span class="FontName">Converter</span>s, or <span class="FontName">Formatter</span>s.</p></div>
<p id="Sec64" class="Heading2">Expiring a controller’s Session Data</p>
<p class="noindent">In order to support the possibility of a form being submitted multiple times and not loose data provided by a user in between submissions, the controller relies on the use of the <span class="FontName">@SessionAttributes</span> annotation. By doing so, a reference to the <span class="FontName">reservation</span> field represented as a <span class="FontName">Reservation</span> object is saved between requests.</p>
<p class="indent">However, once a form is submitted successfully and a reservation is made, there is no point in keeping the <span class="FontName">Reservation</span> object in a user’s session. In fact, if a user revisits the form within a short period of time, there is a possibility remnants of this old <span class="FontName">Reservation</span> object emerge if not removed.</p>
<p class="indent">Values assigned using the <span class="FontName">@SessionAttributes</span> annotation can be removed using the <span class="FontName">SessionStatus</span> object, an object that can be passed as an input parameter to handler methods. The following listing illustrates how to expire the controller’s session data.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web;</span><br class="calibre10"/><span class="FontName">....</span><br class="calibre10"/><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">@RequestMapping("/reservationForm")</span><br class="calibre10"/><b class="calibre4">@SessionAttributes("reservation")</b> <br class="calibre10"/><span class="FontName">public class ReservationFormController {</span><br class="calibre10"/><span class="FontName">....</span><br class="calibre10"/>   <span class="FontName">@RequestMapping(method = RequestMethod.POST)</span><br class="calibre10"/>    <span class="FontName">public String submitForm(</span><br class="calibre10"/>            <span class="FontName">@ModelAttribute("reservation") Reservation reservation,</span><br class="calibre10"/>            <span class="FontName">BindingResult result, SessionStatus status) {</span><br class="calibre10"/><br class="calibre10"/>            <span class="FontName">if (result.hasErrors()) {</span><br class="calibre10"/>               <span class="FontName">return "reservationForm";</span><br class="calibre10"/>             <span class="FontName">} else {</span><br class="calibre10"/>            <span class="FontName">reservationService.make(reservation);</span><br class="calibre10"/>            <b class="calibre4">status.setComplete();</b><br class="calibre10"/>            <span class="FontName">return "redirect:reservationSuccess";</span><br class="calibre10"/>             <span class="FontName">}</span><br class="calibre10"/>     <span class="FontName">}</span></pre>
<p class="indent">Once the handler method performs the reservation by calling <span class="FontName">reservationService. make(reservation);</span> and right before a user is redirected to a success page, it becomes an ideal time in which expire a controller’s session data. This is done by calling the <span class="FontName">setComplete()</span> method on the <span class="FontName">SessionStatus</span> object. It’s that simple.</p>
<p id="Sec65" class="Heading">4-10. Bean validation<a id="cXXX.441" class="calibre6"></a> with Annotations (JSR-303)</p>
<p id="Sec66" class="Heading1">Problem</p>
<p class="noindent">You want to validate Java beans in a web application using annotations based on the JSR-303 standard.</p>
<p id="Sec67" class="Heading1">Solution</p>
<p class="noindent">JSR-303 or bean validation is a specification whose objective is to standardize the validation of Java beans through annotations.</p>
<p class="indent">In the previous examples, you saw how the Spring framework<a id="cXXX.442" class="calibre5"></a> supports an ad-hoc technique for validating beans. This requires you to extend one of the Spring framework’s classes to create a validator class for a particular type of Java bean.</p>
<p class="indent">The objective of the JSR-303 standard is to use annotations directly in a Java bean class. This allows validation rules to be specified directly in the code they are intended to validate, instead of creating validation rules in separate classes—just like you did earlier using Spring a framework class.</p>
<p id="Sec68" class="Heading1">How It Works</p>
<p class="noindent">The first thing you need to do is decorate a Java bean with the necessary JSR-303 annotations. The following listing illustrates the <span class="FontName">Reservation</span> domain<a id="cXXX.443" class="calibre5"></a> class used in the court application decorated with JSR-303 annotations:</p>
<pre class="calibre11"><span class="FontName">public class Reservation {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@NotNull</span><br class="calibre10"/>    <span class="FontName">@Size(min = 4)</span><br class="calibre10"/>    <span class="FontName">private String courtName;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@NotNull</span><br class="calibre10"/>    <span class="FontName">private Date date;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Min(9)</span><br class="calibre10"/>    <span class="FontName">@Max(21)</span><br class="calibre10"/>    <span class="FontName">private int hour;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Valid</span><br class="calibre10"/>    <span class="FontName">private Player player;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@NotNull</span><br class="calibre10"/>    <span class="FontName">private SportType sportType;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">// Getter/Setter methods ommited for brevity</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The courtN<span class="FontName">ame</span> field is assigned two annotations. The <span class="FontName">@NotNull</span> annotation, which indicates that a field cannot be <span class="FontName">null</span> and the <span class="FontName">@Size</span> annotation used to indicate a field has to have a minimum of two characters. The <span class="FontName">date</span> and <span class="FontName">sportType</span> fields are annotated with <span class="FontName">@NotNull</span><a id="cXXX.444" class="calibre5"></a>  as those are required.</p>
<p class="indent">The hour field is annotated with <span class="FontName">@Min</span> and <span class="FontName">@Max</span> because those are the lower and upper limits of the <span class="FontName">hour</span> field.</p>
<p class="indent">Both the fields in the <span class="FontName">Player</span> domain class are annotated with <span class="FontName">@NotNull</span> to also trigger validation of the related object we have annotated it with <span class="FontName">@Valid</span>.</p>
<p class="indent">Now that you know how a Java bean class is decorated with annotations belonging to the JSR-303 standard. Let’s take a look at how these validator annotations are enforced in a controller.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">.....</span><br class="calibre10"/>   <span class="FontName">private ReservationService reservationService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public ReservationFormController(ReservationService reservationService) {</span><br class="calibre10"/>        <span class="FontName">this.reservationService = reservationService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.POST)</span><br class="calibre10"/>    <span class="FontName">public String submitForm(</span><br class="calibre10"/>            <span class="FontName">@ModelAttribute("reservation")</span> <b class="calibre4">@Valid</b> <span class="FontName">Reservation reservation,</span><br class="calibre10"/>            <span class="FontName">BindingResult result, SessionStatus status) {</span><br class="calibre10"/>        <b class="calibre4">if (result.hasErrors()) {</b><br class="calibre10"/>            <b class="calibre4">return "reservationForm";</b><br class="calibre10"/>        <span class="FontName">} else {</span><br class="calibre10"/>            <span class="FontName">reservationService.make(reservation);</span><br class="calibre10"/>            <span class="FontName">return "redirect:reservationSuccess";</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/></pre>
<p class="indent">The controller is almost similar to the one from recipe 4.9. The only difference is the absence of the <span class="FontName">@InitBinder</span> annotated method. Spring MVC detects a <span class="FontName">javax.validation.Validator</span> if that is on the classpath. We added hibernate-validator to the classpath and that is a validation implementation.</p>
<p class="indent">Next, you can find the controller’s HTTP <span class="FontName">POST</span> handler method used to handle the submission of user data. Since the handler method is expecting an instance of the <span class="FontName">Reservation</span> object, which you decorated with JSR-303 annotations, you can validate its data.</p>
<p class="indent">The remainder of the submitForm method<a id="cXXX.445" class="calibre5"></a> is exact the same as from recipe 4.9.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To use JSR-303 bean validation<a id="cXXX.2013" class="calibre5"></a> in a web application, you must add a dependency to an implementation to your CLASSPATH. If you are using Maven, add the following dependencies to your Maven Project:</p>
<pre class="calibre19"><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;javax.validation&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;validation-api&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;1.1.0.Final&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span><br class="calibre2"/><br class="calibre2"/>  <span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.hibernate&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;5.1.1.Final&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span></pre></div>
<p id="Sec69" class="Heading">4-11. Creating Excel and PDF Views<a id="cXXX.446" class="calibre6"></a></p>
<p id="Sec70" class="Heading1">Problem</p>
<p class="noindent">Although HTML<a id="cXXX.447" class="calibre5"></a> is the most common method of displaying web contents, sometimes your users may wish to export contents from your web application in Excel or PDF format. In Java, there are several libraries that can help generate Excel and PDF files. However, to use these libraries directly in a web application, you have to generate the files behind the scenes and return them to users as binary attachments. You have to deal with HTTP response headers and output streams for this purpose.</p>
<p id="Sec71" class="Heading1">Solution</p>
<p class="noindent">Spring integrates the generation of Excel and PDF files into its MVC framework. You can consider Excel and PDF files as special kinds of views, so you can consistently handle a web request in a controller and add data to a model for passing to Excel and PDF views. In this way, you have no need to deal with HTTP response headers and output streams.</p>
<p class="indent">Spring MVC supports generating Excel files using either the Apache POI library (<span class="FontName"><a href="http://poi.apache.org/" class="calibre5">http://poi.apache.org/</a></span>) or the JExcelAPI library (<span class="FontName"><a href="http://jexcelapi.sourceforge.net/" class="calibre5">http://jexcelapi.sourceforge.net/</a></span>). The corresponding view classes are <span class="FontName">AbstractExcelView</span> and <span class="FontName">AbstractJExcelView</span>. PDF files are generated by the iText library (<span class="FontName"><a href="http://www.lowagie.com/iText/" class="calibre5">http://www.lowagie.com/iText/</a></span>), and the corresponding view class is <span class="FontName">AbstractPdfView</span>.</p>
<p id="Sec72" class="Heading1">How It Works</p>
<p class="noindent">Suppose your users wish to generate a report of the reservation summary for a particular day. They want this report to be generated in either, Excel, PDF, or the basic HTML format. For this report generation function, you need to declare a method in the service layer that returns all the reservations of a specified day:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public interface ReservationService {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">public List&lt;Reservation&gt; findByDate(Date date);</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Then you provide a simple implementation for this method by iterating over all the made reservations:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.service;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">public class ReservationServiceImpl implements ReservationService {</span><br class="calibre10"/>    <span class="FontName">...</span><br class="calibre10"/>    <span class="FontName">public List&lt;Reservation&gt; findByDate(Date date) {</span><br class="calibre10"/>        <span class="FontName">List&lt;Reservation&gt; result = new ArrayList&lt;Reservation&gt;();</span><br class="calibre10"/>        <span class="FontName">for (Reservation reservation : reservations) {</span><br class="calibre10"/>            <span class="FontName">if (reservation.getDate().equals(date)) {</span><br class="calibre10"/>                <span class="FontName">result.add(reservation);</span><br class="calibre10"/>            <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">return result;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">Now you can write a simple controller to get the <span class="FontName">date</span> parameters from the URL. The <span class="FontName">date</span> parameter<a id="cXXX.448" class="calibre5"></a> is formatted into a date object and passed to the service layer for querying reservations. The controller relies on the content negotiation<a id="cXXX.2018" class="calibre5"></a> resolver described in recipe 4-7 “Views and Content Negotiation,” therefore the controller returns a single logic view and lets the resolver determine if a report should be generated in Excel, PDF, or a default HTML web page.</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">@Controller</span><br class="calibre10"/><span class="FontName">@RequestMapping("/reservationSummary*")</span><br class="calibre10"/><span class="FontName">public class ReservationSummaryController {</span><br class="calibre10"/>    <span class="FontName">private ReservationService reservationService;</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@Autowired</span><br class="calibre10"/>    <span class="FontName">public ReservationSummaryController(ReservationService reservationService) {</span><br class="calibre10"/>        <span class="FontName">this.reservationService = reservationService;</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">@RequestMapping(method = RequestMethod.GET)</span><br class="calibre10"/>    <span class="FontName">public String generateSummary(</span><br class="calibre10"/>           <span class="FontName">@RequestParam(required = true, value = "date") String selectedDate,</span> <br class="calibre10"/>           <span class="FontName">Model model) {</span> <br class="calibre10"/>        <span class="FontName">List&lt;Reservation&gt; reservations = java.util.Collections.emptyList();</span><br class="calibre10"/>        <span class="FontName">try {</span> <br class="calibre10"/>            <span class="FontName">Date summaryDate = new SimpleDateFormat("yyyy-MM-dd").parse(selectedDate);</span><br class="calibre10"/>            <span class="FontName">reservations = reservationService.findByDate(summaryDate);</span><br class="calibre10"/>        <span class="FontName">} catch (java.text.ParseException ex) {</span> <br class="calibre10"/>            <span class="FontName">StringWriter sw = new StringWriter();</span><br class="calibre10"/>            <span class="FontName">PrintWriter pw = new PrintWriter(sw);</span><br class="calibre10"/>            <span class="FontName">ex.printStackTrace(pw);</span><br class="calibre10"/>            <span class="FontName">throw new ReservationWebException("Invalid date format for reservation summary",new Date(),sw.toString());</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">model.addAttribute("reservations",reservations);</span><br class="calibre10"/>        <span class="FontName">return "reservationSummary";</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">This controller only contains a default HTTP <span class="FontName">GET</span> handler method. The first action performed by this method is creating an empty <span class="FontName">Reservation</span> list to place the results obtained from the reservation service. Next, you can find a <span class="FontName">try/catch</span> block<a id="cXXX.449" class="calibre5"></a> that attempts to create a <span class="FontName">Date</span> object from the <span class="FontName">selectedDate @RequestParam</span>, as well as invoke the reservation service with the created <span class="FontName">Date</span> object. If creating the a <span class="FontName">Date</span> object fails, a custom Spring exception named <span class="FontName">ReservationWebException</span> is thrown.</p>
<p class="indent">If no errors are raised in the <span class="FontName">try/catch</span> block, the <span class="FontName">Reservation</span> list is placed into the controller’s <span class="FontName">Model</span> object. Once this is done, the method returns control to <span class="FontName">reservationSummary</span> view.</p>
<p class="indent">Note that the controller returns a single view, even though it supports PDF, XLS and HTML views. This is possible due to the <span class="FontName">ContentNegotiatingViewResolver</span> resolver, that determines on the basis of this single view name which of these multiple views to use. See recipe 4-7, “Views and Content Negotiation,” for more information on this resolver.</p>
<p id="Sec73" class="Heading2">Creating Excel Views</p>
<p class="noindent">An Excel view can be created by extending the <span class="FontName">AbstractExcelView</span><a id="cXXX.450" class="calibre5"></a> class (for Apache POI) or the <span class="FontName">AbstractJExcelView</span> class (for JExcelAPI). Here, <span class="FontName">AbstractExcelView</span> is used as an example. In the <span class="FontName">buildExcelDocument()</span> method, you can access the model passed from the controller and also a precreated Excel workbook. Your task is to populate the workbook with the data in the model.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To generate Excel files with Apache POI in a web application, you must have the Apache POI dependencies on your CLASSPATH. If you are using Apache Maven, add the following dependencies to your Maven Project:</p>
<pre class="calibre19"><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;org.apache.poi&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;poi&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;3.10-FINAL&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency&gt;</span></pre></div>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web.view;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.apache.poi.hssf.usermodel.HSSFRow;</span><br class="calibre10"/><span class="FontName">import org.apache.poi.hssf.usermodel.HSSFSheet;</span><br class="calibre10"/><span class="FontName">import org.apache.poi.hssf.usermodel.HSSFWorkbook;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.view.document.AbstractExcelView;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class ExcelReservationSummary extends AbstractExcelView {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">protected void buildExcelDocument(Map model, HSSFWorkbook workbook,</span><br class="calibre10"/>            <span class="FontName">HttpServletRequest request, HttpServletResponse response)</span><br class="calibre10"/>            <span class="FontName">throws Exception {</span><br class="calibre10"/>        <span class="FontName">List&lt;Reservation&gt; reservations = (List) model.get("reservations");</span><br class="calibre10"/>        <span class="FontName">DateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");</span><br class="calibre10"/>        <span class="FontName">HSSFSheet sheet = workbook.createSheet();</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">HSSFRow header = sheet.createRow(0);</span><br class="calibre10"/>        <span class="FontName">header.createCell((short) 0).setCellValue("Court Name");</span><br class="calibre10"/>        <span class="FontName">header.createCell((short) 1).setCellValue("Date");</span><br class="calibre10"/>        <span class="FontName">header.createCell((short) 2).setCellValue("Hour");</span><br class="calibre10"/>        <span class="FontName">header.createCell((short) 3).setCellValue("Player Name");</span><br class="calibre10"/>        <span class="FontName">header.createCell((short) 4).setCellValue("Player Phone");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">int rowNum = 1;</span><br class="calibre10"/>        <span class="FontName">for (Reservation reservation : reservations) {</span><br class="calibre10"/>            <span class="FontName">HSSFRow row = sheet.createRow(rowNum++);</span><br class="calibre10"/>            <span class="FontName">row.createCell((short) 0).setCellValue(reservation.getCourtName());</span><br class="calibre10"/>            <span class="FontName">row.createCell((short) 1).setCellValue(</span><br class="calibre10"/>                    <span class="FontName">dateFormat.format(reservation.getDate()));</span><br class="calibre10"/>            <span class="FontName">row.createCell((short) 2).setCellValue(reservation.getHour());</span><br class="calibre10"/>            <span class="FontName">row.createCell((short) 3).setCellValue(</span><br class="calibre10"/>                    <span class="FontName">reservation.getPlayer().getName());</span><br class="calibre10"/>            <span class="FontName">row.createCell((short) 4).setCellValue(</span><br class="calibre10"/>                    <span class="FontName">reservation.getPlayer().getPhone());</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">In the preceding Excel view, you first create a sheet in the workbook. In this sheet, you show the headers of this report in the first row. Then you iterate over the reservation list to create a row for each reservation.</p>
<p class="indent">As you have <span class="FontName">@RequestMapping</span><a id="cXXX.451" class="calibre5"></a><span class="FontName">("/reservationSummary*")</span> configured in your controller and the handler method requires <span class="FontName">date</span> as a request parameter. You can access this Excel view through the following URL.</p>
<pre class="calibre11"><span class="FontName">http://localhost:8080/court/reservationSummary.xls?date=2009-01-14</span></pre>
<p id="Sec74" class="Heading2">Creating PDF Views</p>
<p class="noindent">A PDF view is created by extending the <span class="FontName">AbstractPdfView</span> class. In the <span class="FontName">buildPdfDocument()</span> method, you can access the model passed from the controller and also a precreated PDF document. Your task is to populate the document with the data in the model.</p>
<div class="notepara"><p class="paraaftertitle"><img src="../images/00016.jpeg" alt="Image" class="calibre3"/> <b class="calibre4">Note</b>  To generate PDF files with iText in a web application, you must have the iText library on your CLASSPATH. If you are using Apache Maven, add the following dependency to your Maven Project:</p>
<pre class="calibre19"><span class="FontName1">&lt;dependency&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;groupId&gt;com.lowagie&lt;/groupId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;artifactId&gt;itext&lt;/artifactId&gt;</span><br class="calibre2"/>  <span class="FontName1">&lt;version&gt;4.2.1&lt;/version&gt;</span><br class="calibre2"/><span class="FontName1">&lt;/dependency</span></pre></div>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web.view;</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><span class="FontName">import org.springframework.web.servlet.view.document.AbstractPdfView;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">import com.lowagie.text.Document;</span><br class="calibre10"/><span class="FontName">import com.lowagie.text.Table;</span><br class="calibre10"/><span class="FontName">import com.lowagie.text.pdf.PdfWriter;</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class PdfReservationSummary extends AbstractPdfView {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">protected void buildPdfDocument(Map model, Document document,</span><br class="calibre10"/>            <span class="FontName">PdfWriter writer, HttpServletRequest request,</span><br class="calibre10"/>            <span class="FontName">HttpServletResponse response) throws Exception {</span><br class="calibre10"/>        <span class="FontName">List&lt;Reservation&gt; reservations = (List) model.get("reservations");</span><br class="calibre10"/>        <span class="FontName">DateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");</span><br class="calibre10"/>        <span class="FontName">Table table = new Table(5);</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">table.addCell("Court Name");</span><br class="calibre10"/>        <span class="FontName">table.addCell("Date");</span><br class="calibre10"/>        <span class="FontName">table.addCell("Hour");</span><br class="calibre10"/>        <span class="FontName">table.addCell("Player Name");</span><br class="calibre10"/>        <span class="FontName">table.addCell("Player Phone");</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">for (Reservation reservation : reservations) {</span><br class="calibre10"/>            <span class="FontName">table.addCell(reservation.getCourtName());</span><br class="calibre10"/>            <span class="FontName">table.addCell(dateFormat.format(reservation.getDate()));</span><br class="calibre10"/>            <span class="FontName">table.addCell(Integer.toString(reservation.getHour()));</span><br class="calibre10"/>            <span class="FontName">table.addCell(reservation.getPlayer().getName());</span><br class="calibre10"/>            <span class="FontName">table.addCell(reservation.getPlayer().getPhone());</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/><br class="calibre10"/>        <span class="FontName">document.add(table);</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">As you have <span class="FontName">@RequestMapping</span><span class="FontName">("/reservationSummary*")</span> configured in your controller and the handler method requires <span class="FontName">date</span> as a request parameter. You can access this PDF view through the following URL.</p>
<pre class="calibre11"><span class="FontName">http://localhost:8080/court/reservationSummary.pdf?date=2009-01-14</span></pre>
<p id="Sec75" class="Heading2">Creating resolvers for Excel and PDF views<a id="cXXX.2033" class="calibre6"></a></p>
<p class="noindent">In recipe 4-6, “Resolving Views<a id="cXXX.452" class="calibre5"></a> by Names,” you learned different strategies for resolving logical view names to specific view implementations. One of these strategies was resolving views from a resource bundle, this is the better-suited strategy for mapping logical view names to view implementations consisting of PDF or XLS classes.</p>
<p class="indent">Ensuring you have the <span class="FontName">ResourceBundleViewResolver</span> bean configured in your web application context as a view resolver, you can then define views in the <span class="FontName">views.properties</span> file included in a web application’s classpath root.</p>
<p class="indent">You can add the following entry to the <span class="FontName">views.properties</span> in order to map the XLS view class to a logical view name:</p>
<pre class="calibre11"><span class="FontName">reservationSummary.(class)=com.apress.springrecipes.court.web.view.ExcelReservationSummary</span></pre>
<p class="indent">Since the application relies on the process of content negotiation, this implies that the same view name is mapped to multiple view technologies. In addition, since it’s not possible to have duplicate names in the same <span class="FontName">views.properties</span> file, you need to create a separate file named <span class="FontName">secondaryviews.properties</span> to map the PDF view class to a logical view name, as illustrated next:</p>
<pre class="calibre11"><span class="FontName">reservationSummary.(class)=com.apress.springrecipes.court.web.view.PdfReservationSummary</span></pre>
<p class="indent">Take note that this file—<span class="FontName">secondaryviews.properties</span>—needs to be configured in its own <span class="FontName">ResourceBundleViewResolver</span> resolver.</p>
<p class="indent">The property name—<span class="FontName">reservationSummary</span>—corresponds to the views name returned by the controller. It’s the task of the <span class="FontName">ContentNegotiatingViewResolver</span> resolver to determine which of these classes to use based on a user’s request. Once this is determined, the execution of the corresponding class generates either a PDF or XLS file.</p>
<p id="Sec76" class="Heading2">Creating date based<a id="cXXX.453" class="calibre6"></a> PDF and XLS file names</p>
<p class="noindent">When a user makes a request for a PDF or XLS file using any of the following URLs:</p>
<pre class="calibre11"><span class="FontName">http://localhost:8080/court/reservationSummary.pdf?date=2008-01-14</span><br class="calibre10"/><span class="FontName">http://localhost:8080/court/reservationSummary.xls?date=2008-02-24</span></pre>
<p class="indent">The browser prompts a user with a question like “Save as reservationSummary.pdf ?” or “Save as reservationSummary.xls?”. This convention is based on the URL a user is requesting a resource from. However, given that a user is also providing a date in the URL, a nice feature can be an automatic prompt in the form “Save as ReservationSummary_2009_01_24.xls?” or “Save as ReservationSummary_2009_02_24.xls?”. This can be done by applying an interceptor to rewrite the returning URL. The following listing illustrates this interceptor:</p>
<pre class="calibre11"><span class="FontName">package com.apress.springrecipes.court.web</span><br class="calibre10"/><span class="FontName">...</span><br class="calibre10"/><br class="calibre10"/><span class="FontName">public class ExtensionInterceptor extends HandlerInterceptorAdapter {</span><br class="calibre10"/><br class="calibre10"/>    <span class="FontName">public void postHandle(HttpServletRequest request,</span><br class="calibre10"/>            <span class="FontName">HttpServletResponse response, Object handler,</span><br class="calibre10"/>                           <span class="FontName">ModelAndView modelAndView) throws Exception {</span><br class="calibre10"/>        <span class="FontName">// Report date is present in request</span><br class="calibre10"/>        <span class="FontName">String reportName = null;</span><br class="calibre10"/>        <span class="FontName">String reportDate = request.getQueryString().replace("date=","").replace("-","_");</span><br class="calibre10"/>        <span class="FontName">if(request.getServletPath().endsWith(".pdf")) {</span><br class="calibre10"/>            <span class="FontName">reportName= "ReservationSummary_" + reportDate + ".pdf";</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">if(request.getServletPath().endsWith(".xls")) {</span><br class="calibre10"/>            <span class="FontName">reportName= "ReservationSummary_" + reportDate + ".xls";</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>        <span class="FontName">if (reportName != null) {</span><br class="calibre10"/>            <span class="FontName">// Set "Content-Disposition" HTTP Header</span> <br class="calibre10"/>            <span class="FontName">// so a user gets a pretty 'Save as' address</span><br class="calibre10"/>            <span class="FontName">response.setHeader("Content-Disposition","attachment; filename="+reportName);</span><br class="calibre10"/>        <span class="FontName">}</span><br class="calibre10"/>    <span class="FontName">}</span><br class="calibre10"/><span class="FontName">}</span></pre>
<p class="indent">The interceptor extracts the entire URL if it contains a <span class="FontName">.pdf</span> or <span class="FontName">.xls</span> extension. If it detects such an extension, it creates a value for the return file name in the form <span class="FontName">ReservationSummary_&lt;report_date&gt;.&lt;.pdf|.xls&gt;</span>. To ensure a user receives a download prompt in this form, the HTTP header <span class="FontName">Content-Disposition</span><a id="cXXX.454" class="calibre5"></a> is set with this file name format.</p>
<p class="indent">In order to deploy this interceptor and that it only be applied to the URL corresponding to the controller charged with generating PDF and XLS files, we advise you to look over recipe 4-3, “Intercepting Requests with Handler Interceptors,” which contains this particular configuration and more details about interceptor classes.</p>
<div class="Singlethin"><p class="Heading4a">CONTENT NEGOTIATION AND SETTING HTTP HEADERS IN AN INTERCEPTOR</p>
<p class="box-left">Though this application uses the <span class="FontName">ContentNegotiatingViewResolver</span> resolver to select an appropriate view, the process of modifying a return URL is outside the scope of view resolvers.</p>
<p class="box-left">Therefore, it’s necessary to use an interceptor to manually inspect a request extension, as well as set the necessary HTTP headers to modify the outgoing URL.</p></div>
<p id="Sec77" class="Heading">Summary</p>
<p class="noindent">In this chapter, you have learned how to develop a Java web application using the Spring MVC framework. The central component of Spring MVC is <span class="FontName">DispatcherServlet</span>, which acts as a front controller that dispatches requests to appropriate handlers for them to handle requests.</p>
<p class="indent">In Spring MVC, controllers are standard Java classes that are decorated with the <span class="FontName">@Controller</span> annotation. Throughout the various recipes, you learned how to leverage other annotations used in Spring MVC controllers, which included: <span class="FontName">@RequestMapping</span> to indicate access URLs, <span class="FontName">@Autowired</span> to automatically inject bean references and <span class="FontName">@SessionAttributes</span> to maintain objects in a user’s session, among many others.</p>
<p class="indent">You also learned how to incorporate interceptors into an application, which allow you to alter request and response objects in a controller. In addition, you explored how Spring MVC supports form processing, including data validation using both Spring validators and the JSR-303 bean validation standard.</p>
<p class="indent">You also explored how Spring MVC incorporates SpEL to facilitate certain configuration tasks and how Spring MVC supports different types of views for different presentation technologies. Finally, you also learned how Spring supports content negotiation in order to determine a view based on a request’s extensions or HTTP headers.</p></div>
</body></html>
